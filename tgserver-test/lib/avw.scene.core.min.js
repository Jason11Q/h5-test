!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).avw={})}(this,(function(e){"use strict";const t="126",i={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},n={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},a=100,r=300,s=301,o=302,l=303,c=304,h=306,u=307,d=1e3,m=1001,f=1002,g=1003,y=1004,v=1005,b=1006,_=1007,x=1008,w=1009,S=1012,M=1014,T=1015,A=1016,E=1020,C=1022,I=1023,P=1024,R=1026,O=1027,D=1028,L=1030,k=33776,N=33777,B=33778,z=33779,U=35840,F=35841,j=35842,H=35843,G=36196,V=37492,W=37496,Y=2300,X=2301,Z=2302,q=2400,J=2401,Q=2402,K=2500,$=2501,ee=3e3,te=3001,ie=3007,ne=3002,ae=3004,re=3005,se=3006,oe=3200,le=3201,ce=7680,he=35044,ue=35048,de="300 es";function pe(){}Object.assign(pe.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return;const i=this._listeners[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}},dispatchEvent:function(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const i=t.slice(0);for(let t=0,n=i.length;t<n;t++)i[t].call(this,e)}}});const me=[];for(let e=0;e<256;e++)me[e]=(e<16?"0":"")+e.toString(16);let fe=1234567;const ge={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(me[255&e]+me[e>>8&255]+me[e>>16&255]+me[e>>24&255]+"-"+me[255&t]+me[t>>8&255]+"-"+me[t>>16&15|64]+me[t>>24&255]+"-"+me[63&i|128]+me[i>>8&255]+"-"+me[i>>16&255]+me[i>>24&255]+me[255&n]+me[n>>8&255]+me[n>>16&255]+me[n>>24&255]).toUpperCase()},clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,i,n,a){return n+(e-t)*(a-n)/(i-t)},lerp:function(e,t,i){return(1-i)*e+i*t},damp:function(e,t,i,n){return ge.lerp(e,t,1-Math.exp(-i*n))},pingpong:function(e,t=1){return t-Math.abs(ge.euclideanModulo(e,2*t)-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){return void 0!==e&&(fe=e%2147483647),fe=16807*fe%2147483647,(fe-1)/2147483646},degToRad:function(e){return e*ge.DEG2RAD},radToDeg:function(e){return e*ge.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,i,n,a){const r=Math.cos,s=Math.sin,o=r(i/2),l=s(i/2),c=r((t+n)/2),h=s((t+n)/2),u=r((t-n)/2),d=s((t-n)/2),p=r((n-t)/2),m=s((n-t)/2);switch(a){case"XYX":e.set(o*h,l*u,l*d,o*c);break;case"YZY":e.set(l*d,o*h,l*u,o*c);break;case"ZXZ":e.set(l*u,l*d,o*h,o*c);break;case"XZX":e.set(o*h,l*m,l*p,o*c);break;case"YXY":e.set(l*p,o*h,l*m,o*c);break;case"ZYZ":e.set(l*m,l*p,o*h,o*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+a)}}};class ye{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6],this.y=n[1]*t+n[4]*i+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),n=Math.sin(t),a=this.x-e.x,r=this.y-e.y;return this.x=a*i-r*n+e.x,this.y=a*n+r*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}ye.prototype.isVector2=!0;class ve{constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(e,t,i,n,a,r,s,o,l){const c=this.elements;return c[0]=e,c[1]=n,c[2]=s,c[3]=t,c[4]=a,c[5]=o,c[6]=i,c[7]=r,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,a=this.elements,r=i[0],s=i[3],o=i[6],l=i[1],c=i[4],h=i[7],u=i[2],d=i[5],p=i[8],m=n[0],f=n[3],g=n[6],y=n[1],v=n[4],b=n[7],_=n[2],x=n[5],w=n[8];return a[0]=r*m+s*y+o*_,a[3]=r*f+s*v+o*x,a[6]=r*g+s*b+o*w,a[1]=l*m+c*y+h*_,a[4]=l*f+c*v+h*x,a[7]=l*g+c*b+h*w,a[2]=u*m+d*y+p*_,a[5]=u*f+d*v+p*x,a[8]=u*g+d*b+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],n=e[2],a=e[3],r=e[4],s=e[5],o=e[6],l=e[7],c=e[8];return t*r*c-t*s*l-i*a*c+i*s*o+n*a*l-n*r*o}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],a=e[3],r=e[4],s=e[5],o=e[6],l=e[7],c=e[8],h=c*r-s*l,u=s*o-c*a,d=l*a-r*o,p=t*h+i*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return e[0]=h*m,e[1]=(n*l-c*i)*m,e[2]=(s*i-n*r)*m,e[3]=u*m,e[4]=(c*t-n*o)*m,e[5]=(n*a-s*t)*m,e[6]=d*m,e[7]=(i*o-l*t)*m,e[8]=(r*t-i*a)*m,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,n,a,r,s){const o=Math.cos(a),l=Math.sin(a);return this.set(i*o,i*l,-i*(o*r+l*s)+r+e,-n*l,n*o,-n*(-l*r+o*s)+s+t,0,0,1),this}scale(e,t){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=t,i[4]*=t,i[7]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),n=this.elements,a=n[0],r=n[3],s=n[6],o=n[1],l=n[4],c=n[7];return n[0]=t*a+i*o,n[3]=t*r+i*l,n[6]=t*s+i*c,n[1]=-i*a+t*o,n[4]=-i*r+t*l,n[7]=-i*s+t*c,this}translate(e,t){const i=this.elements;return i[0]+=e*i[2],i[3]+=e*i[5],i[6]+=e*i[8],i[1]+=t*i[2],i[4]+=t*i[5],i[7]+=t*i[8],this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}let be;ve.prototype.isMatrix3=!0;const _e={getDataURL:function(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===be&&(be=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),be.width=e.width,be.height=e.height;const i=be.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=be}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}};let xe=0;class we extends pe{constructor(e=we.DEFAULT_IMAGE,t=we.DEFAULT_MAPPING,i=1001,n=1001,a=1006,r=1008,s=1023,o=1009,l=1,c=3e3){super(),Object.defineProperty(this,"id",{value:xe++}),this.uuid=ge.generateUUID(),this.name="",this.image=e,this.mipmaps=[],this.mapping=t,this.wrapS=i,this.wrapT=n,this.magFilter=a,this.minFilter=r,this.anisotropy=l,this.format=s,this.internalFormat=null,this.type=o,this.offset=new ye(0,0),this.repeat=new ye(1,1),this.center=new ye(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new ve,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=c,this.version=0,this.onUpdate=null}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=ge.generateUUID()),!t&&void 0===e.images[n.uuid]){let t;if(Array.isArray(n)){t=[];for(let e=0,i=n.length;e<i;e++)n[e].isDataTexture?t.push(Se(n[e].image)):t.push(Se(n[e]))}else t=Se(n);e.images[n.uuid]={uuid:n.uuid,url:t}}i.image=n.uuid}return t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==r)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case d:e.x=e.x-Math.floor(e.x);break;case m:e.x=e.x<0?0:1;break;case f:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case d:e.y=e.y-Math.floor(e.y);break;case m:e.y=e.y<0?0:1;break;case f:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&this.version++}}function Se(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?_e.getDataURL(e):e.data?{data:Array.prototype.slice.call(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}we.DEFAULT_IMAGE=void 0,we.DEFAULT_MAPPING=r,we.prototype.isTexture=!0;class Me{constructor(e=0,t=0,i=0,n=1){this.x=e,this.y=t,this.z=i,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,a=this.w,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*n+r[12]*a,this.y=r[1]*t+r[5]*i+r[9]*n+r[13]*a,this.z=r[2]*t+r[6]*i+r[10]*n+r[14]*a,this.w=r[3]*t+r[7]*i+r[11]*n+r[15]*a,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,n,a;const r=.01,s=.1,o=e.elements,l=o[0],c=o[4],h=o[8],u=o[1],d=o[5],p=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(c-u)<r&&Math.abs(h-m)<r&&Math.abs(p-f)<r){if(Math.abs(c+u)<s&&Math.abs(h+m)<s&&Math.abs(p+f)<s&&Math.abs(l+d+g-3)<s)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(d+1)/2,y=(g+1)/2,v=(c+u)/4,b=(h+m)/4,_=(p+f)/4;return e>o&&e>y?e<r?(i=0,n=.707106781,a=.707106781):(i=Math.sqrt(e),n=v/i,a=b/i):o>y?o<r?(i=.707106781,n=0,a=.707106781):(n=Math.sqrt(o),i=v/n,a=_/n):y<r?(i=.707106781,n=.707106781,a=0):(a=Math.sqrt(y),i=b/a,n=_/a),this.set(i,n,a,t),this}let y=Math.sqrt((f-p)*(f-p)+(h-m)*(h-m)+(u-c)*(u-c));return Math.abs(y)<.001&&(y=1),this.x=(f-p)/y,this.y=(h-m)/y,this.z=(u-c)/y,this.w=Math.acos((l+d+g-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}Me.prototype.isVector4=!0;class Te extends pe{constructor(e,t,i){super(),this.width=e,this.height=t,this.depth=1,this.scissor=new Me(0,0,e,t),this.scissorTest=!1,this.viewport=new Me(0,0,e,t),i=i||{},this.texture=new we(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.image={},this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=1,this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:b,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}setTexture(e){e.image={width:this.width,height:this.height,depth:this.depth},this.texture=e}setSize(e,t,i=1){this.width===e&&this.height===t&&this.depth===i||(this.width=e,this.height=t,this.depth=i,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}Te.prototype.isWebGLRenderTarget=!0;class Ae extends Te{constructor(e,t,i){super(e,t,i),this.samples=4}copy(e){return super.copy.call(this,e),this.samples=e.samples,this}}Ae.prototype.isWebGLMultisampleRenderTarget=!0;class Ee{constructor(e=0,t=0,i=0,n=1){this._x=e,this._y=t,this._z=i,this._w=n}static slerp(e,t,i,n){return i.copy(e).slerp(t,n)}static slerpFlat(e,t,i,n,a,r,s){let o=i[n+0],l=i[n+1],c=i[n+2],h=i[n+3];const u=a[r+0],d=a[r+1],p=a[r+2],m=a[r+3];if(0===s)return e[t+0]=o,e[t+1]=l,e[t+2]=c,void(e[t+3]=h);if(1===s)return e[t+0]=u,e[t+1]=d,e[t+2]=p,void(e[t+3]=m);if(h!==m||o!==u||l!==d||c!==p){let e=1-s;const t=o*u+l*d+c*p+h*m,i=t>=0?1:-1,n=1-t*t;if(n>Number.EPSILON){const a=Math.sqrt(n),r=Math.atan2(a,t*i);e=Math.sin(e*r)/a,s=Math.sin(s*r)/a}const a=s*i;if(o=o*e+u*a,l=l*e+d*a,c=c*e+p*a,h=h*e+m*a,e===1-s){const e=1/Math.sqrt(o*o+l*l+c*c+h*h);o*=e,l*=e,c*=e,h*=e}}e[t]=o,e[t+1]=l,e[t+2]=c,e[t+3]=h}static multiplyQuaternionsFlat(e,t,i,n,a,r){const s=i[n],o=i[n+1],l=i[n+2],c=i[n+3],h=a[r],u=a[r+1],d=a[r+2],p=a[r+3];return e[t]=s*p+c*h+o*d-l*u,e[t+1]=o*p+c*u+l*h-s*d,e[t+2]=l*p+c*d+s*u-o*h,e[t+3]=c*p-s*h-o*u-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=e._x,n=e._y,a=e._z,r=e._order,s=Math.cos,o=Math.sin,l=s(i/2),c=s(n/2),h=s(a/2),u=o(i/2),d=o(n/2),p=o(a/2);switch(r){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+r)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],a=t[8],r=t[1],s=t[5],o=t[9],l=t[2],c=t[6],h=t[10],u=i+s+h;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(c-o)*e,this._y=(a-l)*e,this._z=(r-n)*e}else if(i>s&&i>h){const e=2*Math.sqrt(1+i-s-h);this._w=(c-o)/e,this._x=.25*e,this._y=(n+r)/e,this._z=(a+l)/e}else if(s>h){const e=2*Math.sqrt(1+s-i-h);this._w=(a-l)/e,this._x=(n+r)/e,this._y=.25*e,this._z=(o+c)/e}else{const e=2*Math.sqrt(1+h-i-s);this._w=(r-n)/e,this._x=(a+l)/e,this._y=(o+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<1e-6?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(ge.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const n=Math.min(1,t/i);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,n=e._y,a=e._z,r=e._w,s=t._x,o=t._y,l=t._z,c=t._w;return this._x=i*c+r*s+n*l-a*o,this._y=n*c+r*o+a*s-i*l,this._z=a*c+r*l+i*o-n*s,this._w=r*c-i*s-n*o-a*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,n=this._y,a=this._z,r=this._w;let s=r*e._w+i*e._x+n*e._y+a*e._z;if(s<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,s=-s):this.copy(e),s>=1)return this._w=r,this._x=i,this._y=n,this._z=a,this;const o=1-s*s;if(o<=Number.EPSILON){const e=1-t;return this._w=e*r+t*this._w,this._x=e*i+t*this._x,this._y=e*n+t*this._y,this._z=e*a+t*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(o),c=Math.atan2(l,s),h=Math.sin((1-t)*c)/l,u=Math.sin(t*c)/l;return this._w=r*h+this._w*u,this._x=i*h+this._x*u,this._y=n*h+this._y*u,this._z=a*h+this._z*u,this._onChangeCallback(),this}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Ee.prototype.isQuaternion=!0;class Ce{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Pe.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Pe.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,n=this.z,a=e.elements;return this.x=a[0]*t+a[3]*i+a[6]*n,this.y=a[1]*t+a[4]*i+a[7]*n,this.z=a[2]*t+a[5]*i+a[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,a=e.elements,r=1/(a[3]*t+a[7]*i+a[11]*n+a[15]);return this.x=(a[0]*t+a[4]*i+a[8]*n+a[12])*r,this.y=(a[1]*t+a[5]*i+a[9]*n+a[13])*r,this.z=(a[2]*t+a[6]*i+a[10]*n+a[14])*r,this}applyQuaternion(e){const t=this.x,i=this.y,n=this.z,a=e.x,r=e.y,s=e.z,o=e.w,l=o*t+r*n-s*i,c=o*i+s*t-a*n,h=o*n+a*i-r*t,u=-a*t-r*i-s*n;return this.x=l*o+u*-a+c*-s-h*-r,this.y=c*o+u*-r+h*-a-l*-s,this.z=h*o+u*-s+l*-r-c*-a,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,n=this.z,a=e.elements;return this.x=a[0]*t+a[4]*i+a[8]*n,this.y=a[1]*t+a[5]*i+a[9]*n,this.z=a[2]*t+a[6]*i+a[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,n=e.y,a=e.z,r=t.x,s=t.y,o=t.z;return this.x=n*o-a*s,this.y=a*r-i*o,this.z=i*s-n*r,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return Ie.copy(this).projectOnVector(e),this.sub(Ie)}reflect(e){return this.sub(Ie.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(ge.clamp(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const n=Math.sin(t)*e;return this.x=n*Math.sin(i),this.y=Math.cos(t)*e,this.z=n*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}Ce.prototype.isVector3=!0;const Ie=new Ce,Pe=new Ee;class Re{constructor(e=new Ce(1/0,1/0,1/0),t=new Ce(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,i=1/0,n=1/0,a=-1/0,r=-1/0,s=-1/0;for(let o=0,l=e.length;o<l;o+=3){const l=e[o],c=e[o+1],h=e[o+2];l<t&&(t=l),c<i&&(i=c),h<n&&(n=h),l>a&&(a=l),c>r&&(r=c),h>s&&(s=h)}return this.min.set(t,i,n),this.max.set(a,r,s),this}setFromBufferAttribute(e){let t=1/0,i=1/0,n=1/0,a=-1/0,r=-1/0,s=-1/0;for(let o=0,l=e.count;o<l;o++){const l=e.getX(o),c=e.getY(o),h=e.getZ(o);l<t&&(t=l),c<i&&(i=c),h<n&&(n=h),l>a&&(a=l),c>r&&(r=c),h>s&&(s=h)}return this.min.set(t,i,n),this.max.set(a,r,s),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=De.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e){return this.makeEmpty(),this.expandByObject(e)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return void 0===e&&(console.warn("THREE.Box3: .getCenter() target is now required"),e=new Ce),this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return void 0===e&&(console.warn("THREE.Box3: .getSize() target is now required"),e=new Ce),this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;void 0!==t&&(null===t.boundingBox&&t.computeBoundingBox(),Le.copy(t.boundingBox),Le.applyMatrix4(e.matrixWorld),this.union(Le));const i=e.children;for(let e=0,t=i.length;e<t;e++)this.expandByObject(i[e]);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return void 0===t&&(console.warn("THREE.Box3: .getParameter() target is now required"),t=new Ce),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,De),De.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(je),He.subVectors(this.max,je),ke.subVectors(e.a,je),Ne.subVectors(e.b,je),Be.subVectors(e.c,je),ze.subVectors(Ne,ke),Ue.subVectors(Be,Ne),Fe.subVectors(ke,Be);let t=[0,-ze.z,ze.y,0,-Ue.z,Ue.y,0,-Fe.z,Fe.y,ze.z,0,-ze.x,Ue.z,0,-Ue.x,Fe.z,0,-Fe.x,-ze.y,ze.x,0,-Ue.y,Ue.x,0,-Fe.y,Fe.x,0];return!!We(t,ke,Ne,Be,He)&&(t=[1,0,0,0,1,0,0,0,1],!!We(t,ke,Ne,Be,He)&&(Ge.crossVectors(ze,Ue),t=[Ge.x,Ge.y,Ge.z],We(t,ke,Ne,Be,He)))}clampPoint(e,t){return void 0===t&&(console.warn("THREE.Box3: .clampPoint() target is now required"),t=new Ce),t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return De.copy(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){return void 0===e&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(e.center),e.radius=.5*this.getSize(De).length(),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Oe[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Oe[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Oe[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Oe[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Oe[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Oe[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Oe[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Oe[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Oe)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}Re.prototype.isBox3=!0;const Oe=[new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce],De=new Ce,Le=new Re,ke=new Ce,Ne=new Ce,Be=new Ce,ze=new Ce,Ue=new Ce,Fe=new Ce,je=new Ce,He=new Ce,Ge=new Ce,Ve=new Ce;function We(e,t,i,n,a){for(let r=0,s=e.length-3;r<=s;r+=3){Ve.fromArray(e,r);const s=a.x*Math.abs(Ve.x)+a.y*Math.abs(Ve.y)+a.z*Math.abs(Ve.z),o=t.dot(Ve),l=i.dot(Ve),c=n.dot(Ve);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>s)return!1}return!0}const Ye=new Re;class Xe{constructor(e=new Ce,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;void 0!==t?i.copy(t):Ye.setFromPoints(e).getCenter(i);let n=0;for(let t=0,a=e.length;t<a;t++)n=Math.max(n,i.distanceToSquared(e[t]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return void 0===t&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),t=new Ce),t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return void 0===e&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),e=new Re),this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const Ze=new Ce,qe=new Ce,Je=new Ce,Qe=new Ce,Ke=new Ce,$e=new Ce,et=new Ce;class tt{constructor(e=new Ce,t=new Ce(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return void 0===t&&(console.warn("THREE.Ray: .at() target is now required"),t=new Ce),t.copy(this.direction).multiplyScalar(e).add(this.origin)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Ze)),this}closestPointToPoint(e,t){void 0===t&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),t=new Ce),t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Ze.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Ze.copy(this.direction).multiplyScalar(t).add(this.origin),Ze.distanceToSquared(e))}distanceSqToSegment(e,t,i,n){qe.copy(e).add(t).multiplyScalar(.5),Je.copy(t).sub(e).normalize(),Qe.copy(this.origin).sub(qe);const a=.5*e.distanceTo(t),r=-this.direction.dot(Je),s=Qe.dot(this.direction),o=-Qe.dot(Je),l=Qe.lengthSq(),c=Math.abs(1-r*r);let h,u,d,p;if(c>0)if(h=r*o-s,u=r*s-o,p=a*c,h>=0)if(u>=-p)if(u<=p){const e=1/c;h*=e,u*=e,d=h*(h+r*u+2*s)+u*(r*h+u+2*o)+l}else u=a,h=Math.max(0,-(r*u+s)),d=-h*h+u*(u+2*o)+l;else u=-a,h=Math.max(0,-(r*u+s)),d=-h*h+u*(u+2*o)+l;else u<=-p?(h=Math.max(0,-(-r*a+s)),u=h>0?-a:Math.min(Math.max(-a,-o),a),d=-h*h+u*(u+2*o)+l):u<=p?(h=0,u=Math.min(Math.max(-a,-o),a),d=u*(u+2*o)+l):(h=Math.max(0,-(r*a+s)),u=h>0?a:Math.min(Math.max(-a,-o),a),d=-h*h+u*(u+2*o)+l);else u=r>0?-a:a,h=Math.max(0,-(r*u+s)),d=-h*h+u*(u+2*o)+l;return i&&i.copy(this.direction).multiplyScalar(h).add(this.origin),n&&n.copy(Je).multiplyScalar(u).add(qe),d}intersectSphere(e,t){Ze.subVectors(e.center,this.origin);const i=Ze.dot(this.direction),n=Ze.dot(Ze)-i*i,a=e.radius*e.radius;if(n>a)return null;const r=Math.sqrt(a-n),s=i-r,o=i+r;return s<0&&o<0?null:s<0?this.at(o,t):this.at(s,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,n,a,r,s,o;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(i=(e.min.x-u.x)*l,n=(e.max.x-u.x)*l):(i=(e.max.x-u.x)*l,n=(e.min.x-u.x)*l),c>=0?(a=(e.min.y-u.y)*c,r=(e.max.y-u.y)*c):(a=(e.max.y-u.y)*c,r=(e.min.y-u.y)*c),i>r||a>n?null:((a>i||i!=i)&&(i=a),(r<n||n!=n)&&(n=r),h>=0?(s=(e.min.z-u.z)*h,o=(e.max.z-u.z)*h):(s=(e.max.z-u.z)*h,o=(e.min.z-u.z)*h),i>o||s>n?null:((s>i||i!=i)&&(i=s),(o<n||n!=n)&&(n=o),n<0?null:this.at(i>=0?i:n,t)))}intersectsBox(e){return null!==this.intersectBox(e,Ze)}intersectTriangle(e,t,i,n,a){Ke.subVectors(t,e),$e.subVectors(i,e),et.crossVectors(Ke,$e);let r,s=this.direction.dot(et);if(s>0){if(n)return null;r=1}else{if(!(s<0))return null;r=-1,s=-s}Qe.subVectors(this.origin,e);const o=r*this.direction.dot($e.crossVectors(Qe,$e));if(o<0)return null;const l=r*this.direction.dot(Ke.cross(Qe));if(l<0)return null;if(o+l>s)return null;const c=-r*Qe.dot(et);return c<0?null:this.at(c/s,a)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class it{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,i,n,a,r,s,o,l,c,h,u,d,p,m,f){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=n,g[1]=a,g[5]=r,g[9]=s,g[13]=o,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new it).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,n=1/nt.setFromMatrixColumn(e,0).length(),a=1/nt.setFromMatrixColumn(e,1).length(),r=1/nt.setFromMatrixColumn(e,2).length();return t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t[3]=0,t[4]=i[4]*a,t[5]=i[5]*a,t[6]=i[6]*a,t[7]=0,t[8]=i[8]*r,t[9]=i[9]*r,t[10]=i[10]*r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const t=this.elements,i=e.x,n=e.y,a=e.z,r=Math.cos(i),s=Math.sin(i),o=Math.cos(n),l=Math.sin(n),c=Math.cos(a),h=Math.sin(a);if("XYZ"===e.order){const e=r*c,i=r*h,n=s*c,a=s*h;t[0]=o*c,t[4]=-o*h,t[8]=l,t[1]=i+n*l,t[5]=e-a*l,t[9]=-s*o,t[2]=a-e*l,t[6]=n+i*l,t[10]=r*o}else if("YXZ"===e.order){const e=o*c,i=o*h,n=l*c,a=l*h;t[0]=e+a*s,t[4]=n*s-i,t[8]=r*l,t[1]=r*h,t[5]=r*c,t[9]=-s,t[2]=i*s-n,t[6]=a+e*s,t[10]=r*o}else if("ZXY"===e.order){const e=o*c,i=o*h,n=l*c,a=l*h;t[0]=e-a*s,t[4]=-r*h,t[8]=n+i*s,t[1]=i+n*s,t[5]=r*c,t[9]=a-e*s,t[2]=-r*l,t[6]=s,t[10]=r*o}else if("ZYX"===e.order){const e=r*c,i=r*h,n=s*c,a=s*h;t[0]=o*c,t[4]=n*l-i,t[8]=e*l+a,t[1]=o*h,t[5]=a*l+e,t[9]=i*l-n,t[2]=-l,t[6]=s*o,t[10]=r*o}else if("YZX"===e.order){const e=r*o,i=r*l,n=s*o,a=s*l;t[0]=o*c,t[4]=a-e*h,t[8]=n*h+i,t[1]=h,t[5]=r*c,t[9]=-s*c,t[2]=-l*c,t[6]=i*h+n,t[10]=e-a*h}else if("XZY"===e.order){const e=r*o,i=r*l,n=s*o,a=s*l;t[0]=o*c,t[4]=-h,t[8]=l*c,t[1]=e*h+a,t[5]=r*c,t[9]=i*h-n,t[2]=n*h-i,t[6]=s*c,t[10]=a*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(rt,e,st)}lookAt(e,t,i){const n=this.elements;return ct.subVectors(e,t),0===ct.lengthSq()&&(ct.z=1),ct.normalize(),ot.crossVectors(i,ct),0===ot.lengthSq()&&(1===Math.abs(i.z)?ct.x+=1e-4:ct.z+=1e-4,ct.normalize(),ot.crossVectors(i,ct)),ot.normalize(),lt.crossVectors(ct,ot),n[0]=ot.x,n[4]=lt.x,n[8]=ct.x,n[1]=ot.y,n[5]=lt.y,n[9]=ct.y,n[2]=ot.z,n[6]=lt.z,n[10]=ct.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,a=this.elements,r=i[0],s=i[4],o=i[8],l=i[12],c=i[1],h=i[5],u=i[9],d=i[13],p=i[2],m=i[6],f=i[10],g=i[14],y=i[3],v=i[7],b=i[11],_=i[15],x=n[0],w=n[4],S=n[8],M=n[12],T=n[1],A=n[5],E=n[9],C=n[13],I=n[2],P=n[6],R=n[10],O=n[14],D=n[3],L=n[7],k=n[11],N=n[15];return a[0]=r*x+s*T+o*I+l*D,a[4]=r*w+s*A+o*P+l*L,a[8]=r*S+s*E+o*R+l*k,a[12]=r*M+s*C+o*O+l*N,a[1]=c*x+h*T+u*I+d*D,a[5]=c*w+h*A+u*P+d*L,a[9]=c*S+h*E+u*R+d*k,a[13]=c*M+h*C+u*O+d*N,a[2]=p*x+m*T+f*I+g*D,a[6]=p*w+m*A+f*P+g*L,a[10]=p*S+m*E+f*R+g*k,a[14]=p*M+m*C+f*O+g*N,a[3]=y*x+v*T+b*I+_*D,a[7]=y*w+v*A+b*P+_*L,a[11]=y*S+v*E+b*R+_*k,a[15]=y*M+v*C+b*O+_*N,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],n=e[8],a=e[12],r=e[1],s=e[5],o=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+a*o*h-n*l*h-a*s*u+i*l*u+n*s*d-i*o*d)+e[7]*(+t*o*d-t*l*u+a*r*u-n*r*d+n*l*c-a*o*c)+e[11]*(+t*l*h-t*s*d-a*r*h+i*r*d+a*s*c-i*l*c)+e[15]*(-n*s*c-t*o*h+t*s*u+n*r*h-i*r*u+i*o*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=t,n[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],a=e[3],r=e[4],s=e[5],o=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11],p=e[12],m=e[13],f=e[14],g=e[15],y=h*f*l-m*u*l+m*o*d-s*f*d-h*o*g+s*u*g,v=p*u*l-c*f*l-p*o*d+r*f*d+c*o*g-r*u*g,b=c*m*l-p*h*l+p*s*d-r*m*d-c*s*g+r*h*g,_=p*h*o-c*m*o-p*s*u+r*m*u+c*s*f-r*h*f,x=t*y+i*v+n*b+a*_;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/x;return e[0]=y*w,e[1]=(m*u*a-h*f*a-m*n*d+i*f*d+h*n*g-i*u*g)*w,e[2]=(s*f*a-m*o*a+m*n*l-i*f*l-s*n*g+i*o*g)*w,e[3]=(h*o*a-s*u*a-h*n*l+i*u*l+s*n*d-i*o*d)*w,e[4]=v*w,e[5]=(c*f*a-p*u*a+p*n*d-t*f*d-c*n*g+t*u*g)*w,e[6]=(p*o*a-r*f*a-p*n*l+t*f*l+r*n*g-t*o*g)*w,e[7]=(r*u*a-c*o*a+c*n*l-t*u*l-r*n*d+t*o*d)*w,e[8]=b*w,e[9]=(p*h*a-c*m*a-p*i*d+t*m*d+c*i*g-t*h*g)*w,e[10]=(r*m*a-p*s*a+p*i*l-t*m*l-r*i*g+t*s*g)*w,e[11]=(c*s*a-r*h*a-c*i*l+t*h*l+r*i*d-t*s*d)*w,e[12]=_*w,e[13]=(c*m*n-p*h*n+p*i*u-t*m*u-c*i*f+t*h*f)*w,e[14]=(p*s*n-r*m*n-p*i*o+t*m*o+r*i*f-t*s*f)*w,e[15]=(r*h*n-c*s*n+c*i*o-t*h*o-r*i*u+t*s*u)*w,this}scale(e){const t=this.elements,i=e.x,n=e.y,a=e.z;return t[0]*=i,t[4]*=n,t[8]*=a,t[1]*=i,t[5]*=n,t[9]*=a,t[2]*=i,t[6]*=n,t[10]*=a,t[3]*=i,t[7]*=n,t[11]*=a,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,n))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),n=Math.sin(t),a=1-i,r=e.x,s=e.y,o=e.z,l=a*r,c=a*s;return this.set(l*r+i,l*s-n*o,l*o+n*s,0,l*s+n*o,c*s+i,c*o-n*r,0,l*o-n*s,c*o+n*r,a*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i){return this.set(1,t,i,0,e,1,i,0,e,t,1,0,0,0,0,1),this}compose(e,t,i){const n=this.elements,a=t._x,r=t._y,s=t._z,o=t._w,l=a+a,c=r+r,h=s+s,u=a*l,d=a*c,p=a*h,m=r*c,f=r*h,g=s*h,y=o*l,v=o*c,b=o*h,_=i.x,x=i.y,w=i.z;return n[0]=(1-(m+g))*_,n[1]=(d+b)*_,n[2]=(p-v)*_,n[3]=0,n[4]=(d-b)*x,n[5]=(1-(u+g))*x,n[6]=(f+y)*x,n[7]=0,n[8]=(p+v)*w,n[9]=(f-y)*w,n[10]=(1-(u+m))*w,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,t,i){const n=this.elements;let a=nt.set(n[0],n[1],n[2]).length();const r=nt.set(n[4],n[5],n[6]).length(),s=nt.set(n[8],n[9],n[10]).length();this.determinant()<0&&(a=-a),e.x=n[12],e.y=n[13],e.z=n[14],at.copy(this);const o=1/a,l=1/r,c=1/s;return at.elements[0]*=o,at.elements[1]*=o,at.elements[2]*=o,at.elements[4]*=l,at.elements[5]*=l,at.elements[6]*=l,at.elements[8]*=c,at.elements[9]*=c,at.elements[10]*=c,t.setFromRotationMatrix(at),i.x=a,i.y=r,i.z=s,this}makePerspective(e,t,i,n,a,r){void 0===r&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const s=this.elements,o=2*a/(t-e),l=2*a/(i-n),c=(t+e)/(t-e),h=(i+n)/(i-n),u=-(r+a)/(r-a),d=-2*r*a/(r-a);return s[0]=o,s[4]=0,s[8]=c,s[12]=0,s[1]=0,s[5]=l,s[9]=h,s[13]=0,s[2]=0,s[6]=0,s[10]=u,s[14]=d,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this}makeOrthographic(e,t,i,n,a,r){const s=this.elements,o=1/(t-e),l=1/(i-n),c=1/(r-a),h=(t+e)*o,u=(i+n)*l,d=(r+a)*c;return s[0]=2*o,s[4]=0,s[8]=0,s[12]=-h,s[1]=0,s[5]=2*l,s[9]=0,s[13]=-u,s[2]=0,s[6]=0,s[10]=-2*c,s[14]=-d,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}it.prototype.isMatrix4=!0;const nt=new Ce,at=new it,rt=new Ce(0,0,0),st=new Ce(1,1,1),ot=new Ce,lt=new Ce,ct=new Ce,ht=new it,ut=new Ee;class dt{constructor(e=0,t=0,i=0,n=dt.DefaultOrder){this._x=e,this._y=t,this._z=i,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._order=n||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t,i){const n=ge.clamp,a=e.elements,r=a[0],s=a[4],o=a[8],l=a[1],c=a[5],h=a[9],u=a[2],d=a[6],p=a[10];switch(t=t||this._order){case"XYZ":this._y=Math.asin(n(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(d,c),this._z=0);break;case"YXZ":this._x=Math.asin(-n(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(o,p),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-s,c)):(this._y=0,this._z=Math.atan2(l,r));break;case"ZYX":this._y=Math.asin(-n(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,p),this._z=Math.atan2(l,r)):(this._x=0,this._z=Math.atan2(-s,c));break;case"YZX":this._z=Math.asin(n(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(o,p));break;case"XZY":this._z=Math.asin(-n(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-h,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!1!==i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return ht.makeRotationFromQuaternion(e),this.setFromRotationMatrix(ht,t,i)}setFromVector3(e,t){return this.set(e.x,e.y,e.z,t||this._order)}reorder(e){return ut.setFromEuler(this),this.setFromQuaternion(ut,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}toVector3(e){return e?e.set(this._x,this._y,this._z):new Ce(this._x,this._y,this._z)}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}dt.prototype.isEuler=!0,dt.DefaultOrder="XYZ",dt.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class pt{constructor(){this.mask=1}set(e){this.mask=1<<e|0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return 0!=(this.mask&e.mask)}}let mt=0;const ft=new Ce,gt=new Ee,yt=new it,vt=new Ce,bt=new Ce,_t=new Ce,xt=new Ee,wt=new Ce(1,0,0),St=new Ce(0,1,0),Mt=new Ce(0,0,1),Tt={type:"added"},At={type:"removed"};function Et(){Object.defineProperty(this,"id",{value:mt++}),this.uuid=ge.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Et.DefaultUp.clone();const e=new Ce,t=new dt,i=new Ee,n=new Ce(1,1,1);t._onChange((function(){i.setFromEuler(t,!1)})),i._onChange((function(){t.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new it},normalMatrix:{value:new ve}}),this.matrix=new it,this.matrixWorld=new it,this.matrixAutoUpdate=Et.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new pt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}Et.DefaultUp=new Ce(0,1,0),Et.DefaultMatrixAutoUpdate=!0,Et.prototype=Object.assign(Object.create(pe.prototype),{constructor:Et,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(e){return this.quaternion.premultiply(e),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(e,t){return gt.setFromAxisAngle(e,t),this.quaternion.multiply(gt),this},rotateOnWorldAxis:function(e,t){return gt.setFromAxisAngle(e,t),this.quaternion.premultiply(gt),this},rotateX:function(e){return this.rotateOnAxis(wt,e)},rotateY:function(e){return this.rotateOnAxis(St,e)},rotateZ:function(e){return this.rotateOnAxis(Mt,e)},translateOnAxis:function(e,t){return ft.copy(e).applyQuaternion(this.quaternion),this.position.add(ft.multiplyScalar(t)),this},translateX:function(e){return this.translateOnAxis(wt,e)},translateY:function(e){return this.translateOnAxis(St,e)},translateZ:function(e){return this.translateOnAxis(Mt,e)},localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(e){return e.applyMatrix4(yt.copy(this.matrixWorld).invert())},lookAt:function(e,t,i){e.isVector3?vt.copy(e):vt.set(e,t,i);const n=this.parent;this.updateWorldMatrix(!0,!1),bt.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?yt.lookAt(bt,vt,this.up):yt.lookAt(vt,bt,this.up),this.quaternion.setFromRotationMatrix(yt),n&&(yt.extractRotation(n.matrixWorld),gt.setFromRotationMatrix(yt),this.quaternion.premultiply(gt.invert()))},add:function(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(Tt)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(At)),this},clear:function(){for(let e=0;e<this.children.length;e++){const t=this.children[e];t.parent=null,t.dispatchEvent(At)}return this.children.length=0,this},attach:function(e){return this.updateWorldMatrix(!0,!1),yt.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),yt.multiply(e.parent.matrixWorld)),e.applyMatrix4(yt),this.add(e),e.updateWorldMatrix(!1,!0),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(e,t);if(void 0!==n)return n}},getWorldPosition:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),e=new Ce),this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),e=new Ee),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(bt,e,_t),e},getWorldScale:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),e=new Ce),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(bt,xt,e),e},getWorldDirection:function(e){void 0===e&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),e=new Ce),this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()},raycast:function(){},traverse:function(e){e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverse(e)},traverseVisible:function(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverseVisible(e)},traverseAncestors:function(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].updateMatrixWorld(e)},updateWorldMatrix:function(e,t){const i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateWorldMatrix(!1,!0)}},toJSON:function(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function a(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){n.geometry=a(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,n=i.length;t<n;t++){const n=i[t];a(e.shapes,n)}else a(e.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(a(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,n=this.material.length;i<n;i++)t.push(a(e.materials,this.material[i]));n.material=t}else n.material=a(e.materials,this.material);if(this.children.length>0){n.children=[];for(let t=0;t<this.children.length;t++)n.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let t=0;t<this.animations.length;t++){const i=this.animations[t];n.animations.push(a(e.animations,i))}}if(t){const t=r(e.geometries),n=r(e.materials),a=r(e.textures),s=r(e.images),o=r(e.shapes),l=r(e.skeletons),c=r(e.animations);t.length>0&&(i.geometries=t),n.length>0&&(i.materials=n),a.length>0&&(i.textures=a),s.length>0&&(i.images=s),o.length>0&&(i.shapes=o),l.length>0&&(i.skeletons=l),c.length>0&&(i.animations=c)}return i.object=n,i;function r(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const i=e.children[t];this.add(i.clone())}return this}});const Ct=new Ce,It=new Ce,Pt=new ve;class Rt{constructor(e=new Ce(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const n=Ct.subVectors(i,t).cross(It.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return void 0===t&&(console.warn("THREE.Plane: .projectPoint() target is now required"),t=new Ce),t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}intersectLine(e,t){void 0===t&&(console.warn("THREE.Plane: .intersectLine() target is now required"),t=new Ce);const i=e.delta(Ct),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(e.start)?t.copy(e.start):void 0;const a=-(e.start.dot(this.normal)+this.constant)/n;return a<0||a>1?void 0:t.copy(i).multiplyScalar(a).add(e.start)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return void 0===e&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),e=new Ce),e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||Pt.getNormalMatrix(e),n=this.coplanarPoint(Ct).applyMatrix4(e),a=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(a),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}Rt.prototype.isPlane=!0;const Ot=new Ce,Dt=new Ce,Lt=new Ce,kt=new Ce,Nt=new Ce,Bt=new Ce,zt=new Ce,Ut=new Ce,Ft=new Ce,jt=new Ce;class Ht{constructor(e=new Ce,t=new Ce,i=new Ce){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,n){void 0===n&&(console.warn("THREE.Triangle: .getNormal() target is now required"),n=new Ce),n.subVectors(i,t),Ot.subVectors(e,t),n.cross(Ot);const a=n.lengthSq();return a>0?n.multiplyScalar(1/Math.sqrt(a)):n.set(0,0,0)}static getBarycoord(e,t,i,n,a){Ot.subVectors(n,t),Dt.subVectors(i,t),Lt.subVectors(e,t);const r=Ot.dot(Ot),s=Ot.dot(Dt),o=Ot.dot(Lt),l=Dt.dot(Dt),c=Dt.dot(Lt),h=r*l-s*s;if(void 0===a&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),a=new Ce),0===h)return a.set(-2,-1,-1);const u=1/h,d=(l*o-s*c)*u,p=(r*c-s*o)*u;return a.set(1-d-p,p,d)}static containsPoint(e,t,i,n){return this.getBarycoord(e,t,i,n,kt),kt.x>=0&&kt.y>=0&&kt.x+kt.y<=1}static getUV(e,t,i,n,a,r,s,o){return this.getBarycoord(e,t,i,n,kt),o.set(0,0),o.addScaledVector(a,kt.x),o.addScaledVector(r,kt.y),o.addScaledVector(s,kt.z),o}static isFrontFacing(e,t,i,n){return Ot.subVectors(i,t),Dt.subVectors(e,t),Ot.cross(Dt).dot(n)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,n){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[n]),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Ot.subVectors(this.c,this.b),Dt.subVectors(this.a,this.b),.5*Ot.cross(Dt).length()}getMidpoint(e){return void 0===e&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),e=new Ce),e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Ht.getNormal(this.a,this.b,this.c,e)}getPlane(e){return void 0===e&&(console.warn("THREE.Triangle: .getPlane() target is now required"),e=new Rt),e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Ht.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,i,n,a){return Ht.getUV(e,this.a,this.b,this.c,t,i,n,a)}containsPoint(e){return Ht.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Ht.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){void 0===t&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),t=new Ce);const i=this.a,n=this.b,a=this.c;let r,s;Nt.subVectors(n,i),Bt.subVectors(a,i),Ut.subVectors(e,i);const o=Nt.dot(Ut),l=Bt.dot(Ut);if(o<=0&&l<=0)return t.copy(i);Ft.subVectors(e,n);const c=Nt.dot(Ft),h=Bt.dot(Ft);if(c>=0&&h<=c)return t.copy(n);const u=o*h-c*l;if(u<=0&&o>=0&&c<=0)return r=o/(o-c),t.copy(i).addScaledVector(Nt,r);jt.subVectors(e,a);const d=Nt.dot(jt),p=Bt.dot(jt);if(p>=0&&d<=p)return t.copy(a);const m=d*l-o*p;if(m<=0&&l>=0&&p<=0)return s=l/(l-p),t.copy(i).addScaledVector(Bt,s);const f=c*p-d*h;if(f<=0&&h-c>=0&&d-p>=0)return zt.subVectors(a,n),s=(h-c)/(h-c+(d-p)),t.copy(n).addScaledVector(zt,s);const g=1/(f+m+u);return r=m*g,s=u*g,t.copy(i).addScaledVector(Nt,r).addScaledVector(Bt,s)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let Gt=0;function Vt(){Object.defineProperty(this,"id",{value:Gt++}),this.uuid=ge.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=a,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=ce,this.stencilZFail=ce,this.stencilZPass=ce,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}Vt.prototype=Object.assign(Object.create(pe.prototype),{constructor:Vt,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}if("shading"===t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;continue}const n=this[t];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[t]=i:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}},toJSON:function(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(i.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,i.reflectivity=this.reflectivity,i.refractionRatio=this.refractionRatio,void 0!==this.combine&&(i.combine=this.combine),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.morphNormals&&(i.morphNormals=!0),!0===this.skinning&&(i.skinning=!0),!0===this.flatShading&&(i.flatShading=this.flatShading),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),t){const t=n(e.textures),a=n(e.images);t.length>0&&(i.textures=t),a.length>0&&(i.images=a)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let n=0;n!==e;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(Vt.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}});const Wt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Yt={h:0,s:0,l:0},Xt={h:0,s:0,l:0};function Zt(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}function qt(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Jt(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class Qt{constructor(e,t,i){return void 0===t&&void 0===i?this.set(e):this.setRGB(e,t,i)}set(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this}setRGB(e,t,i){return this.r=e,this.g=t,this.b=i,this}setHSL(e,t,i){if(e=ge.euclideanModulo(e,1),t=ge.clamp(t,0,1),i=ge.clamp(i,0,1),0===t)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+t):i+t-i*t,a=2*i-n;this.r=Zt(a,n,e+1/3),this.g=Zt(a,n,e),this.b=Zt(a,n,e-1/3)}return this}setStyle(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(e)){let e;const n=i[1],a=i[2];switch(n){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return this.r=Math.min(255,parseInt(e[1],10))/255,this.g=Math.min(255,parseInt(e[2],10))/255,this.b=Math.min(255,parseInt(e[3],10))/255,t(e[4]),this;if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return this.r=Math.min(100,parseInt(e[1],10))/100,this.g=Math.min(100,parseInt(e[2],10))/100,this.b=Math.min(100,parseInt(e[3],10))/100,t(e[4]),this;break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a)){const i=parseFloat(e[1])/360,n=parseInt(e[2],10)/100,a=parseInt(e[3],10)/100;return t(e[4]),this.setHSL(i,n,a)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=i[1],t=e.length;if(3===t)return this.r=parseInt(e.charAt(0)+e.charAt(0),16)/255,this.g=parseInt(e.charAt(1)+e.charAt(1),16)/255,this.b=parseInt(e.charAt(2)+e.charAt(2),16)/255,this;if(6===t)return this.r=parseInt(e.charAt(0)+e.charAt(1),16)/255,this.g=parseInt(e.charAt(2)+e.charAt(3),16)/255,this.b=parseInt(e.charAt(4)+e.charAt(5),16)/255,this}return e&&e.length>0?this.setColorName(e):this}setColorName(e){const t=Wt[e];return void 0!==t?this.setHex(t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyGammaToLinear(e,t=2){return this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this}copyLinearToGamma(e,t=2){const i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this}convertGammaToLinear(e){return this.copyGammaToLinear(this,e),this}convertLinearToGamma(e){return this.copyLinearToGamma(this,e),this}copySRGBToLinear(e){return this.r=qt(e.r),this.g=qt(e.g),this.b=qt(e.b),this}copyLinearToSRGB(e){return this.r=Jt(e.r),this.g=Jt(e.g),this.b=Jt(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(e){void 0===e&&(console.warn("THREE.Color: .getHSL() target is now required"),e={h:0,s:0,l:0});const t=this.r,i=this.g,n=this.b,a=Math.max(t,i,n),r=Math.min(t,i,n);let s,o;const l=(r+a)/2;if(r===a)s=0,o=0;else{const e=a-r;switch(o=l<=.5?e/(a+r):e/(2-a-r),a){case t:s=(i-n)/e+(i<n?6:0);break;case i:s=(n-t)/e+2;break;case n:s=(t-i)/e+4}s/=6}return e.h=s,e.s=o,e.l=l,e}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(e,t,i){return this.getHSL(Yt),Yt.h+=e,Yt.s+=t,Yt.l+=i,this.setHSL(Yt.h,Yt.s,Yt.l),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(Yt),e.getHSL(Xt);const i=ge.lerp(Yt.h,Xt.h,t),n=ge.lerp(Yt.s,Xt.s,t),a=ge.lerp(Yt.l,Xt.l,t);return this.setHSL(i,n,a),this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),!0===e.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}Qt.NAMES=Wt,Qt.prototype.isColor=!0,Qt.prototype.r=1,Qt.prototype.g=1,Qt.prototype.b=1;class Kt extends Vt{constructor(e){super(),this.type="MeshBasicMaterial",this.color=new Qt(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this}}Kt.prototype.isMeshBasicMaterial=!0;const $t=new Ce,ei=new ye;function ti(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===i,this.usage=he,this.updateRange={offset:0,count:-1},this.version=0}function ii(e,t,i){ti.call(this,new Int8Array(e),t,i)}function ni(e,t,i){ti.call(this,new Uint8Array(e),t,i)}function ai(e,t,i){ti.call(this,new Uint8ClampedArray(e),t,i)}function ri(e,t,i){ti.call(this,new Int16Array(e),t,i)}function si(e,t,i){ti.call(this,new Uint16Array(e),t,i)}function oi(e,t,i){ti.call(this,new Int32Array(e),t,i)}function li(e,t,i){ti.call(this,new Uint32Array(e),t,i)}function ci(e,t,i){ti.call(this,new Uint16Array(e),t,i)}function hi(e,t,i){ti.call(this,new Float32Array(e),t,i)}function ui(e,t,i){ti.call(this,new Float64Array(e),t,i)}function di(e){if(0===e.length)return-1/0;let t=e[0];for(let i=1,n=e.length;i<n;++i)e[i]>t&&(t=e[i]);return t}Object.defineProperty(ti.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(ti.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(e){return this.usage=e,this},copy:function(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this},copyAt:function(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let n=0,a=this.itemSize;n<a;n++)this.array[e+n]=t.array[i+n];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){const t=this.array;let i=0;for(let n=0,a=e.length;n<a;n++){let a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),a=new Qt),t[i++]=a.r,t[i++]=a.g,t[i++]=a.b}return this},copyVector2sArray:function(e){const t=this.array;let i=0;for(let n=0,a=e.length;n<a;n++){let a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),a=new ye),t[i++]=a.x,t[i++]=a.y}return this},copyVector3sArray:function(e){const t=this.array;let i=0;for(let n=0,a=e.length;n<a;n++){let a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),a=new Ce),t[i++]=a.x,t[i++]=a.y,t[i++]=a.z}return this},copyVector4sArray:function(e){const t=this.array;let i=0;for(let n=0,a=e.length;n<a;n++){let a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),a=new Me),t[i++]=a.x,t[i++]=a.y,t[i++]=a.z,t[i++]=a.w}return this},applyMatrix3:function(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)ei.fromBufferAttribute(this,t),ei.applyMatrix3(e),this.setXY(t,ei.x,ei.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)$t.fromBufferAttribute(this,t),$t.applyMatrix3(e),this.setXYZ(t,$t.x,$t.y,$t.z);return this},applyMatrix4:function(e){for(let t=0,i=this.count;t<i;t++)$t.x=this.getX(t),$t.y=this.getY(t),$t.z=this.getZ(t),$t.applyMatrix4(e),this.setXYZ(t,$t.x,$t.y,$t.z);return this},applyNormalMatrix:function(e){for(let t=0,i=this.count;t<i;t++)$t.x=this.getX(t),$t.y=this.getY(t),$t.z=this.getZ(t),$t.applyNormalMatrix(e),this.setXYZ(t,$t.x,$t.y,$t.z);return this},transformDirection:function(e){for(let t=0,i=this.count;t<i;t++)$t.x=this.getX(t),$t.y=this.getY(t),$t.z=this.getZ(t),$t.transformDirection(e),this.setXYZ(t,$t.x,$t.y,$t.z);return this},set:function(e,t=0){return this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this},setXYZ:function(e,t,i,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this},setXYZW:function(e,t,i,n,a){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this.array[e+3]=a,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),ii.prototype=Object.create(ti.prototype),ii.prototype.constructor=ii,ni.prototype=Object.create(ti.prototype),ni.prototype.constructor=ni,ai.prototype=Object.create(ti.prototype),ai.prototype.constructor=ai,ri.prototype=Object.create(ti.prototype),ri.prototype.constructor=ri,si.prototype=Object.create(ti.prototype),si.prototype.constructor=si,oi.prototype=Object.create(ti.prototype),oi.prototype.constructor=oi,li.prototype=Object.create(ti.prototype),li.prototype.constructor=li,ci.prototype=Object.create(ti.prototype),ci.prototype.constructor=ci,ci.prototype.isFloat16BufferAttribute=!0,hi.prototype=Object.create(ti.prototype),hi.prototype.constructor=hi,ui.prototype=Object.create(ti.prototype),ui.prototype.constructor=ui;const pi={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function mi(e,t){return new pi[e](t)}let fi=0;const gi=new it,yi=new Et,vi=new Ce,bi=new Re,_i=new Re,xi=new Ce;function wi(){Object.defineProperty(this,"id",{value:fi++}),this.uuid=ge.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}wi.prototype=Object.assign(Object.create(pe.prototype),{constructor:wi,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){return Array.isArray(e)?this.index=new(di(e)>65535?li:si)(e,1):this.index=e,this},getAttribute:function(e){return this.attributes[e]},setAttribute:function(e,t){return this.attributes[e]=t,this},deleteAttribute:function(e){return delete this.attributes[e],this},hasAttribute:function(e){return void 0!==this.attributes[e]},addGroup:function(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix4:function(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new ve).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(e){return gi.makeRotationX(e),this.applyMatrix4(gi),this},rotateY:function(e){return gi.makeRotationY(e),this.applyMatrix4(gi),this},rotateZ:function(e){return gi.makeRotationZ(e),this.applyMatrix4(gi),this},translate:function(e,t,i){return gi.makeTranslation(e,t,i),this.applyMatrix4(gi),this},scale:function(e,t,i){return gi.makeScale(e,t,i),this.applyMatrix4(gi),this},lookAt:function(e){return yi.lookAt(e),yi.updateMatrix(),this.applyMatrix4(yi.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(vi).negate(),this.translate(vi.x,vi.y,vi.z),this},setFromPoints:function(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i];t.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new hi(t,3)),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Re);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new Ce(-1/0,-1/0,-1/0),new Ce(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];bi.setFromBufferAttribute(i),this.morphTargetsRelative?(xi.addVectors(this.boundingBox.min,bi.min),this.boundingBox.expandByPoint(xi),xi.addVectors(this.boundingBox.max,bi.max),this.boundingBox.expandByPoint(xi)):(this.boundingBox.expandByPoint(bi.min),this.boundingBox.expandByPoint(bi.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Xe);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new Ce,1/0);if(e){const i=this.boundingSphere.center;if(bi.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];_i.setFromBufferAttribute(i),this.morphTargetsRelative?(xi.addVectors(bi.min,_i.min),bi.expandByPoint(xi),xi.addVectors(bi.max,_i.max),bi.expandByPoint(xi)):(bi.expandByPoint(_i.min),bi.expandByPoint(_i.max))}bi.getCenter(i);let n=0;for(let t=0,a=e.count;t<a;t++)xi.fromBufferAttribute(e,t),n=Math.max(n,i.distanceToSquared(xi));if(t)for(let a=0,r=t.length;a<r;a++){const r=t[a],s=this.morphTargetsRelative;for(let t=0,a=r.count;t<a;t++)xi.fromBufferAttribute(r,t),s&&(vi.fromBufferAttribute(e,t),xi.add(vi)),n=Math.max(n,i.distanceToSquared(xi))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeTangents:function(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=e.array,n=t.position.array,a=t.normal.array,r=t.uv.array,s=n.length/3;void 0===t.tangent&&this.setAttribute("tangent",new ti(new Float32Array(4*s),4));const o=t.tangent.array,l=[],c=[];for(let e=0;e<s;e++)l[e]=new Ce,c[e]=new Ce;const h=new Ce,u=new Ce,d=new Ce,p=new ye,m=new ye,f=new ye,g=new Ce,y=new Ce;function v(e,t,i){h.fromArray(n,3*e),u.fromArray(n,3*t),d.fromArray(n,3*i),p.fromArray(r,2*e),m.fromArray(r,2*t),f.fromArray(r,2*i),u.sub(h),d.sub(h),m.sub(p),f.sub(p);const a=1/(m.x*f.y-f.x*m.y);isFinite(a)&&(g.copy(u).multiplyScalar(f.y).addScaledVector(d,-m.y).multiplyScalar(a),y.copy(d).multiplyScalar(m.x).addScaledVector(u,-f.x).multiplyScalar(a),l[e].add(g),l[t].add(g),l[i].add(g),c[e].add(y),c[t].add(y),c[i].add(y))}let b=this.groups;0===b.length&&(b=[{start:0,count:i.length}]);for(let e=0,t=b.length;e<t;++e){const t=b[e],n=t.start;for(let e=n,a=n+t.count;e<a;e+=3)v(i[e+0],i[e+1],i[e+2])}const _=new Ce,x=new Ce,w=new Ce,S=new Ce;function M(e){w.fromArray(a,3*e),S.copy(w);const t=l[e];_.copy(t),_.sub(w.multiplyScalar(w.dot(t))).normalize(),x.crossVectors(S,t);const i=x.dot(c[e])<0?-1:1;o[4*e]=_.x,o[4*e+1]=_.y,o[4*e+2]=_.z,o[4*e+3]=i}for(let e=0,t=b.length;e<t;++e){const t=b[e],n=t.start;for(let e=n,a=n+t.count;e<a;e+=3)M(i[e+0]),M(i[e+1]),M(i[e+2])}},computeVertexNormals:function(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new ti(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const n=new Ce,a=new Ce,r=new Ce,s=new Ce,o=new Ce,l=new Ce,c=new Ce,h=new Ce;if(e)for(let u=0,d=e.count;u<d;u+=3){const d=e.getX(u+0),p=e.getX(u+1),m=e.getX(u+2);n.fromBufferAttribute(t,d),a.fromBufferAttribute(t,p),r.fromBufferAttribute(t,m),c.subVectors(r,a),h.subVectors(n,a),c.cross(h),s.fromBufferAttribute(i,d),o.fromBufferAttribute(i,p),l.fromBufferAttribute(i,m),s.add(c),o.add(c),l.add(c),i.setXYZ(d,s.x,s.y,s.z),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,s=t.count;e<s;e+=3)n.fromBufferAttribute(t,e+0),a.fromBufferAttribute(t,e+1),r.fromBufferAttribute(t,e+2),c.subVectors(r,a),h.subVectors(n,a),c.cross(h),i.setXYZ(e+0,c.x,c.y,c.z),i.setXYZ(e+1,c.x,c.y,c.z),i.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),i.needsUpdate=!0}},merge:function(e,t){if(!e||!e.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const n in i){if(void 0===e.attributes[n])continue;const a=i[n].array,r=e.attributes[n],s=r.array,o=r.itemSize*t,l=Math.min(s.length,a.length-o);for(let e=0,t=o;e<l;e++,t++)a[t]=s[e]}return this},normalizeNormals:function(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)xi.fromBufferAttribute(e,t),xi.normalize(),e.setXYZ(t,xi.x,xi.y,xi.z)},toNonIndexed:function(){function e(e,t){const i=e.array,n=e.itemSize,a=e.normalized,r=new i.constructor(t.length*n);let s=0,o=0;for(let e=0,a=t.length;e<a;e++){s=t[e]*n;for(let e=0;e<n;e++)r[o++]=i[s++]}return new ti(r,n,a)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new wi,i=this.index.array,n=this.attributes;for(const a in n){const r=e(n[a],i);t.setAttribute(a,r)}const a=this.morphAttributes;for(const n in a){const r=[],s=a[n];for(let t=0,n=s.length;t<n;t++){const n=e(s[t],i);r.push(n)}t.morphAttributes[n]=r}t.morphTargetsRelative=this.morphTargetsRelative;const r=this.groups;for(let e=0,i=r.length;e<i;e++){const i=r[e];t.addGroup(i.start,i.count,i.materialIndex)}return t},toJSON:function(){const e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const t in i){const n=i[t],a=n.toJSON(e.data);""!==n.name&&(a.name=n.name),e.data.attributes[t]=a}const n={};let a=!1;for(const t in this.morphAttributes){const i=this.morphAttributes[t],r=[];for(let t=0,n=i.length;t<n;t++){const n=i[t],a=n.toJSON(e.data);""!==n.name&&(a.name=n.name),r.push(a)}r.length>0&&(n[t]=r,a=!0)}a&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);const r=this.groups;r.length>0&&(e.data.groups=JSON.parse(JSON.stringify(r)));const s=this.boundingSphere;return null!==s&&(e.data.boundingSphere={center:s.center.toArray(),radius:s.radius}),e},clone:function(){return(new wi).copy(this)},copy:function(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone(t));const n=e.attributes;for(const e in n){const i=n[e];this.setAttribute(e,i.clone(t))}const a=e.morphAttributes;for(const e in a){const i=[],n=a[e];for(let e=0,a=n.length;e<a;e++)i.push(n[e].clone(t));this.morphAttributes[e]=i}this.morphTargetsRelative=e.morphTargetsRelative;const r=e.groups;for(let e=0,t=r.length;e<t;e++){const t=r[e];this.addGroup(t.start,t.count,t.materialIndex)}const s=e.boundingBox;null!==s&&(this.boundingBox=s.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});const Si=new it,Mi=new tt,Ti=new Xe,Ai=new Ce,Ei=new Ce,Ci=new Ce,Ii=new Ce,Pi=new Ce,Ri=new Ce,Oi=new Ce,Di=new Ce,Li=new Ce,ki=new ye,Ni=new ye,Bi=new ye,zi=new Ce,Ui=new Ce;function Fi(e=new wi,t=new Kt){Et.call(this),this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}function ji(e,t,i,n,a,r,s,o,l,c,h,u){Ai.fromBufferAttribute(a,c),Ei.fromBufferAttribute(a,h),Ci.fromBufferAttribute(a,u);const d=e.morphTargetInfluences;if(t.morphTargets&&r&&d){Oi.set(0,0,0),Di.set(0,0,0),Li.set(0,0,0);for(let e=0,t=r.length;e<t;e++){const t=d[e],i=r[e];0!==t&&(Ii.fromBufferAttribute(i,c),Pi.fromBufferAttribute(i,h),Ri.fromBufferAttribute(i,u),s?(Oi.addScaledVector(Ii,t),Di.addScaledVector(Pi,t),Li.addScaledVector(Ri,t)):(Oi.addScaledVector(Ii.sub(Ai),t),Di.addScaledVector(Pi.sub(Ei),t),Li.addScaledVector(Ri.sub(Ci),t)))}Ai.add(Oi),Ei.add(Di),Ci.add(Li)}e.isSkinnedMesh&&t.skinning&&(e.boneTransform(c,Ai),e.boneTransform(h,Ei),e.boneTransform(u,Ci));const p=function(e,t,i,n,a,r,s,o){let l;if(l=1===t.side?n.intersectTriangle(s,r,a,!0,o):n.intersectTriangle(a,r,s,2!==t.side,o),null===l)return null;Ui.copy(o),Ui.applyMatrix4(e.matrixWorld);const c=i.ray.origin.distanceTo(Ui);return c<i.near||c>i.far?null:{distance:c,point:Ui.clone(),object:e}}(e,t,i,n,Ai,Ei,Ci,zi);if(p){o&&(ki.fromBufferAttribute(o,c),Ni.fromBufferAttribute(o,h),Bi.fromBufferAttribute(o,u),p.uv=Ht.getUV(zi,Ai,Ei,Ci,ki,Ni,Bi,new ye)),l&&(ki.fromBufferAttribute(l,c),Ni.fromBufferAttribute(l,h),Bi.fromBufferAttribute(l,u),p.uv2=Ht.getUV(zi,Ai,Ei,Ci,ki,Ni,Bi,new ye));const e={a:c,b:h,c:u,normal:new Ce,materialIndex:0};Ht.getNormal(Ai,Ei,Ci,e.normal),p.face=e}return p}Fi.prototype=Object.assign(Object.create(Et.prototype),{constructor:Fi,isMesh:!0,copy:function(e){return Et.prototype.copy.call(this,e),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=e.material,this.geometry=e.geometry,this},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(e,t){const i=this.geometry,n=this.material,a=this.matrixWorld;if(void 0===n)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),Ti.copy(i.boundingSphere),Ti.applyMatrix4(a),!1===e.ray.intersectsSphere(Ti))return;if(Si.copy(a).invert(),Mi.copy(e.ray).applyMatrix4(Si),null!==i.boundingBox&&!1===Mi.intersectsBox(i.boundingBox))return;let r;if(i.isBufferGeometry){const a=i.index,s=i.attributes.position,o=i.morphAttributes.position,l=i.morphTargetsRelative,c=i.attributes.uv,h=i.attributes.uv2,u=i.groups,d=i.drawRange;if(null!==a)if(Array.isArray(n))for(let i=0,p=u.length;i<p;i++){const p=u[i],m=n[p.materialIndex];for(let i=Math.max(p.start,d.start),n=Math.min(p.start+p.count,d.start+d.count);i<n;i+=3){const n=a.getX(i),u=a.getX(i+1),d=a.getX(i+2);r=ji(this,m,e,Mi,s,o,l,c,h,n,u,d),r&&(r.faceIndex=Math.floor(i/3),r.face.materialIndex=p.materialIndex,t.push(r))}}else{for(let i=Math.max(0,d.start),u=Math.min(a.count,d.start+d.count);i<u;i+=3){const u=a.getX(i),d=a.getX(i+1),p=a.getX(i+2);r=ji(this,n,e,Mi,s,o,l,c,h,u,d,p),r&&(r.faceIndex=Math.floor(i/3),t.push(r))}}else if(void 0!==s)if(Array.isArray(n))for(let i=0,a=u.length;i<a;i++){const a=u[i],p=n[a.materialIndex];for(let i=Math.max(a.start,d.start),n=Math.min(a.start+a.count,d.start+d.count);i<n;i+=3){r=ji(this,p,e,Mi,s,o,l,c,h,i,i+1,i+2),r&&(r.faceIndex=Math.floor(i/3),r.face.materialIndex=a.materialIndex,t.push(r))}}else{for(let i=Math.max(0,d.start),a=Math.min(s.count,d.start+d.count);i<a;i+=3){r=ji(this,n,e,Mi,s,o,l,c,h,i,i+1,i+2),r&&(r.faceIndex=Math.floor(i/3),t.push(r))}}}else i.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}});class Hi extends wi{constructor(e=1,t=1,i=1,n=1,a=1,r=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:a,depthSegments:r};const s=this;n=Math.floor(n),a=Math.floor(a),r=Math.floor(r);const o=[],l=[],c=[],h=[];let u=0,d=0;function p(e,t,i,n,a,r,p,m,f,g,y){const v=r/f,b=p/g,_=r/2,x=p/2,w=m/2,S=f+1,M=g+1;let T=0,A=0;const E=new Ce;for(let r=0;r<M;r++){const s=r*b-x;for(let o=0;o<S;o++){const u=o*v-_;E[e]=u*n,E[t]=s*a,E[i]=w,l.push(E.x,E.y,E.z),E[e]=0,E[t]=0,E[i]=m>0?1:-1,c.push(E.x,E.y,E.z),h.push(o/f),h.push(1-r/g),T+=1}}for(let e=0;e<g;e++)for(let t=0;t<f;t++){const i=u+t+S*e,n=u+t+S*(e+1),a=u+(t+1)+S*(e+1),r=u+(t+1)+S*e;o.push(i,n,r),o.push(n,a,r),A+=6}s.addGroup(d,A,y),d+=A,u+=T}p("z","y","x",-1,-1,i,t,e,r,a,0),p("z","y","x",1,-1,i,t,-e,r,a,1),p("x","z","y",1,1,e,i,t,n,r,2),p("x","z","y",1,-1,e,i,-t,n,r,3),p("x","y","z",1,-1,e,t,i,n,a,4),p("x","y","z",-1,-1,e,t,-i,n,a,5),this.setIndex(o),this.setAttribute("position",new hi(l,3)),this.setAttribute("normal",new hi(c,3)),this.setAttribute("uv",new hi(h,2))}}function Gi(e){const t={};for(const i in e){t[i]={};for(const n in e[i]){const a=e[i][n];a&&(a.isColor||a.isMatrix3||a.isMatrix4||a.isVector2||a.isVector3||a.isVector4||a.isTexture||a.isQuaternion)?t[i][n]=a.clone():Array.isArray(a)?t[i][n]=a.slice():t[i][n]=a}}return t}function Vi(e){const t={};for(let i=0;i<e.length;i++){const n=Gi(e[i]);for(const e in n)t[e]=n[e]}return t}const Wi={clone:Gi,merge:Vi};function Yi(e){Vt.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function Xi(){Et.call(this),this.type="Camera",this.matrixWorldInverse=new it,this.projectionMatrix=new it,this.projectionMatrixInverse=new it}function Zi(e=50,t=1,i=.1,n=2e3){Xi.call(this),this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}Yi.prototype=Object.create(Vt.prototype),Yi.prototype.constructor=Yi,Yi.prototype.isShaderMaterial=!0,Yi.prototype.copy=function(e){return Vt.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Gi(e.uniforms),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this},Yi.prototype.toJSON=function(e){const t=Vt.prototype.toJSON.call(this,e);t.glslVersion=this.glslVersion,t.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?t.uniforms[i]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?t.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?t.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?t.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?t.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?t.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?t.uniforms[i]={type:"m4",value:n.toArray()}:t.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader;const i={};for(const e in this.extensions)!0===this.extensions[e]&&(i[e]=!0);return Object.keys(i).length>0&&(t.extensions=i),t},Xi.prototype=Object.assign(Object.create(Et.prototype),{constructor:Xi,isCamera:!0,copy:function(e,t){return Et.prototype.copy.call(this,e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this},getWorldDirection:function(e){void 0===e&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),e=new Ce),this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()},updateMatrixWorld:function(e){Et.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()},updateWorldMatrix:function(e,t){Et.prototype.updateWorldMatrix.call(this,e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()},clone:function(){return(new this.constructor).copy(this)}}),Zi.prototype=Object.assign(Object.create(Xi.prototype),{constructor:Zi,isPerspectiveCamera:!0,copy:function(e,t){return Xi.prototype.copy.call(this,e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){const t=.5*this.getFilmHeight()/e;this.fov=2*ge.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){const e=Math.tan(.5*ge.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*ge.RAD2DEG*Math.atan(Math.tan(.5*ge.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,i,n,a,r){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=a,this.view.height=r,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const e=this.near;let t=e*Math.tan(.5*ge.DEG2RAD*this.fov)/this.zoom,i=2*t,n=this.aspect*i,a=-.5*n;const r=this.view;if(null!==this.view&&this.view.enabled){const e=r.fullWidth,s=r.fullHeight;a+=r.offsetX*n/e,t-=r.offsetY*i/s,n*=r.width/e,i*=r.height/s}const s=this.filmOffset;0!==s&&(a+=e*s/this.getFilmWidth()),this.projectionMatrix.makePerspective(a,a+n,t,t-i,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(e){const t=Et.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}});const qi=90;class Ji extends Et{constructor(e,t,i){if(super(),this.type="CubeCamera",!0!==i.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=i;const n=new Zi(qi,1,e,t);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new Ce(1,0,0)),this.add(n);const a=new Zi(qi,1,e,t);a.layers=this.layers,a.up.set(0,-1,0),a.lookAt(new Ce(-1,0,0)),this.add(a);const r=new Zi(qi,1,e,t);r.layers=this.layers,r.up.set(0,0,1),r.lookAt(new Ce(0,1,0)),this.add(r);const s=new Zi(qi,1,e,t);s.layers=this.layers,s.up.set(0,0,-1),s.lookAt(new Ce(0,-1,0)),this.add(s);const o=new Zi(qi,1,e,t);o.layers=this.layers,o.up.set(0,-1,0),o.lookAt(new Ce(0,0,1)),this.add(o);const l=new Zi(qi,1,e,t);l.layers=this.layers,l.up.set(0,-1,0),l.lookAt(new Ce(0,0,-1)),this.add(l)}update(e,t){null===this.parent&&this.updateMatrixWorld();const i=this.renderTarget,[n,a,r,s,o,l]=this.children,c=e.xr.enabled,h=e.getRenderTarget();e.xr.enabled=!1;const u=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0),e.render(t,n),e.setRenderTarget(i,1),e.render(t,a),e.setRenderTarget(i,2),e.render(t,r),e.setRenderTarget(i,3),e.render(t,s),e.setRenderTarget(i,4),e.render(t,o),i.texture.generateMipmaps=u,e.setRenderTarget(i,5),e.render(t,l),e.setRenderTarget(h),e.xr.enabled=c}}class Qi extends we{constructor(e,t,i,n,a,r,o,l,c,h){super(e=void 0!==e?e:[],t=void 0!==t?t:s,i,n,a,r,o=void 0!==o?o:C,l,c,h),this._needsFlipEnvMap=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}Qi.prototype.isCubeTexture=!0;class Ki extends Te{constructor(e,t,i){Number.isInteger(t)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),t=i),super(e,e,t),t=t||{},this.texture=new Qi(void 0,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.encoding),this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:b,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.format=I,this.texture.encoding=t.encoding,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new Hi(5,5,5),a=new Yi({name:"CubemapFromEquirect",uniforms:Gi(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});a.uniforms.tEquirect.value=t;const r=new Fi(n,a),s=t.minFilter;t.minFilter===x&&(t.minFilter=b);return new Ji(1,10,this).update(e,r),t.minFilter=s,r.geometry.dispose(),r.material.dispose(),this}clear(e,t,i,n){const a=e.getRenderTarget();for(let a=0;a<6;a++)e.setRenderTarget(this,a),e.clear(t,i,n);e.setRenderTarget(a)}}Ki.prototype.isWebGLCubeRenderTarget=!0;class $i extends we{constructor(e,t,i,n,a,r,s,o,l,c,h,u){super(null,r,s,o,l,c,n,a,h,u),this.image={data:e||null,width:t||1,height:i||1},this.magFilter=void 0!==l?l:g,this.minFilter=void 0!==c?c:g,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}$i.prototype.isDataTexture=!0;const en=new Xe,tn=new Ce;class nn{constructor(e=new Rt,t=new Rt,i=new Rt,n=new Rt,a=new Rt,r=new Rt){this.planes=[e,t,i,n,a,r]}set(e,t,i,n,a,r){const s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(i),s[3].copy(n),s[4].copy(a),s[5].copy(r),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e){const t=this.planes,i=e.elements,n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=i[5],c=i[6],h=i[7],u=i[8],d=i[9],p=i[10],m=i[11],f=i[12],g=i[13],y=i[14],v=i[15];return t[0].setComponents(s-n,h-o,m-u,v-f).normalize(),t[1].setComponents(s+n,h+o,m+u,v+f).normalize(),t[2].setComponents(s+a,h+l,m+d,v+g).normalize(),t[3].setComponents(s-a,h-l,m-d,v-g).normalize(),t[4].setComponents(s-r,h-c,m-p,v-y).normalize(),t[5].setComponents(s+r,h+c,m+p,v+y).normalize(),this}intersectsObject(e){const t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),en.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(en)}intersectsSprite(e){return en.center.set(0,0,0),en.radius=.7071067811865476,en.applyMatrix4(e.matrixWorld),this.intersectsSphere(en)}intersectsSphere(e){const t=this.planes,i=e.center,n=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(i)<n)return!1}return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const n=t[i];if(tn.x=n.normal.x>0?e.max.x:e.min.x,tn.y=n.normal.y>0?e.max.y:e.min.y,tn.z=n.normal.z>0?e.max.z:e.min.z,n.distanceToPoint(tn)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function an(){let e=null,t=!1,i=null,n=null;function a(t,r){i(t,r),n=e.requestAnimationFrame(a)}return{start:function(){!0!==t&&null!==i&&(n=e.requestAnimationFrame(a),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function rn(e,t){const i=t.isWebGL2,n=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),n.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const i=n.get(t);i&&(e.deleteBuffer(i.buffer),n.delete(t))},update:function(t,a){if(t.isGLBufferAttribute){const e=n.get(t);return void((!e||e.version<t.version)&&n.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version}))}t.isInterleavedBufferAttribute&&(t=t.data);const r=n.get(t);void 0===r?n.set(t,function(t,n){const a=t.array,r=t.usage,s=e.createBuffer();e.bindBuffer(n,s),e.bufferData(n,a,r),t.onUploadCallback();let o=5126;return a instanceof Float32Array?o=5126:a instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):a instanceof Uint16Array?t.isFloat16BufferAttribute?i?o=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):o=5123:a instanceof Int16Array?o=5122:a instanceof Uint32Array?o=5125:a instanceof Int32Array?o=5124:a instanceof Int8Array?o=5120:a instanceof Uint8Array&&(o=5121),{buffer:s,type:o,bytesPerElement:a.BYTES_PER_ELEMENT,version:t.version}}(t,a)):r.version<t.version&&(!function(t,n,a){const r=n.array,s=n.updateRange;e.bindBuffer(a,t),-1===s.count?e.bufferSubData(a,0,r):(i?e.bufferSubData(a,s.offset*r.BYTES_PER_ELEMENT,r,s.offset,s.count):e.bufferSubData(a,s.offset*r.BYTES_PER_ELEMENT,r.subarray(s.offset,s.offset+s.count)),s.count=-1)}(r.buffer,t,a),r.version=t.version)}}}class sn extends wi{constructor(e=1,t=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n};const a=e/2,r=t/2,s=Math.floor(i),o=Math.floor(n),l=s+1,c=o+1,h=e/s,u=t/o,d=[],p=[],m=[],f=[];for(let e=0;e<c;e++){const t=e*u-r;for(let i=0;i<l;i++){const n=i*h-a;p.push(n,-t,0),m.push(0,0,1),f.push(i/s),f.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<s;t++){const i=t+l*e,n=t+l*(e+1),a=t+1+l*(e+1),r=t+1+l*e;d.push(i,n,r),d.push(n,a,r)}this.setIndex(d),this.setAttribute("position",new hi(p,3)),this.setAttribute("normal",new hi(m,3)),this.setAttribute("uv",new hi(f,2))}}const on={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + viewDir );\n\tfloat dotNL = saturate( dot( normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie(float roughness, float NoH) {\n\tfloat invAlpha = 1.0 / roughness;\n\tfloat cos2h = NoH * NoH;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\treturn (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);\n}\nfloat V_Neubelt(float NoV, float NoL) {\n\treturn saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));\n}\nvec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {\n\tvec3 N = geometry.normal;\n\tvec3 V = geometry.viewDir;\n\tvec3 H = normalize( V + L );\n\tfloat dotNH = saturate( dot( N, H ) );\n\treturn specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );\n}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor.xyz *= color.xyz;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",commonFlipY:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin(-clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_maxMipLevel 8.0\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_maxTileSize 256.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\tfloat texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );\n\t\tvec2 f = fract( uv );\n\t\tuv += 0.5 - f;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tif ( mipInt < cubeUV_maxMipLevel ) {\n\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t}\n\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\tuv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );\n\t\tuv *= texelSize;\n\t\tvec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x += texelSize;\n\t\tvec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.y += texelSize;\n\t\tvec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x -= texelSize;\n\t\tvec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tvec3 tm = mix( tl, tr, f.x );\n\t\tvec3 bm = mix( bl, br, f.x );\n\t\treturn mix( tm, bm, f.y );\n\t}\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= r1 ) {\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\t\t} else if ( roughness >= r4 ) {\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\t\t} else if ( roughness >= r5 ) {\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\t\t} else if ( roughness >= r6 ) {\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = clamp( floor( D ) / 255.0, 0.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value ) {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP )\n\t#ifdef ENVMAP_MODE_REFRACTION\n\t\tuniform float refractionRatio;\n\t#endif\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat sigma = PI * roughness * roughness / ( 1.0 + roughness );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + log2( sigma );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -viewDir, normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tfogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn texture2D( gradientMap, coord ).rgb;\n\t#else\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\treflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry );\n#ifdef DOUBLE_SIDED\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD( material )\t(0)",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\n#ifdef REFLECTIVITY\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#endif\n#ifdef CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheen;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat specularRoughness;\n\tvec3 specularColor;\n#ifdef CLEARCOAT\n\tfloat clearcoat;\n\tfloat clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = ccDotNL * directLight.color;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tccIrradiance *= PI;\n\t\t#endif\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t\treflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(\n\t\t\tmaterial.specularRoughness,\n\t\t\tdirectLight.direction,\n\t\t\tgeometry,\n\t\t\tmaterial.sheenColor\n\t\t);\n\t#else\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularRoughness);\n\t#endif\n\treflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t\tfloat ccDotNL = ccDotNV;\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\treflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifndef USE_MORPHNORMALS\n\t\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\t\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * faceDirection;\n\t\t\tbitangent = bitangent * faceDirection;\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal, mapN, faceDirection );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );\n\t\treturn normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );\n\t#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform highp sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmissionmap_fragment:"#ifdef USE_TRANSMISSIONMAP\n\ttotalTransmission *= texture2D( transmissionMap, vUv ).r;\n#endif",transmissionmap_pars_fragment:"#ifdef USE_TRANSMISSIONMAP\n\tuniform sampler2D transmissionMap;\n#endif",uv_pars_fragment:"#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_frag:"uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t#define TRANSMISSION\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef TRANSMISSION\n\tuniform float transmission;\n#endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <transmissionmap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#ifdef TRANSMISSION\n\t\tfloat totalTransmission = transmission;\n\t#endif\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <transmissionmap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#ifdef TRANSMISSION\n\t\tdiffuseColor.a *= mix( saturate( 1. - totalTransmission + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) ), 1.0, metalness );\n\t#endif\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}"},ln={common:{diffuse:{value:new Qt(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new ve},uv2Transform:{value:new ve},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new ye(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Qt(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Qt(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new ve}},sprite:{diffuse:{value:new Qt(15658734)},opacity:{value:1},center:{value:new ye(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new ve}}},cn={basic:{uniforms:Vi([ln.common,ln.specularmap,ln.envmap,ln.aomap,ln.lightmap,ln.fog]),vertexShader:on.meshbasic_vert,fragmentShader:on.meshbasic_frag},lambert:{uniforms:Vi([ln.common,ln.specularmap,ln.envmap,ln.aomap,ln.lightmap,ln.emissivemap,ln.fog,ln.lights,{emissive:{value:new Qt(0)}}]),vertexShader:on.meshlambert_vert,fragmentShader:on.meshlambert_frag},phong:{uniforms:Vi([ln.common,ln.specularmap,ln.envmap,ln.aomap,ln.lightmap,ln.emissivemap,ln.bumpmap,ln.normalmap,ln.displacementmap,ln.fog,ln.lights,{emissive:{value:new Qt(0)},specular:{value:new Qt(1118481)},shininess:{value:30}}]),vertexShader:on.meshphong_vert,fragmentShader:on.meshphong_frag},standard:{uniforms:Vi([ln.common,ln.envmap,ln.aomap,ln.lightmap,ln.emissivemap,ln.bumpmap,ln.normalmap,ln.displacementmap,ln.roughnessmap,ln.metalnessmap,ln.fog,ln.lights,{emissive:{value:new Qt(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:on.meshphysical_vert,fragmentShader:on.meshphysical_frag},toon:{uniforms:Vi([ln.common,ln.aomap,ln.lightmap,ln.emissivemap,ln.bumpmap,ln.normalmap,ln.displacementmap,ln.gradientmap,ln.fog,ln.lights,{emissive:{value:new Qt(0)}}]),vertexShader:on.meshtoon_vert,fragmentShader:on.meshtoon_frag},matcap:{uniforms:Vi([ln.common,ln.bumpmap,ln.normalmap,ln.displacementmap,ln.fog,{matcap:{value:null}}]),vertexShader:on.meshmatcap_vert,fragmentShader:on.meshmatcap_frag},points:{uniforms:Vi([ln.points,ln.fog]),vertexShader:on.points_vert,fragmentShader:on.points_frag},dashed:{uniforms:Vi([ln.common,ln.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:on.linedashed_vert,fragmentShader:on.linedashed_frag},depth:{uniforms:Vi([ln.common,ln.displacementmap]),vertexShader:on.depth_vert,fragmentShader:on.depth_frag},normal:{uniforms:Vi([ln.common,ln.bumpmap,ln.normalmap,ln.displacementmap,{opacity:{value:1}}]),vertexShader:on.normal_vert,fragmentShader:on.normal_frag},sprite:{uniforms:Vi([ln.sprite,ln.fog]),vertexShader:on.sprite_vert,fragmentShader:on.sprite_frag},background:{uniforms:{uvTransform:{value:new ve},t2D:{value:null}},vertexShader:on.background_vert,fragmentShader:on.background_frag},cube:{uniforms:Vi([ln.envmap,{opacity:{value:1},cubeMapRotationY:{value:0}}]),vertexShader:on.cube_vert,fragmentShader:on.cube_frag},equirect:{uniforms:{tEquirect:{value:null},cubeMapRotationY:{value:0}},vertexShader:on.equirect_vert,fragmentShader:on.equirect_frag},distanceRGBA:{uniforms:Vi([ln.common,ln.displacementmap,{referencePosition:{value:new Ce},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:on.distanceRGBA_vert,fragmentShader:on.distanceRGBA_frag},shadow:{uniforms:Vi([ln.lights,ln.fog,{color:{value:new Qt(0)},opacity:{value:1}}]),vertexShader:on.shadow_vert,fragmentShader:on.shadow_frag}};function hn(e,t,i,n,a){const r=new Qt(0);let s,o,l=0,c=null,u=0,d=null;function p(e,t){i.buffers.color.setClear(e.r,e.g,e.b,t,a)}return{getClearColor:function(){return r},setClearColor:function(e,t=1){r.set(e),l=t,p(r,l)},getClearAlpha:function(){return l},setClearAlpha:function(e){l=e,p(r,l)},render:function(i,a,m,f){let g=!0===a.isScene?a.background:null;g&&g.isTexture&&(g=t.get(g));const y=e.xr,v=y.getSession&&y.getSession();v&&"additive"===v.environmentBlendMode&&(g=null),null===g?p(r,l):g&&g.isColor&&(p(g,1),f=!0),(e.autoClear||f)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),g&&(g.isCubeTexture||g.isWebGLCubeRenderTarget||g.mapping===h)?(void 0===o&&(o=new Fi(new Hi(1,1,1),new Yi({name:"BackgroundCubeMaterial",uniforms:Gi(cn.cube.uniforms),vertexShader:cn.cube.vertexShader,fragmentShader:cn.cube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),o.geometry.deleteAttribute("uv"),o.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(o.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(o)),g.isWebGLCubeRenderTarget&&(g=g.texture),o.material.uniforms.envMap.value=g,o.material.uniforms.flipEnvMap.value=g.isCubeTexture&&g._needsFlipEnvMap?-1:1,c===g&&u===g.version&&d===e.toneMapping||(o.material.needsUpdate=!0,c=g,u=g.version,d=e.toneMapping),i.unshift(o,o.geometry,o.material,0,0,null)):g&&g.isTexture&&(void 0===s&&(s=new Fi(new sn(2,2),new Yi({name:"BackgroundMaterial",uniforms:Gi(cn.background.uniforms),vertexShader:cn.background.vertexShader,fragmentShader:cn.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),Object.defineProperty(s.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(s)),s.material.uniforms.t2D.value=g,!0===g.matrixAutoUpdate&&g.updateMatrix(),s.material.uniforms.uvTransform.value.copy(g.matrix),c===g&&u===g.version&&d===e.toneMapping||(s.material.needsUpdate=!0,c=g,u=g.version,d=e.toneMapping),i.unshift(s,s.geometry,s.material,0,0,null))}}}function un(e,t,i,n){const a=e.getParameter(34921),r=n.isWebGL2?null:t.get("OES_vertex_array_object"),s=n.isWebGL2||null!==r,o={},l=d(null);let c=l;function h(t){return n.isWebGL2?e.bindVertexArray(t):r.bindVertexArrayOES(t)}function u(t){return n.isWebGL2?e.deleteVertexArray(t):r.deleteVertexArrayOES(t)}function d(e){const t=[],i=[],n=[];for(let e=0;e<a;e++)t[e]=0,i[e]=0,n[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:n,object:e,attributes:{},index:null}}function p(){const e=c.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function m(e){f(e,0)}function f(i,a){const r=c.newAttributes,s=c.enabledAttributes,o=c.attributeDivisors;if(r[i]=1,0===s[i]&&(e.enableVertexAttribArray(i),s[i]=1),o[i]!==a){(n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,a),o[i]=a}}function g(){const t=c.newAttributes,i=c.enabledAttributes;for(let n=0,a=i.length;n<a;n++)i[n]!==t[n]&&(e.disableVertexAttribArray(n),i[n]=0)}function y(t,i,a,r,s,o){!0!==n.isWebGL2||5124!==a&&5125!==a?e.vertexAttribPointer(t,i,a,r,s,o):e.vertexAttribIPointer(t,i,a,s,o)}function v(){b(),c!==l&&(c=l,h(c.object))}function b(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(a,l,u,v,b){let _=!1;if(s){const t=function(t,i,a){const s=!0===a.wireframe;let l=o[t.id];void 0===l&&(l={},o[t.id]=l);let c=l[i.id];void 0===c&&(c={},l[i.id]=c);let h=c[s];void 0===h&&(h=d(n.isWebGL2?e.createVertexArray():r.createVertexArrayOES()),c[s]=h);return h}(v,u,l);c!==t&&(c=t,h(c.object)),_=function(e,t){const i=c.attributes,n=e.attributes;let a=0;for(const e in n){const t=i[e],r=n[e];if(void 0===t)return!0;if(t.attribute!==r)return!0;if(t.data!==r.data)return!0;a++}return c.attributesNum!==a||c.index!==t}(v,b),_&&function(e,t){const i={},n=e.attributes;let a=0;for(const e in n){const t=n[e],r={};r.attribute=t,t.data&&(r.data=t.data),i[e]=r,a++}c.attributes=i,c.attributesNum=a,c.index=t}(v,b)}else{const e=!0===l.wireframe;c.geometry===v.id&&c.program===u.id&&c.wireframe===e||(c.geometry=v.id,c.program=u.id,c.wireframe=e,_=!0)}!0===a.isInstancedMesh&&(_=!0),null!==b&&i.update(b,34963),_&&(!function(a,r,s,o){if(!1===n.isWebGL2&&(a.isInstancedMesh||o.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;p();const l=o.attributes,c=s.getAttributes(),h=r.defaultAttributeValues;for(const t in c){const n=c[t];if(n>=0){const r=l[t];if(void 0!==r){const t=r.normalized,a=r.itemSize,s=i.get(r);if(void 0===s)continue;const l=s.buffer,c=s.type,h=s.bytesPerElement;if(r.isInterleavedBufferAttribute){const i=r.data,s=i.stride,u=r.offset;i&&i.isInstancedInterleavedBuffer?(f(n,i.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)):m(n),e.bindBuffer(34962,l),y(n,a,c,t,s*h,u*h)}else r.isInstancedBufferAttribute?(f(n,r.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=r.meshPerAttribute*r.count)):m(n),e.bindBuffer(34962,l),y(n,a,c,t,0,0)}else if("instanceMatrix"===t){const t=i.get(a.instanceMatrix);if(void 0===t)continue;const r=t.buffer,s=t.type;f(n+0,1),f(n+1,1),f(n+2,1),f(n+3,1),e.bindBuffer(34962,r),e.vertexAttribPointer(n+0,4,s,!1,64,0),e.vertexAttribPointer(n+1,4,s,!1,64,16),e.vertexAttribPointer(n+2,4,s,!1,64,32),e.vertexAttribPointer(n+3,4,s,!1,64,48)}else if("instanceColor"===t){const t=i.get(a.instanceColor);if(void 0===t)continue;const r=t.buffer,s=t.type;f(n,1),e.bindBuffer(34962,r),e.vertexAttribPointer(n,3,s,!1,12,0)}else if(void 0!==h){const i=h[t];if(void 0!==i)switch(i.length){case 2:e.vertexAttrib2fv(n,i);break;case 3:e.vertexAttrib3fv(n,i);break;case 4:e.vertexAttrib4fv(n,i);break;default:e.vertexAttrib1fv(n,i)}}}}g()}(a,l,u,v),null!==b&&e.bindBuffer(34963,i.get(b).buffer))},reset:v,resetDefaultState:b,dispose:function(){v();for(const e in o){const t=o[e];for(const e in t){const i=t[e];for(const e in i)u(i[e].object),delete i[e];delete t[e]}delete o[e]}},releaseStatesOfGeometry:function(e){if(void 0===o[e.id])return;const t=o[e.id];for(const e in t){const i=t[e];for(const e in i)u(i[e].object),delete i[e];delete t[e]}delete o[e.id]},releaseStatesOfProgram:function(e){for(const t in o){const i=o[t];if(void 0===i[e.id])continue;const n=i[e.id];for(const e in n)u(n[e].object),delete n[e];delete i[e.id]}},initAttributes:p,enableAttribute:m,disableUnusedAttributes:g}}function dn(e,t,i,n){const a=n.isWebGL2;let r;this.setMode=function(e){r=e},this.render=function(t,n){e.drawArrays(r,t,n),i.update(n,r,1)},this.renderInstances=function(n,s,o){if(0===o)return;let l,c;if(a)l=e,c="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[c](r,n,s,o),i.update(s,r,o)}}function pn(e,t,i){let n;function a(t){if("highp"===t){if(e.getShaderPrecisionFormat(35633,36338).precision>0&&e.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(35633,36337).precision>0&&e.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const r="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&e instanceof WebGL2ComputeRenderingContext;let s=void 0!==i.precision?i.precision:"highp";const o=a(s);o!==s&&(console.warn("THREE.WebGLRenderer:",s,"not supported, using",o,"instead."),s=o);const l=!0===i.logarithmicDepthBuffer,c=e.getParameter(34930),h=e.getParameter(35660),u=e.getParameter(3379),d=e.getParameter(34076),p=e.getParameter(34921),m=e.getParameter(36347),f=e.getParameter(36348),g=e.getParameter(36349),y=h>0,v=r||t.has("OES_texture_float");return{isWebGL2:r,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===t.has("EXT_texture_filter_anisotropic")){const i=t.get("EXT_texture_filter_anisotropic");n=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:a,precision:s,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:h,maxTextureSize:u,maxCubemapSize:d,maxAttributes:p,maxVertexUniforms:m,maxVaryings:f,maxFragmentUniforms:g,vertexTextures:y,floatFragmentTextures:v,floatVertexTextures:y&&v,maxSamples:r?e.getParameter(36183):0}}function mn(e){const t=this;let i=null,n=0,a=!1,r=!1;const s=new Rt,o=new ve,l={value:null,needsUpdate:!1};function c(){l.value!==i&&(l.value=i,l.needsUpdate=n>0),t.numPlanes=n,t.numIntersection=0}function h(e,i,n,a){const r=null!==e?e.length:0;let c=null;if(0!==r){if(c=l.value,!0!==a||null===c){const t=n+4*r,a=i.matrixWorldInverse;o.getNormalMatrix(a),(null===c||c.length<t)&&(c=new Float32Array(t));for(let t=0,i=n;t!==r;++t,i+=4)s.copy(e[t]).applyMatrix4(a,o),s.normal.toArray(c,i),c[i+3]=s.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=r,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t,r){const s=0!==e.length||t||0!==n||a;return a=t,i=h(e,r,0),n=e.length,s},this.beginShadows=function(){r=!0,h(null)},this.endShadows=function(){r=!1,c()},this.setState=function(t,s,o){const u=t.clippingPlanes,d=t.clipIntersection,p=t.clipShadows,m=e.get(t);if(!a||null===u||0===u.length||r&&!p)r?h(null):c();else{const e=r?0:n,t=4*e;let a=m.clippingState||null;l.value=a,a=h(u,s,t,o);for(let e=0;e!==t;++e)a[e]=i[e];m.clippingState=a,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function fn(e){let t=new WeakMap;function i(e,t){return t===l?e.mapping=s:t===c&&(e.mapping=o),e}function n(e){const i=e.target;i.removeEventListener("dispose",n);const a=t.get(i);void 0!==a&&(t.delete(i),a.dispose())}return{get:function(a){if(a&&a.isTexture){const r=a.mapping;if(r===l||r===c){if(t.has(a)){return i(t.get(a).texture,a.mapping)}{const r=a.image;if(r&&r.height>0){const s=e.getRenderTarget(),o=new Ki(r.height/2);return o.fromEquirectangularTexture(e,a),t.set(a,o),e.setRenderTarget(s),a.addEventListener("dispose",n),i(o.texture,a.mapping)}return null}}}return a},dispose:function(){t=new WeakMap}}}function gn(e){const t={};function i(i){if(void 0!==t[i])return t[i];let n;switch(i){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(i)}return t[i]=n,n}return{has:function(e){return null!==i(e)},init:function(e){e.isWebGL2?i("EXT_color_buffer_float"):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float")},get:function(e){const t=i(e);return null===t&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function yn(e,t,i,n){const a={},r=new WeakMap;function s(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const e in o.attributes)t.remove(o.attributes[e]);o.removeEventListener("dispose",s),delete a[o.id];const l=r.get(o);l&&(t.remove(l),r.delete(o)),n.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(e){const i=[],n=e.index,a=e.attributes.position;let s=0;if(null!==n){const e=n.array;s=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],a=e[t+1],r=e[t+2];i.push(n,a,a,r,r,n)}}else{const e=a.array;s=a.version;for(let t=0,n=e.length/3-1;t<n;t+=3){const e=t+0,n=t+1,a=t+2;i.push(e,n,n,a,a,e)}}const o=new(di(i)>65535?li:si)(i,1);o.version=s;const l=r.get(e);l&&t.remove(l),r.set(e,o)}return{get:function(e,t){return!0===a[t.id]||(t.addEventListener("dispose",s),a[t.id]=!0,i.memory.geometries++),t},update:function(e){const i=e.attributes;for(const e in i)t.update(i[e],34962);const n=e.morphAttributes;for(const e in n){const i=n[e];for(let e=0,n=i.length;e<n;e++)t.update(i[e],34962)}},getWireframeAttribute:function(e){const t=r.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&o(e)}else o(e);return r.get(e)}}}function vn(e,t,i,n){const a=n.isWebGL2;let r,s,o;this.setMode=function(e){r=e},this.setIndex=function(e){s=e.type,o=e.bytesPerElement},this.render=function(t,n){e.drawElements(r,n,s,t*o),i.update(n,r,1)},this.renderInstances=function(n,l,c){if(0===c)return;let h,u;if(a)h=e,u="drawElementsInstanced";else if(h=t.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===h)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");h[u](r,l,s,n*o,c),i.update(l,r,c)}}function bn(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(e,i,n){switch(t.calls++,i){case 4:t.triangles+=n*(e/3);break;case 1:t.lines+=n*(e/2);break;case 3:t.lines+=n*(e-1);break;case 2:t.lines+=n*e;break;case 0:t.points+=n*e;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}function _n(e,t){return e[0]-t[0]}function xn(e,t){return Math.abs(t[1])-Math.abs(e[1])}function wn(e){const t={},i=new Float32Array(8),n=[];for(let e=0;e<8;e++)n[e]=[e,0];return{update:function(a,r,s,o){const l=a.morphTargetInfluences,c=void 0===l?0:l.length;let h=t[r.id];if(void 0===h){h=[];for(let e=0;e<c;e++)h[e]=[e,0];t[r.id]=h}for(let e=0;e<c;e++){const t=h[e];t[0]=e,t[1]=l[e]}h.sort(xn);for(let e=0;e<8;e++)e<c&&h[e][1]?(n[e][0]=h[e][0],n[e][1]=h[e][1]):(n[e][0]=Number.MAX_SAFE_INTEGER,n[e][1]=0);n.sort(_n);const u=s.morphTargets&&r.morphAttributes.position,d=s.morphNormals&&r.morphAttributes.normal;let p=0;for(let e=0;e<8;e++){const t=n[e],a=t[0],s=t[1];a!==Number.MAX_SAFE_INTEGER&&s?(u&&r.getAttribute("morphTarget"+e)!==u[a]&&r.setAttribute("morphTarget"+e,u[a]),d&&r.getAttribute("morphNormal"+e)!==d[a]&&r.setAttribute("morphNormal"+e,d[a]),i[e]=s,p+=s):(u&&!0===r.hasAttribute("morphTarget"+e)&&r.deleteAttribute("morphTarget"+e),d&&!0===r.hasAttribute("morphNormal"+e)&&r.deleteAttribute("morphNormal"+e),i[e]=0)}const m=r.morphTargetsRelative?1:1-p;o.getUniforms().setValue(e,"morphTargetBaseInfluence",m),o.getUniforms().setValue(e,"morphTargetInfluences",i)}}}function Sn(e,t,i,n){let a=new WeakMap;function r(e){const t=e.target;t.removeEventListener("dispose",r),i.remove(t.instanceMatrix),null!==t.instanceColor&&i.remove(t.instanceColor)}return{update:function(e){const s=n.render.frame,o=e.geometry,l=t.get(e,o);return a.get(l)!==s&&(t.update(l),a.set(l,s)),e.isInstancedMesh&&(!1===e.hasEventListener("dispose",r)&&e.addEventListener("dispose",r),i.update(e.instanceMatrix,34962),null!==e.instanceColor&&i.update(e.instanceColor,34962)),l},dispose:function(){a=new WeakMap}}}cn.physical={uniforms:Vi([cn.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new ye(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new Qt(0)},transmission:{value:0},transmissionMap:{value:null}}]),vertexShader:on.meshphysical_vert,fragmentShader:on.meshphysical_frag};class Mn extends we{constructor(e=null,t=1,i=1,n=1){super(null),this.image={data:e,width:t,height:i,depth:n},this.magFilter=g,this.minFilter=g,this.wrapR=m,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}}Mn.prototype.isDataTexture2DArray=!0;class Tn extends we{constructor(e=null,t=1,i=1,n=1){super(null),this.image={data:e,width:t,height:i,depth:n},this.magFilter=g,this.minFilter=g,this.wrapR=m,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}}Tn.prototype.isDataTexture3D=!0;const An=new we,En=new Mn,Cn=new Tn,In=new Qi,Pn=[],Rn=[],On=new Float32Array(16),Dn=new Float32Array(9),Ln=new Float32Array(4);function kn(e,t,i){const n=e[0];if(n<=0||n>0)return e;const a=t*i;let r=Pn[a];if(void 0===r&&(r=new Float32Array(a),Pn[a]=r),0!==t&&n){n.toArray(r,0);for(let n=1,a=0;n!==t;++n)a+=i,e[n].toArray(r,a)}return r}function Nn(e,t){if(e.length!==t.length)return!1;for(let i=0,n=e.length;i<n;i++)if(e[i]!==t[i])return!1;return!0}function Bn(e,t){for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}function zn(e,t){let i=Rn[t];void 0===i&&(i=new Int32Array(t),Rn[t]=i);for(let n=0;n!==t;++n)i[n]=e.allocateTextureUnit();return i}function Un(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function Fn(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Nn(i,t))return;e.uniform2fv(this.addr,t),Bn(i,t)}}function jn(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(Nn(i,t))return;e.uniform3fv(this.addr,t),Bn(i,t)}}function Hn(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Nn(i,t))return;e.uniform4fv(this.addr,t),Bn(i,t)}}function Gn(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(Nn(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),Bn(i,t)}else{if(Nn(i,n))return;Ln.set(n),e.uniformMatrix2fv(this.addr,!1,Ln),Bn(i,n)}}function Vn(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(Nn(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),Bn(i,t)}else{if(Nn(i,n))return;Dn.set(n),e.uniformMatrix3fv(this.addr,!1,Dn),Bn(i,n)}}function Wn(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(Nn(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),Bn(i,t)}else{if(Nn(i,n))return;On.set(n),e.uniformMatrix4fv(this.addr,!1,On),Bn(i,n)}}function Yn(e,t,i){const n=this.cache,a=i.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),i.safeSetTexture2D(t||An,a)}function Xn(e,t,i){const n=this.cache,a=i.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),i.setTexture2DArray(t||En,a)}function Zn(e,t,i){const n=this.cache,a=i.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),i.setTexture3D(t||Cn,a)}function qn(e,t,i){const n=this.cache,a=i.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),i.safeSetTextureCube(t||In,a)}function Jn(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function Qn(e,t){const i=this.cache;Nn(i,t)||(e.uniform2iv(this.addr,t),Bn(i,t))}function Kn(e,t){const i=this.cache;Nn(i,t)||(e.uniform3iv(this.addr,t),Bn(i,t))}function $n(e,t){const i=this.cache;Nn(i,t)||(e.uniform4iv(this.addr,t),Bn(i,t))}function ea(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function ta(e,t){e.uniform1fv(this.addr,t)}function ia(e,t){e.uniform1iv(this.addr,t)}function na(e,t){e.uniform2iv(this.addr,t)}function aa(e,t){e.uniform3iv(this.addr,t)}function ra(e,t){e.uniform4iv(this.addr,t)}function sa(e,t){const i=kn(t,this.size,2);e.uniform2fv(this.addr,i)}function oa(e,t){const i=kn(t,this.size,3);e.uniform3fv(this.addr,i)}function la(e,t){const i=kn(t,this.size,4);e.uniform4fv(this.addr,i)}function ca(e,t){const i=kn(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function ha(e,t){const i=kn(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function ua(e,t){const i=kn(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function da(e,t,i){const n=t.length,a=zn(i,n);e.uniform1iv(this.addr,a);for(let e=0;e!==n;++e)i.safeSetTexture2D(t[e]||An,a[e])}function pa(e,t,i){const n=t.length,a=zn(i,n);e.uniform1iv(this.addr,a);for(let e=0;e!==n;++e)i.safeSetTextureCube(t[e]||In,a[e])}function ma(e,t,i){this.id=e,this.addr=i,this.cache=[],this.setValue=function(e){switch(e){case 5126:return Un;case 35664:return Fn;case 35665:return jn;case 35666:return Hn;case 35674:return Gn;case 35675:return Vn;case 35676:return Wn;case 5124:case 35670:return Jn;case 35667:case 35671:return Qn;case 35668:case 35672:return Kn;case 35669:case 35673:return $n;case 5125:return ea;case 35678:case 36198:case 36298:case 36306:case 35682:return Yn;case 35679:case 36299:case 36307:return Zn;case 35680:case 36300:case 36308:case 36293:return qn;case 36289:case 36303:case 36311:case 36292:return Xn}}(t.type)}function fa(e,t,i){this.id=e,this.addr=i,this.cache=[],this.size=t.size,this.setValue=function(e){switch(e){case 5126:return ta;case 35664:return sa;case 35665:return oa;case 35666:return la;case 35674:return ca;case 35675:return ha;case 35676:return ua;case 5124:case 35670:return ia;case 35667:case 35671:return na;case 35668:case 35672:return aa;case 35669:case 35673:return ra;case 35678:case 36198:case 36298:case 36306:case 35682:return da;case 35680:case 36300:case 36308:case 36293:return pa}}(t.type)}function ga(e){this.id=e,this.seq=[],this.map={}}fa.prototype.updateCache=function(e){const t=this.cache;e instanceof Float32Array&&t.length!==e.length&&(this.cache=new Float32Array(e.length)),Bn(t,e)},ga.prototype.setValue=function(e,t,i){const n=this.seq;for(let a=0,r=n.length;a!==r;++a){const r=n[a];r.setValue(e,t[r.id],i)}};const ya=/(\w+)(\])?(\[|\.)?/g;function va(e,t){e.seq.push(t),e.map[t.id]=t}function ba(e,t,i){const n=e.name,a=n.length;for(ya.lastIndex=0;;){const r=ya.exec(n),s=ya.lastIndex;let o=r[1];const l="]"===r[2],c=r[3];if(l&&(o|=0),void 0===c||"["===c&&s+2===a){va(i,void 0===c?new ma(o,e,t):new fa(o,e,t));break}{let e=i.map[o];void 0===e&&(e=new ga(o),va(i,e)),i=e}}}function _a(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,35718);for(let n=0;n<i;++n){const i=e.getActiveUniform(t,n);ba(i,e.getUniformLocation(t,i.name),this)}}function xa(e,t,i){const n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),n}_a.prototype.setValue=function(e,t,i,n){const a=this.map[t];void 0!==a&&a.setValue(e,i,n)},_a.prototype.setOptional=function(e,t,i){const n=t[i];void 0!==n&&this.setValue(e,i,n)},_a.upload=function(e,t,i,n){for(let a=0,r=t.length;a!==r;++a){const r=t[a],s=i[r.id];!1!==s.needsUpdate&&r.setValue(e,s.value,n)}},_a.seqWithValue=function(e,t){const i=[];for(let n=0,a=e.length;n!==a;++n){const a=e[n];a.id in t&&i.push(a)}return i};let wa=0;function Sa(e){switch(e){case ee:return["Linear","( value )"];case te:return["sRGB","( value )"];case ne:return["RGBE","( value )"];case ae:return["RGBM","( value, 7.0 )"];case re:return["RGBM","( value, 16.0 )"];case se:return["RGBD","( value, 256.0 )"];case ie:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case 3003:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",e),["Linear","( value )"]}}function Ma(e,t,i){const n=e.getShaderParameter(t,35713),a=e.getShaderInfoLog(t).trim();if(n&&""===a)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+i+"\n"+a+function(e){const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=e+1+": "+t[e];return t.join("\n")}(e.getShaderSource(t))}function Ta(e,t){const i=Sa(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Aa(e,t){const i=Sa(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function Ea(e,t){let i;switch(t){case 1:i="Linear";break;case 2:i="Reinhard";break;case 3:i="OptimizedCineon";break;case 4:i="ACESFilmic";break;case 5:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),i="Linear"}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Ca(e){return""!==e}function Ia(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function Pa(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const Ra=/^[ \t]*#include +<([\w\d./]+)>/gm;function Oa(e){return e.replace(Ra,Da)}function Da(e,t){const i=on[t];if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return Oa(i)}const La=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,ka=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Na(e){return e.replace(ka,za).replace(La,Ba)}function Ba(e,t,i,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),za(e,t,i,n)}function za(e,t,i,n){let a="";for(let e=parseInt(t);e<parseInt(i);e++)a+=n.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return a}function Ua(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Fa(e,t,i,n){const a=e.getContext(),r=i.defines;let l=i.vertexShader,c=i.fragmentShader;const d=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(i),p=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case s:case o:t="ENVMAP_TYPE_CUBE";break;case h:case u:t="ENVMAP_TYPE_CUBE_UV"}return t}(i),m=function(e){let t="ENVMAP_MODE_REFLECTION";if(e.envMap)switch(e.envMapMode){case o:case u:t="ENVMAP_MODE_REFRACTION"}return t}(i),f=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(i),g=e.gammaFactor>0?e.gammaFactor:1,y=i.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUV||e.bumpMap||e.tangentSpaceNormalMap||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Ca).join("\n")}(i),v=function(e){const t=[];for(const i in e){const n=e[i];!1!==n&&t.push("#define "+i+" "+n)}return t.join("\n")}(r),b=a.createProgram();let _,x,w=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(_=[v].filter(Ca).join("\n"),_.length>0&&(_+="\n"),x=[y,v].filter(Ca).join("\n"),x.length>0&&(x+="\n")):(_=[Ua(i),"#define SHADER_NAME "+i.shaderName,v,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+g,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+m:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+d:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Ca).join("\n"),x=[y,Ua(i),"#define SHADER_NAME "+i.shaderName,v,i.alphaTest?"#define ALPHATEST "+i.alphaTest+(i.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+g,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+p:"",i.envMap?"#define "+m:"",i.envMap?"#define "+f:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.sheen?"#define USE_SHEEN":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+d:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?on.tonemapping_pars_fragment:"",0!==i.toneMapping?Ea("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",on.encodings_pars_fragment,i.map?Ta("mapTexelToLinear",i.mapEncoding):"",i.matcap?Ta("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?Ta("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?Ta("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.lightMap?Ta("lightMapTexelToLinear",i.lightMapEncoding):"",Aa("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Ca).join("\n")),l=Oa(l),l=Ia(l,i),l=Pa(l,i),c=Oa(c),c=Ia(c,i),c=Pa(c,i),l=Na(l),c=Na(c),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(w="#version 300 es\n",_=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+_,x=["#define varying in",i.glslVersion===de?"":"out highp vec4 pc_fragColor;",i.glslVersion===de?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+x);const S=w+x+c,M=xa(a,35633,w+_+l),T=xa(a,35632,S);if(a.attachShader(b,M),a.attachShader(b,T),void 0!==i.index0AttributeName?a.bindAttribLocation(b,0,i.index0AttributeName):!0===i.morphTargets&&a.bindAttribLocation(b,0,"position"),a.linkProgram(b),e.debug.checkShaderErrors){const e=a.getProgramInfoLog(b).trim(),t=a.getShaderInfoLog(M).trim(),i=a.getShaderInfoLog(T).trim();let n=!0,r=!0;if(!1===a.getProgramParameter(b,35714)){n=!1;const t=Ma(a,M,"vertex"),i=Ma(a,T,"fragment");console.error("THREE.WebGLProgram: shader error: ",a.getError(),"35715",a.getProgramParameter(b,35715),"gl.getProgramInfoLog",e,t,i)}else""!==e?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",e):""!==t&&""!==i||(r=!1);r&&(this.diagnostics={runnable:n,programLog:e,vertexShader:{log:t,prefix:_},fragmentShader:{log:i,prefix:x}})}let A,E;return a.deleteShader(M),a.deleteShader(T),this.getUniforms=function(){return void 0===A&&(A=new _a(a,b)),A},this.getAttributes=function(){return void 0===E&&(E=function(e,t){const i={},n=e.getProgramParameter(t,35721);for(let a=0;a<n;a++){const n=e.getActiveAttrib(t,a).name;i[n]=e.getAttribLocation(t,n)}return i}(a,b)),E},this.destroy=function(){n.releaseStatesOfProgram(this),a.deleteProgram(b),this.program=void 0},this.name=i.shaderName,this.id=wa++,this.cacheKey=t,this.usedTimes=1,this.program=b,this.vertexShader=M,this.fragmentShader=T,this}function ja(e,t,i,n,a,r){const s=[],o=n.isWebGL2,l=n.logarithmicDepthBuffer,c=n.floatVertexTextures,d=n.maxVertexUniforms,p=n.vertexTextures;let m=n.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},g=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmissionMap"];function y(e){let t;return e&&e.isTexture?t=e.encoding:e&&e.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),t=e.texture.encoding):t=ee,t}return{getParameters:function(a,s,g,v,b){const _=v.fog,x=a.isMeshStandardMaterial?v.environment:null,w=t.get(a.envMap||x),S=f[a.type],M=b.isSkinnedMesh?function(e){const t=e.skeleton.bones;if(c)return 1024;{const e=d,i=Math.floor((e-20)/4),n=Math.min(i,t.length);return n<t.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+t.length+" bones. This GPU supports "+n+"."),0):n}}(b):0;let T,A;if(null!==a.precision&&(m=n.getMaxPrecision(a.precision),m!==a.precision&&console.warn("THREE.WebGLProgram.getParameters:",a.precision,"not supported, using",m,"instead.")),S){const e=cn[S];T=e.vertexShader,A=e.fragmentShader}else T=a.vertexShader,A=a.fragmentShader;const E=e.getRenderTarget();return{isWebGL2:o,shaderID:S,shaderName:a.type,vertexShader:T,fragmentShader:A,defines:a.defines,isRawShaderMaterial:!0===a.isRawShaderMaterial,glslVersion:a.glslVersion,precision:m,instancing:!0===b.isInstancedMesh,instancingColor:!0===b.isInstancedMesh&&null!==b.instanceColor,supportsVertexTextures:p,outputEncoding:null!==E?y(E.texture):e.outputEncoding,map:!!a.map,mapEncoding:y(a.map),matcap:!!a.matcap,matcapEncoding:y(a.matcap),envMap:!!w,envMapMode:w&&w.mapping,envMapEncoding:y(w),envMapCubeUV:!!w&&(w.mapping===h||w.mapping===u),lightMap:!!a.lightMap,lightMapEncoding:y(a.lightMap),aoMap:!!a.aoMap,emissiveMap:!!a.emissiveMap,emissiveMapEncoding:y(a.emissiveMap),bumpMap:!!a.bumpMap,normalMap:!!a.normalMap,objectSpaceNormalMap:1===a.normalMapType,tangentSpaceNormalMap:0===a.normalMapType,clearcoatMap:!!a.clearcoatMap,clearcoatRoughnessMap:!!a.clearcoatRoughnessMap,clearcoatNormalMap:!!a.clearcoatNormalMap,displacementMap:!!a.displacementMap,roughnessMap:!!a.roughnessMap,metalnessMap:!!a.metalnessMap,specularMap:!!a.specularMap,alphaMap:!!a.alphaMap,gradientMap:!!a.gradientMap,sheen:!!a.sheen,transmissionMap:!!a.transmissionMap,combine:a.combine,vertexTangents:a.normalMap&&a.vertexTangents,vertexColors:a.vertexColors,vertexUvs:!!(a.map||a.bumpMap||a.normalMap||a.specularMap||a.alphaMap||a.emissiveMap||a.roughnessMap||a.metalnessMap||a.clearcoatMap||a.clearcoatRoughnessMap||a.clearcoatNormalMap||a.displacementMap||a.transmissionMap),uvsVertexOnly:!(a.map||a.bumpMap||a.normalMap||a.specularMap||a.alphaMap||a.emissiveMap||a.roughnessMap||a.metalnessMap||a.clearcoatNormalMap||a.transmissionMap||!a.displacementMap),fog:!!_,useFog:a.fog,fogExp2:_&&_.isFogExp2,flatShading:!!a.flatShading,sizeAttenuation:a.sizeAttenuation,logarithmicDepthBuffer:l,skinning:a.skinning&&M>0,maxBones:M,useVertexTexture:c,morphTargets:a.morphTargets,morphNormals:a.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:s.directional.length,numPointLights:s.point.length,numSpotLights:s.spot.length,numRectAreaLights:s.rectArea.length,numHemiLights:s.hemi.length,numDirLightShadows:s.directionalShadowMap.length,numPointLightShadows:s.pointShadowMap.length,numSpotLightShadows:s.spotShadowMap.length,numClippingPlanes:r.numPlanes,numClipIntersection:r.numIntersection,dithering:a.dithering,shadowMapEnabled:e.shadowMap.enabled&&g.length>0,shadowMapType:e.shadowMap.type,toneMapping:a.toneMapped?e.toneMapping:0,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:a.premultipliedAlpha,alphaTest:a.alphaTest,doubleSided:2===a.side,flipSided:1===a.side,depthPacking:void 0!==a.depthPacking&&a.depthPacking,index0AttributeName:a.index0AttributeName,extensionDerivatives:a.extensions&&a.extensions.derivatives,extensionFragDepth:a.extensions&&a.extensions.fragDepth,extensionDrawBuffers:a.extensions&&a.extensions.drawBuffers,extensionShaderTextureLOD:a.extensions&&a.extensions.shaderTextureLOD,rendererExtensionFragDepth:o||i.has("EXT_frag_depth"),rendererExtensionDrawBuffers:o||i.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:o||i.has("EXT_shader_texture_lod"),customProgramCacheKey:a.customProgramCacheKey()}},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.fragmentShader),i.push(t.vertexShader)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);if(!1===t.isRawShaderMaterial){for(let e=0;e<g.length;e++)i.push(t[g[e]]);i.push(e.outputEncoding),i.push(e.gammaFactor)}return i.push(t.customProgramCacheKey),i.join()},getUniforms:function(e){const t=f[e.type];let i;if(t){const e=cn[t];i=Wi.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(t,i){let n;for(let e=0,t=s.length;e<t;e++){const t=s[e];if(t.cacheKey===i){n=t,++n.usedTimes;break}}return void 0===n&&(n=new Fa(e,i,t,a),s.push(n)),n},releaseProgram:function(e){if(0==--e.usedTimes){const t=s.indexOf(e);s[t]=s[s.length-1],s.pop(),e.destroy()}},programs:s}}function Ha(){let e=new WeakMap;return{get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,n){e.get(t)[i]=n},dispose:function(){e=new WeakMap}}}function Ga(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Va(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Wa(e){const t=[];let i=0;const n=[],a=[],r={id:-1};function s(n,a,s,o,l,c){let h=t[i];const u=e.get(s);return void 0===h?(h={id:n.id,object:n,geometry:a,material:s,program:u.program||r,groupOrder:o,renderOrder:n.renderOrder,z:l,group:c},t[i]=h):(h.id=n.id,h.object=n,h.geometry=a,h.material=s,h.program=u.program||r,h.groupOrder=o,h.renderOrder=n.renderOrder,h.z=l,h.group=c),i++,h}return{opaque:n,transparent:a,init:function(){i=0,n.length=0,a.length=0},push:function(e,t,i,r,o,l){const c=s(e,t,i,r,o,l);(!0===i.transparent?a:n).push(c)},unshift:function(e,t,i,r,o,l){const c=s(e,t,i,r,o,l);(!0===i.transparent?a:n).unshift(c)},finish:function(){for(let e=i,n=t.length;e<n;e++){const i=t[e];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.program=null,i.group=null}},sort:function(e,t){n.length>1&&n.sort(e||Ga),a.length>1&&a.sort(t||Va)}}}function Ya(e){let t=new WeakMap;return{get:function(i,n){let a;return!1===t.has(i)?(a=new Wa(e),t.set(i,[a])):n>=t.get(i).length?(a=new Wa(e),t.get(i).push(a)):a=t.get(i)[n],a},dispose:function(){t=new WeakMap}}}function Xa(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new Ce,color:new Qt};break;case"SpotLight":i={position:new Ce,direction:new Ce,color:new Qt,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Ce,color:new Qt,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Ce,skyColor:new Qt,groundColor:new Qt};break;case"RectAreaLight":i={color:new Qt,position:new Ce,halfWidth:new Ce,halfHeight:new Ce}}return e[t.id]=i,i}}}let Za=0;function qa(e,t){return(t.castShadow?1:0)-(e.castShadow?1:0)}function Ja(e,t){const i=new Xa,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ye};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ye,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}(),a={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let e=0;e<9;e++)a.probe.push(new Ce);const r=new Ce,s=new it,o=new it;return{setup:function(r){let s=0,o=0,l=0;for(let e=0;e<9;e++)a.probe[e].set(0,0,0);let c=0,h=0,u=0,d=0,p=0,m=0,f=0,g=0;r.sort(qa);for(let e=0,t=r.length;e<t;e++){const t=r[e],y=t.color,v=t.intensity,b=t.distance,_=t.shadow&&t.shadow.map?t.shadow.map.texture:null;if(t.isAmbientLight)s+=y.r*v,o+=y.g*v,l+=y.b*v;else if(t.isLightProbe)for(let e=0;e<9;e++)a.probe[e].addScaledVector(t.sh.coefficients[e],v);else if(t.isDirectionalLight){const e=i.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity),t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,a.directionalShadow[c]=i,a.directionalShadowMap[c]=_,a.directionalShadowMatrix[c]=t.shadow.matrix,m++}a.directional[c]=e,c++}else if(t.isSpotLight){const e=i.get(t);if(e.position.setFromMatrixPosition(t.matrixWorld),e.color.copy(y).multiplyScalar(v),e.distance=b,e.coneCos=Math.cos(t.angle),e.penumbraCos=Math.cos(t.angle*(1-t.penumbra)),e.decay=t.decay,t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,a.spotShadow[u]=i,a.spotShadowMap[u]=_,a.spotShadowMatrix[u]=t.shadow.matrix,g++}a.spot[u]=e,u++}else if(t.isRectAreaLight){const e=i.get(t);e.color.copy(y).multiplyScalar(v),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),a.rectArea[d]=e,d++}else if(t.isPointLight){const e=i.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity),e.distance=t.distance,e.decay=t.decay,t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,i.shadowCameraNear=e.camera.near,i.shadowCameraFar=e.camera.far,a.pointShadow[h]=i,a.pointShadowMap[h]=_,a.pointShadowMatrix[h]=t.shadow.matrix,f++}a.point[h]=e,h++}else if(t.isHemisphereLight){const e=i.get(t);e.skyColor.copy(t.color).multiplyScalar(v),e.groundColor.copy(t.groundColor).multiplyScalar(v),a.hemi[p]=e,p++}}d>0&&(t.isWebGL2||!0===e.has("OES_texture_float_linear")?(a.rectAreaLTC1=ln.LTC_FLOAT_1,a.rectAreaLTC2=ln.LTC_FLOAT_2):!0===e.has("OES_texture_half_float_linear")?(a.rectAreaLTC1=ln.LTC_HALF_1,a.rectAreaLTC2=ln.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),a.ambient[0]=s,a.ambient[1]=o,a.ambient[2]=l;const y=a.hash;y.directionalLength===c&&y.pointLength===h&&y.spotLength===u&&y.rectAreaLength===d&&y.hemiLength===p&&y.numDirectionalShadows===m&&y.numPointShadows===f&&y.numSpotShadows===g||(a.directional.length=c,a.spot.length=u,a.rectArea.length=d,a.point.length=h,a.hemi.length=p,a.directionalShadow.length=m,a.directionalShadowMap.length=m,a.pointShadow.length=f,a.pointShadowMap.length=f,a.spotShadow.length=g,a.spotShadowMap.length=g,a.directionalShadowMatrix.length=m,a.pointShadowMatrix.length=f,a.spotShadowMatrix.length=g,y.directionalLength=c,y.pointLength=h,y.spotLength=u,y.rectAreaLength=d,y.hemiLength=p,y.numDirectionalShadows=m,y.numPointShadows=f,y.numSpotShadows=g,a.version=Za++)},setupView:function(e,t){let i=0,n=0,l=0,c=0,h=0;const u=t.matrixWorldInverse;for(let t=0,d=e.length;t<d;t++){const d=e[t];if(d.isDirectionalLight){const e=a.directional[i];e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(u),i++}else if(d.isSpotLight){const e=a.spot[l];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(u),l++}else if(d.isRectAreaLight){const e=a.rectArea[c];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),o.identity(),s.copy(d.matrixWorld),s.premultiply(u),o.extractRotation(s),e.halfWidth.set(.5*d.width,0,0),e.halfHeight.set(0,.5*d.height,0),e.halfWidth.applyMatrix4(o),e.halfHeight.applyMatrix4(o),c++}else if(d.isPointLight){const e=a.point[n];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const e=a.hemi[h];e.direction.setFromMatrixPosition(d.matrixWorld),e.direction.transformDirection(u),e.direction.normalize(),h++}}},state:a}}function Qa(e,t){const i=new Ja(e,t),n=[],a=[];return{init:function(){n.length=0,a.length=0},state:{lightsArray:n,shadowsArray:a,lights:i},setupLights:function(){i.setup(n)},setupLightsView:function(e){i.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){a.push(e)}}}function Ka(e,t){let i=new WeakMap;return{get:function(n,a=0){let r;return!1===i.has(n)?(r=new Qa(e,t),i.set(n,[r])):a>=i.get(n).length?(r=new Qa(e,t),i.get(n).push(r)):r=i.get(n)[a],r},dispose:function(){i=new WeakMap}}}class $a extends Vt{constructor(e){super(),this.type="MeshDepthMaterial",this.depthPacking=oe,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}$a.prototype.isMeshDepthMaterial=!0;class er extends Vt{constructor(e){super(),this.type="MeshDistanceMaterial",this.referencePosition=new Ce,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}er.prototype.isMeshDistanceMaterial=!0;function tr(e,t,i){let n=new nn;const a=new ye,r=new ye,s=new Me,o=[],l=[],c={},h={0:1,1:0,2:2},u=new Yi({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new ye},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),d=u.clone();d.defines.HORIZONTAL_PASS=1;const p=new wi;p.setAttribute("position",new ti(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const m=new Fi(p,u),f=this;function y(i,n){const a=t.update(m);u.uniforms.shadow_pass.value=i.map.texture,u.uniforms.resolution.value=i.mapSize,u.uniforms.radius.value=i.radius,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(n,null,a,u,m,null),d.uniforms.shadow_pass.value=i.mapPass.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(n,null,a,d,m,null)}function v(e,t,i){const n=e<<0|t<<1|i<<2;let a=o[n];return void 0===a&&(a=new $a({depthPacking:le,morphTargets:e,skinning:t}),o[n]=a),a}function _(e,t,i){const n=e<<0|t<<1|i<<2;let a=l[n];return void 0===a&&(a=new er({morphTargets:e,skinning:t}),l[n]=a),a}function x(t,i,n,a,r,s,o){let l=null,u=v,d=t.customDepthMaterial;if(!0===a.isPointLight&&(u=_,d=t.customDistanceMaterial),void 0===d){let e=!1;!0===n.morphTargets&&(e=i.morphAttributes&&i.morphAttributes.position&&i.morphAttributes.position.length>0);let a=!1;!0===t.isSkinnedMesh&&(!0===n.skinning?a=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t));l=u(e,a,!0===t.isInstancedMesh)}else l=d;if(e.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const e=l.uuid,t=n.uuid;let i=c[e];void 0===i&&(i={},c[e]=i);let a=i[t];void 0===a&&(a=l.clone(),i[t]=a),l=a}return l.visible=n.visible,l.wireframe=n.wireframe,l.side=3===o?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:h[n.side],l.clipShadows=n.clipShadows,l.clippingPlanes=n.clippingPlanes,l.clipIntersection=n.clipIntersection,l.wireframeLinewidth=n.wireframeLinewidth,l.linewidth=n.linewidth,!0===a.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(a.matrixWorld),l.nearDistance=r,l.farDistance=s),l}function w(i,a,r,s,o){if(!1===i.visible)return;if(i.layers.test(a.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===o)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,i.matrixWorld);const n=t.update(i),a=i.material;if(Array.isArray(a)){const t=n.groups;for(let l=0,c=t.length;l<c;l++){const c=t[l],h=a[c.materialIndex];if(h&&h.visible){const t=x(i,n,h,s,r.near,r.far,o);e.renderBufferDirect(r,null,n,t,i,c)}}}else if(a.visible){const t=x(i,n,a,s,r.near,r.far,o);e.renderBufferDirect(r,null,n,t,i,null)}}const l=i.children;for(let e=0,t=l.length;e<t;e++)w(l[e],a,r,s,o)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(t,o,l){if(!1===f.enabled)return;if(!1===f.autoUpdate&&!1===f.needsUpdate)return;if(0===t.length)return;const c=e.getRenderTarget(),h=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),d=e.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let c=0,h=t.length;c<h;c++){const h=t[c],u=h.shadow;if(void 0===u){console.warn("THREE.WebGLShadowMap:",h,"has no shadow.");continue}if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;a.copy(u.mapSize);const p=u.getFrameExtents();if(a.multiply(p),r.copy(u.mapSize),(a.x>i||a.y>i)&&(a.x>i&&(r.x=Math.floor(i/p.x),a.x=r.x*p.x,u.mapSize.x=r.x),a.y>i&&(r.y=Math.floor(i/p.y),a.y=r.y*p.y,u.mapSize.y=r.y)),null===u.map&&!u.isPointLightShadow&&3===this.type){const e={minFilter:b,magFilter:b,format:I};u.map=new Te(a.x,a.y,e),u.map.texture.name=h.name+".shadowMap",u.mapPass=new Te(a.x,a.y,e),u.camera.updateProjectionMatrix()}if(null===u.map){const e={minFilter:g,magFilter:g,format:I};u.map=new Te(a.x,a.y,e),u.map.texture.name=h.name+".shadowMap",u.camera.updateProjectionMatrix()}e.setRenderTarget(u.map),e.clear();const m=u.getViewportCount();for(let e=0;e<m;e++){const t=u.getViewport(e);s.set(r.x*t.x,r.y*t.y,r.x*t.z,r.y*t.w),d.viewport(s),u.updateMatrices(h,e),n=u.getFrustum(),w(o,l,u.camera,h,this.type)}u.isPointLightShadow||3!==this.type||y(u,l),u.needsUpdate=!1}f.needsUpdate=!1,e.setRenderTarget(c,h,u)}}function ir(e,t,i){const n=i.isWebGL2;const r=new function(){let t=!1;const i=new Me;let n=null;const a=new Me(0,0,0,0);return{setMask:function(i){n===i||t||(e.colorMask(i,i,i,i),n=i)},setLocked:function(e){t=e},setClear:function(t,n,r,s,o){!0===o&&(t*=s,n*=s,r*=s),i.set(t,n,r,s),!1===a.equals(i)&&(e.clearColor(t,n,r,s),a.copy(i))},reset:function(){t=!1,n=null,a.set(-1,0,0,0)}}},s=new function(){let t=!1,i=null,n=null,a=null;return{setTest:function(e){e?L(2929):k(2929)},setMask:function(n){i===n||t||(e.depthMask(n),i=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case 0:e.depthFunc(512);break;case 1:e.depthFunc(519);break;case 2:e.depthFunc(513);break;case 3:e.depthFunc(515);break;case 4:e.depthFunc(514);break;case 5:e.depthFunc(518);break;case 6:e.depthFunc(516);break;case 7:e.depthFunc(517);break;default:e.depthFunc(515)}else e.depthFunc(515);n=t}},setLocked:function(e){t=e},setClear:function(t){a!==t&&(e.clearDepth(t),a=t)},reset:function(){t=!1,i=null,n=null,a=null}}},o=new function(){let t=!1,i=null,n=null,a=null,r=null,s=null,o=null,l=null,c=null;return{setTest:function(e){t||(e?L(2960):k(2960))},setMask:function(n){i===n||t||(e.stencilMask(n),i=n)},setFunc:function(t,i,s){n===t&&a===i&&r===s||(e.stencilFunc(t,i,s),n=t,a=i,r=s)},setOp:function(t,i,n){s===t&&o===i&&l===n||(e.stencilOp(t,i,n),s=t,o=i,l=n)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,i=null,n=null,a=null,r=null,s=null,o=null,l=null,c=null}}};let l={},c=null,h=!1,u=null,d=null,p=null,m=null,f=null,g=null,y=null,v=!1,b=null,_=null,x=null,w=null,S=null;const M=e.getParameter(35661);let T=!1,A=0;const E=e.getParameter(7938);-1!==E.indexOf("WebGL")?(A=parseFloat(/^WebGL (\d)/.exec(E)[1]),T=A>=1):-1!==E.indexOf("OpenGL ES")&&(A=parseFloat(/^OpenGL ES (\d)/.exec(E)[1]),T=A>=2);let C=null,I={};const P=new Me,R=new Me;function O(t,i,n){const a=new Uint8Array(4),r=e.createTexture();e.bindTexture(t,r),e.texParameteri(t,10241,9728),e.texParameteri(t,10240,9728);for(let t=0;t<n;t++)e.texImage2D(i+t,0,6408,1,1,0,6408,5121,a);return r}const D={};function L(t){!0!==l[t]&&(e.enable(t),l[t]=!0)}function k(t){!1!==l[t]&&(e.disable(t),l[t]=!1)}D[3553]=O(3553,3553,1),D[34067]=O(34067,34069,6),r.setClear(0,0,0,1),s.setClear(1),o.setClear(0),L(2929),s.setFunc(3),U(!1),F(1),L(2884),z(0);const N={[a]:32774,101:32778,102:32779};if(n)N[103]=32775,N[104]=32776;else{const e=t.get("EXT_blend_minmax");null!==e&&(N[103]=e.MIN_EXT,N[104]=e.MAX_EXT)}const B={200:0,201:1,202:768,204:770,210:776,208:774,206:772,203:769,205:771,209:775,207:773};function z(t,i,n,r,s,o,l,c){if(0!==t){if(!1===h&&(L(3042),h=!0),5===t)s=s||i,o=o||n,l=l||r,i===d&&s===f||(e.blendEquationSeparate(N[i],N[s]),d=i,f=s),n===p&&r===m&&o===g&&l===y||(e.blendFuncSeparate(B[n],B[r],B[o],B[l]),p=n,m=r,g=o,y=l),u=t,v=null;else if(t!==u||c!==v){if(d===a&&f===a||(e.blendEquation(32774),d=a,f=a),c)switch(t){case 1:e.blendFuncSeparate(1,771,1,771);break;case 2:e.blendFunc(1,1);break;case 3:e.blendFuncSeparate(0,0,769,771);break;case 4:e.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case 1:e.blendFuncSeparate(770,771,1,771);break;case 2:e.blendFunc(770,1);break;case 3:e.blendFunc(0,769);break;case 4:e.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}p=null,m=null,g=null,y=null,u=t,v=c}}else!0===h&&(k(3042),h=!1)}function U(t){b!==t&&(t?e.frontFace(2304):e.frontFace(2305),b=t)}function F(t){0!==t?(L(2884),t!==_&&(1===t?e.cullFace(1029):2===t?e.cullFace(1028):e.cullFace(1032))):k(2884),_=t}function j(t,i,n){t?(L(32823),w===i&&S===n||(e.polygonOffset(i,n),w=i,S=n)):k(32823)}function H(t){void 0===t&&(t=33984+M-1),C!==t&&(e.activeTexture(t),C=t)}return{buffers:{color:r,depth:s,stencil:o},enable:L,disable:k,useProgram:function(t){return c!==t&&(e.useProgram(t),c=t,!0)},setBlending:z,setMaterial:function(e,t){2===e.side?k(2884):L(2884);let i=1===e.side;t&&(i=!i),U(i),1===e.blending&&!1===e.transparent?z(0):z(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),s.setFunc(e.depthFunc),s.setTest(e.depthTest),s.setMask(e.depthWrite),r.setMask(e.colorWrite);const n=e.stencilWrite;o.setTest(n),n&&(o.setMask(e.stencilWriteMask),o.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),o.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),j(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)},setFlipSided:U,setCullFace:F,setLineWidth:function(t){t!==x&&(T&&e.lineWidth(t),x=t)},setPolygonOffset:j,setScissorTest:function(e){e?L(3089):k(3089)},activeTexture:H,bindTexture:function(t,i){null===C&&H();let n=I[C];void 0===n&&(n={type:void 0,texture:void 0},I[C]=n),n.type===t&&n.texture===i||(e.bindTexture(t,i||D[t]),n.type=t,n.texture=i)},unbindTexture:function(){const t=I[C];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===P.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),P.copy(t))},viewport:function(t){!1===R.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),R.copy(t))},reset:function(){e.disable(3042),e.disable(2884),e.disable(2929),e.disable(32823),e.disable(3089),e.disable(2960),e.blendEquation(32774),e.blendFunc(1,0),e.blendFuncSeparate(1,0,1,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(513),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(519,0,4294967295),e.stencilOp(7680,7680,7680),e.clearStencil(0),e.cullFace(1029),e.frontFace(2305),e.polygonOffset(0,0),e.activeTexture(33984),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),l={},C=null,I={},c=null,h=!1,u=null,d=null,p=null,m=null,f=null,g=null,y=null,v=!1,b=null,_=null,x=null,w=null,S=null,r.reset(),s.reset(),o.reset()}}}function nr(e,t,i,n,a,r,s){const o=a.isWebGL2,l=a.maxTextures,c=a.maxCubemapSize,h=a.maxTextureSize,u=a.maxSamples,p=new WeakMap;let w,P=!1;try{P="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function D(e,t){return P?new OffscreenCanvas(e,t):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function L(e,t,i,n){let a=1;if((e.width>n||e.height>n)&&(a=n/Math.max(e.width,e.height)),a<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const n=t?ge.floorPowerOfTwo:Math.floor,r=n(a*e.width),s=n(a*e.height);void 0===w&&(w=D(r,s));const o=i?D(r,s):w;o.width=r,o.height=s;return o.getContext("2d").drawImage(e,0,0,r,s),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+e.width+"x"+e.height+") to ("+r+"x"+s+")."),o}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+e.width+"x"+e.height+")."),e}return e}function k(e){return ge.isPowerOfTwo(e.width)&&ge.isPowerOfTwo(e.height)}function N(e,t){return e.generateMipmaps&&t&&e.minFilter!==g&&e.minFilter!==b}function B(t,i,a,r){e.generateMipmap(t);n.get(i).__maxMipLevel=Math.log2(Math.max(a,r))}function z(i,n,a){if(!1===o)return n;if(null!==i){if(void 0!==e[i])return e[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let r=n;return 6403===n&&(5126===a&&(r=33326),5131===a&&(r=33325),5121===a&&(r=33321)),6407===n&&(5126===a&&(r=34837),5131===a&&(r=34843),5121===a&&(r=32849)),6408===n&&(5126===a&&(r=34836),5131===a&&(r=34842),5121===a&&(r=32856)),33325!==r&&33326!==r&&34842!==r&&34836!==r||t.get("EXT_color_buffer_float"),r}function U(e){return e===g||e===y||e===v?9728:9729}function F(t){const i=t.target;i.removeEventListener("dispose",F),function(t){const i=n.get(t);if(void 0===i.__webglInit)return;e.deleteTexture(i.__webglTexture),n.remove(t)}(i),i.isVideoTexture&&p.delete(i),s.memory.textures--}function j(t){const i=t.target;i.removeEventListener("dispose",j),function(t){const i=t.texture,a=n.get(t),r=n.get(i);if(!t)return;void 0!==r.__webglTexture&&e.deleteTexture(r.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++)e.deleteFramebuffer(a.__webglFramebuffer[t]),a.__webglDepthbuffer&&e.deleteRenderbuffer(a.__webglDepthbuffer[t]);else e.deleteFramebuffer(a.__webglFramebuffer),a.__webglDepthbuffer&&e.deleteRenderbuffer(a.__webglDepthbuffer),a.__webglMultisampledFramebuffer&&e.deleteFramebuffer(a.__webglMultisampledFramebuffer),a.__webglColorRenderbuffer&&e.deleteRenderbuffer(a.__webglColorRenderbuffer),a.__webglDepthRenderbuffer&&e.deleteRenderbuffer(a.__webglDepthRenderbuffer);n.remove(i),n.remove(t)}(i),s.memory.textures--}let H=0;function G(e,t){const a=n.get(e);if(e.isVideoTexture&&function(e){const t=s.render.frame;p.get(e)!==t&&(p.set(e,t),e.update())}(e),e.version>0&&a.__version!==e.version){const i=e.image;if(void 0===i)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==i.complete)return void q(a,e,t);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.activeTexture(33984+t),i.bindTexture(3553,a.__webglTexture)}function V(t,a){const s=n.get(t);t.version>0&&s.__version!==t.version?function(t,n,a){if(6!==n.image.length)return;Z(t,n),i.activeTexture(33984+a),i.bindTexture(34067,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment),e.pixelStorei(37443,0);const s=n&&(n.isCompressedTexture||n.image[0].isCompressedTexture),l=n.image[0]&&n.image[0].isDataTexture,h=[];for(let e=0;e<6;e++)h[e]=s||l?l?n.image[e].image:n.image[e]:L(n.image[e],!1,!0,c);const u=h[0],d=k(u)||o,p=r.convert(n.format),m=r.convert(n.type),f=z(n.internalFormat,p,m);let g;if(X(34067,n,d),s){for(let e=0;e<6;e++){g=h[e].mipmaps;for(let t=0;t<g.length;t++){const a=g[t];n.format!==I&&n.format!==C?null!==p?i.compressedTexImage2D(34069+e,t,f,a.width,a.height,0,a.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(34069+e,t,f,a.width,a.height,0,p,m,a.data)}}t.__maxMipLevel=g.length-1}else{g=n.mipmaps;for(let e=0;e<6;e++)if(l){i.texImage2D(34069+e,0,f,h[e].width,h[e].height,0,p,m,h[e].data);for(let t=0;t<g.length;t++){const n=g[t].image[e].image;i.texImage2D(34069+e,t+1,f,n.width,n.height,0,p,m,n.data)}}else{i.texImage2D(34069+e,0,f,p,m,h[e]);for(let t=0;t<g.length;t++){const n=g[t];i.texImage2D(34069+e,t+1,f,p,m,n.image[e])}}t.__maxMipLevel=g.length}N(n,d)&&B(34067,n,u.width,u.height);t.__version=n.version,n.onUpdate&&n.onUpdate(n)}(s,t,a):(i.activeTexture(33984+a),i.bindTexture(34067,s.__webglTexture))}const W={[d]:10497,[m]:33071,[f]:33648},Y={[g]:9728,[y]:9984,[v]:9986,[b]:9729,[_]:9985,[x]:9987};function X(i,r,s){if(s?(e.texParameteri(i,10242,W[r.wrapS]),e.texParameteri(i,10243,W[r.wrapT]),32879!==i&&35866!==i||e.texParameteri(i,32882,W[r.wrapR]),e.texParameteri(i,10240,Y[r.magFilter]),e.texParameteri(i,10241,Y[r.minFilter])):(e.texParameteri(i,10242,33071),e.texParameteri(i,10243,33071),32879!==i&&35866!==i||e.texParameteri(i,32882,33071),r.wrapS===m&&r.wrapT===m||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),e.texParameteri(i,10240,U(r.magFilter)),e.texParameteri(i,10241,U(r.minFilter)),r.minFilter!==g&&r.minFilter!==b&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),!0===t.has("EXT_texture_filter_anisotropic")){const s=t.get("EXT_texture_filter_anisotropic");if(r.type===T&&!1===t.has("OES_texture_float_linear"))return;if(!1===o&&r.type===A&&!1===t.has("OES_texture_half_float_linear"))return;(r.anisotropy>1||n.get(r).__currentAnisotropy)&&(e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r.anisotropy,a.getMaxAnisotropy())),n.get(r).__currentAnisotropy=r.anisotropy)}}function Z(t,i){void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",F),t.__webglTexture=e.createTexture(),s.memory.textures++)}function q(t,n,a){let s=3553;n.isDataTexture2DArray&&(s=35866),n.isDataTexture3D&&(s=32879),Z(t,n),i.activeTexture(33984+a),i.bindTexture(s,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment),e.pixelStorei(37443,0);const l=function(e){return!o&&(e.wrapS!==m||e.wrapT!==m||e.minFilter!==g&&e.minFilter!==b)}(n)&&!1===k(n.image),c=L(n.image,l,!1,h),u=k(c)||o,d=r.convert(n.format);let p,f=r.convert(n.type),y=z(n.internalFormat,d,f);X(s,n,u);const v=n.mipmaps;if(n.isDepthTexture)y=6402,o?y=n.type===T?36012:n.type===M?33190:n.type===E?35056:33189:n.type===T&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===R&&6402===y&&n.type!==S&&n.type!==M&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=S,f=r.convert(n.type)),n.format===O&&6402===y&&(y=34041,n.type!==E&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=E,f=r.convert(n.type))),i.texImage2D(3553,0,y,c.width,c.height,0,d,f,null);else if(n.isDataTexture)if(v.length>0&&u){for(let e=0,t=v.length;e<t;e++)p=v[e],i.texImage2D(3553,e,y,p.width,p.height,0,d,f,p.data);n.generateMipmaps=!1,t.__maxMipLevel=v.length-1}else i.texImage2D(3553,0,y,c.width,c.height,0,d,f,c.data),t.__maxMipLevel=0;else if(n.isCompressedTexture){for(let e=0,t=v.length;e<t;e++)p=v[e],n.format!==I&&n.format!==C?null!==d?i.compressedTexImage2D(3553,e,y,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(3553,e,y,p.width,p.height,0,d,f,p.data);t.__maxMipLevel=v.length-1}else if(n.isDataTexture2DArray)i.texImage3D(35866,0,y,c.width,c.height,c.depth,0,d,f,c.data),t.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(32879,0,y,c.width,c.height,c.depth,0,d,f,c.data),t.__maxMipLevel=0;else if(v.length>0&&u){for(let e=0,t=v.length;e<t;e++)p=v[e],i.texImage2D(3553,e,y,d,f,p);n.generateMipmaps=!1,t.__maxMipLevel=v.length-1}else i.texImage2D(3553,0,y,d,f,c),t.__maxMipLevel=0;N(n,u)&&B(s,n,c.width,c.height),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function J(t,a,s,o){const l=a.texture,c=r.convert(l.format),h=r.convert(l.type),u=z(l.internalFormat,c,h);32879===o||35866===o?i.texImage3D(o,0,u,a.width,a.height,a.depth,0,c,h,null):i.texImage2D(o,0,u,a.width,a.height,0,c,h,null),e.bindFramebuffer(36160,t),e.framebufferTexture2D(36160,s,o,n.get(l).__webglTexture,0),e.bindFramebuffer(36160,null)}function Q(t,i,n){if(e.bindRenderbuffer(36161,t),i.depthBuffer&&!i.stencilBuffer){let a=33189;if(n){const t=i.depthTexture;t&&t.isDepthTexture&&(t.type===T?a=36012:t.type===M&&(a=33190));const n=$(i);e.renderbufferStorageMultisample(36161,n,a,i.width,i.height)}else e.renderbufferStorage(36161,a,i.width,i.height);e.framebufferRenderbuffer(36160,36096,36161,t)}else if(i.depthBuffer&&i.stencilBuffer){if(n){const t=$(i);e.renderbufferStorageMultisample(36161,t,35056,i.width,i.height)}else e.renderbufferStorage(36161,34041,i.width,i.height);e.framebufferRenderbuffer(36160,33306,36161,t)}else{const t=i.texture,a=r.convert(t.format),s=r.convert(t.type),o=z(t.internalFormat,a,s);if(n){const t=$(i);e.renderbufferStorageMultisample(36161,t,o,i.width,i.height)}else e.renderbufferStorage(36161,o,i.width,i.height)}e.bindRenderbuffer(36161,null)}function K(t){const i=n.get(t),a=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture){if(a)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(36160,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),G(i.depthTexture,0);const a=n.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===R)e.framebufferTexture2D(36160,36096,3553,a,0);else{if(i.depthTexture.format!==O)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(36160,33306,3553,a,0)}}(i.__webglFramebuffer,t)}else if(a){i.__webglDepthbuffer=[];for(let n=0;n<6;n++)e.bindFramebuffer(36160,i.__webglFramebuffer[n]),i.__webglDepthbuffer[n]=e.createRenderbuffer(),Q(i.__webglDepthbuffer[n],t,!1)}else e.bindFramebuffer(36160,i.__webglFramebuffer),i.__webglDepthbuffer=e.createRenderbuffer(),Q(i.__webglDepthbuffer,t,!1);e.bindFramebuffer(36160,null)}function $(e){return o&&e.isWebGLMultisampleRenderTarget?Math.min(u,e.samples):0}let ee=!1,te=!1;this.allocateTextureUnit=function(){const e=H;return e>=l&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+l),H+=1,e},this.resetTextureUnits=function(){H=0},this.setTexture2D=G,this.setTexture2DArray=function(e,t){const a=n.get(e);e.version>0&&a.__version!==e.version?q(a,e,t):(i.activeTexture(33984+t),i.bindTexture(35866,a.__webglTexture))},this.setTexture3D=function(e,t){const a=n.get(e);e.version>0&&a.__version!==e.version?q(a,e,t):(i.activeTexture(33984+t),i.bindTexture(32879,a.__webglTexture))},this.setTextureCube=V,this.setupRenderTarget=function(t){const a=t.texture,l=n.get(t),c=n.get(a);t.addEventListener("dispose",j),c.__webglTexture=e.createTexture(),s.memory.textures++;const h=!0===t.isWebGLCubeRenderTarget,u=!0===t.isWebGLMultisampleRenderTarget,d=a.isDataTexture3D||a.isDataTexture2DArray,p=k(t)||o;if(!o||a.format!==C||a.type!==T&&a.type!==A||(a.format=I,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),h){l.__webglFramebuffer=[];for(let t=0;t<6;t++)l.__webglFramebuffer[t]=e.createFramebuffer()}else if(l.__webglFramebuffer=e.createFramebuffer(),u)if(o){l.__webglMultisampledFramebuffer=e.createFramebuffer(),l.__webglColorRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,l.__webglColorRenderbuffer);const i=r.convert(a.format),n=r.convert(a.type),s=z(a.internalFormat,i,n),o=$(t);e.renderbufferStorageMultisample(36161,o,s,t.width,t.height),e.bindFramebuffer(36160,l.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(36160,36064,36161,l.__webglColorRenderbuffer),e.bindRenderbuffer(36161,null),t.depthBuffer&&(l.__webglDepthRenderbuffer=e.createRenderbuffer(),Q(l.__webglDepthRenderbuffer,t,!0)),e.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(h){i.bindTexture(34067,c.__webglTexture),X(34067,a,p);for(let e=0;e<6;e++)J(l.__webglFramebuffer[e],t,36064,34069+e);N(a,p)&&B(34067,a,t.width,t.height),i.bindTexture(34067,null)}else{let e=3553;if(d)if(o){e=a.isDataTexture3D?32879:35866}else console.warn("THREE.DataTexture3D and THREE.DataTexture2DArray only supported with WebGL2.");i.bindTexture(e,c.__webglTexture),X(e,a,p),J(l.__webglFramebuffer,t,36064,e),N(a,p)&&B(3553,a,t.width,t.height),i.bindTexture(3553,null)}t.depthBuffer&&K(t)},this.updateRenderTargetMipmap=function(e){const t=e.texture;if(N(t,k(e)||o)){const a=e.isWebGLCubeRenderTarget?34067:3553,r=n.get(t).__webglTexture;i.bindTexture(a,r),B(a,t,e.width,e.height),i.bindTexture(a,null)}},this.updateMultisampleRenderTarget=function(t){if(t.isWebGLMultisampleRenderTarget)if(o){const i=n.get(t);e.bindFramebuffer(36008,i.__webglMultisampledFramebuffer),e.bindFramebuffer(36009,i.__webglFramebuffer);const a=t.width,r=t.height;let s=16384;t.depthBuffer&&(s|=256),t.stencilBuffer&&(s|=1024),e.blitFramebuffer(0,0,a,r,0,0,a,r,s,9728),e.bindFramebuffer(36160,i.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(e,t){e&&e.isWebGLRenderTarget&&(!1===ee&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),ee=!0),e=e.texture),G(e,t)},this.safeSetTextureCube=function(e,t){e&&e.isWebGLCubeRenderTarget&&(!1===te&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),te=!0),e=e.texture),V(e,t)}}function ar(e,t,i){const n=i.isWebGL2;return{convert:function(e){let i;if(e===w)return 5121;if(1017===e)return 32819;if(1018===e)return 32820;if(1019===e)return 33635;if(1010===e)return 5120;if(1011===e)return 5122;if(e===S)return 5123;if(1013===e)return 5124;if(e===M)return 5125;if(e===T)return 5126;if(e===A)return n?5131:(i=t.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(1021===e)return 6406;if(e===C)return 6407;if(e===I)return 6408;if(e===P)return 6409;if(1025===e)return 6410;if(e===R)return 6402;if(e===O)return 34041;if(e===D)return 6403;if(1029===e)return 36244;if(e===L)return 33319;if(1031===e)return 33320;if(1032===e)return 36248;if(1033===e)return 36249;if(e===k||e===N||e===B||e===z){if(i=t.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(e===k)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===N)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===B)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===z)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===U||e===F||e===j||e===H){if(i=t.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(e===U)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===F)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===j)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===H)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===G)return i=t.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if((e===V||e===W)&&(i=t.get("WEBGL_compressed_texture_etc"),null!==i)){if(e===V)return i.COMPRESSED_RGB8_ETC2;if(e===W)return i.COMPRESSED_RGBA8_ETC2_EAC}return 37808===e||37809===e||37810===e||37811===e||37812===e||37813===e||37814===e||37815===e||37816===e||37817===e||37818===e||37819===e||37820===e||37821===e||37840===e||37841===e||37842===e||37843===e||37844===e||37845===e||37846===e||37847===e||37848===e||37849===e||37850===e||37851===e||37852===e||37853===e?(i=t.get("WEBGL_compressed_texture_astc"),null!==i?e:null):36492===e?(i=t.get("EXT_texture_compression_bptc"),null!==i?e:null):e===E?n?34042:(i=t.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function rr(e=[]){Zi.call(this),this.cameras=e}rr.prototype=Object.assign(Object.create(Zi.prototype),{constructor:rr,isArrayCamera:!0});class sr extends Et{constructor(){super(),this.type="Group"}}function or(){this._targetRay=null,this._grip=null,this._hand=null}function lr(e,t){const i=this;let n=null,a=1,r=null,s="local-floor",o=null;const l=[],c=new Map,h=new Zi;h.layers.enable(1),h.viewport=new Me;const u=new Zi;u.layers.enable(2),u.viewport=new Me;const d=[h,u],p=new rr;p.layers.enable(1),p.layers.enable(2);let m=null,f=null;function g(e){const t=c.get(e.inputSource);t&&t.dispatchEvent({type:e.type,data:e.inputSource})}function y(){c.forEach((function(e,t){e.disconnect(t)})),c.clear(),m=null,f=null,e.setFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),S.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function v(e){const t=n.inputSources;for(let e=0;e<l.length;e++)c.set(t[e],l[e]);for(let t=0;t<e.removed.length;t++){const i=e.removed[t],n=c.get(i);n&&(n.dispatchEvent({type:"disconnected",data:i}),c.delete(i))}for(let t=0;t<e.added.length;t++){const i=e.added[t],n=c.get(i);n&&n.dispatchEvent({type:"connected",data:i})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=l[e];return void 0===t&&(t=new or,l[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=l[e];return void 0===t&&(t=new or,l[e]=t),t.getGripSpace()},this.getHand=function(e){let t=l[e];return void 0===t&&(t=new or,l[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){a=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){s=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return r},this.getSession=function(){return n},this.setSession=async function(e){if(n=e,null!==n){n.addEventListener("select",g),n.addEventListener("selectstart",g),n.addEventListener("selectend",g),n.addEventListener("squeeze",g),n.addEventListener("squeezestart",g),n.addEventListener("squeezeend",g),n.addEventListener("end",y),n.addEventListener("inputsourceschange",v);const e=t.getContextAttributes();!0!==e.xrCompatible&&await t.makeXRCompatible();const o={antialias:e.antialias,alpha:e.alpha,depth:e.depth,stencil:e.stencil,framebufferScaleFactor:a},l=new XRWebGLLayer(n,t,o);n.updateRenderState({baseLayer:l}),r=await n.requestReferenceSpace(s),S.setContext(n),S.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}};const b=new Ce,_=new Ce;function x(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.getCamera=function(e){p.near=u.near=h.near=e.near,p.far=u.far=h.far=e.far,m===p.near&&f===p.far||(n.updateRenderState({depthNear:p.near,depthFar:p.far}),m=p.near,f=p.far);const t=e.parent,i=p.cameras;x(p,t);for(let e=0;e<i.length;e++)x(i[e],t);e.matrixWorld.copy(p.matrixWorld),e.matrix.copy(p.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale);const a=e.children;for(let e=0,t=a.length;e<t;e++)a[e].updateMatrixWorld(!0);return 2===i.length?function(e,t,i){b.setFromMatrixPosition(t.matrixWorld),_.setFromMatrixPosition(i.matrixWorld);const n=b.distanceTo(_),a=t.projectionMatrix.elements,r=i.projectionMatrix.elements,s=a[14]/(a[10]-1),o=a[14]/(a[10]+1),l=(a[9]+1)/a[5],c=(a[9]-1)/a[5],h=(a[8]-1)/a[0],u=(r[8]+1)/r[0],d=s*h,p=s*u,m=n/(-h+u),f=m*-h;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();const g=s+m,y=o+m,v=d-f,x=p+(n-f),w=l*o/y*g,S=c*o/y*g;e.projectionMatrix.makePerspective(v,x,w,S,g,y)}(p,h,u):p.projectionMatrix.copy(h.projectionMatrix),p};let w=null;const S=new an;S.setAnimationLoop((function(t,i){if(o=i.getViewerPose(r),null!==o){const t=o.views,i=n.renderState.baseLayer;e.setFramebuffer(i.framebuffer);let a=!1;t.length!==p.cameras.length&&(p.cameras.length=0,a=!0);for(let e=0;e<t.length;e++){const n=t[e],r=i.getViewport(n),s=d[e];s.matrix.fromArray(n.transform.matrix),s.projectionMatrix.fromArray(n.projectionMatrix),s.viewport.set(r.x,r.y,r.width,r.height),0===e&&p.matrix.copy(s.matrix),!0===a&&p.cameras.push(s)}}const a=n.inputSources;for(let e=0;e<l.length;e++){const t=l[e],n=a[e];t.update(n,i,r)}w&&w(t,i)})),this.setAnimationLoop=function(e){w=e},this.dispose=function(){}}function cr(e){function t(t,i){t.opacity.value=i.opacity,i.color&&t.diffuse.value.copy(i.color),i.emissive&&t.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(t.map.value=i.map),i.alphaMap&&(t.alphaMap.value=i.alphaMap),i.specularMap&&(t.specularMap.value=i.specularMap);const n=e.get(i).envMap;if(n){t.envMap.value=n,t.flipEnvMap.value=n.isCubeTexture&&n._needsFlipEnvMap?-1:1,t.reflectivity.value=i.reflectivity,t.refractionRatio.value=i.refractionRatio;const a=e.get(n).__maxMipLevel;void 0!==a&&(t.maxMipLevel.value=a)}let a,r;i.lightMap&&(t.lightMap.value=i.lightMap,t.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(t.aoMap.value=i.aoMap,t.aoMapIntensity.value=i.aoMapIntensity),i.map?a=i.map:i.specularMap?a=i.specularMap:i.displacementMap?a=i.displacementMap:i.normalMap?a=i.normalMap:i.bumpMap?a=i.bumpMap:i.roughnessMap?a=i.roughnessMap:i.metalnessMap?a=i.metalnessMap:i.alphaMap?a=i.alphaMap:i.emissiveMap?a=i.emissiveMap:i.clearcoatMap?a=i.clearcoatMap:i.clearcoatNormalMap?a=i.clearcoatNormalMap:i.clearcoatRoughnessMap&&(a=i.clearcoatRoughnessMap),void 0!==a&&(a.isWebGLRenderTarget&&(a=a.texture),!0===a.matrixAutoUpdate&&a.updateMatrix(),t.uvTransform.value.copy(a.matrix)),i.aoMap?r=i.aoMap:i.lightMap&&(r=i.lightMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uv2Transform.value.copy(r.matrix))}function i(t,i){t.roughness.value=i.roughness,t.metalness.value=i.metalness,i.roughnessMap&&(t.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(t.metalnessMap.value=i.metalnessMap),i.emissiveMap&&(t.emissiveMap.value=i.emissiveMap),i.bumpMap&&(t.bumpMap.value=i.bumpMap,t.bumpScale.value=i.bumpScale,1===i.side&&(t.bumpScale.value*=-1)),i.normalMap&&(t.normalMap.value=i.normalMap,t.normalScale.value.copy(i.normalScale),1===i.side&&t.normalScale.value.negate()),i.displacementMap&&(t.displacementMap.value=i.displacementMap,t.displacementScale.value=i.displacementScale,t.displacementBias.value=i.displacementBias);e.get(i).envMap&&(t.envMapIntensity.value=i.envMapIntensity)}return{refreshFogUniforms:function(e,t){e.fogColor.value.copy(t.color),t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,n,a,r){n.isMeshBasicMaterial?t(e,n):n.isMeshLambertMaterial?(t(e,n),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(e,n)):n.isMeshToonMaterial?(t(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap);t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshPhongMaterial?(t(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshStandardMaterial?(t(e,n),n.isMeshPhysicalMaterial?function(e,t){i(e,t),e.reflectivity.value=t.reflectivity,e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.sheen&&e.sheen.value.copy(t.sheen);t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap);t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap);t.clearcoatNormalMap&&(e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),e.clearcoatNormalMap.value=t.clearcoatNormalMap,1===t.side&&e.clearcoatNormalScale.value.negate());e.transmission.value=t.transmission,t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap)}(e,n):i(e,n)):n.isMeshMatcapMaterial?(t(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDepthMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDistanceMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(e,n)):n.isMeshNormalMaterial?(t(e,n),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,i,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*n,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let a;t.map?a=t.map:t.alphaMap&&(a=t.alphaMap);void 0!==a&&(!0===a.matrixAutoUpdate&&a.updateMatrix(),e.uvTransform.value.copy(a.matrix))}(e,n,a,r):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let i;t.map?i=t.map:t.alphaMap&&(i=t.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),e.uvTransform.value.copy(i.matrix))}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function hr(e){const t=void 0!==(e=e||{}).canvas?e.canvas:function(){const e=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return e.style.display="block",e}(),i=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,a=void 0===e.depth||e.depth,r=void 0===e.stencil||e.stencil,s=void 0!==e.antialias&&e.antialias,o=void 0===e.premultipliedAlpha||e.premultipliedAlpha,l=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,c=void 0!==e.powerPreference?e.powerPreference:"default",h=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat;let u=null,d=null;const p=[],m=[];this.domElement=t,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=ee,this.physicallyCorrectLights=!1,this.toneMapping=0,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const f=this;let g=!1,y=null,v=0,b=0,_=null,x=null,S=-1,M=null;const E=new Me,C=new Me;let P=null,R=t.width,O=t.height,D=1,L=null,k=null;const N=new Me(0,0,R,O),B=new Me(0,0,R,O);let z=!1;const U=new nn;let F=!1,j=!1;const H=new it,G=new Ce,V={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function W(){return null===_?D:1}let Y,X,Z,q,J,Q,K,$,te,ie,ne,ae,re,se,oe,le,ce,he,ue,de,pe,me=i;function fe(e,i){for(let n=0;n<e.length;n++){const a=e[n],r=t.getContext(a,i);if(null!==r)return r}return null}try{const e={alpha:n,depth:a,stencil:r,antialias:s,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:h};if(t.addEventListener("webglcontextlost",xe,!1),t.addEventListener("webglcontextrestored",we,!1),null===me){const t=["webgl2","webgl","experimental-webgl"];if(!0===f.isWebGL1Renderer&&t.shift(),me=fe(t,e),null===me)throw fe(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===me.getShaderPrecisionFormat&&(me.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function ve(){Y=new gn(me),X=new pn(me,Y,e),Y.init(X),de=new ar(me,Y,X),Z=new ir(me,Y,X),Z.scissor(C.copy(B).multiplyScalar(D).floor()),Z.viewport(E.copy(N).multiplyScalar(D).floor()),q=new bn(me),J=new Ha,Q=new nr(me,Y,Z,J,X,de,q),K=new fn(f),$=new rn(me,X),pe=new un(me,Y,$,X),te=new yn(me,$,q,pe),ie=new Sn(me,te,$,q),ce=new wn(me),oe=new mn(J),ne=new ja(f,K,Y,X,pe,oe),ae=new cr(J),re=new Ya(J),se=new Ka(Y,X),le=new hn(f,K,Z,ie,o),he=new dn(me,Y,q,X),ue=new vn(me,Y,q,X),q.programs=ne.programs,f.capabilities=X,f.extensions=Y,f.properties=J,f.renderLists=re,f.state=Z,f.info=q}ve();const be=new lr(f,me);this.xr=be;const _e=new tr(f,ie,X.maxTextureSize);function xe(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),g=!0}function we(){console.log("THREE.WebGLRenderer: Context Restored."),g=!1,ve()}function Se(e){const t=e.target;t.removeEventListener("dispose",Se),function(e){Te(e),J.remove(e)}(t)}function Te(e){const t=J.get(e).program;void 0!==t&&ne.releaseProgram(t)}this.shadowMap=_e,this.getContext=function(){return me},this.getContextAttributes=function(){return me.getContextAttributes()},this.forceContextLoss=function(){const e=Y.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=Y.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return D},this.setPixelRatio=function(e){void 0!==e&&(D=e,this.setSize(R,O,!1))},this.getSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),e=new ye),e.set(R,O)},this.setSize=function(e,i,n){be.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(R=e,O=i,t.width=Math.floor(e*D),t.height=Math.floor(i*D),!1!==n&&(t.style.width=e+"px",t.style.height=i+"px"),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),e=new ye),e.set(R*D,O*D).floor()},this.setDrawingBufferSize=function(e,i,n){R=e,O=i,D=n,t.width=Math.floor(e*n),t.height=Math.floor(i*n),this.setViewport(0,0,e,i)},this.getCurrentViewport=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),e=new Me),e.copy(E)},this.getViewport=function(e){return e.copy(N)},this.setViewport=function(e,t,i,n){e.isVector4?N.set(e.x,e.y,e.z,e.w):N.set(e,t,i,n),Z.viewport(E.copy(N).multiplyScalar(D).floor())},this.getScissor=function(e){return e.copy(B)},this.setScissor=function(e,t,i,n){e.isVector4?B.set(e.x,e.y,e.z,e.w):B.set(e,t,i,n),Z.scissor(C.copy(B).multiplyScalar(D).floor())},this.getScissorTest=function(){return z},this.setScissorTest=function(e){Z.setScissorTest(z=e)},this.setOpaqueSort=function(e){L=e},this.setTransparentSort=function(e){k=e},this.getClearColor=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getClearColor() now requires a Color as an argument"),e=new Qt),e.copy(le.getClearColor())},this.setClearColor=function(){le.setClearColor.apply(le,arguments)},this.getClearAlpha=function(){return le.getClearAlpha()},this.setClearAlpha=function(){le.setClearAlpha.apply(le,arguments)},this.clear=function(e,t,i){let n=0;(void 0===e||e)&&(n|=16384),(void 0===t||t)&&(n|=256),(void 0===i||i)&&(n|=1024),me.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",xe,!1),t.removeEventListener("webglcontextrestored",we,!1),re.dispose(),se.dispose(),J.dispose(),K.dispose(),ie.dispose(),pe.dispose(),be.dispose(),Ee.stop()},this.renderBufferImmediate=function(e,t){pe.initAttributes();const i=J.get(e);e.hasPositions&&!i.position&&(i.position=me.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=me.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=me.createBuffer()),e.hasColors&&!i.color&&(i.color=me.createBuffer());const n=t.getAttributes();e.hasPositions&&(me.bindBuffer(34962,i.position),me.bufferData(34962,e.positionArray,35048),pe.enableAttribute(n.position),me.vertexAttribPointer(n.position,3,5126,!1,0,0)),e.hasNormals&&(me.bindBuffer(34962,i.normal),me.bufferData(34962,e.normalArray,35048),pe.enableAttribute(n.normal),me.vertexAttribPointer(n.normal,3,5126,!1,0,0)),e.hasUvs&&(me.bindBuffer(34962,i.uv),me.bufferData(34962,e.uvArray,35048),pe.enableAttribute(n.uv),me.vertexAttribPointer(n.uv,2,5126,!1,0,0)),e.hasColors&&(me.bindBuffer(34962,i.color),me.bufferData(34962,e.colorArray,35048),pe.enableAttribute(n.color),me.vertexAttribPointer(n.color,3,5126,!1,0,0)),pe.disableUnusedAttributes(),me.drawArrays(4,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,i,n,a,r){null===t&&(t=V);const s=a.isMesh&&a.matrixWorld.determinant()<0,o=De(e,t,n,a);Z.setMaterial(n,s);let l=i.index;const c=i.attributes.position;if(null===l){if(void 0===c||0===c.count)return}else if(0===l.count)return;let h,u=1;!0===n.wireframe&&(l=te.getWireframeAttribute(i),u=2),(n.morphTargets||n.morphNormals)&&ce.update(a,i,n,o),pe.setup(a,n,o,i,l);let d=he;null!==l&&(h=$.get(l),d=ue,d.setIndex(h));const p=null!==l?l.count:c.count,m=i.drawRange.start*u,f=i.drawRange.count*u,g=null!==r?r.start*u:0,y=null!==r?r.count*u:1/0,v=Math.max(m,g),b=Math.min(p,m+f,g+y)-1,_=Math.max(0,b-v+1);if(0!==_){if(a.isMesh)!0===n.wireframe?(Z.setLineWidth(n.wireframeLinewidth*W()),d.setMode(1)):d.setMode(4);else if(a.isLine){let e=n.linewidth;void 0===e&&(e=1),Z.setLineWidth(e*W()),a.isLineSegments?d.setMode(1):a.isLineLoop?d.setMode(2):d.setMode(3)}else a.isPoints?d.setMode(0):a.isSprite&&d.setMode(4);if(a.isInstancedMesh)d.renderInstances(v,_,a.count);else if(i.isInstancedBufferGeometry){const e=Math.min(i.instanceCount,i._maxInstanceCount);d.renderInstances(v,_,e)}else d.render(v,_)}},this.compile=function(e,t){d=se.get(e),d.init(),e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(d.pushLight(e),e.castShadow&&d.pushShadow(e))})),d.setupLights();const i=new WeakMap;e.traverse((function(t){const n=t.material;if(n)if(Array.isArray(n))for(let a=0;a<n.length;a++){const r=n[a];!1===i.has(r)&&(Oe(r,e,t),i.set(r))}else!1===i.has(n)&&(Oe(n,e,t),i.set(n))}))};let Ae=null;const Ee=new an;function Ie(e,t,i,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)d.pushLight(e),e.castShadow&&d.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||U.intersectsSprite(e)){n&&G.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);const t=ie.update(e),a=e.material;a.visible&&u.push(e,t,a,i,G.z,null)}}else if(e.isImmediateRenderObject)n&&G.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H),u.push(e,null,e.material,i,G.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==q.render.frame&&(e.skeleton.update(),e.skeleton.frame=q.render.frame),!e.frustumCulled||U.intersectsObject(e))){n&&G.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);const t=ie.update(e),a=e.material;if(Array.isArray(a)){const n=t.groups;for(let r=0,s=n.length;r<s;r++){const s=n[r],o=a[s.materialIndex];o&&o.visible&&u.push(e,t,o,i,G.z,s)}}else a.visible&&u.push(e,t,a,i,G.z,null)}const a=e.children;for(let e=0,r=a.length;e<r;e++)Ie(a[e],t,i,n)}function Pe(e,t,i){const n=!0===t.isScene?t.overrideMaterial:null;for(let a=0,r=e.length;a<r;a++){const r=e[a],s=r.object,o=r.geometry,l=null===n?r.material:n,c=r.group;if(i.isArrayCamera){const e=i.cameras;for(let i=0,n=e.length;i<n;i++){const n=e[i];s.layers.test(n.layers)&&(Z.viewport(E.copy(n.viewport)),d.setupLightsView(n),Re(s,t,n,o,l,c))}}else Re(s,t,i,o,l,c)}}function Re(e,t,i,n,a,r){if(e.onBeforeRender(f,t,i,n,a,r),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){const n=De(i,t,a,e);Z.setMaterial(a),pe.reset(),function(e,t){e.render((function(e){f.renderBufferImmediate(e,t)}))}(e,n)}else f.renderBufferDirect(i,t,n,a,e,r);e.onAfterRender(f,t,i,n,a,r)}function Oe(e,t,i){!0!==t.isScene&&(t=V);const n=J.get(e),a=d.state.lights,r=d.state.shadowsArray,s=a.state.version,o=ne.getParameters(e,a.state,r,t,i),l=ne.getProgramCacheKey(o);let c=n.program,h=!0;if(n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=K.get(e.envMap||n.environment),void 0===c)e.addEventListener("dispose",Se);else if(c.cacheKey!==l)Te(e);else if(n.lightsStateVersion!==s)h=!1;else{if(void 0!==o.shaderID)return;h=!1}h&&(o.uniforms=ne.getUniforms(e),e.onBeforeCompile(o,f),c=ne.acquireProgram(o,l),n.program=c,n.uniforms=o.uniforms,n.outputEncoding=o.outputEncoding);const u=n.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=oe.numPlanes,n.numIntersection=oe.numIntersection,u.clippingPlanes=oe.uniform),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=s,n.needsLights&&(u.ambientLightColor.value=a.state.ambient,u.lightProbe.value=a.state.probe,u.directionalLights.value=a.state.directional,u.directionalLightShadows.value=a.state.directionalShadow,u.spotLights.value=a.state.spot,u.spotLightShadows.value=a.state.spotShadow,u.rectAreaLights.value=a.state.rectArea,u.ltc_1.value=a.state.rectAreaLTC1,u.ltc_2.value=a.state.rectAreaLTC2,u.pointLights.value=a.state.point,u.pointLightShadows.value=a.state.pointShadow,u.hemisphereLights.value=a.state.hemi,u.directionalShadowMap.value=a.state.directionalShadowMap,u.directionalShadowMatrix.value=a.state.directionalShadowMatrix,u.spotShadowMap.value=a.state.spotShadowMap,u.spotShadowMatrix.value=a.state.spotShadowMatrix,u.pointShadowMap.value=a.state.pointShadowMap,u.pointShadowMatrix.value=a.state.pointShadowMatrix);const p=n.program.getUniforms(),m=_a.seqWithValue(p.seq,u);n.uniformsList=m}function De(e,t,i,n){!0!==t.isScene&&(t=V),Q.resetTextureUnits();const a=t.fog,r=i.isMeshStandardMaterial?t.environment:null,s=null===_?f.outputEncoding:_.texture.encoding,o=K.get(i.envMap||r),l=J.get(i),c=d.state.lights;if(!0===F&&(!0===j||e!==M)){const t=e===M&&i.id===S;oe.setState(i,e,t)}i.version===l.__version?i.fog&&l.fog!==a||l.environment!==r||l.needsLights&&l.lightsStateVersion!==c.state.version?Oe(i,t,n):void 0===l.numClippingPlanes||l.numClippingPlanes===oe.numPlanes&&l.numIntersection===oe.numIntersection?(l.outputEncoding!==s||l.envMap!==o)&&Oe(i,t,n):Oe(i,t,n):(Oe(i,t,n),l.__version=i.version);let h=!1,u=!1,p=!1;const m=l.program,g=m.getUniforms(),y=l.uniforms;if(Z.useProgram(m.program)&&(h=!0,u=!0,p=!0),i.id!==S&&(S=i.id,u=!0),h||M!==e){if(g.setValue(me,"projectionMatrix",e.projectionMatrix),X.logarithmicDepthBuffer&&g.setValue(me,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),M!==e&&(M=e,u=!0,p=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const t=g.map.cameraPosition;void 0!==t&&t.setValue(me,G.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&g.setValue(me,"isOrthographic",!0===e.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||i.skinning)&&g.setValue(me,"viewMatrix",e.matrixWorldInverse)}if(i.skinning){g.setOptional(me,n,"bindMatrix"),g.setOptional(me,n,"bindMatrixInverse");const e=n.skeleton;if(e){const t=e.bones;if(X.floatVertexTextures){if(null===e.boneTexture){let i=Math.sqrt(4*t.length);i=ge.ceilPowerOfTwo(i),i=Math.max(i,4);const n=new Float32Array(i*i*4);n.set(e.boneMatrices);const a=new $i(n,i,i,I,T);e.boneMatrices=n,e.boneTexture=a,e.boneTextureSize=i}g.setValue(me,"boneTexture",e.boneTexture,Q),g.setValue(me,"boneTextureSize",e.boneTextureSize)}else g.setOptional(me,e,"boneMatrices")}}var v,b;return(u||l.receiveShadow!==n.receiveShadow)&&(l.receiveShadow=n.receiveShadow,g.setValue(me,"receiveShadow",n.receiveShadow)),u&&(g.setValue(me,"toneMappingExposure",f.toneMappingExposure),l.needsLights&&(b=p,(v=y).ambientLightColor.needsUpdate=b,v.lightProbe.needsUpdate=b,v.directionalLights.needsUpdate=b,v.directionalLightShadows.needsUpdate=b,v.pointLights.needsUpdate=b,v.pointLightShadows.needsUpdate=b,v.spotLights.needsUpdate=b,v.spotLightShadows.needsUpdate=b,v.rectAreaLights.needsUpdate=b,v.hemisphereLights.needsUpdate=b),a&&i.fog&&ae.refreshFogUniforms(y,a),ae.refreshMaterialUniforms(y,i,D,O),_a.upload(me,l.uniformsList,y,Q)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(_a.upload(me,l.uniformsList,y,Q),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&g.setValue(me,"center",n.center),g.setValue(me,"modelViewMatrix",n.modelViewMatrix),g.setValue(me,"normalMatrix",n.normalMatrix),g.setValue(me,"modelMatrix",n.matrixWorld),m}Ee.setAnimationLoop((function(e){be.isPresenting||Ae&&Ae(e)})),"undefined"!=typeof window&&Ee.setContext(window),this.setAnimationLoop=function(e){Ae=e,be.setAnimationLoop(e),null===e?Ee.stop():Ee.start()},this.render=function(e,t){let i,n;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),i=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),n=arguments[3]),void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===g)return;pe.resetDefaultState(),S=-1,M=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===be.enabled&&!0===be.isPresenting&&(t=be.getCamera(t)),!0===e.isScene&&e.onBeforeRender(f,e,t,i||_),d=se.get(e,m.length),d.init(),m.push(d),H.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),U.setFromProjectionMatrix(H),j=this.localClippingEnabled,F=oe.init(this.clippingPlanes,j,t),u=re.get(e,p.length),u.init(),p.push(u),Ie(e,t,0,f.sortObjects),u.finish(),!0===f.sortObjects&&u.sort(L,k),!0===F&&oe.beginShadows();const a=d.state.shadowsArray;_e.render(a,e,t),d.setupLights(),d.setupLightsView(t),!0===F&&oe.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==i&&this.setRenderTarget(i),le.render(u,e,t,n);const r=u.opaque,s=u.transparent;r.length>0&&Pe(r,e,t),s.length>0&&Pe(s,e,t),!0===e.isScene&&e.onAfterRender(f,e,t),null!==_&&(Q.updateRenderTargetMipmap(_),Q.updateMultisampleRenderTarget(_)),Z.buffers.depth.setTest(!0),Z.buffers.depth.setMask(!0),Z.buffers.color.setMask(!0),Z.setPolygonOffset(!1),m.pop(),d=m.length>0?m[m.length-1]:null,p.pop(),u=p.length>0?p[p.length-1]:null},this.setFramebuffer=function(e){y!==e&&null===_&&me.bindFramebuffer(36160,e),y=e},this.getActiveCubeFace=function(){return v},this.getActiveMipmapLevel=function(){return b},this.getRenderTarget=function(){return _},this.setRenderTarget=function(e,t=0,i=0){_=e,v=t,b=i,e&&void 0===J.get(e).__webglFramebuffer&&Q.setupRenderTarget(e);let n=y,a=!1,r=!1;if(e){const i=e.texture;(i.isDataTexture3D||i.isDataTexture2DArray)&&(r=!0);const s=J.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=s[t],a=!0):n=e.isWebGLMultisampleRenderTarget?J.get(e).__webglMultisampledFramebuffer:s,E.copy(e.viewport),C.copy(e.scissor),P=e.scissorTest}else E.copy(N).multiplyScalar(D).floor(),C.copy(B).multiplyScalar(D).floor(),P=z;if(x!==n&&(me.bindFramebuffer(36160,n),x=n),Z.viewport(E),Z.scissor(C),Z.setScissorTest(P),a){const n=J.get(e.texture);me.framebufferTexture2D(36160,36064,34069+t,n.__webglTexture,i)}else if(r){const n=J.get(e.texture),a=t||0;me.framebufferTextureLayer(36160,36064,n.__webglTexture,i||0,a)}},this.readRenderTargetPixels=function(e,t,i,n,a,r,s){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=J.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==s&&(o=o[s]),o){let s=!1;o!==x&&(me.bindFramebuffer(36160,o),s=!0);try{const o=e.texture,l=o.format,c=o.type;if(l!==I&&de.convert(l)!==me.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const h=c===A&&(Y.has("EXT_color_buffer_half_float")||X.isWebGL2&&Y.has("EXT_color_buffer_float"));if(!(c===w||de.convert(c)===me.getParameter(35738)||c===T&&(X.isWebGL2||Y.has("OES_texture_float")||Y.has("WEBGL_color_buffer_float"))||h))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");36053===me.checkFramebufferStatus(36160)?t>=0&&t<=e.width-n&&i>=0&&i<=e.height-a&&me.readPixels(t,i,n,a,de.convert(l),de.convert(c),r):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&me.bindFramebuffer(36160,x)}}},this.copyFramebufferToTexture=function(e,t,i=0){const n=Math.pow(2,-i),a=Math.floor(t.image.width*n),r=Math.floor(t.image.height*n),s=de.convert(t.format);Q.setTexture2D(t,0),me.copyTexImage2D(3553,i,s,e.x,e.y,a,r,0),Z.unbindTexture()},this.copyTextureToTexture=function(e,t,i,n=0){const a=t.image.width,r=t.image.height,s=de.convert(i.format),o=de.convert(i.type);Q.setTexture2D(i,0),me.pixelStorei(37440,i.flipY),me.pixelStorei(37441,i.premultiplyAlpha),me.pixelStorei(3317,i.unpackAlignment),t.isDataTexture?me.texSubImage2D(3553,n,e.x,e.y,a,r,s,o,t.image.data):t.isCompressedTexture?me.compressedTexSubImage2D(3553,n,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,s,t.mipmaps[0].data):me.texSubImage2D(3553,n,e.x,e.y,s,o,t.image),0===n&&i.generateMipmaps&&me.generateMipmap(3553),Z.unbindTexture()},this.copyTextureToTexture3D=function(e,t,i,n,a=0){if(f.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const{width:r,height:s,data:o}=i.image,l=de.convert(n.format),c=de.convert(n.type);let h;if(n.isDataTexture3D)Q.setTexture3D(n,0),h=32879;else{if(!n.isDataTexture2DArray)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");Q.setTexture2DArray(n,0),h=35866}me.pixelStorei(37440,n.flipY),me.pixelStorei(37441,n.premultiplyAlpha),me.pixelStorei(3317,n.unpackAlignment);const u=me.getParameter(3314),d=me.getParameter(32878),p=me.getParameter(3316),m=me.getParameter(3315),g=me.getParameter(32877);me.pixelStorei(3314,r),me.pixelStorei(32878,s),me.pixelStorei(3316,e.min.x),me.pixelStorei(3315,e.min.y),me.pixelStorei(32877,e.min.z),me.texSubImage3D(h,a,t.x,t.y,t.z,e.max.x-e.min.x+1,e.max.y-e.min.y+1,e.max.z-e.min.z+1,l,c,o),me.pixelStorei(3314,u),me.pixelStorei(32878,d),me.pixelStorei(3316,p),me.pixelStorei(3315,m),me.pixelStorei(32877,g),0===a&&n.generateMipmaps&&me.generateMipmap(h),Z.unbindTexture()},this.initTexture=function(e){Q.setTexture2D(e,0),Z.unbindTexture()},this.resetState=function(){Z.reset(),pe.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}sr.prototype.isGroup=!0,Object.assign(or.prototype,{constructor:or,getHandSpace:function(){return null===this._hand&&(this._hand=new sr,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand},getTargetRaySpace:function(){return null===this._targetRay&&(this._targetRay=new sr,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return null===this._grip&&(this._grip=new sr,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this},disconnect:function(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this},update:function(e,t,i){let n=null,a=null,r=null;const s=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState)if(l&&e.hand){r=!0;for(const n of e.hand.values()){const e=t.getJointPose(n,i);if(void 0===l.joints[n.jointName]){const e=new sr;e.matrixAutoUpdate=!1,e.visible=!1,l.joints[n.jointName]=e,l.add(e)}const a=l.joints[n.jointName];null!==e&&(a.matrix.fromArray(e.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.jointRadius=e.radius),a.visible=null!==e}const n=l.joints["index-finger-tip"],a=l.joints["thumb-tip"],s=n.position.distanceTo(a.position),o=.02,c=.005;l.inputState.pinching&&s>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&s<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==s&&(n=t.getPose(e.targetRaySpace,i),null!==n&&(s.matrix.fromArray(n.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale))),null!==o&&e.gripSpace&&(a=t.getPose(e.gripSpace,i),null!==a&&(o.matrix.fromArray(a.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale)));return null!==s&&(s.visible=null!==n),null!==o&&(o.visible=null!==a),null!==l&&(l.visible=null!==r),this}}),Object.assign(lr.prototype,pe.prototype);class ur extends hr{}ur.prototype.isWebGL1Renderer=!0;class dr{constructor(e,t){this.name="",this.color=new Qt(e),this.density=void 0!==t?t:25e-5}clone(){return new dr(this.color,this.density)}toJSON(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}dr.prototype.isFogExp2=!0;class pr{constructor(e,t,i){this.name="",this.color=new Qt(e),this.near=void 0!==t?t:1,this.far=void 0!==i?i:1e3}clone(){return new pr(this.color,this.near,this.far)}toJSON(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}pr.prototype.isFog=!0;class mr extends Et{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.environment&&(t.object.environment=this.environment.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}function fr(e,t){this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=he,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=ge.generateUUID()}mr.prototype.isScene=!0,Object.defineProperty(fr.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(fr.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setUsage:function(e){return this.usage=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this},copyAt:function(e,t,i){e*=this.stride,i*=t.stride;for(let n=0,a=this.stride;n<a;n++)this.array[e+n]=t.array[i+n];return this},set:function(e,t=0){return this.array.set(e,t),this},clone:function(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ge.generateUUID()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new fr(new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),this.stride);return t.setUsage(this.usage),t},onUpload:function(e){return this.onUploadCallback=e,this},toJSON:function(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ge.generateUUID()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}});const gr=new Ce;function yr(e,t,i,n){this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=!0===n}Object.defineProperties(yr.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}},needsUpdate:{set:function(e){this.data.needsUpdate=e}}}),Object.assign(yr.prototype,{isInterleavedBufferAttribute:!0,applyMatrix4:function(e){for(let t=0,i=this.data.count;t<i;t++)gr.x=this.getX(t),gr.y=this.getY(t),gr.z=this.getZ(t),gr.applyMatrix4(e),this.setXYZ(t,gr.x,gr.y,gr.z);return this},setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this},setXYZ:function(e,t,i,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this},setXYZW:function(e,t,i,n,a){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this.data.array[e+3]=a,this},clone:function(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new ti(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new yr(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)},toJSON:function(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}});class vr extends Vt{constructor(e){super(),this.type="SpriteMaterial",this.color=new Qt(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this}}let br;vr.prototype.isSpriteMaterial=!0;const _r=new Ce,xr=new Ce,wr=new Ce,Sr=new ye,Mr=new ye,Tr=new it,Ar=new Ce,Er=new Ce,Cr=new Ce,Ir=new ye,Pr=new ye,Rr=new ye;class Or extends Et{constructor(e){if(super(),this.type="Sprite",void 0===br){br=new wi;const e=new fr(new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),5);br.setIndex([0,1,2,0,2,3]),br.setAttribute("position",new yr(e,3,0,!1)),br.setAttribute("uv",new yr(e,2,3,!1))}this.geometry=br,this.material=void 0!==e?e:new vr,this.center=new ye(.5,.5)}raycast(e,t){null===e.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),xr.setFromMatrixScale(this.matrixWorld),Tr.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),wr.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&xr.multiplyScalar(-wr.z);const i=this.material.rotation;let n,a;0!==i&&(a=Math.cos(i),n=Math.sin(i));const r=this.center;Dr(Ar.set(-.5,-.5,0),wr,r,xr,n,a),Dr(Er.set(.5,-.5,0),wr,r,xr,n,a),Dr(Cr.set(.5,.5,0),wr,r,xr,n,a),Ir.set(0,0),Pr.set(1,0),Rr.set(1,1);let s=e.ray.intersectTriangle(Ar,Er,Cr,!1,_r);if(null===s&&(Dr(Er.set(-.5,.5,0),wr,r,xr,n,a),Pr.set(0,1),s=e.ray.intersectTriangle(Ar,Cr,Er,!1,_r),null===s))return;const o=e.ray.origin.distanceTo(_r);o<e.near||o>e.far||t.push({distance:o,point:_r.clone(),uv:Ht.getUV(_r,Ar,Er,Cr,Ir,Pr,Rr,new ye),face:null,object:this})}copy(e){return super.copy(e),void 0!==e.center&&this.center.copy(e.center),this.material=e.material,this}}function Dr(e,t,i,n,a,r){Sr.subVectors(e,i).addScalar(.5).multiply(n),void 0!==a?(Mr.x=r*Sr.x-a*Sr.y,Mr.y=a*Sr.x+r*Sr.y):Mr.copy(Sr),e.copy(t),e.x+=Mr.x,e.y+=Mr.y,e.applyMatrix4(Tr)}Or.prototype.isSprite=!0;const Lr=new Ce,kr=new Ce;class Nr extends Et{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(e){super.copy(e,!1);const t=e.levels;for(let e=0,i=t.length;e<i;e++){const i=t[e];this.addLevel(i.object.clone(),i.distance)}return this.autoUpdate=e.autoUpdate,this}addLevel(e,t=0){t=Math.abs(t);const i=this.levels;let n;for(n=0;n<i.length&&!(t<i[n].distance);n++);return i.splice(n,0,{distance:t,object:e}),this.add(e),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(e){const t=this.levels;if(t.length>0){let i,n;for(i=1,n=t.length;i<n&&!(e<t[i].distance);i++);return t[i-1].object}return null}raycast(e,t){if(this.levels.length>0){Lr.setFromMatrixPosition(this.matrixWorld);const i=e.ray.origin.distanceTo(Lr);this.getObjectForDistance(i).raycast(e,t)}}update(e){const t=this.levels;if(t.length>1){Lr.setFromMatrixPosition(e.matrixWorld),kr.setFromMatrixPosition(this.matrixWorld);const i=Lr.distanceTo(kr)/e.zoom;let n,a;for(t[0].object.visible=!0,n=1,a=t.length;n<a&&i>=t[n].distance;n++)t[n-1].object.visible=!1,t[n].object.visible=!0;for(this._currentLevel=n-1;n<a;n++)t[n].object.visible=!1}}toJSON(e){const t=super.toJSON(e);!1===this.autoUpdate&&(t.object.autoUpdate=!1),t.object.levels=[];const i=this.levels;for(let e=0,n=i.length;e<n;e++){const n=i[e];t.object.levels.push({object:n.object.uuid,distance:n.distance})}return t}}const Br=new Ce,zr=new Me,Ur=new Me,Fr=new Ce,jr=new it;function Hr(e,t){Fi.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new it,this.bindMatrixInverse=new it}function Gr(){Et.call(this),this.type="Bone"}Hr.prototype=Object.assign(Object.create(Fi.prototype),{constructor:Hr,isSkinnedMesh:!0,copy:function(e){return Fi.prototype.copy.call(this,e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){const e=new Me,t=this.geometry.attributes.skinWeight;for(let i=0,n=t.count;i<n;i++){e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.w=t.getW(i);const n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}},updateMatrixWorld:function(e){Fi.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},boneTransform:function(e,t){const i=this.skeleton,n=this.geometry;zr.fromBufferAttribute(n.attributes.skinIndex,e),Ur.fromBufferAttribute(n.attributes.skinWeight,e),Br.fromBufferAttribute(n.attributes.position,e).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const n=Ur.getComponent(e);if(0!==n){const a=zr.getComponent(e);jr.multiplyMatrices(i.bones[a].matrixWorld,i.boneInverses[a]),t.addScaledVector(Fr.copy(Br).applyMatrix4(jr),n)}}return t.applyMatrix4(this.bindMatrixInverse)}}),Gr.prototype=Object.assign(Object.create(Et.prototype),{constructor:Gr,isBone:!0});const Vr=new it,Wr=new it;class Yr{constructor(e=[],t=[]){this.uuid=ge.generateUUID(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new it)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new it;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let n=0,a=e.length;n<a;n++){const a=e[n]?e[n].matrixWorld:Wr;Vr.multiplyMatrices(a,t[n]),Vr.toArray(i,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new Yr(this.bones,this.boneInverses)}getBoneByName(e){for(let t=0,i=this.bones.length;t<i;t++){const i=this.bones[t];if(i.name===e)return i}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let i=0,n=e.bones.length;i<n;i++){const n=e.bones[i];let a=t[n];void 0===a&&(console.warn("THREE.Skeleton: No bone found with UUID:",n),a=new Gr),this.bones.push(a),this.boneInverses.push((new it).fromArray(e.boneInverses[i]))}return this.init(),this}toJSON(){const e={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,i=this.boneInverses;for(let n=0,a=t.length;n<a;n++){const a=t[n];e.bones.push(a.uuid);const r=i[n];e.boneInverses.push(r.toArray())}return e}}const Xr=new it,Zr=new it,qr=[],Jr=new Fi;function Qr(e,t,i){Fi.call(this,e,t),this.instanceMatrix=new ti(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.frustumCulled=!1}Qr.prototype=Object.assign(Object.create(Fi.prototype),{constructor:Qr,isInstancedMesh:!0,copy:function(e){return Fi.prototype.copy.call(this,e),this.instanceMatrix.copy(e.instanceMatrix),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,this},getColorAt:function(e,t){t.fromArray(this.instanceColor.array,3*e)},getMatrixAt:function(e,t){t.fromArray(this.instanceMatrix.array,16*e)},raycast:function(e,t){const i=this.matrixWorld,n=this.count;if(Jr.geometry=this.geometry,Jr.material=this.material,void 0!==Jr.material)for(let a=0;a<n;a++){this.getMatrixAt(a,Xr),Zr.multiplyMatrices(i,Xr),Jr.matrixWorld=Zr,Jr.raycast(e,qr);for(let e=0,i=qr.length;e<i;e++){const i=qr[e];i.instanceId=a,i.object=this,t.push(i)}qr.length=0}},setColorAt:function(e,t){null===this.instanceColor&&(this.instanceColor=new ti(new Float32Array(3*this.count),3)),t.toArray(this.instanceColor.array,3*e)},setMatrixAt:function(e,t){t.toArray(this.instanceMatrix.array,16*e)},updateMorphTargets:function(){},dispose:function(){this.dispatchEvent({type:"dispose"})}});class Kr extends Vt{constructor(e){super(),this.type="LineBasicMaterial",this.color=new Qt(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.morphTargets=e.morphTargets,this}}Kr.prototype.isLineBasicMaterial=!0;const $r=new Ce,es=new Ce,ts=new it,is=new tt,ns=new Xe;function as(e=new wi,t=new Kr){Et.call(this),this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}as.prototype=Object.assign(Object.create(Et.prototype),{constructor:as,isLine:!0,copy:function(e){return Et.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry)if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,n=t.count;e<n;e++)$r.fromBufferAttribute(t,e-1),es.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=$r.distanceTo(es);e.setAttribute("lineDistance",new hi(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this},raycast:function(e,t){const i=this.geometry,n=this.matrixWorld,a=e.params.Line.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),ns.copy(i.boundingSphere),ns.applyMatrix4(n),ns.radius+=a,!1===e.ray.intersectsSphere(ns))return;ts.copy(n).invert(),is.copy(e.ray).applyMatrix4(ts);const r=a/((this.scale.x+this.scale.y+this.scale.z)/3),s=r*r,o=new Ce,l=new Ce,c=new Ce,h=new Ce,u=this.isLineSegments?2:1;if(i.isBufferGeometry){const n=i.index,a=i.attributes.position;if(null!==n){const i=n.array;for(let n=0,r=i.length-1;n<r;n+=u){const r=i[n],u=i[n+1];o.fromBufferAttribute(a,r),l.fromBufferAttribute(a,u);if(is.distanceSqToSegment(o,l,h,c)>s)continue;h.applyMatrix4(this.matrixWorld);const d=e.ray.origin.distanceTo(h);d<e.near||d>e.far||t.push({distance:d,point:c.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else for(let i=0,n=a.count-1;i<n;i+=u){o.fromBufferAttribute(a,i),l.fromBufferAttribute(a,i+1);if(is.distanceSqToSegment(o,l,h,c)>s)continue;h.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(h);n<e.near||n>e.far||t.push({distance:n,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else i.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const rs=new Ce,ss=new Ce;function os(e,t){as.call(this,e,t),this.type="LineSegments"}os.prototype=Object.assign(Object.create(as.prototype),{constructor:os,isLineSegments:!0,computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry)if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,n=t.count;e<n;e+=2)rs.fromBufferAttribute(t,e),ss.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+rs.distanceTo(ss);e.setAttribute("lineDistance",new hi(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}});class ls extends as{constructor(e,t){super(e,t),this.type="LineLoop"}}ls.prototype.isLineLoop=!0;class cs extends Vt{constructor(e){super(),this.type="PointsMaterial",this.color=new Qt(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.morphTargets=e.morphTargets,this}}cs.prototype.isPointsMaterial=!0;const hs=new it,us=new tt,ds=new Xe,ps=new Ce;function ms(e=new wi,t=new cs){Et.call(this),this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}function fs(e,t,i,n,a,r,s){const o=us.distanceSqToPoint(e);if(o<i){const i=new Ce;us.closestPointToPoint(e,i),i.applyMatrix4(n);const l=a.ray.origin.distanceTo(i);if(l<a.near||l>a.far)return;r.push({distance:l,distanceToRay:Math.sqrt(o),point:i,index:t,face:null,object:s})}}ms.prototype=Object.assign(Object.create(Et.prototype),{constructor:ms,isPoints:!0,copy:function(e){return Et.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},raycast:function(e,t){const i=this.geometry,n=this.matrixWorld,a=e.params.Points.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),ds.copy(i.boundingSphere),ds.applyMatrix4(n),ds.radius+=a,!1===e.ray.intersectsSphere(ds))return;hs.copy(n).invert(),us.copy(e.ray).applyMatrix4(hs);const r=a/((this.scale.x+this.scale.y+this.scale.z)/3),s=r*r;if(i.isBufferGeometry){const a=i.index,r=i.attributes.position;if(null!==a){const i=a.array;for(let a=0,o=i.length;a<o;a++){const o=i[a];ps.fromBufferAttribute(r,o),fs(ps,o,s,n,e,t,this)}}else for(let i=0,a=r.count;i<a;i++)ps.fromBufferAttribute(r,i),fs(ps,i,s,n,e,t,this)}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});class gs extends we{constructor(e,t,i,n,a,r,s,o,l){super(e,t,i,n,a,r,s,o,l),this.format=void 0!==s?s:C,this.minFilter=void 0!==r?r:b,this.magFilter=void 0!==a?a:b,this.generateMipmaps=!1;const c=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback((function t(){c.needsUpdate=!0,e.requestVideoFrameCallback(t)}))}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;!1==="requestVideoFrameCallback"in e&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}gs.prototype.isVideoTexture=!0;class ys extends we{constructor(e,t,i,n,a,r,s,o,l,c,h,u){super(null,r,s,o,l,c,n,a,h,u),this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}ys.prototype.isCompressedTexture=!0;class vs extends we{constructor(e,t,i,n,a,r,s,o,l){super(e,t,i,n,a,r,s,o,l),this.needsUpdate=!0}}vs.prototype.isCanvasTexture=!0;class bs extends we{constructor(e,t,i,n,a,r,s,o,l,c){if((c=void 0!==c?c:R)!==R&&c!==O)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&c===R&&(i=S),void 0===i&&c===O&&(i=E),super(null,n,a,r,s,o,c,i,l),this.image={width:e,height:t},this.magFilter=void 0!==s?s:g,this.minFilter=void 0!==o?o:g,this.flipY=!1,this.generateMipmaps=!1}}bs.prototype.isDepthTexture=!0;class _s extends wi{constructor(e=1,t=8,i=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:n},t=Math.max(3,t);const a=[],r=[],s=[],o=[],l=new Ce,c=new ye;r.push(0,0,0),s.push(0,0,1),o.push(.5,.5);for(let a=0,h=3;a<=t;a++,h+=3){const u=i+a/t*n;l.x=e*Math.cos(u),l.y=e*Math.sin(u),r.push(l.x,l.y,l.z),s.push(0,0,1),c.x=(r[h]/e+1)/2,c.y=(r[h+1]/e+1)/2,o.push(c.x,c.y)}for(let e=1;e<=t;e++)a.push(e,e+1,0);this.setIndex(a),this.setAttribute("position",new hi(r,3)),this.setAttribute("normal",new hi(s,3)),this.setAttribute("uv",new hi(o,2))}}class xs extends wi{constructor(e=1,t=1,i=1,n=8,a=1,r=!1,s=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:n,heightSegments:a,openEnded:r,thetaStart:s,thetaLength:o};const l=this;n=Math.floor(n),a=Math.floor(a);const c=[],h=[],u=[],d=[];let p=0;const m=[],f=i/2;let g=0;function y(i){const a=p,r=new ye,m=new Ce;let y=0;const v=!0===i?e:t,b=!0===i?1:-1;for(let e=1;e<=n;e++)h.push(0,f*b,0),u.push(0,b,0),d.push(.5,.5),p++;const _=p;for(let e=0;e<=n;e++){const t=e/n*o+s,i=Math.cos(t),a=Math.sin(t);m.x=v*a,m.y=f*b,m.z=v*i,h.push(m.x,m.y,m.z),u.push(0,b,0),r.x=.5*i+.5,r.y=.5*a*b+.5,d.push(r.x,r.y),p++}for(let e=0;e<n;e++){const t=a+e,n=_+e;!0===i?c.push(n,n+1,t):c.push(n+1,n,t),y+=3}l.addGroup(g,y,!0===i?1:2),g+=y}!function(){const r=new Ce,y=new Ce;let v=0;const b=(t-e)/i;for(let l=0;l<=a;l++){const c=[],g=l/a,v=g*(t-e)+e;for(let e=0;e<=n;e++){const t=e/n,a=t*o+s,l=Math.sin(a),m=Math.cos(a);y.x=v*l,y.y=-g*i+f,y.z=v*m,h.push(y.x,y.y,y.z),r.set(l,b,m).normalize(),u.push(r.x,r.y,r.z),d.push(t,1-g),c.push(p++)}m.push(c)}for(let e=0;e<n;e++)for(let t=0;t<a;t++){const i=m[t][e],n=m[t+1][e],a=m[t+1][e+1],r=m[t][e+1];c.push(i,n,r),c.push(n,a,r),v+=6}l.addGroup(g,v,0),g+=v}(),!1===r&&(e>0&&y(!0),t>0&&y(!1)),this.setIndex(c),this.setAttribute("position",new hi(h,3)),this.setAttribute("normal",new hi(u,3)),this.setAttribute("uv",new hi(d,2))}}class ws extends xs{constructor(e=1,t=1,i=8,n=1,a=!1,r=0,s=2*Math.PI){super(0,e,t,i,n,a,r,s),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:n,openEnded:a,thetaStart:r,thetaLength:s}}}class Ss extends wi{constructor(e,t,i=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:n};const a=[],r=[];function s(e,t,i,n){const a=n+1,r=[];for(let n=0;n<=a;n++){r[n]=[];const s=e.clone().lerp(i,n/a),o=t.clone().lerp(i,n/a),l=a-n;for(let e=0;e<=l;e++)r[n][e]=0===e&&n===a?s:s.clone().lerp(o,e/l)}for(let e=0;e<a;e++)for(let t=0;t<2*(a-e)-1;t++){const i=Math.floor(t/2);t%2==0?(o(r[e][i+1]),o(r[e+1][i]),o(r[e][i])):(o(r[e][i+1]),o(r[e+1][i+1]),o(r[e+1][i]))}}function o(e){a.push(e.x,e.y,e.z)}function l(t,i){const n=3*t;i.x=e[n+0],i.y=e[n+1],i.z=e[n+2]}function c(e,t,i,n){n<0&&1===e.x&&(r[t]=e.x-1),0===i.x&&0===i.z&&(r[t]=n/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}!function(e){const i=new Ce,n=new Ce,a=new Ce;for(let r=0;r<t.length;r+=3)l(t[r+0],i),l(t[r+1],n),l(t[r+2],a),s(i,n,a,e)}(n),function(e){const t=new Ce;for(let i=0;i<a.length;i+=3)t.x=a[i+0],t.y=a[i+1],t.z=a[i+2],t.normalize().multiplyScalar(e),a[i+0]=t.x,a[i+1]=t.y,a[i+2]=t.z}(i),function(){const e=new Ce;for(let i=0;i<a.length;i+=3){e.x=a[i+0],e.y=a[i+1],e.z=a[i+2];const n=h(e)/2/Math.PI+.5,s=(t=e,Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5);r.push(n,1-s)}var t;(function(){const e=new Ce,t=new Ce,i=new Ce,n=new Ce,s=new ye,o=new ye,l=new ye;for(let u=0,d=0;u<a.length;u+=9,d+=6){e.set(a[u+0],a[u+1],a[u+2]),t.set(a[u+3],a[u+4],a[u+5]),i.set(a[u+6],a[u+7],a[u+8]),s.set(r[d+0],r[d+1]),o.set(r[d+2],r[d+3]),l.set(r[d+4],r[d+5]),n.copy(e).add(t).add(i).divideScalar(3);const p=h(n);c(s,d+0,e,p),c(o,d+2,t,p),c(l,d+4,i,p)}})(),function(){for(let e=0;e<r.length;e+=6){const t=r[e+0],i=r[e+2],n=r[e+4],a=Math.max(t,i,n),s=Math.min(t,i,n);a>.9&&s<.1&&(t<.2&&(r[e+0]+=1),i<.2&&(r[e+2]+=1),n<.2&&(r[e+4]+=1))}}()}(),this.setAttribute("position",new hi(a,3)),this.setAttribute("normal",new hi(a.slice(),3)),this.setAttribute("uv",new hi(r,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}}class Ms extends Ss{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2,n=1/i;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}}const Ts=new Ce,As=new Ce,Es=new Ce,Cs=new Ht;class Is extends wi{constructor(e,t){if(super(),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1,!0===e.isGeometry)return void console.error("THREE.EdgesGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const i=Math.pow(10,4),n=Math.cos(ge.DEG2RAD*t),a=e.getIndex(),r=e.getAttribute("position"),s=a?a.count:r.count,o=[0,0,0],l=["a","b","c"],c=new Array(3),h={},u=[];for(let e=0;e<s;e+=3){a?(o[0]=a.getX(e),o[1]=a.getX(e+1),o[2]=a.getX(e+2)):(o[0]=e,o[1]=e+1,o[2]=e+2);const{a:t,b:s,c:d}=Cs;if(t.fromBufferAttribute(r,o[0]),s.fromBufferAttribute(r,o[1]),d.fromBufferAttribute(r,o[2]),Cs.getNormal(Es),c[0]=`${Math.round(t.x*i)},${Math.round(t.y*i)},${Math.round(t.z*i)}`,c[1]=`${Math.round(s.x*i)},${Math.round(s.y*i)},${Math.round(s.z*i)}`,c[2]=`${Math.round(d.x*i)},${Math.round(d.y*i)},${Math.round(d.z*i)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let e=0;e<3;e++){const t=(e+1)%3,i=c[e],a=c[t],r=Cs[l[e]],s=Cs[l[t]],d=`${i}_${a}`,p=`${a}_${i}`;p in h&&h[p]?(Es.dot(h[p].normal)<=n&&(u.push(r.x,r.y,r.z),u.push(s.x,s.y,s.z)),h[p]=null):d in h||(h[d]={index0:o[e],index1:o[t],normal:Es.clone()})}}for(const e in h)if(h[e]){const{index0:t,index1:i}=h[e];Ts.fromBufferAttribute(r,t),As.fromBufferAttribute(r,i),u.push(Ts.x,Ts.y,Ts.z),u.push(As.x,As.y,As.z)}this.setAttribute("position",new hi(u,3))}}const Ps=function(e,t,i){i=i||2;const n=t&&t.length,a=n?t[0]*i:e.length;let r=Rs(e,0,a,i,!0);const s=[];if(!r||r.next===r.prev)return s;let o,l,c,h,u,d,p;if(n&&(r=function(e,t,i,n){const a=[];let r,s,o,l,c;for(r=0,s=t.length;r<s;r++)o=t[r]*n,l=r<s-1?t[r+1]*n:e.length,c=Rs(e,o,l,n,!1),c===c.next&&(c.steiner=!0),a.push(Hs(c));for(a.sort(zs),r=0;r<a.length;r++)Us(a[r],i),i=Os(i,i.next);return i}(e,t,r,i)),e.length>80*i){o=c=e[0],l=h=e[1];for(let t=i;t<a;t+=i)u=e[t],d=e[t+1],u<o&&(o=u),d<l&&(l=d),u>c&&(c=u),d>h&&(h=d);p=Math.max(c-o,h-l),p=0!==p?1/p:0}return Ds(r,s,i,o,l,p),s};function Rs(e,t,i,n,a){let r,s;if(a===function(e,t,i,n){let a=0;for(let r=t,s=i-n;r<i;r+=n)a+=(e[s]-e[r])*(e[r+1]+e[s+1]),s=r;return a}(e,t,i,n)>0)for(r=t;r<i;r+=n)s=Ks(r,e[r],e[r+1],s);else for(r=i-n;r>=t;r-=n)s=Ks(r,e[r],e[r+1],s);return s&&Ys(s,s.next)&&($s(s),s=s.next),s}function Os(e,t){if(!e)return e;t||(t=e);let i,n=e;do{if(i=!1,n.steiner||!Ys(n,n.next)&&0!==Ws(n.prev,n,n.next))n=n.next;else{if($s(n),n=t=n.prev,n===n.next)break;i=!0}}while(i||n!==t);return t}function Ds(e,t,i,n,a,r,s){if(!e)return;!s&&r&&function(e,t,i,n){let a=e;do{null===a.z&&(a.z=js(a.x,a.y,t,i,n)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,function(e){let t,i,n,a,r,s,o,l,c=1;do{for(i=e,e=null,r=null,s=0;i;){for(s++,n=i,o=0,t=0;t<c&&(o++,n=n.nextZ,n);t++);for(l=c;o>0||l>0&&n;)0!==o&&(0===l||!n||i.z<=n.z)?(a=i,i=i.nextZ,o--):(a=n,n=n.nextZ,l--),r?r.nextZ=a:e=a,a.prevZ=r,r=a;i=n}r.nextZ=null,c*=2}while(s>1)}(a)}(e,n,a,r);let o,l,c=e;for(;e.prev!==e.next;)if(o=e.prev,l=e.next,r?ks(e,n,a,r):Ls(e))t.push(o.i/i),t.push(e.i/i),t.push(l.i/i),$s(e),e=l.next,c=l.next;else if((e=l)===c){s?1===s?Ds(e=Ns(Os(e),t,i),t,i,n,a,r,2):2===s&&Bs(e,t,i,n,a,r):Ds(Os(e),t,i,n,a,r,1);break}}function Ls(e){const t=e.prev,i=e,n=e.next;if(Ws(t,i,n)>=0)return!1;let a=e.next.next;for(;a!==e.prev;){if(Gs(t.x,t.y,i.x,i.y,n.x,n.y,a.x,a.y)&&Ws(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function ks(e,t,i,n){const a=e.prev,r=e,s=e.next;if(Ws(a,r,s)>=0)return!1;const o=a.x<r.x?a.x<s.x?a.x:s.x:r.x<s.x?r.x:s.x,l=a.y<r.y?a.y<s.y?a.y:s.y:r.y<s.y?r.y:s.y,c=a.x>r.x?a.x>s.x?a.x:s.x:r.x>s.x?r.x:s.x,h=a.y>r.y?a.y>s.y?a.y:s.y:r.y>s.y?r.y:s.y,u=js(o,l,t,i,n),d=js(c,h,t,i,n);let p=e.prevZ,m=e.nextZ;for(;p&&p.z>=u&&m&&m.z<=d;){if(p!==e.prev&&p!==e.next&&Gs(a.x,a.y,r.x,r.y,s.x,s.y,p.x,p.y)&&Ws(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,m!==e.prev&&m!==e.next&&Gs(a.x,a.y,r.x,r.y,s.x,s.y,m.x,m.y)&&Ws(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;p&&p.z>=u;){if(p!==e.prev&&p!==e.next&&Gs(a.x,a.y,r.x,r.y,s.x,s.y,p.x,p.y)&&Ws(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;m&&m.z<=d;){if(m!==e.prev&&m!==e.next&&Gs(a.x,a.y,r.x,r.y,s.x,s.y,m.x,m.y)&&Ws(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function Ns(e,t,i){let n=e;do{const a=n.prev,r=n.next.next;!Ys(a,r)&&Xs(a,n,n.next,r)&&Js(a,r)&&Js(r,a)&&(t.push(a.i/i),t.push(n.i/i),t.push(r.i/i),$s(n),$s(n.next),n=e=r),n=n.next}while(n!==e);return Os(n)}function Bs(e,t,i,n,a,r){let s=e;do{let e=s.next.next;for(;e!==s.prev;){if(s.i!==e.i&&Vs(s,e)){let o=Qs(s,e);return s=Os(s,s.next),o=Os(o,o.next),Ds(s,t,i,n,a,r),void Ds(o,t,i,n,a,r)}e=e.next}s=s.next}while(s!==e)}function zs(e,t){return e.x-t.x}function Us(e,t){if(t=function(e,t){let i=t;const n=e.x,a=e.y;let r,s=-1/0;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){const e=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>s){if(s=e,e===n){if(a===i.y)return i;if(a===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(n===s)return r;const o=r,l=r.x,c=r.y;let h,u=1/0;i=r;do{n>=i.x&&i.x>=l&&n!==i.x&&Gs(a<c?n:s,a,l,c,a<c?s:n,a,i.x,i.y)&&(h=Math.abs(a-i.y)/(n-i.x),Js(i,e)&&(h<u||h===u&&(i.x>r.x||i.x===r.x&&Fs(r,i)))&&(r=i,u=h)),i=i.next}while(i!==o);return r}(e,t)){const i=Qs(t,e);Os(t,t.next),Os(i,i.next)}}function Fs(e,t){return Ws(e.prev,e,t.prev)<0&&Ws(t.next,e,e.next)<0}function js(e,t,i,n,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Hs(e){let t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function Gs(e,t,i,n,a,r,s,o){return(a-s)*(t-o)-(e-s)*(r-o)>=0&&(e-s)*(n-o)-(i-s)*(t-o)>=0&&(i-s)*(r-o)-(a-s)*(n-o)>=0}function Vs(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Xs(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(Js(e,t)&&Js(t,e)&&function(e,t){let i=e,n=!1;const a=(e.x+t.x)/2,r=(e.y+t.y)/2;do{i.y>r!=i.next.y>r&&i.next.y!==i.y&&a<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)&&(Ws(e.prev,e,t.prev)||Ws(e,t.prev,t))||Ys(e,t)&&Ws(e.prev,e,e.next)>0&&Ws(t.prev,t,t.next)>0)}function Ws(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function Ys(e,t){return e.x===t.x&&e.y===t.y}function Xs(e,t,i,n){const a=qs(Ws(e,t,i)),r=qs(Ws(e,t,n)),s=qs(Ws(i,n,e)),o=qs(Ws(i,n,t));return a!==r&&s!==o||(!(0!==a||!Zs(e,i,t))||(!(0!==r||!Zs(e,n,t))||(!(0!==s||!Zs(i,e,n))||!(0!==o||!Zs(i,t,n)))))}function Zs(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function qs(e){return e>0?1:e<0?-1:0}function Js(e,t){return Ws(e.prev,e,e.next)<0?Ws(e,t,e.next)>=0&&Ws(e,e.prev,t)>=0:Ws(e,t,e.prev)<0||Ws(e,e.next,t)<0}function Qs(e,t){const i=new eo(e.i,e.x,e.y),n=new eo(t.i,t.x,t.y),a=e.next,r=t.prev;return e.next=t,t.prev=e,i.next=a,a.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function Ks(e,t,i,n){const a=new eo(e,t,i);return n?(a.next=n.next,a.prev=n,n.next.prev=a,n.next=a):(a.prev=a,a.next=a),a}function $s(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function eo(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}const to={area:function(e){const t=e.length;let i=0;for(let n=t-1,a=0;a<t;n=a++)i+=e[n].x*e[a].y-e[a].x*e[n].y;return.5*i},isClockWise:function(e){return to.area(e)<0},triangulateShape:function(e,t){const i=[],n=[],a=[];io(e),no(i,e);let r=e.length;t.forEach(io);for(let e=0;e<t.length;e++)n.push(r),r+=t[e].length,no(i,t[e]);const s=Ps(i,n);for(let e=0;e<s.length;e+=3)a.push(s.slice(e,e+3));return a}};function io(e){const t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function no(e,t){for(let i=0;i<t.length;i++)e.push(t[i].x),e.push(t[i].y)}class ao extends wi{constructor(e,t){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const i=this,n=[],a=[];for(let t=0,i=e.length;t<i;t++){r(e[t])}function r(e){const r=[],s=void 0!==t.curveSegments?t.curveSegments:12,o=void 0!==t.steps?t.steps:1;let l=void 0!==t.depth?t.depth:100,c=void 0===t.bevelEnabled||t.bevelEnabled,h=void 0!==t.bevelThickness?t.bevelThickness:6,u=void 0!==t.bevelSize?t.bevelSize:h-2,d=void 0!==t.bevelOffset?t.bevelOffset:0,p=void 0!==t.bevelSegments?t.bevelSegments:3;const m=t.extrudePath,f=void 0!==t.UVGenerator?t.UVGenerator:ro;void 0!==t.amount&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),l=t.amount);let g,y,v,b,_,x=!1;m&&(g=m.getSpacedPoints(o),x=!0,c=!1,y=m.computeFrenetFrames(o,!1),v=new Ce,b=new Ce,_=new Ce),c||(p=0,h=0,u=0,d=0);const w=e.extractPoints(s);let S=w.shape;const M=w.holes;if(!to.isClockWise(S)){S=S.reverse();for(let e=0,t=M.length;e<t;e++){const t=M[e];to.isClockWise(t)&&(M[e]=t.reverse())}}const T=to.triangulateShape(S,M),A=S;for(let e=0,t=M.length;e<t;e++){const t=M[e];S=S.concat(t)}function E(e,t,i){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(i).add(e)}const C=S.length,I=T.length;function P(e,t,i){let n,a,r;const s=e.x-t.x,o=e.y-t.y,l=i.x-e.x,c=i.y-e.y,h=s*s+o*o,u=s*c-o*l;if(Math.abs(u)>Number.EPSILON){const u=Math.sqrt(h),d=Math.sqrt(l*l+c*c),p=t.x-o/u,m=t.y+s/u,f=((i.x-c/d-p)*c-(i.y+l/d-m)*l)/(s*c-o*l);n=p+s*f-e.x,a=m+o*f-e.y;const g=n*n+a*a;if(g<=2)return new ye(n,a);r=Math.sqrt(g/2)}else{let e=!1;s>Number.EPSILON?l>Number.EPSILON&&(e=!0):s<-Number.EPSILON?l<-Number.EPSILON&&(e=!0):Math.sign(o)===Math.sign(c)&&(e=!0),e?(n=-o,a=s,r=Math.sqrt(h)):(n=s,a=o,r=Math.sqrt(h/2))}return new ye(n/r,a/r)}const R=[];for(let e=0,t=A.length,i=t-1,n=e+1;e<t;e++,i++,n++)i===t&&(i=0),n===t&&(n=0),R[e]=P(A[e],A[i],A[n]);const O=[];let D,L=R.concat();for(let e=0,t=M.length;e<t;e++){const t=M[e];D=[];for(let e=0,i=t.length,n=i-1,a=e+1;e<i;e++,n++,a++)n===i&&(n=0),a===i&&(a=0),D[e]=P(t[e],t[n],t[a]);O.push(D),L=L.concat(D)}for(let e=0;e<p;e++){const t=e/p,i=h*Math.cos(t*Math.PI/2),n=u*Math.sin(t*Math.PI/2)+d;for(let e=0,t=A.length;e<t;e++){const t=E(A[e],R[e],n);B(t.x,t.y,-i)}for(let e=0,t=M.length;e<t;e++){const t=M[e];D=O[e];for(let e=0,a=t.length;e<a;e++){const a=E(t[e],D[e],n);B(a.x,a.y,-i)}}}const k=u+d;for(let e=0;e<C;e++){const t=c?E(S[e],L[e],k):S[e];x?(b.copy(y.normals[0]).multiplyScalar(t.x),v.copy(y.binormals[0]).multiplyScalar(t.y),_.copy(g[0]).add(b).add(v),B(_.x,_.y,_.z)):B(t.x,t.y,0)}for(let e=1;e<=o;e++)for(let t=0;t<C;t++){const i=c?E(S[t],L[t],k):S[t];x?(b.copy(y.normals[e]).multiplyScalar(i.x),v.copy(y.binormals[e]).multiplyScalar(i.y),_.copy(g[e]).add(b).add(v),B(_.x,_.y,_.z)):B(i.x,i.y,l/o*e)}for(let e=p-1;e>=0;e--){const t=e/p,i=h*Math.cos(t*Math.PI/2),n=u*Math.sin(t*Math.PI/2)+d;for(let e=0,t=A.length;e<t;e++){const t=E(A[e],R[e],n);B(t.x,t.y,l+i)}for(let e=0,t=M.length;e<t;e++){const t=M[e];D=O[e];for(let e=0,a=t.length;e<a;e++){const a=E(t[e],D[e],n);x?B(a.x,a.y+g[o-1].y,g[o-1].x+i):B(a.x,a.y,l+i)}}}function N(e,t){let i=e.length;for(;--i>=0;){const n=i;let a=i-1;a<0&&(a=e.length-1);for(let e=0,i=o+2*p;e<i;e++){const i=C*e,r=C*(e+1);U(t+n+i,t+a+i,t+a+r,t+n+r)}}}function B(e,t,i){r.push(e),r.push(t),r.push(i)}function z(e,t,a){F(e),F(t),F(a);const r=n.length/3,s=f.generateTopUV(i,n,r-3,r-2,r-1);j(s[0]),j(s[1]),j(s[2])}function U(e,t,a,r){F(e),F(t),F(r),F(t),F(a),F(r);const s=n.length/3,o=f.generateSideWallUV(i,n,s-6,s-3,s-2,s-1);j(o[0]),j(o[1]),j(o[3]),j(o[1]),j(o[2]),j(o[3])}function F(e){n.push(r[3*e+0]),n.push(r[3*e+1]),n.push(r[3*e+2])}function j(e){a.push(e.x),a.push(e.y)}!function(){const e=n.length/3;if(c){let e=0,t=C*e;for(let e=0;e<I;e++){const i=T[e];z(i[2]+t,i[1]+t,i[0]+t)}e=o+2*p,t=C*e;for(let e=0;e<I;e++){const i=T[e];z(i[0]+t,i[1]+t,i[2]+t)}}else{for(let e=0;e<I;e++){const t=T[e];z(t[2],t[1],t[0])}for(let e=0;e<I;e++){const t=T[e];z(t[0]+C*o,t[1]+C*o,t[2]+C*o)}}i.addGroup(e,n.length/3-e,0)}(),function(){const e=n.length/3;let t=0;N(A,t),t+=A.length;for(let e=0,i=M.length;e<i;e++){const i=M[e];N(i,t),t+=i.length}i.addGroup(e,n.length/3-e,1)}()}this.setAttribute("position",new hi(n,3)),this.setAttribute("uv",new hi(a,2)),this.computeVertexNormals()}toJSON(){const e=wi.prototype.toJSON.call(this);return function(e,t,i){if(i.shapes=[],Array.isArray(e))for(let t=0,n=e.length;t<n;t++){const n=e[t];i.shapes.push(n.uuid)}else i.shapes.push(e.uuid);void 0!==t.extrudePath&&(i.options.extrudePath=t.extrudePath.toJSON());return i}(this.parameters.shapes,this.parameters.options,e)}}const ro={generateTopUV:function(e,t,i,n,a){const r=t[3*i],s=t[3*i+1],o=t[3*n],l=t[3*n+1],c=t[3*a],h=t[3*a+1];return[new ye(r,s),new ye(o,l),new ye(c,h)]},generateSideWallUV:function(e,t,i,n,a,r){const s=t[3*i],o=t[3*i+1],l=t[3*i+2],c=t[3*n],h=t[3*n+1],u=t[3*n+2],d=t[3*a],p=t[3*a+1],m=t[3*a+2],f=t[3*r],g=t[3*r+1],y=t[3*r+2];return Math.abs(o-h)<.01?[new ye(s,1-l),new ye(c,1-u),new ye(d,1-m),new ye(f,1-y)]:[new ye(o,1-l),new ye(h,1-u),new ye(p,1-m),new ye(g,1-y)]}};class so extends Ss{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}}class oo extends wi{constructor(e,t=12,i=0,n=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:n},t=Math.floor(t),n=ge.clamp(n,0,2*Math.PI);const a=[],r=[],s=[],o=1/t,l=new Ce,c=new ye;for(let a=0;a<=t;a++){const h=i+a*o*n,u=Math.sin(h),d=Math.cos(h);for(let i=0;i<=e.length-1;i++)l.x=e[i].x*u,l.y=e[i].y,l.z=e[i].x*d,r.push(l.x,l.y,l.z),c.x=a/t,c.y=i/(e.length-1),s.push(c.x,c.y)}for(let i=0;i<t;i++)for(let t=0;t<e.length-1;t++){const n=t+i*e.length,r=n,s=n+e.length,o=n+e.length+1,l=n+1;a.push(r,s,l),a.push(s,o,l)}if(this.setIndex(a),this.setAttribute("position",new hi(r,3)),this.setAttribute("uv",new hi(s,2)),this.computeVertexNormals(),n===2*Math.PI){const i=this.attributes.normal.array,n=new Ce,a=new Ce,r=new Ce,s=t*e.length*3;for(let t=0,o=0;t<e.length;t++,o+=3)n.x=i[o+0],n.y=i[o+1],n.z=i[o+2],a.x=i[s+o+0],a.y=i[s+o+1],a.z=i[s+o+2],r.addVectors(n,a).normalize(),i[o+0]=i[s+o+0]=r.x,i[o+1]=i[s+o+1]=r.y,i[o+2]=i[s+o+2]=r.z}}}class lo extends Ss{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}}function co(e,t,i){wi.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:i};const n=[],a=[],r=[],s=[],o=1e-5,l=new Ce,c=new Ce,h=new Ce,u=new Ce,d=new Ce;e.length<3&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");const p=t+1;for(let n=0;n<=i;n++){const p=n/i;for(let i=0;i<=t;i++){const n=i/t;e(n,p,c),a.push(c.x,c.y,c.z),n-o>=0?(e(n-o,p,h),u.subVectors(c,h)):(e(n+o,p,h),u.subVectors(h,c)),p-o>=0?(e(n,p-o,h),d.subVectors(c,h)):(e(n,p+o,h),d.subVectors(h,c)),l.crossVectors(u,d).normalize(),r.push(l.x,l.y,l.z),s.push(n,p)}}for(let e=0;e<i;e++)for(let i=0;i<t;i++){const t=e*p+i,a=e*p+i+1,r=(e+1)*p+i+1,s=(e+1)*p+i;n.push(t,a,s),n.push(a,r,s)}this.setIndex(n),this.setAttribute("position",new hi(a,3)),this.setAttribute("normal",new hi(r,3)),this.setAttribute("uv",new hi(s,2))}co.prototype=Object.create(wi.prototype),co.prototype.constructor=co;class ho extends wi{constructor(e=.5,t=1,i=8,n=1,a=0,r=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:n,thetaStart:a,thetaLength:r},i=Math.max(3,i);const s=[],o=[],l=[],c=[];let h=e;const u=(t-e)/(n=Math.max(1,n)),d=new Ce,p=new ye;for(let e=0;e<=n;e++){for(let e=0;e<=i;e++){const n=a+e/i*r;d.x=h*Math.cos(n),d.y=h*Math.sin(n),o.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/t+1)/2,p.y=(d.y/t+1)/2,c.push(p.x,p.y)}h+=u}for(let e=0;e<n;e++){const t=e*(i+1);for(let e=0;e<i;e++){const n=e+t,a=n,r=n+i+1,o=n+i+2,l=n+1;s.push(a,r,l),s.push(r,o,l)}}this.setIndex(s),this.setAttribute("position",new hi(o,3)),this.setAttribute("normal",new hi(l,3)),this.setAttribute("uv",new hi(c,2))}}class uo extends wi{constructor(e,t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const i=[],n=[],a=[],r=[];let s=0,o=0;if(!1===Array.isArray(e))l(e);else for(let t=0;t<e.length;t++)l(e[t]),this.addGroup(s,o,t),s+=o,o=0;function l(e){const s=n.length/3,l=e.extractPoints(t);let c=l.shape;const h=l.holes;!1===to.isClockWise(c)&&(c=c.reverse());for(let e=0,t=h.length;e<t;e++){const t=h[e];!0===to.isClockWise(t)&&(h[e]=t.reverse())}const u=to.triangulateShape(c,h);for(let e=0,t=h.length;e<t;e++){const t=h[e];c=c.concat(t)}for(let e=0,t=c.length;e<t;e++){const t=c[e];n.push(t.x,t.y,0),a.push(0,0,1),r.push(t.x,t.y)}for(let e=0,t=u.length;e<t;e++){const t=u[e],n=t[0]+s,a=t[1]+s,r=t[2]+s;i.push(n,a,r),o+=3}}this.setIndex(i),this.setAttribute("position",new hi(n,3)),this.setAttribute("normal",new hi(a,3)),this.setAttribute("uv",new hi(r,2))}toJSON(){const e=wi.prototype.toJSON.call(this);return function(e,t){if(t.shapes=[],Array.isArray(e))for(let i=0,n=e.length;i<n;i++){const n=e[i];t.shapes.push(n.uuid)}else t.shapes.push(e.uuid);return t}(this.parameters.shapes,e)}}class po extends wi{constructor(e=1,t=8,i=6,n=0,a=2*Math.PI,r=0,s=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:n,phiLength:a,thetaStart:r,thetaLength:s},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const o=Math.min(r+s,Math.PI);let l=0;const c=[],h=new Ce,u=new Ce,d=[],p=[],m=[],f=[];for(let d=0;d<=i;d++){const g=[],y=d/i;let v=0;0==d&&0==r?v=.5/t:d==i&&o==Math.PI&&(v=-.5/t);for(let i=0;i<=t;i++){const o=i/t;h.x=-e*Math.cos(n+o*a)*Math.sin(r+y*s),h.y=e*Math.cos(r+y*s),h.z=e*Math.sin(n+o*a)*Math.sin(r+y*s),p.push(h.x,h.y,h.z),u.copy(h).normalize(),m.push(u.x,u.y,u.z),f.push(o+v,1-y),g.push(l++)}c.push(g)}for(let e=0;e<i;e++)for(let n=0;n<t;n++){const t=c[e][n+1],a=c[e][n],s=c[e+1][n],l=c[e+1][n+1];(0!==e||r>0)&&d.push(t,a,l),(e!==i-1||o<Math.PI)&&d.push(a,s,l)}this.setIndex(d),this.setAttribute("position",new hi(p,3)),this.setAttribute("normal",new hi(m,3)),this.setAttribute("uv",new hi(f,2))}}class mo extends Ss{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}}class fo extends ao{constructor(e,t={}){const i=t.font;if(!i||!i.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new wi;const n=i.generateShapes(e,t.size);t.depth=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),super(n,t),this.type="TextGeometry"}}class go extends wi{constructor(e=1,t=.4,i=8,n=6,a=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:a},i=Math.floor(i),n=Math.floor(n);const r=[],s=[],o=[],l=[],c=new Ce,h=new Ce,u=new Ce;for(let r=0;r<=i;r++)for(let d=0;d<=n;d++){const p=d/n*a,m=r/i*Math.PI*2;h.x=(e+t*Math.cos(m))*Math.cos(p),h.y=(e+t*Math.cos(m))*Math.sin(p),h.z=t*Math.sin(m),s.push(h.x,h.y,h.z),c.x=e*Math.cos(p),c.y=e*Math.sin(p),u.subVectors(h,c).normalize(),o.push(u.x,u.y,u.z),l.push(d/n),l.push(r/i)}for(let e=1;e<=i;e++)for(let t=1;t<=n;t++){const i=(n+1)*e+t-1,a=(n+1)*(e-1)+t-1,s=(n+1)*(e-1)+t,o=(n+1)*e+t;r.push(i,a,o),r.push(a,s,o)}this.setIndex(r),this.setAttribute("position",new hi(s,3)),this.setAttribute("normal",new hi(o,3)),this.setAttribute("uv",new hi(l,2))}}class yo extends wi{constructor(e=1,t=.4,i=64,n=8,a=2,r=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:n,p:a,q:r},i=Math.floor(i),n=Math.floor(n);const s=[],o=[],l=[],c=[],h=new Ce,u=new Ce,d=new Ce,p=new Ce,m=new Ce,f=new Ce,g=new Ce;for(let s=0;s<=i;++s){const v=s/i*a*Math.PI*2;y(v,a,r,e,d),y(v+.01,a,r,e,p),f.subVectors(p,d),g.addVectors(p,d),m.crossVectors(f,g),g.crossVectors(m,f),m.normalize(),g.normalize();for(let e=0;e<=n;++e){const a=e/n*Math.PI*2,r=-t*Math.cos(a),p=t*Math.sin(a);h.x=d.x+(r*g.x+p*m.x),h.y=d.y+(r*g.y+p*m.y),h.z=d.z+(r*g.z+p*m.z),o.push(h.x,h.y,h.z),u.subVectors(h,d).normalize(),l.push(u.x,u.y,u.z),c.push(s/i),c.push(e/n)}}for(let e=1;e<=i;e++)for(let t=1;t<=n;t++){const i=(n+1)*(e-1)+(t-1),a=(n+1)*e+(t-1),r=(n+1)*e+t,o=(n+1)*(e-1)+t;s.push(i,a,o),s.push(a,r,o)}function y(e,t,i,n,a){const r=Math.cos(e),s=Math.sin(e),o=i/t*e,l=Math.cos(o);a.x=n*(2+l)*.5*r,a.y=n*(2+l)*s*.5,a.z=n*Math.sin(o)*.5}this.setIndex(s),this.setAttribute("position",new hi(o,3)),this.setAttribute("normal",new hi(l,3)),this.setAttribute("uv",new hi(c,2))}}class vo extends wi{constructor(e,t=64,i=1,n=8,a=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:n,closed:a};const r=e.computeFrenetFrames(t,a);this.tangents=r.tangents,this.normals=r.normals,this.binormals=r.binormals;const s=new Ce,o=new Ce,l=new ye;let c=new Ce;const h=[],u=[],d=[],p=[];function m(a){c=e.getPointAt(a/t,c);const l=r.normals[a],d=r.binormals[a];for(let e=0;e<=n;e++){const t=e/n*Math.PI*2,a=Math.sin(t),r=-Math.cos(t);o.x=r*l.x+a*d.x,o.y=r*l.y+a*d.y,o.z=r*l.z+a*d.z,o.normalize(),u.push(o.x,o.y,o.z),s.x=c.x+i*o.x,s.y=c.y+i*o.y,s.z=c.z+i*o.z,h.push(s.x,s.y,s.z)}}!function(){for(let e=0;e<t;e++)m(e);m(!1===a?t:0),function(){for(let e=0;e<=t;e++)for(let i=0;i<=n;i++)l.x=e/t,l.y=i/n,d.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=n;t++){const i=(n+1)*(e-1)+(t-1),a=(n+1)*e+(t-1),r=(n+1)*e+t,s=(n+1)*(e-1)+t;p.push(i,a,s),p.push(a,r,s)}}()}(),this.setIndex(p),this.setAttribute("position",new hi(h,3)),this.setAttribute("normal",new hi(u,3)),this.setAttribute("uv",new hi(d,2))}toJSON(){const e=wi.prototype.toJSON.call(this);return e.path=this.parameters.path.toJSON(),e}}class bo extends wi{constructor(e){if(super(),this.type="WireframeGeometry",!0===e.isGeometry)return void console.error("THREE.WireframeGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const t=[],i=[0,0],n={},a=new Ce;if(null!==e.index){const r=e.attributes.position,s=e.index;let o=e.groups;0===o.length&&(o=[{start:0,count:s.count,materialIndex:0}]);for(let e=0,t=o.length;e<t;++e){const t=o[e],a=t.start;for(let e=a,r=a+t.count;e<r;e+=3)for(let t=0;t<3;t++){const a=s.getX(e+t),r=s.getX(e+(t+1)%3);i[0]=Math.min(a,r),i[1]=Math.max(a,r);const o=i[0]+","+i[1];void 0===n[o]&&(n[o]={index1:i[0],index2:i[1]})}}for(const e in n){const i=n[e];a.fromBufferAttribute(r,i.index1),t.push(a.x,a.y,a.z),a.fromBufferAttribute(r,i.index2),t.push(a.x,a.y,a.z)}}else{const i=e.attributes.position;for(let e=0,n=i.count/3;e<n;e++)for(let n=0;n<3;n++){const r=3*e+n;a.fromBufferAttribute(i,r),t.push(a.x,a.y,a.z);const s=3*e+(n+1)%3;a.fromBufferAttribute(i,s),t.push(a.x,a.y,a.z)}}this.setAttribute("position",new hi(t,3))}}var _o=Object.freeze({__proto__:null,BoxGeometry:Hi,BoxBufferGeometry:Hi,CircleGeometry:_s,CircleBufferGeometry:_s,ConeGeometry:ws,ConeBufferGeometry:ws,CylinderGeometry:xs,CylinderBufferGeometry:xs,DodecahedronGeometry:Ms,DodecahedronBufferGeometry:Ms,EdgesGeometry:Is,ExtrudeGeometry:ao,ExtrudeBufferGeometry:ao,IcosahedronGeometry:so,IcosahedronBufferGeometry:so,LatheGeometry:oo,LatheBufferGeometry:oo,OctahedronGeometry:lo,OctahedronBufferGeometry:lo,ParametricGeometry:co,ParametricBufferGeometry:co,PlaneGeometry:sn,PlaneBufferGeometry:sn,PolyhedronGeometry:Ss,PolyhedronBufferGeometry:Ss,RingGeometry:ho,RingBufferGeometry:ho,ShapeGeometry:uo,ShapeBufferGeometry:uo,SphereGeometry:po,SphereBufferGeometry:po,TetrahedronGeometry:mo,TetrahedronBufferGeometry:mo,TextGeometry:fo,TextBufferGeometry:fo,TorusGeometry:go,TorusBufferGeometry:go,TorusKnotGeometry:yo,TorusKnotBufferGeometry:yo,TubeGeometry:vo,TubeBufferGeometry:vo,WireframeGeometry:bo});class xo extends Vt{constructor(e){super(),this.type="ShadowMaterial",this.color=new Qt(0),this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this}}xo.prototype.isShadowMaterial=!0;class wo extends Yi{constructor(e){super(e),this.type="RawShaderMaterial"}}function So(e){Vt.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Qt(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Qt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new ye(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.vertexTangents=!1,this.setValues(e)}function Mo(e){So.call(this),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new ye(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,Object.defineProperty(this,"ior",{get:function(){return(1+.4*this.reflectivity)/(1-.4*this.reflectivity)},set:function(e){this.reflectivity=ge.clamp(2.5*(e-1)/(e+1),0,1)}}),this.sheen=null,this.transmission=0,this.transmissionMap=null,this.setValues(e)}wo.prototype.isRawShaderMaterial=!0,So.prototype=Object.create(Vt.prototype),So.prototype.constructor=So,So.prototype.isMeshStandardMaterial=!0,So.prototype.copy=function(e){return Vt.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this.vertexTangents=e.vertexTangents,this},Mo.prototype=Object.create(So.prototype),Mo.prototype.constructor=Mo,Mo.prototype.isMeshPhysicalMaterial=!0,Mo.prototype.copy=function(e){return So.prototype.copy.call(this,e),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.reflectivity=e.reflectivity,e.sheen?this.sheen=(this.sheen||new Qt).copy(e.sheen):this.sheen=null,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this};class To extends Vt{constructor(e){super(),this.type="MeshPhongMaterial",this.color=new Qt(16777215),this.specular=new Qt(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Qt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new ye(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this}}To.prototype.isMeshPhongMaterial=!0;class Ao extends Vt{constructor(e){super(),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Qt(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Qt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new ye(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this}}Ao.prototype.isMeshToonMaterial=!0;class Eo extends Vt{constructor(e){super(),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new ye(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this}}Eo.prototype.isMeshNormalMaterial=!0;class Co extends Vt{constructor(e){super(),this.type="MeshLambertMaterial",this.color=new Qt(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Qt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this}}Co.prototype.isMeshLambertMaterial=!0;class Io extends Vt{constructor(e){super(),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Qt(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new ye(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.flatShading=e.flatShading,this}}Io.prototype.isMeshMatcapMaterial=!0;class Po extends Kr{constructor(e){super(),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}Po.prototype.isLineDashedMaterial=!0;var Ro=Object.freeze({__proto__:null,ShadowMaterial:xo,SpriteMaterial:vr,RawShaderMaterial:wo,ShaderMaterial:Yi,PointsMaterial:cs,MeshPhysicalMaterial:Mo,MeshStandardMaterial:So,MeshPhongMaterial:To,MeshToonMaterial:Ao,MeshNormalMaterial:Eo,MeshLambertMaterial:Co,MeshDepthMaterial:$a,MeshDistanceMaterial:er,MeshBasicMaterial:Kt,MeshMatcapMaterial:Io,LineDashedMaterial:Po,LineBasicMaterial:Kr,Material:Vt});const Oo={arraySlice:function(e,t,i){return Oo.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==i?i:e.length)):e.slice(t,i)},convertArray:function(e,t,i){return!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){const t=e.length,i=new Array(t);for(let e=0;e!==t;++e)i[e]=e;return i.sort((function(t,i){return e[t]-e[i]})),i},sortedArray:function(e,t,i){const n=e.length,a=new e.constructor(n);for(let r=0,s=0;s!==n;++r){const n=i[r]*t;for(let i=0;i!==t;++i)a[s++]=e[n+i]}return a},flattenJSON:function(e,t,i,n){let a=1,r=e[0];for(;void 0!==r&&void 0===r[n];)r=e[a++];if(void 0===r)return;let s=r[n];if(void 0!==s)if(Array.isArray(s))do{s=r[n],void 0!==s&&(t.push(r.time),i.push.apply(i,s)),r=e[a++]}while(void 0!==r);else if(void 0!==s.toArray)do{s=r[n],void 0!==s&&(t.push(r.time),s.toArray(i,i.length)),r=e[a++]}while(void 0!==r);else do{s=r[n],void 0!==s&&(t.push(r.time),i.push(s)),r=e[a++]}while(void 0!==r)},subclip:function(e,t,i,n,a=30){const r=e.clone();r.name=t;const s=[];for(let e=0;e<r.tracks.length;++e){const t=r.tracks[e],o=t.getValueSize(),l=[],c=[];for(let e=0;e<t.times.length;++e){const r=t.times[e]*a;if(!(r<i||r>=n)){l.push(t.times[e]);for(let i=0;i<o;++i)c.push(t.values[e*o+i])}}0!==l.length&&(t.times=Oo.convertArray(l,t.times.constructor),t.values=Oo.convertArray(c,t.values.constructor),s.push(t))}r.tracks=s;let o=1/0;for(let e=0;e<r.tracks.length;++e)o>r.tracks[e].times[0]&&(o=r.tracks[e].times[0]);for(let e=0;e<r.tracks.length;++e)r.tracks[e].shift(-1*o);return r.resetDuration(),r},makeClipAdditive:function(e,t=0,i=e,n=30){n<=0&&(n=30);const a=i.tracks.length,r=t/n;for(let t=0;t<a;++t){const n=i.tracks[t],a=n.ValueTypeName;if("bool"===a||"string"===a)continue;const s=e.tracks.find((function(e){return e.name===n.name&&e.ValueTypeName===a}));if(void 0===s)continue;let o=0;const l=n.getValueSize();n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(o=l/3);let c=0;const h=s.getValueSize();s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(c=h/3);const u=n.times.length-1;let d;if(r<=n.times[0]){const e=o,t=l-o;d=Oo.arraySlice(n.values,e,t)}else if(r>=n.times[u]){const e=u*l+o,t=e+l-o;d=Oo.arraySlice(n.values,e,t)}else{const e=n.createInterpolant(),t=o,i=l-o;e.evaluate(r),d=Oo.arraySlice(e.resultBuffer,t,i)}if("quaternion"===a){(new Ee).fromArray(d).normalize().conjugate().toArray(d)}const p=s.times.length;for(let e=0;e<p;++e){const t=e*h+c;if("quaternion"===a)Ee.multiplyQuaternionsFlat(s.values,t,d,0,s.values,t);else{const e=h-2*c;for(let i=0;i<e;++i)s.values[t+i]-=d[i]}}}return e.blendMode=$,e}};function Do(e,t,i,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(i),this.sampleValues=t,this.valueSize=i}function Lo(e,t,i,n){Do.call(this,e,t,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function ko(e,t,i,n){Do.call(this,e,t,i,n)}function No(e,t,i,n){Do.call(this,e,t,i,n)}Object.assign(Do.prototype,{evaluate:function(e){const t=this.parameterPositions;let i=this._cachedIndex,n=t[i],a=t[i-1];e:{t:{let r;i:{n:if(!(e<n)){for(let r=i+2;;){if(void 0===n){if(e<a)break n;return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,e,a)}if(i===r)break;if(a=n,n=t[++i],e<n)break t}r=t.length;break i}if(e>=a)break e;{const s=t[1];e<s&&(i=2,a=s);for(let r=i-2;;){if(void 0===a)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(i===r)break;if(n=a,a=t[--i-1],e>=a)break t}r=i,i=0}}for(;i<r;){const n=i+r>>>1;e<t[n]?r=n:i=n+1}if(n=t[i],a=t[i-1],void 0===a)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(void 0===n)return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,a,e)}this._cachedIndex=i,this.intervalChanged_(i,a,n)}return this.interpolate_(i,a,e,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,a=e*n;for(let e=0;e!==n;++e)t[e]=i[a+e];return t},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(Do.prototype,{beforeStart_:Do.prototype.copySampleValue_,afterEnd_:Do.prototype.copySampleValue_}),Lo.prototype=Object.assign(Object.create(Do.prototype),{constructor:Lo,DefaultSettings_:{endingStart:q,endingEnd:q},intervalChanged_:function(e,t,i){const n=this.parameterPositions;let a=e-2,r=e+1,s=n[a],o=n[r];if(void 0===s)switch(this.getSettings_().endingStart){case J:a=e,s=2*t-i;break;case Q:a=n.length-2,s=t+n[a]-n[a+1];break;default:a=e,s=i}if(void 0===o)switch(this.getSettings_().endingEnd){case J:r=e,o=2*i-t;break;case Q:r=1,o=i+n[1]-n[0];break;default:r=e-1,o=t}const l=.5*(i-t),c=this.valueSize;this._weightPrev=l/(t-s),this._weightNext=l/(o-i),this._offsetPrev=a*c,this._offsetNext=r*c},interpolate_:function(e,t,i,n){const a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=e*s,l=o-s,c=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(i-t)/(n-t),m=p*p,f=m*p,g=-u*f+2*u*m-u*p,y=(1+u)*f+(-1.5-2*u)*m+(-.5+u)*p+1,v=(-1-d)*f+(1.5+d)*m+.5*p,b=d*f-d*m;for(let e=0;e!==s;++e)a[e]=g*r[c+e]+y*r[l+e]+v*r[o+e]+b*r[h+e];return a}}),ko.prototype=Object.assign(Object.create(Do.prototype),{constructor:ko,interpolate_:function(e,t,i,n){const a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=e*s,l=o-s,c=(i-t)/(n-t),h=1-c;for(let e=0;e!==s;++e)a[e]=r[l+e]*h+r[o+e]*c;return a}}),No.prototype=Object.assign(Object.create(Do.prototype),{constructor:No,interpolate_:function(e){return this.copySampleValue_(e-1)}});class Bo{constructor(e,t,i,n){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=Oo.convertArray(t,this.TimeBufferType),this.values=Oo.convertArray(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let i;if(t.toJSON!==this.toJSON)i=t.toJSON(e);else{i={name:e.name,times:Oo.convertArray(e.times,Array),values:Oo.convertArray(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(i.interpolation=t)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new No(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new ko(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Lo(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case Y:t=this.InterpolantFactoryMethodDiscrete;break;case X:t=this.InterpolantFactoryMethodLinear;break;case Z:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Y;case this.InterpolantFactoryMethodLinear:return X;case this.InterpolantFactoryMethodSmooth:return Z}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]*=e}return this}trim(e,t){const i=this.times,n=i.length;let a=0,r=n-1;for(;a!==n&&i[a]<e;)++a;for(;-1!==r&&i[r]>t;)--r;if(++r,0!==a||r!==n){a>=r&&(r=Math.max(r,1),a=r-1);const e=this.getValueSize();this.times=Oo.arraySlice(i,a,r),this.values=Oo.arraySlice(this.values,a*e,r*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const i=this.times,n=this.values,a=i.length;0===a&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let r=null;for(let t=0;t!==a;t++){const n=i[t];if("number"==typeof n&&isNaN(n)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,n),e=!1;break}if(null!==r&&r>n){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,n,r),e=!1;break}r=n}if(void 0!==n&&Oo.isTypedArray(n))for(let t=0,i=n.length;t!==i;++t){const i=n[t];if(isNaN(i)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,i),e=!1;break}}return e}optimize(){const e=Oo.arraySlice(this.times),t=Oo.arraySlice(this.values),i=this.getValueSize(),n=this.getInterpolation()===Z,a=e.length-1;let r=1;for(let s=1;s<a;++s){let a=!1;const o=e[s];if(o!==e[s+1]&&(1!==s||o!==e[0]))if(n)a=!0;else{const e=s*i,n=e-i,r=e+i;for(let s=0;s!==i;++s){const i=t[e+s];if(i!==t[n+s]||i!==t[r+s]){a=!0;break}}}if(a){if(s!==r){e[r]=e[s];const n=s*i,a=r*i;for(let e=0;e!==i;++e)t[a+e]=t[n+e]}++r}}if(a>0){e[r]=e[a];for(let e=a*i,n=r*i,s=0;s!==i;++s)t[n+s]=t[e+s];++r}return r!==e.length?(this.times=Oo.arraySlice(e,0,r),this.values=Oo.arraySlice(t,0,r*i)):(this.times=e,this.values=t),this}clone(){const e=Oo.arraySlice(this.times,0),t=Oo.arraySlice(this.values,0),i=new(0,this.constructor)(this.name,e,t);return i.createInterpolant=this.createInterpolant,i}}Bo.prototype.TimeBufferType=Float32Array,Bo.prototype.ValueBufferType=Float32Array,Bo.prototype.DefaultInterpolation=X;class zo extends Bo{}zo.prototype.ValueTypeName="bool",zo.prototype.ValueBufferType=Array,zo.prototype.DefaultInterpolation=Y,zo.prototype.InterpolantFactoryMethodLinear=void 0,zo.prototype.InterpolantFactoryMethodSmooth=void 0;class Uo extends Bo{}Uo.prototype.ValueTypeName="color";class Fo extends Bo{}function jo(e,t,i,n){Do.call(this,e,t,i,n)}Fo.prototype.ValueTypeName="number",jo.prototype=Object.assign(Object.create(Do.prototype),{constructor:jo,interpolate_:function(e,t,i,n){const a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=(i-t)/(n-t);let l=e*s;for(let e=l+s;l!==e;l+=4)Ee.slerpFlat(a,0,r,l-s,r,l,o);return a}});class Ho extends Bo{InterpolantFactoryMethodLinear(e){return new jo(this.times,this.values,this.getValueSize(),e)}}Ho.prototype.ValueTypeName="quaternion",Ho.prototype.DefaultInterpolation=X,Ho.prototype.InterpolantFactoryMethodSmooth=void 0;class Go extends Bo{}Go.prototype.ValueTypeName="string",Go.prototype.ValueBufferType=Array,Go.prototype.DefaultInterpolation=Y,Go.prototype.InterpolantFactoryMethodLinear=void 0,Go.prototype.InterpolantFactoryMethodSmooth=void 0;class Vo extends Bo{}Vo.prototype.ValueTypeName="vector";class Wo{constructor(e,t=-1,i,n=2500){this.name=e,this.tracks=i,this.duration=t,this.blendMode=n,this.uuid=ge.generateUUID(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],i=e.tracks,n=1/(e.fps||1);for(let e=0,a=i.length;e!==a;++e)t.push(Yo(i[e]).scale(n));const a=new this(e.name,e.duration,t,e.blendMode);return a.uuid=e.uuid,a}static toJSON(e){const t=[],i=e.tracks,n={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,n=i.length;e!==n;++e)t.push(Bo.toJSON(i[e]));return n}static CreateFromMorphTargetSequence(e,t,i,n){const a=t.length,r=[];for(let e=0;e<a;e++){let s=[],o=[];s.push((e+a-1)%a,e,(e+1)%a),o.push(0,1,0);const l=Oo.getKeyframeOrder(s);s=Oo.sortedArray(s,1,l),o=Oo.sortedArray(o,1,l),n||0!==s[0]||(s.push(a),o.push(o[0])),r.push(new Fo(".morphTargetInfluences["+t[e].name+"]",s,o).scale(1/i))}return new this(e,-1,r)}static findByName(e,t){let i=e;if(!Array.isArray(e)){const t=e;i=t.geometry&&t.geometry.animations||t.animations}for(let e=0;e<i.length;e++)if(i[e].name===t)return i[e];return null}static CreateClipsFromMorphTargetSequences(e,t,i){const n={},a=/^([\w-]*?)([\d]+)$/;for(let t=0,i=e.length;t<i;t++){const i=e[t],r=i.name.match(a);if(r&&r.length>1){const e=r[1];let t=n[e];t||(n[e]=t=[]),t.push(i)}}const r=[];for(const e in n)r.push(this.CreateFromMorphTargetSequence(e,n[e],t,i));return r}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const i=function(e,t,i,n,a){if(0!==i.length){const r=[],s=[];Oo.flattenJSON(i,r,s,n),0!==r.length&&a.push(new e(t,r,s))}},n=[],a=e.name||"default",r=e.fps||30,s=e.blendMode;let o=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const a=l[e].keys;if(a&&0!==a.length)if(a[0].morphTargets){const e={};let t;for(t=0;t<a.length;t++)if(a[t].morphTargets)for(let i=0;i<a[t].morphTargets.length;i++)e[a[t].morphTargets[i]]=-1;for(const i in e){const e=[],r=[];for(let n=0;n!==a[t].morphTargets.length;++n){const n=a[t];e.push(n.time),r.push(n.morphTarget===i?1:0)}n.push(new Fo(".morphTargetInfluence["+i+"]",e,r))}o=e.length*(r||1)}else{const r=".bones["+t[e].name+"]";i(Vo,r+".position",a,"pos",n),i(Ho,r+".quaternion",a,"rot",n),i(Vo,r+".scale",a,"scl",n)}}if(0===n.length)return null;return new this(a,o,n,s)}resetDuration(){let e=0;for(let t=0,i=this.tracks.length;t!==i;++t){const i=this.tracks[t];e=Math.max(e,i.times[i.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function Yo(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Fo;case"vector":case"vector2":case"vector3":case"vector4":return Vo;case"color":return Uo;case"quaternion":return Ho;case"bool":case"boolean":return zo;case"string":return Go}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],i=[];Oo.flattenJSON(e.keys,t,i,"value"),e.times=t,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const Xo={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},Zo=new Map;function qo(e,t,i){const n=this;let a,r=!1,s=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){o++,!1===r&&void 0!==n.onStart&&n.onStart(e,s,o),r=!0},this.itemEnd=function(e){s++,void 0!==n.onProgress&&n.onProgress(e,s,o),s===o&&(r=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return a?a(e):e},this.setURLModifier=function(e){return a=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){const i=l[t],n=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return n}return null}}Zo.enable=!1;const Jo=new qo;function Qo(e){this.manager=void 0!==e?e:Jo,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}Object.assign(Qo.prototype,{load:function(){},loadAsync:function(e,t){const i=this;return new Promise((function(n,a){i.load(e,n,t,a)}))},parse:function(){},setCrossOrigin:function(e){return this.crossOrigin=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}});const Ko={};function $o(e){Qo.call(this,e)}$o.prototype=Object.assign(Object.create(Qo.prototype),{constructor:$o,load:function(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const a=this,r=Xo.get(e);if(void 0!==r)return a.manager.itemStart(e),setTimeout((function(){t&&t(r),a.manager.itemEnd(e)}),0),r;if(void 0!==Ko[e])return void Ko[e].push({onLoad:t,onProgress:i,onError:n});const s=e.match(/^data:(.*?)(;base64)?,(.*)$/);let o;if(s){const i=s[1],r=!!s[2];let o=s[3];o=decodeURIComponent(o),r&&(o=atob(o));try{let n;const r=(this.responseType||"").toLowerCase();switch(r){case"arraybuffer":case"blob":const e=new Uint8Array(o.length);for(let t=0;t<o.length;t++)e[t]=o.charCodeAt(t);n="blob"===r?new Blob([e.buffer],{type:i}):e.buffer;break;case"document":const t=new DOMParser;n=t.parseFromString(o,i);break;case"json":n=JSON.parse(o);break;default:n=o}setTimeout((function(){t&&t(n),a.manager.itemEnd(e)}),0)}catch(t){setTimeout((function(){n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)}),0)}}else{Ko[e]=[],Ko[e].push({onLoad:t,onProgress:i,onError:n}),o=new XMLHttpRequest,o.open("GET",e,!0),o.addEventListener("load",(function(t){const i=this.response,n=Ko[e];if(delete Ko[e],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),Xo.add(e,i);for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onLoad&&t.onLoad(i)}a.manager.itemEnd(e)}else{for(let e=0,i=n.length;e<i;e++){const i=n[e];i.onError&&i.onError(t)}a.manager.itemError(e),a.manager.itemEnd(e)}}),!1),o.addEventListener("progress",(function(t){const i=Ko[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onProgress&&n.onProgress(t)}}),!1),o.addEventListener("error",(function(t){const i=Ko[e];delete Ko[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onError&&n.onError(t)}a.manager.itemError(e),a.manager.itemEnd(e)}),!1),o.addEventListener("abort",(function(t){const i=Ko[e];delete Ko[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onError&&n.onError(t)}a.manager.itemError(e),a.manager.itemEnd(e)}),!1),void 0!==this.responseType&&(o.responseType=this.responseType),void 0!==this.withCredentials&&(o.withCredentials=this.withCredentials),o.overrideMimeType&&o.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const e in this.requestHeader)o.setRequestHeader(e,this.requestHeader[e]);o.send(null)}return a.manager.itemStart(e),o},setResponseType:function(e){return this.responseType=e,this},setMimeType:function(e){return this.mimeType=e,this}});function el(e){Qo.call(this,e)}el.prototype=Object.assign(Object.create(Qo.prototype),{constructor:el,load:function(e,t,i,n){const a=this,r=[],s=new ys,o=new $o(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(a.withCredentials);let l=0;function c(c){o.load(e[c],(function(e){const i=a.parse(e,!0);r[c]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},l+=1,6===l&&(1===i.mipmapCount&&(s.minFilter=b),s.image=r,s.format=i.format,s.needsUpdate=!0,t&&t(s))}),i,n)}if(Array.isArray(e))for(let t=0,i=e.length;t<i;++t)c(t);else o.load(e,(function(e){const i=a.parse(e,!0);if(i.isCubemap){const e=i.mipmaps.length/i.mipmapCount;for(let t=0;t<e;t++){r[t]={mipmaps:[]};for(let e=0;e<i.mipmapCount;e++)r[t].mipmaps.push(i.mipmaps[t*i.mipmapCount+e]),r[t].format=i.format,r[t].width=i.width,r[t].height=i.height}s.image=r}else s.image.width=i.width,s.image.height=i.height,s.mipmaps=i.mipmaps;1===i.mipmapCount&&(s.minFilter=b),s.format=i.format,s.needsUpdate=!0,t&&t(s)}),i,n);return s}});class tl extends Qo{constructor(e){super(e)}load(e,t,i,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const a=this,r=Xo.get(e);if(void 0!==r)return a.manager.itemStart(e),setTimeout((function(){t&&t(r),a.manager.itemEnd(e)}),0),r;const s=document.createElementNS("http://www.w3.org/1999/xhtml","img");function o(){s.removeEventListener("load",o,!1),s.removeEventListener("error",l,!1),Xo.add(e,this),t&&t(this),a.manager.itemEnd(e)}function l(t){s.removeEventListener("load",o,!1),s.removeEventListener("error",l,!1),n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)}return s.addEventListener("load",o,!1),s.addEventListener("error",l,!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(s.crossOrigin=this.crossOrigin),a.manager.itemStart(e),s.src=e,s}}class il extends Qo{constructor(e){super(e)}load(e,t,i,n){const a=new Qi,r=new tl(this.manager);r.setCrossOrigin(this.crossOrigin),r.setPath(this.path);let s=0;function o(i){r.load(e[i],(function(e){a.images[i]=e,s++,6===s&&(a.needsUpdate=!0,t&&t(a))}),void 0,n)}for(let t=0;t<e.length;++t)o(t);return a}}function nl(e){Qo.call(this,e)}function al(e){Qo.call(this,e)}function rl(){this.type="Curve",this.arcLengthDivisions=200}nl.prototype=Object.assign(Object.create(Qo.prototype),{constructor:nl,load:function(e,t,i,n){const a=this,r=new $i,s=new $o(this.manager);return s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setPath(this.path),s.setWithCredentials(a.withCredentials),s.load(e,(function(e){const i=a.parse(e);i&&(void 0!==i.image?r.image=i.image:void 0!==i.data&&(r.image.width=i.width,r.image.height=i.height,r.image.data=i.data),r.wrapS=void 0!==i.wrapS?i.wrapS:m,r.wrapT=void 0!==i.wrapT?i.wrapT:m,r.magFilter=void 0!==i.magFilter?i.magFilter:b,r.minFilter=void 0!==i.minFilter?i.minFilter:b,r.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.encoding&&(r.encoding=i.encoding),void 0!==i.flipY&&(r.flipY=i.flipY),void 0!==i.format&&(r.format=i.format),void 0!==i.type&&(r.type=i.type),void 0!==i.mipmaps&&(r.mipmaps=i.mipmaps,r.minFilter=x),1===i.mipmapCount&&(r.minFilter=b),r.needsUpdate=!0,t&&t(r,i))}),i,n),r}}),al.prototype=Object.assign(Object.create(Qo.prototype),{constructor:al,load:function(e,t,i,n){const a=new we,r=new tl(this.manager);return r.setCrossOrigin(this.crossOrigin),r.setPath(this.path),r.load(e,(function(i){a.image=i;const n=e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/);a.format=n?C:I,a.needsUpdate=!0,void 0!==t&&t(a)}),i,n),a}}),Object.assign(rl.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e,t){const i=this.getUtoTmapping(e);return this.getPoint(i,t)},getPoints:function(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t},getSpacedPoints:function(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t},getLength:function(){const e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let i,n=this.getPoint(0),a=0;t.push(0);for(let r=1;r<=e;r++)i=this.getPoint(r/e),a+=i.distanceTo(n),t.push(a),n=i;return this.cacheArcLengths=t,t},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){const i=this.getLengths();let n=0;const a=i.length;let r;r=t||e*i[a-1];let s,o=0,l=a-1;for(;o<=l;)if(n=Math.floor(o+(l-o)/2),s=i[n]-r,s<0)o=n+1;else{if(!(s>0)){l=n;break}l=n-1}if(n=l,i[n]===r)return n/(a-1);const c=i[n];return(n+(r-c)/(i[n+1]-c))/(a-1)},getTangent:function(e,t){const i=1e-4;let n=e-i,a=e+i;n<0&&(n=0),a>1&&(a=1);const r=this.getPoint(n),s=this.getPoint(a),o=t||(r.isVector2?new ye:new Ce);return o.copy(s).sub(r).normalize(),o},getTangentAt:function(e,t){const i=this.getUtoTmapping(e);return this.getTangent(i,t)},computeFrenetFrames:function(e,t){const i=new Ce,n=[],a=[],r=[],s=new Ce,o=new it;for(let t=0;t<=e;t++){const i=t/e;n[t]=this.getTangentAt(i,new Ce),n[t].normalize()}a[0]=new Ce,r[0]=new Ce;let l=Number.MAX_VALUE;const c=Math.abs(n[0].x),h=Math.abs(n[0].y),u=Math.abs(n[0].z);c<=l&&(l=c,i.set(1,0,0)),h<=l&&(l=h,i.set(0,1,0)),u<=l&&i.set(0,0,1),s.crossVectors(n[0],i).normalize(),a[0].crossVectors(n[0],s),r[0].crossVectors(n[0],a[0]);for(let t=1;t<=e;t++){if(a[t]=a[t-1].clone(),r[t]=r[t-1].clone(),s.crossVectors(n[t-1],n[t]),s.length()>Number.EPSILON){s.normalize();const e=Math.acos(ge.clamp(n[t-1].dot(n[t]),-1,1));a[t].applyMatrix4(o.makeRotationAxis(s,e))}r[t].crossVectors(n[t],a[t])}if(!0===t){let t=Math.acos(ge.clamp(a[0].dot(a[e]),-1,1));t/=e,n[0].dot(s.crossVectors(a[0],a[e]))>0&&(t=-t);for(let i=1;i<=e;i++)a[i].applyMatrix4(o.makeRotationAxis(n[i],t*i)),r[i].crossVectors(n[i],a[i])}return{tangents:n,normals:a,binormals:r}},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this},toJSON:function(){const e={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e},fromJSON:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}});class sl extends rl{constructor(e=0,t=0,i=1,n=1,a=0,r=2*Math.PI,s=!1,o=0){super(),this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=n,this.aStartAngle=a,this.aEndAngle=r,this.aClockwise=s,this.aRotation=o}getPoint(e,t){const i=t||new ye,n=2*Math.PI;let a=this.aEndAngle-this.aStartAngle;const r=Math.abs(a)<Number.EPSILON;for(;a<0;)a+=n;for(;a>n;)a-=n;a<Number.EPSILON&&(a=r?0:n),!0!==this.aClockwise||r||(a===n?a=-n:a-=n);const s=this.aStartAngle+e*a;let o=this.aX+this.xRadius*Math.cos(s),l=this.aY+this.yRadius*Math.sin(s);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),i=o-this.aX,n=l-this.aY;o=i*e-n*t+this.aX,l=i*t+n*e+this.aY}return i.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}sl.prototype.isEllipseCurve=!0;class ol extends sl{constructor(e,t,i,n,a,r){super(e,t,i,i,n,a,r),this.type="ArcCurve"}}function ll(){let e=0,t=0,i=0,n=0;function a(a,r,s,o){e=a,t=s,i=-3*a+3*r-2*s-o,n=2*a-2*r+s+o}return{initCatmullRom:function(e,t,i,n,r){a(t,i,r*(i-e),r*(n-t))},initNonuniformCatmullRom:function(e,t,i,n,r,s,o){let l=(t-e)/r-(i-e)/(r+s)+(i-t)/s,c=(i-t)/s-(n-t)/(s+o)+(n-i)/o;l*=s,c*=s,a(t,i,l,c)},calc:function(a){const r=a*a;return e+t*a+i*r+n*(r*a)}}}ol.prototype.isArcCurve=!0;const cl=new Ce,hl=new ll,ul=new ll,dl=new ll;class pl extends rl{constructor(e=[],t=!1,i="centripetal",n=.5){super(),this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=n}getPoint(e,t=new Ce){const i=t,n=this.points,a=n.length,r=(a-(this.closed?0:1))*e;let s,o,l=Math.floor(r),c=r-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/a)+1)*a:0===c&&l===a-1&&(l=a-2,c=1),this.closed||l>0?s=n[(l-1)%a]:(cl.subVectors(n[0],n[1]).add(n[0]),s=cl);const h=n[l%a],u=n[(l+1)%a];if(this.closed||l+2<a?o=n[(l+2)%a]:(cl.subVectors(n[a-1],n[a-2]).add(n[a-1]),o=cl),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(s.distanceToSquared(h),e),i=Math.pow(h.distanceToSquared(u),e),n=Math.pow(u.distanceToSquared(o),e);i<1e-4&&(i=1),t<1e-4&&(t=i),n<1e-4&&(n=i),hl.initNonuniformCatmullRom(s.x,h.x,u.x,o.x,t,i,n),ul.initNonuniformCatmullRom(s.y,h.y,u.y,o.y,t,i,n),dl.initNonuniformCatmullRom(s.z,h.z,u.z,o.z,t,i,n)}else"catmullrom"===this.curveType&&(hl.initCatmullRom(s.x,h.x,u.x,o.x,this.tension),ul.initCatmullRom(s.y,h.y,u.y,o.y,this.tension),dl.initCatmullRom(s.z,h.z,u.z,o.z,this.tension));return i.set(hl.calc(c),ul.calc(c),dl.calc(c)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push(i.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const i=this.points[t];e.points.push(i.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new Ce).fromArray(i))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function ml(e,t,i,n,a){const r=.5*(n-t),s=.5*(a-i),o=e*e;return(2*i-2*n+r+s)*(e*o)+(-3*i+3*n-2*r-s)*o+r*e+i}function fl(e,t,i,n){return function(e,t){const i=1-e;return i*i*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,i)+function(e,t){return e*e*t}(e,n)}function gl(e,t,i,n,a){return function(e,t){const i=1-e;return i*i*i*t}(e,t)+function(e,t){const i=1-e;return 3*i*i*e*t}(e,i)+function(e,t){return 3*(1-e)*e*e*t}(e,n)+function(e,t){return e*e*e*t}(e,a)}pl.prototype.isCatmullRomCurve3=!0;class yl extends rl{constructor(e=new ye,t=new ye,i=new ye,n=new ye){super(),this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=n}getPoint(e,t=new ye){const i=t,n=this.v0,a=this.v1,r=this.v2,s=this.v3;return i.set(gl(e,n.x,a.x,r.x,s.x),gl(e,n.y,a.y,r.y,s.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}yl.prototype.isCubicBezierCurve=!0;class vl extends rl{constructor(e=new Ce,t=new Ce,i=new Ce,n=new Ce){super(),this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=n}getPoint(e,t=new Ce){const i=t,n=this.v0,a=this.v1,r=this.v2,s=this.v3;return i.set(gl(e,n.x,a.x,r.x,s.x),gl(e,n.y,a.y,r.y,s.y),gl(e,n.z,a.z,r.z,s.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}vl.prototype.isCubicBezierCurve3=!0;class bl extends rl{constructor(e=new ye,t=new ye){super(),this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new ye){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t){const i=t||new ye;return i.copy(this.v2).sub(this.v1).normalize(),i}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}bl.prototype.isLineCurve=!0;class _l extends rl{constructor(e=new Ce,t=new Ce){super(),this.type="LineCurve3",this.isLineCurve3=!0,this.v1=e,this.v2=t}getPoint(e,t=new Ce){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class xl extends rl{constructor(e=new ye,t=new ye,i=new ye){super(),this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new ye){const i=t,n=this.v0,a=this.v1,r=this.v2;return i.set(fl(e,n.x,a.x,r.x),fl(e,n.y,a.y,r.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}xl.prototype.isQuadraticBezierCurve=!0;class wl extends rl{constructor(e=new Ce,t=new Ce,i=new Ce){super(),this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new Ce){const i=t,n=this.v0,a=this.v1,r=this.v2;return i.set(fl(e,n.x,a.x,r.x),fl(e,n.y,a.y,r.y),fl(e,n.z,a.z,r.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}wl.prototype.isQuadraticBezierCurve3=!0;class Sl extends rl{constructor(e=[]){super(),this.type="SplineCurve",this.points=e}getPoint(e,t=new ye){const i=t,n=this.points,a=(n.length-1)*e,r=Math.floor(a),s=a-r,o=n[0===r?r:r-1],l=n[r],c=n[r>n.length-2?n.length-1:r+1],h=n[r>n.length-3?n.length-1:r+2];return i.set(ml(s,o.x,l.x,c.x,h.x),ml(s,o.y,l.y,c.y,h.y)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push(i.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const i=this.points[t];e.points.push(i.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new ye).fromArray(i))}return this}}Sl.prototype.isSplineCurve=!0;var Ml=Object.freeze({__proto__:null,ArcCurve:ol,CatmullRomCurve3:pl,CubicBezierCurve:yl,CubicBezierCurve3:vl,EllipseCurve:sl,LineCurve:bl,LineCurve3:_l,QuadraticBezierCurve:xl,QuadraticBezierCurve3:wl,SplineCurve:Sl});class Tl extends rl{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new bl(t,e))}getPoint(e){const t=e*this.getLength(),i=this.getCurveLengths();let n=0;for(;n<i.length;){if(i[n]>=t){const e=i[n]-t,a=this.curves[n],r=a.getLength(),s=0===r?0:1-e/r;return a.getPointAt(s)}n++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let i=0,n=this.curves.length;i<n;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let i;for(let n=0,a=this.curves;n<a.length;n++){const r=a[n],s=r&&r.isEllipseCurve?2*e:r&&(r.isLineCurve||r.isLineCurve3)?1:r&&r.isSplineCurve?e*r.points.length:e,o=r.getPoints(s);for(let e=0;e<o.length;e++){const n=o[e];i&&i.equals(n)||(t.push(n),i=n)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const i=e.curves[t];this.curves.push(i.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,i=this.curves.length;t<i;t++){const i=this.curves[t];e.curves.push(i.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const i=e.curves[t];this.curves.push((new Ml[i.type]).fromJSON(i))}return this}}class Al extends Tl{constructor(e){super(),this.type="Path",this.currentPoint=new ye,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const i=new bl(this.currentPoint.clone(),new ye(e,t));return this.curves.push(i),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,i,n){const a=new xl(this.currentPoint.clone(),new ye(e,t),new ye(i,n));return this.curves.push(a),this.currentPoint.set(i,n),this}bezierCurveTo(e,t,i,n,a,r){const s=new yl(this.currentPoint.clone(),new ye(e,t),new ye(i,n),new ye(a,r));return this.curves.push(s),this.currentPoint.set(a,r),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),i=new Sl(t);return this.curves.push(i),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,i,n,a,r){const s=this.currentPoint.x,o=this.currentPoint.y;return this.absarc(e+s,t+o,i,n,a,r),this}absarc(e,t,i,n,a,r){return this.absellipse(e,t,i,i,n,a,r),this}ellipse(e,t,i,n,a,r,s,o){const l=this.currentPoint.x,c=this.currentPoint.y;return this.absellipse(e+l,t+c,i,n,a,r,s,o),this}absellipse(e,t,i,n,a,r,s,o){const l=new sl(e,t,i,n,a,r,s,o);if(this.curves.length>0){const e=l.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(l);const c=l.getPoint(1);return this.currentPoint.copy(c),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class El extends Al{constructor(e){super(e),this.uuid=ge.generateUUID(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let i=0,n=this.holes.length;i<n;i++)t[i]=this.holes[i].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const i=e.holes[t];this.holes.push(i.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,i=this.holes.length;t<i;t++){const i=this.holes[t];e.holes.push(i.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const i=e.holes[t];this.holes.push((new Al).fromJSON(i))}return this}}class Cl extends Et{constructor(e,t=1){super(),this.type="Light",this.color=new Qt(e),this.intensity=t}copy(e){return super.copy(e),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}Cl.prototype.isLight=!0;class Il extends Cl{constructor(e,t,i){super(e,i),this.type="HemisphereLight",this.position.copy(Et.DefaultUp),this.updateMatrix(),this.groundColor=new Qt(t)}copy(e){return Cl.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}Il.prototype.isHemisphereLight=!0;const Pl=new it,Rl=new Ce,Ol=new Ce;class Dl{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new ye(512,512),this.map=null,this.mapPass=null,this.matrix=new it,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new nn,this._frameExtents=new ye(1,1),this._viewportCount=1,this._viewports=[new Me(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;Rl.setFromMatrixPosition(e.matrixWorld),t.position.copy(Rl),Ol.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Ol),t.updateMatrixWorld(),Pl.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Pl),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(t.projectionMatrix),i.multiply(t.matrixWorldInverse)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Ll extends Dl{constructor(){super(new Zi(50,1,.5,500)),this.focus=1}updateMatrices(e){const t=this.camera,i=2*ge.RAD2DEG*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height,a=e.distance||t.far;i===t.fov&&n===t.aspect&&a===t.far||(t.fov=i,t.aspect=n,t.far=a,t.updateProjectionMatrix()),super.updateMatrices(e)}}Ll.prototype.isSpotLightShadow=!0;class kl extends Cl{constructor(e,t,i=0,n=Math.PI/3,a=0,r=1){super(e,t),this.type="SpotLight",this.position.copy(Et.DefaultUp),this.updateMatrix(),this.target=new Et,this.distance=i,this.angle=n,this.penumbra=a,this.decay=r,this.shadow=new Ll}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}copy(e){return super.copy(e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}kl.prototype.isSpotLight=!0;const Nl=new it,Bl=new Ce,zl=new Ce;class Ul extends Dl{constructor(){super(new Zi(90,1,.5,500)),this._frameExtents=new ye(4,2),this._viewportCount=6,this._viewports=[new Me(2,1,1,1),new Me(0,1,1,1),new Me(3,1,1,1),new Me(1,1,1,1),new Me(3,0,1,1),new Me(1,0,1,1)],this._cubeDirections=[new Ce(1,0,0),new Ce(-1,0,0),new Ce(0,0,1),new Ce(0,0,-1),new Ce(0,1,0),new Ce(0,-1,0)],this._cubeUps=[new Ce(0,1,0),new Ce(0,1,0),new Ce(0,1,0),new Ce(0,1,0),new Ce(0,0,1),new Ce(0,0,-1)]}updateMatrices(e,t=0){const i=this.camera,n=this.matrix;Bl.setFromMatrixPosition(e.matrixWorld),i.position.copy(Bl),zl.copy(i.position),zl.add(this._cubeDirections[t]),i.up.copy(this._cubeUps[t]),i.lookAt(zl),i.updateMatrixWorld(),n.makeTranslation(-Bl.x,-Bl.y,-Bl.z),Nl.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Nl)}}Ul.prototype.isPointLightShadow=!0;class Fl extends Cl{constructor(e,t,i=0,n=1){super(e,t),this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new Ul}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}copy(e){return super.copy(e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}Fl.prototype.isPointLight=!0;class jl extends Xi{constructor(e=-1,t=1,i=1,n=-1,a=.1,r=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=n,this.near=a,this.far=r,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,n,a,r){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=a,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let a=i-e,r=i+e,s=n+t,o=n-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;a+=e*this.view.offsetX,r=a+e*this.view.width,s-=t*this.view.offsetY,o=s-t*this.view.height}this.projectionMatrix.makeOrthographic(a,r,s,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=Et.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}jl.prototype.isOrthographicCamera=!0;class Hl extends Dl{constructor(){super(new jl(-5,5,5,-5,.5,500))}}Hl.prototype.isDirectionalLightShadow=!0;class Gl extends Cl{constructor(e,t){super(e,t),this.type="DirectionalLight",this.position.copy(Et.DefaultUp),this.updateMatrix(),this.target=new Et,this.shadow=new Hl}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}Gl.prototype.isDirectionalLight=!0;class Vl extends Cl{constructor(e,t){super(e,t),this.type="AmbientLight"}}Vl.prototype.isAmbientLight=!0;class Wl extends Cl{constructor(e,t,i=10,n=10){super(e,t),this.type="RectAreaLight",this.width=i,this.height=n}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}Wl.prototype.isRectAreaLight=!0;class Yl{constructor(){this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new Ce)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const i=e.x,n=e.y,a=e.z,r=this.coefficients;return t.copy(r[0]).multiplyScalar(.282095),t.addScaledVector(r[1],.488603*n),t.addScaledVector(r[2],.488603*a),t.addScaledVector(r[3],.488603*i),t.addScaledVector(r[4],i*n*1.092548),t.addScaledVector(r[5],n*a*1.092548),t.addScaledVector(r[6],.315392*(3*a*a-1)),t.addScaledVector(r[7],i*a*1.092548),t.addScaledVector(r[8],.546274*(i*i-n*n)),t}getIrradianceAt(e,t){const i=e.x,n=e.y,a=e.z,r=this.coefficients;return t.copy(r[0]).multiplyScalar(.886227),t.addScaledVector(r[1],1.023328*n),t.addScaledVector(r[2],1.023328*a),t.addScaledVector(r[3],1.023328*i),t.addScaledVector(r[4],.858086*i*n),t.addScaledVector(r[5],.858086*n*a),t.addScaledVector(r[6],.743125*a*a-.247708),t.addScaledVector(r[7],.858086*i*a),t.addScaledVector(r[8],.429043*(i*i-n*n)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(e.coefficients[i],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let i=0;i<9;i++)this.coefficients[i].lerp(e.coefficients[i],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].fromArray(e,t+3*n);return this}toArray(e=[],t=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].toArray(e,t+3*n);return e}static getBasisAt(e,t){const i=e.x,n=e.y,a=e.z;t[0]=.282095,t[1]=.488603*n,t[2]=.488603*a,t[3]=.488603*i,t[4]=1.092548*i*n,t[5]=1.092548*n*a,t[6]=.315392*(3*a*a-1),t[7]=1.092548*i*a,t[8]=.546274*(i*i-n*n)}}Yl.prototype.isSphericalHarmonics3=!0;class Xl extends Cl{constructor(e=new Yl,t=1){super(void 0,t),this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}Xl.prototype.isLightProbe=!0;class Zl extends Qo{constructor(e){super(e),this.textures={}}load(e,t,i,n){const a=this,r=new $o(a.manager);r.setPath(a.path),r.setRequestHeader(a.requestHeader),r.setWithCredentials(a.withCredentials),r.load(e,(function(i){try{t(a.parse(JSON.parse(i)))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n)}parse(e){const t=this.textures;function i(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}const n=new Ro[e.type];if(void 0!==e.uuid&&(n.uuid=e.uuid),void 0!==e.name&&(n.name=e.name),void 0!==e.color&&void 0!==n.color&&n.color.setHex(e.color),void 0!==e.roughness&&(n.roughness=e.roughness),void 0!==e.metalness&&(n.metalness=e.metalness),void 0!==e.sheen&&(n.sheen=(new Qt).setHex(e.sheen)),void 0!==e.emissive&&void 0!==n.emissive&&n.emissive.setHex(e.emissive),void 0!==e.specular&&void 0!==n.specular&&n.specular.setHex(e.specular),void 0!==e.shininess&&(n.shininess=e.shininess),void 0!==e.clearcoat&&(n.clearcoat=e.clearcoat),void 0!==e.clearcoatRoughness&&(n.clearcoatRoughness=e.clearcoatRoughness),void 0!==e.fog&&(n.fog=e.fog),void 0!==e.flatShading&&(n.flatShading=e.flatShading),void 0!==e.blending&&(n.blending=e.blending),void 0!==e.combine&&(n.combine=e.combine),void 0!==e.side&&(n.side=e.side),void 0!==e.opacity&&(n.opacity=e.opacity),void 0!==e.transparent&&(n.transparent=e.transparent),void 0!==e.alphaTest&&(n.alphaTest=e.alphaTest),void 0!==e.depthTest&&(n.depthTest=e.depthTest),void 0!==e.depthWrite&&(n.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(n.colorWrite=e.colorWrite),void 0!==e.stencilWrite&&(n.stencilWrite=e.stencilWrite),void 0!==e.stencilWriteMask&&(n.stencilWriteMask=e.stencilWriteMask),void 0!==e.stencilFunc&&(n.stencilFunc=e.stencilFunc),void 0!==e.stencilRef&&(n.stencilRef=e.stencilRef),void 0!==e.stencilFuncMask&&(n.stencilFuncMask=e.stencilFuncMask),void 0!==e.stencilFail&&(n.stencilFail=e.stencilFail),void 0!==e.stencilZFail&&(n.stencilZFail=e.stencilZFail),void 0!==e.stencilZPass&&(n.stencilZPass=e.stencilZPass),void 0!==e.wireframe&&(n.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(n.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(n.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(n.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(n.rotation=e.rotation),1!==e.linewidth&&(n.linewidth=e.linewidth),void 0!==e.dashSize&&(n.dashSize=e.dashSize),void 0!==e.gapSize&&(n.gapSize=e.gapSize),void 0!==e.scale&&(n.scale=e.scale),void 0!==e.polygonOffset&&(n.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(n.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(n.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.skinning&&(n.skinning=e.skinning),void 0!==e.morphTargets&&(n.morphTargets=e.morphTargets),void 0!==e.morphNormals&&(n.morphNormals=e.morphNormals),void 0!==e.dithering&&(n.dithering=e.dithering),void 0!==e.vertexTangents&&(n.vertexTangents=e.vertexTangents),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.toneMapped&&(n.toneMapped=e.toneMapped),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.vertexColors&&("number"==typeof e.vertexColors?n.vertexColors=e.vertexColors>0:n.vertexColors=e.vertexColors),void 0!==e.uniforms)for(const t in e.uniforms){const a=e.uniforms[t];switch(n.uniforms[t]={},a.type){case"t":n.uniforms[t].value=i(a.value);break;case"c":n.uniforms[t].value=(new Qt).setHex(a.value);break;case"v2":n.uniforms[t].value=(new ye).fromArray(a.value);break;case"v3":n.uniforms[t].value=(new Ce).fromArray(a.value);break;case"v4":n.uniforms[t].value=(new Me).fromArray(a.value);break;case"m3":n.uniforms[t].value=(new ve).fromArray(a.value);break;case"m4":n.uniforms[t].value=(new it).fromArray(a.value);break;default:n.uniforms[t].value=a.value}}if(void 0!==e.defines&&(n.defines=e.defines),void 0!==e.vertexShader&&(n.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(n.fragmentShader=e.fragmentShader),void 0!==e.extensions)for(const t in e.extensions)n.extensions[t]=e.extensions[t];if(void 0!==e.shading&&(n.flatShading=1===e.shading),void 0!==e.size&&(n.size=e.size),void 0!==e.sizeAttenuation&&(n.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(n.map=i(e.map)),void 0!==e.matcap&&(n.matcap=i(e.matcap)),void 0!==e.alphaMap&&(n.alphaMap=i(e.alphaMap)),void 0!==e.bumpMap&&(n.bumpMap=i(e.bumpMap)),void 0!==e.bumpScale&&(n.bumpScale=e.bumpScale),void 0!==e.normalMap&&(n.normalMap=i(e.normalMap)),void 0!==e.normalMapType&&(n.normalMapType=e.normalMapType),void 0!==e.normalScale){let t=e.normalScale;!1===Array.isArray(t)&&(t=[t,t]),n.normalScale=(new ye).fromArray(t)}return void 0!==e.displacementMap&&(n.displacementMap=i(e.displacementMap)),void 0!==e.displacementScale&&(n.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(n.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(n.roughnessMap=i(e.roughnessMap)),void 0!==e.metalnessMap&&(n.metalnessMap=i(e.metalnessMap)),void 0!==e.emissiveMap&&(n.emissiveMap=i(e.emissiveMap)),void 0!==e.emissiveIntensity&&(n.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(n.specularMap=i(e.specularMap)),void 0!==e.envMap&&(n.envMap=i(e.envMap)),void 0!==e.envMapIntensity&&(n.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(n.reflectivity=e.reflectivity),void 0!==e.refractionRatio&&(n.refractionRatio=e.refractionRatio),void 0!==e.lightMap&&(n.lightMap=i(e.lightMap)),void 0!==e.lightMapIntensity&&(n.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(n.aoMap=i(e.aoMap)),void 0!==e.aoMapIntensity&&(n.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(n.gradientMap=i(e.gradientMap)),void 0!==e.clearcoatMap&&(n.clearcoatMap=i(e.clearcoatMap)),void 0!==e.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap=i(e.clearcoatRoughnessMap)),void 0!==e.clearcoatNormalMap&&(n.clearcoatNormalMap=i(e.clearcoatNormalMap)),void 0!==e.clearcoatNormalScale&&(n.clearcoatNormalScale=(new ye).fromArray(e.clearcoatNormalScale)),void 0!==e.transmission&&(n.transmission=e.transmission),void 0!==e.transmissionMap&&(n.transmissionMap=i(e.transmissionMap)),n}setTextures(e){return this.textures=e,this}}const ql={decodeText:function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let i=0,n=e.length;i<n;i++)t+=String.fromCharCode(e[i]);try{return decodeURIComponent(escape(t))}catch(e){return t}},extractUrlBase:function(e){const t=e.lastIndexOf("/");return-1===t?"./":e.substr(0,t+1)}};function Jl(){wi.call(this),this.type="InstancedBufferGeometry",this.instanceCount=1/0}function Ql(e,t,i,n){"number"==typeof i&&(n=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),ti.call(this,e,t,i),this.meshPerAttribute=n||1}Jl.prototype=Object.assign(Object.create(wi.prototype),{constructor:Jl,isInstancedBufferGeometry:!0,copy:function(e){return wi.prototype.copy.call(this,e),this.instanceCount=e.instanceCount,this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const e=wi.prototype.toJSON.call(this);return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}),Ql.prototype=Object.assign(Object.create(ti.prototype),{constructor:Ql,isInstancedBufferAttribute:!0,copy:function(e){return ti.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},toJSON:function(){const e=ti.prototype.toJSON.call(this);return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}});class Kl extends Qo{constructor(e){super(e)}load(e,t,i,n){const a=this,r=new $o(a.manager);r.setPath(a.path),r.setRequestHeader(a.requestHeader),r.setWithCredentials(a.withCredentials),r.load(e,(function(i){try{t(a.parse(JSON.parse(i)))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n)}parse(e){const t={},i={};function n(e,n){if(void 0!==t[n])return t[n];const a=e.interleavedBuffers[n],r=function(e,t){if(void 0!==i[t])return i[t];const n=e.arrayBuffers[t],a=new Uint32Array(n).buffer;return i[t]=a,a}(e,a.buffer),s=new fr(mi(a.type,r),a.stride);return s.uuid=a.uuid,t[n]=s,s}const a=e.isInstancedBufferGeometry?new Jl:new wi,r=e.data.index;if(void 0!==r){const e=mi(r.type,r.array);a.setIndex(new ti(e,1))}const s=e.data.attributes;for(const t in s){const i=s[t];let r;if(i.isInterleavedBufferAttribute){r=new yr(n(e.data,i.data),i.itemSize,i.offset,i.normalized)}else{const e=mi(i.type,i.array);r=new(i.isInstancedBufferAttribute?Ql:ti)(e,i.itemSize,i.normalized)}void 0!==i.name&&(r.name=i.name),a.setAttribute(t,r)}const o=e.data.morphAttributes;if(o)for(const t in o){const i=o[t],r=[];for(let t=0,a=i.length;t<a;t++){const a=i[t];let s;if(a.isInterleavedBufferAttribute){s=new yr(n(e.data,a.data),a.itemSize,a.offset,a.normalized)}else{s=new ti(mi(a.type,a.array),a.itemSize,a.normalized)}void 0!==a.name&&(s.name=a.name),r.push(s)}a.morphAttributes[t]=r}e.data.morphTargetsRelative&&(a.morphTargetsRelative=!0);const l=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==l)for(let e=0,t=l.length;e!==t;++e){const t=l[e];a.addGroup(t.start,t.count,t.materialIndex)}const c=e.data.boundingSphere;if(void 0!==c){const e=new Ce;void 0!==c.center&&e.fromArray(c.center),a.boundingSphere=new Xe(e,c.radius)}return e.name&&(a.name=e.name),e.userData&&(a.userData=e.userData),a}}const $l={UVMapping:r,CubeReflectionMapping:s,CubeRefractionMapping:o,EquirectangularReflectionMapping:l,EquirectangularRefractionMapping:c,CubeUVReflectionMapping:h,CubeUVRefractionMapping:u},ec={RepeatWrapping:d,ClampToEdgeWrapping:m,MirroredRepeatWrapping:f},tc={NearestFilter:g,NearestMipmapNearestFilter:y,NearestMipmapLinearFilter:v,LinearFilter:b,LinearMipmapNearestFilter:_,LinearMipmapLinearFilter:x};function ic(e){"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),Qo.call(this,e),this.options={premultiplyAlpha:"none"}}ic.prototype=Object.assign(Object.create(Qo.prototype),{constructor:ic,isImageBitmapLoader:!0,setOptions:function(e){return this.options=e,this},load:function(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const a=this,r=Xo.get(e);if(void 0!==r)return a.manager.itemStart(e),setTimeout((function(){t&&t(r),a.manager.itemEnd(e)}),0),r;const s={};s.credentials="anonymous"===this.crossOrigin?"same-origin":"include",s.headers=this.requestHeader;let o=null;fetch(e,s).then((function(e){return e.blob()})).then((function(e){return o=e,createImageBitmap(e,Object.assign(a.options,{colorSpaceConversion:"none"}))})).then((function(i){Xo.get(e)?(t&&t(Xo.get(e)),a.manager.itemEnd(e)):(Xo.add(e,i),o&&!Zo.enable&&Zo.set(i,o),t&&t(i),a.manager.itemEnd(e))})).catch((function(t){n&&n(t),a.manager.itemError(e),a.manager.itemEnd(e)})),a.manager.itemStart(e)}});class nc{constructor(){this.type="ShapePath",this.color=new Qt,this.subPaths=[],this.currentPath=null}moveTo(e,t){return this.currentPath=new Al,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t),this}lineTo(e,t){return this.currentPath.lineTo(e,t),this}quadraticCurveTo(e,t,i,n){return this.currentPath.quadraticCurveTo(e,t,i,n),this}bezierCurveTo(e,t,i,n,a,r){return this.currentPath.bezierCurveTo(e,t,i,n,a,r),this}splineThru(e){return this.currentPath.splineThru(e),this}toShapes(e,t){function i(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i],a=new El;a.curves=n.curves,t.push(a)}return t}function n(e,t){const i=t.length;let n=!1;for(let a=i-1,r=0;r<i;a=r++){let i=t[a],s=t[r],o=s.x-i.x,l=s.y-i.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(i=t[r],o=-o,s=t[a],l=-l),e.y<i.y||e.y>s.y)continue;if(e.y===i.y){if(e.x===i.x)return!0}else{const t=l*(e.x-i.x)-o*(e.y-i.y);if(0===t)return!0;if(t<0)continue;n=!n}}else{if(e.y!==i.y)continue;if(s.x<=e.x&&e.x<=i.x||i.x<=e.x&&e.x<=s.x)return!0}}return n}const a=to.isClockWise,r=this.subPaths;if(0===r.length)return[];if(!0===t)return i(r);let s,o,l;const c=[];if(1===r.length)return o=r[0],l=new El,l.curves=o.curves,c.push(l),c;let h=!a(r[0].getPoints());h=e?!h:h;const u=[],d=[];let p,m,f=[],g=0;d[g]=void 0,f[g]=[];for(let t=0,i=r.length;t<i;t++)o=r[t],p=o.getPoints(),s=a(p),s=e?!s:s,s?(!h&&d[g]&&g++,d[g]={s:new El,p:p},d[g].s.curves=o.curves,h&&g++,f[g]=[]):f[g].push({h:o,p:p[0]});if(!d[0])return i(r);if(d.length>1){let e=!1;const t=[];for(let e=0,t=d.length;e<t;e++)u[e]=[];for(let i=0,a=d.length;i<a;i++){const a=f[i];for(let r=0;r<a.length;r++){const s=a[r];let o=!0;for(let a=0;a<d.length;a++)n(s.p,d[a].p)&&(i!==a&&t.push({froms:i,tos:a,hole:r}),o?(o=!1,u[a].push(s)):e=!0);o&&u[i].push(s)}}t.length>0&&(e||(f=u))}for(let e=0,t=d.length;e<t;e++){l=d[e].s,c.push(l),m=f[e];for(let e=0,t=m.length;e<t;e++)l.holes.push(m[e].h)}return c}}class ac{constructor(e){this.type="Font",this.data=e}generateShapes(e,t=100){const i=[],n=function(e,t,i){const n=Array.from(e),a=t/i.resolution,r=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*a,s=[];let o=0,l=0;for(let e=0;e<n.length;e++){const t=n[e];if("\n"===t)o=0,l-=r;else{const e=rc(t,a,o,l,i);o+=e.offsetX,s.push(e.path)}}return s}(e,t,this.data);for(let e=0,t=n.length;e<t;e++)Array.prototype.push.apply(i,n[e].toShapes());return i}}function rc(e,t,i,n,a){const r=a.glyphs[e]||a.glyphs["?"];if(!r)return void console.error('THREE.Font: character "'+e+'" does not exists in font family '+a.familyName+".");const s=new nc;let o,l,c,h,u,d,p,m;if(r.o){const e=r._cachedOutline||(r._cachedOutline=r.o.split(" "));for(let a=0,r=e.length;a<r;){switch(e[a++]){case"m":o=e[a++]*t+i,l=e[a++]*t+n,s.moveTo(o,l);break;case"l":o=e[a++]*t+i,l=e[a++]*t+n,s.lineTo(o,l);break;case"q":c=e[a++]*t+i,h=e[a++]*t+n,u=e[a++]*t+i,d=e[a++]*t+n,s.quadraticCurveTo(u,d,c,h);break;case"b":c=e[a++]*t+i,h=e[a++]*t+n,u=e[a++]*t+i,d=e[a++]*t+n,p=e[a++]*t+i,m=e[a++]*t+n,s.bezierCurveTo(u,d,p,m,c,h)}}}return{offsetX:r.ha*t,path:s}}ac.prototype.isFont=!0;let sc;const oc={getContext:function(){return void 0===sc&&(sc=new(window.AudioContext||window.webkitAudioContext)),sc},setContext:function(e){sc=e}};class lc extends Qo{constructor(e){super(e)}load(e,t,i,n){const a=this,r=new $o(this.manager);r.setResponseType("arraybuffer"),r.setPath(this.path),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(function(i){try{const e=i.slice(0);oc.getContext().decodeAudioData(e,(function(e){t(e)}))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n)}}class cc extends Xl{constructor(e,t,i=1){super(void 0,i);const n=(new Qt).set(e),a=(new Qt).set(t),r=new Ce(n.r,n.g,n.b),s=new Ce(a.r,a.g,a.b),o=Math.sqrt(Math.PI),l=o*Math.sqrt(.75);this.sh.coefficients[0].copy(r).add(s).multiplyScalar(o),this.sh.coefficients[1].copy(r).sub(s).multiplyScalar(l)}}cc.prototype.isHemisphereLightProbe=!0;class hc extends Xl{constructor(e,t=1){super(void 0,t);const i=(new Qt).set(e);this.sh.coefficients[0].set(i.r,i.g,i.b).multiplyScalar(2*Math.sqrt(Math.PI))}}hc.prototype.isAmbientLightProbe=!0;const uc=new it,dc=new it;class pc{constructor(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=mc(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=mc();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function mc(){return("undefined"==typeof performance?Date:performance).now()}const fc=new Ce,gc=new Ee,yc=new Ce,vc=new Ce;class bc extends Et{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+e;const t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.onended=this.onEnded.bind(this),t.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(!1!==this.hasPlaybackControl)return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){if(this.detune=e,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}}const _c=new Ce,xc=new Ee,wc=new Ce,Sc=new Ce;class Mc{constructor(e,t=2048){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=t,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let e=0;const t=this.getFrequencyData();for(let i=0;i<t.length;i++)e+=t[i];return e/t.length}}class Tc{constructor(e,t,i){let n,a,r;switch(this.binding=e,this.valueSize=i,t){case"quaternion":n=this._slerp,a=this._slerpAdditive,r=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":n=this._select,a=this._select,r=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:n=this._lerp,a=this._lerpAdditive,r=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=a,this._setIdentity=r,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const i=this.buffer,n=this.valueSize,a=e*n+n;let r=this.cumulativeWeight;if(0===r){for(let e=0;e!==n;++e)i[a+e]=i[e];r=t}else{r+=t;const e=t/r;this._mixBufferRegion(i,a,0,e,n)}this.cumulativeWeight=r}accumulateAdditive(e){const t=this.buffer,i=this.valueSize,n=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(t,n,0,e,i),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,i=this.buffer,n=e*t+t,a=this.cumulativeWeight,r=this.cumulativeWeightAdditive,s=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,a<1){const e=t*this._origIndex;this._mixBufferRegion(i,n,e,1-a,t)}r>0&&this._mixBufferRegionAdditive(i,n,this._addIndex*t,1,t);for(let e=t,a=t+t;e!==a;++e)if(i[e]!==i[e+t]){s.setValue(i,n);break}}saveOriginalState(){const e=this.binding,t=this.buffer,i=this.valueSize,n=i*this._origIndex;e.getValue(t,n);for(let e=i,a=n;e!==a;++e)t[e]=t[n+e%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=3*this.valueSize;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let i=e;i<t;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[t+i]=this.buffer[e+i]}_select(e,t,i,n,a){if(n>=.5)for(let n=0;n!==a;++n)e[t+n]=e[i+n]}_slerp(e,t,i,n){Ee.slerpFlat(e,t,e,t,e,i,n)}_slerpAdditive(e,t,i,n,a){const r=this._workIndex*a;Ee.multiplyQuaternionsFlat(e,r,e,t,e,i),Ee.slerpFlat(e,t,e,t,e,r,n)}_lerp(e,t,i,n,a){const r=1-n;for(let s=0;s!==a;++s){const a=t+s;e[a]=e[a]*r+e[i+s]*n}}_lerpAdditive(e,t,i,n,a){for(let r=0;r!==a;++r){const a=t+r;e[a]=e[a]+e[i+r]*n}}}const Ac="\\[\\]\\.:\\/",Ec=new RegExp("[\\[\\]\\.:\\/]","g"),Cc="[^\\[\\]\\.:\\/]",Ic="[^"+Ac.replace("\\.","")+"]",Pc=/((?:WC+[\/:])*)/.source.replace("WC",Cc),Rc=/(WCOD+)?/.source.replace("WCOD",Ic),Oc=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",Cc),Dc=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",Cc),Lc=new RegExp("^"+Pc+Rc+Oc+Dc+"$"),kc=["material","materials","bones"];function Nc(e,t,i){const n=i||Bc.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}function Bc(e,t,i){this.path=t,this.parsedPath=i||Bc.parseTrackName(t),this.node=Bc.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}Object.assign(Nc.prototype,{getValue:function(e,t){this.bind();const i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(e,t)},setValue:function(e,t){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,a=i.length;n!==a;++n)i[n].setValue(e,t)},bind:function(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()},unbind:function(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}),Object.assign(Bc,{Composite:Nc,create:function(e,t,i){return e&&e.isAnimationObjectGroup?new Bc.Composite(e,t,i):new Bc(e,t,i)},sanitizeNodeName:function(e){return e.replace(/\s/g,"_").replace(Ec,"")},parseTrackName:function(e){const t=Lc.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const e=i.nodeName.substring(n+1);-1!==kc.indexOf(e)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=e)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i},findNode:function(e,t){if(!t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const i=e.skeleton.getBoneByName(t);if(void 0!==i)return i}if(e.children){const i=function(e){for(let n=0;n<e.length;n++){const a=e[n];if(a.name===t||a.uuid===t)return a;const r=i(a.children);if(r)return r}return null},n=i(e.children);if(n)return n}return null}}),Object.assign(Bc.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){const i=this.resolvedProperty;for(let n=0,a=i.length;n!==a;++n)e[t++]=i[n]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.targetObject[this.propertyName]=e[t]},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){const i=this.resolvedProperty;for(let n=0,a=i.length;n!==a;++n)i[n]=e[t++]},function(e,t){const i=this.resolvedProperty;for(let n=0,a=i.length;n!==a;++n)i[n]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){const i=this.resolvedProperty;for(let n=0,a=i.length;n!==a;++n)i[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){let e=this.node;const t=this.parsedPath,i=t.objectName,n=t.propertyName;let a=t.propertyIndex;if(e||(e=Bc.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");if(i){let n=t.objectIndex;switch(i){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===n){n=t;break}break;default:if(void 0===e[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[i]}if(void 0!==n){if(void 0===e[n])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[n]}}const r=e[n];if(void 0===r){const i=t.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+i+"."+n+" but it wasn't found.",e)}let s=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?s=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(s=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==a){if("morphTargetInfluences"===n){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.isBufferGeometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[a]&&(a=e.morphTargetDictionary[a])}o=this.BindingType.ArrayElement,this.resolvedProperty=r,this.propertyIndex=a}else void 0!==r.fromArray&&void 0!==r.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=r):Array.isArray(r)?(o=this.BindingType.EntireArray,this.resolvedProperty=r):this.propertyName=n;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][s]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(Bc.prototype,{_getValue_unbound:Bc.prototype.getValue,_setValue_unbound:Bc.prototype.setValue});class zc{constructor(){this.uuid=ge.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const e={};this._indicesByUUID=e;for(let t=0,i=arguments.length;t!==i;++t)e[arguments[t].uuid]=t;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const t=this;this.stats={objects:{get total(){return t._objects.length},get inUse(){return this.total-t.nCachedObjects_}},get bindingsPerObject(){return t._bindings.length}}}add(){const e=this._objects,t=this._indicesByUUID,i=this._paths,n=this._parsedPaths,a=this._bindings,r=a.length;let s,o=e.length,l=this.nCachedObjects_;for(let c=0,h=arguments.length;c!==h;++c){const h=arguments[c],u=h.uuid;let d=t[u];if(void 0===d){d=o++,t[u]=d,e.push(h);for(let e=0,t=r;e!==t;++e)a[e].push(new Bc(h,i[e],n[e]))}else if(d<l){s=e[d];const o=--l,c=e[o];t[c.uuid]=d,e[d]=c,t[u]=o,e[o]=h;for(let e=0,t=r;e!==t;++e){const t=a[e],r=t[o];let s=t[d];t[d]=r,void 0===s&&(s=new Bc(h,i[e],n[e])),t[o]=s}}else e[d]!==s&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=l}remove(){const e=this._objects,t=this._indicesByUUID,i=this._bindings,n=i.length;let a=this.nCachedObjects_;for(let r=0,s=arguments.length;r!==s;++r){const s=arguments[r],o=s.uuid,l=t[o];if(void 0!==l&&l>=a){const r=a++,c=e[r];t[c.uuid]=l,e[l]=c,t[o]=r,e[r]=s;for(let e=0,t=n;e!==t;++e){const t=i[e],n=t[r],a=t[l];t[l]=n,t[r]=a}}}this.nCachedObjects_=a}uncache(){const e=this._objects,t=this._indicesByUUID,i=this._bindings,n=i.length;let a=this.nCachedObjects_,r=e.length;for(let s=0,o=arguments.length;s!==o;++s){const o=arguments[s].uuid,l=t[o];if(void 0!==l)if(delete t[o],l<a){const s=--a,o=e[s],c=--r,h=e[c];t[o.uuid]=l,e[l]=o,t[h.uuid]=s,e[s]=h,e.pop();for(let e=0,t=n;e!==t;++e){const t=i[e],n=t[s],a=t[c];t[l]=n,t[s]=a,t.pop()}}else{const a=--r,s=e[a];a>0&&(t[s.uuid]=l),e[l]=s,e.pop();for(let e=0,t=n;e!==t;++e){const t=i[e];t[l]=t[a],t.pop()}}}this.nCachedObjects_=a}subscribe_(e,t){const i=this._bindingsIndicesByPath;let n=i[e];const a=this._bindings;if(void 0!==n)return a[n];const r=this._paths,s=this._parsedPaths,o=this._objects,l=o.length,c=this.nCachedObjects_,h=new Array(l);n=a.length,i[e]=n,r.push(e),s.push(t),a.push(h);for(let i=c,n=o.length;i!==n;++i){const n=o[i];h[i]=new Bc(n,e,t)}return h}unsubscribe_(e){const t=this._bindingsIndicesByPath,i=t[e];if(void 0!==i){const n=this._paths,a=this._parsedPaths,r=this._bindings,s=r.length-1,o=r[s];t[e[s]]=i,r[i]=o,r.pop(),a[i]=a[s],a.pop(),n[i]=n[s],n.pop()}}}zc.prototype.isAnimationObjectGroup=!0;class Uc{constructor(e,t,i=null,n=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=i,this.blendMode=n;const a=t.tracks,r=a.length,s=new Array(r),o={endingStart:q,endingEnd:q};for(let e=0;e!==r;++e){const t=a[e].createInterpolant(null);s[e]=t,t.settings=o}this._interpolantSettings=o,this._interpolants=s,this._propertyBindings=new Array(r),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,i){if(e.fadeOut(t),this.fadeIn(t),i){const i=this._clip.duration,n=e._clip.duration,a=n/i,r=i/n;e.warp(1,a,t),this.warp(r,1,t)}return this}crossFadeTo(e,t,i){return e.crossFadeFrom(this,t,i)}stopFading(){const e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,i){const n=this._mixer,a=n.time,r=this.timeScale;let s=this._timeScaleInterpolant;null===s&&(s=n._lendControlInterpolant(),this._timeScaleInterpolant=s);const o=s.parameterPositions,l=s.sampleValues;return o[0]=a,o[1]=a+i,l[0]=e/r,l[1]=t/r,this}stopWarping(){const e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,i,n){if(!this.enabled)return void this._updateWeight(e);const a=this._startTime;if(null!==a){const n=(e-a)*i;if(n<0||0===i)return;this._startTime=null,t=i*n}t*=this._updateTimeScale(e);const r=this._updateTime(t),s=this._updateWeight(e);if(s>0){const e=this._interpolants,t=this._propertyBindings;switch(this.blendMode){case $:for(let i=0,n=e.length;i!==n;++i)e[i].evaluate(r),t[i].accumulateAdditive(s);break;case K:default:for(let i=0,a=e.length;i!==a;++i)e[i].evaluate(r),t[i].accumulate(n,s)}}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const i=this._weightInterpolant;if(null!==i){const n=i.evaluate(e)[0];t*=n,e>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const i=this._timeScaleInterpolant;if(null!==i){t*=i.evaluate(e)[0],e>i.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,i=this.loop;let n=this.time+e,a=this._loopCount;const r=2202===i;if(0===e)return-1===a?n:r&&1==(1&a)?t-n:n;if(2200===i){-1===a&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(n>=t)n=t;else{if(!(n<0)){this.time=n;break e}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===a&&(e>=0?(a=0,this._setEndings(!0,0===this.repetitions,r)):this._setEndings(0===this.repetitions,!0,r)),n>=t||n<0){const i=Math.floor(n/t);n-=t*i,a+=Math.abs(i);const s=this.repetitions-a;if(s<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=e>0?t:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===s){const t=e<0;this._setEndings(t,!t,r)}else this._setEndings(!1,!1,r);this._loopCount=a,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=n;if(r&&1==(1&a))return t-n}return n}_setEndings(e,t,i){const n=this._interpolantSettings;i?(n.endingStart=J,n.endingEnd=J):(n.endingStart=e?this.zeroSlopeAtStart?J:q:Q,n.endingEnd=t?this.zeroSlopeAtEnd?J:q:Q)}_scheduleFading(e,t,i){const n=this._mixer,a=n.time;let r=this._weightInterpolant;null===r&&(r=n._lendControlInterpolant(),this._weightInterpolant=r);const s=r.parameterPositions,o=r.sampleValues;return s[0]=a,o[0]=t,s[1]=a+e,o[1]=i,this}}class Fc extends pe{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const i=e._localRoot||this._root,n=e._clip.tracks,a=n.length,r=e._propertyBindings,s=e._interpolants,o=i.uuid,l=this._bindingsByRootAndName;let c=l[o];void 0===c&&(c={},l[o]=c);for(let e=0;e!==a;++e){const a=n[e],l=a.name;let h=c[l];if(void 0!==h)r[e]=h;else{if(h=r[e],void 0!==h){null===h._cacheIndex&&(++h.referenceCount,this._addInactiveBinding(h,o,l));continue}const n=t&&t._propertyBindings[e].binding.parsedPath;h=new Tc(Bc.create(i,l,n),a.ValueTypeName,a.getValueSize()),++h.referenceCount,this._addInactiveBinding(h,o,l),r[e]=h}s[e].resultBuffer=h.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){const t=(e._localRoot||this._root).uuid,i=e._clip.uuid,n=this._actionsByClip[i];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,i,t)}const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return null!==t&&t<this._nActiveActions}_addInactiveAction(e,t,i){const n=this._actions,a=this._actionsByClip;let r=a[t];if(void 0===r)r={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,a[t]=r;else{const t=r.knownActions;e._byClipCacheIndex=t.length,t.push(e)}e._cacheIndex=n.length,n.push(e),r.actionByRoot[i]=e}_removeInactiveAction(e){const t=this._actions,i=t[t.length-1],n=e._cacheIndex;i._cacheIndex=n,t[n]=i,t.pop(),e._cacheIndex=null;const a=e._clip.uuid,r=this._actionsByClip,s=r[a],o=s.knownActions,l=o[o.length-1],c=e._byClipCacheIndex;l._byClipCacheIndex=c,o[c]=l,o.pop(),e._byClipCacheIndex=null;delete s.actionByRoot[(e._localRoot||this._root).uuid],0===o.length&&delete r[a],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==--i.referenceCount&&this._removeInactiveBinding(i)}}_lendAction(e){const t=this._actions,i=e._cacheIndex,n=this._nActiveActions++,a=t[n];e._cacheIndex=n,t[n]=e,a._cacheIndex=i,t[i]=a}_takeBackAction(e){const t=this._actions,i=e._cacheIndex,n=--this._nActiveActions,a=t[n];e._cacheIndex=n,t[n]=e,a._cacheIndex=i,t[i]=a}_addInactiveBinding(e,t,i){const n=this._bindingsByRootAndName,a=this._bindings;let r=n[t];void 0===r&&(r={},n[t]=r),r[i]=e,e._cacheIndex=a.length,a.push(e)}_removeInactiveBinding(e){const t=this._bindings,i=e.binding,n=i.rootNode.uuid,a=i.path,r=this._bindingsByRootAndName,s=r[n],o=t[t.length-1],l=e._cacheIndex;o._cacheIndex=l,t[l]=o,t.pop(),delete s[a],0===Object.keys(s).length&&delete r[n]}_lendBinding(e){const t=this._bindings,i=e._cacheIndex,n=this._nActiveBindings++,a=t[n];e._cacheIndex=n,t[n]=e,a._cacheIndex=i,t[i]=a}_takeBackBinding(e){const t=this._bindings,i=e._cacheIndex,n=--this._nActiveBindings,a=t[n];e._cacheIndex=n,t[n]=e,a._cacheIndex=i,t[i]=a}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let i=e[t];return void 0===i&&(i=new ko(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),i.__cacheIndex=t,e[t]=i),i}_takeBackControlInterpolant(e){const t=this._controlInterpolants,i=e.__cacheIndex,n=--this._nActiveControlInterpolants,a=t[n];e.__cacheIndex=n,t[n]=e,a.__cacheIndex=i,t[i]=a}clipAction(e,t,i){const n=t||this._root,a=n.uuid;let r="string"==typeof e?Wo.findByName(n,e):e;const s=null!==r?r.uuid:e,o=this._actionsByClip[s];let l=null;if(void 0===i&&(i=null!==r?r.blendMode:K),void 0!==o){const e=o.actionByRoot[a];if(void 0!==e&&e.blendMode===i)return e;l=o.knownActions[0],null===r&&(r=l._clip)}if(null===r)return null;const c=new Uc(this,r,t,i);return this._bindAction(c,l),this._addInactiveAction(c,s,a),c}existingAction(e,t){const i=t||this._root,n=i.uuid,a="string"==typeof e?Wo.findByName(i,e):e,r=a?a.uuid:e,s=this._actionsByClip[r];return void 0!==s&&s.actionByRoot[n]||null}stopAllAction(){const e=this._actions;for(let t=this._nActiveActions-1;t>=0;--t)e[t].stop();return this}update(e){e*=this.timeScale;const t=this._actions,i=this._nActiveActions,n=this.time+=e,a=Math.sign(e),r=this._accuIndex^=1;for(let s=0;s!==i;++s){t[s]._update(n,e,a,r)}const s=this._bindings,o=this._nActiveBindings;for(let e=0;e!==o;++e)s[e].apply(r);return this}setTime(e){this.time=0;for(let e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,i=e.uuid,n=this._actionsByClip,a=n[i];if(void 0!==a){const e=a.knownActions;for(let i=0,n=e.length;i!==n;++i){const n=e[i];this._deactivateAction(n);const a=n._cacheIndex,r=t[t.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,r._cacheIndex=a,t[a]=r,t.pop(),this._removeInactiveBindingsForAction(n)}delete n[i]}}uncacheRoot(e){const t=e.uuid,i=this._actionsByClip;for(const e in i){const n=i[e].actionByRoot[t];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}const n=this._bindingsByRootAndName[t];if(void 0!==n)for(const e in n){const t=n[e];t.restoreOriginalState(),this._removeInactiveBinding(t)}}uncacheAction(e,t){const i=this.existingAction(e,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}Fc.prototype._controlInterpolantsResultBuffer=new Float32Array(1);class jc{constructor(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}clone(){return new jc(void 0===this.value.clone?this.value:this.value.clone())}}function Hc(e,t,i){fr.call(this,e,t),this.meshPerAttribute=i||1}function Gc(e,t,i,n,a){this.buffer=e,this.type=t,this.itemSize=i,this.elementSize=n,this.count=a,this.version=0}function Vc(e,t,i=0,n=1/0){this.ray=new tt(e,t),this.near=i,this.far=n,this.camera=null,this.layers=new pt,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function Wc(e,t){return e.distance-t.distance}function Yc(e,t,i,n){if(e.layers.test(t.layers)&&e.raycast(t,i),!0===n){const n=e.children;for(let e=0,a=n.length;e<a;e++)Yc(n[e],t,i,!0)}}Hc.prototype=Object.assign(Object.create(fr.prototype),{constructor:Hc,isInstancedInterleavedBuffer:!0,copy:function(e){return fr.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},clone:function(e){const t=fr.prototype.clone.call(this,e);return t.meshPerAttribute=this.meshPerAttribute,t},toJSON:function(e){const t=fr.prototype.toJSON.call(this,e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}),Object.defineProperty(Gc.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(Gc.prototype,{isGLBufferAttribute:!0,setBuffer:function(e){return this.buffer=e,this},setType:function(e,t){return this.type=e,this.elementSize=t,this},setItemSize:function(e){return this.itemSize=e,this},setCount:function(e){return this.count=e,this}}),Object.assign(Vc.prototype,{set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)},intersectObject:function(e,t=!1,i=[]){return Yc(e,this,i,t),i.sort(Wc),i},intersectObjects:function(e,t=!1,i=[]){for(let n=0,a=e.length;n<a;n++)Yc(e[n],this,i,t);return i.sort(Wc),i}});class Xc{constructor(e=1,t=0,i=0){return this.radius=e,this.phi=t,this.theta=i,this}set(e,t,i){return this.radius=e,this.phi=t,this.theta=i,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Math.max(e,Math.min(Math.PI-e,this.phi)),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,i){return this.radius=Math.sqrt(e*e+t*t+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,i),this.phi=Math.acos(ge.clamp(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}const Zc=new ye;class qc{constructor(e=new ye(1/0,1/0),t=new ye(-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=Zc.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return void 0===e&&(console.warn("THREE.Box2: .getCenter() target is now required"),e=new ye),this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return void 0===e&&(console.warn("THREE.Box2: .getSize() target is now required"),e=new ye),this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return void 0===t&&(console.warn("THREE.Box2: .getParameter() target is now required"),t=new ye),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,t){return void 0===t&&(console.warn("THREE.Box2: .clampPoint() target is now required"),t=new ye),t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return Zc.copy(e).clamp(this.min,this.max).sub(e).length()}intersect(e){return this.min.max(e.min),this.max.min(e.max),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}qc.prototype.isBox2=!0;const Jc=new Ce,Qc=new Ce;class Kc{constructor(e=new Ce,t=new Ce){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return void 0===e&&(console.warn("THREE.Line3: .getCenter() target is now required"),e=new Ce),e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return void 0===e&&(console.warn("THREE.Line3: .delta() target is now required"),e=new Ce),e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return void 0===t&&(console.warn("THREE.Line3: .at() target is now required"),t=new Ce),this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){Jc.subVectors(e,this.start),Qc.subVectors(this.end,this.start);const i=Qc.dot(Qc);let n=Qc.dot(Jc)/i;return t&&(n=ge.clamp(n,0,1)),n}closestPointToPoint(e,t,i){const n=this.closestPointToPointParameter(e,t);return void 0===i&&(console.warn("THREE.Line3: .closestPointToPoint() target is now required"),i=new Ce),this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}function $c(e){Et.call(this),this.material=e,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}$c.prototype=Object.create(Et.prototype),$c.prototype.constructor=$c,$c.prototype.isImmediateRenderObject=!0;const eh=new Ce;const th=new Ce,ih=new it,nh=new it;class ah extends os{constructor(e){const t=rh(e),i=new wi,n=[],a=[],r=new Qt(0,0,1),s=new Qt(0,1,0);for(let e=0;e<t.length;e++){const i=t[e];i.parent&&i.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),a.push(r.r,r.g,r.b),a.push(s.r,s.g,s.b))}i.setAttribute("position",new hi(n,3)),i.setAttribute("color",new hi(a,3));super(i,new Kr({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){const t=this.bones,i=this.geometry,n=i.getAttribute("position");nh.copy(this.root.matrixWorld).invert();for(let e=0,i=0;e<t.length;e++){const a=t[e];a.parent&&a.parent.isBone&&(ih.multiplyMatrices(nh,a.matrixWorld),th.setFromMatrixPosition(ih),n.setXYZ(i,th.x,th.y,th.z),ih.multiplyMatrices(nh,a.parent.matrixWorld),th.setFromMatrixPosition(ih),n.setXYZ(i+1,th.x,th.y,th.z),i+=2)}i.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}}function rh(e){const t=[];e&&e.isBone&&t.push(e);for(let i=0;i<e.children.length;i++)t.push.apply(t,rh(e.children[i]));return t}const sh=new Ce,oh=new Qt,lh=new Qt;class ch extends os{constructor(e=10,t=10,i=4473924,n=8947848){i=new Qt(i),n=new Qt(n);const a=t/2,r=e/t,s=e/2,o=[],l=[];for(let e=0,c=0,h=-s;e<=t;e++,h+=r){o.push(-s,0,h,s,0,h),o.push(h,0,-s,h,0,s);const t=e===a?i:n;t.toArray(l,c),c+=3,t.toArray(l,c),c+=3,t.toArray(l,c),c+=3,t.toArray(l,c),c+=3}const c=new wi;c.setAttribute("position",new hi(o,3)),c.setAttribute("color",new hi(l,3));super(c,new Kr({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}}const hh=new Ce,uh=new Ce,dh=new Ce;const ph=new Ce,mh=new Xi;function fh(e,t,i,n,a,r,s){ph.set(a,r,s).unproject(n);const o=t[e];if(void 0!==o){const e=i.getAttribute("position");for(let t=0,i=o.length;t<i;t++)e.setXYZ(o[t],ph.x,ph.y,ph.z)}}const gh=new Re;class yh extends os{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),a=new wi;a.setIndex(new ti(i,1)),a.setAttribute("position",new ti(n,3)),super(a,new Kr({color:t,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&gh.setFromObject(this.object),gh.isEmpty())return;const t=gh.min,i=gh.max,n=this.geometry.attributes.position,a=n.array;a[0]=i.x,a[1]=i.y,a[2]=i.z,a[3]=t.x,a[4]=i.y,a[5]=i.z,a[6]=t.x,a[7]=t.y,a[8]=i.z,a[9]=i.x,a[10]=t.y,a[11]=i.z,a[12]=i.x,a[13]=i.y,a[14]=t.z,a[15]=t.x,a[16]=i.y,a[17]=t.z,a[18]=t.x,a[19]=t.y,a[20]=t.z,a[21]=i.x,a[22]=t.y,a[23]=t.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e){return os.prototype.copy.call(this,e),this.object=e.object,this}}class vh extends os{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new wi;n.setIndex(new ti(i,1)),n.setAttribute("position",new hi([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new Kr({color:t,toneMapped:!1})),this.box=e,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}}const bh=new Ce;let _h,xh;class wh extends Et{constructor(e=new Ce(0,0,1),t=new Ce(0,0,0),i=1,n=16776960,a=.2*i,r=.2*a){super(),this.type="ArrowHelper",void 0===_h&&(_h=new wi,_h.setAttribute("position",new hi([0,0,0,0,1,0],3)),xh=new xs(0,.5,1,5,1),xh.translate(0,-.5,0)),this.position.copy(t),this.line=new as(_h,new Kr({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Fi(xh,new Kt({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(i,a,r)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{bh.set(e.z,0,-e.x).normalize();const t=Math.acos(e.y);this.quaternion.setFromAxisAngle(bh,t)}}setLength(e,t=.2*e,i=.2*t){this.line.scale.set(1,Math.max(1e-4,e-t),1),this.line.updateMatrix(),this.cone.scale.set(i,t,i),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}}class Sh extends os{constructor(e=1){const t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],i=new wi;i.setAttribute("position",new hi(t,3)),i.setAttribute("color",new hi([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(i,new Kr({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}}const Mh=new Float32Array(1),Th=new Int32Array(Mh.buffer),Ah={toHalfFloat:function(e){Mh[0]=e;const t=Th[0];let i=t>>16&32768,n=t>>12&2047;const a=t>>23&255;return a<103?i:a>142?(i|=31744,i|=(255==a?0:1)&&8388607&t,i):a<113?(n|=2048,i|=(n>>114-a)+(n>>113-a&1),i):(i|=a-112<<10|n>>1,i+=1&n,i)}},Eh=Math.pow(2,8),Ch=[.125,.215,.35,.446,.526,.582],Ih=5+Ch.length,Ph=20,Rh={[ee]:0,[te]:1,[ne]:2,[ae]:3,[re]:4,[se]:5,[ie]:6},Oh=new Kt({side:1,depthWrite:!1,depthTest:!1}),Dh=new Fi(new Hi,Oh),Lh=new jl,{_lodPlanes:kh,_sizeLods:Nh,_sigmas:Bh}=Yh(),zh=new Qt;let Uh=null;const Fh=(1+Math.sqrt(5))/2,jh=1/Fh,Hh=[new Ce(1,1,1),new Ce(-1,1,1),new Ce(1,1,-1),new Ce(-1,1,-1),new Ce(0,Fh,jh),new Ce(0,Fh,-jh),new Ce(jh,0,Fh),new Ce(-jh,0,Fh),new Ce(Fh,jh,0),new Ce(-Fh,jh,0)];function Gh(e){const t=Math.max(e.r,e.g,e.b),i=Math.min(Math.max(Math.ceil(Math.log2(t)),-128),127);e.multiplyScalar(Math.pow(2,-i));return(i+128)/255}class Vh{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._blurMaterial=function(e){const t=new Float32Array(e),i=new Ce(0,1,0);return new wo({name:"SphericalGaussianBlur",defines:{n:e},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:t},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:i},inputEncoding:{value:Rh[3e3]},outputEncoding:{value:Rh[3e3]}},vertexShader:Qh(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t${Kh()}\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:0,depthTest:!1,depthWrite:!1})}(Ph),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,i=.1,n=100){Uh=this._renderer.getRenderTarget();const a=this._allocateTargets();return this._sceneToCubeUV(e,i,n,a),t>0&&this._blur(a,0,0,t),this._applyPMREM(a),this._cleanup(a),a}fromEquirectangular(e,t,i,n){return this._fromTexture(e,t,i,n)}fromCubemap(e,t){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapShader&&(this._cubemapShader=Jh(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(e){null===this._equirectShader&&(this._equirectShader=qh(e),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),null!==this._cubemapShader&&this._cubemapShader.dispose(),null!==this._equirectShader&&this._equirectShader.dispose();for(let e=0;e<kh.length;e++)kh[e].dispose()}_cleanup(e){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(Uh),e.scissorTest=!1,Zh(e,0,0,e.width,e.height)}_fromTexture(e,t,i,n){Uh=this._renderer.getRenderTarget();const a=this._allocateTargets(e);return this._textureToCubeUV(e,a,t,i,n),this._applyPMREM(a),this._cleanup(a),a}_allocateTargets(e){const t={magFilter:g,minFilter:g,generateMipmaps:!1,type:w,format:1023,encoding:Wh(e)?e.encoding:ne,depthBuffer:!1},i=Xh(t);return i.depthBuffer=!e,this._pingPongRenderTarget=Xh(t),i}_compileMaterial(e){const t=new Fi(kh[0],e);this._renderer.compile(t,Lh)}_sceneToCubeUV(e,t,i,n){const a=new Zi(90,1,t,i),r=[1,-1,1,1,1,1],s=[1,1,1,-1,-1,-1],o=this._renderer,l=o.autoClear,c=o.outputEncoding,h=o.toneMapping;o.getClearColor(zh),o.toneMapping=0,o.outputEncoding=ee,o.autoClear=!1;let u=!1;const d=e.background;if(d){if(d.isColor){Oh.color.copy(d).convertSRGBToLinear(),e.background=null;const t=Gh(Oh.color);Oh.opacity=t,u=!0}}else{Oh.color.copy(zh).convertSRGBToLinear();const e=Gh(Oh.color);Oh.opacity=e,u=!0}for(let t=0;t<6;t++){const i=t%3;0==i?(a.up.set(0,r[t],0),a.lookAt(s[t],0,0)):1==i?(a.up.set(0,0,r[t]),a.lookAt(0,s[t],0)):(a.up.set(0,r[t],0),a.lookAt(0,0,s[t])),Zh(n,i*Eh,t>2?Eh:0,Eh,Eh),o.setRenderTarget(n),u&&o.render(Dh,a),o.render(e,a)}o.toneMapping=h,o.outputEncoding=c,o.autoClear=l}_textureToCubeUV(e,t,i,n,a){const r=this._renderer;e.isCubeTexture?null==this._cubemapShader&&(this._cubemapShader=Jh()):null!=this._equirectShader&&this.cubeFlipY==a||(this.cubeFlipY=a,this._equirectShader=qh(a));const s=e.isCubeTexture?this._cubemapShader:this._equirectShader,o=new Fi(kh[0],s),l=s.uniforms;l.envMap.value=e,"number"==typeof i&&(l.cubeMapRotationY.value=i),"number"==typeof n&&(l.cubeMapIntensity.value=n),l.cubeMapFlipY.value=a?-1:1,e.isCubeTexture||l.texelSize.value.set(1/e.image.width,1/e.image.height),l.inputEncoding.value=Rh[e.encoding],l.outputEncoding.value=Rh[t.texture.encoding],Zh(t,0,0,3*Eh,2*Eh),r.setRenderTarget(t),r.render(o,Lh)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;for(let t=1;t<Ih;t++){const i=Math.sqrt(Bh[t]*Bh[t]-Bh[t-1]*Bh[t-1]),n=Hh[(t-1)%Hh.length];this._blur(e,t-1,t,i,n)}t.autoClear=i}_blur(e,t,i,n,a){const r=this._pingPongRenderTarget;this._halfBlur(e,r,t,i,n,"latitudinal",a),this._halfBlur(r,e,i,i,n,"longitudinal",a)}_halfBlur(e,t,i,n,a,r,s){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==r&&"longitudinal"!==r&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new Fi(kh[n],l),h=l.uniforms,u=Nh[i]-1,d=isFinite(a)?Math.PI/(2*u):2*Math.PI/39,p=a/d,m=isFinite(a)?1+Math.floor(3*p):Ph;m>Ph&&console.warn(`sigmaRadians, ${a}, is too large and will clip, as it requested ${m} samples when the maximum is set to 20`);const f=[];let g=0;for(let e=0;e<Ph;++e){const t=e/p,i=Math.exp(-t*t/2);f.push(i),0==e?g+=i:e<m&&(g+=2*i)}for(let e=0;e<f.length;e++)f[e]=f[e]/g;h.envMap.value=e.texture,h.samples.value=m,h.weights.value=f,h.latitudinal.value="latitudinal"===r,s&&(h.poleAxis.value=s),h.dTheta.value=d,h.mipInt.value=8-i,h.inputEncoding.value=Rh[e.texture.encoding],h.outputEncoding.value=Rh[e.texture.encoding];const y=Nh[n];Zh(t,3*Math.max(0,Eh-2*y),(0===n?0:2*Eh)+2*y*(n>4?n-8+4:0),3*y,2*y),o.setRenderTarget(t),o.render(c,Lh)}}function Wh(e){return void 0!==e&&e.type===w&&(e.encoding===ee||e.encoding===te||e.encoding===ie)}function Yh(){const e=[],t=[],i=[];let n=8;for(let a=0;a<Ih;a++){const r=Math.pow(2,n);t.push(r);let s=1/r;a>4?s=Ch[a-8+4-1]:0==a&&(s=0),i.push(s);const o=1/(r-1),l=-o/2,c=1+o/2,h=[l,l,c,l,c,c,l,l,c,c,l,c],u=6,d=6,p=3,m=2,f=1,g=new Float32Array(p*d*u),y=new Float32Array(m*d*u),v=new Float32Array(f*d*u);for(let e=0;e<u;e++){const t=e%3*2/3-1,i=e>2?0:-1,n=[t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0];g.set(n,p*d*e),y.set(h,m*d*e);const a=[e,e,e,e,e,e];v.set(a,f*d*e)}const b=new wi;b.setAttribute("position",new ti(g,p)),b.setAttribute("uv",new ti(y,m)),b.setAttribute("faceIndex",new ti(v,f)),e.push(b),n>4&&n--}return{_lodPlanes:e,_sizeLods:t,_sigmas:i}}function Xh(e){const t=new Te(3*Eh,3*Eh,e);return t.texture.mapping=h,t.texture.name="PMREM.cubeUv",t.scissorTest=!0,t}function Zh(e,t,i,n,a){e.viewport.set(t,i,n,a),e.scissor.set(t,i,n,a)}function qh(e){const t=new ye(1,1);return new wo({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:t},inputEncoding:{value:Rh[3e3]},outputEncoding:{value:Rh[3e3]},cubeMapRotationY:{value:0},cubeMapIntensity:{value:1},cubeMapFlipY:{value:1}},vertexShader:Qh(),fragmentShader:`\n\n\t\t\tprecision highp float;\n\t\t\tprecision highp int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform vec2 texelSize;\n\t\t\tuniform float cubeMapRotationY;\n\t\t\tuniform float cubeMapIntensity;\n      uniform float cubeMapFlipY;\n\n\t\t\t${Kh()}\n \n\t\t\t#include <common${e?"FlipY":""}>\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n        \n        uv.x += (cubeMapRotationY / 6.283185307379586);\n\n        vec2 f = fract( uv / texelSize - 0.5 );\n\t\t\t\tuv -= f * texelSize;\n\t\t\t\tvec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x += texelSize.x;\n\t\t\t\tvec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.y += texelSize.y;\n\t\t\t\tvec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x -= texelSize.x;\n\t\t\t\tvec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\n\t\t\t\tvec3 tm = mix( tl, tr, f.x );\n        vec3 bm = mix( bl, br, f.x );\n\t\t\t\tgl_FragColor.rgb = mix( tm, bm, f.y );\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n        gl_FragColor *= cubeMapIntensity;\n\n\t\t\t}\n\t\t\t// void main() {\n\n\t\t\t// \tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\t\t\t// \tmat4 cubeMapRotateMat = mat4(cos(cubeMapRotationY), 0., -sin(cubeMapRotationY), 0.,\n\t\t\t// \t0., 1., 0., 0.,\n\t\t\t// \tsin(cubeMapRotationY), 0., cos(cubeMapRotationY),  0.,\n\t\t\t// \t0., 0., 0., 1.);\n\t\t\t// \tvec4 reflectVecRotated = vec4(vOutputDirection, 1.);\n\t\t\t// \treflectVecRotated = cubeMapRotateMat * reflectVecRotated;\n\n\t\t\t// \tvec3 outputDirection = normalize( reflectVecRotated.xyz );\n\t\t\t// \tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t// \tvec2 f = fract( uv / texelSize - 0.5 );\n\t\t\t// \tuv -= f * texelSize;\n\t\t\t// \tvec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t// \tuv.x += texelSize.x;\n\t\t\t// \tvec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t// \tuv.y += texelSize.y;\n\t\t\t// \tvec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t// \tuv.x -= texelSize.x;\n\t\t\t// \tvec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\n\t\t\t// \tvec3 tm = mix( tl, tr, f.x );\n      //   vec3 bm = mix( bl, br, f.x );\n\n\t\t\t// \t//  gl_FragColor.rgb = vec3(1.,0.,0.);\n\t\t\t// \tgl_FragColor.rgb = mix( tm, bm, f.y );\n\n\t\t\t// \tgl_FragColor = linearToOutputTexel( gl_FragColor );\n      //   gl_FragColor *= cubeMapIntensity;\n\n\t\t\t// }\n\t\t`,blending:0,depthTest:!1,depthWrite:!1})}function Jh(){return new wo({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},cubeMapRotationY:{value:0},inputEncoding:{value:Rh[3e3]},outputEncoding:{value:Rh[3e3]}},vertexShader:Qh(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\t\t\tuniform float cubeMapRotationY;\n\n\t\t\t${Kh()}\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tmat4 cubeMapRotateMat = mat4(cos(cubeMapRotationY), 0., -sin(cubeMapRotationY), 0.,\n\t\t\t\t0., 1., 0., 0.,\n\t\t\t\tsin(cubeMapRotationY), 0., cos(cubeMapRotationY),  0.,\n\t\t\t\t0., 0., 0., 1.);\n\t\t\t\tvec4 reflectVecRotated = vec4(vOutputDirection, 1.);\n\t\t\t\t reflectVecRotated = cubeMapRotateMat * reflectVecRotated;\n\t\t\t\tgl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - reflectVecRotated.x, reflectVecRotated.yz ) ) ).rgb;\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:0,depthTest:!1,depthWrite:!1})}function Qh(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function Kh(){return"\n\n\t\tuniform int inputEncoding;\n\t\tuniform int outputEncoding;\n\n\t\t#include <encodings_pars_fragment>\n\n\t\tvec4 inputTexelToLinear( vec4 value ) {\n\n\t\t\tif ( inputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( inputEncoding == 1 ) {\n\n\t\t\t\treturn sRGBToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 2 ) {\n\n\t\t\t\treturn RGBEToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 3 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 7.0 );\n\n\t\t\t} else if ( inputEncoding == 4 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 16.0 );\n\n\t\t\t} else if ( inputEncoding == 5 ) {\n\n\t\t\t\treturn RGBDToLinear( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn GammaToLinear( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 linearToOutputTexel( vec4 value ) {\n\n\t\t\tif ( outputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( outputEncoding == 1 ) {\n\n\t\t\t\treturn LinearTosRGB( value );\n\n\t\t\t} else if ( outputEncoding == 2 ) {\n\n\t\t\t\treturn LinearToRGBE( value );\n\n\t\t\t} else if ( outputEncoding == 3 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 7.0 );\n\n\t\t\t} else if ( outputEncoding == 4 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 16.0 );\n\n\t\t\t} else if ( outputEncoding == 5 ) {\n\n\t\t\t\treturn LinearToRGBD( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn LinearToGamma( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 envMapTexelToLinear( vec4 color ) {\n\n\t\t\treturn inputTexelToLinear( color );\n\n\t\t}\n\t"}rl.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(rl.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Al.prototype.fromPoints=function(e){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(e)},ch.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},ah.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Qo.prototype.extractUrlBase=function(e){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),ql.extractUrlBase(e)},Qo.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}},qc.prototype.center=function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},qc.prototype.empty=function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},qc.prototype.isIntersectionBox=function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},qc.prototype.size=function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)},Re.prototype.center=function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},Re.prototype.empty=function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},Re.prototype.isIntersectionBox=function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},Re.prototype.isIntersectionSphere=function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},Re.prototype.size=function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)},Xe.prototype.empty=function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()},nn.prototype.setFromMatrix=function(e){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(e)},Kc.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},ge.random16=function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},ge.nearestPowerOfTwo=function(e){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),ge.floorPowerOfTwo(e)},ge.nextPowerOfTwo=function(e){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),ge.ceilPowerOfTwo(e)},ve.prototype.flattenToArrayOffset=function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},ve.prototype.multiplyVector3=function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},ve.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},ve.prototype.applyToBufferAttribute=function(e){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},ve.prototype.applyToVector3Array=function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")},ve.prototype.getInverse=function(e){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(e).invert()},it.prototype.extractPosition=function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},it.prototype.flattenToArrayOffset=function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},it.prototype.getPosition=function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),(new Ce).setFromMatrixColumn(this,3)},it.prototype.setRotationFromQuaternion=function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},it.prototype.multiplyToArray=function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},it.prototype.multiplyVector3=function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},it.prototype.multiplyVector4=function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},it.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},it.prototype.rotateAxis=function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},it.prototype.crossVector=function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},it.prototype.translate=function(){console.error("THREE.Matrix4: .translate() has been removed.")},it.prototype.rotateX=function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},it.prototype.rotateY=function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},it.prototype.rotateZ=function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},it.prototype.rotateByAxis=function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},it.prototype.applyToBufferAttribute=function(e){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},it.prototype.applyToVector3Array=function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},it.prototype.makeFrustum=function(e,t,i,n,a,r){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,n,i,a,r)},it.prototype.getInverse=function(e){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(e).invert()},Rt.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},Ee.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Ee.prototype.inverse=function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()},tt.prototype.isIntersectionBox=function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},tt.prototype.isIntersectionPlane=function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},tt.prototype.isIntersectionSphere=function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},Ht.prototype.area=function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},Ht.prototype.barycoordFromPoint=function(e,t){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(e,t)},Ht.prototype.midpoint=function(e){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(e)},Ht.prototypenormal=function(e){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(e)},Ht.prototype.plane=function(e){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(e)},Ht.barycoordFromPoint=function(e,t,i,n,a){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Ht.getBarycoord(e,t,i,n,a)},Ht.normal=function(e,t,i,n){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Ht.getNormal(e,t,i,n)},El.prototype.extractAllPoints=function(e){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(e)},El.prototype.extrude=function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new ao(this,e)},El.prototype.makeGeometry=function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new uo(this,e)},ye.prototype.fromAttribute=function(e,t,i){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)},ye.prototype.distanceToManhattan=function(e){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},ye.prototype.lengthManhattan=function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Ce.prototype.setEulerFromRotationMatrix=function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},Ce.prototype.setEulerFromQuaternion=function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},Ce.prototype.getPositionFromMatrix=function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},Ce.prototype.getScaleFromMatrix=function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},Ce.prototype.getColumnFromMatrix=function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},Ce.prototype.applyProjection=function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},Ce.prototype.fromAttribute=function(e,t,i){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)},Ce.prototype.distanceToManhattan=function(e){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},Ce.prototype.lengthManhattan=function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Me.prototype.fromAttribute=function(e,t,i){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)},Me.prototype.lengthManhattan=function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()},Et.prototype.getChildByName=function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},Et.prototype.renderDepth=function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},Et.prototype.translate=function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)},Et.prototype.getWorldRotation=function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")},Et.prototype.applyMatrix=function(e){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)},Object.defineProperties(Et.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Fi.prototype.setDrawMode=function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")},Object.defineProperties(Fi.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),0},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}}),Object.defineProperties(Nr.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(Yr.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Hr.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")},Object.defineProperty(rl.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),Zi.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Cl.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(ti.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===ue},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(ue)}}}),ti.prototype.setDynamic=function(e){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===e?ue:he),this},ti.prototype.copyIndicesArray=function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},ti.prototype.setArray=function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")},wi.prototype.addIndex=function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},wi.prototype.addAttribute=function(e,t){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),t&&t.isBufferAttribute||t&&t.isInterleavedBufferAttribute?"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(t),this):this.setAttribute(e,t):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(e,new ti(arguments[1],arguments[2])))},wi.prototype.addDrawCall=function(e,t,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},wi.prototype.clearDrawCalls=function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},wi.prototype.computeOffsets=function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},wi.prototype.removeAttribute=function(e){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(e)},wi.prototype.applyMatrix=function(e){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)},Object.defineProperties(wi.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(Jl.prototype,{maxInstancedCount:{get:function(){return console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount},set:function(e){console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount=e}}}),Object.defineProperties(Vc.prototype,{linePrecision:{get:function(){return console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold},set:function(e){console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold=e}}}),Object.defineProperties(fr.prototype,{dynamic:{get:function(){return console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.usage===ue},set:function(e){console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.setUsage(e)}}}),fr.prototype.setDynamic=function(e){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===e?ue:he),this},fr.prototype.setArray=function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")},ao.prototype.getArrays=function(){console.error("THREE.ExtrudeGeometry: .getArrays() has been removed.")},ao.prototype.addShapeList=function(){console.error("THREE.ExtrudeGeometry: .addShapeList() has been removed.")},ao.prototype.addShape=function(){console.error("THREE.ExtrudeGeometry: .addShape() has been removed.")},mr.prototype.dispose=function(){console.error("THREE.Scene: .dispose() has been removed.")},Object.defineProperties(jc.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(Vt.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new Qt}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===e}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(e){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=e}}}),Object.defineProperties(To.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(Mo.prototype,{transparency:{get:function(){return console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission},set:function(e){console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission=e}}}),Object.defineProperties(Yi.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),hr.prototype.clearTarget=function(e,t,i,n){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(e),this.clear(t,i,n)},hr.prototype.animate=function(e){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(e)},hr.prototype.getCurrentRenderTarget=function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},hr.prototype.getMaxAnisotropy=function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},hr.prototype.getPrecision=function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},hr.prototype.resetGLState=function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},hr.prototype.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},hr.prototype.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},hr.prototype.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},hr.prototype.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},hr.prototype.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},hr.prototype.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},hr.prototype.supportsVertexTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},hr.prototype.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},hr.prototype.enableScissorTest=function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},hr.prototype.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},hr.prototype.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},hr.prototype.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},hr.prototype.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},hr.prototype.setFaceCulling=function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},hr.prototype.allocTextureUnit=function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},hr.prototype.setTexture=function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},hr.prototype.setTexture2D=function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},hr.prototype.setTextureCube=function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")},hr.prototype.getActiveMipMapLevel=function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()},Object.defineProperties(hr.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(e){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=!0===e?te:ee}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}}),Object.defineProperties(tr.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(Te.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Object.defineProperties(bc.prototype,{load:{value:function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const t=this;return(new lc).load(e,(function(e){t.setBuffer(e)})),this}},startTime:{set:function(){console.warn("THREE.Audio: .startTime is now .play( delay ).")}}}),Mc.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},Ji.prototype.updateCubeMap=function(e,t){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(e,t)},Ji.prototype.clear=function(e,t,i,n){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(e,t,i,n)},_e.crossOrigin=void 0,_e.loadTexture=function(e,t,i,n){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const a=new al;a.setCrossOrigin(this.crossOrigin);const r=a.load(e,i,void 0,n);return t&&(r.mapping=t),r},_e.loadTextureCube=function(e,t,i,n){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const a=new il;a.setCrossOrigin(this.crossOrigin);const r=a.load(e,i,void 0,n);return t&&(r.mapping=t),r},_e.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},_e.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};const $h={createMultiMaterialObject:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},detach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},attach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")}};"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:t}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=t);var eu=Object.freeze({__proto__:null,ACESFilmicToneMapping:4,AddEquation:a,AddOperation:2,AdditiveAnimationBlendMode:$,AdditiveBlending:2,AlphaFormat:1021,AlwaysDepth:1,AlwaysStencilFunc:519,AmbientLight:Vl,AmbientLightProbe:hc,AnimationClip:Wo,AnimationLoader:class extends Qo{constructor(e){super(e)}load(e,t,i,n){const a=this,r=new $o(this.manager);r.setPath(this.path),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(function(i){try{t(a.parse(JSON.parse(i)))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n)}parse(e){const t=[];for(let i=0;i<e.length;i++){const n=Wo.parse(e[i]);t.push(n)}return t}},AnimationMixer:Fc,AnimationObjectGroup:zc,AnimationUtils:Oo,ArcCurve:ol,ArrayCamera:rr,ArrowHelper:wh,Audio:bc,AudioAnalyser:Mc,AudioContext:oc,AudioListener:class extends Et{constructor(){super(),this.type="AudioListener",this.context=oc.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new pc}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);const t=this.context.listener,i=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(fc,gc,yc),vc.set(0,0,-1).applyQuaternion(gc),t.positionX){const e=this.context.currentTime+this.timeDelta;t.positionX.linearRampToValueAtTime(fc.x,e),t.positionY.linearRampToValueAtTime(fc.y,e),t.positionZ.linearRampToValueAtTime(fc.z,e),t.forwardX.linearRampToValueAtTime(vc.x,e),t.forwardY.linearRampToValueAtTime(vc.y,e),t.forwardZ.linearRampToValueAtTime(vc.z,e),t.upX.linearRampToValueAtTime(i.x,e),t.upY.linearRampToValueAtTime(i.y,e),t.upZ.linearRampToValueAtTime(i.z,e)}else t.setPosition(fc.x,fc.y,fc.z),t.setOrientation(vc.x,vc.y,vc.z,i.x,i.y,i.z)}},AudioLoader:lc,AxesHelper:Sh,AxisHelper:function(e){return console.warn("THREE.AxisHelper has been renamed to THREE.AxesHelper."),new Sh(e)},BackSide:1,BasicDepthPacking:oe,BasicShadowMap:0,BinaryTextureLoader:function(e){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new nl(e)},Bone:Gr,BooleanKeyframeTrack:zo,BoundingBoxHelper:function(e,t){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new yh(e,t)},Box2:qc,Box3:Re,Box3Helper:vh,BoxBufferGeometry:Hi,BoxGeometry:Hi,BoxHelper:yh,BufferAttribute:ti,BufferGeometry:wi,BufferGeometryLoader:Kl,ByteType:1010,Cache:Xo,Camera:Xi,CameraHelper:class extends os{constructor(e){const t=new wi,i=new Kr({color:16777215,vertexColors:!0,toneMapped:!1}),n=[],a=[],r={},s=new Qt(16755200),o=new Qt(16711680),l=new Qt(43775),c=new Qt(16777215),h=new Qt(3355443);function u(e,t,i){d(e,i),d(t,i)}function d(e,t){n.push(0,0,0),a.push(t.r,t.g,t.b),void 0===r[e]&&(r[e]=[]),r[e].push(n.length/3-1)}u("n1","n2",s),u("n2","n4",s),u("n4","n3",s),u("n3","n1",s),u("f1","f2",s),u("f2","f4",s),u("f4","f3",s),u("f3","f1",s),u("n1","f1",s),u("n2","f2",s),u("n3","f3",s),u("n4","f4",s),u("p","n1",o),u("p","n2",o),u("p","n3",o),u("p","n4",o),u("u1","u2",l),u("u2","u3",l),u("u3","u1",l),u("c","t",c),u("p","c",h),u("cn1","cn2",h),u("cn3","cn4",h),u("cf1","cf2",h),u("cf3","cf4",h),t.setAttribute("position",new hi(n,3)),t.setAttribute("color",new hi(a,3)),super(t,i),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=r,this.update()}update(){const e=this.geometry,t=this.pointMap;mh.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),fh("c",t,e,mh,0,0,-1),fh("t",t,e,mh,0,0,1),fh("n1",t,e,mh,-1,-1,-1),fh("n2",t,e,mh,1,-1,-1),fh("n3",t,e,mh,-1,1,-1),fh("n4",t,e,mh,1,1,-1),fh("f1",t,e,mh,-1,-1,1),fh("f2",t,e,mh,1,-1,1),fh("f3",t,e,mh,-1,1,1),fh("f4",t,e,mh,1,1,1),fh("u1",t,e,mh,.7,1.1,-1),fh("u2",t,e,mh,-.7,1.1,-1),fh("u3",t,e,mh,0,2,-1),fh("cf1",t,e,mh,-1,0,1),fh("cf2",t,e,mh,1,0,1),fh("cf3",t,e,mh,0,-1,1),fh("cf4",t,e,mh,0,1,1),fh("cn1",t,e,mh,-1,0,-1),fh("cn2",t,e,mh,1,0,-1),fh("cn3",t,e,mh,0,-1,-1),fh("cn4",t,e,mh,0,1,-1),e.getAttribute("position").needsUpdate=!0}},CanvasRenderer:function(){console.error("THREE.CanvasRenderer has been removed")},CanvasTexture:vs,CatmullRomCurve3:pl,CineonToneMapping:3,CircleBufferGeometry:_s,CircleGeometry:_s,ClampToEdgeWrapping:m,Clock:pc,Color:Qt,ColorKeyframeTrack:Uo,CompressedTexture:ys,CompressedTextureLoader:el,ConeBufferGeometry:ws,ConeGeometry:ws,CubeCamera:Ji,CubeReflectionMapping:s,CubeRefractionMapping:o,CubeTexture:Qi,CubeTextureLoader:il,CubeUVReflectionMapping:h,CubeUVRefractionMapping:u,CubicBezierCurve:yl,CubicBezierCurve3:vl,CubicInterpolant:Lo,CullFaceBack:1,CullFaceFront:2,CullFaceFrontBack:3,CullFaceNone:0,Curve:rl,CurvePath:Tl,CustomBlending:5,CustomToneMapping:5,CylinderBufferGeometry:xs,CylinderGeometry:xs,Cylindrical:class{constructor(e=1,t=0,i=0){return this.radius=e,this.theta=t,this.y=i,this}set(e,t,i){return this.radius=e,this.theta=t,this.y=i,this}copy(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,i){return this.radius=Math.sqrt(e*e+i*i),this.theta=Math.atan2(e,i),this.y=t,this}clone(){return(new this.constructor).copy(this)}},DataTexture:$i,DataTexture2DArray:Mn,DataTexture3D:Tn,DataTextureLoader:nl,DataUtils:Ah,DecrementStencilOp:7683,DecrementWrapStencilOp:34056,DefaultLoadingManager:Jo,DepthFormat:R,DepthStencilFormat:O,DepthTexture:bs,DirectionalLight:Gl,DirectionalLightHelper:class extends Et{constructor(e,t,i){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===t&&(t=1);let n=new wi;n.setAttribute("position",new hi([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));const a=new Kr({fog:!1,toneMapped:!1});this.lightPlane=new as(n,a),this.add(this.lightPlane),n=new wi,n.setAttribute("position",new hi([0,0,0,0,0,1],3)),this.targetLine=new as(n,a),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){hh.setFromMatrixPosition(this.light.matrixWorld),uh.setFromMatrixPosition(this.light.target.matrixWorld),dh.subVectors(uh,hh),this.lightPlane.lookAt(uh),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(uh),this.targetLine.scale.z=dh.length()}},DiscreteInterpolant:No,DodecahedronBufferGeometry:Ms,DodecahedronGeometry:Ms,DoubleSide:2,DstAlphaFactor:206,DstColorFactor:208,DynamicBufferAttribute:function(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setUsage( THREE.DynamicDrawUsage ) instead."),new ti(e,t).setUsage(ue)},DynamicCopyUsage:35050,DynamicDrawUsage:ue,DynamicReadUsage:35049,EdgesGeometry:Is,EdgesHelper:function(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new os(new Is(e.geometry),new Kr({color:void 0!==t?t:16777215}))},EllipseCurve:sl,EqualDepth:4,EqualStencilFunc:514,EquirectangularReflectionMapping:l,EquirectangularRefractionMapping:c,Euler:dt,EventDispatcher:pe,ExtrudeBufferGeometry:ao,ExtrudeGeometry:ao,FaceColors:1,FileLoader:$o,FlatShading:1,Float16BufferAttribute:ci,Float32Attribute:function(e,t){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new hi(e,t)},Float32BufferAttribute:hi,Float64Attribute:function(e,t){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new ui(e,t)},Float64BufferAttribute:ui,FloatType:T,Fog:pr,FogExp2:dr,Font:ac,FontLoader:class extends Qo{constructor(e){super(e)}load(e,t,i,n){const a=this,r=new $o(this.manager);r.setPath(this.path),r.setRequestHeader(this.requestHeader),r.setWithCredentials(a.withCredentials),r.load(e,(function(e){let i;try{i=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(e.substring(65,e.length-2))}const n=a.parse(i);t&&t(n)}),i,n)}parse(e){return new ac(e)}},FrontSide:0,Frustum:nn,GLBufferAttribute:Gc,GLSL1:"100",GLSL3:de,GammaEncoding:ie,GreaterDepth:6,GreaterEqualDepth:5,GreaterEqualStencilFunc:518,GreaterStencilFunc:516,GridHelper:ch,Group:sr,HalfFloatType:A,HemisphereLight:Il,HemisphereLightHelper:class extends Et{constructor(e,t,i){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i;const n=new lo(t);n.rotateY(.5*Math.PI),this.material=new Kt({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const a=n.getAttribute("position"),r=new Float32Array(3*a.count);n.setAttribute("color",new ti(r,3)),this.add(new Fi(n,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const e=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const t=e.geometry.getAttribute("color");oh.copy(this.light.color),lh.copy(this.light.groundColor);for(let e=0,i=t.count;e<i;e++){const n=e<i/2?oh:lh;t.setXYZ(e,n.r,n.g,n.b)}t.needsUpdate=!0}e.lookAt(sh.setFromMatrixPosition(this.light.matrixWorld).negate())}},HemisphereLightProbe:cc,IcosahedronBufferGeometry:so,IcosahedronGeometry:so,ImageBitMapCache:Zo,ImageBitmapLoader:ic,ImageLoader:tl,ImageUtils:_e,ImmediateRenderObject:$c,IncrementStencilOp:7682,IncrementWrapStencilOp:34055,InstancedBufferAttribute:Ql,InstancedBufferGeometry:Jl,InstancedInterleavedBuffer:Hc,InstancedMesh:Qr,Int16Attribute:function(e,t){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new ri(e,t)},Int16BufferAttribute:ri,Int32Attribute:function(e,t){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new oi(e,t)},Int32BufferAttribute:oi,Int8Attribute:function(e,t){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new ii(e,t)},Int8BufferAttribute:ii,IntType:1013,InterleavedBuffer:fr,InterleavedBufferAttribute:yr,Interpolant:Do,InterpolateDiscrete:Y,InterpolateLinear:X,InterpolateSmooth:Z,InvertStencilOp:5386,JSONLoader:function(){console.error("THREE.JSONLoader has been removed.")},KeepStencilOp:ce,KeyframeTrack:Bo,LOD:Nr,LatheBufferGeometry:oo,LatheGeometry:oo,Layers:pt,LensFlare:function(){console.error("THREE.LensFlare has been moved to /examples/jsm/objects/Lensflare.js")},LessDepth:2,LessEqualDepth:3,LessEqualStencilFunc:515,LessStencilFunc:513,Light:Cl,LightProbe:Xl,Line:as,Line3:Kc,LineBasicMaterial:Kr,LineCurve:bl,LineCurve3:_l,LineDashedMaterial:Po,LineLoop:ls,LinePieces:1,LineSegments:os,LineStrip:0,LinearEncoding:ee,LinearFilter:b,LinearInterpolant:ko,LinearMipMapLinearFilter:1008,LinearMipMapNearestFilter:1007,LinearMipmapLinearFilter:x,LinearMipmapNearestFilter:_,LinearToneMapping:1,Loader:Qo,LoaderUtils:ql,LoadingManager:qo,LogLuvEncoding:3003,LoopOnce:2200,LoopPingPong:2202,LoopRepeat:2201,LuminanceAlphaFormat:1025,LuminanceFormat:P,MOUSE:i,Material:Vt,MaterialLoader:Zl,Math:ge,MathUtils:ge,Matrix3:ve,Matrix4:it,MaxEquation:104,Mesh:Fi,MeshBasicMaterial:Kt,MeshDepthMaterial:$a,MeshDistanceMaterial:er,MeshFaceMaterial:function(e){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),e},MeshLambertMaterial:Co,MeshMatcapMaterial:Io,MeshNormalMaterial:Eo,MeshPhongMaterial:To,MeshPhysicalMaterial:Mo,MeshStandardMaterial:So,MeshToonMaterial:Ao,MinEquation:103,MirroredRepeatWrapping:f,MixOperation:1,MultiMaterial:function(e=[]){return console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,e.materials=e,e.clone=function(){return e.slice()},e},MultiplyBlending:4,MultiplyOperation:0,NearestFilter:g,NearestMipMapLinearFilter:1005,NearestMipMapNearestFilter:1004,NearestMipmapLinearFilter:v,NearestMipmapNearestFilter:y,NeverDepth:0,NeverStencilFunc:512,NoBlending:0,NoColors:0,NoToneMapping:0,NormalAnimationBlendMode:K,NormalBlending:1,NotEqualDepth:7,NotEqualStencilFunc:517,NumberKeyframeTrack:Fo,Object3D:Et,ObjectLoader:class extends Qo{constructor(e){super(e)}load(e,t,i,n){const a=this,r=""===this.path?ql.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||r;const s=new $o(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(function(i){let r=null;try{r=JSON.parse(i)}catch(t){return void 0!==n&&n(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}const s=r.metadata;void 0!==s&&void 0!==s.type&&"geometry"!==s.type.toLowerCase()?a.parse(r,t):console.error("THREE.ObjectLoader: Can't load "+e)}),i,n)}parse(e,t){const i=this.parseAnimations(e.animations),n=this.parseShapes(e.shapes),a=this.parseGeometries(e.geometries,n),r=this.parseImages(e.images,(function(){void 0!==t&&t(l)})),s=this.parseTextures(e.textures,r),o=this.parseMaterials(e.materials,s),l=this.parseObject(e.object,a,o,i),c=this.parseSkeletons(e.skeletons,l);if(this.bindSkeletons(l,c),void 0!==t){let e=!1;for(const t in r)if(r[t]instanceof HTMLImageElement){e=!0;break}!1===e&&t(l)}return l}parseShapes(e){const t={};if(void 0!==e)for(let i=0,n=e.length;i<n;i++){const n=(new El).fromJSON(e[i]);t[n.uuid]=n}return t}parseSkeletons(e,t){const i={},n={};if(t.traverse((function(e){e.isBone&&(n[e.uuid]=e)})),void 0!==e)for(let t=0,a=e.length;t<a;t++){const a=(new Yr).fromJSON(e[t],n);i[a.uuid]=a}return i}parseGeometries(e,t){const i={};let n;if(void 0!==e){const a=new Kl;for(let r=0,s=e.length;r<s;r++){let s;const o=e[r];switch(o.type){case"PlaneGeometry":case"PlaneBufferGeometry":s=new _o[o.type](o.width,o.height,o.widthSegments,o.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":s=new _o[o.type](o.width,o.height,o.depth,o.widthSegments,o.heightSegments,o.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":s=new _o[o.type](o.radius,o.segments,o.thetaStart,o.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":s=new _o[o.type](o.radiusTop,o.radiusBottom,o.height,o.radialSegments,o.heightSegments,o.openEnded,o.thetaStart,o.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":s=new _o[o.type](o.radius,o.height,o.radialSegments,o.heightSegments,o.openEnded,o.thetaStart,o.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":s=new _o[o.type](o.radius,o.widthSegments,o.heightSegments,o.phiStart,o.phiLength,o.thetaStart,o.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":s=new _o[o.type](o.radius,o.detail);break;case"RingGeometry":case"RingBufferGeometry":s=new _o[o.type](o.innerRadius,o.outerRadius,o.thetaSegments,o.phiSegments,o.thetaStart,o.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":s=new _o[o.type](o.radius,o.tube,o.radialSegments,o.tubularSegments,o.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":s=new _o[o.type](o.radius,o.tube,o.tubularSegments,o.radialSegments,o.p,o.q);break;case"TubeGeometry":case"TubeBufferGeometry":s=new _o[o.type]((new Ml[o.path.type]).fromJSON(o.path),o.tubularSegments,o.radius,o.radialSegments,o.closed);break;case"LatheGeometry":case"LatheBufferGeometry":s=new _o[o.type](o.points,o.segments,o.phiStart,o.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":s=new _o[o.type](o.vertices,o.indices,o.radius,o.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":n=[];for(let e=0,i=o.shapes.length;e<i;e++){const i=t[o.shapes[e]];n.push(i)}s=new _o[o.type](n,o.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":n=[];for(let e=0,i=o.shapes.length;e<i;e++){const i=t[o.shapes[e]];n.push(i)}const e=o.options.extrudePath;void 0!==e&&(o.options.extrudePath=(new Ml[e.type]).fromJSON(e)),s=new _o[o.type](n,o.options);break;case"BufferGeometry":case"InstancedBufferGeometry":s=a.parse(o);break;case"Geometry":console.error('THREE.ObjectLoader: Loading "Geometry" is not supported anymore.');break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+o.type+'"');continue}s.uuid=o.uuid,void 0!==o.name&&(s.name=o.name),!0===s.isBufferGeometry&&void 0!==o.userData&&(s.userData=o.userData),i[o.uuid]=s}}return i}parseMaterials(e,t){const i={},n={};if(void 0!==e){const a=new Zl;a.setTextures(t);for(let t=0,r=e.length;t<r;t++){const r=e[t];if("MultiMaterial"===r.type){const e=[];for(let t=0;t<r.materials.length;t++){const n=r.materials[t];void 0===i[n.uuid]&&(i[n.uuid]=a.parse(n)),e.push(i[n.uuid])}n[r.uuid]=e}else void 0===i[r.uuid]&&(i[r.uuid]=a.parse(r)),n[r.uuid]=i[r.uuid]}}return n}parseAnimations(e){const t={};if(void 0!==e)for(let i=0;i<e.length;i++){const n=e[i],a=Wo.parse(n);t[a.uuid]=a}return t}parseImages(e,t){const i=this,n={};let a;function r(e){if("string"==typeof e){const t=e;return function(e){return i.manager.itemStart(e),a.load(e,(function(){i.manager.itemEnd(e)}),void 0,(function(){i.manager.itemError(e),i.manager.itemEnd(e)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(t)?t:i.resourcePath+t)}return e.data?{data:mi(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){const i=new qo(t);a=new tl(i),a.setCrossOrigin(this.crossOrigin);for(let t=0,i=e.length;t<i;t++){const i=e[t],a=i.url;if(Array.isArray(a)){n[i.uuid]=[];for(let e=0,t=a.length;e<t;e++){const t=r(a[e]);null!==t&&(t instanceof HTMLImageElement?n[i.uuid].push(t):n[i.uuid].push(new $i(t.data,t.width,t.height)))}}else{const e=r(i.url);null!==e&&(n[i.uuid]=e)}}}return n}parseTextures(e,t){function i(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}const n={};if(void 0!==e)for(let a=0,r=e.length;a<r;a++){const r=e[a];let s;void 0===r.image&&console.warn('THREE.ObjectLoader: No "image" specified for',r.uuid),void 0===t[r.image]&&console.warn("THREE.ObjectLoader: Undefined image",r.image);const o=t[r.image];Array.isArray(o)?(s=new Qi(o),6===o.length&&(s.needsUpdate=!0)):(s=o&&o.data?new $i(o.data,o.width,o.height):new we(o),o&&(s.needsUpdate=!0)),s.uuid=r.uuid,void 0!==r.name&&(s.name=r.name),void 0!==r.mapping&&(s.mapping=i(r.mapping,$l)),void 0!==r.offset&&s.offset.fromArray(r.offset),void 0!==r.repeat&&s.repeat.fromArray(r.repeat),void 0!==r.center&&s.center.fromArray(r.center),void 0!==r.rotation&&(s.rotation=r.rotation),void 0!==r.wrap&&(s.wrapS=i(r.wrap[0],ec),s.wrapT=i(r.wrap[1],ec)),void 0!==r.format&&(s.format=r.format),void 0!==r.type&&(s.type=r.type),void 0!==r.encoding&&(s.encoding=r.encoding),void 0!==r.minFilter&&(s.minFilter=i(r.minFilter,tc)),void 0!==r.magFilter&&(s.magFilter=i(r.magFilter,tc)),void 0!==r.anisotropy&&(s.anisotropy=r.anisotropy),void 0!==r.flipY&&(s.flipY=r.flipY),void 0!==r.premultiplyAlpha&&(s.premultiplyAlpha=r.premultiplyAlpha),void 0!==r.unpackAlignment&&(s.unpackAlignment=r.unpackAlignment),n[r.uuid]=s}return n}parseObject(e,t,i,n){let a,r,s;function o(e){return void 0===t[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),t[e]}function l(e){if(void 0!==e){if(Array.isArray(e)){const t=[];for(let n=0,a=e.length;n<a;n++){const a=e[n];void 0===i[a]&&console.warn("THREE.ObjectLoader: Undefined material",a),t.push(i[a])}return t}return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),i[e]}}switch(e.type){case"Scene":a=new mr,void 0!==e.background&&Number.isInteger(e.background)&&(a.background=new Qt(e.background)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new pr(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new dr(e.fog.color,e.fog.density)));break;case"PerspectiveCamera":a=new Zi(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"OrthographicCamera":a=new jl(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"AmbientLight":a=new Vl(e.color,e.intensity);break;case"DirectionalLight":a=new Gl(e.color,e.intensity);break;case"PointLight":a=new Fl(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":a=new Wl(e.color,e.intensity,e.width,e.height);break;case"SpotLight":a=new kl(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":a=new Il(e.color,e.groundColor,e.intensity);break;case"LightProbe":a=(new Xl).fromJSON(e);break;case"SkinnedMesh":r=o(e.geometry),s=l(e.material),a=new Hr(r,s),void 0!==e.bindMode&&(a.bindMode=e.bindMode),void 0!==e.bindMatrix&&a.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(a.skeleton=e.skeleton);break;case"Mesh":r=o(e.geometry),s=l(e.material),a=new Fi(r,s);break;case"InstancedMesh":r=o(e.geometry),s=l(e.material);const t=e.count,i=e.instanceMatrix;a=new Qr(r,s,t),a.instanceMatrix=new ti(new Float32Array(i.array),16);break;case"LOD":a=new Nr;break;case"Line":a=new as(o(e.geometry),l(e.material));break;case"LineLoop":a=new ls(o(e.geometry),l(e.material));break;case"LineSegments":a=new os(o(e.geometry),l(e.material));break;case"PointCloud":case"Points":a=new ms(o(e.geometry),l(e.material));break;case"Sprite":a=new Or(l(e.material));break;case"Group":a=new sr;break;case"Bone":a=new Gr;break;default:a=new Et}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(a.shadow.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(a.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children){const r=e.children;for(let e=0;e<r.length;e++)a.add(this.parseObject(r[e],t,i,n))}if(void 0!==e.animations){const t=e.animations;for(let e=0;e<t.length;e++){const i=t[e];a.animations.push(n[i])}}if("LOD"===e.type){void 0!==e.autoUpdate&&(a.autoUpdate=e.autoUpdate);const t=e.levels;for(let e=0;e<t.length;e++){const i=t[e],n=a.getObjectByProperty("uuid",i.object);void 0!==n&&a.addLevel(n,i.distance)}}return a}bindSkeletons(e,t){0!==Object.keys(t).length&&e.traverse((function(e){if(!0===e.isSkinnedMesh&&void 0!==e.skeleton){const i=t[e.skeleton];void 0===i?console.warn("THREE.ObjectLoader: No skeleton found with UUID:",e.skeleton):e.bind(i,e.bindMatrix)}}))}setTexturePath(e){return console.warn("THREE.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(e)}},ObjectSpaceNormalMap:1,OctahedronBufferGeometry:lo,OctahedronGeometry:lo,OneFactor:201,OneMinusDstAlphaFactor:207,OneMinusDstColorFactor:209,OneMinusSrcAlphaFactor:205,OneMinusSrcColorFactor:203,OrthographicCamera:jl,PCFShadowMap:1,PCFSoftShadowMap:2,PMREMGenerator:Vh,ParametricBufferGeometry:co,ParametricGeometry:co,Particle:function(e){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new Or(e)},ParticleBasicMaterial:function(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new cs(e)},ParticleSystem:function(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new ms(e,t)},ParticleSystemMaterial:function(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new cs(e)},Path:Al,PerspectiveCamera:Zi,Plane:Rt,PlaneBufferGeometry:sn,PlaneGeometry:sn,PlaneHelper:class extends as{constructor(e,t=1,i=16776960){const n=i,a=new wi;a.setAttribute("position",new hi([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),a.computeBoundingSphere(),super(a,new Kr({color:n,toneMapped:!1})),this.type="PlaneHelper",this.plane=e,this.size=t;const r=new wi;r.setAttribute("position",new hi([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),r.computeBoundingSphere(),this.add(new Fi(r,new Kt({color:n,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(e){let t=-this.plane.constant;Math.abs(t)<1e-8&&(t=1e-8),this.scale.set(.5*this.size,.5*this.size,t),this.children[0].material.side=t<0?1:0,this.lookAt(this.plane.normal),super.updateMatrixWorld(e)}},PointCloud:function(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new ms(e,t)},PointCloudMaterial:function(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new cs(e)},PointLight:Fl,PointLightHelper:class extends Fi{constructor(e,t,i){super(new po(t,4,2),new Kt({wireframe:!0,fog:!1,toneMapped:!1})),this.light=e,this.light.updateMatrixWorld(),this.color=i,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}},Points:ms,PointsMaterial:cs,PolarGridHelper:class extends os{constructor(e=10,t=16,i=8,n=64,a=4473924,r=8947848){a=new Qt(a),r=new Qt(r);const s=[],o=[];for(let i=0;i<=t;i++){const n=i/t*(2*Math.PI),l=Math.sin(n)*e,c=Math.cos(n)*e;s.push(0,0,0),s.push(l,0,c);const h=1&i?a:r;o.push(h.r,h.g,h.b),o.push(h.r,h.g,h.b)}for(let t=0;t<=i;t++){const l=1&t?a:r,c=e-e/i*t;for(let e=0;e<n;e++){let t=e/n*(2*Math.PI),i=Math.sin(t)*c,a=Math.cos(t)*c;s.push(i,0,a),o.push(l.r,l.g,l.b),t=(e+1)/n*(2*Math.PI),i=Math.sin(t)*c,a=Math.cos(t)*c,s.push(i,0,a),o.push(l.r,l.g,l.b)}}const l=new wi;l.setAttribute("position",new hi(s,3)),l.setAttribute("color",new hi(o,3));super(l,new Kr({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}},PolyhedronBufferGeometry:Ss,PolyhedronGeometry:Ss,PositionalAudio:class extends bc{constructor(e){super(e),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(e){return this.panner.refDistance=e,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(e){return this.panner.rolloffFactor=e,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){return this.panner.distanceModel=e,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){return this.panner.maxDistance=e,this}setDirectionalCone(e,t,i){return this.panner.coneInnerAngle=e,this.panner.coneOuterAngle=t,this.panner.coneOuterGain=i,this}updateMatrixWorld(e){if(super.updateMatrixWorld(e),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(_c,xc,wc),Sc.set(0,0,1).applyQuaternion(xc);const t=this.panner;if(t.positionX){const e=this.context.currentTime+this.listener.timeDelta;t.positionX.linearRampToValueAtTime(_c.x,e),t.positionY.linearRampToValueAtTime(_c.y,e),t.positionZ.linearRampToValueAtTime(_c.z,e),t.orientationX.linearRampToValueAtTime(Sc.x,e),t.orientationY.linearRampToValueAtTime(Sc.y,e),t.orientationZ.linearRampToValueAtTime(Sc.z,e)}else t.setPosition(_c.x,_c.y,_c.z),t.setOrientation(Sc.x,Sc.y,Sc.z)}},PropertyBinding:Bc,PropertyMixer:Tc,QuadraticBezierCurve:xl,QuadraticBezierCurve3:wl,Quaternion:Ee,QuaternionKeyframeTrack:Ho,QuaternionLinearInterpolant:jo,REVISION:t,RGBADepthPacking:le,RGBAFormat:I,RGBAIntegerFormat:1033,RGBA_ASTC_10x10_Format:37819,RGBA_ASTC_10x5_Format:37816,RGBA_ASTC_10x6_Format:37817,RGBA_ASTC_10x8_Format:37818,RGBA_ASTC_12x10_Format:37820,RGBA_ASTC_12x12_Format:37821,RGBA_ASTC_4x4_Format:37808,RGBA_ASTC_5x4_Format:37809,RGBA_ASTC_5x5_Format:37810,RGBA_ASTC_6x5_Format:37811,RGBA_ASTC_6x6_Format:37812,RGBA_ASTC_8x5_Format:37813,RGBA_ASTC_8x6_Format:37814,RGBA_ASTC_8x8_Format:37815,RGBA_BPTC_Format:36492,RGBA_ETC2_EAC_Format:W,RGBA_PVRTC_2BPPV1_Format:H,RGBA_PVRTC_4BPPV1_Format:j,RGBA_S3TC_DXT1_Format:N,RGBA_S3TC_DXT3_Format:B,RGBA_S3TC_DXT5_Format:z,RGBDEncoding:se,RGBEEncoding:ne,RGBEFormat:1023,RGBFormat:C,RGBIntegerFormat:1032,RGBM16Encoding:re,RGBM7Encoding:ae,RGB_ETC1_Format:G,RGB_ETC2_Format:V,RGB_PVRTC_2BPPV1_Format:F,RGB_PVRTC_4BPPV1_Format:U,RGB_S3TC_DXT1_Format:k,RGFormat:L,RGIntegerFormat:1031,RawShaderMaterial:wo,Ray:tt,Raycaster:Vc,RectAreaLight:Wl,RedFormat:D,RedIntegerFormat:1029,ReinhardToneMapping:2,RepeatWrapping:d,ReplaceStencilOp:7681,ReverseSubtractEquation:102,RingBufferGeometry:ho,RingGeometry:ho,SRGB8_ALPHA8_ASTC_10x10_Format:37851,SRGB8_ALPHA8_ASTC_10x5_Format:37848,SRGB8_ALPHA8_ASTC_10x6_Format:37849,SRGB8_ALPHA8_ASTC_10x8_Format:37850,SRGB8_ALPHA8_ASTC_12x10_Format:37852,SRGB8_ALPHA8_ASTC_12x12_Format:37853,SRGB8_ALPHA8_ASTC_4x4_Format:37840,SRGB8_ALPHA8_ASTC_5x4_Format:37841,SRGB8_ALPHA8_ASTC_5x5_Format:37842,SRGB8_ALPHA8_ASTC_6x5_Format:37843,SRGB8_ALPHA8_ASTC_6x6_Format:37844,SRGB8_ALPHA8_ASTC_8x5_Format:37845,SRGB8_ALPHA8_ASTC_8x6_Format:37846,SRGB8_ALPHA8_ASTC_8x8_Format:37847,Scene:mr,SceneUtils:$h,ShaderChunk:on,ShaderLib:cn,ShaderMaterial:Yi,ShadowMaterial:xo,Shape:El,ShapeBufferGeometry:uo,ShapeGeometry:uo,ShapePath:nc,ShapeUtils:to,ShortType:1011,Skeleton:Yr,SkeletonHelper:ah,SkinnedMesh:Hr,SmoothShading:2,Sphere:Xe,SphereBufferGeometry:po,SphereGeometry:po,Spherical:Xc,SphericalHarmonics3:Yl,SplineCurve:Sl,SpotLight:kl,SpotLightHelper:class extends Et{constructor(e,t){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;const i=new wi,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let e=0,t=1,i=32;e<i;e++,t++){const a=e/i*Math.PI*2,r=t/i*Math.PI*2;n.push(Math.cos(a),Math.sin(a),1,Math.cos(r),Math.sin(r),1)}i.setAttribute("position",new hi(n,3));const a=new Kr({fog:!1,toneMapped:!1});this.cone=new os(i,a),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateMatrixWorld();const e=this.light.distance?this.light.distance:1e3,t=e*Math.tan(this.light.angle);this.cone.scale.set(t,t,e),eh.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(eh),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}},Sprite:Or,SpriteMaterial:vr,SrcAlphaFactor:204,SrcAlphaSaturateFactor:210,SrcColorFactor:202,StaticCopyUsage:35046,StaticDrawUsage:he,StaticReadUsage:35045,StereoCamera:class{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Zi,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Zi,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){const t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep;const i=e.projectionMatrix.clone(),n=t.eyeSep/2,a=n*t.near/t.focus,r=t.near*Math.tan(ge.DEG2RAD*t.fov*.5)/t.zoom;let s,o;dc.elements[12]=-n,uc.elements[12]=n,s=-r*t.aspect+a,o=r*t.aspect+a,i.elements[0]=2*t.near/(o-s),i.elements[8]=(o+s)/(o-s),this.cameraL.projectionMatrix.copy(i),s=-r*t.aspect-a,o=r*t.aspect-a,i.elements[0]=2*t.near/(o-s),i.elements[8]=(o+s)/(o-s),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(dc),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(uc)}},StreamCopyUsage:35042,StreamDrawUsage:35040,StreamReadUsage:35041,StringKeyframeTrack:Go,SubtractEquation:101,SubtractiveBlending:3,TOUCH:n,TangentSpaceNormalMap:0,TetrahedronBufferGeometry:mo,TetrahedronGeometry:mo,TextBufferGeometry:fo,TextGeometry:fo,Texture:we,TextureLoader:al,TorusBufferGeometry:go,TorusGeometry:go,TorusKnotBufferGeometry:yo,TorusKnotGeometry:yo,Triangle:Ht,TriangleFanDrawMode:2,TriangleStripDrawMode:1,TrianglesDrawMode:0,TubeBufferGeometry:vo,TubeGeometry:vo,UVMapping:r,Uint16Attribute:function(e,t){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new si(e,t)},Uint16BufferAttribute:si,Uint32Attribute:function(e,t){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new li(e,t)},Uint32BufferAttribute:li,Uint8Attribute:function(e,t){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new ni(e,t)},Uint8BufferAttribute:ni,Uint8ClampedAttribute:function(e,t){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new ai(e,t)},Uint8ClampedBufferAttribute:ai,Uniform:jc,UniformsLib:ln,UniformsUtils:Wi,UnsignedByteType:w,UnsignedInt248Type:E,UnsignedIntType:M,UnsignedShort4444Type:1017,UnsignedShort5551Type:1018,UnsignedShort565Type:1019,UnsignedShortType:S,VSMShadowMap:3,Vector2:ye,Vector3:Ce,Vector4:Me,VectorKeyframeTrack:Vo,Vertex:function(e,t,i){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new Ce(e,t,i)},VertexColors:2,VideoTexture:gs,WebGL1Renderer:ur,WebGLCubeRenderTarget:Ki,WebGLMultisampleRenderTarget:Ae,WebGLRenderTarget:Te,WebGLRenderTargetCube:function(e,t,i){return console.warn("THREE.WebGLRenderTargetCube( width, height, options ) is now WebGLCubeRenderTarget( size, options )."),new Ki(e,i)},WebGLRenderer:hr,WebGLUtils:ar,WireframeGeometry:bo,WireframeHelper:function(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new os(new bo(e.geometry),new Kr({color:void 0!==t?t:16777215}))},WrapAroundEnding:Q,XHRLoader:function(e){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new $o(e)},ZeroCurvatureEnding:q,ZeroFactor:200,ZeroSlopeEnding:J,ZeroStencilOp:0,sRGBEncoding:te}),tu=function(e){el.call(this,e)};tu.prototype=Object.assign(Object.create(el.prototype),{constructor:tu,parse:function(e,t){var i={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function a(e,t,i,n){for(var a=i*n*4,r=new Uint8Array(e,t,a),s=new Uint8Array(a),o=0,l=0,c=0;c<n;c++)for(var h=0;h<i;h++){var u=r[l],d=r[++l],p=r[++l],m=r[++l];l++,s[o]=p,s[++o]=d,s[++o]=u,s[++o]=m,o++}return s}var r,s=n("DXT1"),o=n("DXT3"),l=n("DXT5"),c=n("ETC1"),h=new Int32Array(e,0,31);if(542327876!==h[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),i;if(4&!h[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),i;var u,d=h[21],p=!1;switch(d){case s:r=8,i.format=k;break;case o:r=16,i.format=B;break;case l:r=16,i.format=z;break;case c:r=8,i.format=G;break;default:if(!(32===h[22]&&16711680&h[23]&&65280&h[24]&&255&h[25]&&4278190080&h[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",(u=d,String.fromCharCode(255&u,u>>8&255,u>>16&255,u>>24&255))),i;p=!0,r=64,i.format=I}i.mipmapCount=1,131072&h[2]&&!1!==t&&(i.mipmapCount=Math.max(1,h[7]));var m=h[28];if(i.isCubemap=!!(512&m),i.isCubemap&&(!(1024&m)||!(2048&m)||!(4096&m)||!(8192&m)||!(16384&m)||!(32768&m)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),i;i.width=h[4],i.height=h[3];for(var f=h[1]+4,g=i.isCubemap?6:1,y=0;y<g;y++)for(var v=i.width,b=i.height,_=0;_<i.mipmapCount;_++){if(p)var x=(w=a(e,f,v,b)).length;else{x=Math.max(4,v)/4*Math.max(4,b)/4*r;var w=new Uint8Array(e,f,x)}var S={data:w,width:v,height:b};i.mipmaps.push(S),f+=x,v=Math.max(v>>1,1),b=Math.max(b>>1,1)}return i}});var iu=function(e){Qo.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};iu.prototype=Object.assign(Object.create(Qo.prototype),{constructor:iu,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(e,t,i,n){var a=new $o(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(e=>{var i={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,i).then(t).catch(n)}),i,n)},decodeDracoFile:function(e,t,i,n){var a={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,a).then(t)},decodeGeometry:function(e,t){for(var i in t.attributeTypes){var n=t.attributeTypes[i];void 0!==n.BYTES_PER_ELEMENT&&(t.attributeTypes[i]=n.name)}var a,r=JSON.stringify(t);if(iu.taskCache.has(e)){var s=iu.taskCache.get(e);if(s.key===r)return s.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var o=this.workerNextTaskID++,l=e.byteLength,c=this._getWorker(o,l).then((i=>(a=i,new Promise(((i,n)=>{a._callbacks[o]={resolve:i,reject:n},a.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return c.catch((()=>!0)).then((()=>{a&&o&&this._releaseTask(a,o)})),iu.taskCache.set(e,{key:r,promise:c}),c},_createGeometry:function(e){var t=new wi;e.index&&t.setIndex(new ti(e.index.array,1));for(var i=0;i<e.attributes.length;i++){var n=e.attributes[i],a=n.name,r=n.array,s=n.itemSize;t.setAttribute(a,new ti(r,s))}return t},_loadLibrary:function(e,t){var i=new $o(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise(((t,n)=>{i.load(e,t,void 0,n)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{var i=t[0];e||(this.decoderConfig.wasmBinary=t[1]);var n=iu.DRACOWorker.toString(),a=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a]))})),this.decoderPending},_getWorker:function(e,t){return this._initDecoder().then((()=>{var i;this.workerPool.length<this.workerLimit?((i=new Worker(this.workerSourceURL))._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(e){var t=e.data;switch(t.type){case"decode":i._callbacks[t.id].resolve(t);break;case"error":i._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(i)):this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));return(i=this.workerPool[this.workerPool.length-1])._taskCosts[e]=t,i._taskLoad+=t,i}))},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),iu.DRACOWorker=function(){var e,t;function i(e,t,i,n,a,r){var s=r.num_components(),o=i.num_points()*s,l=o*a.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,a),h=e._malloc(l);t.GetAttributeDataArrayForAllPoints(i,r,c,l,h);var u=new a(e.HEAPF32.buffer,h,o).slice();return e._free(h),{name:n,array:u,itemSize:s}}onmessage=function(n){var a=n.data;switch(a.type){case"init":e=a.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":var r=a.buffer,s=a.taskConfig;t.then((e=>{var t=e.draco,n=new t.Decoder,o=new t.DecoderBuffer;o.Init(new Int8Array(r),r.byteLength);try{var l=function(e,t,n,a){var r,s,o=a.attributeIDs,l=a.attributeTypes,c=t.GetEncodedGeometryType(n);if(c===e.TRIANGULAR_MESH)r=new e.Mesh,s=t.DecodeBufferToMesh(n,r);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");r=new e.PointCloud,s=t.DecodeBufferToPointCloud(n,r)}if(!s.ok()||0===r.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+s.error_msg());var h={index:null,attributes:[]};for(var u in o){var d,p,m=self[l[u]];if(a.useUniqueIDs)p=o[u],d=t.GetAttributeByUniqueId(r,p);else{if(-1===(p=t.GetAttributeId(r,e[o[u]])))continue;d=t.GetAttribute(r,p)}h.attributes.push(i(e,t,r,u,m,d))}c===e.TRIANGULAR_MESH&&(h.index=function(e,t,i){var n=3*i.num_faces(),a=4*n,r=e._malloc(a);t.GetTrianglesUInt32Array(i,a,r);var s=new Uint32Array(e.HEAPF32.buffer,r,n).slice();return e._free(r),{array:s,itemSize:1}}(e,t,r));return e.destroy(r),h}(t,n,o,s),c=l.attributes.map((e=>e.array.buffer));l.index&&c.push(l.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:l},c)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}finally{t.destroy(o),t.destroy(n)}}))}}},iu.taskCache=new WeakMap,iu.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},iu.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},iu.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},iu.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};var nu,au,ru=function(){function e(){this.pluginCallbacks=[],this.register((function(e){return new P(e)})),this.register((function(e){return new R(e)})),this.register((function(e){return new O(e)}))}e.prototype={constructor:e,register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,i){for(var n=new E,a=[],r=0,s=this.pluginCallbacks.length;r<s;r++)a.push(this.pluginCallbacks[r](n));n.setPlugins(a),n.write(e,t,i)}};var t=0,i=1,n=2,a=3,r=4,s=5121,o=5123,l=5126,c=5125,h=34962,u=34963,d=9728,p=9729,m=9984,f=9985,g=9986,y=9987,v=33071,b=33648,_=10497,x={};x[1003]=d,x[1004]=m,x[1005]=g,x[1006]=p,x[1007]=f,x[1008]=y,x[1001]=v,x[1e3]=_,x[1002]=b;var w={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};function S(e,t){return e.length===t.length&&e.every((function(e,i){return e===t[i]}))}function M(e){return 4*Math.ceil(e/4)}function T(e,t){t=t||0;var i=M(e.byteLength);if(i!==e.byteLength){var n=new Uint8Array(i);if(n.set(new Uint8Array(e)),0!==t)for(var a=e.byteLength;a<i;a++)n[a]=t;return n.buffer}return e}var A=null;function E(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}function P(e){this.writer=e,this.name="KHR_lights_punctual"}function R(e){this.writer=e,this.name="KHR_materials_unlit"}function O(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}return E.prototype={constructor:E,setPlugins:function(e){this.plugins=e},write:function(e,t,i){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},i),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);var n=this;Promise.all(this.pending).then((function(){var e,i=n.buffers,a=n.json,r=n.options,s=n.extensionsUsed,o=new Blob(i,{type:"application/octet-stream"}),l=Object.keys(s);(l.length>0&&(a.extensionsUsed=l),a.buffers&&a.buffers.length>0&&(a.buffers[0].byteLength=o.size),!0===r.binary)?((e=new window.FileReader).readAsArrayBuffer(o),e.onloadend=function(){var i=T(e.result),n=new DataView(new ArrayBuffer(8));n.setUint32(0,i.byteLength,!0),n.setUint32(4,5130562,!0);var r=T(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),i=0,n=e.length;i<n;i++){var a=e.charCodeAt(i);t[i]=a>255?32:a}return t.buffer}(JSON.stringify(a)),32),s=new DataView(new ArrayBuffer(8));s.setUint32(0,r.byteLength,!0),s.setUint32(4,1313821514,!0);var o=new ArrayBuffer(12),l=new DataView(o);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);var c=12+s.byteLength+r.byteLength+n.byteLength+i.byteLength;l.setUint32(8,c,!0);var h=new Blob([o,s,r,n,i],{type:"application/octet-stream"}),u=new window.FileReader;u.readAsArrayBuffer(h),u.onloadend=function(){t(u.result)}}):a.buffers&&a.buffers.length>0?((e=new window.FileReader).readAsDataURL(o),e.onloadend=function(){var i=e.result;a.buffers[0].uri=i,t(a)}):t(a)}))},serializeUserData:function(e,t){if(0!==Object.keys(e.userData).length){var i=this.options,n=this.extensionsUsed;try{var a=JSON.parse(JSON.stringify(e.userData));if(i.includeCustomExtensions&&a.gltfExtensions){for(var r in void 0===t.extensions&&(t.extensions={}),a.gltfExtensions)t.extensions[r]=a.gltfExtensions[r],n[r]=!0;delete a.gltfExtensions}Object.keys(a).length>0&&(t.extras=a)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}},getUID:function(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)},isNormalizedNormalAttribute:function(e){if(this.cache.attributesNormalized.has(e))return!1;for(var t=new Ce,i=0,n=e.count;i<n;i++)if(Math.abs(t.fromBufferAttribute(e,i).length()-1)>5e-4)return!1;return!0},createNormalizedNormalAttribute:function(e){var t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);for(var i=e.clone(),n=new Ce,a=0,r=i.count;a<r;a++)n.fromBufferAttribute(i,a),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),i.setXYZ(a,n.x,n.y,n.z);return t.attributesNormalized.set(e,i),i},applyTextureTransform:function(e,t){var i=!1,n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),i=!0),0!==t.rotation&&(n.rotation=t.rotation,i=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),i=!0),i&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)},processBuffer:function(e){var t=this.json,i=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),i.push(e),0},processBufferView:function(e,t,i,n,a){var r,u=this.json;u.bufferViews||(u.bufferViews=[]),r=t===s?1:t===o?2:4;for(var d=M(n*e.itemSize*r),p=new DataView(new ArrayBuffer(d)),m=0,f=i;f<i+n;f++)for(var g=0;g<e.itemSize;g++){var y;e.itemSize>4?y=e.array[f*e.itemSize+g]:0===g?y=e.getX(f):1===g?y=e.getY(f):2===g?y=e.getZ(f):3===g&&(y=e.getW(f)),t===l?p.setFloat32(m,y,!0):t===c?p.setUint32(m,y,!0):t===o?p.setUint16(m,y,!0):t===s&&p.setUint8(m,y),m+=r}var v={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:d};return void 0!==a&&(v.target=a),a===h&&(v.byteStride=e.itemSize*r),this.byteOffset+=d,u.bufferViews.push(v),{id:u.bufferViews.length-1,byteLength:0}},processBufferViewImage:function(e){var t=this,i=t.json;return i.bufferViews||(i.bufferViews=[]),new Promise((function(n){var a=new window.FileReader;a.readAsArrayBuffer(e),a.onloadend=function(){var e=T(a.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(i.bufferViews.push(r)-1)}}))},processAccessor:function(e,t,i,n){var a,r=this.options,d=this.json;if(e.array.constructor===Float32Array)a=l;else if(e.array.constructor===Uint32Array)a=c;else if(e.array.constructor===Uint16Array)a=o;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");a=s}if(void 0===i&&(i=0),void 0===n&&(n=e.count),r.truncateDrawRange&&void 0!==t&&null===t.index){var p=i+n,m=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;i=Math.max(i,t.drawRange.start),(n=Math.min(p,m)-i)<0&&(n=0)}if(0===n)return null;var f,g=function(e,t,i){for(var n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},a=t;a<t+i;a++)for(var r=0;r<e.itemSize;r++){var s;e.itemSize>4?s=e.array[a*e.itemSize+r]:0===r?s=e.getX(a):1===r?s=e.getY(a):2===r?s=e.getZ(a):3===r&&(s=e.getW(a)),n.min[r]=Math.min(n.min[r],s),n.max[r]=Math.max(n.max[r],s)}return n}(e,i,n);void 0!==t&&(f=e===t.index?u:h);var y=this.processBufferView(e,a,i,n,f),v={bufferView:y.id,byteOffset:y.byteOffset,componentType:a,count:n,max:g.max,min:g.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(v.normalized=!0),d.accessors||(d.accessors=[]),d.accessors.push(v)-1},processImage:function(e,t,i){var n=this,a=n.cache,r=n.json,s=n.options,o=n.pending;a.images.has(e)||a.images.set(e,{});var l=a.images.get(e),c=t===I?"image/png":"image/jpeg",h=c+":flipY/"+i.toString();if(void 0!==l[h])return l[h];r.images||(r.images=[]);var u={mimeType:c};if(s.embedImages){var d=A=A||document.createElement("canvas");d.width=Math.min(e.width,s.maxTextureSize),d.height=Math.min(e.height,s.maxTextureSize);var p=d.getContext("2d");if(!0===i&&(p.translate(0,d.height),p.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)p.drawImage(e,0,0,d.width,d.height);else{t!==I&&t!==C&&console.error("GLTFExporter: Only RGB and RGBA formats are supported."),(e.width>s.maxTextureSize||e.height>s.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);var m=e.data;if(t===C){m=new Uint8ClampedArray(e.height*e.width*4);for(var f=0,g=0;f<m.length;f+=4,g+=3)m[f+0]=e.data[g+0],m[f+1]=e.data[g+1],m[f+2]=e.data[g+2],m[f+3]=255}p.putImageData(new ImageData(m,e.width,e.height),0,0)}!0===s.binary?o.push(new Promise((function(e){d.toBlob((function(t){n.processBufferViewImage(t).then((function(t){u.bufferView=t,e()}))}),c)}))):u.uri=d.toDataURL(c)}else u.uri=e.src;var y=r.images.push(u)-1;return l[h]=y,y},processSampler:function(e){var t=this.json;t.samplers||(t.samplers=[]);var i={magFilter:x[e.magFilter],minFilter:x[e.minFilter],wrapS:x[e.wrapS],wrapT:x[e.wrapT]};return t.samplers.push(i)-1},processTexture:function(e){var t=this.cache,i=this.json;if(t.textures.has(e))return t.textures.get(e);i.textures||(i.textures=[]);var n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(n.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,n)}));var a=i.textures.push(n)-1;return t.textures.set(e,a),a},processMaterial:function(e){var t=this.cache,i=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;i.materials||(i.materials=[]);var n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var a=e.color.toArray().concat([e.opacity]);if(S(a,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=a),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap){var r={index:this.processTexture(e.metalnessMap)};this.applyTextureTransform(r,e.metalnessMap),n.pbrMetallicRoughness.metallicRoughnessTexture=r}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){var s={index:this.processTexture(e.map)};this.applyTextureTransform(s,e.map),n.pbrMetallicRoughness.baseColorTexture=s}if(e.emissive){var o=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(S(o,[0,0,0])||(n.emissiveFactor=o),e.emissiveMap){var l={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(l,e.emissiveMap),n.emissiveTexture=l}}if(e.normalMap){var c={index:this.processTexture(e.normalMap)};e.normalScale&&-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),c.scale=e.normalScale.x),this.applyTextureTransform(c,e.normalMap),n.normalTexture=c}if(e.aoMap){var h={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(h.strength=e.aoMapIntensity),this.applyTextureTransform(h,e.aoMap),n.occlusionTexture=h}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),2===e.side&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,n)}));var u=i.materials.push(n)-1;return t.materials.set(e,u),u},processMesh:function(e){var s=this.cache,o=this.json,l=[e.geometry.uuid];if(Array.isArray(e.material))for(var c=0,h=e.material.length;c<h;c++)l.push(e.material[c].uuid);else l.push(e.material.uuid);var u=l.join(":");if(s.meshes.has(u))return s.meshes.get(u);var d,p=e.geometry;if(d=e.isLineSegments?i:e.isLineLoop?n:e.isLine?a:e.isPoints?t:e.material.wireframe?i:r,!0!==p.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");var m={},f={},g=[],y=[],v={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},b=p.getAttribute("normal");void 0===b||this.isNormalizedNormalAttribute(b)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),p.setAttribute("normal",this.createNormalizedNormalAttribute(b)));var _=null;for(var x in p.attributes)if("morph"!==x.substr(0,5)){var w=p.attributes[x];x=v[x]||x.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(x)||(x="_"+x),s.attributes.has(this.getUID(w)))f[x]=s.attributes.get(this.getUID(w));else{_=null;var S=w.array;"JOINTS_0"!==x||S instanceof Uint16Array||S instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),_=new ti(new Uint16Array(S),w.itemSize,w.normalized));var M=this.processAccessor(_||w,p);null!==M&&(f[x]=M,s.attributes.set(this.getUID(w),M))}}if(void 0!==b&&p.setAttribute("normal",b),0===Object.keys(f).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var T=[],A=[],E={};if(void 0!==e.morphTargetDictionary)for(var C in e.morphTargetDictionary)E[e.morphTargetDictionary[C]]=C;for(c=0;c<e.morphTargetInfluences.length;++c){var I={},P=!1;for(var x in p.morphAttributes)if("position"===x||"normal"===x){w=p.morphAttributes[x][c];var R=x.toUpperCase(),O=p.attributes[x];if(s.attributes.has(this.getUID(w)))I[R]=s.attributes.get(this.getUID(w));else{var D=w.clone();if(!p.morphTargetsRelative)for(var L=0,k=w.count;L<k;L++)D.setXYZ(L,w.getX(L)-O.getX(L),w.getY(L)-O.getY(L),w.getZ(L)-O.getZ(L));I[R]=this.processAccessor(D,p),s.attributes.set(this.getUID(O),I[R])}}else P||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),P=!0);y.push(I),T.push(e.morphTargetInfluences[c]),void 0!==e.morphTargetDictionary&&A.push(E[c])}m.weights=T,A.length>0&&(m.extras={},m.extras.targetNames=A)}var N=Array.isArray(e.material);if(N&&0===p.groups.length)return null;for(var B=N?e.material:[e.material],z=N?p.groups:[{materialIndex:0,start:void 0,count:void 0}],U=(c=0,z.length);c<U;c++){var F={mode:d,attributes:f};if(this.serializeUserData(p,F),y.length>0&&(F.targets=y),null!==p.index){var j=this.getUID(p.index);void 0===z[c].start&&void 0===z[c].count||(j+=":"+z[c].start+":"+z[c].count),s.attributes.has(j)?F.indices=s.attributes.get(j):(F.indices=this.processAccessor(p.index,p,z[c].start,z[c].count),s.attributes.set(j,F.indices)),null===F.indices&&delete F.indices}var H=this.processMaterial(B[z[c].materialIndex]);null!==H&&(F.material=H),g.push(F)}m.primitives=g,o.meshes||(o.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,m)}));var G=o.meshes.push(m)-1;return s.meshes.set(u,G),G},processCamera:function(e){var t=this.json;t.cameras||(t.cameras=[]);var i=e.isOrthographicCamera,n={type:i?"orthographic":"perspective"};return i?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:ge.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1},processAnimation:function(t,i){var n=this.json,a=this.nodeMap;n.animations||(n.animations=[]);for(var r=(t=e.Utils.mergeMorphTargetTracks(t.clone(),i)).tracks,s=[],o=[],l=0;l<r.length;++l){var c=r[l],h=Bc.parseTrackName(c.name),u=Bc.findNode(i,h.nodeName),d=w[h.propertyName];if("bones"===h.objectName&&(u=!0===u.isSkinnedMesh?u.skeleton.getBoneByName(h.objectIndex):void 0),!u||!d)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',c.name),null;var p,m=c.values.length/c.times.length;d===w.morphTargetInfluences&&(m/=u.morphTargetInfluences.length),!0===c.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(p="CUBICSPLINE",m/=3):p=c.getInterpolation()===Y?"STEP":"LINEAR",o.push({input:this.processAccessor(new ti(c.times,1)),output:this.processAccessor(new ti(c.values,m)),interpolation:p}),s.push({sampler:o.length-1,target:{node:a.get(u),path:d}})}return n.animations.push({name:t.name||"clip_"+n.animations.length,samplers:o,channels:s}),n.animations.length-1},processSkin:function(e){var t=this.json,i=this.nodeMap,n=t.nodes[i.get(e)],a=e.skeleton;if(void 0===a)return null;var r=e.skeleton.bones[0];if(void 0===r)return null;for(var s=[],o=new Float32Array(16*a.bones.length),l=new it,c=0;c<a.bones.length;++c)s.push(i.get(a.bones[c])),l.copy(a.boneInverses[c]),l.multiply(e.bindMatrix).toArray(o,16*c);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new ti(o,16)),joints:s,skeleton:i.get(r)}),n.skin=t.skins.length-1},processNode:function(e){var t=this.json,i=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);var a={};if(i.trs){var r=e.quaternion.toArray(),s=e.position.toArray(),o=e.scale.toArray();S(r,[0,0,0,1])||(a.rotation=r),S(s,[0,0,0])||(a.translation=s),S(o,[1,1,1])||(a.scale=o)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===function(e){return S(e.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}(e.matrix)&&(a.matrix=e.matrix.elements);if(""!==e.name&&(a.name=String(e.name)),this.serializeUserData(e,a),e.isMesh||e.isLine||e.isPoints){var l=this.processMesh(e);null!==l&&(a.mesh=l)}else e.isCamera&&(a.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){for(var c=[],h=0,u=e.children.length;h<u;h++){var d=e.children[h];if(d.visible||!1===i.onlyVisible)null!==(p=this.processNode(d))&&c.push(p)}c.length>0&&(a.children=c)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,a)}));var p=t.nodes.push(a)-1;return n.set(e,p),p},processScene:function(e){var t=this.json,i=this.options;t.scenes||(t.scenes=[],t.scene=0);var n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);for(var a=[],r=0,s=e.children.length;r<s;r++){var o=e.children[r];if(o.visible||!1===i.onlyVisible){var l=this.processNode(o);null!==l&&a.push(l)}}a.length>0&&(n.nodes=a),this.serializeUserData(e,n)},processObjects:function(e){var t=new mr;t.name="AuxScene";for(var i=0;i<e.length;i++)t.children.push(e[i]);this.processScene(t)},processInput:function(e){var t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));for(var i=[],n=0;n<e.length;n++)e[n]instanceof mr?this.processScene(e[n]):i.push(e[n]);i.length>0&&this.processObjects(i);for(n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))},_invokeAll:function(e){for(var t=0,i=this.plugins.length;t<i;t++)e(this.plugins[t])}},P.prototype={constructor:P,writeNode:function(e,t){if(e.isLight)if(e.isDirectionalLight||e.isPointLight||e.isSpotLight){var i=this.writer,n=i.json,a=i.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),a[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},a[this.name]=!0);var s=n.extensions[this.name].lights;s.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}else console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e)}},R.prototype={constructor:R,writeMaterial:function(e,t){if(e.isMeshBasicMaterial){var i=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},i[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}},O.prototype={constructor:O,writeMaterial:function(e,t){if(e.isGLTFSpecularGlossinessMaterial){var i=this.writer,n=i.extensionsUsed,a={};t.pbrMetallicRoughness.baseColorFactor&&(a.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);var r=[1,1,1];if(e.specular.toArray(r,0),a.specularFactor=r,a.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(a.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){var s={index:i.processTexture(e.specularMap)};i.applyTextureTransform(s,e.specularMap),a.specularGlossinessTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}},e.Utils={insertKeyframe:function(e,t){var i,n=.001,a=e.getValueSize(),r=new e.TimeBufferType(e.times.length+1),s=new e.ValueBufferType(e.values.length+a),o=e.createInterpolant(new e.ValueBufferType(a));if(0===e.times.length){r[0]=t;for(var l=0;l<a;l++)s[l]=0;i=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<n)return 0;r[0]=t,r.set(e.times,1),s.set(o.evaluate(t),0),s.set(e.values,a),i=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<n)return e.times.length-1;r[r.length-1]=t,r.set(e.times,0),s.set(e.values,0),s.set(o.evaluate(t),e.values.length),i=r.length-1}else for(l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<n)return l;if(e.times[l]<t&&e.times[l+1]>t){r.set(e.times.slice(0,l+1),0),r[l+1]=t,r.set(e.times.slice(l+1),l+2),s.set(e.values.slice(0,(l+1)*a),0),s.set(o.evaluate(t),(l+1)*a),s.set(e.values.slice((l+1)*a),(l+2)*a),i=l+1;break}}return e.times=r,e.values=s,i},mergeMorphTargetTracks:function(e,t){for(var i=[],n={},a=e.tracks,r=0;r<a.length;++r){var s=a[r],o=Bc.parseTrackName(s.name),l=Bc.findNode(t,o.nodeName);if("morphTargetInfluences"===o.propertyName&&void 0!==o.propertyIndex){if(s.createInterpolant!==s.InterpolantFactoryMethodDiscrete&&s.createInterpolant!==s.InterpolantFactoryMethodLinear){if(s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(s=s.clone()).setInterpolation(X)}var c,h=l.morphTargetInfluences.length,u=l.morphTargetDictionary[o.propertyIndex];if(void 0===u)throw new Error("THREE.GLTFExporter: Morph target name not found: "+o.propertyIndex);if(void 0!==n[l.uuid]){var d=s.createInterpolant(new s.ValueBufferType(1));c=n[l.uuid];for(f=0;f<c.times.length;f++)c.values[f*h+u]=d.evaluate(c.times[f]);for(f=0;f<s.times.length;f++){var p=this.insertKeyframe(c,s.times[f]);c.values[p*h+u]=s.values[f]}}else{for(var m=new((c=s.clone()).ValueBufferType)(h*c.times.length),f=0;f<c.times.length;f++)m[f*h+u]=c.values[f];c.name=(o.nodeName||"")+".morphTargetInfluences",c.values=m,n[l.uuid]=c,i.push(c)}}else i.push(s)}return e.tracks=i,e}},e}(),su=function(){Jl.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new hi([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new hi([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))};su.prototype=Object.assign(Object.create(Jl.prototype),{constructor:su,isLineSegmentsGeometry:!0,applyMatrix4:function(e){var t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var i=new Hc(t,6,1);return this.setAttribute("instanceStart",new yr(i,3,0)),this.setAttribute("instanceEnd",new yr(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var i=new Hc(t,6,1);return this.setAttribute("instanceColorStart",new yr(i,3,0)),this.setAttribute("instanceColorEnd",new yr(i,3,3)),this},fromWireframeGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromEdgesGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromMesh:function(e){return this.fromWireframeGeometry(new bo(e.geometry)),this},fromLineSegments:function(e){var t=e.geometry;if(!t.isGeometry)return t.isBufferGeometry&&this.setPositions(t.attributes.position.array),this;console.error("THREE.LineSegmentsGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.")},computeBoundingBox:(au=new Re,function(){null===this.boundingBox&&(this.boundingBox=new Re);var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;void 0!==e&&void 0!==t&&(this.boundingBox.setFromBufferAttribute(e),au.setFromBufferAttribute(t),this.boundingBox.union(au))}),computeBoundingSphere:(nu=new Ce,function(){null===this.boundingSphere&&(this.boundingSphere=new Xe),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var n=0,a=0,r=e.count;a<r;a++)nu.fromBufferAttribute(e,a),n=Math.max(n,i.distanceToSquared(nu)),nu.fromBufferAttribute(t,a),n=Math.max(n,i.distanceToSquared(nu));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},applyMatrix:function(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}),ln.line={linewidth:{value:1},resolution:{value:new ye(1,1)},dashScale:{value:1},dashSize:{value:1},dashOffset:{value:0},gapSize:{value:1},opacity:{value:1}},cn.line={uniforms:Wi.merge([ln.common,ln.fog,ln.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};var ou=function(e){Yi.call(this,{type:"LineMaterial",uniforms:Wi.clone(cn.line.uniforms),vertexShader:cn.line.vertexShader,fragmentShader:cn.line.fragmentShader,clipping:!0}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}}}),this.setValues(e)};(ou.prototype=Object.create(Yi.prototype)).constructor=ou,ou.prototype.isLineMaterial=!0;var lu=function(e,t){void 0===e&&(e=new su),void 0===t&&(t=new ou({color:16777215*Math.random()})),Fi.call(this,e,t),this.type="LineSegments2"};lu.prototype=Object.assign(Object.create(Fi.prototype),{constructor:lu,isLineSegments2:!0,computeLineDistances:function(){var e=new Ce,t=new Ce;return function(){for(var i=this.geometry,n=i.attributes.instanceStart,a=i.attributes.instanceEnd,r=new Float32Array(2*n.data.count),s=0,o=0,l=n.data.count;s<l;s++,o+=2)e.fromBufferAttribute(n,s),t.fromBufferAttribute(a,s),r[o]=0===o?0:r[o-1],r[o+1]=r[o]+e.distanceTo(t);var c=new Hc(r,2,1);return i.setAttribute("instanceDistanceStart",new yr(c,1,0)),i.setAttribute("instanceDistanceEnd",new yr(c,1,1)),this}}(),raycast:function(){var e=new Me,t=new Me,i=new Me,n=new Ce,a=new it,r=new Kc,s=new Ce;return function(o,l){null===o.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var c=void 0!==o.params.Line2&&o.params.Line2.threshold||0,h=o.ray,u=o.camera,d=u.projectionMatrix,p=this.geometry,m=this.material,f=m.resolution,g=m.linewidth+c,y=p.attributes.instanceStart,v=p.attributes.instanceEnd,b=-u.near;h.at(1,i),i.w=1,i.applyMatrix4(u.matrixWorldInverse),i.applyMatrix4(d),i.multiplyScalar(1/i.w),i.x*=f.x/2,i.y*=f.y/2,i.z=0,n.copy(i);var _=this.matrixWorld;a.multiplyMatrices(u.matrixWorldInverse,_);for(var x=0,w=y.count;x<w;x++){if(e.fromBufferAttribute(y,x),t.fromBufferAttribute(v,x),e.w=1,t.w=1,e.applyMatrix4(a),t.applyMatrix4(a),!(e.z>b&&t.z>b)){if(e.z>b){const i=e.z-t.z,n=(e.z-b)/i;e.lerp(t,n)}else if(t.z>b){const i=t.z-e.z,n=(t.z-b)/i;t.lerp(e,n)}e.applyMatrix4(d),t.applyMatrix4(d),e.multiplyScalar(1/e.w),t.multiplyScalar(1/t.w),e.x*=f.x/2,e.y*=f.y/2,t.x*=f.x/2,t.y*=f.y/2,r.start.copy(e),r.start.z=0,r.end.copy(t),r.end.z=0;var S=r.closestPointToPointParameter(n,!0);r.at(S,s);var M=ge.lerp(e.z,t.z,S),T=M>=-1&&M<=1,A=n.distanceTo(s)<.5*g;if(T&&A){r.start.fromBufferAttribute(y,x),r.end.fromBufferAttribute(v,x),r.start.applyMatrix4(_),r.end.applyMatrix4(_);var E=new Ce,C=new Ce;h.distanceSqToSegment(r.start,r.end,C,E),l.push({point:C,pointOnLine:E,distance:h.origin.distanceTo(C),object:this,face:null,faceIndex:x,uv:null,uv2:null})}}}}}()});var cu=function(){su.call(this),this.type="LineGeometry"};cu.prototype=Object.assign(Object.create(su.prototype),{constructor:cu,isLineGeometry:!0,setPositions:function(e){for(var t=e.length-3,i=new Float32Array(2*t),n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return su.prototype.setPositions.call(this,i),this},setColors:function(e){for(var t=e.length-3,i=new Float32Array(2*t),n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return su.prototype.setColors.call(this,i),this},fromLine:function(e){var t=e.geometry;if(!t.isGeometry)return t.isBufferGeometry&&this.setPositions(t.attributes.position.array),this;console.error("THREE.LineGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.")},copy:function(){return this}});var hu=function(e,t){void 0===e&&(e=new cu),void 0===t&&(t=new ou({color:16777215*Math.random()})),lu.call(this,e,t),this.type="Line2"};hu.prototype=Object.assign(Object.create(lu.prototype),{constructor:hu,isLine2:!0});var uu=function(e){Qo.call(this,e)};uu.prototype=Object.assign(Object.create(Qo.prototype),{constructor:uu,load:function(e,t,i,n){var a=this,r=new we,s=new $o(this.manager);return s.setResponseType("arraybuffer"),s.setPath(this.path),s.setWithCredentials(this.withCredentials),s.load(e,(function(e){r.image=a.parse(e),r.needsUpdate=!0,void 0!==t&&t(r)}),i,n),r},parse:function(e){var t=0,i=1,n=2,a=3,r=9,s=10,o=11,l=48,c=4,h=0,u=1,d=2,p=3;e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");var m=new Uint8Array(e),f=0,g={id_length:m[f++],colormap_type:m[f++],image_type:m[f++],colormap_index:m[f++]|m[f++]<<8,colormap_length:m[f++]|m[f++]<<8,colormap_size:m[f++],origin:[m[f++]|m[f++]<<8,m[f++]|m[f++]<<8],width:m[f++]|m[f++]<<8,height:m[f++]|m[f++]<<8,pixel_size:m[f++],flags:m[f++]};!function(e){switch(e.image_type){case i:case r:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case n:case a:case s:case o:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(g),g.id_length+f>e.length&&console.error("THREE.TGALoader: No data."),f+=g.id_length;var y=!1,v=!1,b=!1;switch(g.image_type){case r:y=!0,v=!0;break;case i:v=!0;break;case s:y=!0;break;case n:break;case o:y=!0,b=!0;break;case a:b=!0}var _="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(g.width,g.height):document.createElement("canvas");_.width=g.width,_.height=g.height;var x=_.getContext("2d"),w=x.createImageData(g.width,g.height),S=function(e,t,i,n,a){var r,s,o,l;if(s=i.pixel_size>>3,o=i.width*i.height*s,t&&(l=a.subarray(n,n+=i.colormap_length*(i.colormap_size>>3))),e){var c,h,u;r=new Uint8Array(o);for(var d=0,p=new Uint8Array(s);d<o;)if(h=1+(127&(c=a[n++])),128&c){for(u=0;u<s;++u)p[u]=a[n++];for(u=0;u<h;++u)r.set(p,d+u*s);d+=s*h}else{for(h*=s,u=0;u<h;++u)r[d+u]=a[n++];d+=h}}else r=a.subarray(n,n+=t?i.width*i.height:o);return{pixel_data:r,palettes:l}}(y,v,g,f,m);return function(e,t,i,n,a){var r,s,o,m,f,y;switch((g.flags&l)>>c){default:case d:r=0,o=1,f=t,s=0,m=1,y=i;break;case h:r=0,o=1,f=t,s=i-1,m=-1,y=-1;break;case p:r=t-1,o=-1,f=-1,s=0,m=1,y=i;break;case u:r=t-1,o=-1,f=-1,s=i-1,m=-1,y=-1}if(b)switch(g.pixel_size){case 8:!function(e,t,i,n,a,r,s,o){var l,c,h,u=0,d=g.width;for(h=t;h!==n;h+=i)for(c=a;c!==s;c+=r,u++)l=o[u],e[4*(c+d*h)+0]=l,e[4*(c+d*h)+1]=l,e[4*(c+d*h)+2]=l,e[4*(c+d*h)+3]=255}(e,s,m,y,r,o,f,n);break;case 16:!function(e,t,i,n,a,r,s,o){var l,c,h=0,u=g.width;for(c=t;c!==n;c+=i)for(l=a;l!==s;l+=r,h+=2)e[4*(l+u*c)+0]=o[h+0],e[4*(l+u*c)+1]=o[h+0],e[4*(l+u*c)+2]=o[h+0],e[4*(l+u*c)+3]=o[h+1]}(e,s,m,y,r,o,f,n);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(g.pixel_size){case 8:!function(e,t,i,n,a,r,s,o,l){var c,h,u,d=l,p=0,m=g.width;for(u=t;u!==n;u+=i)for(h=a;h!==s;h+=r,p++)c=o[p],e[4*(h+m*u)+3]=255,e[4*(h+m*u)+2]=d[3*c+0],e[4*(h+m*u)+1]=d[3*c+1],e[4*(h+m*u)+0]=d[3*c+2]}(e,s,m,y,r,o,f,n,a);break;case 16:!function(e,t,i,n,a,r,s,o){var l,c,h,u=0,d=g.width;for(h=t;h!==n;h+=i)for(c=a;c!==s;c+=r,u+=2)l=o[u+0]+(o[u+1]<<8),e[4*(c+d*h)+0]=(31744&l)>>7,e[4*(c+d*h)+1]=(992&l)>>2,e[4*(c+d*h)+2]=(31&l)>>3,e[4*(c+d*h)+3]=32768&l?0:255}(e,s,m,y,r,o,f,n);break;case 24:!function(e,t,i,n,a,r,s,o){var l,c,h=0,u=g.width;for(c=t;c!==n;c+=i)for(l=a;l!==s;l+=r,h+=3)e[4*(l+u*c)+3]=255,e[4*(l+u*c)+2]=o[h+0],e[4*(l+u*c)+1]=o[h+1],e[4*(l+u*c)+0]=o[h+2]}(e,s,m,y,r,o,f,n);break;case 32:!function(e,t,i,n,a,r,s,o){var l,c,h=0,u=g.width;for(c=t;c!==n;c+=i)for(l=a;l!==s;l+=r,h+=4)e[4*(l+u*c)+2]=o[h+0],e[4*(l+u*c)+1]=o[h+1],e[4*(l+u*c)+0]=o[h+2],e[4*(l+u*c)+3]=o[h+3]}(e,s,m,y,r,o,f,n);break;default:console.error("THREE.TGALoader: Format not supported.")}}(w.data,g.width,g.height,S.pixel_data,S.palettes),x.putImageData(w,0,0),_}});var du=function(){var e=0,t=document.createElement("div");function i(e){return t.appendChild(e.dom),e}function n(i){for(var n=0;n<t.children.length;n++)t.children[n].style.display=n===i?"block":"none";e=i}t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",(function(i){i.preventDefault(),n(++e%t.children.length)}),!1);var a=(performance||Date).now(),r=a,s=0,o=i(new du.Panel("FPS","#0ff","#002")),l=i(new du.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=i(new du.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:t,addPanel:i,showPanel:n,begin:function(){a=(performance||Date).now()},end:function(){s++;var e=(performance||Date).now();if(l.update(e-a,200),e>=r+1e3&&(o.update(1e3*s/(e-r),100),r=e,s=0,c)){var t=performance.memory;c.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){a=this.end()},domElement:t,setMode:n}};du.Panel=function(e,t,i){var n=1/0,a=0,r=Math.round,s=r(window.devicePixelRatio||1),o=80*s,l=48*s,c=3*s,h=2*s,u=3*s,d=15*s,p=74*s,m=30*s,f=document.createElement("canvas");f.width=o,f.height=l,f.style.cssText="width:80px;height:48px";var g=f.getContext("2d");return g.font="bold "+9*s+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=i,g.fillRect(0,0,o,l),g.fillStyle=t,g.fillText(e,c,h),g.fillRect(u,d,p,m),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(u,d,p,m),{dom:f,update:function(l,y){n=Math.min(n,l),a=Math.max(a,l),g.fillStyle=i,g.globalAlpha=1,g.fillRect(0,0,o,d),g.fillStyle=t,g.fillText(r(l)+" "+e+" ("+r(n)+"-"+r(a)+")",c,h),g.drawImage(f,u+s,d,p-s,m,u,d,p-s,m),g.fillRect(u+p-s,d,s,m),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(u+p-s,d,s,r((1-l/y)*m))}}};
/**
   * postprocessing v6.21.3 build Wed Apr 07 2021
   * https://github.com/vanruesc/postprocessing
   * Copyright 2021 Raoul van Rüschen
   * @license Zlib
   */
var pu=0,mu=1,fu=2,gu=3,yu="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",vu=class extends Yi{constructor(e=!1,t=!1){super({type:"BokehMaterial",defines:{PASS:e?"2":"1"},uniforms:{kernel64:new jc(null),kernel16:new jc(null),inputBuffer:new jc(null),cocBuffer:new jc(null),texelSize:new jc(new ye),scale:new jc(1)},fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform lowp sampler2D cocBuffer;uniform vec2 texelSize;uniform float scale;\n#if PASS == 1\nuniform vec4 kernel64[32];\n#else\nuniform vec4 kernel16[8];\n#endif\nvarying vec2 vUv;void main(){\n#ifdef FOREGROUND\nvec2 CoCNearFar=texture2D(cocBuffer,vUv).rg;float CoC=CoCNearFar.r*scale;\n#else\nfloat CoC=texture2D(cocBuffer,vUv).g*scale;\n#endif\nif(CoC==0.0){gl_FragColor=texture2D(inputBuffer,vUv);}else{\n#ifdef FOREGROUND\nvec2 step=texelSize*max(CoC,CoCNearFar.g*scale);\n#else\nvec2 step=texelSize*CoC;\n#endif\n#if PASS == 1\nvec4 acc=vec4(0.0);for(int i=0;i<32;++i){vec4 kernel=kernel64[i];vec2 uv=step*kernel.xy+vUv;acc+=texture2D(inputBuffer,uv);uv=step*kernel.zw+vUv;acc+=texture2D(inputBuffer,uv);}gl_FragColor=acc/64.0;\n#else\nvec4 maxValue=texture2D(inputBuffer,vUv);for(int i=0;i<8;++i){vec4 kernel=kernel16[i];vec2 uv=step*kernel.xy+vUv;maxValue=max(texture2D(inputBuffer,uv),maxValue);uv=step*kernel.zw+vUv;maxValue=max(texture2D(inputBuffer,uv),maxValue);}gl_FragColor=maxValue;\n#endif\n}}",vertexShader:yu,blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,t&&(this.defines.FOREGROUND="1"),this.generateKernel()}generateKernel(){const e=new Float32Array(128),t=new Float32Array(32);let i=0,n=0;for(let a=0;a<80;++a){const r=2.39996323*a,s=Math.sqrt(a)/Math.sqrt(80),o=s*Math.cos(r),l=s*Math.sin(r);a%5==0?(t[n++]=o,t[n++]=l):(e[i++]=o,e[i++]=l)}const a=[],r=[];for(let t=0;t<128;)a.push(new Me(e[t++],e[t++],e[t++],e[t++]));for(let e=0;e<32;)r.push(new Me(t[e++],t[e++],t[e++],t[e++]));this.uniforms.kernel64.value=a,this.uniforms.kernel16.value=r}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}},bu=class extends Yi{constructor(e){super({type:"CircleOfConfusionMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new jc(null),focusDistance:new jc(0),focalLength:new jc(0),cameraNear:new jc(.3),cameraFar:new jc(1e3)},fragmentShader:"#include <common>\n#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform float focusDistance;uniform float focalLength;uniform float cameraNear;uniform float cameraFar;varying vec2 vUv;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}void main(){float depth=readDepth(vUv);\n#ifdef PERSPECTIVE_CAMERA\nfloat viewZ=perspectiveDepthToViewZ(depth,cameraNear,cameraFar);float linearDepth=viewZToOrthographicDepth(viewZ,cameraNear,cameraFar);\n#else\nfloat linearDepth=depth;\n#endif\nfloat signedDistance=linearDepth-focusDistance;float magnitude=smoothstep(0.0,focalLength,abs(signedDistance));gl_FragColor.rg=vec2(step(signedDistance,0.0)*magnitude,step(0.0,signedDistance)*magnitude);}",vertexShader:yu,blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.adoptCameraSettings(e)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}adoptCameraSettings(e=null){null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof Zi?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},_u=class extends Yi{constructor(e=new ye){super({type:"ConvolutionMaterial",uniforms:{inputBuffer:new jc(null),texelSize:new jc(new ye),halfTexelSize:new jc(new ye),kernel:new jc(0),scale:new jc(1)},fragmentShader:"#include <common>\n#include <dithering_pars_fragment>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;\n#include <dithering_fragment>\n}",vertexShader:"uniform vec2 texelSize;uniform vec2 halfTexelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize*vec2(kernel)+halfTexelSize)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernelSize=wu.LARGE}getKernel(){return xu[this.kernelSize]}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}},xu=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],wu={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5},Su=class extends Yi{constructor(){super({type:"CopyMaterial",uniforms:{inputBuffer:new jc(null),opacity:new jc(1)},fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;\n#include <encodings_fragment>\n}",vertexShader:yu,blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1}},Mu=class extends Yi{constructor(e=null,t){super({type:"DepthComparisonMaterial",uniforms:{depthBuffer:new jc(e),cameraNear:new jc(.3),cameraFar:new jc(1e3)},fragmentShader:"#include <packing>\n#include <clipping_planes_pars_fragment>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform float cameraNear;uniform float cameraFar;varying float vViewZ;varying vec4 vProjTexCoord;void main(){\n#include <clipping_planes_fragment>\nvec2 projTexCoord=(vProjTexCoord.xy/vProjTexCoord.w)*0.5+0.5;projTexCoord=clamp(projTexCoord,0.002,0.998);float fragCoordZ=unpackRGBAToDepth(texture2D(depthBuffer,projTexCoord));\n#ifdef PERSPECTIVE_CAMERA\nfloat viewZ=perspectiveDepthToViewZ(fragCoordZ,cameraNear,cameraFar);\n#else\nfloat viewZ=orthographicDepthToViewZ(fragCoordZ,cameraNear,cameraFar);\n#endif\nfloat depthTest=(-vViewZ>-viewZ)? 1.0 : 0.0;gl_FragColor.rg=vec2(0.0,depthTest);}",vertexShader:"#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying float vViewZ;varying vec4 vProjTexCoord;void main(){\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\nvViewZ=mvPosition.z;vProjTexCoord=gl_Position;\n#include <clipping_planes_vertex>\n}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.adoptCameraSettings(t)}adoptCameraSettings(e=null){null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof Zi?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA)}},Tu=class extends Yi{constructor(){super({type:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new jc(null),normalBuffer:new jc(null),texelSize:new jc(new ye)},fragmentShader:"#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\n#ifdef DOWNSAMPLE_NORMALS\nuniform lowp sampler2D normalBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])/4.0;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);\n#ifdef DOWNSAMPLE_NORMALS\nvec2 uvs[4];uvs[0]=vUv0;uvs[1]=vUv1;uvs[2]=vUv2;uvs[3]=vUv3;vec3 n=texture2D(normalBuffer,uvs[index]).rgb;\n#else\nvec3 n=vec3(0.0);\n#endif\ngl_FragColor=vec4(n,d[index]);}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}},Au=class extends Yi{constructor(e=new ye,t=Eu.COLOR){super({type:"EdgeDetectionMaterial",defines:{LOCAL_CONTRAST_ADAPTATION_FACTOR:"2.0",EDGE_THRESHOLD:"0.1",DEPTH_THRESHOLD:"0.01",PREDICATION_MODE:"0",PREDICATION_THRESHOLD:"0.01",PREDICATION_SCALE:"2.0",PREDICATION_STRENGTH:"1.0",DEPTH_PACKING:"0"},uniforms:{inputBuffer:new jc(null),depthBuffer:new jc(null),predicationBuffer:new jc(null),texelSize:new jc(e)},fragmentShader:"varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;\n#if EDGE_DETECTION_MODE != 0\nvarying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;\n#endif\n#if EDGE_DETECTION_MODE == 1\n#include <common>\n#endif\n#if EDGE_DETECTION_MODE == 0 || PREDICATION_MODE == 1\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nfloat readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}vec3 gatherNeighbors(){float p=readDepth(vUv);float pLeft=readDepth(vUv0);float pTop=readDepth(vUv1);return vec3(p,pLeft,pTop);}\n#elif PREDICATION_MODE == 2\nuniform sampler2D predicationBuffer;vec3 gatherNeighbors(){float p=texture2D(predicationBuffer,vUv).r;float pLeft=texture2D(predicationBuffer,vUv0).r;float pTop=texture2D(predicationBuffer,vUv1).r;return vec3(p,pLeft,pTop);}\n#endif\n#if PREDICATION_MODE != 0\nvec2 calculatePredicatedThreshold(){vec3 neighbours=gatherNeighbors();vec2 delta=abs(neighbours.xx-neighbours.yz);vec2 edges=step(PREDICATION_THRESHOLD,delta);return PREDICATION_SCALE*EDGE_THRESHOLD*(1.0-PREDICATION_STRENGTH*edges);}\n#endif\n#if EDGE_DETECTION_MODE != 0\nuniform sampler2D inputBuffer;\n#endif\nvoid main(){\n#if EDGE_DETECTION_MODE == 0\nconst vec2 threshold=vec2(DEPTH_THRESHOLD);\n#elif PREDICATION_MODE != 0\nvec2 threshold=calculatePredicatedThreshold();\n#else\nconst vec2 threshold=vec2(EDGE_THRESHOLD);\n#endif\n#if EDGE_DETECTION_MODE == 0\nvec3 neighbors=gatherNeighbors();vec2 delta=abs(neighbors.xx-vec2(neighbors.y,neighbors.z));vec2 edges=step(threshold,delta);if(dot(edges,vec2(1.0))==0.0){discard;}gl_FragColor=vec4(edges,0.0,1.0);\n#elif EDGE_DETECTION_MODE == 1\nfloat l=linearToRelativeLuminance(texture2D(inputBuffer,vUv).rgb);float lLeft=linearToRelativeLuminance(texture2D(inputBuffer,vUv0).rgb);float lTop=linearToRelativeLuminance(texture2D(inputBuffer,vUv1).rgb);vec4 delta;delta.xy=abs(l-vec2(lLeft,lTop));vec2 edges=step(threshold,delta.xy);if(dot(edges,vec2(1.0))==0.0){discard;}float lRight=linearToRelativeLuminance(texture2D(inputBuffer,vUv2).rgb);float lBottom=linearToRelativeLuminance(texture2D(inputBuffer,vUv3).rgb);delta.zw=abs(l-vec2(lRight,lBottom));vec2 maxDelta=max(delta.xy,delta.zw);float lLeftLeft=linearToRelativeLuminance(texture2D(inputBuffer,vUv4).rgb);float lTopTop=linearToRelativeLuminance(texture2D(inputBuffer,vUv5).rgb);delta.zw=abs(vec2(lLeft,lTop)-vec2(lLeftLeft,lTopTop));maxDelta=max(maxDelta.xy,delta.zw);float finalDelta=max(maxDelta.x,maxDelta.y);edges.xy*=step(finalDelta,LOCAL_CONTRAST_ADAPTATION_FACTOR*delta.xy);gl_FragColor=vec4(edges,0.0,1.0);\n#elif EDGE_DETECTION_MODE == 2\nvec4 delta;vec3 c=texture2D(inputBuffer,vUv).rgb;vec3 cLeft=texture2D(inputBuffer,vUv0).rgb;vec3 t=abs(c-cLeft);delta.x=max(max(t.r,t.g),t.b);vec3 cTop=texture2D(inputBuffer,vUv1).rgb;t=abs(c-cTop);delta.y=max(max(t.r,t.g),t.b);vec2 edges=step(threshold,delta.xy);if(dot(edges,vec2(1.0))==0.0){discard;}vec3 cRight=texture2D(inputBuffer,vUv2).rgb;t=abs(c-cRight);delta.z=max(max(t.r,t.g),t.b);vec3 cBottom=texture2D(inputBuffer,vUv3).rgb;t=abs(c-cBottom);delta.w=max(max(t.r,t.g),t.b);vec2 maxDelta=max(delta.xy,delta.zw);vec3 cLeftLeft=texture2D(inputBuffer,vUv4).rgb;t=abs(c-cLeftLeft);delta.z=max(max(t.r,t.g),t.b);vec3 cTopTop=texture2D(inputBuffer,vUv5).rgb;t=abs(c-cTopTop);delta.w=max(max(t.r,t.g),t.b);maxDelta=max(maxDelta.xy,delta.zw);float finalDelta=max(maxDelta.x,maxDelta.y);edges*=step(finalDelta,LOCAL_CONTRAST_ADAPTATION_FACTOR*delta.xy);gl_FragColor=vec4(edges,0.0,1.0);\n#endif\n}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;\n#if EDGE_DETECTION_MODE != 0\nvarying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;\n#endif\nvoid main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,0.0);vUv1=vUv+texelSize*vec2(0.0,-1.0);\n#if EDGE_DETECTION_MODE != 0\nvUv2=vUv+texelSize*vec2(1.0,0.0);vUv3=vUv+texelSize*vec2(0.0,1.0);vUv4=vUv+texelSize*vec2(-2.0,0.0);vUv5=vUv+texelSize*vec2(0.0,-2.0);\n#endif\ngl_Position=vec4(position.xy,1.0,1.0);}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setEdgeDetectionMode(t)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setEdgeDetectionMode(e){this.defines.EDGE_DETECTION_MODE=e.toFixed(0),this.needsUpdate=!0}setLocalContrastAdaptationFactor(e){this.defines.LOCAL_CONTRAST_ADAPTATION_FACTOR=e.toFixed("6"),this.needsUpdate=!0}setEdgeDetectionThreshold(e){this.defines.EDGE_THRESHOLD=e.toFixed("6"),this.defines.DEPTH_THRESHOLD=(.1*e).toFixed("6"),this.needsUpdate=!0}setPredicationMode(e){this.defines.PREDICATION_MODE=e.toFixed(0),this.needsUpdate=!0}setPredicationBuffer(e){this.uniforms.predicationBuffer.value=e}setPredicationThreshold(e){this.defines.PREDICATION_THRESHOLD=e.toFixed("6"),this.needsUpdate=!0}setPredicationScale(e){this.defines.PREDICATION_SCALE=e.toFixed("6"),this.needsUpdate=!0}setPredicationStrength(e){this.defines.PREDICATION_STRENGTH=e.toFixed("6"),this.needsUpdate=!0}},Eu={DEPTH:0,LUMA:1,COLOR:2},Cu=1,Iu=class extends Yi{constructor(e=null,t=null,i=null,n,a=!1){super({type:"EffectMaterial",defines:{DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new jc(null),depthBuffer:new jc(null),resolution:new jc(new ye),texelSize:new jc(new ye),cameraNear:new jc(.3),cameraFar:new jc(1e3),aspect:new jc(1),time:new jc(0)},blending:0,depthWrite:!1,depthTest:!1,dithering:a}),this.toneMapped=!1,null!==e&&this.setShaderParts(e),null!==t&&this.setDefines(t),null!==i&&this.setUniforms(i),this.adoptCameraSettings(n)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setShaderParts(e){return this.fragmentShader="#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}FRAGMENT_HEADvoid main(){FRAGMENT_MAIN_UVvec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGEgl_FragColor=color0;\n#ifdef ENCODE_OUTPUT\n#include <encodings_fragment>\n#endif\n#include <dithering_fragment>\n}".replace(Pu.FRAGMENT_HEAD,e.get(Pu.FRAGMENT_HEAD)).replace(Pu.FRAGMENT_MAIN_UV,e.get(Pu.FRAGMENT_MAIN_UV)).replace(Pu.FRAGMENT_MAIN_IMAGE,e.get(Pu.FRAGMENT_MAIN_IMAGE)),this.vertexShader="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEADvoid main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORTgl_Position=vec4(position.xy,1.0,1.0);}".replace(Pu.VERTEX_HEAD,e.get(Pu.VERTEX_HEAD)).replace(Pu.VERTEX_MAIN_SUPPORT,e.get(Pu.VERTEX_MAIN_SUPPORT)),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}adoptCameraSettings(e=null){null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof Zi?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const i=Math.max(e,1),n=Math.max(t,1);this.uniforms.resolution.value.set(i,n),this.uniforms.texelSize.value.set(1/i,1/n),this.uniforms.aspect.value=i/n}},Pu={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},Ru=class extends Yi{constructor(e=!1,t=null){const i=null!==t;super({type:"LuminanceMaterial",uniforms:{inputBuffer:new jc(null),threshold:new jc(0),smoothing:new jc(1),range:new jc(i?t:new ye)},fragmentShader:"#include <common>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef RANGE\nuniform vec2 range;\n#elif defined(THRESHOLD)\nuniform float threshold;uniform float smoothing;\n#endif\nvarying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=linearToRelativeLuminance(texel.rgb);\n#ifdef RANGE\nfloat low=step(range.x,l);float high=step(l,range.y);l*=low*high;\n#elif defined(THRESHOLD)\nl=smoothstep(threshold,threshold+smoothing,l);\n#endif\n#ifdef COLOR\ngl_FragColor=vec4(texel.rgb*l,l);\n#else\ngl_FragColor=vec4(l);\n#endif\n}",vertexShader:yu,blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.colorOutput=e,this.useThreshold=!0,this.useRange=i}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.uniforms.threshold.value=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.uniforms.smoothing.value=e}get useThreshold(){return void 0!==this.defines.THRESHOLD}set useThreshold(e){e?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.needsUpdate=!0}get colorOutput(){return void 0!==this.defines.COLOR}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return void 0!==this.defines.RANGE}set useRange(e){e?this.defines.RANGE="1":delete this.defines.RANGE,this.needsUpdate=!0}get luminanceRange(){return this.useRange}set luminanceRange(e){this.useRange=e}setLuminanceRangeEnabled(e){this.useRange=e}},Ou=class extends Yi{constructor(e=null){super({type:"MaskMaterial",uniforms:{maskTexture:new jc(e),inputBuffer:new jc(null),strength:new jc(1)},fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef MASK_PRECISION_HIGH\nuniform mediump sampler2D maskTexture;\n#else\nuniform lowp sampler2D maskTexture;\n#endif\n#if MASK_FUNCTION != 0\nuniform float strength;\n#endif\nvarying vec2 vUv;void main(){\n#if COLOR_CHANNEL == 0\nfloat mask=texture2D(maskTexture,vUv).r;\n#elif COLOR_CHANNEL == 1\nfloat mask=texture2D(maskTexture,vUv).g;\n#elif COLOR_CHANNEL == 2\nfloat mask=texture2D(maskTexture,vUv).b;\n#else\nfloat mask=texture2D(maskTexture,vUv).a;\n#endif\n#if MASK_FUNCTION == 0\n#ifdef INVERTED\nif(mask>0.0){discard;}\n#else\nif(mask==0.0){discard;}\n#endif\n#else\nmask=clamp(mask*strength,0.0,1.0);\n#ifdef INVERTED\nmask=(1.0-mask);\n#endif\n#if MASK_FUNCTION == 1\ngl_FragColor=mask*texture2D(inputBuffer,vUv);\n#else\ngl_FragColor=vec4(mask*texture2D(inputBuffer,vUv).rgb,mask);\n#endif\n#endif\n}",vertexShader:yu,blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.colorChannel=pu,this.maskFunction=Du.DISCARD}set maskTexture(e){this.uniforms.maskTexture.value=e,delete this.defines.MASK_PRECISION_HIGH,e.type!==w&&(this.defines.MASK_PRECISION_HIGH="1"),this.needsUpdate=!0}set colorChannel(e){this.defines.COLOR_CHANNEL=e.toFixed(0),this.needsUpdate=!0}set maskFunction(e){this.defines.MASK_FUNCTION=e.toFixed(0),this.needsUpdate=!0}get inverted(){return void 0!==this.defines.INVERTED}set inverted(e){this.inverted&&!e?delete this.defines.INVERTED:e&&(this.defines.INVERTED="1"),this.needsUpdate=!0}get strength(){return this.uniforms.strength.value}set strength(e){this.uniforms.strength.value=e}},Du={DISCARD:0,MULTIPLY:1,MULTIPLY_RGB_SET_ALPHA:2},Lu=class extends Yi{constructor(e=new ye){super({type:"OutlineMaterial",uniforms:{inputBuffer:new jc(null),texelSize:new jc(new ye)},fragmentShader:"uniform lowp sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 c0=texture2D(inputBuffer,vUv0).rg;vec2 c1=texture2D(inputBuffer,vUv1).rg;vec2 c2=texture2D(inputBuffer,vUv2).rg;vec2 c3=texture2D(inputBuffer,vUv3).rg;float d0=(c0.x-c1.x)*0.5;float d1=(c2.x-c3.x)*0.5;float d=length(vec2(d0,d1));float a0=min(c0.y,c1.y);float a1=min(c2.y,c3.y);float visibilityFactor=min(a0,a1);gl_FragColor.rg=(1.0-visibilityFactor>0.001)? vec2(d,0.0): vec2(0.0,d);}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=vec2(uv.x+texelSize.x,uv.y);vUv1=vec2(uv.x-texelSize.x,uv.y);vUv2=vec2(uv.x,uv.y+texelSize.y);vUv3=vec2(uv.x,uv.y-texelSize.y);gl_Position=vec4(position.xy,1.0,1.0);}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.uniforms.maskTexture=this.uniforms.inputBuffer}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}},ku=class extends Yi{constructor(e=new ye,t=new ye){super({type:"SMAAWeightsMaterial",defines:{MAX_SEARCH_STEPS_INT:"16",MAX_SEARCH_STEPS_FLOAT:"16.0",MAX_SEARCH_STEPS_DIAG_INT:"8",MAX_SEARCH_STEPS_DIAG_FLOAT:"8.0",CORNER_ROUNDING:"25",CORNER_ROUNDING_NORM:"0.25",AREATEX_MAX_DISTANCE:"16.0",AREATEX_MAX_DISTANCE_DIAG:"20.0",AREATEX_PIXEL_SIZE:"(1.0 / vec2(160.0, 560.0))",AREATEX_SUBTEX_SIZE:"(1.0 / 7.0)",SEARCHTEX_SIZE:"vec2(66.0, 33.0)",SEARCHTEX_PACKED_SIZE:"vec2(64.0, 16.0)"},uniforms:{inputBuffer:new jc(null),areaTexture:new jc(null),searchTexture:new jc(null),texelSize:new jc(e),resolution:new jc(t)},fragmentShader:"#define sampleLevelZeroOffset(t, coord, offset) texture2D(t, coord + offset * texelSize)\n#if __VERSION__ < 300\n#define round(v) floor(v + 0.5)\n#endif\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform lowp sampler2D areaTexture;uniform lowp sampler2D searchTexture;uniform vec2 texelSize;uniform vec2 resolution;varying vec2 vUv;varying vec4 vOffset[3];varying vec2 vPixCoord;void movec(const in bvec2 c,inout vec2 variable,const in vec2 value){if(c.x){variable.x=value.x;}if(c.y){variable.y=value.y;}}void movec(const in bvec4 c,inout vec4 variable,const in vec4 value){movec(c.xy,variable.xy,value.xy);movec(c.zw,variable.zw,value.zw);}vec2 decodeDiagBilinearAccess(in vec2 e){e.r=e.r*abs(5.0*e.r-5.0*0.75);return round(e);}vec4 decodeDiagBilinearAccess(in vec4 e){e.rb=e.rb*abs(5.0*e.rb-5.0*0.75);return round(e);}vec2 searchDiag1(const in vec2 texCoord,const in vec2 dir,out vec2 e){vec4 coord=vec4(texCoord,-1.0,1.0);vec3 t=vec3(texelSize,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(coord.z<float(MAX_SEARCH_STEPS_DIAG_INT-1)&&coord.w>0.9)){break;}coord.xyz=t*vec3(dir,1.0)+coord.xyz;e=texture2D(inputBuffer,coord.xy).rg;coord.w=dot(e,vec2(0.5));}return coord.zw;}vec2 searchDiag2(const in vec2 texCoord,const in vec2 dir,out vec2 e){vec4 coord=vec4(texCoord,-1.0,1.0);coord.x+=0.25*texelSize.x;vec3 t=vec3(texelSize,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(coord.z<float(MAX_SEARCH_STEPS_DIAG_INT-1)&&coord.w>0.9)){break;}coord.xyz=t*vec3(dir,1.0)+coord.xyz;e=texture2D(inputBuffer,coord.xy).rg;e=decodeDiagBilinearAccess(e);coord.w=dot(e,vec2(0.5));}return coord.zw;}vec2 areaDiag(const in vec2 dist,const in vec2 e,const in float offset){vec2 texCoord=vec2(AREATEX_MAX_DISTANCE_DIAG,AREATEX_MAX_DISTANCE_DIAG)*e+dist;texCoord=AREATEX_PIXEL_SIZE*texCoord+0.5*AREATEX_PIXEL_SIZE;texCoord.x+=0.5;texCoord.y+=AREATEX_SUBTEX_SIZE*offset;return texture2D(areaTexture,texCoord).rg;}vec2 calculateDiagWeights(const in vec2 texCoord,const in vec2 e,const in vec4 subsampleIndices){vec2 weights=vec2(0.0);vec4 d;vec2 end;if(e.r>0.0){d.xz=searchDiag1(texCoord,vec2(-1.0,1.0),end);d.x+=float(end.y>0.9);}else{d.xz=vec2(0.0);}d.yw=searchDiag1(texCoord,vec2(1.0,-1.0),end);if(d.x+d.y>2.0){vec4 coords=vec4(-d.x+0.25,d.x,d.y,-d.y-0.25)*texelSize.xyxy+texCoord.xyxy;vec4 c;c.xy=sampleLevelZeroOffset(inputBuffer,coords.xy,vec2(-1,0)).rg;c.zw=sampleLevelZeroOffset(inputBuffer,coords.zw,vec2(1,0)).rg;c.yxwz=decodeDiagBilinearAccess(c.xyzw);vec2 cc=vec2(2.0)*c.xz+c.yw;movec(bvec2(step(0.9,d.zw)),cc,vec2(0.0));weights+=areaDiag(d.xy,cc,subsampleIndices.z);}d.xz=searchDiag2(texCoord,vec2(-1.0,-1.0),end);if(sampleLevelZeroOffset(inputBuffer,texCoord,vec2(1,0)).r>0.0){d.yw=searchDiag2(texCoord,vec2(1.0),end);d.y+=float(end.y>0.9);}else{d.yw=vec2(0.0);}if(d.x+d.y>2.0){vec4 coords=vec4(-d.x,-d.x,d.y,d.y)*texelSize.xyxy+texCoord.xyxy;vec4 c;c.x=sampleLevelZeroOffset(inputBuffer,coords.xy,vec2(-1,0)).g;c.y=sampleLevelZeroOffset(inputBuffer,coords.xy,vec2(0,-1)).r;c.zw=sampleLevelZeroOffset(inputBuffer,coords.zw,vec2(1,0)).gr;vec2 cc=vec2(2.0)*c.xz+c.yw;movec(bvec2(step(0.9,d.zw)),cc,vec2(0.0));weights+=areaDiag(d.xy,cc,subsampleIndices.w).gr;}return weights;}float searchLength(const in vec2 e,const in float offset){vec2 scale=SEARCHTEX_SIZE*vec2(0.5,-1.0);vec2 bias=SEARCHTEX_SIZE*vec2(offset,1.0);scale+=vec2(-1.0,1.0);bias+=vec2(0.5,-0.5);scale*=1.0/SEARCHTEX_PACKED_SIZE;bias*=1.0/SEARCHTEX_PACKED_SIZE;return texture2D(searchTexture,scale*e+bias).r;}float searchXLeft(in vec2 texCoord,const in float end){vec2 e=vec2(0.0,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(texCoord.x>end&&e.g>0.8281&&e.r==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=vec2(-2.0,0.0)*texelSize+texCoord;}float offset=-(255.0/127.0)*searchLength(e,0.0)+3.25;return texelSize.x*offset+texCoord.x;}float searchXRight(vec2 texCoord,const in float end){vec2 e=vec2(0.0,1.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(texCoord.x<end&&e.g>0.8281&&e.r==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=vec2(2.0,0.0)*texelSize.xy+texCoord;}float offset=-(255.0/127.0)*searchLength(e,0.5)+3.25;return-texelSize.x*offset+texCoord.x;}float searchYUp(vec2 texCoord,const in float end){vec2 e=vec2(1.0,0.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;++i){if(!(texCoord.y>end&&e.r>0.8281&&e.g==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=-vec2(0.0,2.0)*texelSize.xy+texCoord;}float offset=-(255.0/127.0)*searchLength(e.gr,0.0)+3.25;return texelSize.y*offset+texCoord.y;}float searchYDown(vec2 texCoord,const in float end){vec2 e=vec2(1.0,0.0);for(int i=0;i<MAX_SEARCH_STEPS_INT;i++){if(!(texCoord.y<end&&e.r>0.8281&&e.g==0.0)){break;}e=texture2D(inputBuffer,texCoord).rg;texCoord=vec2(0.0,2.0)*texelSize.xy+texCoord;}float offset=-(255.0/127.0)*searchLength(e.gr,0.5)+3.25;return-texelSize.y*offset+texCoord.y;}vec2 area(const in vec2 dist,const in float e1,const in float e2,const in float offset){vec2 texCoord=vec2(AREATEX_MAX_DISTANCE)*round(4.0*vec2(e1,e2))+dist;texCoord=AREATEX_PIXEL_SIZE*texCoord+0.5*AREATEX_PIXEL_SIZE;texCoord.y=AREATEX_SUBTEX_SIZE*offset+texCoord.y;return texture2D(areaTexture,texCoord).rg;}void detectHorizontalCornerPattern(inout vec2 weights,const in vec4 texCoord,const in vec2 d){\n#if !defined(DISABLE_CORNER_DETECTION)\nvec2 leftRight=step(d.xy,d.yx);vec2 rounding=(1.0-CORNER_ROUNDING_NORM)*leftRight;rounding/=leftRight.x+leftRight.y;vec2 factor=vec2(1.0);factor.x-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(0,1)).r;factor.x-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(1,1)).r;factor.y-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(0,-2)).r;factor.y-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(1,-2)).r;weights*=clamp(factor,0.0,1.0);\n#endif\n}void detectVerticalCornerPattern(inout vec2 weights,const in vec4 texCoord,const in vec2 d){\n#if !defined(DISABLE_CORNER_DETECTION)\nvec2 leftRight=step(d.xy,d.yx);vec2 rounding=(1.0-CORNER_ROUNDING_NORM)*leftRight;rounding/=leftRight.x+leftRight.y;vec2 factor=vec2(1.0);factor.x-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(1,0)).g;factor.x-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(1,1)).g;factor.y-=rounding.x*sampleLevelZeroOffset(inputBuffer,texCoord.xy,vec2(-2,0)).g;factor.y-=rounding.y*sampleLevelZeroOffset(inputBuffer,texCoord.zw,vec2(-2,1)).g;weights*=clamp(factor,0.0,1.0);\n#endif\n}void main(){vec4 weights=vec4(0.0);vec4 subsampleIndices=vec4(0.0);vec2 e=texture2D(inputBuffer,vUv).rg;if(e.g>0.0){\n#if !defined(DISABLE_DIAG_DETECTION)\nweights.rg=calculateDiagWeights(vUv,e,subsampleIndices);if(weights.r==-weights.g){\n#endif\nvec2 d;vec3 coords;coords.x=searchXLeft(vOffset[0].xy,vOffset[2].x);coords.y=vOffset[1].y;d.x=coords.x;float e1=texture2D(inputBuffer,coords.xy).r;coords.z=searchXRight(vOffset[0].zw,vOffset[2].y);d.y=coords.z;d=round(resolution.xx*d+-vPixCoord.xx);vec2 sqrtD=sqrt(abs(d));float e2=sampleLevelZeroOffset(inputBuffer,coords.zy,vec2(1,0)).r;weights.rg=area(sqrtD,e1,e2,subsampleIndices.y);coords.y=vUv.y;detectHorizontalCornerPattern(weights.rg,coords.xyzy,d);\n#if !defined(DISABLE_DIAG_DETECTION)\n}else{e.r=0.0;}\n#endif\n}if(e.r>0.0){vec2 d;vec3 coords;coords.y=searchYUp(vOffset[1].xy,vOffset[2].z);coords.x=vOffset[0].x;d.x=coords.y;float e1=texture2D(inputBuffer,coords.xy).g;coords.z=searchYDown(vOffset[1].zw,vOffset[2].w);d.y=coords.z;d=round(resolution.yy*d-vPixCoord.yy);vec2 sqrtD=sqrt(abs(d));float e2=sampleLevelZeroOffset(inputBuffer,coords.xz,vec2(0,1)).g;weights.ba=area(sqrtD,e1,e2,subsampleIndices.x);coords.x=vUv.x;detectVerticalCornerPattern(weights.ba,coords.xyxz,d);}gl_FragColor=weights;}",vertexShader:"uniform vec2 texelSize;uniform vec2 resolution;varying vec2 vUv;varying vec4 vOffset[3];varying vec2 vPixCoord;void main(){vUv=position.xy*0.5+0.5;vPixCoord=vUv*resolution;vOffset[0]=vUv.xyxy+texelSize.xyxy*vec4(-0.25,-0.125,1.25,-0.125);vOffset[1]=vUv.xyxy+texelSize.xyxy*vec4(-0.125,-0.25,-0.125,1.25);vOffset[2]=vec4(vOffset[0].xz,vOffset[1].yw)+vec4(-2.0,2.0,-2.0,2.0)*texelSize.xxyy*MAX_SEARCH_STEPS_FLOAT;gl_Position=vec4(position.xy,1.0,1.0);}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1}setOrthogonalSearchSteps(e){const t=Math.min(Math.max(e,0),112);this.defines.MAX_SEARCH_STEPS_INT=t.toFixed("0"),this.defines.MAX_SEARCH_STEPS_FLOAT=t.toFixed("1"),this.needsUpdate=!0}setDiagonalSearchSteps(e){const t=Math.min(Math.max(e,0),20);this.defines.MAX_SEARCH_STEPS_DIAG_INT=t.toFixed("0"),this.defines.MAX_SEARCH_STEPS_DIAG_FLOAT=t.toFixed("1"),this.needsUpdate=!0}setCornerRounding(e){const t=Math.min(Math.max(e,0),100);this.defines.CORNER_ROUNDING=t.toFixed("4"),this.defines.CORNER_ROUNDING_NORM=(t/100).toFixed("4"),this.needsUpdate=!0}get diagonalDetection(){return void 0===this.defines.DISABLE_DIAG_DETECTION}set diagonalDetection(e){e?delete this.defines.DISABLE_DIAG_DETECTION:this.defines.DISABLE_DIAG_DETECTION="1",this.needsUpdate=!0}get cornerRounding(){return void 0===this.defines.DISABLE_CORNER_DETECTION}set cornerRounding(e){e?delete this.defines.DISABLE_CORNER_DETECTION:this.defines.DISABLE_CORNER_DETECTION="1",this.needsUpdate=!0}},Nu=class extends Yi{constructor(e){super({type:"SSAOMaterial",defines:{SAMPLES_INT:"0",SAMPLES_FLOAT:"0.0",SPIRAL_TURNS:"0.0",RADIUS:"1.0",RADIUS_SQ:"1.0",DISTANCE_SCALING:"1",DEPTH_PACKING:"0"},uniforms:{normalBuffer:new jc(null),normalDepthBuffer:new jc(null),noiseTexture:new jc(null),inverseProjectionMatrix:new jc(new it),projectionMatrix:new jc(new it),texelSize:new jc(new ye),cameraNear:new jc(0),cameraFar:new jc(0),distanceCutoff:new jc(new ye),proximityCutoff:new jc(new ye),noiseScale:new jc(new ye),minRadiusScale:new jc(.33),intensity:new jc(1),fade:new jc(.01),bias:new jc(0)},fragmentShader:"#include <common>\n#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D normalDepthBuffer;\n#else\nuniform mediump sampler2D normalDepthBuffer;\n#endif\n#ifndef NORMAL_DEPTH\nuniform lowp sampler2D normalBuffer;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(normalDepthBuffer,uv));\n#else\nreturn texture2D(normalDepthBuffer,uv).r;\n#endif\n}\n#endif\nuniform lowp sampler2D noiseTexture;uniform mat4 inverseProjectionMatrix;uniform mat4 projectionMatrix;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float minRadiusScale;uniform float intensity;uniform float fade;uniform float bias;uniform vec2 distanceCutoff;uniform vec2 proximityCutoff;varying vec2 vUv;varying vec2 vUv2;float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(inverseProjectionMatrix*clipPosition).xyz;}float getAmbientOcclusion(const in vec3 p,const in vec3 n,const in float depth,const in vec2 uv){\n#ifdef DISTANCE_SCALING\nfloat radiusScale=1.0-smoothstep(0.0,distanceCutoff.y,depth);radiusScale=radiusScale*(1.0-minRadiusScale)+minRadiusScale;float radius=RADIUS*radiusScale;\n#else\nfloat radius=RADIUS;\n#endif\nfloat noise=texture2D(noiseTexture,vUv2).r;float baseAngle=noise*PI2;float invSamples=1.0/SAMPLES_FLOAT;float rings=SPIRAL_TURNS*PI2;float occlusion=0.0;int taps=0;for(int i=0;i<SAMPLES_INT;++i){float alpha=(float(i)+0.5)*invSamples;float angle=alpha*rings+baseAngle;vec2 coord=alpha*radius*vec2(cos(angle),sin(angle))*texelSize+uv;if(coord.s<0.0||coord.s>1.0||coord.t<0.0||coord.t>1.0){continue;}\n#ifdef NORMAL_DEPTH\nfloat sampleDepth=texture2D(normalDepthBuffer,coord).a;\n#else\nfloat sampleDepth=readDepth(coord);\n#endif\nfloat viewZ=getViewZ(sampleDepth);\n#ifdef PERSPECTIVE_CAMERA\nfloat linearSampleDepth=viewZToOrthographicDepth(viewZ,cameraNear,cameraFar);\n#else\nfloat linearSampleDepth=sampleDepth;\n#endif\nfloat proximity=abs(depth-linearSampleDepth);if(proximity<proximityCutoff.y){float falloff=1.0-smoothstep(proximityCutoff.x,proximityCutoff.y,proximity);vec3 Q=getViewPosition(coord,sampleDepth,viewZ);vec3 v=Q-p;float vv=dot(v,v);float vn=dot(v,n)-bias;float f=max(RADIUS_SQ-vv,0.0)/RADIUS_SQ;occlusion+=(f*f*f*max(vn/(fade+vv),0.0))*falloff;}++taps;}return occlusion/(4.0*max(float(taps),1.0));}void main(){\n#ifdef NORMAL_DEPTH\nvec4 normalDepth=texture2D(normalDepthBuffer,vUv);\n#else\nvec4 normalDepth=vec4(texture2D(normalBuffer,vUv).rgb,readDepth(vUv));\n#endif\nfloat ao=1.0;float depth=normalDepth.a;float viewZ=getViewZ(depth);\n#ifdef PERSPECTIVE_CAMERA\nfloat linearDepth=viewZToOrthographicDepth(viewZ,cameraNear,cameraFar);\n#else\nfloat linearDepth=depth;\n#endif\nif(linearDepth<distanceCutoff.y){vec3 viewPosition=getViewPosition(vUv,depth,viewZ);vec3 viewNormal=unpackRGBToNormal(normalDepth.rgb);ao-=getAmbientOcclusion(viewPosition,viewNormal,linearDepth,vUv);float d=smoothstep(distanceCutoff.x,distanceCutoff.y,linearDepth);ao=mix(ao,1.0,d);ao=clamp(pow(ao,abs(intensity)),0.0,1.0);}gl_FragColor.r=ao;}",vertexShader:"uniform vec2 noiseScale;varying vec2 vUv;varying vec2 vUv2;void main(){vUv=position.xy*0.5+0.5;vUv2=vUv*noiseScale;gl_Position=vec4(position.xy,1.0,1.0);}",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.adoptCameraSettings(e)}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}adoptCameraSettings(e=null){if(null!==e){const t=this.uniforms;t.cameraNear.value=e.near,t.cameraFar.value=e.far,e instanceof Zi?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0}}},Bu=new Xi,zu=null;var Uu=class{constructor(e="Pass",t=new mr,i=Bu){this.name=e,this.scene=t,this.camera=i,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(e){if(this.rtt===e){const t=this.getFullscreenMaterial();null!==t&&(t.needsUpdate=!0),this.rtt=!e}}getFullscreenMaterial(){return null!==this.screen?this.screen.material:null}setFullscreenMaterial(e){let t=this.screen;null!==t?t.material=e:(t=new Fi(function(){if(null===zu){const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]);void 0!==(zu=new wi).setAttribute?(zu.setAttribute("position",new ti(e,3)),zu.setAttribute("uv",new ti(t,2))):(zu.addAttribute("position",new ti(e,3)),zu.addAttribute("uv",new ti(t,2)))}return zu}(),e),t.frustumCulled=!1,null===this.scene&&(this.scene=new mr),this.scene.add(t),this.screen=t)}getDepthTexture(){return null}setDepthTexture(e,t=0){}render(e,t,i,n,a){throw new Error("Render method not implemented!")}setSize(e,t){}initialize(e,t,i){}dispose(){const e=this.getFullscreenMaterial();null!==e&&e.dispose();for(const e of Object.keys(this)){const t=this[e];if(null!==t&&"function"==typeof t.dispose){if(t instanceof mr)continue;this[e].dispose()}}}},Fu=-1,ju=class{constructor(e,t=-1,i=-1,n=1){this.resizable=e,this.base=new ye(1,1),this.target=new ye(t,i),this.s=n}get scale(){return this.s}set scale(e){this.s=e,this.target.x=Fu,this.target.y=Fu,this.resizable.setSize(this.base.x,this.base.y)}get width(){const e=this.base,t=this.target;let i;return i=t.x!==Fu?t.x:t.y!==Fu?Math.round(t.y*(e.x/e.y)):Math.round(e.x*this.s),i}set width(e){this.target.x=e,this.resizable.setSize(this.base.x,this.base.y)}get height(){const e=this.base,t=this.target;let i;return i=t.y!==Fu?t.y:t.x!==Fu?Math.round(t.x/(e.x/e.y)):Math.round(e.y*this.s),i}set height(e){this.target.y=e,this.resizable.setSize(this.base.x,this.base.y)}static get AUTO_SIZE(){return Fu}},Hu=class extends Uu{constructor({resolutionScale:e=.5,width:t=ju.AUTO_SIZE,height:i=ju.AUTO_SIZE,kernelSize:n=wu.LARGE}={}){super("BlurPass"),this.renderTargetA=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B",this.resolution=new ju(this,t,i,e),this.convolutionMaterial=new _u,this.ditheredConvolutionMaterial=new _u,this.ditheredConvolutionMaterial.dithering=!0,this.dithering=!1,this.kernelSize=n}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get scale(){return this.convolutionMaterial.uniforms.scale.value}set scale(e){this.convolutionMaterial.uniforms.scale.value=e,this.ditheredConvolutionMaterial.uniforms.scale.value=e}get kernelSize(){return this.convolutionMaterial.kernelSize}set kernelSize(e){this.convolutionMaterial.kernelSize=e,this.ditheredConvolutionMaterial.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,i,n,a){const r=this.scene,s=this.camera,o=this.renderTargetA,l=this.renderTargetB;let c=this.convolutionMaterial,h=c.uniforms;const u=c.getKernel();let d,p,m,f=t;for(this.setFullscreenMaterial(c),p=0,m=u.length-1;p<m;++p)d=0==(1&p)?o:l,h.kernel.value=u[p],h.inputBuffer.value=f.texture,e.setRenderTarget(d),e.render(r,s),f=d;this.dithering&&(c=this.ditheredConvolutionMaterial,h=c.uniforms,this.setFullscreenMaterial(c)),h.kernel.value=u[p],h.inputBuffer.value=f.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(r,s)}setSize(e,t){const i=this.resolution;i.base.set(e,t);const n=i.width,a=i.height;this.renderTargetA.setSize(n,a),this.renderTargetB.setSize(n,a),this.convolutionMaterial.setTexelSize(1/n,1/a),this.ditheredConvolutionMaterial.setTexelSize(1/n,1/a)}initialize(e,t,i){if(t||i!==w||(this.renderTargetA.texture.format=C,this.renderTargetB.texture.format=C),void 0!==i&&(this.renderTargetA.texture.type=i,this.renderTargetB.texture.type=i,i!==w)){const e=this.convolutionMaterial,t=this.ditheredConvolutionMaterial;e.defines.FRAMEBUFFER_PRECISION_HIGH="1",t.defines.FRAMEBUFFER_PRECISION_HIGH="1"}}static get AUTO_SIZE(){return ju.AUTO_SIZE}},Gu=class extends Uu{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,i,n,a){const r=e.state.buffers.stencil;r.setLocked(!1),r.setTest(!1)}},Vu=new Qt,Wu=class extends Uu{constructor(e=!0,t=!0,i=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=i,this.overrideClearColor=null,this.overrideClearAlpha=-1}render(e,t,i,n,a){const r=this.overrideClearColor,s=this.overrideClearAlpha,o=e.getClearAlpha(),l=null!==r,c=s>=0;l?(Vu.copy(e.getClearColor(Vu)),e.setClearColor(r,c?s:o)):c&&e.setClearAlpha(s),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),l?e.setClearColor(Vu,o):c&&e.setClearAlpha(o)}},Yu=!1,Xu=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=e=>{if(e.isMesh){let t;switch(e.material.side){case 2:t=this.materialsDoubleSide;break;case 1:t=this.materialsBackSide;break;default:t=this.materials}this.originalMaterials.set(e,e.material),e.isSkinnedMesh?e.material=t[2]:e.isInstancedMesh?e.material=t[1]:e.material=t[0],++this.meshCount}}}setMaterial(e){if(this.disposeMaterials(),this.material=e,null!==e){const t=this.materials=[e.clone(),e.clone(),e.clone()];for(const i of t)i.uniforms=Object.assign({},e.uniforms),i.side=0;t[2].skinning=!0,this.materialsBackSide=t.map((t=>{const i=t.clone();return i.uniforms=Object.assign({},e.uniforms),i.side=1,i})),this.materialsDoubleSide=t.map((t=>{const i=t.clone();return i.uniforms=Object.assign({},e.uniforms),i.side=2,i}))}}render(e,t,i){const n=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,Yu){const n=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,i);for(const e of n)e[0].material=e[1];this.meshCount!==n.size&&n.clear()}else{const n=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,i),t.overrideMaterial=n}e.shadowMap.enabled=n}disposeMaterials(){if(null!==this.material){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return Yu}static set workaroundEnabled(e){Yu=e}},Zu=class extends Uu{constructor(e,t,i=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new Wu,this.overrideMaterialManager=null===i?null:new Xu(i)}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return null!==e?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;null!==e?null!==t?t.setMaterial(e):this.overrideMaterialManager=new Xu(e):null!==t&&(t.dispose(),this.overrideMaterialManager=null)}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getClearPass(){return this.clearPass}render(e,t,i,n,a){const r=this.scene,s=this.camera,o=r.background,l=this.renderToScreen?null:t;this.clear&&(null!==this.clearPass.overrideClearColor&&(r.background=null),this.clearPass.render(e,t)),e.setRenderTarget(l),null!==this.overrideMaterialManager?this.overrideMaterialManager.render(e,r,s):e.render(r,s),r.background!==o&&(r.background=o)}},qu=class extends Uu{constructor(e,t,{resolutionScale:i=1,width:n=ju.AUTO_SIZE,height:a=ju.AUTO_SIZE,renderTarget:r}={}){super("DepthPass"),this.needsSwap=!1,this.renderPass=new Zu(e,t,new $a({depthPacking:le}));const s=this.renderPass.getClearPass();s.overrideClearColor=new Qt(16777215),s.overrideClearAlpha=1,this.renderTarget=r,void 0===this.renderTarget&&(this.renderTarget=new Te(1,1,{minFilter:g,magFilter:g,stencilBuffer:!1}),this.renderTarget.texture.name="DepthPass.Target"),this.resolution=new ju(this,n,a,i)}get texture(){return this.renderTarget.texture}getResolutionScale(){return this.resolutionScale}setResolutionScale(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}render(e,t,i,n,a){const r=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,r)}setSize(e,t){const i=this.resolution;i.base.set(e,t),this.renderTarget.setSize(i.width,i.height)}},Ju=class extends Uu{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:i=ju.AUTO_SIZE,height:n=ju.AUTO_SIZE}={}){if(super("DepthDownsamplingPass"),this.setFullscreenMaterial(new Tu),this.needsDepthTexture=!0,this.needsSwap=!1,null!==e){const t=this.getFullscreenMaterial();t.uniforms.normalBuffer.value=e,t.defines.DOWNSAMPLE_NORMALS="1"}this.renderTarget=new Te(1,1,{minFilter:g,magFilter:g,stencilBuffer:!1,depthBuffer:!1,type:T}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1,this.resolution=new ju(this,i,n),this.resolution.scale=t}get texture(){return this.renderTarget.texture}setDepthTexture(e,t=3200){const i=this.getFullscreenMaterial();i.uniforms.depthBuffer.value=e,i.depthPacking=t}render(e,t,i,n,a){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const i=this.resolution;i.base.set(e,t),this.getFullscreenMaterial().setTexelSize(1/e,1/t),this.renderTarget.setSize(i.width,i.height)}initialize(e,t,i){e.capabilities.isWebGL2||console.error("The DepthDownsamplingPass requires WebGL 2")}},Qu={SKIP:0,ADD:1,ALPHA:2,AVERAGE:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,EXCLUSION:8,LIGHTEN:9,MULTIPLY:10,DIVIDE:11,NEGATION:12,NORMAL:13,OVERLAY:14,REFLECT:15,SCREEN:16,SOFT_LIGHT:17,SUBTRACT:18},Ku=new Map([[Qu.SKIP,null],[Qu.ADD,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return min(x+y,1.0)*opacity+x*(1.0-opacity);}"],[Qu.ALPHA,"vec3 blend(const in vec3 x,const in vec3 y,const in float opacity){return y*opacity+x*(1.0-opacity);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){float a=min(y.a,opacity);return vec4(blend(x.rgb,y.rgb,a),max(x.a,a));}"],[Qu.AVERAGE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(x+y)*0.5*opacity+x*(1.0-opacity);}"],[Qu.COLOR_BURN,"float blend(const in float x,const in float y){return(y==0.0)? y : max(1.0-(1.0-x)/y,0.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[Qu.COLOR_DODGE,"float blend(const in float x,const in float y){return(y==1.0)? y : min(x/(1.0-y),1.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[Qu.DARKEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return min(x,y)*opacity+x*(1.0-opacity);}"],[Qu.DIFFERENCE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return abs(x-y)*opacity+x*(1.0-opacity);}"],[Qu.EXCLUSION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(x+y-2.0*x*y)*opacity+x*(1.0-opacity);}"],[Qu.LIGHTEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return max(x,y)*opacity+x*(1.0-opacity);}"],[Qu.MULTIPLY,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return x*y*opacity+x*(1.0-opacity);}"],[Qu.DIVIDE,"float blend(const in float x,const in float y){return(y>0.0)? min(x/y,1.0): 1.0;}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[Qu.NEGATION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(1.0-abs(1.0-x-y))*opacity+x*(1.0-opacity);}"],[Qu.NORMAL,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y*opacity+x*(1.0-opacity);}"],[Qu.OVERLAY,"float blend(const in float x,const in float y){return(x<0.5)?(2.0*x*y):(1.0-2.0*(1.0-x)*(1.0-y));}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[Qu.REFLECT,"float blend(const in float x,const in float y){return(y==1.0)? y : min(x*x/(1.0-y),1.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[Qu.SCREEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(1.0-(1.0-x)*(1.0-y))*opacity+x*(1.0-opacity);}"],[Qu.SOFT_LIGHT,"float blend(const in float x,const in float y){return(y<0.5)?(2.0*x*y+x*x*(1.0-2.0*y)):(sqrt(x)*(2.0*y-1.0)+2.0*x*(1.0-y));}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[Qu.SUBTRACT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return max(x+y-1.0,0.0)*opacity+x*(1.0-opacity);}"]]),$u=class extends pe{constructor(e,t=1){super(),this.blendFunction=e,this.opacity=new jc(t)}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e,this.dispatchEvent({type:"change"})}getShaderCode(){return Ku.get(this.blendFunction)}},ed=class extends pe{constructor(e,t,{attributes:i=td.NONE,blendFunction:n=Qu.SCREEN,defines:a=new Map,uniforms:r=new Map,extensions:s=null,vertexShader:o=null}={}){super(),this.name=e,this.attributes=i,this.fragmentShader=t,this.vertexShader=o,this.defines=a,this.uniforms=r,this.extensions=s,this.blendMode=new $u(n),this.blendMode.addEventListener("change",(e=>this.setChanged()))}setChanged(){this.dispatchEvent({type:"change"})}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setDepthTexture(e,t=0){}update(e,t,i){}setSize(e,t){}initialize(e,t,i){}dispose(){for(const e of Object.keys(this)){const t=this[e];if(null!==t&&"function"==typeof t.dispose){if(t instanceof mr)continue;this[e].dispose()}}}},td={NONE:0,DEPTH:1,CONVOLUTION:2};function nd(e,t){const i=[];let n;for(;null!==(n=e.exec(t));)i.push(n[1]);return i}function ad(e,t,i){let n,a;for(const r of t){n="$1"+e+r.charAt(0).toUpperCase()+r.slice(1),a=new RegExp("([^\\.])(\\b"+r+"\\b)","g");for(const e of i.entries())null!==e[1]&&i.set(e[0],e[1].replace(a,n))}}function rd(e,t,i,n,a,r,s){const o=/(?:\w+\s+(\w+)\([\w\s,]*\)\s*{[^}]+})/g,l=/(?:varying\s+\w+\s+(\w*))/g,c=t.blendMode,h=new Map([["fragment",t.getFragmentShader()],["vertex",t.getVertexShader()]]),u=void 0!==h.get("fragment")&&/mainImage/.test(h.get("fragment")),d=void 0!==h.get("fragment")&&/mainUv/.test(h.get("fragment"));let p=[],m=[],f=!1,g=!1;if(void 0===h.get("fragment"))console.error("Missing fragment shader",t);else if(d&&0!=(s&td.CONVOLUTION))console.error("Effects that transform UV coordinates are incompatible with convolution effects",t);else if(u||d){if(d&&(i.set(Pu.FRAGMENT_MAIN_UV,i.get(Pu.FRAGMENT_MAIN_UV)+"\t"+e+"MainUv(UV);\n"),f=!0),null!==h.get("vertex")&&/mainSupport/.test(h.get("vertex"))){let t="\t"+e+"MainSupport(";/mainSupport *\([\w\s]*?uv\s*?\)/.test(h.get("vertex"))&&(t+="vUv"),t+=");\n",i.set(Pu.VERTEX_MAIN_SUPPORT,i.get(Pu.VERTEX_MAIN_SUPPORT)+t),p=p.concat(nd(l,h.get("vertex"))),m=m.concat(p).concat(nd(o,h.get("vertex")))}if(m=m.concat(nd(o,h.get("fragment"))).concat(Array.from(t.defines.keys()).map((e=>e.replace(/\([\w\s,]*\)/g,"")))).concat(Array.from(t.uniforms.keys())),t.uniforms.forEach(((t,i)=>r.set(e+i.charAt(0).toUpperCase()+i.slice(1),t))),t.defines.forEach(((t,i)=>a.set(e+i.charAt(0).toUpperCase()+i.slice(1),t))),ad(e,m,a),ad(e,m,h),n.set(c.blendFunction,c),u){const t=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;let n=e+"MainImage(color0, UV, ";0!=(s&td.DEPTH)&&t.test(h.get("fragment"))&&(n+="depth, ",g=!0),n+="color1);\n\t";const a=e+"BlendOpacity";r.set(a,c.opacity),n+="color0 = blend"+c.getBlendFunction()+"(color0, color1, "+a+");\n\n\t",i.set(Pu.FRAGMENT_MAIN_IMAGE,i.get(Pu.FRAGMENT_MAIN_IMAGE)+n),i.set(Pu.FRAGMENT_HEAD,i.get(Pu.FRAGMENT_HEAD)+"uniform float "+a+";\n\n")}i.set(Pu.FRAGMENT_HEAD,i.get(Pu.FRAGMENT_HEAD)+h.get("fragment")+"\n"),null!==h.get("vertex")&&i.set(Pu.VERTEX_HEAD,i.get(Pu.VERTEX_HEAD)+h.get("vertex")+"\n")}else console.error("The fragment shader contains neither a mainImage nor a mainUv function",t);return{varyings:p,transformedUv:f,readDepth:g}}var sd=class extends Uu{constructor(e,...t){super("EffectPass"),this.setFullscreenMaterial(new Iu(null,null,null,e)),this.effects=t.sort(((e,t)=>t.attributes-e.attributes)),this.skipRendering=!1,this.uniforms=0,this.varyings=0,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY}get encodeOutput(){return void 0!==this.getFullscreenMaterial().defines.ENCODE_OUTPUT}set encodeOutput(e){if(this.encodeOutput!==e){const t=this.getFullscreenMaterial();t.needsUpdate=!0,e?t.defines.ENCODE_OUTPUT="1":delete t.defines.ENCODE_OUTPUT}}get dithering(){return this.getFullscreenMaterial().dithering}set dithering(e){const t=this.getFullscreenMaterial();t.dithering!==e&&(t.dithering=e,t.needsUpdate=!0)}verifyResources(e){const t=e.capabilities;let i=Math.min(t.maxFragmentUniforms,t.maxVertexUniforms);this.uniforms>i&&console.warn("The current rendering context doesn't support more than "+i+" uniforms, but "+this.uniforms+" were defined"),i=t.maxVaryings,this.varyings>i&&console.warn("The current rendering context doesn't support more than "+i+" varyings, but "+this.varyings+" were defined")}updateMaterial(){const e=/\bblend\b/g,t=new Map([[Pu.FRAGMENT_HEAD,""],[Pu.FRAGMENT_MAIN_UV,""],[Pu.FRAGMENT_MAIN_IMAGE,""],[Pu.VERTEX_HEAD,""],[Pu.VERTEX_MAIN_SUPPORT,""]]),i=new Map,n=new Map,a=new Map,r=new Set;let s,o=0,l=0,c=0,h=!1,u=!1;for(const e of this.effects)if(e.blendMode.getBlendFunction()===Qu.SKIP)c|=e.getAttributes()&td.DEPTH;else if(0!=(c&td.CONVOLUTION)&&0!=(e.getAttributes()&td.CONVOLUTION))console.error("Convolution effects cannot be merged",e);else if(c|=e.getAttributes(),s=rd("e"+o++,e,t,i,n,a,c),l+=s.varyings.length,h=h||s.transformedUv,u=u||s.readDepth,null!==e.extensions)for(const t of e.extensions)r.add(t);for(const n of i.values())t.set(Pu.FRAGMENT_HEAD,t.get(Pu.FRAGMENT_HEAD)+n.getShaderCode().replace(e,"blend"+n.getBlendFunction())+"\n");0!=(c&td.DEPTH)?(u&&t.set(Pu.FRAGMENT_MAIN_IMAGE,"float depth = readDepth(UV);\n\n\t"+t.get(Pu.FRAGMENT_MAIN_IMAGE)),this.needsDepthTexture=null===this.getDepthTexture()):this.needsDepthTexture=!1,h?(t.set(Pu.FRAGMENT_MAIN_UV,"vec2 transformedUv = vUv;\n"+t.get(Pu.FRAGMENT_MAIN_UV)),n.set("UV","transformedUv")):n.set("UV","vUv"),t.forEach(((e,t,i)=>i.set(t,e.trim().replace(/^#/,"\n#")))),this.uniforms=a.size,this.varyings=l,this.skipRendering=0===o,this.needsSwap=!this.skipRendering;const d=this.getFullscreenMaterial();if(d.setShaderParts(t).setDefines(n).setUniforms(a),d.extensions={},r.size>0)for(const e of r)d.extensions[e]=!0;this.needsUpdate=!1}recompile(e){this.updateMaterial(),void 0!==e&&this.verifyResources(e)}getDepthTexture(){return this.getFullscreenMaterial().uniforms.depthBuffer.value}setDepthTexture(e,t=3200){const i=this.getFullscreenMaterial();i.uniforms.depthBuffer.value=e,i.depthPacking=t,i.needsUpdate=!0;for(const i of this.effects)i.setDepthTexture(e,t)}render(e,t,i,n,a){const r=this.getFullscreenMaterial(),s=r.uniforms.time.value+n;this.needsUpdate&&this.recompile(e);for(const i of this.effects)i.update(e,t,n);this.skipRendering&&!this.renderToScreen||(r.uniforms.inputBuffer.value=t.texture,r.uniforms.time.value=s<=this.maxTime?s:this.minTime,e.setRenderTarget(this.renderToScreen?null:i),e.render(this.scene,this.camera))}setSize(e,t){this.getFullscreenMaterial().setSize(e,t);for(const i of this.effects)i.setSize(e,t)}initialize(e,t,i){for(const n of this.effects)n.initialize(e,t,i),n.addEventListener("change",(e=>this.handleEvent(e)));if(this.updateMaterial(),this.verifyResources(e),void 0!==i&&i!==w){this.getFullscreenMaterial().defines.FRAMEBUFFER_PRECISION_HIGH="1"}}dispose(){super.dispose();for(const e of this.effects)e.dispose()}handleEvent(e){switch(e.type){case"change":this.needsUpdate=!0}}},od=class extends Uu{constructor({width:e=ju.AUTO_SIZE,height:t=ju.AUTO_SIZE,renderTarget:i,luminanceRange:n,colorOutput:a}={}){super("LuminancePass"),this.setFullscreenMaterial(new Ru(a,n)),this.needsSwap=!1,this.renderTarget=i,void 0===this.renderTarget&&(this.renderTarget=new Te(1,1,{minFilter:b,magFilter:b,format:a?I:P,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target",this.renderTarget.texture.generateMipmaps=!1),this.resolution=new ju(this,e,t)}get texture(){return this.renderTarget.texture}render(e,t,i,n,a){this.getFullscreenMaterial().uniforms.inputBuffer.value=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const i=this.resolution;i.base.set(e,t),this.renderTarget.setSize(i.width,i.height)}initialize(e,t,i){if(void 0!==i&&i!==w){this.getFullscreenMaterial().defines.FRAMEBUFFER_PRECISION_HIGH="1"}}},ld=class extends Uu{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new Wu(!1,!1,!0),this.inverse=!1}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}render(e,t,i,n,a){const r=e.getContext(),s=e.state.buffers,o=this.scene,l=this.camera,c=this.clearPass,h=this.inverse?0:1,u=1-h;s.color.setMask(!1),s.depth.setMask(!1),s.color.setLocked(!0),s.depth.setLocked(!0),s.stencil.setTest(!0),s.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),s.stencil.setFunc(r.ALWAYS,h,4294967295),s.stencil.setClear(u),s.stencil.setLocked(!0),this.clear&&(this.renderToScreen?c.render(e,null):(c.render(e,t),c.render(e,i))),this.renderToScreen?(e.setRenderTarget(null),e.render(o,l)):(e.setRenderTarget(t),e.render(o,l),e.setRenderTarget(i),e.render(o,l)),s.color.setLocked(!1),s.depth.setLocked(!1),s.stencil.setLocked(!1),s.stencil.setFunc(r.EQUAL,1,4294967295),s.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),s.stencil.setLocked(!0)}},cd=class extends Uu{constructor(e,t,{resolutionScale:i=1,width:n=ju.AUTO_SIZE,height:a=ju.AUTO_SIZE,renderTarget:r}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new Zu(e,t,new Eo);const s=this.renderPass.getClearPass();s.overrideClearColor=new Qt(7829503),s.overrideClearAlpha=1,this.renderTarget=r,void 0===this.renderTarget&&(this.renderTarget=new Te(1,1,{minFilter:g,magFilter:g,format:C,stencilBuffer:!1}),this.renderTarget.texture.name="NormalPass.Target"),this.resolution=new ju(this,n,a,i)}get texture(){return this.renderTarget.texture}getResolutionScale(){return this.resolutionScale}setResolutionScale(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}render(e,t,i,n,a){const r=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,r,r)}setSize(e,t){const i=this.resolution;i.base.set(e,t),this.renderTarget.setSize(i.width,i.height)}},hd=class extends Uu{constructor(e,t="inputBuffer"){super("ShaderPass"),this.setFullscreenMaterial(e),this.uniform=null,this.setInput(t)}setInput(e){const t=this.getFullscreenMaterial();if(this.uniform=null,null!==t){const i=t.uniforms;void 0!==i&&void 0!==i[e]&&(this.uniform=i[e])}}render(e,t,i,n,a){null!==this.uniform&&null!==t&&(this.uniform.value=t.texture),e.setRenderTarget(this.renderToScreen?null:i),e.render(this.scene,this.camera)}initialize(e,t,i){if(void 0!==i&&i!==w){this.getFullscreenMaterial().defines.FRAMEBUFFER_PRECISION_HIGH="1"}}},ud=class extends Set{constructor(e,t=10){super(),this.currentLayer=t,void 0!==e&&this.set(e)}get layer(){return this.currentLayer}set layer(e){const t=this.currentLayer;for(const i of this)i.layers.disable(t),i.layers.enable(e);this.currentLayer=e}clear(){const e=this.layer;for(const t of this)t.layers.disable(e);return super.clear()}set(e){this.clear();for(const t of e)this.add(t);return this}indexOf(e){return this.has(e)?0:-1}add(e){return e.layers.enable(this.layer),super.add(e),this}delete(e){return this.has(e)&&e.layers.disable(this.layer),super.delete(e)}setVisible(e){for(const t of this)e?t.layers.enable(0):t.layers.disable(0);return this}},dd=class extends ed{constructor({blendFunction:e=Qu.SCREEN,luminanceThreshold:t=.9,luminanceSmoothing:i=.025,resolutionScale:n=.5,intensity:a=1,width:r=ju.AUTO_SIZE,height:s=ju.AUTO_SIZE,kernelSize:o=wu.LARGE}={}){super("BloomEffect","#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D map;\n#else\nuniform lowp sampler2D map;\n#endif\nuniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=clamp(texture2D(map,uv)*intensity,0.0,1.0);}",{blendFunction:e,uniforms:new Map([["map",new jc(null)],["intensity",new jc(a)]])}),this.renderTarget=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.renderTarget.texture.generateMipmaps=!1,this.uniforms.get("map").value=this.renderTarget.texture,this.blurPass=new Hu({resolutionScale:n,width:r,height:s,kernelSize:o}),this.blurPass.resolution.resizable=this,this.luminancePass=new od({renderTarget:this.renderTarget,colorOutput:!0}),this.luminancePass.resolution=this.resolution,this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=i}get texture(){return this.renderTarget.texture}get luminanceMaterial(){return this.luminancePass.getFullscreenMaterial()}get resolution(){return this.blurPass.resolution}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return console.warn(this.name,"The distinction field has been removed, use luminanceMaterial.threshold and luminanceMaterial.smoothing instead."),1}set distinction(e){console.warn(this.name,"The distinction field has been removed, use luminanceMaterial.threshold and luminanceMaterial.smoothing instead.")}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,i){const n=this.renderTarget;this.luminancePass.enabled?(this.luminancePass.render(e,t,n),this.blurPass.render(e,n,n)):this.blurPass.render(e,t,n)}setSize(e,t){this.blurPass.setSize(e,t),this.renderTarget.setSize(this.resolution.width,this.resolution.height)}initialize(e,t,i){this.blurPass.initialize(e,t,i),t||i!==w||(this.renderTarget.texture.format=C),void 0!==i&&(this.renderTarget.texture.type=i)}},pd=class extends ed{constructor({blendFunction:e=Qu.NORMAL,brightness:t=0,contrast:i=0}={}){super("BrightnessContrastEffect","uniform float brightness;uniform float contrast;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=inputColor.rgb+vec3(brightness-0.5);if(contrast>0.0){color/=vec3(1.0-contrast);}else{color*=vec3(1.0+contrast);}outputColor=vec4(min(color+vec3(0.5),1.0),inputColor.a);}",{blendFunction:e,uniforms:new Map([["brightness",new jc(t)],["contrast",new jc(i)]])})}},md=class extends ed{constructor({blendFunction:e=Qu.NORMAL,inverted:t=!1}={}){super("DepthEffect","void mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){\n#ifdef INVERTED\nvec3 color=vec3(1.0-depth);\n#else\nvec3 color=vec3(depth);\n#endif\noutputColor=vec4(color,inputColor.a);}",{blendFunction:e,attributes:td.DEPTH}),this.inverted=t}get inverted(){return this.defines.has("INVERTED")}set inverted(e){this.inverted!==e&&(e?this.defines.set("INVERTED","1"):this.defines.delete("INVERTED"),this.setChanged())}},fd=class extends ed{constructor(e,{blendFunction:t=Qu.NORMAL,focusDistance:i=0,focalLength:n=.1,bokehScale:a=1,width:r=ju.AUTO_SIZE,height:s=ju.AUTO_SIZE}={}){super("DepthOfFieldEffect","#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D nearColorBuffer;uniform mediump sampler2D farColorBuffer;\n#else\nuniform lowp sampler2D nearColorBuffer;uniform lowp sampler2D farColorBuffer;\n#endif\nuniform lowp sampler2D nearCoCBuffer;uniform float scale;void mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){vec4 colorNear=texture2D(nearColorBuffer,uv);vec4 colorFar=texture2D(farColorBuffer,uv);float CoCNear=texture2D(nearCoCBuffer,uv).r;CoCNear=min(CoCNear*scale,1.0);vec4 result=inputColor*(1.0-colorFar.a)+colorFar;result=mix(result,colorNear,CoCNear);outputColor=result;}",{blendFunction:t,attributes:td.DEPTH,uniforms:new Map([["nearColorBuffer",new jc(null)],["farColorBuffer",new jc(null)],["nearCoCBuffer",new jc(null)],["scale",new jc(1)]])}),this.camera=e,this.renderTarget=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="DoF.Intermediate",this.renderTarget.texture.generateMipmaps=!1,this.renderTargetMasked=this.renderTarget.clone(),this.renderTargetMasked.texture.name="DoF.Masked.Far",this.renderTargetNear=this.renderTarget.clone(),this.renderTargetNear.texture.name="DoF.Bokeh.Near",this.uniforms.get("nearColorBuffer").value=this.renderTargetNear.texture,this.renderTargetFar=this.renderTarget.clone(),this.renderTargetFar.texture.name="DoF.Bokeh.Far",this.uniforms.get("farColorBuffer").value=this.renderTargetFar.texture,this.renderTargetCoC=this.renderTarget.clone(),this.renderTargetCoC.texture.format=C,this.renderTargetCoC.texture.name="DoF.CoC",this.renderTargetCoCBlurred=this.renderTargetCoC.clone(),this.renderTargetCoCBlurred.texture.name="DoF.CoC.Blurred",this.uniforms.get("nearCoCBuffer").value=this.renderTargetCoCBlurred.texture,this.cocPass=new hd(new bu(e));const o=this.circleOfConfusionMaterial;o.uniforms.focusDistance.value=i,o.uniforms.focalLength.value=n,this.blurPass=new Hu({width:r,height:s,kernelSize:wu.MEDIUM}),this.blurPass.resolution.resizable=this,this.maskPass=new hd(new Ou(this.renderTargetCoC.texture));const l=this.maskPass.getFullscreenMaterial();l.maskFunction=Du.MULTIPLY_RGB_SET_ALPHA,l.colorChannel=mu,this.bokehNearBasePass=new hd(new vu(!1,!0)),this.bokehNearFillPass=new hd(new vu(!0,!0)),this.bokehFarBasePass=new hd(new vu(!1,!1)),this.bokehFarFillPass=new hd(new vu(!0,!1)),this.bokehScale=a,this.target=null}get circleOfConfusionMaterial(){return this.cocPass.getFullscreenMaterial()}get resolution(){return this.blurPass.resolution}get bokehScale(){return this.uniforms.get("scale").value}set bokehScale(e){[this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].map((e=>e.getFullscreenMaterial().uniforms.scale)).forEach((t=>{t.value=e})),this.maskPass.getFullscreenMaterial().uniforms.strength.value=e,this.uniforms.get("scale").value=e}calculateFocusDistance(e){const t=this.camera,i=t.far-t.near,n=t.position.distanceTo(e);return Math.min(Math.max(n/i,0),1)}setDepthTexture(e,t=3200){const i=this.circleOfConfusionMaterial;i.uniforms.depthBuffer.value=e,i.depthPacking=t}update(e,t,i){const n=this.renderTarget,a=this.renderTargetCoC,r=this.renderTargetCoCBlurred,s=this.renderTargetMasked,o=this.bokehFarBasePass,l=this.bokehFarFillPass,c=o.getFullscreenMaterial().uniforms,h=l.getFullscreenMaterial().uniforms,u=this.bokehNearBasePass,d=this.bokehNearFillPass,p=u.getFullscreenMaterial().uniforms,m=d.getFullscreenMaterial().uniforms;if(null!==this.target){const e=this.calculateFocusDistance(this.target);this.circleOfConfusionMaterial.uniforms.focusDistance.value=e}this.cocPass.render(e,null,a),this.blurPass.render(e,a,r),this.maskPass.render(e,t,s),c.cocBuffer.value=h.cocBuffer.value=a.texture,o.render(e,s,n),l.render(e,n,this.renderTargetFar),p.cocBuffer.value=m.cocBuffer.value=r.texture,u.render(e,t,n),d.render(e,n,this.renderTargetNear)}setSize(e,t){const i=this.resolution;let n=[this.cocPass,this.blurPass,this.maskPass,this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass];n.push(this.renderTargetCoC,this.renderTargetMasked),n.forEach((i=>i.setSize(e,t)));const a=i.width,r=i.height;n=[this.renderTarget,this.renderTargetNear,this.renderTargetFar,this.renderTargetCoCBlurred],n.forEach((e=>e.setSize(a,r)));[this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].forEach((e=>e.getFullscreenMaterial().setTexelSize(1/a,1/r)))}initialize(e,t,i){[this.cocPass,this.maskPass,this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].forEach((n=>n.initialize(e,t,i))),this.blurPass.initialize(e,t,w),t||i!==w||(this.renderTargetNear.texture.type=C),void 0!==i&&(this.renderTarget.texture.type=i,this.renderTargetNear.texture.type=i,this.renderTargetFar.texture.type=i,this.renderTargetMasked.texture.type=i)}};var gd=class extends $i{constructor(e,t,i=1024,n=1009){super(function(e,t,i){const n=new Map([[P,1],[D,1],[L,2],[C,3],[I,4]]);let a;if(n.has(t)||console.error("Invalid noise texture format"),i===w){a=new Uint8Array(e*n.get(t));for(let e=0,t=a.length;e<t;++e)a[e]=255*Math.random()}else{a=new Float32Array(e*n.get(t));for(let e=0,t=a.length;e<t;++e)a[e]=Math.random()}return a}(e*t,i,n),e,t,i,n)}};new Ce,new it;var yd=class extends ed{constructor({blendFunction:e=Qu.NORMAL,hue:t=0,saturation:i=0}={}){super("HueSaturationEffect","uniform vec3 hue;uniform float saturation;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=vec3(dot(inputColor.rgb,hue.xyz),dot(inputColor.rgb,hue.zxy),dot(inputColor.rgb,hue.yzx));float average=(color.r+color.g+color.b)/3.0;vec3 diff=average-color;if(saturation>0.0){color+=diff*(1.0-1.0/(1.001-saturation));}else{color+=diff*-saturation;}outputColor=vec4(min(color,1.0),inputColor.a);}",{blendFunction:e,uniforms:new Map([["hue",new jc(new Ce)],["saturation",new jc(i)]])}),this.setHue(t)}setHue(e){const t=Math.sin(e),i=Math.cos(e);this.uniforms.get("hue").value.set(2*i,-Math.sqrt(3)*t-i,Math.sqrt(3)*t-i).addScalar(1).divideScalar(3)}};function vd(e,t,i){const n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),a=n.getContext("2d");if(n.width=e,n.height=t,i instanceof Image)a.drawImage(i,0,0);else{const n=a.createImageData(e,t);n.data.set(i),a.putImageData(n,0,0)}return n}var bd=class{constructor(e=0,t=0,i=null){this.width=e,this.height=t,this.data=i}toCanvas(){return"undefined"==typeof document?null:vd(this.width,this.height,this.data)}static from(e){const{width:t,height:i}=e;let n;if(e instanceof Image){const a=vd(t,i,e);if(null!==a){n=a.getContext("2d").getImageData(0,0,t,i).data}}else n=e.data;return new bd(t,i,n)}},_d="lut.scaleup",xd=new Qt,wd=class extends Tn{constructor(e,t){super(e,t,t,t),this.type=T,this.format=C,this.encoding=ee,this.minFilter=b,this.magFilter=b,this.wrapS=m,this.wrapT=m,this.wrapR=m,this.unpackAlignment=1,this.domainMin=new Ce(0,0,0),this.domainMax=new Ce(1,1,1)}get isLookupTexture3D(){return!0}scaleUp(e,t=!0){const i=this.image;let n;if(e<=i.width)n=Promise.reject(new Error("The target size must be greater than the current size"));else{const a=URL.createObjectURL(new Blob(['(()=>{var q={SCALE_UP:"lut.scaleup"};var _=[new Float32Array(3),new Float32Array(3)],t=[new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3)],U=[[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([0,1,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([0,1,1]),new Float32Array([1,1,1])]];function L(a,n,r,m){let h=r[0]-n[0],e=r[1]-n[1],s=r[2]-n[2],l=a[0]-n[0],w=a[1]-n[1],c=a[2]-n[2],y=e*c-s*w,A=s*l-h*c,g=h*w-e*l,p=Math.sqrt(y*y+A*A+g*g),V=p*.5,F=y/p,f=A/p,i=g/p,u=-(a[0]*F+a[1]*f+a[2]*i),M=m[0]*F+m[1]*f+m[2]*i;return Math.abs(M+u)*V/3}function X(a,n,r,m,h,e){let s=(r+m*n+h*n*n)*3;e[0]=a[s+0],e[1]=a[s+1],e[2]=a[s+2]}function k(a,n,r,m,h,e){let s=r*(n-1),l=m*(n-1),w=h*(n-1),c=Math.floor(s),y=Math.floor(l),A=Math.floor(w),g=Math.ceil(s),p=Math.ceil(l),V=Math.ceil(w),F=s-c,f=l-y,i=w-A;if(c===s&&y===l&&A===w)X(a,n,s,l,w,e);else{let u;F>=f&&f>=i?u=U[0]:F>=i&&i>=f?u=U[1]:i>=F&&F>=f?u=U[2]:f>=F&&F>=i?u=U[3]:f>=i&&i>=F?u=U[4]:i>=f&&f>=F&&(u=U[5]);let[M,x,P,T]=u,d=_[0];d[0]=F,d[1]=f,d[2]=i;let o=_[1],Y=g-c,Z=p-y,b=V-A;o[0]=Y*M[0]+c,o[1]=Z*M[1]+y,o[2]=b*M[2]+A,X(a,n,o[0],o[1],o[2],t[0]),o[0]=Y*x[0]+c,o[1]=Z*x[1]+y,o[2]=b*x[2]+A,X(a,n,o[0],o[1],o[2],t[1]),o[0]=Y*P[0]+c,o[1]=Z*P[1]+y,o[2]=b*P[2]+A,X(a,n,o[0],o[1],o[2],t[2]),o[0]=Y*T[0]+c,o[1]=Z*T[1]+y,o[2]=b*T[2]+A,X(a,n,o[0],o[1],o[2],t[3]);let v=L(x,P,T,d)*6,S=L(M,P,T,d)*6,C=L(M,x,T,d)*6,E=L(M,x,P,d)*6;t[0][0]*=v,t[0][1]*=v,t[0][2]*=v,t[1][0]*=S,t[1][1]*=S,t[1][2]*=S,t[2][0]*=C,t[2][1]*=C,t[2][2]*=C,t[3][0]*=E,t[3][1]*=E,t[3][2]*=E,e[0]=t[0][0]+t[1][0]+t[2][0]+t[3][0],e[1]=t[0][1]+t[1][1]+t[2][1]+t[3][1],e[2]=t[0][2]+t[1][2]+t[2][2]+t[3][2]}}var O=class{static expand(n,r){let m=Math.cbrt(n.length/3),h=new Float32Array(3),e=new n.constructor(r**3*3),s=1/(r-1);for(let l=0;l<r;++l)for(let w=0;w<r;++w)for(let c=0;c<r;++c){let y=c*s,A=w*s,g=l*s,p=Math.round(c+w*r+l*r*r)*3;k(n,m,y,A,g,h),e[p+0]=h[0],e[p+1]=h[1],e[p+2]=h[2]}return e}};self.addEventListener("message",a=>{let n=a.data,r=n.data;switch(n.operation){case q.SCALE_UP:r=O.expand(r,n.size);break}postMessage(r,[r.buffer]),close()});})();\n'],{type:"text/javascript"})),r=new Worker(a);n=new Promise(((n,s)=>{r.addEventListener("error",(e=>s(e.error))),r.addEventListener("message",(t=>{const i=new wd(t.data,e);i.encoding=this.encoding,i.type=this.type,i.name=this.name,URL.revokeObjectURL(a),n(i)}));const o=t?[i.data.buffer]:[];r.postMessage({operation:_d,data:i.data,size:e},o)}))}return n}applyLUT(e){const t=this.image,i=e.image,n=Math.min(t.width,t.height,t.depth);if(n!==Math.min(i.width,i.height,i.depth))console.error("Size mismatch");else if(e.type!==T||this.type!==T)console.error("Both LUTs must be FloatType textures");else if(e.format!==C||this.format!==C)console.error("Both LUTs must be RGB textures");else{const e=t.data,a=i.data,r=n,s=r-1;for(let t=0,i=r**3;t<i;++t){const i=3*t,n=e[i+0]*s,o=e[i+1]*s,l=e[i+2]*s,c=3*Math.round(n+o*r+l*r*r);e[i+0]=a[c+0],e[i+1]=a[c+1],e[i+2]=a[c+2]}this.needsUpdate=!0}return this}convertToUint8(){if(this.type===T){const e=this.image.data,t=new Uint8ClampedArray(e.length);for(let i=0,n=e.length;i<n;++i)t[i]=255*e[i];this.image.data=t,this.type=w,this.needsUpdate=!0}return this}convertToFloat(){if(this.type===w){const e=this.image.data,t=new Float32Array(e.length);for(let i=0,n=e.length;i<n;++i)t[i]=e[i]/255;this.image.data=t,this.type=T,this.needsUpdate=!0}return this}convertLinearToSRGB(){const e=this.image.data;if(this.type===T){const t=this.format===I?4:3;for(let i=0,n=e.length;i<n;i+=t)xd.fromArray(e,i).convertLinearToSRGB().toArray(e,i);this.encoding=te,this.needsUpdate=!0}else console.error("Color space conversion requires FloatType data");return this}convertSRGBToLinear(){const e=this.image.data;if(this.type===T){const t=this.format===I?4:3;for(let i=0,n=e.length;i<n;i+=t)xd.fromArray(e,i).convertSRGBToLinear().toArray(e,i);this.encoding=ee,this.needsUpdate=!0}else console.error("Color space conversion requires FloatType data");return this}convertToRGBA(){if(this.format===C){const e=this.image.width,t=this.image.data,i=new t.constructor(e**3*4),n=this.type===T?1:255;for(let e=0,a=0,r=t.length;e<r;e+=3,a+=4)i[a+0]=t[e+0],i[a+1]=t[e+1],i[a+2]=t[e+2],i[a+3]=n;this.image.data=i,this.format=I,this.needsUpdate=!0}return this}toDataTexture(){const e=this.image.width,t=this.image.height*this.image.depth,i=new $i(this.image.data,e,t);return i.name=this.name,i.type=this.type,i.format=this.format,i.encoding=this.encoding,i.minFilter=b,i.magFilter=b,i.wrapS=this.wrapS,i.wrapT=this.wrapT,i.generateMipmaps=!1,i}static from(e){const t=e.image,{width:i,height:n}=t,a=Math.min(i,n);let r;if(t instanceof Image){r=bd.from(t).data;const e=new Uint8Array(a**3*3);if(i>n)for(let t=0;t<a;++t)for(let i=0;i<a;++i)for(let n=0;n<a;++n){const s=4*(n+t*a+i*a*a),o=3*(n+i*a+t*a*a);e[o+0]=r[s+0],e[o+1]=r[s+1],e[o+2]=r[s+2]}else for(let t=0,i=a**3;t<i;++t){const i=4*t,n=3*t;e[n+0]=r[i+0],e[n+1]=r[i+1],e[n+2]=r[i+2]}r=e}else r=t.data.slice();const s=new wd(r,a);return s.type=e.type,s.encoding=e.encoding,s.name=e.name,s}static createNeutral(e){const t=new Float32Array(e**3*3),i=1/(e-1);for(let n=0;n<e;++n)for(let a=0;a<e;++a)for(let r=0;r<e;++r){const s=3*(n+a*e+r*e*e);t[s+0]=n*i,t[s+1]=a*i,t[s+2]=r*i}const n=new wd(t,e);return n.name="neutral",n}},Sd=class extends ed{constructor(e,{blendFunction:t=Qu.NORMAL,tetrahedralInterpolation:i=!1}={}){super("LUTEffect","uniform vec3 scale;uniform vec3 offset;\n#ifdef CUSTOM_INPUT_DOMAIN\nuniform vec3 domainMin;uniform vec3 domainMax;\n#endif\n#ifdef LUT_3D\n#ifdef LUT_PRECISION_HIGH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler3D lut;\n#else\nuniform mediump sampler3D lut;\n#endif\n#else\nuniform lowp sampler3D lut;\n#endif\nvec4 applyLUT(const in vec3 rgb){\n#ifdef TETRAHEDRAL_INTERPOLATION\nvec3 p=floor(rgb);vec3 f=rgb-p;vec3 v1=(p+0.5)*LUT_TEXEL_WIDTH;vec3 v4=(p+1.5)*LUT_TEXEL_WIDTH;vec3 v2,v3;vec3 frac;if(f.r>=f.g){if(f.g>f.b){frac=f.rgb;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else if(f.r>=f.b){frac=f.rbg;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v1.y,v4.z);}else{frac=f.brg;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v4.x,v1.y,v4.z);}}else{if(f.b>f.g){frac=f.bgr;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v1.x,v4.y,v4.z);}else if(f.r>=f.b){frac=f.grb;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else{frac=f.gbr;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v1.x,v4.y,v4.z);}}vec4 n1=texture(lut,v1);vec4 n2=texture(lut,v2);vec4 n3=texture(lut,v3);vec4 n4=texture(lut,v4);vec4 weights=vec4(1.0-frac.x,frac.x-frac.y,frac.y-frac.z,frac.z);vec4 result=weights*mat4(vec4(n1.r,n2.r,n3.r,n4.r),vec4(n1.g,n2.g,n3.g,n4.g),vec4(n1.b,n2.b,n3.b,n4.b),vec4(1.0));return vec4(result.rgb,1.0);\n#else\nreturn texture(lut,rgb);\n#endif\n}\n#else\n#ifdef LUT_PRECISION_HIGH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D lut;\n#else\nuniform mediump sampler2D lut;\n#endif\n#else\nuniform lowp sampler2D lut;\n#endif\nvec4 applyLUT(const in vec3 rgb){float slice=rgb.b*LUT_SIZE;float slice0=floor(slice);float interp=slice-slice0;float centeredInterp=interp-0.5;float slice1=slice0+sign(centeredInterp);\n#ifdef LUT_STRIP_HORIZONTAL\nfloat xOffset=clamp(rgb.r*LUT_TEXEL_HEIGHT,LUT_TEXEL_WIDTH*0.5,LUT_TEXEL_HEIGHT-LUT_TEXEL_WIDTH*0.5);vec2 uv0=vec2(slice0*LUT_TEXEL_HEIGHT+xOffset,rgb.g);vec2 uv1=vec2(slice1*LUT_TEXEL_HEIGHT+xOffset,rgb.g);\n#else\nfloat yOffset=clamp(rgb.g*LUT_TEXEL_WIDTH,LUT_TEXEL_HEIGHT*0.5,LUT_TEXEL_WIDTH-LUT_TEXEL_HEIGHT*0.5);vec2 uv0=vec2(rgb.r,slice0*LUT_TEXEL_WIDTH+yOffset);vec2 uv1=vec2(rgb.r,slice1*LUT_TEXEL_WIDTH+yOffset);\n#endif\nvec4 sample0=texture2D(lut,uv0);vec4 sample1=texture2D(lut,uv1);return mix(sample0,sample1,abs(centeredInterp));}\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 c=linearToInputTexel(inputColor).rgb;\n#ifdef CUSTOM_INPUT_DOMAIN\nif(c.r>=domainMin.r&&c.g>=domainMin.g&&c.b>=domainMin.b&&c.r<=domainMax.r&&c.g<=domainMax.g&&c.b<=domainMax.b){c=texelToLinear(applyLUT(scale*c+offset)).rgb;}else{c=inputColor.rgb;}\n#else\n#if !defined(LUT_3D) || defined(TETRAHEDRAL_INTERPOLATION)\nc=clamp(c,0.0,1.0);\n#endif\nc=texelToLinear(applyLUT(scale*c+offset)).rgb;\n#endif\noutputColor=vec4(c,inputColor.a);}",{blendFunction:t,uniforms:new Map([["lut",new jc(null)],["scale",new jc(new Ce)],["offset",new jc(new Ce)],["domainMin",new jc(null)],["domainMax",new jc(null)]])}),this.tetrahedralInterpolation=i,this.inputEncoding=te,this.outputEncoding=this.inputEncoding,this.setInputEncoding(te),this.setLUT(e)}getOutputEncoding(){return this.outputEncoding}getInputEncoding(){return this.inputEncoding}setInputEncoding(e){const t=this.defines,i=this.getLUT();switch(e){case te:t.set("linearToInputTexel(texel)","LinearTosRGB(texel)");break;case ee:t.set("linearToInputTexel(texel)","texel");break;default:console.error("Unsupported input encoding:",e)}if(null!==i)switch(this.outputEncoding=i.encoding===ee?e:i.encoding,this.outputEncoding){case te:t.set("texelToLinear(texel)","sRGBToLinear(texel)");break;case ee:t.set("texelToLinear(texel)","texel");break;default:console.error("Unsupported LUT encoding:",i.encoding)}this.inputEncoding!==e&&(this.inputEncoding=e,this.setChanged())}getLUT(){return this.uniforms.get("lut").value}setLUT(e){const t=this.defines,i=this.uniforms;if(this.getLUT()!==e){const n=e.image;if(t.clear(),t.set("LUT_SIZE",Math.min(n.width,n.height).toFixed(16)),t.set("LUT_TEXEL_WIDTH",(1/n.width).toFixed(16)),t.set("LUT_TEXEL_HEIGHT",(1/n.height).toFixed(16)),i.get("lut").value=e,i.get("domainMin").value=null,i.get("domainMax").value=null,e.type!==T&&e.type!==A||t.set("LUT_PRECISION_HIGH","1"),n.width>n.height?t.set("LUT_STRIP_HORIZONTAL","1"):e instanceof Tn&&t.set("LUT_3D","1"),e instanceof wd){const n=e.domainMin,a=e.domainMax;0===n.x&&0===n.y&&0===n.z&&1===a.x&&1===a.y&&1===a.z||(t.set("CUSTOM_INPUT_DOMAIN","1"),i.get("domainMin").value=n.clone(),i.get("domainMax").value=a.clone())}this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setInputEncoding(this.inputEncoding),this.setChanged()}}updateScaleOffset(){const e=this.getLUT(),t=Math.min(e.image.width,e.image.height),i=this.uniforms.get("scale").value,n=this.uniforms.get("offset").value;if(this.defines.has("TETRAHEDRAL_INTERPOLATION"))if(this.defines.has("CUSTOM_INPUT_DOMAIN")){const a=e.domainMax.clone().sub(e.domainMin);i.setScalar(t-1).divide(a),n.copy(e.domainMin).negate().multiply(i)}else i.setScalar(t-1),n.setScalar(0);else if(this.defines.has("CUSTOM_INPUT_DOMAIN")){const a=e.domainMax.clone().sub(e.domainMin).multiplyScalar(t);i.setScalar(t-1).divide(a),n.copy(e.domainMin).negate().multiply(i).addScalar(1/(2*t))}else i.setScalar((t-1)/t),n.setScalar(1/(2*t))}configureTetrahedralInterpolation(){const e=this.getLUT();e.minFilter=b,e.magFilter=b,this.defines.delete("TETRAHEDRAL_INTERPOLATION"),this.tetrahedralInterpolation&&null!==e&&(e instanceof Tn?(this.defines.set("TETRAHEDRAL_INTERPOLATION","1"),e.minFilter=g,e.magFilter=g):console.warn("Tetrahedral interpolation requires a 3D texture")),e.needsUpdate=!0}setTetrahedralInterpolationEnabled(e){this.tetrahedralInterpolation=e,this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setChanged()}},Md=class extends ed{constructor({blendFunction:e=Qu.SCREEN,premultiply:t=!1}={}){super("NoiseEffect","void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 noise=vec3(rand(uv*time));\n#ifdef PREMULTIPLY\noutputColor=vec4(min(inputColor.rgb*noise,vec3(1.0)),inputColor.a);\n#else\noutputColor=vec4(noise,inputColor.a);\n#endif\n}",{blendFunction:e}),this.premultiply=t}get premultiply(){return this.defines.has("PREMULTIPLY")}set premultiply(e){this.premultiply!==e&&(e?this.defines.set("PREMULTIPLY","1"):this.defines.delete("PREMULTIPLY"),this.setChanged())}},Td=class extends ed{constructor(e,t,{blendFunction:i=Qu.SCREEN,patternTexture:n=null,edgeStrength:a=1,pulseSpeed:r=0,visibleEdgeColor:s=16777215,hiddenEdgeColor:o=2230538,resolutionScale:l=.5,width:c=ju.AUTO_SIZE,height:h=ju.AUTO_SIZE,kernelSize:u=wu.VERY_SMALL,blur:d=!1,xRay:p=!0}={}){super("OutlineEffect","uniform lowp sampler2D edgeTexture;uniform lowp sampler2D maskTexture;uniform vec3 visibleEdgeColor;uniform vec3 hiddenEdgeColor;uniform float pulse;uniform float edgeStrength;\n#ifdef USE_PATTERN\nuniform lowp sampler2D patternTexture;varying vec2 vUvPattern;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 edge=texture2D(edgeTexture,uv).rg;vec2 mask=texture2D(maskTexture,uv).rg;\n#ifndef X_RAY\nedge.y=0.0;\n#endif\nedge*=(edgeStrength*mask.x*pulse);vec3 color=edge.x*visibleEdgeColor+edge.y*hiddenEdgeColor;float visibilityFactor=0.0;\n#ifdef USE_PATTERN\nvec4 patternColor=texture2D(patternTexture,vUvPattern);\n#ifdef X_RAY\nfloat hiddenFactor=0.5;\n#else\nfloat hiddenFactor=0.0;\n#endif\nvisibilityFactor=(1.0-mask.y>0.0)? 1.0 : hiddenFactor;visibilityFactor*=(1.0-mask.x)*patternColor.a;color+=visibilityFactor*patternColor.rgb;\n#endif\nfloat alpha=max(max(edge.x,edge.y),visibilityFactor);\n#ifdef ALPHA\noutputColor=vec4(color,alpha);\n#else\noutputColor=vec4(color,max(alpha,inputColor.a));\n#endif\n}",{uniforms:new Map([["maskTexture",new jc(null)],["edgeTexture",new jc(null)],["edgeStrength",new jc(a)],["visibleEdgeColor",new jc(new Qt(s))],["hiddenEdgeColor",new jc(new Qt(o))],["pulse",new jc(1)],["patternScale",new jc(1)],["patternTexture",new jc(null)]])}),this.blendMode.addEventListener("change",(e=>{this.blendMode.getBlendFunction()===Qu.ALPHA?this.defines.set("ALPHA","1"):this.defines.delete("ALPHA"),this.setChanged()})),this.blendMode.setBlendFunction(i),this.setPatternTexture(n),this.xRay=p,this.scene=e,this.camera=t,this.renderTargetMask=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,format:C}),this.renderTargetMask.texture.name="Outline.Mask",this.uniforms.get("maskTexture").value=this.renderTargetMask.texture,this.renderTargetOutline=this.renderTargetMask.clone(),this.renderTargetOutline.texture.name="Outline.Edges",this.renderTargetOutline.depthBuffer=!1,this.renderTargetBlurredOutline=this.renderTargetOutline.clone(),this.renderTargetBlurredOutline.texture.name="Outline.BlurredEdges",this.clearPass=new Wu,this.clearPass.overrideClearColor=new Qt(0),this.clearPass.overrideClearAlpha=1,this.depthPass=new qu(e,t),this.maskPass=new Zu(e,t,new Mu(this.depthPass.texture,t));const m=this.maskPass.getClearPass();m.overrideClearColor=new Qt(16777215),m.overrideClearAlpha=1,this.blurPass=new Hu({resolutionScale:l,width:c,height:h,kernelSize:u}),this.blurPass.resolution.resizable=this,this.blur=d,this.outlinePass=new hd(new Lu),this.outlinePass.getFullscreenMaterial().uniforms.inputBuffer.value=this.renderTargetMask.texture,this.time=0,this.selection=new ud,this.pulseSpeed=r}get resolution(){return this.blurPass.resolution}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get selectionLayer(){return this.selection.layer}set selectionLayer(e){this.selection.layer=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get blur(){return this.blurPass.enabled}set blur(e){this.blurPass.enabled=e,this.uniforms.get("edgeTexture").value=e?this.renderTargetBlurredOutline.texture:this.renderTargetOutline.texture}get xRay(){return this.defines.has("X_RAY")}set xRay(e){this.xRay!==e&&(e?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}setPatternTexture(e){null!==e?(e.wrapS=e.wrapT=d,this.defines.set("USE_PATTERN","1"),this.uniforms.get("patternTexture").value=e,this.setVertexShader("uniform float patternScale;varying vec2 vUvPattern;void mainSupport(const in vec2 uv){vUvPattern=uv*vec2(aspect,1.0)*patternScale;}")):(this.defines.delete("USE_PATTERN"),this.uniforms.get("patternTexture").value=null,this.setVertexShader(null)),this.setChanged()}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}setSelection(e){return this.selection.set(e),this}clearSelection(){return this.selection.clear(),this}selectObject(e){return this.selection.add(e),this}deselectObject(e){return this.selection.delete(e),this}update(e,t,i){const n=this.scene,a=this.camera,r=this.selection,s=this.uniforms.get("pulse"),o=n.background,l=a.layers.mask;r.size>0?(n.background=null,s.value=1,this.pulseSpeed>0&&(s.value=.625+.375*Math.cos(this.time*this.pulseSpeed*10)),this.time+=i,r.setVisible(!1),this.depthPass.render(e),r.setVisible(!0),a.layers.set(r.layer),this.maskPass.render(e,this.renderTargetMask),a.layers.mask=l,n.background=o,this.outlinePass.render(e,null,this.renderTargetOutline),this.blur&&this.blurPass.render(e,this.renderTargetOutline,this.renderTargetBlurredOutline)):this.time>0&&(this.clearPass.render(e,this.renderTargetMask),this.time=0)}setSize(e,t){this.blurPass.setSize(e,t),this.renderTargetMask.setSize(e,t);const i=this.resolution.width,n=this.resolution.height;this.depthPass.setSize(i,n),this.renderTargetOutline.setSize(i,n),this.renderTargetBlurredOutline.setSize(i,n),this.outlinePass.getFullscreenMaterial().setTexelSize(1/i,1/n)}initialize(e,t,i){this.blurPass.initialize(e,t,w),void 0!==i&&(this.depthPass.initialize(e,t,i),this.maskPass.initialize(e,t,i),this.outlinePass.initialize(e,t,i))}};new Ce,new Ce;var Ad="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAACm53kpAAAAeElEQVRYR+2XSwqAMAxEJ168ePEqwRSKhIIiuHjJqiU0gWE+1CQdApcVAMUAuARaMGCX1MIL/Ow13++9lW2s3mW9MWvsnWc/2fvGygwPAN4E8QzAA4CXAB6AHjG4JTHYI1ey3pcx6FHnEfhLDOIBKAmUBK6/ANUDTlROXAHd9EC1AAAAAElFTkSuQmCC",Ed="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAYAAAABNmBHAAAgAElEQVR4Xuy9CbhlV1ktOvbpq09DkiIkUBI6kxASIH0DlAQiIK1wRfSJTx+i4JX7vKIigs8HXpXvqVcvrcC9agQ7IDTSSWgqCQQliDRBJKkkhDSkqVPNqVOnP+8b//rH3P+eZ+199tlznVTlvVrft7+1T7OaueZY42/m37QALKNk2wHg1pITlB17mC+Pp11W3X/LHyT32vhg48/5SOv+PnwpsHA70JoGlueB1iKApeqzvOzn44GatTB76Xzhd7suBR7+WWADgDEAwwCG/L54b/poDLrHuvvm70Z2Avhsc+PVcxscBU8F8C8ADg5+ipIjD/PlGwfgju8B924E5seARUfLsiNmqQW0IjL8+7L2NYD/7COBzfcCm+aB8SVgdAkYIRCXKyDax4EdAanL5PuNPllNvXDlAHwFgP8AcC2AhRIoDXbsYb48dl5WkVFTE3LGDcC9m4CZCWBuFFgeAZaGAYJQQCRqDHT+McJrVb8zwATUXH02MHYfMHEIGFsAxgjApQqACYQORjtd/B7Axt/z79sC0+cMPgjjlwPwVwHcA+DfAHzTxcVgWBroqMN8+cYBeM71wH0TwKExYHYUWCIAHYRLTlkCYgcIBcAgU/n3qy8GRu4HRgnAOWBkERhddPAJhGJDBxkvw7cqimr+zFM/ZLnZF64cgL8BYD+AWwB8x/dlWuWagHiYL984AJ/0RWBy1AE4AizyM1yxYAcTigW55xMbAkxEiwEdkJ/ZCQxPAiOHgBECcKEC4TBZcKkSv+mTieNcNPNC26mLNsj45QD8LQDTAO4GcJt/7iw2bfoG4WG+vAGwm9ExiEg69zpg/wgwPQLMjgALzn4E4aIzoJjQ9g4024uygkj+pyuAoX0VAIfngOH5NgCHMhAm8Sv2y3XDZeBhNIp8OzJE8OsBzAKYBHAXgDt8/4O+MVT0j4f58o0D8Pxrgf3DwMwIMEPQEYRkNwfgsuuDZLskip0No0gWMD/9HGDoADAkAC4Aw/wsAgZAgs2Z0ABI0GU6IVmKv+f28KDnHxkA/G0A8y6G73N9kOCjXnh/Ebb6OvgwX75xAF5wLTA1VIHPADgMLDj4yIA5AAm6aCUnv4oz46eeDwxNAUMzwJAz4BABSNDFTwSfg7DDKHE23MG5PqIY8A1u/dINs9dBdy8AgnGPM2NfUBrsnw7z5RsH4IXXAAcJviFgluAbygBINnSLWOAjGxJ4pgOKDV0v/OSLKp8iGXBovhLBBOCQM2ACoTOhnYrAdItYbCij5JFzRyIAqRccAnDAQUjg6UNQ7hsMXP0cRQAexss3DsCLCECCLwCQzMcPwUi2MwAScAKbfnY/YRLFQ8DHX+IAJAMSfDkAF13kLvleIjhjQQHxUVS3jjgGpKeeNzYVQEjgUS8k+PghONdhIwAP4+XXBYCHKIJbwJyDTgaIAdCBJx3Q2M8tYAHP9m4df/ylQOsQ0JqtRLCx30K1wtLBggScQOgsKBGcWHAJeOwRC0BSM1mQIKRbhh+Bj98JQP6t4U0APEyXXxcAEnxkQAFwoVUxID9kvQg+c1C7vidRbIDkc24B//hTQGumDcCWA5DgMxASdNIFBUI5pCML8v8API5zfEQx4BudgqiczviSnJhQwCP4BMCGl+wO8+U7AJi/W4O4YS6+pmK/2ciADsAOBhTIIiAJnPB7AvNjP+0AnANaYkAHX2JBAc+tYaJXOqBZv24Vc386XW5dtkHGW+4HFAJonpOe+YYQZAShgKjv3PNvPQaxVoI8zJdfFwASfPzMUwS3Kt1v0UFIlos6oDFdAGFcliMAP/ryAEAGNwQRnDOgLbdlIEwrIs6AZ/QgkMMHQF6ZAKQcJAsSYPwIeAIk9wJgoPK1gi7+PwF4GC/fOAAvIQPSs0URTPBJ/Pp3GSEGRHfBCIQ0xowBtUbcAj7ys5X4Jfu1HIAGQrIgQRXEsAFQIORDFhiDY/rMHmrU4QUgR08AkgUjCAW6CD6CkwBsAIQC4GG6fPMA3OXiNzCg2I9gNCMksmAAoemDzoimFwL48M85AKkiuQVMAAp8CYRRDAt8GQiJ67N6GJODAXAHlsGguscA2AJg1IPGYmxOpBxFWkRN9LsATgIwXnNs/v/5z/9XCf8BO3YAtxbc/46/KDt+5+ea1Yku2VUxHz/z0v24FwMGK1gWsK2OUUxHHdCBeRUB6OxHABr4ZICIBd0QWSF+XRdMTAjgCdTrG9cBNwE4F8CpDkICyYLGsuhFt6zs+gISwUen8zEAjgMw4cfx2H6O/90yAFo84Cbg4ID3/9TfLTt+5+ebnRABkODjx0SwPi5ec/FrYpmqSAxM8Dn60CsqAFI6GfhqAMiDE/gokmvEr0C4PgDkBQm40wE8zMFEUDKEVoxIMLl/KS73mE7H9d+vcKHQQcjwW0Yu9nP8m8sAmOIBuWY6wP2/4s0ezjjg8TuvaR6ABJ70vxUApGrm7EbGE+i472BAB+WHfqHS/eoAaEwY2E9+wLSXTqhI7CXgnB6LCoOJ4BiST+hTnG0HcCwAglCx3ARoZEVFXnBPp/O/A/hXACc7CPs9/i1lAOyIB+RDX+P9/+pbQjjjAMfv/PL6AFDs1wFAgs/9fgKfgdE/ZEpuiQlbwAde6QAMBgiRmsSwA9BY0JfjovGRDBMH4TlcXGhcBOc6HkF0gjPhZgchxTLZMAci/04W/B6Ab3t09EPXcPyflgFwRTwgJ2MN9/8bf5qFM67x+B/aW4XQz42FeL0YrRyikztUFw0704mf9kXgxhOAqc3AAsPyRxxQCs/PdXOFY0W1KHy3QIUGtx+6vdnx1vsB+dsTncm2AogglFgVEAlUWrOMB2RyEmMCGQ/Y7/HvKns6tfGAnJQ+r/9b76oJZ1zD8WdyQjYBh8aBhVEHjELouQ8ukQ7VRSCJAALwkr+sALhnGzDD3JAJYJHg9uhoi4bx8ytkWUtvHT/7+Zc4dw1uZ3612fH2dkQf7yxIEEockwkJQn4IQoq8unhAhmPRKKFx0uv4K8ueTs94wD7u//VX9ghn7OP4c+4G7h8HpseB+dF2AKlFLwuAIZ8jD6NPrOhAffmfA9/ZBuzZCkyRWSeqBCWyoYGQ5yQrBpDbum/ME1HoPo0XEkSD2zlfbna8q6+EUJcTCxKEtHL5EQjP6BEPyIgYAZBvYt3xHyx7OqvGA65y/7/9wVXCGVc5/sl7qxD66dEqiYgRzAqhN1A4CBNAAlDyAFI+iZ9/N3DLJuC+jcDUBmCWyUnOrmTYCMIOkNclLg0B8/RsNLg9+UvNjnd1APLmmQpFHyEBROuWACQT8nN+H/GAvY7/VNnT6SsesMf13/CpahGnZzhjj+PPmwX2MYdDIfQexWyBAwEUOQDrRDN/98p3A7dvAO6fAA5sqHJDBEAyoUVGkwEd6HR12XU4kwzfl6fCXTZzjy57vvnR513X7Hj7AyDvggAUi9EyFgiZqNxPQF6345nOWbD1HQ/Y5fpvuLa/2+82/vNHgAPDFQDnhoF5j2C2qBWCI8bw1eRw5CL5l94L3DEOTI4DB8Y9OWmsEu/zBJ3rgsaybqBob/7A4C7jtWcooRrczr+u2fH2D0AOQgAUCxKEP7aGgLy64+m6KdjWFA9Yc/03/Osa4glrjr+AupqHz1sEs0cxG0BC9HIePLoit9eNkVf9L+DuUWByDJgaq4ybGYLPAWgiXmLedUE7dwC7saL7CqfPKXi4NYdaykCD410bAHlDEsNiwZ9wAPYbkJcfz6T2gm3N8YDZ9d/wHxUA+739fPwXPrSKYGb+BuP3jAFDElFH9HIWwbzCIGkBr/or4J4RYO8oMOW6ZVcAuvi1Cgoha04BCwT5gfMKHm7NoRde2+x41w5A3hQZkADk5+cGiAeMx3+/7AENFA8Yrv/G71cAXFM4Yzj+otOAaQLQA0gZxaIIZtMDFTigKJV8H9Iq6aZ59ZXAvSPAvpEKgBTtBODcSCWCZeRYtpzrmLyeGNCAyFl1v+Hei8qeb370Rdc2O97BAMi7EgB/2QG41nhAHU9LuWAbOB7Qr//GPRUA13r7Gv9FZwIMoVcEswEwfDoimEP0shKKtIphaZQAXv1+YM+wA3DEdcvRKkGJADQQEsQuhi1Tjt95vBsh5nx2IO59SsHDrTmUOStNjndwAAqEry0IyCMICkOyiuIBNwBvPFQQT7gBuPjc9oRYAIHyOEL4vIFEYVNaOou5vCGE/tV/A0wOVcnpzI47NOri3QFIBpSeaSDUdYLOSWvYImSGgftpJDa4MWJbAGxivGUA5MAOc0Be6eVLj7/4Mk+hzCOYPYpZDBiNkLh+G/M3yFyv/ltgL3W3YQfgcFUhgRY2PwY+Z7/EhAR1SFyXCOb57r28QfQBsJQBMn5D4y0HYLPje9Cd7RIC0PM3EiMofF4gVCBp1P840ix/gyz56r+vAMjk9Gl375iB4+CzveuZdLkkEPJ8ZEfX/6R73vOjzT5Si9hucLxHAVg4PwJgRwh9CKOXK8YA4ZEqKZXSQWh5P+5AftXfA/uGKvYjCKn72cctbFrZNECka5L5CPwIPtMH3TVz17MLB5gdLgA2Nd6jACycHwLQxFEUSR5ASvARDB0h9AQb9bXIgCGk6lUfAPYTgEPAITKgg1BObk58srTJgG58WMkWMaAbQQT1nc8rHGANAJsc71EAFs4PAagQestgC1lsBJ4BMCSOK6dDUcwqqaFiQr/0QeAAAdjy+jBiQQeeMSBZT3nCPUDIa9z+/MIB1gCwyfEeBWDh/BCAeQSzgkjFfGLBBD5nxQ4DxN0wv3hVxX5TBGDwL5obxvVA5YqYL5BeMLd66YYxJpRB0gK+96LCAdYAsMnxHgVg4fwIgMrhUPKQ2C+Bz0PmBTqBMQehAbDlIjj4F80KJguSVZ0FuXpjoCOgXawLjALhbT9eOMAuAGxqvEcBWDg/l1IE05Ed0ygZnyHdz0VwCqEPIfNyx0QQvvLDFQCp+8nfZk5und8tXwIgWcHSNX0N2CJmnAl3v6RwgNnhl17T7HiPArBwfghAS7mV/hey2JS9FvM3BLpUUi1YwDRMXvkRYJoAlAh2l0dcZ04s6JUTDIjyBcrl4yDc/dLCAdYAsMnxHgVg4fxwKVwJgGEJNmWtxpQMpX9on2eRhVA+O56AjMfnP+e3Xvf3NwG4xIPTleiY55bpGh6UbafNU0l0z0p+5Jh5HqYJ6b51nP6XP8cx12XNHQVgIQB/bFPVg2OC7Q+WgVFWng/FvtWLI06uWh5oguKEcXVS/9sEAF//VGD7t4ETDgJbF4CNi8CGZWBs2fPL/H6Vwp2KEtVk4fJ+v/EIYPN9wKa5qu+IncfPwXHVZe/aOL3EbwS7xv8A1rQvnO0j8PArTgTGZ4BxFv9mIxhOCGsv+0OPYDRghcLfkWkEuq0+G00x4OtfDGz+d2DbHmDLjL8si8AYP/7CGIAiEEMTG92zXqSbH+d9R2aA0XnvO+JjthiIrOVDHHPOkBrzUQAWAPsZp3oPDpa/Xag6EVkLBK+5rAnJC3/nYk/APD704WiEAV8OTHwX2LQH2DgFbJgFNrBhjd8r79deGoEwsllgNBOzy8CdjweG9wBj08AIAci2D6HafmyAk4/Z7SJ72hGYRwFYAMDLTwOGp4FRFgD3HhzqRGQiyeurqOdG6r0Rm8IEZjzRlkiqCWoEgK8Axm4BJu4HJhyAbFhDxmbDGnZO4j0SgLGDkpibgEq66TJw/1nA0F5gdLpq+zDqFfd5LMeWqu5HNST0uJOIllg+qgMWgI+HPv0xwLA3gWHpW2sC441gCECbmKziaGrnUdMO4aHeh6MxAP4SMHI7ML4HGD8AjHvHJGNAgpDgY/ck3stipRemvVhc+uASMPUEYGh/9dIRgGx8Y+MNbR/00uVtH0wEx94j/v0oAxaA8Ed+GBieAYZZg5kADC0QWGOFzGJlcGPzl1BxNLXD8sk4xftwNAbA/wwM3wGMUmxOOQBnHXzetIYvibonmSiuYTNjriVg7glAiwBk0fNZH6+PmX9P6kfNmCXGpftJ7TgKwBIAnln14BAAYxMYm5C6RjCyCoOyr0qkD/c+HI0B8DXA8N3AyCQwesD1VQKH7EcASm1Q+y4CkN9pUKiVF5nLvy+fBbTUd8QBaH1HvNBROiZvfsNnrF4kcvPwpdsBLBeU18Nf7AB23Dp4ecHC8oBgUlJJecLS+7+WOpE3gbE+HKw+yoevCYkMGKqPJrdEKARutaFYRs1fiEZ0wP8CDN8LDO8FRqYq3W10pgKgfYLaYCzootgA6KXaTA90y374TKB1sBozy77xHFZ536utRgAmEaw6g5kUSFZwSXnA330qsOlfgHMPDlZesLA8IOjoLypPWHj/11EnCiVwkz7kAExtsGraYUWdSDX5TmsagL8KDBGA7Bd30JsW0oWivnEOQNP7yGTSBR101AlZSUtGyfgZDkCWY1HnJdcBVe6325hTvelg2CQjZNDygG/2An0j1wKnL6y9vGBheUC8prQ8YeH9X39OVQSc7Mc6fCaKvAeHdCIVf4yMYCynTpX+nb97NJmlSQb8r8DQHm9YOFUZTKOzoXGhs6AxF0HIexcLBvWBuiHN8s2ne98R3qc6L4Vyb2oBVjfm9MIFHbjDCh6kPOBbQoG+oW8CO5bWVl6wsDwgfr20PGHh/X/1iaEIuDcCTIW/1Q4rFv8OnYiW3c+W2iKwUjKbyjQNwL1uuR6sAEgDgq1brXOmV81PxhNB6DUDBSYzQJwFtz623XcktX1Q1VWKaTF/zZhVazBVYA1tX5MazsGvobwe/jQr0Ne6BTh5uf/ygoXlAfG60vKEhff/rSe1i4DnTWDUACY1guFTDqLYdCBvf6DJYSMYATBfOx1kLfj1v1axH10nQ3Sd0GUkBnTfpemtBJgseIKQAHLQcVxa2TnuMW0Aqui5es8xBIegVdVVE8VhzHnLh65WMB9An+X18K6aAn2tO4ETl6vqbKuVFywsDwhevqg8YeH93/Rk70JE90nowxZbIJjvS3WYNSGUwGHJTpPxwwcbBuBrgRYBeKACn7VtpdUu/c0NJxO9BIxcKu4TTODzbkonPLoaL0vyUQRb2y8HsL1ckfWzMeuFi40Qezqi+yiPhyt7FOjr6/gCFwgP7Xb5vssTFt7/nQRg6MGRWmDRoeyTlpgw68GRTwgZgo1gGmXAX6/8dtaylSKY/koyID9BhzML3q1gAos2AcOrZYSoq/pJp1VtODRm9Z3LS/7WjVkvXOzEtOpKyGrlAT+4SoG+VY8vBGCvy/dVnrDw/vee65NBJiAjBIVcAJQjOm+DkCZEeiGAMw6sAwDZsJrAdhFM9rPGhd4904Co5oVuCZPV6kD40Ec6+9W8dBTBsfdc3nkpvnB82fp2RPcs79dHgb51LA9ofsDV6vut5/3PnxcAmLVBiDqgevDaJLkYrpuQxzcNwN8AWgIgRbB8loEBzXDwl4cGiDGft58SCOWGedgjvOJ+bPvgRkiuA+ZjzhnQQOiFNVbloa7l/fos0LdO5QENgEXlCfs8Qbf7HyMA3QVjYihYhLENgjX9y/qwxQmRU/asfd0ZcLU2CHVGyusJQLKfVi98CS12T5f7iECkHpsMkAhCF8+nshWH2I/jXsOYO144GV/9ApAIrS3vt4YCfetQHtAA2G+/4PW4/2PPbzMgmUMi2NoeSCRxIt2/FvuxWURIWCXg357gfTjEDNIHnTRXRCpH5ugKwGl3HpMBXQc0v6WLYVm/5limj04rG762K2uYY9jBkr9+rI03NL5ZbczS/dJ+LQyoga4o77fGAn0NlwdMAOy3vl/T938KAcj121z8Bn+Y9eWQJRz8Y6kNagDh2ey5EvxjxQD8TWdAuneCCO4An1vw5vdzQMmdktwq7pLZQR+dM34+ZumAxvY1Y04uqOAJ6FsExzeto7zfAAX6GiwPaLWR1lrfr8n7f/Rl3QGzmsis+/uO71V9OFgP2gpPhgr7TGRqRUT6dyvr4aIs/pm/2zVUNbBSv6G8e5pEv0Cvec7Po7+bTtjlBRlkvAMBkDeQyvsNWKCvofKACYBrre/X1P0/oWEAnnFD1YdjhtXxR73mX10FfCHHE9pVWcGAI/S0gKsfA2y+twrFZw6Hxf/F0Pk8Ri/kpGSnMuDx5T0iACgQHioo0NdAecBUHW6QdsV2/cL7v/Cyqr5gnc42CCOcfX1VIZ/V8We9IDmTzVXwPDJiXuKXPxtDBma8+lzP4WAgKkPxCUAPE4v5GzEuMX0PYJPLhB6FJsc7MAMmkVxaYC/K9gG+F1++8AQ7Gwbgk78I7GFpXgIwFiRXOwaJZPUbiR0yCUDRk+cHf+YpwMj9HgfI8ClGPyvsSiH0WSKRuYlitLb/zHM/JOSs5C/YIC9cMQDZr/dwxgOW9gtGYUBi0wA8l304vDQvAchilFbpIBQhZ7Ejq6ZQ0/Yhil8y4j89Axie9DAsD6FX9HOK3QtROTFkviN83kG4felIY8DCeLrSeMDSfsEovAECUFsTjHD+tcB+tkFgcXKvBRir7qtFl9owmO4Xy/1G3bAFfPrZHorFNWBFwHjQAFctIghj2kBarw06If/+MM9ZqTN6DgsDojCerjQesLRfMApvoGkAWh8Ob/tgAPSKWCp8ngNQtadjmTdltvNvn3peFYhgQQgh+iUmEaUAUoXM1yRLmWuFLaE9Z+XIAWBhPF1pPGBpv2AU3kDTALzwmqo6qtVh9kJErAudABia38TC5wJgS2xIhAwBn3yhByL4EhzXfRXxYsDTJ4IvrNN2JFMxZcBzVo4cABbG05XGA5b2C0bhDTQNQLZBYH1AVsQSAAU+imI1obHyblnjG/kJk3U8BHz8xVUQAhnQIl5CyNgKAGp5LKSSCoAySh5Jj79vTagcxUaIBeRNe79g9gq+DXig4wGzy+PONfT7RWFA4noAkGXZVAhcBckJQgNgrLiaNb3paIDo1vHHX+oA9LQBi4DxJcOUPJUnTgU2NJUyROs8irGARxQAC+PpCtsFd40H/AEf0gMQkLgeACT41PiGoLOKqyrJq3K/Ya9mNyr5FusN/uPLPIeDa8Bc+w3rtyl4VFHaMZc3i9RWBM9jjzgAFsbTFbYLRmm/YBTeQNMAtD4cBKDXBTQGdAB2MGBo8SCLmEuS1AFVAJ3A/NhPt0PoCcA8bSDG76XI7aySg6JYuGfKwJHFgH0E5B3ueMCe/Y4L+xVHAOZ+9EHcEgQgwbeiEYx6jwTdz4qfu7EhEJqxGqruf/RnHIAEnxgwBM0aC8aUAYWNBRCmoIll4HTqO122QcZbrgMWxtMVtgvuOx6wa7/jwhtoGoDWh4MBJ16WN4lfr8AqI0TVV1O1fa9BbQzovkAy4Ed+NgCQUSxZCFWvCOaOFREXyUwZOPIA2GdA3uGOB6wPaOz+QPv5S+MA3OXiN9aclghW+d3IgupBF2pPqxcxGenDPxfSRh2ASiKKiVP2PaZScvAKoA0VDc6cOlIB2GdA3uGOB1zR77iwX/F6AFB9ONSOQW0frA50sILVcckWJyIDSgwPAVcJgFbYuZ3FJvAlEHbJ3IsgJLGedeBIA+AAAXmHOx6wo99xYb/i9QKg2iAIfDJEJHqj4SExbEty0gkdhB/6P9oZbBZIGiKYVb9GKaN50lRHBLOvhDxh/5EKwDUG5B3ueMB2QGM/grb7/6wHAPNGMAY+GSGUjC52VX2f2CD4+HO0gqkZfegXKgBaHkcWtS0AWii9xG1ImrLlN5XR8L8fmQD05BVrmEENmpYSP9QX+KHiqj2/82+HqqDWwnbBRfGATdzAegGwru2DpRq7Mzq2fpAf0Nq0Rl2wBXzglZ4yUAPAmDSVWDBPHQjLcgTqOZ6zUvdKHh4ruDCerox/Dnu7YqwXAC1NI/QcEQuK6WK/kdgCTGC0PYAP/KIDMBgglq+hIkrOfsaCviLSofcJgJ5AdM7kkSaCj/HqQKVIGvD4swF8bcBjmzjsaQ2H5D/6acBd9wALB4DFWWB5AVherMp4GKIYEOp7+26UF0aSfT/xYuDG7wDjrIpAERytXf2vajj7ueryQXSFl10K/ON3gIWDwCLvjfGB8Z54O+Ee4ve6513uB2R1yzsqC+twbC8HcNVhfAeaBuDP/TvwtS3A/ePAIfYFVlPq2HHTuyulZCTlhbjhETF5yxTQGgPGhoHhIWC4VSXGD3n0tLkMHXHxu+YyB+MlPwDuZs5K6FlsbCzdVO9DuKfkHM8AEkP7B8fOkwDcD+B7np42+JkGOvKdAL4E4K8P0zvQdET0b14D3DgB3D0B7B8HZka9WzrD88N6sFm+YcUjrn7E1ZDvMtF9DBgeAYaHgSGB0PNHCD4BLwLRsByAyX/ij0/dDUxuqlIG5hix7eFhvLcOVUAtyPSydAFmOQNe6EYGV/9ZESiKgIEgtbaD/gHALQC4ovY5r5KwtjOU/XfTAHzzLuCmIeDuMWDvKHBwpMoN0WQzNtAaYSs0K4ZlOSAjGG9kPjCBRwZ0ABKEBJexYAZEAU3A7Oi1BeDym4EDnjQ1TwCGWMW8MXcKks0YOyZNlQOQjcgYIUHllEzYQ0ktm+r6oz8G4F4AXwXwRd8/kO9A0wB8y65KmPxgGJgcqYJTKYpTv2CCzyddQJRDOjKivn+Deh8BF8BnwBtaCUA+YYEyAU8h+c6Az9gNHHRmrgOgmDA3jHQ+iWupCeUAvNSrA9HNwqx+muk9nJVNg/CTfrmbAPwbgK8D+PcHkIibjob5o13A3XypWsAkG1cPA9PDFQDZM1id0i1KxsWfOrKnAFXlifCFFMMRcASigOcs2MGAIfE9iWXplS6On7UbmPaUUTXQrgsVMzcRj5Folg2V5ayUA5BWYKwOxKUafnosWjcJwk+7W5F2EKvlE3xcXaNYfiCYsGkA/smuqug6hcleAnAImPbO6YwRpMgjCAVAm/yQmKTv5hNsAf/i7SyNBSl2a8Qv/4/M1yF+BZSYlNQCnnVrpbC+mToAACAASURBVJcaI7sOSEY2NpaDXLqpR+vE/OVksDgImgGgghHoYJbTWc7oJtFWc65/cg2AYvh2ALsB3AzgVv95nS/f4QdsIkT9T3cBrGtITWZfC5hqtQHInsEGQn3UDDvEDEY/ICf7SxMOrAg8T+c00JGkvHGd2DABUYZIAONzCUDppCFhSukCBsLQrFtZe/IixYQpSyEoJoqnuPWrVRAubQh83HNlZB23z7j1ywmj6CIIqUPxw2Xeu9bx2jx10wz4Z7sqTYZaDD8EIDuoE3hMVEphWg66JIp90k0sBxBcy+iPIIaT1RtEsHS/yIAqw+VSNPWQfe5tlVEk8auXgVa5BUsEJuT5uoliAbE5AGotmIAjCPnR9xDG3TQernYAUupTdBGEFMf83OkApHG+XlvTAPwfuyrgSZOhas3u6cwTsUBVn2gTwyFMi8wjHZAA1M9fYGHDULJD1m8Cpa8fRxDad+l+Ykf/3XNvd11U+qiL39SxXevSsshdDFvgbI1O2AwAtRZMZzTBRuDFjxe1Xg8QEIB8yyj5yYIUxfQIkfkIRnmHCM712JoG4FsdgHHp3ACoMH2G6jM4lWzoQarSvwQ6MSB/vporVaFkh+mCLlpVR8Z+dqDZLoDOpHSiQeAFDkBjPrlgCHgCUaFifg67H/9uYjn4Ai1vpTERTAASBaoQJBAKeNqHlL6mwPDZYAOROag/EYRkPX34MwHIvzW9rQcA+TLpI22G7EcQKlJGsYIJhC6ClUMiXfBTbFUQAej6nPS/OuAl9pOOqIc2BLzg++3VmWgIEUz82cRuCAtLIHQQm0gO52uOAb22sC3JEWgRfPpZf2sQBQIgLydPEIFGwPEj8MlF2bSbsulghLftqsCXq9HGgHysznrGgi5qzTUTFH8FLhAUn3hIJwCN0HLncw37qaF2zoYvuKNivmQIuUNc7GvWt6sHNs26twA6vhyq8NEMAHlyntFrDCcQehyaPTl+FwAbXDcmAKMRThakEk8Q8kPg8SPL0qzLBl+A9QCgR6uZGs3vfHz8TtBZvkgGQrEPBVAUg2Sij50QAOjiVKI3saADJRm7dSLYWfSFDkCem/dhZeMy9pPY5QvSDYQyUJoDIK8qMezh3wY6fSL49PcGgCAA8pScJLIgAUYQEmz8RPA17StvGoBv39W24eREiBoNQSgWNI1HBkdgxJSw1AI+dFIbgOYmkjimQ1r6XXC3rAbCHycAgytohf8vsB/r2KRaRq7zpZ+D37HMX0s3DDcCUGLYaw53MJ4YUODzusqlGCQAOQCejuxA8UULUkxIwAmMAp8Wa3qkN/R9W+sBwOhIEPjk5SLr8HeKFbTQfb77csPIMHGl/4MPbReslPhNe4+MiTpi9AFGV4nI7MfvagNQLh/pfrYnDAS8aJQ42A2w4em2cAyWQUuJVQTGWLs1uL7DG9J1RjhA+jvYk4t3KXeMqijpzrud4At9z3XtP16yGfjKZmCGooYh1tZzvv8xXPFl4PoJYC97k9FlwZWD+Azi/deMZWeP13eQCGEyoERudChIjbb3mJYwH7V0QIKuCwj/gfMj0asn2I0FXRSHXfL/iRkNgLyeVj8ccMY//J1fyxzTAXT2+xoQViKYD/1hDqLxPiYxTgSvQrphphG97tz4Slqafnj7uk1kIQDZrvWTw8B3jwEW+RLxPgSiCERdPwPR7+wCPg/gulFgfruDkOMQkFc5x84e708JAMmCuRNBXi4TIg5CGRzGiBGE/D4E/C2r2vcAYJoify62i0aJSMhB+2IHoNwu0fkcjQ85pu3ack5nIBREqneYFyWLkAXIJHESe00Cyx5QyeL6F/tyEcDcrOW2n7fX8df0mME+/vQ/PQjhoy3gzo3AISYf80MQaQx1peH9wb7v2mrtmCBkIMMejp3jIJD1MsaxaMZ8v5N/67INAsB3BAYU4JL4DSo1J15AFPAEwuQHZJzkKfUAtOHLJSOQRWndBYQvCQA01cfnNopfsaCJaD2baBn79QjSTiOEP1EcawIpkq2kegBTNgHWEpOKF8Uwq2NRFPM4AqCf46/rA2U9/uVDvurB01zvAJpiiwOl3fEeciCGF+Ij11f+QkbSfMPfIzqw57mEFZ9Dl3Ps5HXWAYByHJAJKV7N+s0cCQQhwSlfm4lGZ0KB8C/rABgZUS6ZHITBSEhCowUYAAksF7cStWREyxRwtuPpOlgw+5s9sq6OaIJIIlUgEhA1edoTgHxa9HVw5jibZNF+j/9yGQA/7pbujZ4bwv2+cWB6tFo0NzYnkxFA+cvEAo43VBoEo2e+48EMXEOmD9F6xhCE8RwZEJ80VblKvDlmzwicfqy93/o+8K8TwB2jVSgW138FrJQTXBNlnJgmrjZwanow9CBP/rL9wF0jwAGWDtFyoN9PHutnIHT05mPXz93dMGQAPniJsjiBXiTbxDZFMF9NLUPQxKR5qezz1Y6/YZDH0D6GkdAkYJIvRalAdHAMmPZoYhb6NhDWvEyf/ma737CXN7R1ZC7hUbPgcFgqt/ZZjADnM1xqEVhYBpb4CUk5UsL7jQvj///5buDrLeCOEeD+YQchYwG9VIfyg1NaZszFiCH6DkRGLze5/dgk8IMWcMCjdCiCzR8od1B8OTwvJM8JEShFut1fzMhi+eRJr6LI7hYP2M/xVLwKNoZjUTwRMAQQmYyhWGQxsSADOflZ4kukj7PhZ75bETjBpkAGahMkcrGgwhsXeCyBHBj1wmOBQwvAwqKzoFeRV8ZaerjKYAuirmPY/o9X7q5Cyr7fAvYMAftCPGAEoYlBiVtFwLjtp2U4irj7yOANbi+crHyrfCbTquJV44O0F1FrwQGIMZFqdQDyP/gGSZ8TC0ZRRsOlVzzgasd/u+zpMByLehAfCgMQCDyGZJHFCCgLZ2f8mgI5qauEcVx9e5vACTgCTwEMWr5TdIpWKJb5MvrnoocDswvAPAG4VLGg6UKeqmi4iuDz4er30oX0FP7u5moMvIf7W8B+jwlUNAzFnlZCIhvGFRCeWzrgXSSIBreXTFZSgVLHAp4UHOFuociEEsn2PJwl/XEk0dzfSojeerFg1IOo5BKAveIBex1P67lgUzgWQaJwLAKRH04i14ItgDKEtGsRnWx49b2Vkk9wUefTGrKCF7R0JxZMqxN8cmPAxWcAcxGABKEAKPA5u9lEaAbCmKMI+sDN1X3z+ro24wEZFc0VEE64ABgT180PF9ZdBcDb6JpqcPtPk+1ACbmKjJnllwyuILunEAWjZHkBsrsRUnfD0qEiC5IJfyisgMhzWhcP2O14Ro4WbASgAMQJ48SJwchmBCDFa8qpyBbSP7OvU4PQ0p2W7+LSnSJUFOrI4V7w5IoBTQQTfJ6oTSYk2mQcpGRyH2syGjIF6EM3V/fM++C1CfwUExhCsmzCaQT43lZC3e1hBpEHh36XEqrB7Scmq5dV0XZxmV8WuDFzAF9iwhow9seAGoBcGtKjqAc+1l9rLb/1igesO55ysmCrC8ei6IxRMAKTWNBi6Xw98xNTFUi0jEcmpYgRAPhddpVi9OIEPP5cYD4CcLkCooHPwaW9kV+iwWrQHT8uA1fd3F7DFvgUHUP2k8jTiogAqLoxFpDgbMj9jXSuN7i9dLIdaxzBp5XVBMIMgFEnFAPKT9qPd6A9BIGI7MfPmf4U+40HzI8nWgq2PBxL4FEkjKJixGRRFyQQPzzd1iAUzCAQas1YOmAEoFjwkecDC/PAwhKw6CxIkCXwOdVJLxTobMjBdyIgfvimNvNJ7Evf4jWtdnRYD1YNGVuG93VWuWs4Jf+mlZCCZxwP/cnJ6mXVKk2+tK8lQQVHRTGc64SDAZB3Ey3JcxyACkToJx4wHl+YwqloGDICmYmTFgMQFBET8yyYzyAG/AfWX8mCGQg0BTRoHwt9KVaPE/HQ890AIfgWK+CRAaMRYnVdxHbhdY8Wslw1V93UDsmPIj9GxgiAioRRMIJNvoti+SW/Ikd0gwAU8+XxJcbGITJPDvI6XdCFREFSknTB83xka40H1PGF9dnycCxFwygkK0bASJQSVAbAYeD98xUAe5U3jKIwBosSgNsuABYogl3/IwgFPrOIg1Xc4ZrpAsSrvruykl2ucykapkMMh4CExD5DwJfWAYAxwk4MKPAJgOIjGSEGwuCakRhemw6Yv0UUwRf7L00L9pnsNx6Qx4feY4O8pDEcixOjsoTKKpMYjSFYYjOC8Eq3Wnnr0YYS+0Tmi2HysrPGLqwASNYzBnT2Mz2QD91laxLB0gs12GAh81cf/o/OcHyJ+qj0S/zxnhUZbSyYWaL8+Rq2S29wowiWkJPan4MvgrDDGAlRe7KIywDIgR3meEDWg9HbJgApNTkXo8o0i7oVgxnEgFr8F7jEdnU5GvqfJQKQKyEOPlsNIQvyvupAGHS/Okv4qv9oh+PHxMLk8ggBCRxvAmEN+AiEzz2iQfQBeNmkh4K52hJBKOaNe/FSLobLRXCz43rQnu2yi9oMSMDxs2jo8303ERz1wsCGZECF4kd3DwEYYwJjhoNlQrgIjlYodbBPrwMAZfEmyzcIv27gs6XDzC/IR1DOgA9a6DRz4wZAsZ+LYXvQYsHoD4ziOFklna6YD3+nnU6dZ7bGDAcBUImIAmEUw/zbJ1i/scGNDJiLXmle3RhQ+l/aq57gUQCWzwwBKPeLsZ/LFrGg/ShRXAe64Ajkv30kALAjF8R11Dy3K7KRwJcsUTaqWScARou3w/INVnCH+A36n8RvM3nB5XP4oD6DATBYwGb5ajlOLOh6X8JaBKRG77+7ygGYp1bn+V25/01AzBnwQ1ypanD7KWfA1QDYC3zJIj7KgOUzc9nFbetX/r+O5biwNhyX5uSEDr5o0xsJwLp8/m4A7GaJUv/j3/5+HQFYJ3oFPPkho/hNeqBcMkcB2BAA6XrxmMBkfFAci/m0JpwzXw0TXvXtzrz+PKc/Ml/ugzM9MDqCAbz/keVjjGcQA/YLvjoguo1mRslRI6RwfsiA5nqhL5D6nscF8gfTdfxpS+/hLzvWfzMQCoB1Fq/8b3VWaPIDZqsRV64DALsZHVHs1gEvsqFAeBSApQC8pHK90Oql4UEAyvCwNeGcBXNLOPMLftgZsI75ouUr9ousp2TEyIJ/sU4AzC1e+WIFshyAHPZREVwItrrD3wGAhibTYBhxVpe/xePyrNBuWaoNp3DgFwC81O+RAepK/a5Lfe51jxr7JwA83nPXYgq1asl0yX5N48+f4VEGLATlK1vAo5YB1gBSRmsM+NFE57lcfPD5pPFWCJImtyvGgGfOAacBYO59zFglgHgPefZsXV6/gPXBYeC0RVgyJNOGYuJjPka9eHWgjL9bWzhWk0/n/wPn+k8bgFNmgYcsVflZnBRmIShtJM/m7JGibGBoOIIez9wKPP4AcNpylfbNlGfdI+9NjBjz8JVzppckZuJ+dBw4aQ44drk6j1LIY9JkPD7P4s2lwVEGLHwJnncscNIh4Nh5YMsSsHm5ndOu1BGFThJ8/K6JrZtoslST2+XHA6ftB05ZAE5crgAups5TfaL6EF+UyIif3gAcOwtsXep82eIYY9JkXpMgMp/AeZQBC2b8OduBYw8C2+aALQvARgJwGZhY7swEzbNa88IRvAVO1qkF91J36DNOBE7eD2yfB45fqphLnevzdGeBKBfL8UX5/CZgyyyweRHYsFwxYHzRNK6oetSBMDLjUQAWTPqPngpsnQK2zgKbCMAlYMMSME4ALrcnR6JYQIwsoUnjpDRstOLy7cBJB4CHUGwuAtuW2nUDVH1EFUhycSwWjGD64mZg0xywcaECoI0z5P3X5P6nWlHdgHgUgAUAfOYOYMtBYNMssHEe2LgITBCADkIzSJZXpCOnIg25uPrhgnupO/TyhwLHHwSOmwW2LVSik2pCrDsQskzNIBGIpBdGI+VfNgMb5oENCxX4yPRjPj4xaJ0+WGeEHRXBDUz2Mx4FbDoIbJypADixUAFwzAFI8KUJChMV2SUaAGc1cE/xFJef3FYRti64nkqWDrqqEhbrsm5zvZCdPCd8nHzJOLZuABRz9hTHZwPL7LnLnoNMIY2VyaKcjtZLHOAbNgNPngKe4BacfGF1pnydD+hphQ/8XV5UiEueLGnDN1tWXj/3/4cTwAUzwGPcRcFJiDpPt3FLmf5vjwE2HAQ2zPrEzDv7OQg5OSM+ScYQy5Xbo8465u/ZfLTJ7fKHAdumKxVh8wKwealSE6inEoSy2MWCdbUHIghv3AqMzwHji9VLZuDzD8cXxxWZs5c7apmW0fMBnIHKn5X7d6I5npvRz94O7LgXuGIReJSb+Xl1tzqflybwRwqf9i97BQRWomWJQ7oZVFtJoqDX/b/oGODsvcBTATB9gsfGqmzdjtVz+G+PAyamgYmZCoDjFE2anCVg1CeJwOMnTRB/DmUINVkkgia3y08BtkwDW+YqAFJFMD1VAAw6XG61R31O9/fdrcDYPDDmY0zjc1UjivBuAMx1QdMB+WAYXU8dhEU16dOSkppbcHFSrng8MHwnsGMPcN5ypURHp2xMIa7zDz2z8Gn/kVe0YomO0wEwBYKujL7v/zHA6C3AxfOVh58g5AsZxx4fZM7sf3h6BcDxWWeGBZ+cMEFiwGEHHRnDzun7ONHs/djkRgBunql0VDOSHIDU3cxSD4aEajhFXS4H4S1bgVGN0V8we7E0Fh9jVDG6Obr1LJMRwn+kOCaTEYT0dsfqZHXl/p7PrLi9wIY7gO0H2yAgCAWCWCowKrYE8nMLn/a7PQn9X7zIJPPkCcK+758y7x7guNsB6l98gZjLLYet3Ay5n0sv4R+fCYxPA2MOwLEAQLIDPyP8uBg2cRYmzFweAYilKkn+OC8/Fdh0CNhEA4nGA40kd6FES13WLO8v1qHKAfh9B+DoYjU2Ak/js/8NAIwg7OUb7LCC+WAfB4CpBJoIiTRNRmS1l13kqWh3Adv2A8cdqqp1MB+aIOSxWv6pq5D2kkIAvt8rF7BLJksN/jMqfa7v+7/Ak4B3A6ceqpasKMq5akAmlLWY37t8ZW97PDB2qALg2BxgAFwANEGcnI5JcrDZRPlkaXL4u1KJUAfAjbTQ59x6dSvdLPXAgGYshZWR6JIRaXB/NwFI8C1WwLMXzMeSwLfcXuKrA2G+wrLCDcN/IIg4ERRn0qvyySAQX6mG1XuA4fuAbTOVwktRRr2MLCoQyvEZ/UY/WwjAj3jtFJZkU79g1ghkgEBf98+0Umb/3A2M3lkBl/fOcdMok2EjkZyv8773LAfgHDDKjwNwxEUw9yailpwdxBAEYhBbAuGzG3aKkQEJwAkCkOCjlb7Y6SYyf2UwlAS+vKYnAXjfNmDEX7DEfA5CjUcsnzvbu1nDtUMmCDkRZEEyGdlAk6G6lQTSa6m0MP6HuY73AxNTlcJLZ6WOJYC5/CNxLpHMgdKIKNl69Qvu6/75AjHOiTU87gKOOViJb748BKCWrnK/maTA+58AjM0Ao7PA6Lx/xBAupoYDC9okBRAmPdBZ47lNA/DhwMRsxX7mPgl+SrmK5EaRNRslXFQ9CKB9DkADn79cZtkHFkysJ103eBbqlh97DpmTQTYgk9VNxu+xYbXKU3lhFoJPOgdFGY+lPkgQxokkgF9Xgj4AvfoFs84eX4Ke9x9fIC+tRfDxvvniif358sSir2LCj5wNjBKAc8CIi2AxxLCzIAGY9L7AhGIKgpATw4l8wToB0JjPrfTkp+SLQbHrOqm5jNyajS6VCMIpApDAWwQ4LrGgXqzIfnq5cv0vN0ZXHTInME5GBNLb1DGdOYQsI7AfGKFjlgqve8wJwG4T+fuFAFytXzCLb+VgWnH/fIGYfc46Hs7iHC8ZkPcdXx4VfVXJw8+cA4wIgM6AHSLKWZCTESfLfg7WsIyRF3ckiRQ+HACXkwHptyP4KHrpJvKVGnOhRF9eBF9wE0mUEogz2wC+WGI/vVxiQQIxAs9+rmHA6E1YFYB8DJwQMZl0OrLZ++i7sfT8zroYHLS9df4RACWKxSZvLXzG/fQLZqk2gqn2/vUCUQ9UZaM9wDaPeSPrC4A5C1KV+NITKwCS/SiCR/jRBDlLmP7nHynsxno1IPwJSyRpbiMADXzuPDYfZfBTEoAmcuVQdiaW0zwXwQsCYDYmMaDA1wG8TBSvaoR0G77EcGSET6hjOvVApfRPAUN0zjr45JzVcSqiTxD+VeGzXku/4Nr7JwDJOkxFIwt6j6+RqUrlkO4bXzp1gCAAv04AzgLDDsBhKugLFUvQUhTwCEKbnKCw14HwJ9cDgGQ9WegRgDI8XEcVEDvAl7lVlglAgi+I4CR+Zf1mLGgMmDFhBGFfDCicRJFERviSABjLS7FC0MFKMU+07wOPE0kGvaoQgGvtF9z1/iODkwn3VWoEXxres5ib9xx1wZufBAwLgAQexbAD0JiQwJOuJBA68/H3Zhk6+3CifqqwWNMKN8wjKgbk6gWJgC+FMaBb5vJVmsUbV2vCqo3cRWZcCIACoax53+ulkqNd7iqOcU1WcC9cxEm5kQBUdZ+sTnSL/jEtTWngi21jhJNJBivZBukXvOL+yYBkcOqxKjJ4AGgxzMrBVwdAMmHrZOAYF2l6y/mwV6xD17zmWo6MbRyeWtOHwxJ91IIhr6rqZS70DPPLXDVUrfBwzHKr1EUp6/h0T/6L/GcCqslt4IhoTcwdAqDSs7I60WQH6R329pHuFyuXDJmEjuOSbdB+wSvuP5bGUjmsA5XoUvcvBXKKAQnApUdXwah0b8jXR2YzJTsC0ZHB33FL+2yiX3h/1YeD1fFZGT81g/H6yqkVa9YEpqMhTADle8erHA6t7Mh6j4ZBXdBGjFyO4CSIm9wGBiBvgqxwIAJQlXIyEJLyI/i0SkAG/FbhaEr6BXfcv+5dLKhCg4z1C1HEBJ8+BODQGZXfk/quAZC6ketAZEQCTWAU8PIJt0fgwHzZvVWNaKqi7JLOmtDWFy42g1FxH/XfqGkII0C+a0tnDkfsGxQjn3VPsk7tXmuy+Xp0JhtoJosAaFcUAJUYKiYJxcqHqKAH9rPlG2cMrmCUbMX9guMLpGTcCMKDlZGhMK8IPnPIn1X5PA2AwegwEEYmDGBMjOI5whGQP3NPBT7VJlRNaKvF4t2IWHbDErtDlSk1p4lJ7/zd246tglGZryIfrFhQ7pU8WCAX0ZENG+57U14Z4YrCeLrSxXdev6TfLwrbxT7znMrfKQXfHLQCnyvmRIv0Q3430ezMmL98P393G3wqz6am1NYzzoGn+svqRmTAU2citctqAX/2EI8F9ACEmLHXLZGoFxtSl2xyK2bAYwrj6Xr12+1noL/jUTCD9vvFrn6u0v1/nvGkaoVBAQi0eummMAuXQHMWJAA7gCixG8U0gFfcXdlBKk4Z6zELgAJfZEKrxpC1xOIl/+Sk7jkcdYlSco90y9+gK6vJrRiADD0piad7RuFo3udNCgft94vCdrGXn+tujgV3QAcHLcFnroelivHkchEL8ue0uQ74S3eubAITS3IQhKkMRjBMokgWG3L//2z3VSnP4VDgQWxUEEUxAZFHL0eR3HDfm3IRbDHkBfF0zy4EIKNhSvr9goGEBdvTz/MIYQLQdVsTwRTFDj5jQmdArRDYJQNDSs961R3tPhx5NXoVgoxleHnarjohgLec3D2HI492yQNvIwvqO9fJm9zKGbAwnu6FhaP5pFuMg/b7tTbpBdvTz68cz/zI8azVj8iAHTqgmFHXDUB89R2dtaC7tUGw4kDOgFb0R2wYRDGZ8g9O8aU4XwPOczhiwGlMjqqLWiFYGu570wADFsbTvaxg8nkow7E8nM/atfKzln6/1mS4YHv6BQ4+Z0BbqHcd0NwwYbVD3+1yWhXJxPBrbq8AqE/XApSqAxiBV2MZ/54DMOZwKE00rnDUWcR5KiV/brjtSAMALIyn+/mCyeehjIYp6fdrvVELth8RAClyHXxmhPi6r1m8FM0ucgk8+y4RHC1kAK/5XgW+2hZYofafWcPq1B5AqDqEYsQ3nepR2gqhV2yiol1COkD0C+aOaoGx4aL7DQCwMJ7uVwomn4fm7VrX2u/XAlELth+5sHPtN+l/Ap6sX2dCsZ/phZkIJgv9l++1wbcq+2WFv2NXIjNKAPzuw7MUAV8DTuynFIEsQy83RgTAhiv+NgBABaQOGE/3mwWTLwAqHnaQfr9GnwUbARgDNBUlkpzQboyYCyYDYdILdf0l4NduW9kGoa4geNdazLElKoA3Prx7DofiETtC6XvE7hGEzJlpcis3Qgrj6d5UOJoYDcMglrX2+y0NPtl5UZUjkfx/Hqbecoe0OZzdF1gHQrln9Bhee4s3f3Zxm4MvAk9VSFdUIw0i+Q2PaBtISiBSSFgCYMjMW00MP7pwvvLDmwFgQTzdHxcOSGvBg/b7ZRZByWYAlOERluKM3Ra9CKWc0q73dTBhMFT4ZwIw9l5Lrpes+HjeBiGCUOKXeuBvPcKTiEIOR0f+RhDBMYi0Lhea4GTaa5NbOQAVDzhgPB1La5RssV3rIP1+7yy5OAADoAchEHBkFbKfGRpiweAPtMs5IFNokyOGk/7rAYC9OhBFwNXVY1at5tftCBHaWVS2AJdEcEinrDNC+Lumiyc1B8AB4+muLARAXTDCWvr93lR4/Z0Xt6ODFQkj8WtumEwHTKDLQejAfN3uds/dfjoQdatGLxb8jQBAYz6/boxiFgAVudzNIc2/s3xLk1szAORoB4yn+2DhaATAGJCtbpkCYq9+v4V+aBgAQ4i66XtaC85YkDog/zdZvzUgfN1N7a633Xqv6fe9msDIHfNaB6Ay2JRE1AHAEDIfI5nzZCLeN4Nbm9yaA+CA8XSsul6yqV0rJ2WQfr+splCyCYBR/HJyKX4phs0PKBZ0lqOYTpvniAiUAmAd+HKjo1cvDjHgr+3wPJQsVCymUZrPMuRsRBDG4AQCsunyJtFGHwAAIABJREFUcc0BUJlxQoH62q8ST8cggpKNAFRGwCD9fkuvbwAkyGgJE3C+Nz1P1q9/T3F1EZBxvZh50s6AEYC5yyUHXt5/Q8zI5/KrAmAIkkipkyGPYwXz1aRT8v5ZO6jJrRyAvKOvNXlLazsXs9bo/ztc29Pohgotp5J49Rcj/pzfIwGS//3OM4CNd1dpntQpFUmjEH4LYIgnyn/OLjL8FeDGhwJbNgFjI8DIEDA8BAy1PFK7FSKf43cNKrvHx+8C/vmxwMgmYHgEaA35J0StpvvzL/nP8RbLAfhyT207TChgDRiu/ZL9DsfWNABvYzbhCDBKoBAk/pEobGWTqp819hzQ1/0k0PoaMDEJbJjxVZFgDad0SaUO5LksWVj+XScDmw5UEUDJ6U4d0nVbC91S3ovfVHp5al64cgC+k7mZAP768KCA0WD3A/ieLz090CDceVmlAuhBljLgrfcAw6PAyDAwPFwBkCAbItM4a/FiNtERjBl76W9ffD2AbwJDdwFj+6syImRXrd5Y2FjIYcnzWPLEqnsfC0zsr6qBMQmfIDR/pyJ6xMhKyMrSDiKD2xja6TADTt0/AGAs1KcAUCFrOLF6tbtiRVFavT/wuMCa7MfVTlH098YBeBcwNAIMEYAUlS4uBULOmK3LCnwOPANlEIOSoF9+C4DvVoWXhvdWZVOYqWgi3vOXDUQhgieB0EElViMYJ08HxqeqnG8D4IIDkAzo51DKQQJvBKUmKACzbM4+5hUivwrgiwC4LzvjmgCh6nBcgiMTcv9Abo0D8E6g5eCjfpUA6AxoQIzgi8ALmWwC4z//DxcPPwBak8DQFDB8yJPpPZHeGCyC0KN5DFCByfh9/+OAsekKgEzCTwD047X0SCPM1IYQjCv2E/MJoGVwUUQoPboq0MdqkWVn7RtDDMahB4g+P6qhXFpjVtkDtRGA2nKjos7IyOyHFUbIrXe0FXsTuzIYfNb4O2M3ATGIYQOmPn6hG6gi3eUkQQAeAIYOAUOzALMVh2pAlESqGFBAXAYOMQVjxll03iO/yYKRAT0FQXkwZkjp1pz51LO2XAT3KtD3AIAwj4Wg05kfiuUHYlsXAJLVnP0INLM0OYFx78AzcRySeTsw2AJueI+Dj2Fne4EWKz5MA0MzDkCCkAByUWqsJzarEanzj2zXwjEGFHuGY+pYsMojzZL1G9EBexXou339IRBrC3lJGmNDuSHX+w7WC4Cm6wWxm8DngLTImgC8pBcGBuTXf/1fXnyTugnFwxTQOgi0CECyIFlsvvJfEnh0mhsYI/s5uxFYi1xZof7oOqSAawwYjRGBzYGXbtWXaCIrlvHUagX6SP/ruMVYCEbEqECXAMjfree2HgA0ESur1/0vtnNwGSsG0RsZME20/+/XWH6Mugk/yngPAGy5GDYALjiIHIgRUIrsZjM7Ax+BSx1S4pfffQVIep8dL7dMDsTGjJB+CvQxTHmdtrw4l0CovFruC2NOe975egDQsCXRK/eK634JhBK90q2C7I1i+Gt0jxF40k1cPJAB7UP2m3MGJAAFQrGei9iUTH9yBUDTHfU3B5+BOIKQ43BWtNtPcWIOzEZE8FoK9K0DCGNxLi3FqaKA9gTgeoFwPQAoI0OulWT11oEwiFz7cwbErzNxWtEYBB+VY76Vh4DWrH8IOoGQ7Ocg1CqMRLPltmxvs1/SHaP4dcAJePYyyUCRIzrTB8tE8FoL9DUMwl61kQQ87Rmy2PS2rgB0a1ci18RudEJH57OsY02y/+83/sZdBKr4FXQTApBvprGgQCg9UEAM+h9F6ugJDkC3gJPBEvRGrYoYCBX9IxEcS5K4i6cZAHIw8oXQ4mLBb35YH5d7OekadtTV1UZSjaEIPH4nQzYNwgjAHNwDuWGYpZc7lzPfX1cQur5oBorfzDf+zi0yVTuSkuxBI2Q+PhQDIUEnMLo1TBCZLufGw/ixbQa0KB8CTODjPohdY78IQmfDjmW7Yo/doAX6GqIiAtDHaYswSmeMubV81kp11L6hy2PdAcgblfslOKC1IiKRmyRxZgV/8++DS8BFrxXi5Hd/U6MeSKdqEsEKhpBRsgRMbAtuG4KU/+9ry5brzP/lPVMv1EPOQegharrVcgZUhVHFxNPcp9VFtlOWkL437C0WABWypFRGsV0sb5Hn2zYBwvUGoKl10v1knDgo0y7XA8Pfv0UACnjaK33Co9gJQAOe64FkNvtZAHQdjz9v2Nz2GSa3jYej2W3KGuZ9ixGdIVSoKT13B2s5AHkGheST6qn0erHv5AIgAAU+LVfw/wq3CEAV7clBKDDGZG9/5oVXx/oyYARczcqH5GyH8eFplTawFvAtrtXLGpNrQDGbejupB3omlIHQGc/ErzOcGSRs8zrhAbbuL1Tco/JfbLlNwHOmi2kIcs3owbdwNpYtynDQhsFcgvuG9/YapGFvYX22zZcAU0/GwA2LJ/4AmGF9mwEbBu98Y3cMF+uAGQCj2HVp3BbPuo3IlqxAy5wHAq4OfARmEBXGfNIBa0BIsG0ecwC67merHgRpZLwocrWaovuTxew/V0txJQ2DWeae3WAGbdhb2DB4+wRw7w5g8Qpv88liyGtoWHzMi4C9fAEHbBi8kwUKu2xNAdBxaGBLbJdZux1LwAGECYAEm6wyfpelJrEgFnRDxESwgyUxIUsVMwjVy5AYO0bG89Auu1/5BF38KqjBHlUAYXsteNCGwTeWNuwtk4JMkrlzGNizA1hm69g1Nix+zDOBW0aBeRZZGqBh8M4emfWNADDT+zqMjQyESdQFHfDbZECCLRgdHeCTe8CBaKJY1rDnBRCIAuGW4TYAZeFG8ZuMkGiQ1IEwGCJtHZBmy1obBsvVMnDD3jIAerti3LEBOMjGcOpa3WfD4ic9t6oveDtLfw7QMHjnH6wPAybW6yaG4+8D4HIQfvtDIVtLejpBFsVvUI7NIBHw3DUjRzL3rDVtsYPOkAScuX3coNDynT2VYJCkn+PjqvUD8hVbS8NgjphGxcANe8sAGNoVY/824BCBtIaGxRe8pLKZdpMkTvXiJ2toGHzSNHDPScAyq3er4qPyGaNc7JCRXWLT2TjwGmCOeQashq6+qSpZmp8vojQpheF58ncdZVjLnjWPHr4VWKTKxrHGUqq97qXu3jp0wPy+eEC/DYNZsZAO6IEb9pY9lNCuGPcNV830ZmkM9dmw+OKfbdcXvJMPdY0Ng0/7GnDXKcDMccBS7MwdKz8KCAKQIgY0MWGCtr4TOHAasMwOkTqf6unyuLykfd254nkb7qsw/iVg7jhgmSX31Vpd9yRHeLx+zRhjEGRbB6wDYT8NdymyubzDzCCGfpMJWfSRYfr9HP/aMgBm7YoxNQHMbQHm+ID6aFh8yS93tAvGQb7da2gYfPoXgbtPAqaPA+a3AEubgGU1RM6B060fgkRoCzj+TcD+04CFE4BldZdRc4/YxlxgjJMewSiwN1zWfsOngdljq3EmY08vm5i/7j5yIMqpvupKyGoNg9lngYosl9wY/0dZdrMzYl8Ne8sAWNOu2MA3zw/F2CoNiy99XbvftrcLriz6PhsGn3U9cM9xMODObQYWCMANwPJ49UliuW6SaqqBn/gGYP8pwPyJwNIxwDK76ahDeN6uXYCuYyABkEza4LbpY5WEWdSLxjF26/dQB0SJ6r4ByAN6NQxmkWcqrnQ00x1DEDJFjR8CcNWGvWVPp6ZdMQ6OVOCb3wAscPJ6NCy+7PerkP5Q3tBY1PrT9tEw+JwbgPu2AlNbgVkCcCOwtAFYcgAuiwWlM/XqDjMEbP9t4MB2YO54YJFMo/5gHIcALV1TRZ17FXOhPtvgtvkqf9H4kvHDlyKK4l6VzvVSBF22uwjOb7pbw+CfcwBSkyeFEHAUx/yw9JTyEbo27C17Ol3aFWNuAlgIn9QxO2tYfNlbK6MvaxeMRYquvL9rTcPgJ30TuH8LcHAzMOugX3QALo21WXBZLEHwRF1OgHS2eOgbgIPHA7PHAezNu7QFWFZ7JnXJ5rnqxHEulvlzwyVNN3+wern5Yovl7SXLGwvn4riLWO4fgMRJXcPd/+pmOymELEhRzBxJAo9gVL4kwVnbsLccgHEpWi3epocCAMeBRU5eTcPiy/6qtl0wpvhA+2gYfO7NwOQm4OBGYGaDs+5ExYDGgqP+ccAkINaVpB8GTv4d4OBxwNw2YGFrxYCmV0YxLNYheCXau7EhV3ga3Lb8g4+R45uoGLADgHWqhsBXA8K1AZADyRvuvtkBSArh+i9DsQhCOtf0UUgW/7aiYW/Z0+nRrhizoxXwFhyAi5y4rGHxU66qAFhT3rDSIVdpGHzencDejcDBDcDsBDBP1uX1CMJRwFiQIBzxieL3KIY1YW5MPOxNwLRb8gs0aghAss1GZ1O+SFHsdRPt0i/PLHu++dFb/x4mXfhcbWxhfCtYMFr/uWvKxfDaAcg7ipPCvFOVpuo3HrCjYW/ZA+rRrti6TS6MVQ+L4NPH2nx698GnXF0BsKa8Iab4dFZpGHz+JLBvApieqAA4J8CPOQuOBBAOV0CUYbIskRkAecrvAdNbXc/aDCxSpyT4CEIyTgRgneiLIp3nP6fs+a4A4N8B8/48CUC+ZGJA29fpuLmxJW+5h5kNFg2jiWHSi0r0Uv4pCoZsxw8DUfnhd4Vk0XGdGvaWPaBV2hVjdjgA0BlpkQ/K9bmn/HOVqtClvKEBqlfD4AtmgP3jDsBxB6DA7tdbcvYzJvQJkii2n4NOeMpbgJktbYPGACiF3wFoEx1ZMNe/4jnPLXu+KwD4t/5SO/iMBcXuesHylyACMBPDgzGg7opM8mEHIGdwrfGA1rC37AH10a64Yr4APvvOSdwEPOVbKxu+K2pdKRTmdI3dqkPPVgbSTBGAY8AsATjWniBdx0QxJylOFCcr6HBiw1P/CDgU3EgEIMW52M8YkLolQRddIN1AyKWiBretf9MJQN6HsaCPxe4rvgDdHOcOxDIAcmDFDXvLnk4f7Yqt63gEIB/Yoj+4p9xaAbBHeUPM8qF2aRh84QQwNQYcGgdmx4C50WqCFngNsgSvQ+Dxu4MuiawhwIAXVk1O+e/A7CZgThY1dcno1nHL2oDIyZULpBsAFTBZ9pjT0QQgn2V6ufRicS8QRgbs5ZYpEsENDejBfpoLrwAOjgIzZMBRZ0AHoUC+SOA56xJwNlEyTFw5FxBPeWvlzpnbANCdQ1eSGTRybMuydgMggVBsKmtYoC6Mt8znZxsZMLzAxoAOvsh+ydDqtXx4FIDl8L/omQ7A0QqA82S/ERdTI22mNfaTuBIIxR4BhKe+y61punQC+MytI/Zz/c9EuvyBeetLAfGZ5WOMZ9j2/gqABB1fMLsHAVBqhfTcyH5d9MByEdzs+B50Z7voGZX+NzNSsd8cwUcG5ASRKYbdHRNYwhhDIHRgGmO0gFP+HJh15jOXjnyKblVT5Cbfoq+yJOszF8P8+VnNPlICkMAzds/YLxlYznrJwIpO6egTPMqA5ZNDAB6iCCYAyYBcBqTRQ0e4630SxZyQJQIvMJ8mSeLrYe+p/GzGfnTpEIBy6US/out+K1wg+brs88rHmDOgAVCMnrEfxxMte1Mt6j7u9zzKgIXzczEBOJIB0BnCJoqgIfDEhM58SWzJEPGJe9hfVH42un/Mfxl9bgSiBySIBWnAJBDGEDAB8QWFA8wO3/a+wH4+rg4RLPYLul8tCI8CsJmJMQAOuwFC9qMI9g9Z0CxhZz65K0wfFBPqu7PEyVdWAOTHVlTcpxhXHZLz1w0ZA6EDLhkCskRf0sw4dRYC0PQ/vVSRAYPo7QCdj7GqVOSMeBSAzUzMxZcDMwLgcKX/zbv45SQlHXDIgagJc+bjZBqAWhUoH/Y+B2D0J7rFa6LYDRmzomsAaOeKqxEvbWacHQB08JkRIteSXiSBLYJOLB+X4xrzAzY7vgfd2S4RAKkDDgPzNEAIxMASSWF38WsgkuXLyXTRSRCe/DduSZMBMwe6ObTd8JBj24Aot07uDObPP9XsIzUGFPs5+JJ/M6oT4buxHv9X7BeY8KgOWDg/Z58GTC9Xq5FxTXOw9c3Cm6k5fPcjgbHbgAlvVG2tH1T3Oavoq6BlniZ+12n5u/2sDbOvasqoFg8x2Lnbcd1GdhSAhXN+7qMrAC4sA8sORJ6yHwD28z+Ft4fdv8UyqUDrDmCEBcpZ39kLS6aq9l4D2rLb/KYsFTPWdfbvh86vQu2s1K/K+zIjTsXIVQ9a59Egs4Y6sZfIA/EcSp/jEXv8BWcAhxaA+SVgSQAkGAMICcwVlNLlqTc9Gbv/HAA7MrL4+f1VlXwrUq7SvCoyGcrrWpGhuur2fNGYwM8YT67hT3s1LaZvqn5MLM0bzmHMmIFSgdFNj/mIBct63NhFZwEzDsBFgpDPeanNgATfCtGsX9TIKwNrg9tuVkhlng7TI/YArX1VkXKrEe1l2SynN1RCsFJsqnQv3UIMxhwIRjU5AGN9QUteVz3BUAvahuNgjC3HxLAND7nBp/cgONXF5wCz8xUDGgCjKPbvevlzcKUHH2ag6cnYzepYBB9Zi2FxDJdjoXJv1WDFiLJ6MKqKZUzoQFTfj2HmwTKcTpVWvcxHKm6kKgoORAEvVclPD6NdzLXpMT8IYNPcLV7yJGB2AVhYrAC4SNA5AxKM9ryDPE5fs6eeVKWGZ2M3S3MQfEyJUKV8L1ZpJXpVJ9pLilmlAxWkVJHKwIhjjD9TtVXVm1HdOy/pJiaMFRWM+bo0rWl4yM1N7oPhTJecC8wRgAttBjQWdBBGESwgSiV0Pb9DRgu0TY19N+M1mRKh8niqFx3rRDsLqjgl9yaGXT80vcL1wnE252PAZCzAHQCoiqoW3yYWFIt664fUpKaREr1NPakH6XkuOQ+YDwy4FMSwgU8GSRSz0UJx3Vx/5vFNbrs/EiLRY+v4ACITww6iJEodQKwBIyBRv9vwhKzUW6z66TUGEwhDS3ezqusAyNxnJn8xa1KRPSFts9YfFB/QDZcAm78CnDBT5U8rCqjfc3yh8Gn/hGd/MsKf1+QzYJ4891Jye13iy1cAE9cDJ+6FpYrEkidxDN3OtXR+FwBGMezoMmxJLOumAuD4J4rxJrfdH/XCoLGFVKiUbw+LAPQqWWaMMLrd6/+JycSIm85w9lOpt1j1MwAwFTiqAWEUxeYH5ENn/jInUVHeMXQ/f/jRePvCa4DhTwLHfBc4frGqqaNJzLPw6iZxV+HTplFGvZrXZT45N39+HW3TujlZv8D6fp8HRq8Dts9XIOR5YtakgBgdrrrt5Qsq8Ssd0BhQ4HMwmVitAWHAY/LbLDQNQDaTVJ8Q6W4qVB51OOqDZDPVB3TLOBepW5jmqaLbec3jGgBGMSxvvemDYkQ9GoKF1ShUCSKCqBeQrvmfVZPC1keBjXcCmw911tTJ8q5XgOLaQgA+x/OdWA2EGZ98gbjleTHdQHQN+2iwls3nK3/Zhj3VeQhovYzdxmArSwQgDRA3QiSCJUrTnjfl4KozRCSCCeYmt90EoJJbVCk/1+FiCwFZxLk4dRfLFia6x8LbYkD9v9cXtLG6+O4AYQRfrgPygVIcqyhTXcWFOJH8fh3rz7EKwnUArq8mcGwK2MCC1i7WY7Zenh56feHT/jE3yliE4TZncd636gPFCKWavGhcRx2J+cvs9MlSw0Ty3cCm+c7n0G0MExdW4BMIbTXE9UCynvyCCX+Ovm4gbByA/xisVgJPpXrzLj4EoRJjJIZrWHArS9iprK+KcefgiyB0XVKGjOmCmW9xhRVMUSyRFnNeFGEdI2q+/HFXclkp9WsAbgTG9wGj08CI64WxRk/OTDcUAvBHXSLQxcVCDMQSWbzv+1e7WVbz+k5w2tJtsbcCYV6WJY7hmAsDA7r1Sz3OgOgoM+KTOJbcjSI5yGIaNE1uuwlAAU/MF+tF5/0sIghVLdVdM2S0bSzHx2Mi+FTxXf8X925NC4BycK8QwfmgVX1LlcFiykEMcL2BndJJ7aQfijKfxLGDwAhByM7aC5U4qwPzNwufNnNuOH4VZaCPlPo2AahqFqoPVFc14ga2m+WEEL0cAz9kdPrOmMu8r1o/rTsXz7f9oswFs+jO6LAqkvC3Ggg5Fg6mwW03CUI6X12h8lyfcz3QHqr3DIl64DbqaQKc9mI87QXACD6vpJqY0EVxz2CEyCI5eMSGX2e7VtI5J4yTRyZhscrvt1nQuivOAaNLlYESwcySgiVbr37Bfd0/u31yEgg2FVaiPCeVOguqAfGov0iR0R9JABJ0bnwk9nMxw+fOh55EbgRhzozrBUA1polN9CLwok5HEEUQBjFMQB7D+j656PW+IrJ8O/bBCo4sGFdGejqiyYCx3mKe9/JtTiBvmI5OFiTisg9LtJFF7gZGDrUbHKs79+hyu5hSaUvh1foFr3r/6vZJCiXgCDwVVFJ7MVmRLsrGltuFCc68yFdACMDAflwR4QM3HPoKgIExt4gz42SuaQb8hBOE2oZmlu+KFlKR3QSssMJxDPWbbjpfLoJrxG8CYT8MKGZSVTCxYFTIb84nkCxCIPLDiby30gXFghaF4c2ReR466Uu2fvoFr3r/fKAEFxvpqMcd9yonIrkuK5LLV7MVCM+/uDJCyIC2J8a0z1iwqyESgMl15Sa33QKgmtPEBnp11mwuXgO70Ud4DHWzfgDYC3zBEOk7HlA6XKyHQzb8HgGoCSQLqsxorIy1Bxie7Wx0rFaf+wr9Xv32C+56/7HbJ5VHtRYT+GJrsehHcya57PyKAQk6+vBkBZPpjPEExlwU59awg3C24W6KBsC6tqHR+MidyVG3i3rdAnAsH2T093XT+zLr197MTA80h3SfsZP2UqpCrPQ46oF317VrpeiKXTJ9MhMLkgGdCacKG/mupV9w1/vnwyGgCDCKWzJe3lqsyzLWZWe6/kc/oKzgKH4jC7oolhdC4jiuzM0WPo+cPQ2AsX1obFCTO5Jzn566PwbReiwnfTWjI4KvDoh1juh+aT+WKSYD3i8Aql2rJk+VsVQly5kkddv2FvHT61icqO7Fr71/IkLNXOi0FQjV0046oBy6wZ922Q95ICqDEaL4XWw3COcf9Mw73DFB9AqE6wZAAS8XuzGQIDKf+oVkqxt00ttAc+YT0PJ9qRFSB8xoye5Xu1ZVeCSgCLbYLVNswoncHxoeLwCzBGjBNki/4BX3z9lXgUCyIIGmhova83cRgO5Te9yLgP3MfmsBS8xs8/U67ePQOqy9umBUruDchqo8sHSd3PMfT5ifo+ack8eFHI6QEcnT5GvdOnVdXof+ptJ+BVPWceiaRHA8Us/nkACo8mzqlqmWrbFDppT5A5UIZm7CPA2Vgm3QfsEd909kKIqB1qJAKCBG8ZstZz3xHOAAiwmpDIdng1maZQAkZzsHZ537YfQrwNyxoQ+HakrnS0h1mUA1C96TdJTmORyhC3oeqdwROi+GDhkFI6bYNrcNDEDeAkXwQizPRpmnIs3OdqZPSaRFUcbchHlgie6agq2kX7Dd/+d8lUJVXuUzk8ERmS+2vfd4uvN2VOV5rSwb0y3JhgIh9wJeN3YMQCIgR78Q+nDEVYBYZUrUpbXFnM7COSdf7N4IPvtDnT2BY/h8Chh10MXQeYGS+7GGjaQiABpuNIFiECnzdWJMIUHcazLptC7YivsF8/7FgLFMqpiQL5TuNbKfA/DC46rqqAbAwIKWK+timRUBEiNGsOQsyQm+Gpjd4n046hbT84KPuYjOmHHyp92gcgDS2OoIuVIeh/xyUkaVwyEWdLrewHE3uBUDcKIwnq40HpDXL+n3CzbaKdguel5VnFJl2awaghLQBTzteZ0cjLq2A2n0M6EPh2pC57Wg41poLzZsAZNso0Hw6eVR/J8bF9YjWGmVCpGKwQLBRCcrbiSxNLgVAxCF8XSl8YDHHFPW7xeFBRwv/rGqOKUBkODzqgdWPYAM53vTASMQu4Bx9J+69OHIF+N71F1O1gUB+AsBfFqKC+4Wi4BWX+CYgOTAU36wdMVNVKka3MoBWBhPxyiuko3xkSX9fvGMkqsDlzzHC1N6SQ4DoINOe7KelWWTheziObeKCdARApD1AdVnRH048gKUAmAEYi6Oh4DJV4VoGDWqjq4XLbO5o1jBoimEPhPJmwu9FvnTLgdgYTwd2wyXbMyRKen3i2eXXB245FlVYUpVxUpGiLtmGBlrTEhVUwV8dEkVKAq3MHJ1uzRbRx+OOgDWFX6MsXJU/36lJoEoA2AKvw8+uwTEDIBbStdOs8ddDsDCeDom7ZdszBIs6fcL9ror2C75US9IxJJsEsHdGFBil4yYuUwknofJgF4XcEUfjrz+X7fKo4EJJ//PkMORO6FrVjQMeL5kJhZMMXzLwNZCt1nzDFgYT8cQwpLt4hDON0i/X7ys5OrAJVe0S/ISgFY7j9ZvnQ7I3+lyqpYaL98CWp/N+nDkZdhi6bW8An1kP3fRTLKVWlwF6RZCH2L4zDDR0k1IqeTNb2OQSYNbOQMWxtMxeqtkY6I+ny9VEz6btfb7xc+XXB249AoXv85+tIBVgJJ6n4lf6oV+mfjdDJNMH0wAVFX90GMk1f5TxlS3Fggh92DyN0IORy5665KIfCktsl+K3VsGtpVOWOMiuDCerlSnjQ2rB+n3C+pIBdulz8wqonrNPLKgwKaC5B3s53qhXVq6oDNg6sOhqvqhEr3V2VNLBjmnSSNdrOLJ1zkAu6VPRjFcFz4fXDJ8i45hG94Gt3IGjOFYA8TTlQZ/qGH1oP1+8ZtlT1MAtHK8mQg25zOZUSCLIliWcbw8wfW5Ln04ssqnHX04euiCk6/3de66MPpuAQVZAEFkw2MKFw6a1wEL4+lSBvmAOMhD8vkOkFX77feLNw14YT/ssmc4A6oOdHBEkwXlgjH2k4Nal6wB4fIuX9LzZjAmorNeHMo5Tc0OewHwDTUh9HXxfGJsYkAbAAAgAElEQVS/uvCpoAcew6zBBrdyBlQwwoDxdLZWXLDFkHyF8xGE/fb7xR8XXByAAVC1oB18HQYIT+8uGfP75SCUs1o64he8v4j6cIQ+IqkPhxrBCHjdjBH6AblQkAeY1ondukSiELmsUPpjbyp7XuvDgAXxdNZVvWCLIfmKg6Bbhrjup98v3lVwcQLw8gqA5v9zC9jErutltg8gMxDWWMBaMVkmANWFyEV6R0uH2I1IzW7ypbkQOTP5f2ch9KsFkwp0kQlDAOmxzHpscGuGAQvi6VD4RgmAg/b7xZVlT5MATNXwqQc6KGwf2U2uGV2uzg3D4ua7fDnPwZcKgIdq9GaIBPZb0YdD7hgyIFWMXiH0eQ5vXS5HcMkc++9lz2t9GLAgns7KxxZsCkgdtN8vWD+vYDMAUpcja7lOR9eLVcIP4tcuob/3AOHCdW02VTX62ApB4Mv1v24gnPy9HiH03fJ366KYHYTHsgBBg1s5AxbG0+HLZaOp65i+ln6/YM5EwdYBwGj1cmUkE7+8THLNdAHhwrUOXtcrO/pwhF4cct2oN68BMDCfmsJM/n6PEPoYPp8bH3kCkbtjji2tJJA962YAWBBPZ0WBCrbYsFoOf9pDAiENk179fkuvf9nTXewKcBSjsn7ldonWbgQpx+26otaLIwAlfi2QQSJY3Yjy5i9dmsFM/oEDMM/Z7Uf0RiYUA7J+ToNbOQC3e0WBBm9qLad6HICG1ZK1XB5PoxnuOOIcxSXe/Of8xHV/P+FpwN47gKUpYHmuSve0pKZgCKSq5wqniWE1WZz/xouBm74KTMwBI17lVBXwtWSs+8/vL45Ff3vhpcAnvwos8d48DZX3M2hx9XIAnu0IIO0chu35AOgLL0yuG/jOmwbg028G/mNz1YWdETbm4I5BrFlov+EtD2wIo7l+Atg8D2xY7iw3V5diEqO54mnj6XdMAYcU+6gon7A3NSO2qFjlyZYDkAX6uD5Iam44YaUfVNDNxaJcLIPXcGGpfi6PnZdVD1wPspQBX/wl4OaNwN6Jqg+xwrxslcVFuYJblehkcYYZGPS3L20BxueBcS8nwg5H5kZkx6TQSbXFZcCQKadx5Cz5mPurAFxrRaa17pAR2PFC+ElSHKQ/0QjQcgCyGyM9v3SnsDBRJgL6msWCf6IfWeUJac8UFlpY8500DcCfvgb43hiwZwyYVhd2D/VSrKGAmIDnBkiafEcN9cprHgKMzgNjS1V7rRjRlceyrqif6KAkMgXIM+6tAnDl+zSL36O9+U8p9jGHQo285/2XA/AnXeNnKAorDXH/AILwbSvLEz6Ql2+cAf/3XcCdw8DkKHBwpOpFbE2wadzIdyh3jjNQirYWEwYq+/zJwMh8pf+xKNSwM6DZMmzNRRbM2K+2Ii6TlFrAWfd5V3i/F7IgT2LBF5LbIdkqxLPWvtzlAGQ3RpU3Y7AiixMxLOUB2t7pKQ8M0qCTnp8HkojJgNqaMEJesQv4AR3Iw8DB4QqAs+6SWRiqgJgY0HVDAdBA4Ba4xN7ndlSFAAjAYX4IPO5dBDMAdS2i+Jx7XTf1eEdTDfgAQnR34p/wQkRmjNAoByDT/ugFphXAmjAEn8qaPQAgZCs0lSckCNmVigEbFMsPBBE3DcBX7gLuawH7hoAD7EM8DMw48AhATrjtQwiXoqkTEwWd7LOneXNCbz6Tiq/TInb2M8ZzIFrTQbGiy92oGz7pXl/7jvdAJnb2470IbB3T77Sai+hyAP5voTqW6sKwFAc/TAdc5+3dvcsTrvPVYSK4SQb8xV3+6IaAqSHg0FDVh3iOIFTIFxtit9orL5Z/LD1Q4s+B8OnHVuXwhhdd5DoLGsgCCJ04q66X/Ju/vSaeAxDPvbdtmdtKDV90gVEPIl/xySkviOhmAEjrlzSkwj40SlQZYZ39I+8JBMx8mZryhOsKwqYB+KpdVSDFvhYwPVR9BD7uyX4SwRS59nNI+bRck/DzJ05v12M0nY8fAk8iWL5BB5qASPGRCi8EVjzv3mqpkC9ACrrwhKukB67GhpqRRowQMqCiYbj8oOoHeUWpdYIBAUj8c8WjrjyhNIJ1unzjDPjqXdUjJAAP8TMEzLYq9uOHICQALe/EwWe+QgddAqCzzD8+vgIgg0qp+5nYjaDzCgjmnCYone0klqP4JSgvvK+6LoFPoFMlkPGh+0rPWta4RHTNJJQz4M8EAGoNTPVU8opS64CC9zoAWTFChcq7lCdch6s3L4J/2QFIEBKA1P9mHIBmhPh3Ai354RyAAmWsR/PRs6vOR8Z8FMPS97yxtIlYgVB/I7jC0rIKSfLXF1EEB+BFFjQ3jCLA49OWsRTTEPzvzQEwry7VrZ5KwzAQAPssT9jw1dcHgCrORQCS/bgn+1HsCYQSveaHkzvGv1scgU/6R55Y1YIxhvOm1EZekQWl8wVDxJgwc88QiJc6AKX/meHDawX9z16M/Em7bO8Q08GBP/jEkAEVjMBoAFWXUjRA3KtNwOBXW3EkAZhrALktpC6lKtTV4OU7RHB+3kHWgv/zrnYZl2kCkF4uF8MGQGc+MqEYUCA0n1tkwxbw4ScHAHr71Q7W4++c8czwcBAmHVB/c7Bcek9b3FuwbdD/kjGWgzJjQ3thGmVA3jhfOyU+RxB6FamOFp8NrhsTgLy8Cpzm5QlVptAU+6CiNgXCaIQ0BcDYV8b0P4pi30vfIxD5+w72C9aliegW8MHzqrmh/meuFhYi0pKbs6D9fsh/n1XFMrYMbPgUByCZz6J+uEknDA9AornWFRb01WZEsACoHhOqyC7wdetT0QAK2KqOb5MCUvPyhLE0oQxzqaYNXL5xBvyVXe12vByLADjXAvgxBvSPGFGMIjCmJbEW8HfntxtQmxT0cmxp9UPAdKAZ1upA6EB7qgDo6oCUxXRtPVSpAwJpnUhuxAqWCCYK1MBExZljY5S8SYr+pxAFAuBayhNG26jw8usCQLX0SAAkwwcAEngyQizaXoziIli+Oe7/9kJvNk1LmBMe9ECO3XRB7aPeF0EYHNVPdT8gj016YBcWtBfBVYJuz7mF7VgGY/pO8f5WdQ1/7U67nIKNS7j0wIbDPFZsyNHHY7od/xdlEHj8CcC3TgCWHgGAPSxiSdt4312u/8SPAl8/Dlh4pDeZW2PD4J1c9+uyDaIDkgEJQKnTfG/N8nUAmu5HUnMW5ARbPfEuIHy/ACjRK7FL5pOR4RaxgTHofKl8r/S1ZWBnAGDKefbn3AFIPRPXB7sFiVQimKVgGdl5ooNwLQ1/1U+DQGSXQ9r5Evy1q9rZbP1lGQDZsPpzI8APHgXgod7qUx11YtBbFzC+/C+BL7SAWwhgdoLkONSLqy5oLogYft3ZI1F7EAC+phsAnekokhP4HIzml/PvthQWmPB9LJ7jxkcSr14jWj4/0wFlgJD5eoDw6fe4DzAYPHokWhHJZ3TFSkn4h7YOSOBwEtiMTv1aY0uktFYTmI2/43EMQmCuAJmUE0gmVD8EFdPpdnxhVhqzDr8F4NMtYM9Jfg98EVTeNu9Q2OFZBX7vr9vtgm/lcezczZ61ZNN8DCvilYCdPXqNDQpAlfGTKm0M6AA0PTAyoMSx64cRfPQHXsniOTI+fEWDFGp+Qb9BeySRBV2kpl0QxxGAlHDmkI56X6z+EP7UDYSdRgh/IouwIZ36lHabBE0GJ0r10Rgb/xA/tt/j/6aMAf+7R4CxzuBXWRGULwBfIrY6UNfpvLae7n0I+LO/reoLMqiVMbW38oUhkNkQIzZO7tIweGePcmWlAFTjAYHPVGwXxWoLYblEDkLuTT8MDPhXLJ4jALpaJB+ggU6xfgJknT7IKXIQXh4Y0FZCog+wxiUTwSkXUbSMV1rB/A31OXWuFpPUda/mRHKi1e6U+hA7Zq7l+A+UAfDtHg/LrptkQpZ727cRWOL9542Pa3rOvuOqagUltgtmJM08j4/PILbIDKz6w5PAHsbraTnMGdZWIwIzxIfeK0rn578J3LAVuH8CODRahV/FFQ/1IumIvXP1QudNfyNT8oVqcHviPcBd48A0g2RDuoDqHdb2SalZAdG9dnfDkAE0gXnH5ijWCDbKCq5/MRiV0QD8HgHQ63jG0hdsLGxA3x9Bw1Asli7hO3BwApgng/Gjvq01IHrXJ7q3Cz7E++YziF2rs1ZLZ+8H9jJsSoECWXj6igmR87aLgfbGq4GvbgLu2gjsHwdmCEIPSI1h+SkCRjpfUC3iNWcpoRrcnrYbuGsUOMBo7QBCxSTG/igxVcBIVGPWM1h1JYQPnyKNExGZMDIJ9b66eEBGxPDY1Y5nv+GCjfGAxD+DDpiawphABWZPjwNzNLAEIH4XCH0M7/5c93bBfI8Yk2cgVAdvdT10ifDkBWC/r9lGH51NhIsnsWHOfPmEUKT94WeAG8eAO8aAfWPAwVEHISNQlKQUglJjJExqC+H6Nq93kOpUg9szbwLuHa66QzFWkaFieXxi6hgVHOMCYGRuJ+5V4jYJIDKI9KlsAvFDq8QDrnb8NWVPh9EwdFkQ79TlSMIsN0Mi5s9MoOGno4U6f3YAvefL7Y7rvdoFLxOANSA8f7xSgWmd0kCQbmZ6mTLEnJ0UqWLhUkxlrBn6n3wWuGkYuGukCsufGq2iojnRFpafsU7MDxErJuZhYCsJosHtWTcBe1oeq+hxigJgXBrMmTBPnJKLrr+VED54ibHYvZos8sO+DNcrHrDX8YVVyglAKud0LtMjFPtNMz6QLDY7VomLJd671AEH4Xu+3g7nWq28ISvX58/hguOBg8vtFQvV/hEzxfqOevuTfpjri8vAWz8L3NYCfjBc6ZYHmBcitnFd06pxyb8W4gPlgonBqffTtdTg9pybqiVNBssyUsdUD7eGO9amnf3sXtxQipl7Wg/sD4A8AwHIyZMYky50Tp/xgN2OL8y051qw2hXzwRCEdT2nmck1RxHG+w5jeO9NFQBpR6ldMIMXlFWgVndqF2dVFsJzuOgRwMElB6DcI6rznemD0RnbwQiSRS3g7Z+tVIl7PC9kahiYZm6IizuLigliT/VoUog+p8P9l3wJ7qGEanB77k3VczroUToWLCsABud4ypaLCUoxf9i/9w9ADiICULrQRWuIB6w7nuZrwaZwLBGwClSqSyz3AhHbaRGEFGOmC44D72UVgjW2C2Z4lIF4ArjodODQcqUGqAxfcpG4mJVuVqcL5tbs2z/veV0tYK/nhTAqesYNHdO5PCJZos+WuzxHJIViuXFyJxupNLg976ZK2lizUKodilGUgzyGhokF8yw5Mf+qRkjdjfuDtwkkm7DTkNaBaQ2ox1q3eMD8+B6O3H6em8Kx1Ccx9ptWl9iYIUAAWrI3I3nHgPdOtsO5eOuxXXBdj0V1vOL/so3Cxef60tlSpYwveKf0pAu6ohfdJ8k4CUqgvr5jV6VGTBKALeCAh+VbZLTnh5gu6D44A6H8cVlkNK95O1WkBrfn31R5HSy+JCwPplAxRegE/2T+AloGncNmbQyogUQx/KwB4gHj8YWNTwRAOW0FIIIndoqNkTAxz/bd09XDGLBdMM6/pLKi5whAX60gCK2ujxzEAqGL2pQ1Jis5AJEAFHvTujYAKjRf+SEugm1d2COQLU/DAwQ44caEw8AtZzSIPgAvuKkdrWMM6M7xCMBoiBn4YpCE2NCfxWAA5MEuwvCCEICwlnhAHV+YORfDsWJGgPpMKwg1b9QpFnzHbD2BK2JGul9s8KkYW17vLALQRTCBpzXZpS4gtCXXMAkduuAy8E7PijPWprXJ5CR38ygw1fJDohh2BlRAgq2OeN7uTWc1D0AFNtmL54ESBsCaJcLkDajxj5ZXRiCIGA0waDwgjy8sk5+HY+X9ppUbJSCp6TnFCMXwny1WAFQ8rUAc2wUrRL6mXTAefWnFfnz3FpbagQKLAqAzoZjAKkkpXkNO5GCEvOMLFXOnnC4xIKOjnQGNdWSM+GqHQGd7JSsxUf+JzQLwhTdV4je1nQvr1MkPGtlf9yP2Dy+gAqZ6rQytfvdHSDxgLwBF8AmAYjHWluEDiKGMiqOVvtejXTBOuRSYJwDJAARgZAGWL9Nk+IM3SzgTydE4eec1nZHbtDaNAf1Dpd/SMx2END6kD0oXtFhBXmcY+OY6AFChnKnzl7NfdMR3qCAae2B+VVMYXASvDs3/X/zHJZcB84vuiqABEo0QPnhnwqQLyRURmZBPytnwHde0M1vN2lR6picoKULaxHDIEdHkW2iWg4/7b5zb7DSQAVd0/griV2JYojfpwRGEYsGBrOBmx/OgP5sAKANkcbFzNWTRnX/GSGImMYH/LYlk+gGvdT+bW+SWH+Ig1GqL5QeTtR2EYj5LVHfjw/ZDwL8yJ6TB7UU3VVoTjTYxYDK+Ivv7dzNAZIxpZSiU8jjKgIWTcykZkBawDBBnQdMr5QeTKI5iWCB09AmEb7+ucnOQ/aTPWn6wuzyS4u+R0Ob6CUGqJpIDA97AdqINbgRgBJ69CG4Jp6q/ckjXqB/RKla4WpkO2ODgHoynigA0JiLwaNiEt95YQKJ4FRC+7brKzRH9jZbN6iJYuSHm9I5iOAOhHNJfZkh+gxsBKPbLu3+JgaWDdojhMO5kkDWSlNTg4B6MpyIAjf3IggJgMD4MCARjFMU9QCgAykhSKnUCYHB9JB0wy5aTRUxmup4h+Q1uAmDs+hpXgFLnB6ULONOn5xACNJqxghsc3IPxVBGAiQG9aLeilWUJW1FvVXEN0TKp1C6At19TMSCBpz1dHtT/JH7N9yaxp6QkF73KBxYIr10nAMproB44qQGTj6sjUrtOFPtLeFQHLES9AdDFrq1E6M13MaxVCTNAXNFThIylLcor40zxtgDAPKuVwDMrOKw+SBTbtR2MND7sZwC7Qvm4wqHa4T/uIrhb+7n0EgbQdTijoyg+agWXT8llDsAFWr/B8qP1K7bT0pvtVwHhW6+t2C/m8svvZlawi2CKe37nhFtapkDnILRqBQA+v04AjMyn79EIkXO/DnzyCBwVweX4wxs9B4rRZgyPVFqykgDd+5JSpBU5r0vHyHz+jsc3ub0KABsZMCyQgeExKyFPVIz3lmcM6OfPAGCADYPE67Jfs6h7G0o+xvi7oyK4cLZfOgpsXwC2Lq9MwuuVERonKn4nSJrcXnQKcM7dwMMXgYcsVxkSebJgzOWPqdB1ad2f3gpsnwK2LXWeR9m3danUIV1lBSCPArBwtp+7DThuBti6UDWDmWA/DvXk8LRptfPtNUlihYZTOPCi04GH3wFsnwGOW6iAs5n3GeJJ+KLoE+9VDClQ8R6vOQHYegDYwuY3S6H/iJ8jb11ck0q9Qhoc9QMWgPBZJwFbpoFN88DGRWBiqQIgWyJY3lPozaGJ1KTEPh36zpTkJrcXPRE44S7g+Cng2DlgyyKwaclfFoIwvCwx9Zn3Q1DmIPx/2/sSaMuusszvjfXq1ZRUElJkKsBEGQyYhJCBSkUqAW1tsBdpuxEVaBzowXZqe1g90G2LotjQdmMjKqtBxQERdAWUAkUlZNBGkQRNyIAEMAkxpFKpqjfUG3t9//m/c/+737njPq9uVeqcte66b7jnnn32/s6///3v//++Tz0dmD0KzC4DM6vAFpd/0L3Gh6yTDgnvLwKzAWDGiH/ThcC2OWDrErB1pRgQisIQhAa+AED+HEEY6uNLyrRnZLSl6tSbrgLOeBQ44yiw8ziwfaV4UGbdegmA5QMTLFlqsfn7XecDW+eAmePAltXiXnkuZSBkRcm4UGXtU2uo3xsAZgz6y54JzMwDWzkgBOAqMMVBCSAUObh8QuN/CiTgcWAuyWhL1amvvBbY+VgxbW477paa7gIBqCnUrbUBiQuhAKDUot13IbBlDtiyBEyvtO5VDxvvVfxW/JkWNFrCeK8NAGsY7BsvKQC4hQCkJNaKy2LRIsg6SJ3IQSe1onKKC2CsOYMeN+0Dtj0ObDsGbFsEZmWp5S74g2Ir2uA22BScAJGA+dJFwPQ8ML0ETAUAkgDTPq9zdK/+sMWpPF19NxYwA4g3PtsHxAE4SQC6FdSgmGWRRIJLZJll8EGKjHiX1jwaN10HzD4BbD0GzC4WrsKMW2pNobZoCu6CLCDfCTqzgg6sr+wFphaAKQfgZHKvpRSYg7HN5XCL2AbAZwPrZGaj6ippXhgn0kqmU1woxnHedg5AATuWHig2FE1uVRwoxoX+Wcbg89S3AqCKPONcCi8oPtVP+9++G3j+oSK2xRBFDElUxbTS+3nvc4FpDsjxllXQoJg8FgdCQoGJJTTicLcQ6vPL6wbg9cDM4cJv27oAzFA5ky9/UOSvmg8oP86n0dICBn25JwjARWDSAUgBHN6vfdbv10AbARh8X91vDM2ss+NvAECKPVLCsHoyUgRqrlbnRwB933OBc+4DXrIC0IEmiLnE75di8HsyAcjzWUVGUi6uICMpVwwJVMXdeOk3XAxc+Hng+vV2esAYw+sWoP31r3eLcLwQBeQUrEHh4Jo2h4vDmJPuAyMLGAeEn7uqbgB+I7DlSWBGCwe31Gb9aL20kGDb/EGRxY6WTz8f2wtM8l4pgL1SgM8esHCvsuylME4nn9cfQLtldg6TZ0kUKorAfij23vAPCmqp3fcCl60XFINid1PlZrf41/dnApB6wSQjutUfIDJR8CGIQOwWEH7DywpKrWc8CFzqRLHkVYrB2jS2FQH5vkuBycXCAlIUUAAkCM2iRBA6+ARCe7DjYmQduLYTleiQ/XTTS4DpI+6nLhZW2nzVCEBaMLd+soIGqjD1ampdugiYWCpeBKA9bBJC9ActAk8LES26SqsftInLZ44dQif4Igdhym5WLrPDyuYH/7HTCNwDnPko8LXrBccjQaioe6BiKad3+QY/MGTH6rS3OBvCnQDuAIyqhiDkQ9RX+29yE3on8IwjxQPI8zkTiApGU3oVkD/4fGDieAuAdMw5MFQjEgg1DYsUku+a3uI0TGBfV7PotwHwaOEmbHEATvuDIutni6UAQoFRIFRYhfe/dhEw7tbe9Of0Si1g8HkrwRcevDajz07gIJ7n05rYyWIpb4ya/7vv8PRdFpj/LXDmkQLAnA4jCCOlTBRN/rFMAJKgkkVHpGUjySSBSFeg7/azqk8EgbSEq8UDRACLKDXSyaQ7Br//DcA4LSCtwnKhTEkQcmAIQhtM+Uaajl0uS9NatITXWzpzfcdNB4DpY+6nBgDaCtanYLN6fCj4u1ay0QIqtML/EYC61wSA9tAJeP6eWsAoDysFpg1eB0HIQRCIIkVeCqQf/05P3WCB+UPA+CPAzvmCaFWDKEuYcl1yMN+Y2dckqGTeHPEvvWDSNhOAfbefX0A6rS8CUw8X9066bFIfdqMHJID++DJgLACQumyc3gyAEYRRKFCLD1eu5ODLF6QvXedx0w3A1BwwxdAJLTXjd8seQnGrZ9bPFxLyA7WIKON63tYtCQBN/sv9QPm6BkLp0vl9t/m6ietR6fbyBA4gnXtORwRRpNnTtPpW6gWLH83lKqcOFTEnDiKtoHwy8RNFhrefyeztbnrBfbWfgttsP+kIyO32ELD1cHHvInrlvWs6TsnB7qAUlg/suFtAWkE55zYQ0QpqcALoNCXTEt7A3KoaDwGQfqoAOEUBa7fUbKctltwCajVbxvSiyvoasM0BaBKwwdKb9fN7NfcqBWGiSWykWXER0umeacUEonQgCKRfIgDFjya5yq8Wfsfs8dYgiuMxgpAg/vnMzu6mF0z6Zj5APdvPQec0TEosnvQosGOhaLuIYvnwEYSithE52F1XFAA0p5yigD4otCqygFKnpHUpLYP0OcKURYv6Mj4MNR433QhM0gL6QongawOg+6rl9CswKoSkEIxPyTsuAPigCYBmAXVfYcVf+n0SRYw6dP1YwNgHsgSajiJP429RrpWOM6cxDiJB6NINM4w7LbUGMQUwB/M9mZ3dSy+YVG0EoBiDBST5ddZ+PkCsAiIlQZDa3LVatJ0WXG2PbL98AB+4omB3oP/HgTUhmGgBfRqWf2TTrUSjExDSP/qWzQDgfAFAWyzR8rkFtDAKX75jo6nUguZxZ8NByHbvvqBQ36T1swcsBaBAGGRg40Ir+rt9WUDhQ5ZAU7Es2e9LLzglqHRxNkbeuW+oQRRls5jaMjnK0a9ecNf2R4LAwO829kQB3LTtEYQPUwzQAWgW0AGo8AQH0ljp/V17pm0KRcEifGuNOnocO1rACQbKPXhs8TtNwVr5uh+n6Zf3wDgu29g2FdMtOc8B6PdpFj08ZFrplw+ZA5FTvAQQ0/BT36FPDkRqBT9Jag7xYlQItY0f88j78sZzCcKPZlrAQfSCK9uvB4h577SCotUiEJ8opq8IQFl/PUBPEoBLxbRE62LSqG4dFB8r5bHcOtiOQSqT5T7RKzYDgJx+BUCCTxZQCwhaQc9oKcEnEBKknj5FsJ1LAPo9xoWWPWDy+6IIoqbeaO0VA+zHB0zxIQDKkn1GgtXiRxMIAx0Vn0Db+lkuFjLRCt5WEwD71Qvu2H5OfekD5FaciQay/GIbFgBXriwAyGmJADR1ck3DwTE3TQ4B0LetzBJErTYAr2BBSI3HTS8tLKBZPo/fWQDZp197Z3scjGb5BDp/L3+njMweB6B83Gj9wj3atOsPWin9WgXCFlVO/3ctf4iD8XkBkH5USlAZlNPZAQqARr5vxu1yjmH0givbX0UQKI63o0Wun/xHuR8E4VnPK5JQLd4VNttTBvK2uoiKOUf/f+GjwMNBh0NMV6J0c0NpcRv7mrYv3kh8/uHxYp+bVpwLp3R7sts2YzouSq3KGa+q7+x7Co4nazAerRKsVlV1QitF59dyyFZaYY0HMu9mWL3gtvZXMbymBIFMZ1ov2h0B+LTLisxgW+Eq5uU92iZ72ud9vvR+4JFp4NjkRh2ONi0OB1/UBCkvEYRhfuNs4OmhhiPKnFQlx6aAjMnSXJUAACAASURBVPjmz1w41nnwO4cCIBvBwZgTAOUHRq3gyDExD4zRGVYEnpm5LqmQc0M5esFt7acFl0SlHiBxuTkYxxdaihUC4QVXFu5FCUD5QtJl85sjGA0ziQxqeu/fem+hw0F2fLLQGxFlYMRvo7v1WmIVtpt1DFkXvOR7LwJ2HSkyoZmEypoVVe8p7b6qEMnidGG/Vl/L2aPOIwuA1pAIQE3DAmFa4j9f7CPaFpCHKujr5xzZesGdHqAqKz5X+FLRAl58le+jui+kTBALMcgZ73CDBkpN2/7+bfcWOhwUyCEAjQTcAVhKdjkPc2RajewKyu/n1//qJcA2uhBMRGXQOcn9U6JIOjXHQqSYOsVoQp1HNgAvz8yny80H5PVz9H6RqVd849WtXQ/zA0Ow2ayGLJ474L0G79vvbulwkJi8BGCg4S01SKqofoNvSIC+5zkhFUupV8rUTpJN06KpaBkFQm5M1HlkA3AyM5/u9Zl38zrk6f0iU6/4hmscgK5ISUtCTowyDqb7UxwsqFJW3fo/vbuIBJEZ1YRgyHwQKNi0KEl1OKTCZJdxtPDn//v8ooaDaVgqFyiTD2IKfcjZS4Fo+7g+HXOPv84jG4DIzKfLzQf8KVfI/FNKrQ6h94tfz+vOA9cGAAbrpylY2SDlVTTt+uCnV3/V3a7DQQAysJAwobZJgUXi78Qayhd812WeiOAZzEyUiAkHMeu5BF5FwZQAWLPwknkLQy9CrPMy8+lIHZFzvN3T+YbV+8X7c64OHHix74V6zIxB+RJ0wQ+UU992tYoFy3fcXcTDxQkoPsCUhFIczKVCegSg5B8A/PILN9ZwxBSxtiKiUAOi7JW0dLTustF8AGbm0/1o3vjjnSGdj+lYlGwdRO8XN+c1wABIoHk6k61yuSCJITq3jDY9Vx0BqK++uwAfX6JkI/hME0SC1EGguiQ+isqcQRLrF6/0jO2w+6FMnZhyZYsQ1W50qOHgPX1NXndtODsfgMwHzMin+0+ZN0S9YOllMzWfLwKQSS396P3iY3kNOLDPM1y065H4gOW3p4uTDkB8zWdb7FgbdDhEgJkCUDRvogTmd/vPv3BVAUBuvylNzAAYi4hisVQnEHoIqWblrxqm4Mx8ujfljT+YjsWBYgIOc0oJPsq1slCpH71fKybJOEoAuuVTRSCnYlmU6P/Z4iSJEcbLv+Yu9/1EAh7JKEXDKxq4ChUiKymRbwjgHdcUWTARgLYXHSr2LOU+BV7MVwzxwOfkOWybYAGZD5iRT0edjpxD6VhcOQ6j94tP51wdOHBdMeXa9OqWRcmWXA1XLUIUH6zyCwlAs3z+YBkfs1u+VIejJEF3ckrjI9T0y/aMA2+/tgAg08VURKT8vbKMUgAMIGzzAcOi5HknHQAz8+l+MW/829KxhtH7tTz+jIMAJPCYMULAWd6fvi+EY9ouoZBM/Kx/4LUBgFLgNC5o16FrE8JJVJgkiFhaQQBv3+dVbMrWVsC8UxFRkjjaVsW2DtRdOJ/vAyohVYK7A+bTvTdj8HlqTMcaRu/XxHkzjgNkIOWuDr8jnYYDKDutgpUhra0uAlAyCCUAK8BXcjBXgLCk/h0D/hcByDxFAdAzoFUqUBYRJTUcMWdPP7ONL6i5bLQeALJRQ+bT/W7G4AuAOXq/lsGdcRgAY+glLkYclJVTsa6ptCX3uQjAKINQstFrAZKIwWxQIhIJuovB/Nx+r2LzFCwlj8Y0evl/MYk0kieVtcvrwGUnHQCVjjVkPl3mItQsIPuElx9G79dOzDgMgGkAWlNyBJn8xKprBRC+zgEo4LWRgcdVcOCjjlNvmx84DrzNAahaFZWLygKWxUNibIhTcPD9BMLLa65bzreAMSGVoXvJ/Cgh1WUfO+XTZS5CDYDs9GH1fnOrIDcAkABTTDCCLYK0Cwi/586WcKJUiEpC8CCBYDsiiSplqUIUmOjf+o2tIiKVUJbgU5uSWl4DWwX4+PcXnrQATBNS+8yny1yEopdcay+930y5YhgAg+9n2OoUeI5TdQer+32fdhmGoOBZanBo+g1yEKU4dYgFSvqB//vZBIBt9RshkTbW8ZZZ2hUgvDL3iU3uux4LSBM0ZD7dPRnTH08VAIfV+2XAOucQAMuVcKfFSD/+IAABsEoGwYAoHZIKEEYxRIHwLS8pUuhjFVs6/ZZhIVWyxVKBBIRXnbQATBNS+8ynI4tBzkEACv+chlUVIKE/5cRGsWmlKfIzudc3APLQSlg3E2OCyVRc1kpU3DgBmKoQsWtlBcswjPu+nfTYtBL+GQdgOf16GCZW6pXlBCqWSgqJypoOAFfXXDifbwFJLvi5HAjlnUsiIe6AjOp4iQNQHRlT2PlgJCUbbc2s+v/hFwFb/q7gm6HlYpBbmTV2sscQyy/qFBj2v0/cAdz/HGD7NDA1AUyOOU+1CwWOewNjKj6/O03F1/WuugW4/XJgfBoYmwDGdH7IxB5kLPIB+I8AfNwZgga5ck2fJbEm8V9zNWPfrasbgMuPAcuseJ8Exsb9FdBhA+7gaQNKB6TfcgCYug+YJT+g89aoBDMmIMScP12uTKj13uDv8zsKig/uJ1uQOsnojm3qB5P5ACRBH3OhPuzzRN9DV88HqQLEWPJnvTy5nm/t/1s4BcuSpRZtGAu4fi+wtBVYEyccrYwn6hF8/FkJp9bKxAKVFsn/d8urgbHPA9NPOEOWl4+2cfoFHhfVrJTZPKHSj5daOtup6JyCpPx8rHWRVQ7WOlrYCMx8AHIzlxkALPD9c0VB+x/A3E/+E2fUYHXdF7KTGwdvTd0AHP9r4PgWYG0KWBdfsBdsMPfPrKKsoL9XAVLAvO2fFylCE4cKliyrDVZNcGS1CqEYhWFiAZV+XntaURdTLmpCEbpchTYLqi6NrkMCzLzt5Xc4HwyJmmkJ+Z73jQOh4NWeDUZiK1K08f0EXt7CMHVawIk7gaVpYJUA9LI1Ao8bzKX1cytoFtFfpdCIWz7rgzHgth8u0oPGDwETc8CEMySUzFaikgtlpW1Ta8JqNba7lVljSRgW+Q6ZP/57WQvj6fydBjXfAjKbgEvMLwWCvhNoipgNpnQshlS4IGFWzIk6ylWwAz93ETLxGWB5ClidLABoIOS7pmGfG+33YAG5mND0G8F4678vkiPJczNOAC4UyQm2N8w94kirFlfIAl7i402d6dbPWWAtrsjOFiuCvAJZOQE0pHTFsckHYDeCvhNgipQNxoAz8/8IPr5nbvH2jd+6AThJAE4AqwTdZKEBLDoDgU4+YVkPHIBoPwareOt/BkDexsMFAFnbzNJYm0IDnVwbt4uyur1kwL7Tp+iZM/08WT9Rc7DHUmuYTr/x+6o4ovvu9fjBbgR9JyA+omwwxvZI5ULg6ZW7y9FPf9QNwKm/CgCcKABovh8ByVy/UCtJq2f+X1yYJPGU27lIZLbuEWDsWBHesZeDz4iURLUWa1TE47LqK12fZmd3OXidFctqm92KatVs1jAEsNv6sdymaa2g8+xUL4I+Pn2beCgbLGWHI/h8G3oTr45iK86POlbBU9yKI/AcfLR+ouQwH9BfmmbLlTHboOnZ/T9+5vaf8FUaAThXsFOQ45mUcgZCWTAxe0UQ+urYMO1/37GtxQmoLCBtRSp30LrDp2SFdzYMgk/R+VNwvwR9mwQDsaspGSfJgYDYNTbp8psCQFJxEIBkQjDrxt8dXCUIY+COH5MVFPi8SOn2n/QYLZ9Gp0cxANIP5IvAkzVzxivRydnKNzBa8fddM84b6AFyAriMF2pajk9kYIeoClXmA3AQgr5NQEHMBqMVFMNaIOayNRL/vhlH3RZwmhbQQUcAasrVVGz4EtjCu/3dfb/ID3PbT7uKAZ/MhcIC0vqRTo4W0IBIEAmEtFwCYqjW03bcmdwBYeoWgetUbrR8snrloiR2drpACf+rD4D9EvTVjIJu7HBV+781X752Czj9lwUZkTEgcPoNPp5Nv4oBRhCG6dd+1DkMz1JIhR1BAHJ7zwqO3fIRRM5tmDK5CoQKsSgOeBYBKFZULTqcB9r6Ni5KYmd3WKDUA0BlhNLM8EbT1QBXBU72aI5ZjUcVOxz7WLkQ8d37vsart/uA6RcPsxNSAtAXHDYNC1AEpf9s01kKwuBwGU7HgVt/1jtD1e60fgQigSe/j5bQp+KYpGB+H62jT7P8/ZypBIC8Dhcx8eY9wF015abhmnoAyJ5WSrKeNgKO9SHxnT/LSasJBim5lRjWBEIVeROInKL1qunybRawLgASdEy74qjaNNzJCgqEEYzBGvK0297mAFSHEIB6ebKDgc8J1ksmV8t29f1en6L5v6cxIK5iK6Xne/5jCTiFcTqVn/r/tWDPWwXnEPTVgIKUHU7ljASawKefIwDpMdRxRB+wFgD+RREDJABpwSzz2c0LfxczVjkVKwaYgtBBezu3SvX08d39P5uO3QKahXMQciourZRAGKZWar/YZ1xXRPe8wQr2AUK7TvbOVTZBXx4MBECRnConUBSFEXT6mf/TK+/qmzAF/0UBOPqBZYF52HrTFCw2LH5G8UCzJEko5nZqmRnPh/uCXmpnVpDTsIPPwKApOaSA2QLDLSHf97iPx0tpISLfz7bl4iFfsUsnj+HZWEeOYDCDnDmCvZkEgedcCjxGseIhBYt3vx049HwMLRh8gA9gh2MoH9ABqKJzxf0McO7XlSAU4HzhYYFq+5D7hwBu/98OQLlIBCKnW39SlXNY+nqeiq2dkQg+gnGPb9/ZpT0lq6MV5D96gLCwgDmCwbdnCvZmCgY/dxy47xxg5SWuUjigYPHFbwA+fyGwfr2rXrMvPB+vp3L3GHCgi9JOHQCkRVPppeUBigXLFymyejYTB4YsgfA20ofRAlYB0FfAlvQqP0/TsX5PLOB5DNu471cmIwiBaRww/F01J+mz2pqChxUMZvpJlmBv3iTocsW4dzewfhkGFix+2febXDAeJO/YEILBB7pU1g8LQFo98QASVGYNQ6DZfEG3fnEqrgLhbf/HV15anbkFNCvohWSl9XPQ2XTM/2s3I4DwPIZwBEDfgitH0Ek6N6x+u/iD7T4g/YdBBYPpWHEaHlqwNw+AQa4Yj54JrJO+aQDB4pt+oCAyYvOPEIQDCgYfeF/9U3AbAMX7ItAlVtAspKZdz5SOlvA2pstxjES3wJ+92NgAGK2gwi78QoVfEhBeQACqNNP1RdoA18kKdgDhxkUI/zKIYDCnqyzB3jwAJnLFOEIW7QEEi1/1Y21ywVglCAcQDD5/Efj7M4CVrZ5AKlkhxeQUaxBI4nvFzxf8IfCVC4HV7cC6ZEX5nen3VX1vAGLZq8ysrvHY+QBwbGfI2E6JpLvdX+ksthpUvQrmX/sVDGZVUJZgb17vJHLFeGQcmCdVb5+Cxd/5xjZ6QzzMLOQBBIOfTV2Ps4HFHQ7CLQUQmUrV0rgKJMsCjsxGAqTn/hzw0EXA4tnAyg5gbTYBorKkUyLnkB9YVhTxu+kT13iccwtwdBewPAus+b2ar9xJAafqfgMQO4dh+J9+BHe5gqZZZzYok1JJUcpaR6bp93P+W/N6p0KuGIemgEWKgPQhWPxdP7NBLhiHKYHUp2DwpZ8rLOD8tmJQVplOLxAqmbRKC6EDYC7/CeCRPcCx3cDSrsISrs04CPm9ArZk55UvKAspYLqPaPdR4/H0g8DRHcDyVr/X6VabLHk2PhjpPVZY7d5xwF6CwS9y/4LbbVyQsEKIufGiKe0p2JvXOx3kinF0GjhOQY+oNRtljji9TQPf/fOV9IZY4Gq4D8Hgy/4W+Oo2YG5bUUy04vUcLCqSJVRWszJbNgxSmMau+q/Ao2cBR88EjtOqbgNWWaTkIFz3YiWrF4nAjtN0nBZrJnU+/8PA3CxwfMYB6LUra3oglL0tps6wlVha5rLiqd9AdDfB4Je6U0s/0BXTDYh80Sr2FOzNA2AXuWIszABL1JaKWq1R+nwGeM17OsoFY5XTVw/B4Cv+Djg0C8xvLYqJCECzgsxmZlq9T8e0XGUyaUizavPtxoFr/zvw2BnA0Z3A8e2FVV3x6c4sqwObckeyhiXAowUSADhD1XhceDMwx37lvU4XxVN2n3rJIocygkr/Vbs7fe+EdBLcfaXXQ3IPWIrpBB6XlnwpR76jYG9e7/SQKzarxM7qJFj8mg8UarMV9IZ4gvNDD8HgKx8HDs8A8zMFAFnPYQPDl0Co2g4fpDZLqKCxT0/7fhJ4fCdwbFvhRiwRgJruCOwUgCpeCvUjZmEFxhfk9W969kW/B8xvKQqnVgg+B6CB0MsI7P70AHgmd2n1NQ0rv7FvALIlVYK73MnQCDLThSGZoDpuP7uCeuX5n8zroB5yxThGnQ0CgyBMxY63Aq/5aBHG6EBviDlOLV0Eg1+0AByZLgbl+HRxnZXJoqqttA4ODovlJZVuSjTQFtq+NwNPbHMAzramdVpVs6wEoPtdNg37wJfvsYiJP9NFqvHY+7vAwjSwxAeNxVO8T6aNVRRRlT6hHrJ0Ovaw0WDJCKng7g86APvNB9wg2JvXO33IFWOBgn8EIf2nRLD4tbe1+AU7yAWbZeskGHwVdd2mgAUCcNKnJgLQrZ/V9/Jnn5JUYmnAE3hCmv3+t8AWQfSzyPK/POOgJgDdsgqA5nfJAvLdLV+bz0kK4RqPZ3wQWJxyAPqDVhZQyQr7gyaXI9axWCFVAGLvRUhV46PgLnUWBs0HbBPszeudPuWKsTRZAJDTo8l8ui/42juL5veQC7ZpsEow+OrZQlqVVuH4FLA8WVyDAOTAmHUQCAWQkOlsQAwDt/9/AE8SgPQpNa07+AhAA6HLXbb5Xr4IaAMfv/eGvP5NzyYA7UGjBWTWjh40v9fSyscHLtaxhJWxFVsNNAXH1khw983+DYPmA5aCvXkdNIBccemfceooAfhAAcA+6A2xLuAGucxrzgKOMexDfV9OwbS2BB/BEoqLSrBoYGgJ3E8qLcIEsP/ngCPuUy7S13L3wb6PU56/m/Xj4Ps0TKCXQA6AXuNeZY3HMz5QANAeND1kwcKXlj6wOZQ+b7R+Pi0PD0DeFAfk590CKg8qncfoFzIRVWVqfFfBhgn25vXOAHLFWCDbvPstBsJZ4LUPt+jdesgFg+qVptWq11bg2gtgfuLiRAAgQeg+oEmsOujsXb5SsAoCIN/3vx04OlNM6Yv0tdx1MKvK7/TFjVmeCD4HQQQhf159eV7/pmc/kwCcKABoeYvR0oept7SEoZQ0Tr1lPuPQFlAtO0nyAcWhpzw/FSjFzGjLx+RGvxzoSeC1hwsA9klvaFN5FAy+9mJgnhaQ0qqagglADo4c9AhCDpJPl5ZommQ8738HcGw6AJBW1VecZv0cePwOY0/wl1lAD/WUCx0mMlDLr8bjmb+Dwp3x4nkDYbD0thIO5aNtfmDi/xGEeRawxhs7Vb/q2huABQJwAlhyy2cC0xoggjAAUCWWAkksOiIY978TmOOqeqqwqAx3WGhHK06n7TDwOcAV/iipPAKjwgrZm2o8nkUA0gKmAHTrp+o9MTrEYvq44o9pZIOtgmu8mafCV72YAKT/RwAy5OPOuVlAAk9Oule6xQRTWUKlWtkU/IvAHAHti5oIwDK841ZPFtCmdr0U8PaC9hVultd4CIC8P2Ztt/m5/qC11TJXlJDGGpfGAmYODgFoCxACkLpuWh3KCgqE8gNVZK4KtxgjJAB/2X1Krao1rfN7CWZf3LSBT4uAEIyWBVpipL7GgwA0AW25GbGENBTRx3rm1M2w39mmrFVwjTd1Kn+VAZALEE5LtIDyMWUBvbLNLGHgd5H/V07BDp7r3uU+Jadgn3ptxekA5MBri0/Wp4wzBjDbCnkMWMqVpE8GJwLQqvfc0pqbkVj5aNk7gbCxgJno30cAjntowtXNaZ1suvSKNhsYTcVKmw9F5xGE+94dfEoP+JYhD/8OC8eIPUsUHokVVKB78XszbzAF4Pvd//PCKVGIpOAr78mn4DZOm8YC1jco+w6EFTDDPJqeCEBZBa5GffVbhmQ8DtZW5TYOvPhXip0GTuu22lTMLSw+aAVl9QhEWjurI/aQiLJkTMLsX9R3r/ymZ73fp1+37OU9hunXSkdl7T3QrhKCtlCM59k2i5CMMSIAGdqxEIwrmptzTsCEut5yilKoJLAcxCq3fe8tLCDBFwO+tKjyuxSCMdYEXoeDrHcHvu0tTwLzmwHA4N/Gh6zNCqqeOSxC2lb8tQSiMwbuqXIqAcjFh2JjBKGJyShQG6ygVbfJegULWBYcMR3rvb6oCRaQwFPgl1M5rR7/JtBZOIZWx/0+s4QeY5z/1/X2tFnAxPpFELaVkdLN8MWGVr4pCBsfMHN8bmTKfCjZ0Ncp456/x58zLzfw6Qf3ABd8pUgEYmqk5bGyek06IQl1bkXScnlN/u8L24Gdx1qVq91KQvrpgwaAAw9p+wnXPw1YjyWMGtDo2ASOFGMU7SIEUzdYD34vMPmXwLbHgdkFYAtlGiim6DpxJtvq9LtlVr/aWKEB8pUXAOOPAFPzwBTZ9r04vdQ9Ts4pAZ3cd+yHxgfMAOH+vcA69/9Uxijmz/AerYpdar1lNSMYzV+vWY/34I8DY58Gph8Bpo8A04vAFEFIknIHohGVR62QhFRSYjQE6qFri2z3iaPAhHNNlxKwArI0Q1IAxwfReacbC5gBPp66/5ICgLKCtqnsrKKlrFZUFPKOr7osMTtdsxzqQRZ93Q1MPARMPllohUxRqkEK6gShOP0S+dY2hlRv99y+ovRi7IiTnTvLqmg6xDPYpqAUgRgsoR7MxgJmgHD/c4E1FXu7FRRbvEgd7evXWlbPpp9EgUjiJpwe6zwOMlvpAWCMVusJYPIYMOlSDZRpoGiNxKzbdIQlXONMWJbGtw4svdgz3El47nzTRvPrrKptAJT6ZrzfintvAJgx4vsvdQvIXK5VYF3sUZxmJUvgA1FOvwF8spKyBtM1y6EepI4LqVMedbEaTp0EIKdPKh5FqYYqSxgo2jgFr13j6XXHnOiSZOeBVSvyC8qC2r05FVvVw9cAMAOA178AWPMp2LJaaekiCPXExwHw660n1oB/niGQazwOkkSepbJ/72I1x4CJ+cJ6lYI1riccrVicUuVSmIW82pkwnHHVOKbFsOozQGkFkwewnBES37ABYMaAX39ZAUCCb82nIlo+40p2gNnvsoKunxH1xGwA/LOzdQOQJPIuHzV2GBg7Cow7AI0l33XfjOsv6oVodes6ISbBsAZMX+kJxU56KY7pkmFVhOciuvTzSt05v0+ryuT/9gDrZNe4wPMsI7VJP3GcP7gUOOdvgL1rRYJ0ZI5IV3hV4/wrGYPPU3/AiRhYusy2K7mU999P+z90ObD7LuBZK0Xdkeq9NSX2+o4HLwfWlopFCC0fgciBMtAFC8CGrYXVoVjnU2G7rTXrzh4kfRzLY1kyGwBoeiGcPiXb5eAzdXWnazPCSScb4j3xfmav8Cx2p50lAMW0VXINitCogl2r9H2dcctWwQxQsn6ZTBbMNtcgdKIbiZj51VcBk38CXPxoQcfCUg8pjcYgZScw/momACnXyr4leBhs5QaBTHpf7X8dMPYJYO8XgAv9e8QJlAZZq8D4xSuANYKPJQn0AR2AHKy1MACKe9nfFI6IEqduEWoHIJ9wlsVKLekoMCa9EAegSTYQeM4TXco2SEMkAHEbBZoj4bbYtdyCVrFqGXgTSxgXYTZeHLi9AMjEQRCVUXP/n4KUaaT8vVTi+Rtg7GPAuYcAWlMCgUVkQfJ2Q12yBvPXMwHImhDWwf81imsTiLSEvHZkr+jY/p9CQRD4p8DOBwteItai05qn31FFdfLlFxYWgCDUIkRkj/TxbCEi/89jfPZ3X2VqYSJQbmUNQY3HQT7hbv2sLoerVwKQHNEEoCsm8R4MhPRjXUGzVEIKIoY7yaEYuY4dgGb5RXruoSgtSCLLarkICQ9f6QNykGjFdjsIBaI4kGlt8W+Rg5g0HJ8qAp47nihAzFpuWtPIMBZJlASILvR6fQ0DCVbJCkJOJCqnk4pGpb99tZ8MopyiKDX7WWDiwYKXiEQOehCrgKh+eJQ+EQHo1Lby/zRlyf8TIbf9XS5ftIb8I92YugH4ay2pLusorl7dAoonWtMwQSTdOFuQSLTGHyIC8kxSIQuA4hwU2WUAoO4/grBcDbsfWElSzg+JCoYDoEGM1ixSkHzgF/wG7y8sIa3J7JPAGWuFJSQIaU01iJHUiYP4e33BrPOHmG/JMaOfTZVYRhwGav87vWKPJ9/rSH4IOGO5sITqg/ggxXs4TOaBAECbeoOsgfl+DrQShFqcEIhyyt0MbMusEkx76iAZXKM8BvXiZAGlF+KaIbaadYpem4aDgpJZQz6YJABV5VcHAJZ0v4FxX6KG5UpYs0KnqjhRuagEVgPglYAl9ciHf8mdUrJh0Qx9vkDBzBywfbkYQIGwahA/kglATsHsDzKA0BATiPyZ4NEDwIeoa/uFYKKXL2f24nQoIgd9R3yQCMTFqwIAfdBWI7+yB5ZLECYLETd85YJl+2YAUNosLIel/xYlu4Jsl6bhNhD6it4WJCvA2Zc4Gxo73RcgJeOqFmGR6rcChLYACyGojmEYdj59KnZ+tIQRhH9IvWA2hiREjDeRI9Cly7fMF3EtWRFawhQIf5IJwE56wdTIYdt7tp9ys1K8JnoJvod9Wn682PNkP4hUy1ndWgstAtBDMLYN5/6PAc5DGNoF4SrZfN+4+IhT8jqwg2Cp8ThIJ5vfSWBXAVCrWN9SMxDK+skaOvhoAc8me654pmUB3f0wyt+E8FyRAGmPlOEoiSD2qgvmAKoOm52fAuiTDHSyIRxx+lI0QxxADubfF5vffMmSajrWlP7nmZ3dSy+4r/ZzAUEHnQ8R70HsXlK+PgJsW68G4XYGZj0EY2EYATCAT6tAhmE0DXcC4faapcwMgAIfLb0kuzT9Qmw5uwAAIABJREFUSi+EfeALkSrpBovbrQDnkm8wAo8/E3i+CCsZ98NCpAp8cUekZyBavI4ET/TnaAk/RQCyAXy6uNSPA0i+wMeB6ePA5HFgZq2wpNGK3FUDAHmv3fSCe7afX8CB4UNEEOolVi/3obastNwJ9cO5BOBKEQMsAcifHWzRAigWWAlCn5K2bQYAOe1KMjTIR2kRUhKVS7IrLia0v+3xwHMZMCbYNP0KfG79zAqK5DxOvyEuWu6VD5KSHy2YAEQAfpaRdl5UkuUctIpBnCIIl4psD03FtIIP1ADAlBuJM47EqqUX3LX9kSBQcuuyftK78xUkHyQ+RLqHZ3Fv1KcgLj5kAQ1s0Qo6IA1nHhNLQzA8ZxvBXuNx8DcS5UYpNnoYxsCnUIqvZo0F3wPTMa7Hv53HOJVbS/l+5bumX7d+5WLE44hxIRJB2NMCqj9ixwuE90svWCaIA6bAp959EKeWChAyA0PTOV2unGMQveCO7bfqHbcS4rJR7Ewqnw5AWhLuImg2uFQAXAVs8RGmntW4+g2hB3P79L/EJ9zGvqrxOPibiVihAOgrWQOf/EBfBcsPNBBqW9Hv6zzGqFzmoXz3B9AePgXiq6bgiv4YOB9QHS8AfpkAFMMjrWAcQA0iO9XJiQyAnos2vV7ESHOOQfWCO7Zf7F40mZFQScRKAYBaSU6vAVcTgN7xXHiUFpDTMK2dFh56912BTiDcvpkATIXzCL4g3WXTZ4jpGfjoF/oihL+fx+0yWUABLwIwtYKKIabgCzHQvi2ggBKn0McEQDaKT5cGkIOo6SuyYzEfjQB0EM5nZgAPoxe8of3sgSqCQM3jkdFLvpRvR13+7UVRuhUFSavNO6otwp88ZZ3+t4M6HLtch6OT9AG/q9cmtf//gV1JDYcnQ2zY6/YakfSrU+Pg1M45NqPt3IEtoM7WFHokyrWKkooglCMWLYjiUXMtK3g8Uzd1WL3gDe3vRRCoUEYCwGtYFxxqgA2E/jI20F5hhmQod98BHNnlxOTig1aGiDanO21yV4DygWuB8YeB6fnC9WEtiKVVKeE0ZGiXWczeJoWMIig5a9V5DA1ANoKDeDylZ9NSXxyAsiKawrQqmCv2HVf5e8aRoxfc1n7xs+khItAUvojvyWryxVcWJZksVSyZoQRA3dcAoHzax4Gj2wtu6FVKM7gMgti02jbV476oUJJs1j/AbA1mQ3Pm8eTRsoZDtR+xZKCiEKmMXTIeXHPGdhYArX8FwG4DGMEnAHIK4yvT58nWC2b73cexaZgWWaEKgU1gjNbPP7PvOYGsUSBkv3hBtmRWNzxjTk9RWktvxp6POj0vARjY9sWkFel8RWxegjIF4RjwAOnZWMPBTGjqvHmszxJOBUD3xyznL2bqROvoP3N3q84jG4C7M/PpcvMBef0cvV9k6hXv+2Yno5QfGArRbaCC0mWv2YtF3ecerNDhkNZIIsXQRv5dlTtGADJSz2gEE1EJQM//026HdIEZLC8B6A0tk0g1Ja8DuzJdphS82QBEZj5dbj7gxZN5er/IZI+67pscgE7QaDOUMyC0Wb8+gXjuR4F5J6YsaXnFhBoAGEVvUhb60jISgCQnoh/OLBgvIrL8v7DdFkEYM5dtNg97tvz5zJqzdfIBmJlPl5sP+DJP5xtW7xffnzeh7H+Z+3+RpkyWT1YxuURJYVtx6T0fCTocouQV85VkHRIGegEuEv/YKpkA/JceVmL8kv6t5/9pu62tfiPWcFQVEa0DZ9WcLJEPwMx8uvfnjT9IgZyj94t/ldeA/S9tMaGa9SNdmsIxbvVscVJ1GScoMt4UPwhAsmMZ0aXzQBsvdGRBjQz0FUpEJRAJQOq4KAnBdz+sfiPJ3bOYn8fsykyVWMfiN3BOzckS+QDMzKe7OW/88aqQzsfE5kH1fvGjeQ0wADodmVGwOeiMsUqHrGOnS4UFy9P/wAEojkEnI+IqOIJQNLgpCXhcmLAtD/D+kgQE235L93tj+YBqgTX9BiCeW/NedT4AmQ+YkU/3sbzxBymQuZhm8g1T+QbV+wWFdjKO/Te2mEFNlCb6gPF708VJ1TXHgKd91GnZpDfi1k/gM2vqU3DUnCuBmNQe3P9vw6pe229KOvB0K1k+ZS+rnrfM2AlA3JMZtah/EZKZT3drxuDz1O/yxAwu9JgJxr3lQfR+8aa8Buy/wdWQZAVl+ZzCrG3q9c/YrkmHy3IRYryAAqAkEBIlopJxNNUbER+fA/H+/+AAdP9PmS9dazicJybm7mlB8nR2dI1HvgVkOlZGPt2nM29GCamcGZjAwlQ+vvrV+8X/zGsAAUiLVPp/wd+zaTMFWw+/kAA0GQQnpCw5mDsAMIrcRB5mC/+MAffTwgfwKY2KfmCZ6ZIkUShrxXxBX4yYaV8Hzmcn13jUA8CMfDqWYeQcSkhVOl8U6uxH7xekrsg49h8oiCENgC5TUG5vKxxT8f2aRtOtcAKQ1s8soPuOVUIwpchNlEEIOyNSIrrvv3hwnckWIZPZsnbcDyzTpvg3lU8mpZQqozyfK74aj3wAKh1LgrsD5tMxiz/nkGD1sHq/YNFOxkEAcuW7oqmXlisuQOT7VV2jwi/kTgj1RkoZhBje8Z83SCAEEJZW0C3gff8tADCt4VASaWIBK0HI9q8BF5yUAMzIp8tNx5Jg9bB6v/jdDPSRns0BWIZeUitIo9IhHmhXTvzCPQddccnZ76U1V/IvC4SBCFyg26DFNg7c++Mhhb6qiCikT7WVUmr6lYn2nRKyrdZ51GMBlZIc07GUBdMjny6XCiUmpA6j94vMZbgBMFo552pu27PXAqXTyAUQcitOQjAm9xX0N9pIwIPmSCmH5QuPqER0L4kDYgp9zOUL6fYxkbZcFceyAreAF3GlV+NRDwAz8uksnT3jiILVSmpWNlhMze+k94vMZfgGAPJeHDjpCrgM01Tdry9OzvmYAzAqLVWIwEShwzbRwwSEn+MqP6bQK5tZlWyhjCCCsC19Xv7gOnBRbgp7cu/5AOyVjqVMmA75dJZ9nHF0yohWNlhMxKnS+0XmMtwAmFq4imnYbrEqNJPc+9kfd62RKh0On8qV9hXZ9askEPgAfI56ziocUgVbzGT28lEtRMoKtg7lBHtznfZNA+CQ+XQWM8k4uglWK/NLYKzS+8U9GReXD0g/Tyvh4Ne17Yb4Zbr6g6y7/aNWcoPpjKRTsJIags5IJwkEAv6en05S6GUBfRWsUExZyVZVQCQwrgN7Wfdd41GPBczIp8ODeXfTSbBa6YYxlY8/p3q/udc3C+jTbtvqt2oadnB2m4oNgMn0W0p+hYWHWbwg9yU/0Kb9EIy+5y2hiCit4UgKyTeAkN8Valk4Le/ldlONRz4AWWBRM6fdIPfHstw/G+SE5rMnVQ/kA5AkLHS0ak7V7reXfhgACaBqDtD3e/nmc5k9kA/A80JReq+U38zGVp3ObJo/BvAOD3dtwiWar9zEHsgHIGlFubqSx7+Jja36anLLcDvvgwA+NDpDfILv+qlzuXwAXuSjrkKemlO2e3U1uWUYnL8dwB/5e2apca9LNv+vsQfyAUheX4VguB+mzIsaG9ntqxhF4Xbe3QD+n7/uHLAW9wQ1tblMRQ/UA0CaHC7plXEh+q4T0OWcfhleYTSHBK0EH/mi+fcRuKQn4I6fWpeoB4AevCz3HOOm9yb3F5mBlZBNclYCj1aRfyfrbgPCTR6AzK+vD4CyglX7jpmN7HY66d1E0ctdIrEEE4wEIMlam+Pk7YF6AMj7EwAVbU82vTerCwhAXopJN9zVI+AYrOeULLZgErY2x8nZA/kAJGWr0naUWdFpy2cT+oCWjpdjLFxE5UzYIBBpEUX5nLnlvAktb76SPVAfAOUHpiAMm96bsVtCAMaKALICMyxDq6cXfycA+b/mOLl6oF4AiqBRIEzBp7/X2Af0+fi1XIioMIlAI+AIPIGPmeROWV3j1Zuvyu2B+gHoFfZiDS2lC0LiY52WUADkQoTTMH1BFSYRdHoRfKSu5v9qrizMHYPT+vx6ARhSuDcAzzmDo5ZGHT1PAKYMwQxME2jiSo/gEwBrrq+u41ZOy++oD4BaCcsXTPiSI3ey8s4KGoG8QwCMFM+0ggQhLR0BF19SXuD/ayakz7uR0/TsMcxg3SjfqWNA0hsrga/ojaq/8WPcC+YIk4Ke4CMSuB2XVht1Oj8zIfXlU8BtU8DhmYRXWdfrdF1fgr3+S8At48CD04DVjXQSDO70PTUnaJ5uOCwsIIFHSSFy1pKPWCDsZxCpw8UVgKSPxLXM937OzxxAljzcPAbcswU4Qh4V3UN8mKoeKm/bu78IfKJQa8VD48CylHQiL3O3/qg5Rf30BKACMtJXjXKQcfBSK8Dfqc3KVCwuN2VFGRnm/yKZtq4Re5ifyQQgM2A+BeB3GHaZBo5MAIue0l7Kt3cC4xhw+5eL7TuCkJk1jBtyerbUfYG5ExjZ/pqrxE5fAOrOq5SmowVIrRp1IyT2R6+fg0bgVYG4CsyZe2UsaiOGKXr4Sfp9k8CxCYAFSKyvXeY1o1BxQux91yMtfsHPutgnnyUuUvhc0ZsgUXib+nVkq6+ZKaABIHsgVZnuwD9sVo66rrR4ImdhLGSQ8zPL/JgBQxeU1ouWkO9PTgDzbgmXxrzMkatl3keivfG5x4r4IRcz5BfkO5vEZ0kgpIfBZ8yKjlL17syy0tMNcOn9dl4Fy6dLFabj1Mpvow9Ify+I4Nlo9Xt+ZqU9VdJpqZh4QDDyxUyYOYJwHDg+DhgI/WUVZl7aSEt93+GO9Ia2iuZKOfA7lhp9JpvAVy61w2mOwO5hmCgMHC1H9O24gu6UD9jP+ZmbtLRaSsei9SL4XDPbAEh/kGQ/pSUcc0lbApFWb67lQUhpVnLBsoKqqZclFMmUtrxPcwxl3X7vOCAtYLSCcugFQmqhdssH7HU+RznjiOlYXA8wqkOfkItTAom+oKygca4ES8jY+N3z7fSG4hfUtp3ihUHruVSsFy1iRvNP+1N7A5BdJACmVpAgZPhGOyCigEjlPLudn7kvFtOxuB4g6OjD8UWLRkCZFRwrLCEXJQQhp2K+37lQeBCRX1A7KPQto1prFEmSYn2mB9EAsO+kYfk8KQhZF8yjVz5gp/MztyOUjiW9bCUhEBhKRCCgSis45uQ/PhX/xfFWMgOnWu2gxB0TF/o0kEZ/kCDM1Ts+3RHYnwVUL6XhDFrAswfIB6w6P1MrTulY0sum1VICglKwCEACqvQFCUK3gHcsFQCM/ILayqP1k9JshVqrncMalOYYvgcGAyCvIwuod8YBJQmZpmGJeyRwkGw4n8jJOJQNw3idLFhMRNB0SgASTJyKoy/4ieXCeFfJBUeV2SoAclFyR0bbm1OHTUiN0/DTAwD7zQeM52dqj8VsGEkVE2jKetG7AEhQ0frJAv6RC0trC1skl+IWlNinGLbSaZg7Mc0xfA8MbgF1LQV1z08A2G8+oM7PVF9Ms2GUE0gQyp+Lwu2yagLgR9ZaYpkSypQ6a6Q2DCqzpkvietXIFdoZfuieGmcOD0DeP0HEbBhNwYPmA/L8zJQsATAKnguEqS+XTqkE4YfWWwCUFZTksYAYwZfIBeN9Tw0cjOwu8gDIZqsoSSvhEeQDiiGYFoyWiSDRypWgi69UP5sc5fIcquSCNeXqe2X9ZAHfM7Khe2pcOB+AT41+aO5iRD3QAHBEHd9ctuiBBoANEkbaAw0AR9r9zcUbADYYGGkPNAAcafc3F28A2GBgpD3QAHCk3d9cvAFgg4GR9kADwJF2f3PxBoANBkbaAw0AR9r9zcUbADYYGGkPNAAcafc3F28A2GBgpD3QAHCk3d9cfOxqYJ2au9RdPtdp/khoEOlglDYT39V1PzQFXLsMXAlgt9PCxJKPbufyf8/KHIPfBPAZABf79Xc5XQ0ZQ1Q7360NbxoHrlsDvs5ZRsgo0une06by6X1mZvtP99PNAp4F4LsBXA5gjw8EGTeqaGF4QhzQF80CX7cAvGIdeDYAfhdZ2sTKUcVrpE7nd31N5gj8e2dIo2osk7NZpMdK0Z19tv+bJ4F9K8D1ACj8yfNSikHeg+5Z969m57Y/8/ZP+dPLKZhP/rcA+AYAF7g1oRUhEMUzFMt6eSJfX78b2DkPfM0i8GIAX+uWlAMppreUUErn8p2gzTl+2flg/sDbTkvIOik+CP20//mzwAXzwDcCuNTPJeFXpEpM6QEjIHm/zTF8D7T5gATYNQCe69aAloRTGulfBESBSYNyxR5g/Bhw7hKwZwl4vk9LnM5JmsBzUyDGAX3B8G23Mz/g9BuUa/0IiutfMkj7zwKmngAuXSvOpUvAWYBtF4BTnspIj/O8zPaf7qdvWITw6eZA0JLQEhKEGgxZhUj/dz3NzSKwbR44exnYvVKcy+mM5Km0JhxInUtrGkmzCPicg3W5LMGkQiZZTm9xS9Z3+4m2o8C5c4X15pTKW2Lb+fCx7WLtjYxzqiql29Icw/dA5SqYf6RTTilg+lYCIXmICKQ4IK9wxfSJY8AZK8CuFWDnanEua9ZTAMsaCog3Dt92O/MvnRGBtGwkqKRmMEkqCaa+2k+0LQDTh4rP88UHj74kF1WaATo9QHQ7mmP4HugYhtEKj4PB6ZQ+FS0hQahpldPya1kXTOqNY8DscgG+HavAttUCvBxInitrkgL4lcO33c7spBdM3kAuSnq2nx9gQfAh4JyVwvrxwel2z3p4aMlzH6DM2z/lT+8aB+Q/OT4EEqckWQSBkGD6EQKQnDCLwBSnYgcf32fXioGUFawC4esyu7CXXnDP9tOCsyD4KLB1rmgvX7zfbu2WG/Jtme0/3U/vKxBNAMoi0KcjkATCN3HOEr3UAjDrwOP71rXixYEkeKMFlSX8ocwR6KUXTJ7AaNE2tF8WfA4Ye7Kw1mwvX/yZn+eKnvcrfzC6IK/ObP/pfnpfAGQnySoISBqUXyAASS1AK0JfagWYcRDOrAF66TxZQU7jBOEbM0egH71gcgXSFZAV54NQtj9YcNIpbONCyh8Ygi8CVospApDuB63g92W2/3Q/vW8AsqM4gLIKBBIH8bcJwMCNMX68BTqBb8s6sGWtsIA6jwDk662ZI9CvXjA5A6NVa2t/IAicnC/aGV+8T74IQPm/AmGuBc+8/VP+9IEAyLslAKMV/LgAyIUInfnjwPQqMOOgI/DstQ5Mr7UAqMF8V2YXDqoXXNl+EQQ6N9v29aKdesUpWJZbAPyPme0/3U8fGIDssDid/pUASCvCaXgJmFguAEfgEXT27gDkuwaUg/nbmSMwjF7whvbLhSDL5TwwvdRqo9oqHzACkCB8U2b7T/fThwIgO01T1IMCoAZxGRhbKoAXQUcQTjkI+a4B5e5FzjGsXvCG9gdqrLGFYrpVG/UuHzBOw2/LaXxzbh43DKeoJwlAHqLndSs4udoCoIBHQE45EPk3DuitmYOQoxdctp8+rFwIWsGFYiFFoLGNchcEQC6e+OJC5J2Z7T/dTx/aApYdJ37AyJK/DIwvFxYvWr0IwEn/H1Opco5sveDUhSAAF4HJpQJkWixp6k2n4IYfMGf0amDHev2I8+l4/UbvNw8Eozw72wJePOJ8und7EkKj9ztKGA1/7WwATo44n45pWI3e7/AAGPWZ2QBkYHCU+XTMfGGQmYIxjd7vqOE0+PXzATjifDrKtTZ6v4MP/MlyRj4AR5xPF+VaqZLJF1UzKdPV6P2eLDDr3I58AI44n07ZMARbo/d78gMubWE+AEecT8e9YOn2Uheu0fs9tUCYD8AR59MpG6bR+z21gKfW1gNAz4geRT5dTEZo9H5PPRDmAzBmRM8BJzqfLiYjSKKr0fs9dYBYDwBHmE9XtRfMsIz04aQZ1+j9npygrA+Akqs8wfl0BCCTWRq935MTYL1aVQ8Ao1zlAnAi8+kEQGZTNXq/vYb75Pt/fQAcUT5dBGCj93vyAaxXi+oDoFLyT3A+3Rcavd9eY3xS/z8fgCQX/LPR3SOzkon55jg1eyAfgD8M4NcAPD6aDmBtB1e4NMDNcer1QD4AbwbwxwDe4UvRE9wHZG1gNSXDLlwLNcep1QP5APxzzwj9IIAPnXhT5ORc5EYCA9HNcWr1QD4AmRH6FQBMTSZZH98ZmD5Bh5g1FopiNns1x6nTA/kAvAfAEwDudnI+EvQxPfkEzYfaCXRSBluQMB7YHKdGD+QDsBNBH/9+AkAobqTADGK7Inw1x8nfA/kA7EXQt8kgrGAGMfBxZ5Cv5ji5eyAfgL0I+r68uR0QmUFoBQU8vfNvzXHy9kA9AORoMw7CdGQCjoUZDwL4kv/+8OZ1gJhBIjGDgMh3vTavBc035/RAPgD7JegjODfhiMwgoqeJwNPPTaB6Ezq/hq+sB4AcXeXEP+ZhGVo9vRimIQD5v5oPAZCupgDI9wg8/qz/1Xz55usyeyAfgMMQ9GU2Op4eAchpOIJQQEz/VuPlm6/K7IH6AMjgGzdl6QtyX5jWjpQFevF3lq3xf6yhrOlIAUgQCojR8gmE+l9Nl2++JrMH6gEgR5UA5KYsc+AZmCbQCDi+IvgEQMob1XBEAHIajgBMLV+0kCdws6aGu3zqfkV9AGTwjftg3JRVVRAtHQEXX/wbAcoXP5d5CID8GoJKvqDAloKOoIz/y7x8c3pmD4zhaqwjRzCYyQg5gr2ZgsFTLweWr8XQgsXjbwLWrnNtMlKgNoLBmZAa7PTCAuYIBlMvlWQswwr2UlUw45jdDSx8HbD+Ctd+HVCwePKbgJV9aASDM8Yg59TWFDysYPBtmYK91IbNOHaPA/M7gUXKXA4hWDz79cA8+W0aweCMURj+1HYfcBjBYO54MMY3tGDv8I3nmWSHOzYOLJ0LLPGXAQWLz3oB8MQUsEa16kYwOG8whjh74yJkUMFgbsNlCfYO0epwissVY34bsHw2sEIRkAEEi/dcU0SP5qhF1ggG5w3GEGdXr4L5134Fg4kAjuDQgr1DtDqcUmZETwArZwAru4BVqsv0KVh8/o3F4v0QXZBGMDhvMIY4u3MYhv95Zh+Cu1xBcxuOU/HfeDIq5cv7FuwdotXhlCBXjOXZAnyrO4BV6in0IVh8wStLuWCsUAyvEQzOG5ABz+4eB+R/ewnu/kOP/3G/l4kJTERlljQtIot2e53/IwO2OPl4FLtcnCqAp9cahT56CBZf+LpSLhhz1N5qBIPzBmTAs/sLRHcTDKbiNHdBGGymOC/3hglEvgjAnoK9A7Y4+XgiV4zVWYDAs/etxaubYPFFP1QkLtCIP8neaASD8wZkwLP7AyC/tJNg8L/xLNBu+YBdBXsHbHEFAINcMVamgdWZAoRrfPdXm8KitLdmgYveWAq+2y7iMqfuRjA4b1AGOLt/APJLqwSD3+y5T1yI0AoSbAxMMzGV1o8/My2ro2DvAK2t+GgiV4zj4+3AIwDXtwBrVJeuECze+9aW4Dut4PxkIhYsdetGMDhvoDqcPRgA+SWp4O4veQ5Uv/mAGwR78+6rQq4Yq9PAOi2fA4/vBkKudKVU7VZw77uKvWFuZbtcMNb5v0YwOG9g+jx7cADyi6Pg7gccgIxlcA5TKhaD01yYKBmVFpBZMfx/m2Bvny3t8LGqoqTliZbVI+gMgHwnMAnCIFi897cLAAZ6QyzFzzSCwXkD1OPs4QDIL5XgLmk5JHk/SD5gKdibd38VcsVYGmuBTaAzEHLHgyCcaokB7/1IkUET5IKxwF5pBIPzBqbPs4cHIC/AaeqvPL9pmHxAE+zts6VdLCD/lcgVY3UyWD0Bj1ZwqgCggXA7sPfWAoAJvaEtZBrB4Lyx6efsPADyCtmCvf00s/NnOsgVY3m8BTRZPZuGBUACdArY+5lWDqGmYbIrLHEx0ggG5w1OH2fnA7CPizQfaXqgUw80AGywMdIeaAA40u5vLt4AsMHASHugAeBIu7+5eAPABgMj7YEGgCPt/ubiDQAbDIy0BxoAjrT7m4s3AGwwMNIeaAA40u5vLt4AsMHASHugAeBIu7+5eAPABgMj7YEGgCPt/ubiDQAbDIy0B8ZYNMbkX+ZekpuIiOQrPar+xs889HJg6jZg5jAwvVZ8B+ll9PlO5/Fc/o+ECjnHfi8zYfkvM5ulmp4qJXVqx5deD4zfAkw/CGxdAZgoHfuh131QkaI5hu8Bs4Ds8B0AWLnIRGCBsFfn87JffDMwdjOw5R5g8giwZa34jnQQUwDo99wBfJ4TM7COiNdlaj2rA/jeV/vfDeATAP4UGH8I2Lrc6gc+SHqY4oMZ74VSKM0xfA+UUzB/oBUUCKMl6zSQ/PsXqZD5KQC/A0w/DEwcAcYXgYnVwppwADuBkefnCim90FmBWXwnK87Uen53BI8sbuwqaz9p5UgnQhBS+ZN1zE8Ak0utviCwq8DI8/nx5hi+Bzb4gJzKZE1SEFZZgS9/2pWR/gTAJ4HJQ8DEMWB8ARhfBsaWCwDquwQKvvNgHXvOcYVbPFJPkw+dDxC/W1Y4tWDpw/Rlgo4lo1T4/KxTihDNpJwj3/UiMLXemprjffC7eWpzDN8DlYsQDiKtVxzEqoHkyX9HRizW+nIgaQnvAiaeBCbmC0s4tgSMu2rMePAR9X252jXklaTFU108K0MHav/nvJ6ZxVVk9OI7GR2IZoGQNc/HgbHgIwqILIVujuF7oOMqWFawCoRxkfEIB5CWgkREBCNf9wMTc8A4QciBWyoGz16rwNgaML5eWKpctYZL3N+TWLX0gvtuP0HHk2n16JDyxXmVhfU0qywbJbr5GSuXKxA/sV5Y9UYWdnjwyS3qKKgarWA69Wg6fjQOIK0HadnIjPVFB+AiME4AuiUkCFnESyCSkmAuU7Cjm15wX+2X2ifBRn9A8mKcW2UFjULVQcgVDl80u40SYh763FfvquhLCxitoBYUsoJfjXKttByMq9CKcHn4sPuCbgXNJwyWkECcz5Q376UX3LNncZyQAAADEklEQVT9fFgIJs6lBBwtn3Tt6FpIz4RWnuQxPh2XIGzm4CwQ9hWIFgBTK0gQHiIAJddKq0ELQh+KL1qUR4MvSEsoENIKrgALHNiMox+94K7tl9qnnMio8MSf6SNwGpYVjCDk/Ju7isq496fCqX0BkDeqlWwKwic1gAQSpzGREnFgREz01eALLvvq2Kfi45m6cf3qBXdsfxRbJMho8dimqOhEK8cXQRr9QVpvPoDNMXQP9A3ACELFxPh+jACkP0fLIKFCCRRqKuPUdqjlC9o07JZwKVNHeBC94DQcZO0XAAkmgotAk9QYrR9f/BvByYfMSATDVMzwTXMM3QMDAVAgVHCZ7/MaQK4QZUHiNCbBQlqUw74YCb7gcmYkelC9YFlwvVv7RRAorTuBkECU9asCID9/x9B935zYzyKkqpfiNHxcA0gLQgvBAaPVkCqm3h2AtC5m/RyEqzw/4xhGL3hD++MmslgqCbgUfLKAcRrmTlBzDN0DA1tAXUlWcDm1IOIIJAjlT/Fd05lbFQFwjdtgGcewesFt7Rc/Gx8iWjUCjGCT1YvWT1MwgUqrf3NG45tTbcu0aximWx9xENcEQHGbcYAEwtSXSqY0gnCdgeuMI0cvuGx/FUGgFhwEYrR80QckWN+X0fjm1DwAWv8RgJFilJZBznz0pQg+AZAAlVWh1GvGka0XzB0cCQi30aSGVa9AF62fLOB7MhrfnJoPwPER59Px+o3e76mL5Kwp2G57xPl0kxc3er+nLvyKtLmhfUC78RHn081ONnq/pzcAR5xPR9mRRu/31IVgvgUccT4dNaobvd/TGYAjzqejumqj93s6A3DE+XRUg2VSCjdaGr3fUw+I+VPwiPPpqJjO8J1Nw43e7ymHwHoAKMFd7QErAeEE5NNJMb3R+z3lsGcNzgfgiPPpomJ6o/d76oGwPgCOKJ8uKqY3er+nKwBHmE+noqRG7/fUA199U/AI8+kEwEbv93QHoEhZTnA+nYqSGr3fBoAtaiqBUImdm5hPJwA2er+nKwBHnE+X1gUzSbnR+z11wPj/AeCpPDD3t7rvAAAAAElFTkSuQmCC",Cd=class extends ed{constructor(e,t,i=Id.HIGH,n=Eu.COLOR){super("SMAAEffect","uniform sampler2D weightMap;varying vec2 vOffset0;varying vec2 vOffset1;void movec(const in bvec2 c,inout vec2 variable,const in vec2 value){if(c.x){variable.x=value.x;}if(c.y){variable.y=value.y;}}void movec(const in bvec4 c,inout vec4 variable,const in vec4 value){movec(c.xy,variable.xy,value.xy);movec(c.zw,variable.zw,value.zw);}void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec4 a;a.x=texture2D(weightMap,vOffset0).a;a.y=texture2D(weightMap,vOffset1).g;a.wz=texture2D(weightMap,uv).rb;vec4 color=inputColor;if(dot(a,vec4(1.0))>=1e-5){bool h=max(a.x,a.z)>max(a.y,a.w);vec4 blendingOffset=vec4(0.0,a.y,0.0,a.w);vec2 blendingWeight=a.yw;movec(bvec4(h),blendingOffset,vec4(a.x,0.0,a.z,0.0));movec(bvec2(h),blendingWeight,a.xz);blendingWeight/=dot(blendingWeight,vec2(1.0));vec4 blendingCoord=blendingOffset*vec4(texelSize,-texelSize)+uv.xyxy;color=blendingWeight.x*texture2D(inputBuffer,blendingCoord.xy);color+=blendingWeight.y*texture2D(inputBuffer,blendingCoord.zw);}outputColor=color;}",{vertexShader:"varying vec2 vOffset0;varying vec2 vOffset1;void mainSupport(const in vec2 uv){vOffset0=uv+texelSize*vec2(1.0,0.0);vOffset1=uv+texelSize*vec2(0.0,1.0);}",blendFunction:Qu.NORMAL,attributes:td.CONVOLUTION|td.DEPTH,uniforms:new Map([["weightMap",new jc(null)]])}),this.renderTargetEdges=new Te(1,1,{minFilter:b,stencilBuffer:!1,depthBuffer:!1,format:C}),this.renderTargetEdges.texture.name="SMAA.Edges",this.renderTargetWeights=this.renderTargetEdges.clone(),this.renderTargetWeights.texture.name="SMAA.Weights",this.renderTargetWeights.texture.format=I,this.uniforms.get("weightMap").value=this.renderTargetWeights.texture,this.clearPass=new Wu(!0,!1,!1),this.clearPass.overrideClearColor=new Qt(0),this.clearPass.overrideClearAlpha=1,this.edgeDetectionPass=new hd(new Au(new ye,n)),this.weightsPass=new hd(new ku);const a=new we(e);a.name="SMAA.Search",a.magFilter=g,a.minFilter=g,a.format=I,a.generateMipmaps=!1,a.needsUpdate=!0,a.flipY=!0;const r=new we(t);r.name="SMAA.Area",r.magFilter=b,r.minFilter=b,r.format=I,r.generateMipmaps=!1,r.needsUpdate=!0,r.flipY=!1;const s=this.weightsPass.getFullscreenMaterial();s.uniforms.searchTexture.value=a,s.uniforms.areaTexture.value=r,this.applyPreset(i)}get edgeDetectionMaterial(){return this.edgeDetectionPass.getFullscreenMaterial()}get colorEdgesMaterial(){return this.edgeDetectionMaterial}get weightsMaterial(){return this.weightsPass.getFullscreenMaterial()}setEdgeDetectionThreshold(e){this.edgeDetectionPass.getFullscreenMaterial().setEdgeDetectionThreshold(e)}setOrthogonalSearchSteps(e){this.weightsPass.getFullscreenMaterial().setOrthogonalSearchSteps(e)}applyPreset(e){const t=this.edgeDetectionMaterial,i=this.weightsMaterial;switch(e){case Id.LOW:t.setEdgeDetectionThreshold(.15),i.setOrthogonalSearchSteps(4),i.diagonalDetection=!1,i.cornerRounding=!1;break;case Id.MEDIUM:t.setEdgeDetectionThreshold(.1),i.setOrthogonalSearchSteps(8),i.diagonalDetection=!1,i.cornerRounding=!1;break;case Id.HIGH:t.setEdgeDetectionThreshold(.1),i.setOrthogonalSearchSteps(16),i.setDiagonalSearchSteps(8),i.setCornerRounding(25),i.diagonalDetection=!0,i.cornerRounding=!0;break;case Id.ULTRA:t.setEdgeDetectionThreshold(.05),i.setOrthogonalSearchSteps(32),i.setDiagonalSearchSteps(16),i.setCornerRounding(25),i.diagonalDetection=!0,i.cornerRounding=!0}}setDepthTexture(e,t=3200){const i=this.edgeDetectionMaterial;i.uniforms.depthBuffer.value=e,i.depthPacking=t}update(e,t,i){this.clearPass.render(e,this.renderTargetEdges),this.edgeDetectionPass.render(e,t,this.renderTargetEdges),this.weightsPass.render(e,this.renderTargetEdges,this.renderTargetWeights)}setSize(e,t){const i=this.edgeDetectionPass.getFullscreenMaterial(),n=this.weightsPass.getFullscreenMaterial();this.renderTargetEdges.setSize(e,t),this.renderTargetWeights.setSize(e,t),n.uniforms.resolution.value.set(e,t),n.uniforms.texelSize.value.set(1/e,1/t),i.uniforms.texelSize.value.copy(n.uniforms.texelSize.value)}dispose(){const e=this.weightsPass.getFullscreenMaterial().uniforms;e.searchTexture.value.dispose(),e.areaTexture.value.dispose(),super.dispose()}static get searchImageDataURL(){return Ad}static get areaImageDataURL(){return Ed}},Id={LOW:0,MEDIUM:1,HIGH:2,ULTRA:3},Pd=class extends ed{constructor(e,t,{blendFunction:i=Qu.MULTIPLY,distanceScaling:n=!0,depthAwareUpsampling:a=!0,normalDepthBuffer:r=null,samples:s=9,rings:o=7,distanceThreshold:l=.97,distanceFalloff:c=.03,rangeThreshold:h=5e-4,rangeFalloff:u=.001,minRadiusScale:p=.33,luminanceInfluence:m=.7,radius:f=.1825,intensity:g=1,bias:y=.025,fade:v=.01,color:_=null,resolutionScale:x=1,width:w=ju.AUTO_SIZE,height:S=ju.AUTO_SIZE}={}){super("SSAOEffect","uniform lowp sampler2D aoBuffer;uniform float luminanceInfluence;\n#ifdef DEPTH_AWARE_UPSAMPLING\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D normalDepthBuffer;\n#else\nuniform mediump sampler2D normalDepthBuffer;\n#endif\n#endif\n#ifdef COLORIZE\nuniform vec3 color;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){float aoLinear=texture2D(aoBuffer,uv).r;\n#if defined(DEPTH_AWARE_UPSAMPLING) && __VERSION__ == 300\nvec4 normalDepth[4];normalDepth[0]=textureOffset(normalDepthBuffer,uv,ivec2(0,0));normalDepth[1]=textureOffset(normalDepthBuffer,uv,ivec2(0,1));normalDepth[2]=textureOffset(normalDepthBuffer,uv,ivec2(1,0));normalDepth[3]=textureOffset(normalDepthBuffer,uv,ivec2(1,1));float dot01=dot(normalDepth[0].rgb,normalDepth[1].rgb);float dot02=dot(normalDepth[0].rgb,normalDepth[2].rgb);float dot03=dot(normalDepth[0].rgb,normalDepth[3].rgb);float minDot=min(dot01,min(dot02,dot03));float s=step(THRESHOLD,minDot);float smallestDistance=1.0;int index;for(int i=0;i<4;++i){float distance=abs(depth-normalDepth[i].a);if(distance<smallestDistance){smallestDistance=distance;index=i;}}ivec2 offsets[4];offsets[0]=ivec2(0,0);offsets[1]=ivec2(0,1);offsets[2]=ivec2(1,0);offsets[3]=ivec2(1,1);ivec2 coord=ivec2(uv*vec2(textureSize(aoBuffer,0)))+offsets[index];float aoNearest=texelFetch(aoBuffer,coord,0).r;float ao=mix(aoNearest,aoLinear,s);\n#else\nfloat ao=aoLinear;\n#endif\nfloat l=linearToRelativeLuminance(inputColor.rgb);ao=mix(ao,1.0,l*luminanceInfluence);\n#ifdef COLORIZE\noutputColor=vec4(1.0-(1.0-ao)*(1.0-color),inputColor.a);\n#else\noutputColor=vec4(vec3(ao),inputColor.a);\n#endif\n}",{blendFunction:i,attributes:td.DEPTH,defines:new Map([["THRESHOLD","0.997"]]),uniforms:new Map([["aoBuffer",new jc(null)],["normalDepthBuffer",new jc(null)],["luminanceInfluence",new jc(m)],["color",new jc(null)],["scale",new jc(0)]])}),this.renderTargetAO=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,depthBuffer:!1,format:C}),this.renderTargetAO.texture.name="AO.Target",this.renderTargetAO.texture.generateMipmaps=!1,this.uniforms.get("aoBuffer").value=this.renderTargetAO.texture,this.resolution=new ju(this,w,S,x),this.r=1,this.camera=e,this.ssaoPass=new hd((()=>{const i=new gd(64,64);i.wrapS=i.wrapT=d;const n=new Nu(e);return n.uniforms.noiseTexture.value=i,n.uniforms.intensity.value=g,n.uniforms.minRadiusScale.value=p,n.uniforms.fade.value=v,n.uniforms.bias.value=y,null!==r?(n.uniforms.normalDepthBuffer.value=r,n.defines.NORMAL_DEPTH="1",a&&(this.depthAwareUpsampling=a,this.uniforms.get("normalDepthBuffer").value=r)):n.uniforms.normalBuffer.value=t,n})()),this.distanceScaling=n,this.samples=s,this.rings=o,this.color=_,this.radius=f>1?f/100:f,this.setDistanceCutoff(l,c),this.setProximityCutoff(h,u)}get ssaoMaterial(){return this.ssaoPass.getFullscreenMaterial()}get samples(){return Number(this.ssaoMaterial.defines.SAMPLES_INT)}set samples(e){const t=this.ssaoMaterial;t.defines.SAMPLES_INT=e.toFixed(0),t.defines.SAMPLES_FLOAT=e.toFixed(1),t.needsUpdate=!0}get rings(){return Number(this.ssaoMaterial.defines.SPIRAL_TURNS)}set rings(e){const t=this.ssaoMaterial;t.defines.SPIRAL_TURNS=e.toFixed(1),t.needsUpdate=!0}get radius(){return this.r}set radius(e){this.r=Math.min(Math.max(e,1e-6),1);const t=this.r*this.resolution.height,i=this.ssaoMaterial;i.defines.RADIUS=t.toFixed(11),i.defines.RADIUS_SQ=(t*t).toFixed(11),i.needsUpdate=!0}get depthAwareUpsampling(){return this.defines.has("DEPTH_AWARE_UPSAMPLING")}set depthAwareUpsampling(e){this.depthAwareUpsampling!==e&&(e?this.defines.set("DEPTH_AWARE_UPSAMPLING","1"):this.defines.delete("DEPTH_AWARE_UPSAMPLING"),this.setChanged())}get distanceScaling(){return void 0!==this.ssaoMaterial.defines.DISTANCE_SCALING}set distanceScaling(e){if(this.distanceScaling!==e){const t=this.ssaoMaterial;e?t.defines.DISTANCE_SCALING="1":delete t.defines.DISTANCE_SCALING,t.needsUpdate=!0}}get color(){return this.uniforms.get("color").value}set color(e){const t=this.uniforms,i=this.defines;null!==e?i.has("COLORIZE")?t.get("color").value.set(e):(i.set("COLORIZE","1"),t.get("color").value=new Qt(e),this.setChanged()):i.has("COLORIZE")&&(i.delete("COLORIZE"),t.get("color").value=null,this.setChanged())}setDistanceCutoff(e,t){this.ssaoMaterial.uniforms.distanceCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}setProximityCutoff(e,t){this.ssaoMaterial.uniforms.proximityCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}setDepthTexture(e,t=3200){const i=this.ssaoMaterial;void 0===i.defines.NORMAL_DEPTH&&(i.uniforms.normalDepthBuffer.value=e,i.depthPacking=t)}update(e,t,i){this.ssaoPass.render(e,null,this.renderTargetAO)}setSize(e,t){const i=this.resolution;i.base.set(e,t);const n=i.width,a=i.height;this.renderTargetAO.setSize(n,a),this.ssaoMaterial.setTexelSize(1/n,1/a);const r=this.camera,s=this.ssaoMaterial.uniforms;s.noiseScale.value.set(n,a).divideScalar(64),s.inverseProjectionMatrix.value.copy(r.projectionMatrix).invert(),s.projectionMatrix.value.copy(r.projectionMatrix),this.radius=this.r}},Rd="#ifdef ASPECT_CORRECTION\nuniform float scale;\n#else\nuniform mat3 uvTransform;\n#endif\nvarying vec2 vUv2;void mainSupport(const in vec2 uv){\n#ifdef ASPECT_CORRECTION\nvUv2=uv*vec2(aspect,1.0)*scale;\n#else\nvUv2=(uvTransform*vec3(uv,1.0)).xy;\n#endif\n}",Od=class extends ed{constructor({blendFunction:e=Qu.NORMAL,texture:t=null,aspectCorrection:i=!1}={}){super("TextureEffect","#ifdef TEXTURE_PRECISION_HIGH\nuniform mediump sampler2D map;\n#else\nuniform lowp sampler2D map;\n#endif\n#if defined(ASPECT_CORRECTION) || defined(UV_TRANSFORM)\nvarying vec2 vUv2;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){\n#if defined(ASPECT_CORRECTION) || defined(UV_TRANSFORM)\nvec4 texel=texelToLinear(texture2D(map,vUv2));\n#else\nvec4 texel=texelToLinear(texture2D(map,uv));\n#endif\noutputColor=TEXEL;}",{blendFunction:e,defines:new Map([["TEXEL","texel"]]),uniforms:new Map([["map",new jc(null)],["scale",new jc(1)],["uvTransform",new jc(null)]])}),this.texture=t,this.aspectCorrection=i}get texture(){return this.uniforms.get("map").value}set texture(e){const t=this.texture;if(t!==e&&(this.uniforms.get("map").value=e,this.defines.delete("TEXTURE_PRECISION_HIGH"),null!==e)){switch(e.encoding){case te:this.defines.set("texelToLinear(texel)","sRGBToLinear(texel)");break;case ee:this.defines.set("texelToLinear(texel)","texel");break;default:console.error("Unsupported encoding:",e.encoding)}e.type!==w&&this.defines.set("TEXTURE_PRECISION_HIGH","1"),null!==t&&t.type===e.type&&t.encoding===e.encoding||this.setChanged()}}get aspectCorrection(){return this.defines.has("ASPECT_CORRECTION")}set aspectCorrection(e){this.aspectCorrection!==e&&(e?(this.uvTransform&&(this.uvTransform=!1),this.defines.set("ASPECT_CORRECTION","1"),this.setVertexShader(Rd)):(this.defines.delete("ASPECT_CORRECTION"),this.setVertexShader(null)),this.setChanged())}get uvTransform(){return this.defines.has("UV_TRANSFORM")}set uvTransform(e){this.uvTransform!==e&&(e?(this.aspectCorrection&&(this.aspectCorrection=!1),this.defines.set("UV_TRANSFORM","1"),this.uniforms.get("uvTransform").value=new ve,this.setVertexShader(Rd)):(this.defines.delete("UV_TRANSFORM"),this.uniforms.get("uvTransform").value=null,this.setVertexShader(null)),this.setChanged())}setTextureSwizzleRGBA(e,t=e,i=e,n=e){const a="rgba";let r="";e===pu&&t===mu&&i===fu&&n===gu||(r=[".",a[e],a[t],a[i],a[n]].join("")),this.defines.set("TEXEL","texel"+r),this.setChanged()}update(e,t,i){const n=this.uniforms.get("map").value;this.uvTransform&&n.matrixAutoUpdate&&(n.updateMatrix(),this.uniforms.get("uvTransform").value.copy(n.matrix))}},Dd=class extends Qo{load(e,t=(()=>{}),i=(()=>{}),n=null){const a=this.manager,r=new qo,s=new $o(r);return s.setPath(this.path),s.setResponseType("text"),new Promise(((o,l)=>{r.onError=e=>{a.itemError(e),null!==n?(n(`Failed to load ${e}`),o()):l(`Failed to load ${e}`)},a.itemStart(e),s.load(e,(i=>{try{const n=this.parse(i);a.itemEnd(e),t(n),o(n)}catch(t){console.error(t),r.onError(e)}}),i)}))}parse(e){const t=/^([\d.]+) +([\d.]+) +([\d.]+) *$/gm;let i=/TITLE +"([^"]*)"/.exec(e);const n=null!==i?i[1]:null;if(i=/LUT_3D_SIZE +(\d+)/.exec(e),null===i)throw new Error("Missing LUT_3D_SIZE information");const a=Number(i[1]),r=new Float32Array(a**3*3),s=new Ce(0,0,0),o=new Ce(1,1,1);if(i=/DOMAIN_MIN +([\d.]+) +([\d.]+) +([\d.]+)/.exec(e),null!==i&&s.set(Number(i[1]),Number(i[2]),Number(i[3])),i=/DOMAIN_MAX +([\d.]+) +([\d.]+) +([\d.]+)/.exec(e),null!==i&&o.set(Number(i[1]),Number(i[2]),Number(i[3])),s.x>o.x||s.y>o.y||s.z>o.z)throw s.set(0,0,0),o.set(1,1,1),new Error("Invalid input domain");let l=0;for(;null!==(i=t.exec(e));)r[l++]=Number(i[1]),r[l++]=Number(i[2]),r[l++]=Number(i[3]);const c=new wd(r,a,a,a);return c.encoding=te,c.domainMin.copy(s),c.domainMax.copy(o),null!==n&&(c.name=n),c}},Ld=class extends Qo{load(e=(()=>{}),t=null){4===arguments.length?(e=arguments[1],t=arguments[3]):3!==arguments.length&&"function"==typeof arguments[0]||(e=arguments[1],t=null);const i=this.manager,n=new qo;return new Promise(((a,r)=>{const s=new Image,o=new Image;n.onError=e=>{i.itemError(e),null!==t?(t(`Failed to load ${e}`),a()):r(`Failed to load ${e}`)},n.onLoad=()=>{const t=[s,o];e(t),a(t)},s.addEventListener("error",(e=>{n.itemError("smaa-search")})),o.addEventListener("error",(e=>{n.itemError("smaa-area")})),s.addEventListener("load",(()=>{i.itemEnd("smaa-search"),n.itemEnd("smaa-search")})),o.addEventListener("load",(()=>{i.itemEnd("smaa-area"),n.itemEnd("smaa-area")})),i.itemStart("smaa-search"),i.itemStart("smaa-area"),n.itemStart("smaa-search"),n.itemStart("smaa-area"),s.src=Ad,o.src=Ed}))}};function kd(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function Nd(e,t){for(var i,n="",a=0,r=-1,s=0,o=0;o<=e.length;++o){if(o<e.length)i=e.charCodeAt(o);else{if(47===i)break;i=47}if(47===i){if(r===o-1||1===s);else if(r!==o-1&&2===s){if(n.length<2||2!==a||46!==n.charCodeAt(n.length-1)||46!==n.charCodeAt(n.length-2))if(n.length>2){var l=n.lastIndexOf("/");if(l!==n.length-1){-1===l?(n="",a=0):a=(n=n.slice(0,l)).length-1-n.lastIndexOf("/"),r=o,s=0;continue}}else if(2===n.length||1===n.length){n="",a=0,r=o,s=0;continue}t&&(n.length>0?n+="/..":n="..",a=2)}else n.length>0?n+="/"+e.slice(r+1,o):n=e.slice(r+1,o),a=o-r-1;r=o,s=0}else 46===i&&-1!==s?++s:s=-1}return n}var Bd={resolve:function(){for(var e,t="",i=!1,n=arguments.length-1;n>=-1&&!i;n--){var a;n>=0?a=arguments[n]:(void 0===e&&(e=process.cwd()),a=e),kd(a),0!==a.length&&(t=a+"/"+t,i=47===a.charCodeAt(0))}return t=Nd(t,!i),i?t.length>0?"/"+t:"/":t.length>0?t:"."},normalize:function(e){if(kd(e),0===e.length)return".";var t=47===e.charCodeAt(0),i=47===e.charCodeAt(e.length-1);return 0!==(e=Nd(e,!t)).length||t||(e="."),e.length>0&&i&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return kd(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,t=0;t<arguments.length;++t){var i=arguments[t];kd(i),i.length>0&&(void 0===e?e=i:e+="/"+i)}return void 0===e?".":Bd.normalize(e)},relative:function(e,t){if(kd(e),kd(t),e===t)return"";if((e=Bd.resolve(e))===(t=Bd.resolve(t)))return"";for(var i=1;i<e.length&&47===e.charCodeAt(i);++i);for(var n=e.length,a=n-i,r=1;r<t.length&&47===t.charCodeAt(r);++r);for(var s=t.length-r,o=a<s?a:s,l=-1,c=0;c<=o;++c){if(c===o){if(s>o){if(47===t.charCodeAt(r+c))return t.slice(r+c+1);if(0===c)return t.slice(r+c)}else a>o&&(47===e.charCodeAt(i+c)?l=c:0===c&&(l=0));break}var h=e.charCodeAt(i+c);if(h!==t.charCodeAt(r+c))break;47===h&&(l=c)}var u="";for(c=i+l+1;c<=n;++c)c!==n&&47!==e.charCodeAt(c)||(0===u.length?u+="..":u+="/..");return u.length>0?u+t.slice(r+l):(r+=l,47===t.charCodeAt(r)&&++r,t.slice(r))},_makeLong:function(e){return e},dirname:function(e){if(kd(e),0===e.length)return".";for(var t=e.charCodeAt(0),i=47===t,n=-1,a=!0,r=e.length-1;r>=1;--r)if(47===(t=e.charCodeAt(r))){if(!a){n=r;break}}else a=!1;return-1===n?i?"/":".":i&&1===n?"//":e.slice(0,n)},basename:function(e,t){if(void 0!==t&&"string"!=typeof t)throw new TypeError('"ext" argument must be a string');kd(e);var i,n=0,a=-1,r=!0;if(void 0!==t&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var s=t.length-1,o=-1;for(i=e.length-1;i>=0;--i){var l=e.charCodeAt(i);if(47===l){if(!r){n=i+1;break}}else-1===o&&(r=!1,o=i+1),s>=0&&(l===t.charCodeAt(s)?-1==--s&&(a=i):(s=-1,a=o))}return n===a?a=o:-1===a&&(a=e.length),e.slice(n,a)}for(i=e.length-1;i>=0;--i)if(47===e.charCodeAt(i)){if(!r){n=i+1;break}}else-1===a&&(r=!1,a=i+1);return-1===a?"":e.slice(n,a)},extname:function(e){kd(e);for(var t=-1,i=0,n=-1,a=!0,r=0,s=e.length-1;s>=0;--s){var o=e.charCodeAt(s);if(47!==o)-1===n&&(a=!1,n=s+1),46===o?-1===t?t=s:1!==r&&(r=1):-1!==t&&(r=-1);else if(!a){i=s+1;break}}return-1===t||-1===n||0===r||1===r&&t===n-1&&t===i+1?"":e.slice(t,n)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var i=t.dir||t.root,n=t.base||(t.name||"")+(t.ext||"");return i?i===t.root?i+n:i+e+n:n}("/",e)},parse:function(e){kd(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return t;var i,n=e.charCodeAt(0),a=47===n;a?(t.root="/",i=1):i=0;for(var r=-1,s=0,o=-1,l=!0,c=e.length-1,h=0;c>=i;--c)if(47!==(n=e.charCodeAt(c)))-1===o&&(l=!1,o=c+1),46===n?-1===r?r=c:1!==h&&(h=1):-1!==r&&(h=-1);else if(!l){s=c+1;break}return-1===r||-1===o||0===h||1===h&&r===o-1&&r===s+1?-1!==o&&(t.base=t.name=0===s&&a?e.slice(1,o):e.slice(s,o)):(0===s&&a?(t.name=e.slice(1,r),t.base=e.slice(1,o)):(t.name=e.slice(s,r),t.base=e.slice(s,o)),t.ext=e.slice(r,o)),s>0?t.dir=e.slice(0,s-1):a&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};Bd.posix=Bd;var zd=Bd;function Ud(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const i=t.pathname.split("/").pop(),n=i.lastIndexOf(".");if(-1===n||n===i.length-1)return null;return i.substring(n+1)}class Fd{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const i=this.itemSet;if(i.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,a=this.itemList,r=this.callbacks;return a.push(e),n.add(e),i.set(e,Date.now()),r.set(e,t),!0}remove(e){const t=this.usedSet,i=this.itemSet,n=this.itemList,a=this.callbacks;if(i.has(e)){a.get(e)(e);const r=n.indexOf(e);return n.splice(r,1),t.delete(e),i.delete(e),a.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,i=this.usedSet;t.has(e)&&!i.has(e)&&(t.set(e,Date.now()),i.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,i=this.itemList,n=this.itemSet,a=this.usedSet,r=this.callbacks,s=i.length-a.size,o=i.length-t,l=this.unloadPriorityCallback||this.defaultPriorityCallback;if(o>0&&s>0){i.sort(((e,t)=>{const i=a.has(e),n=a.has(t);return i&&n?0:i||n?i?1:-1:l(t)-l(e)}));const c=Math.min(o,s),h=Math.max(t*e,c*e);let u=Math.min(h,s);u=Math.ceil(u);const d=i.splice(0,u);for(let e=0,t=d.length;e<t;e++){const t=d[e];r.get(t)(t),n.delete(t),r.delete(t)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,function(e){Promise.resolve().then(e)}((()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()})))}}class jd{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((i,n)=>{const a=this.items,r=this.callbacks;a.push(e),r.set(e,((...e)=>t(...e).then(i).catch(n))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,i=this.callbacks,n=t.indexOf(e);-1!==n&&(t.splice(n,1),i.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,i=this.maxJobs;let n=this.currJobs;for(;i>n&&e.length>0;){n++;const i=e.pop(),a=t.get(i);t.delete(i),a(i).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}function Hd(e){return 3===e||4===e}function Gd(e,t){return e.__lastFrameVisited===t&&e.__used}function Vd(e,t){e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)}function Wd(e,t,i){if(Vd(e,t),e.__used=!0,i.markUsed(e),e.__contentEmpty){const n=e.children;for(let e=0,a=n.length;e<a;e++)Wd(n[e],t,i)}}function Yd(e,t,i){if(e.__contentEmpty&&(!e.__externalTileSet||Hd(e.__loadingState))){const n=e.children;for(let e=0,a=n.length;e<a;e++){const a=n[e];a.__depthFromRenderedParent=t,Yd(a,t,i)}}else i.requestTileContents(e)}function Xd(e,t=null,i=null,n=null,a=0){if(t&&t(e,n,a))return void(i&&i(e,n,a));const r=e.children;for(let n=0,s=r.length;n<s;n++)Xd(r[n],t,i,e,a+1);i&&i(e,n,a)}function Zd(e,t){const i=t.stats,n=t.frameCount,a=t.errorTarget,r=t.maxDepth,s=t.loadSiblings,o=t.lruCache,l=t.stopAtEmptyTiles;Vd(e,n);if(!1===t.tileInView(e))return!1;if(e.__used=!0,o.markUsed(e),e.__inFrustum=!0,i.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){t.calculateError(e);if(e.__error<=a)return!0;if(t.maxDepth>0&&e.__depth+1>=r)return!0}let c=!1;const h=e.children;for(let e=0,i=h.length;e<i;e++){const i=Zd(h[e],t);c=c||i}if(c&&s)for(let e=0,t=h.length;e<t;e++){Wd(h[e],n,o)}return!0}function qd(e,t){const i=t.stats,n=t.frameCount;if(!Gd(e,n))return;i.used++;const a=e.children;let r=!1;for(let e=0,t=a.length;e<t;e++){const t=a[e];r=r||Gd(t,n)}if(r){let i=!1,r=!0;for(let e=0,s=a.length;e<s;e++){const s=a[e];if(qd(s,t),i=i||s.__wasSetVisible||s.__childrenWereVisible,Gd(s,n)){const e=s.__allChildrenLoaded||!s.__contentEmpty&&Hd(s.__loadingState)||s.__externalTileSet&&4===s.__loadingState;r=r&&e}}e.__childrenWereVisible=i,e.__allChildrenLoaded=r}else e.__isLeaf=!0}function Jd(e,t){const i=t.stats,n=t.frameCount;if(!Gd(e,n))return;const a=e.parent,r=a?a.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=r;const s=t.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(3===e.__loadingState?(e.__inFrustum&&(e.__visible=!0,i.visible++),e.__active=!0,i.active++):s.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.requestTileContents(e));const o=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=o,c=l||"ADD"===e.refine,h=!e.__contentEmpty,u=h||e.__externalTileSet,d=Hd(e.__loadingState)&&u,p=e.__childrenWereVisible,m=e.children;let f=e.__allChildrenLoaded;if(c&&h&&e.__depthFromRenderedParent++,c&&!d&&!s.isFull()&&u&&t.requestTileContents(e),(l&&!f&&!p&&d||"ADD"===e.refine&&d)&&(e.__inFrustum&&(e.__visible=!0,i.visible++),e.__active=!0,i.active++),"ADD"!==e.refine&&l&&!f&&d)for(let i=0,a=m.length;i<a;i++){const a=m[i];Gd(a,n)&&!s.isFull()&&(a.__depthFromRenderedParent=e.__depthFromRenderedParent+1,Yd(a,a.__depthFromRenderedParent,t))}else for(let e=0,i=m.length;e<i;e++){const i=m[e];Gd(i,n)&&Jd(i,t)}}function Qd(e,t){const i=Gd(e,t.frameCount);if(i||e.__usedLastFrame){let n=!1,a=!1;i&&(n=e.__active,a=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||3!==e.__loadingState||(e.__wasSetActive!==n&&t.setTileActive(e,n),e.__wasSetVisible!==a&&t.setTileVisible(e,a)),e.__wasSetActive=n,e.__wasSetVisible=a,e.__usedLastFrame=i;const r=e.children;for(let e=0,i=r.length;e<i;e++){Qd(r[e],t)}}}const Kd=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,$d=e=>1/(e.__depthFromRenderedParent+1);function ep(e){return(new TextDecoder).decode(e)}class tp{constructor(e,t,i,n){this.buffer=e,this.binOffset=t+i,this.binLength=n;let a=null;if(0!==i){const n=new Uint8Array(e,t,i);a=JSON.parse(ep(n))}else a={};this.header=a}getKeys(){return Object.keys(this.header)}getData(e,t,i=null,n=null){const a=this.header;if(!(e in a))return null;const r=a[e];if(r instanceof Object){if(Array.isArray(r))return r;{const{buffer:a,binOffset:s,binLength:o}=this,l=r.byteOffset||0,c=r.type||n,h=r.componentType||i;if("type"in r&&n&&r.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let u,d;switch(c){case"SCALAR":u=1;break;case"VEC2":u=2;break;case"VEC3":u=3;break;case"VEC4":u=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}const p=s+l,m=t*u;switch(h){case"BYTE":d=new Int8Array(a,p,m);break;case"UNSIGNED_BYTE":d=new Uint8Array(a,p,m);break;case"SHORT":d=new Int16Array(a,p,m);break;case"UNSIGNED_SHORT":d=new Uint16Array(a,p,m);break;case"INT":d=new Int32Array(a,p,m);break;case"UNSIGNED_INT":d=new Uint32Array(a,p,m);break;case"FLOAT":d=new Float32Array(a,p,m);break;case"DOUBLE":d=new Float64Array(a,p,m);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(p+m*d.BYTES_PER_ELEMENT>s+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}return r}}class ip extends tp{constructor(e,t,i,n,a){super(e,i,n,a),this.batchSize=t}getData(e,t=null,i=null){return super.getData(e,this.batchSize,i,t)}}var np=function(){function e(e){Qo.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new r(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new s(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new c(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(Qo.prototype),{constructor:e,load:function(e,t,i,n){var a,r=this;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:ql.extractUrlBase(e),this.manager.itemStart(e);var s=function(t){n?n(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new $o(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(i){try{r.parse(i,a,(function(i){t(i),r.manager.itemEnd(e)}),s)}catch(e){s(e)}}),i,s)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,r){var s,o={},l={};if("string"==typeof e)s=e;else if(ql.decodeText(new Uint8Array(e,0,4))===h){try{o[i.KHR_BINARY_GLTF]=new w(e)}catch(e){return void(r&&r(e))}s=o[i.KHR_BINARY_GLTF].content}else s=ql.decodeText(new Uint8Array(e));var c=JSON.parse(s);if(void 0===c.asset||c.asset.version[0]<2)r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var u=new ee(c,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(var d=0;d<this.pluginCallbacks.length;d++){var p=this.pluginCallbacks[d](u);l[p.name]=p,o[p.name]=!0}if(c.extensionsUsed)for(d=0;d<c.extensionsUsed.length;++d){var m=c.extensionsUsed[d],f=c.extensionsRequired||[];switch(m){case i.KHR_MATERIALS_UNLIT:o[m]=new a;break;case i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[m]=new A;break;case i.KHR_DRACO_MESH_COMPRESSION:o[m]=new S(c,this.dracoLoader);break;case i.KHR_TEXTURE_TRANSFORM:o[m]=new M;break;case i.KHR_MESH_QUANTIZATION:o[m]=new E;break;default:f.indexOf(m)>=0&&void 0===l[m]&&console.warn('THREE.GLTFLoader: Unknown extension "'+m+'".')}}u.setExtensions(o),u.setPlugins(l),u.parse(n,r)}}});var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=i.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function a(){this.name=i.KHR_MATERIALS_UNLIT}function r(e){this.parser=e,this.name=i.KHR_MATERIALS_CLEARCOAT}function s(e){this.parser=e,this.name=i.KHR_MATERIALS_TRANSMISSION}function o(e){this.parser=e,this.name=i.KHR_TEXTURE_BASISU}function l(e){this.parser=e,this.name=i.EXT_TEXTURE_WEBP,this.isSupported=null}function c(e){this.name=i.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],i=0,n=t.length;i<n;i++){var a=t[i];a.extensions&&a.extensions[this.name]&&void 0!==a.extensions[this.name].light&&e._addNodeRef(this.cache,a.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,i="light:"+e,n=t.cache.get(i);if(n)return n;var a,r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e],o=new Qt(16777215);void 0!==s.color&&o.fromArray(s.color);var l=void 0!==s.range?s.range:0;switch(s.type){case"directional":(a=new Gl(o)).target.position.set(0,0,-1),a.add(a.target);break;case"point":(a=new Fl(o)).distance=l;break;case"spot":(a=new kl(o)).distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),n=Promise.resolve(a),t.cache.add(i,n),n},n.prototype.createNodeAttachment=function(e){var t=this,i=this.parser,n=i.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return i._getNodeRef(t.cache,a,e)}))},a.prototype.getMaterialType=function(){return Kt},a.prototype.extendParams=function(e,t,i){var n=[];e.color=new Qt(1,1,1),e.opacity=1;var a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){var r=a.baseColorFactor;e.color.fromArray(r),e.opacity=r[3]}void 0!==a.baseColorTexture&&n.push(i.assignTexture(e,"map",a.baseColorTexture))}return Promise.all(n)},r.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},r.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&a.push(i.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&a.push(i.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(a.push(i.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){var s=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ye(s,-s)}return Promise.all(a)},s.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},s.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(i.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)},o.prototype.loadTexture=function(e){var t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var a=n.extensions[this.name],r=i.images[a.source],s=t.options.ktx2Loader;if(!s){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r,s)},l.prototype.loadTexture=function(e){var t=this.name,i=this.parser,n=i.json,a=n.textures[e];if(!a.extensions||!a.extensions[t])return null;var r=a.extensions[t],s=n.images[r.source],o=i.textureLoader;if(s.uri){var l=i.options.manager.getHandler(s.uri);null!==l&&(o=l)}return this.detectSupport().then((function(a){if(a)return i.loadTextureImage(e,s,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},c.prototype.loadBufferView=function(e){var t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){var n=i.extensions[this.name],a=this.parser.getDependency("buffer",n.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([a,r.ready]).then((function(e){var t=n.byteOffset||0,i=n.byteLength||0,a=n.count,s=n.byteStride,o=new ArrayBuffer(a*s),l=new Uint8Array(e[0],t,i);return r.decodeGltfBuffer(new Uint8Array(o),a,s,l,n.mode,n.filter),o}))}return null};var h="glTF",u=1313821514,p=5130562;function w(e){this.name=i.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:ql.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var n=this.header.length-12,a=new DataView(e,12),r=0;r<n;){var s=a.getUint32(r,!0);r+=4;var o=a.getUint32(r,!0);if(r+=4,o===u){var l=new Uint8Array(e,12+r,s);this.content=ql.decodeText(l)}else if(o===p){var c=12+r;this.body=e.slice(c,c+s)}r+=s}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function S(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=i.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function M(){this.name=i.KHR_TEXTURE_TRANSFORM}function T(e){So.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),a=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),s={specular:{value:(new Qt).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=s,this.onBeforeCompile=function(e){for(var o in s)e.uniforms[o]=s[o];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",a).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return s.specular.value},set:function(e){s.specular.value=e}},specularMap:{get:function(){return s.specularMap.value},set:function(e){s.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return s.glossiness.value},set:function(e){s.glossiness.value=e}},glossinessMap:{get:function(){return s.glossinessMap.value},set:function(e){s.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function A(){return{name:i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return T},extendParams:function(e,t,i){var n=t.extensions[this.name];e.color=new Qt(1,1,1),e.opacity=1;var a=[];if(Array.isArray(n.diffuseFactor)){var r=n.diffuseFactor;e.color.fromArray(r),e.opacity=r[3]}if(void 0!==n.diffuseTexture&&a.push(i.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Qt(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Qt(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var s=n.specularGlossinessTexture;a.push(i.assignTexture(e,"glossinessMap",s)),a.push(i.assignTexture(e,"specularMap",s))}return Promise.all(a)},createMaterial:function(e){var t=new T(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=0,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function E(){this.name=i.KHR_MESH_QUANTIZATION}function I(e,t,i,n){Do.call(this,e,t,i,n)}S.prototype.decodePrimitive=function(e,t){var i=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,s={},o={},l={};for(var c in r){var h=j[c]||c.toLowerCase();s[h]=r[c]}for(c in e.attributes){h=j[c]||c.toLowerCase();if(void 0!==r[c]){var u=i.accessors[e.attributes[c]],d=B[u.componentType];l[h]=d,o[h]=!0===u.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var i in e.attributes){var n=e.attributes[i],a=o[i];void 0!==a&&(n.normalized=a)}t(e)}),s,l)}))}))},M.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},T.prototype=Object.create(So.prototype),T.prototype.constructor=T,T.prototype.copy=function(e){return So.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},I.prototype=Object.create(Do.prototype),I.prototype.constructor=I,I.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,a=e*n*3+n,r=0;r!==n;r++)t[r]=i[a+r];return t},I.prototype.beforeStart_=I.prototype.copySampleValue_,I.prototype.afterEnd_=I.prototype.copySampleValue_,I.prototype.interpolate_=function(e,t,i,n){for(var a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,c=n-t,h=(i-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,y=1-f,v=g-u+h,b=0;b!==s;b++){var _=r[m+b+s],x=r[m+b+o]*c,w=r[p+b+s],S=r[p+b]*c;a[b]=y*_+v*x+f*w+g*S}return a};var P=0,R=1,O=2,D=3,L=4,k=5,N=6,B={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},z={9728:g,9729:b,9984:y,9985:_,9986:v,9987:x},U={33071:m,33648:f,10497:d},F={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},j={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},H={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},G={CUBICSPLINE:void 0,LINEAR:X,STEP:Y},V="OPAQUE",W="MASK",Z="BLEND";function q(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function J(e,t,i){for(var n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function Q(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function K(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(i=0,n=a.length;i<n;i++)e.morphTargetDictionary[a[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function $(e){for(var t="",i=Object.keys(e).sort(),n=0,a=i.length;n<a;n++)t+=i[n]+":"+e[i[n]]+";";return t}function ee(e,i){this.json=e||{},this.extensions={},this.plugins={},this.options=i||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ic(this.options.manager):this.textureLoader=new al(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new $o(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function ie(e,t,i){var n=t.attributes,a=[];function r(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var s in n){var o=j[s]||s.toLowerCase();o in e.attributes||a.push(r(n[s],o))}if(void 0!==t.indices&&!e.index){var l=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return Q(e,t),function(e,t,i){var n=t.attributes,a=new Re;if(void 0!==n.POSITION){var r=(d=i.json.accessors[n.POSITION]).min,s=d.max;if(void 0!==r&&void 0!==s){a.set(new Ce(r[0],r[1],r[2]),new Ce(s[0],s[1],s[2]));var o=t.targets;if(void 0!==o){for(var l=new Ce,c=new Ce,h=0,u=o.length;h<u;h++){var d,p=o[h];if(void 0!==p.POSITION)r=(d=i.json.accessors[p.POSITION]).min,s=d.max,void 0!==r&&void 0!==s?(c.setX(Math.max(Math.abs(r[0]),Math.abs(s[0]))),c.setY(Math.max(Math.abs(r[1]),Math.abs(s[1]))),c.setZ(Math.max(Math.abs(r[2]),Math.abs(s[2]))),l.max(c)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}a.expandByVector(l)}e.boundingBox=a;var m=new Xe;a.getCenter(m.center),m.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=m}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(e,t,i),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,i){for(var n=!1,a=!1,r=0,s=t.length;r<s&&(void 0!==(c=t[r]).POSITION&&(n=!0),void 0!==c.NORMAL&&(a=!0),!n||!a);r++);if(!n&&!a)return Promise.resolve(e);var o=[],l=[];for(r=0,s=t.length;r<s;r++){var c=t[r];if(n){var h=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;o.push(h)}a&&(h=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(h))}return Promise.all([Promise.all(o),Promise.all(l)]).then((function(t){var i=t[0],r=t[1];return n&&(e.morphAttributes.position=i),a&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}function ne(e,t){var i=e.getIndex();if(null===i){var n=[],a=e.getAttribute("position");if(void 0===a)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var r=0;r<a.count;r++)n.push(r);e.setIndex(n),i=e.getIndex()}var s=i.count-2,o=[];if(2===t)for(r=1;r<=s;r++)o.push(i.getX(0)),o.push(i.getX(r)),o.push(i.getX(r+1));else for(r=0;r<s;r++)r%2==0?(o.push(i.getX(r)),o.push(i.getX(r+1)),o.push(i.getX(r+2))):(o.push(i.getX(r+2)),o.push(i.getX(r+1)),o.push(i.getX(r)));o.length/3!==s&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(o),l}return ee.prototype.setExtensions=function(e){this.extensions=e},ee.prototype.setPlugins=function(e){this.plugins=e},ee.prototype.parse=function(e,t){var i=this,n=this.json,a=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){var r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};J(a,r,n),Q(r,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){e(r)}))})).catch(t)},ee.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[],n=0,a=t.length;n<a;n++)for(var r=t[n].joints,s=0,o=r.length;s<o;s++)e[r[s]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var h=e[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(i[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},ee.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},ee.prototype._getNodeRef=function(e,t,i){if(e.refs[t]<=1)return i;var n=i.clone();return n.name+="_instance_"+e.uses[t]++,n},ee.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var i=0;i<t.length;i++){var n=e(t[i]);if(n)return n}},ee.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var i=[],n=0;n<t.length;n++){var a=e(t[n]);a&&i.push(a)}return i},ee.prototype.getDependency=function(e,t){var i=e+":"+t,n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n},ee.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t},ee.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[i.KHR_BINARY_GLTF].body);var a=this.options;return new Promise((function(e,i){n.load(q(t.uri,a.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},ee.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))},ee.prototype.loadAccessor=function(e){var t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var a=[];return void 0!==n.bufferView?a.push(this.getDependency("bufferView",n.bufferView)):a.push(null),void 0!==n.sparse&&(a.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(a).then((function(e){var a,r=e[0],s=F[n.type],o=B[n.componentType],l=o.BYTES_PER_ELEMENT,c=l*s,h=n.byteOffset||0,u=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(u&&u!==c){var p=Math.floor(h/u),m="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,f=t.cache.get(m);f||(f=new fr(new o(r,p*u,n.count*u/l),u/l),t.cache.add(m,f)),a=new yr(f,s,h%u/l,d)}else a=new ti(null===r?new o(n.count*s):new o(r,h,n.count*s),s,d);if(void 0!==n.sparse){var g=F.SCALAR,y=B[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,_=new y(e[1],v,n.sparse.count*g),x=new o(e[2],b,n.sparse.count*s);null!==r&&(a=new ti(a.array.slice(),a.itemSize,a.normalized));for(var w=0,S=_.length;w<S;w++){var M=_[w];if(a.setX(M,x[w*s]),s>=2&&a.setY(M,x[w*s+1]),s>=3&&a.setZ(M,x[w*s+2]),s>=4&&a.setW(M,x[w*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return a}))},ee.prototype.loadTexture=function(e){var t=this.json,i=this.options,n=t.textures[e],a=t.images[n.source],r=this.textureLoader;if(a.uri){var s=i.manager.getHandler(a.uri);null!==s&&(r=s)}return this.loadTextureImage(e,a,r)},ee.prototype.loadTextureImage=function(e,t,i){var n=this,a=this.json,r=this.options,s=a.textures[e],o=self.URL||self.webkitURL,l=t.uri,c=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)l=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var i=new DataView(e,25,1).getUint8(0,!1);h=6===i||4===i||3===i}c=!0;var n=new Blob([e],{type:t.mimeType});return l=o.createObjectURL(n)}));else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");return Promise.resolve(l).then((function(e){return new Promise((function(t,n){var a=t;!0===i.isImageBitmapLoader&&(a=function(e){t(new vs(e))}),i.load(q(e,r.path),a,void 0,n)}))})).then((function(t){!0===c&&o.revokeObjectURL(l),t.flipY=!1,s.name&&(t.name=s.name),h||(t.format=C);var i=(a.samplers||{})[s.sampler]||{};return t.magFilter=z[i.magFilter]||b,t.minFilter=z[i.minFilter]||x,t.wrapS=U[i.wrapS]||d,t.wrapT=U[i.wrapT]||d,n.associations.set(t,{type:"textures",index:e}),t}))},ee.prototype.assignTexture=function(e,t,n){var a=this;return this.getDependency("texture",n.index).then((function(r){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),a.extensions[i.KHR_TEXTURE_TRANSFORM]){var s=void 0!==n.extensions?n.extensions[i.KHR_TEXTURE_TRANSFORM]:void 0;if(s){var o=a.associations.get(r);r=a.extensions[i.KHR_TEXTURE_TRANSFORM].extendTexture(r,s),a.associations.set(r,o)}}e[t]=r}))},ee.prototype.assignFinalMaterial=function(e){var t=e.geometry,i=e.material,n=void 0!==t.attributes.tangent,a=void 0!==t.attributes.color,r=void 0===t.attributes.normal,s=!0===e.isSkinnedMesh,o=Object.keys(t.morphAttributes).length>0,l=o&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+i.uuid,h=this.cache.get(c);h||(h=new cs,Vt.prototype.copy.call(h,i),h.color.copy(i.color),h.map=i.map,h.sizeAttenuation=!1,this.cache.add(c,h)),i=h}else if(e.isLine){c="LineBasicMaterial:"+i.uuid;var u=this.cache.get(c);u||(u=new Kr,Vt.prototype.copy.call(u,i),u.color.copy(i.color),this.cache.add(c,u)),i=u}if(n||a||r||s||o){c="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),s&&(c+="skinning:"),n&&(c+="vertex-tangents:"),a&&(c+="vertex-colors:"),r&&(c+="flat-shading:"),o&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=i.clone(),s&&(d.skinning=!0),a&&(d.vertexColors=!0),r&&(d.flatShading=!0),o&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(i))),i=d}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i},ee.prototype.getMaterialType=function(){return So},ee.prototype.loadMaterial=function(e){var t,n=this,a=this.json,r=this.extensions,s=a.materials[e],o={},l=s.extensions||{},c=[];if(l[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(o,s,n))}else if(l[i.KHR_MATERIALS_UNLIT]){var u=r[i.KHR_MATERIALS_UNLIT];t=u.getMaterialType(),c.push(u.extendParams(o,s,n))}else{var d=s.pbrMetallicRoughness||{};if(o.color=new Qt(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;o.color.fromArray(p),o.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(o,"map",d.baseColorTexture)),o.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,o.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===s.doubleSided&&(o.side=2);var m=s.alphaMode||V;return m===Z?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,m===W&&(o.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==Kt&&(c.push(n.assignTexture(o,"normalMap",s.normalTexture)),o.normalScale=new ye(1,-1),void 0!==s.normalTexture.scale&&o.normalScale.set(s.normalTexture.scale,-s.normalTexture.scale)),void 0!==s.occlusionTexture&&t!==Kt&&(c.push(n.assignTexture(o,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(o.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==Kt&&(o.emissive=(new Qt).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&t!==Kt&&c.push(n.assignTexture(o,"emissiveMap",s.emissiveTexture)),Promise.all(c).then((function(){var a;return a=t===T?r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),s.name&&(a.name=s.name),a.map&&(a.map.encoding=te),a.emissiveMap&&(a.emissiveMap.encoding=te),Q(a,s),n.associations.set(a,{type:"materials",index:e}),s.extensions&&J(r,a,s),a}))},ee.prototype.createUniqueName=function(e){for(var t=Bc.sanitizeNodeName(e||""),i=t,n=1;this.nodeNamesUsed[i];++n)i=t+"_"+n;return this.nodeNamesUsed[i]=!0,i},ee.prototype.loadGeometries=function(e){var t=this,n=this.extensions,a=this.primitiveCache;function r(e){return n[i.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return ie(i,e,t)}))}for(var s,o,l=[],c=0,h=e.length;c<h;c++){var u,d=e[c],p=(o=void 0,(o=(s=d).extensions&&s.extensions[i.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+$(o.attributes):s.indices+":"+$(s.attributes)+":"+s.mode),m=a[p];if(m)l.push(m.promise);else u=d.extensions&&d.extensions[i.KHR_DRACO_MESH_COMPRESSION]?r(d):ie(new wi,d,t),a[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},ee.prototype.loadMesh=function(e){for(var t,i=this,n=this.json,a=this.extensions,r=n.meshes[e],s=r.primitives,o=[],l=0,c=s.length;l<c;l++){var h=void 0===s[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new So({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:0})),t.DefaultMaterial):this.getDependency("material",s[l].material);o.push(h)}return o.push(i.loadGeometries(s)),Promise.all(o).then((function(t){for(var n=t.slice(0,t.length-1),o=t[t.length-1],l=[],c=0,h=o.length;c<h;c++){var u,d=o[c],p=s[c],m=n[c];if(p.mode===L||p.mode===k||p.mode===N||void 0===p.mode)!0!==(u=!0===r.isSkinnedMesh?new Hr(d,m):new Fi(d,m)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===k?u.geometry=ne(u.geometry,1):p.mode===N&&(u.geometry=ne(u.geometry,2));else if(p.mode===R)u=new os(d,m);else if(p.mode===D)u=new as(d,m);else if(p.mode===O)u=new ls(d,m);else{if(p.mode!==P)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);u=new ms(d,m)}Object.keys(u.geometry.morphAttributes).length>0&&K(u,r),u.name=i.createUniqueName(r.name||"mesh_"+e),Q(u,r),p.extensions&&J(a,u,p),i.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var f=new sr;for(c=0,h=l.length;c<h;c++)f.add(l[c]);return f}))},ee.prototype.loadCamera=function(e){var t,i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new Zi(ge.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new jl(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Q(t,i),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},ee.prototype.loadSkin=function(e){var t=this.json.skins[e],i={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return i.inverseBindMatrices=e,i}))},ee.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],i=[],n=[],a=[],r=[],s=[],o=0,l=t.channels.length;o<l;o++){var c=t.channels[o],h=t.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==t.parameters?t.parameters[h.input]:h.input,m=void 0!==t.parameters?t.parameters[h.output]:h.output;i.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),a.push(this.getDependency("accessor",m)),r.push(h),s.push(u)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(a),Promise.all(r),Promise.all(s)]).then((function(i){for(var n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=a[c],p=r[c],m=s[c],f=o[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,H[f.path]){case H.weights:g=Fo;break;case H.rotation:g=Ho;break;case H.position:case H.scale:default:g=Vo}var y=u.name?u.name:u.uuid,v=void 0!==m.interpolation?G[m.interpolation]:X,b=[];H[f.path]===H.weights?u.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&b.push(e.name?e.name:e.uuid)})):b.push(y);var _=p.array;if(p.normalized){var x;if(_.constructor===Int8Array)x=1/127;else if(_.constructor===Uint8Array)x=1/255;else if(_.constructor==Int16Array)x=1/32767;else{if(_.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");x=1/65535}for(var w=new Float32Array(_.length),S=0,M=_.length;S<M;S++)w[S]=_[S]*x;_=w}for(S=0,M=b.length;S<M;S++){var T=new g(b[S]+"."+H[f.path],d.array,_,v);"CUBICSPLINE"===m.interpolation&&(T.createInterpolant=function(e){return new I(this.times,this.values,this.getValueSize()/3,e)},T.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(T)}}}var A=t.name?t.name:"animation_"+e;return new Wo(A,void 0,l)}))},ee.prototype.loadNode=function(e){var t,i=this.json,n=this.extensions,a=this,r=i.nodes[e],s=r.name?a.createUniqueName(r.name):"";return(t=[],void 0!==r.mesh&&t.push(a.getDependency("mesh",r.mesh).then((function(e){var t=a._getNodeRef(a.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,i=r.weights.length;t<i;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))),void 0!==r.camera&&t.push(a.getDependency("camera",r.camera).then((function(e){return a._getNodeRef(a.cameraCache,r.camera,e)}))),a._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var i;if((i=!0===r.isBone?new Gr:t.length>1?new sr:1===t.length?t[0]:new Et)!==t[0])for(var o=0,l=t.length;o<l;o++)i.add(t[o]);if(r.name&&(i.userData.name=r.name,i.name=s),Q(i,r),r.extensions&&J(n,i,r),void 0!==r.matrix){var c=new it;c.fromArray(r.matrix),i.applyMatrix4(c)}else void 0!==r.translation&&i.position.fromArray(r.translation),void 0!==r.rotation&&i.quaternion.fromArray(r.rotation),void 0!==r.scale&&i.scale.fromArray(r.scale);return a.associations.set(i,{type:"nodes",index:e}),i}))},ee.prototype.loadScene=function(){function e(t,i,n,a){var r=n.nodes[t];return a.getDependency("node",t).then((function(e){return void 0===r.skin?e:a.getDependency("skin",r.skin).then((function(e){for(var i=[],n=0,r=(t=e).joints.length;n<r;n++)i.push(a.getDependency("node",t.joints[n]));return Promise.all(i)})).then((function(i){return e.traverse((function(e){if(e.isMesh){for(var n=[],a=[],r=0,s=i.length;r<s;r++){var o=i[r];if(o){n.push(o);var l=new it;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*r),a.push(l)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[r])}e.bind(new Yr(n,a),e.matrixWorld)}})),e}));var t})).then((function(t){i.add(t);var s=[];if(r.children)for(var o=r.children,l=0,c=o.length;l<c;l++){var h=o[l];s.push(e(h,t,n,a))}return Promise.all(s)}))}return function(t){var i=this.json,n=this.extensions,a=this.json.scenes[t],r=new sr;a.name&&(r.name=this.createUniqueName(a.name)),Q(r,a),a.extensions&&J(n,r,a);for(var s=a.nodes||[],o=[],l=0,c=s.length;l<c;l++)o.push(e(s[l],r,i,this));return Promise.all(o).then((function(){return r}))}}(),e}();class ap extends class{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>{if(""===this.workingPath){const t=e.split(/\\\//g);t.pop(),this.workingPath=t.join("/")}return this.parse(t)}))}parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("b3dm"===i);const n=t.getUint32(4,!0);console.assert(1===n);const a=t.getUint32(8,!0);console.assert(a===e.byteLength);const r=t.getUint32(12,!0),s=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+r+s),h=new tp(c,0,r,s),u=28+r+s,d=e.slice(u,u+o+l),p=new ip(d,h.getData("BATCH_LENGTH"),0,o,l),m=u+o+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,m,a-m)}}}{constructor(e=Jo){super(),this.manager=e}parse(e){const t=super.parse(e),i=t.glbBytes.slice().buffer;return new Promise(((e,n)=>{const a=this.manager,r=this.fetchOptions,s=a.getHandler("path.gltf")||new np(a);"include"===r.credentials&&"cors"===r.mode&&s.setCrossOrigin("use-credentials"),"credentials"in r&&s.setWithCredentials("include"===r.credentials),r.headers&&s.setRequestHeader(r.headers);let o=this.workingPath;/[\\/]$/.test(o)||(o+="/"),s.parse(i,o,(i=>{const{batchTable:n,featureTable:a}=t,{scene:r}=i,s=a.getData("RTC_CENTER");s&&(r.position.x+=s[0],r.position.y+=s[1],r.position.z+=s[2]),i.batchTable=n,i.featureTable=a,r.batchTable=n,r.featureTable=a,e(i)}),n)}))}}class rp extends class{constructor(){this.fetchOptions={}}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>this.parse(e)))}parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("pnts"===i);const n=t.getUint32(4,!0);console.assert(1===n);const a=t.getUint32(8,!0);console.assert(a===e.byteLength);const r=t.getUint32(12,!0),s=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+r+s),h=new tp(c,0,r,s),u=28+r+s,d=e.slice(u,u+o+l),p=new ip(d,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return{version:n,featureTable:h,batchTable:p}}}{constructor(e=Jo){super(),this.manager=e}parse(e){const t=super.parse(e),{featureTable:i}=t,n=i.getData("POINTS_LENGTH"),a=i.getData("POSITION",n,"FLOAT","VEC3"),r=i.getData("RGB",n,"UNSIGNED_BYTE","VEC3");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in i.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const s=new wi;s.setAttribute("position",new ti(a,3,!1));const o=new cs;o.size=2,o.sizeAttenuation=!1,null!==r&&(s.setAttribute("color",new ti(r,3,!0)),o.vertexColors=!0);const l=new ms(s,o);t.scene=l,t.scene.featureTable=i;const c=i.getData("RTC_CENTER");return c&&(t.scene.position.x+=c[0],t.scene.position.y+=c[1],t.scene.position.z+=c[2]),t}}const sp=new Ce,op=new Ce,lp=new Ce,cp=new Ce,hp=new Ee,up=new Ce,dp=new it;class pp extends class{constructor(){this.fetchOptions={},this.workingPath=""}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>{if(""===this.workingPath){const t=e.split(/\\\//g);t.pop(),this.workingPath=t.join("/")}return this.parse(t)}))}parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("i3dm"===i);const n=t.getUint32(4,!0);console.assert(1===n);const a=t.getUint32(8,!0);console.assert(a===e.byteLength);const r=t.getUint32(12,!0),s=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+r+s),u=new tp(h,0,r,s),d=32+r+s,p=e.slice(d,d+o+l),m=new ip(p,u.getData("INSTANCES_LENGTH"),0,o,l),f=d+o+l,g=new Uint8Array(e,f,a-f);let y=null,v=null;if(c)y=g,v=Promise.resolve();else{const e=this.resolveExternalURL(ep(g));v=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{y=new Uint8Array(e)}))}return v.then((()=>({version:n,featureTable:u,batchTable:m,glbBytes:y})))}}{constructor(e=Jo){super(),this.manager=e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:i}=e,n=e.glbBytes.slice().buffer;return new Promise(((e,a)=>{const r=this.fetchOptions,s=this.manager,o=s.getHandler("path.gltf")||new np(s);"include"===r.credentials&&"cors"===r.mode&&o.setCrossOrigin("use-credentials"),"credentials"in r&&o.setWithCredentials("include"===r.credentials),r.headers&&o.setRequestHeader(r.headers);let l=this.workingPath;/[\\/]$/.test(l)||(l+="/"),o.parse(n,l,(n=>{const a=t.getData("INSTANCES_LENGTH"),r=t.getData("POSITION",a,"FLOAT","VEC3"),s=t.getData("NORMAL_UP",a,"FLOAT","VEC3"),o=t.getData("NORMAL_RIGHT",a,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",a,"FLOAT","VEC3"),c=t.getData("SCALE",a,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const h=new Map,u=[];n.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:i}=e,n=new Qr(t,i,a);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),u.push(n),h.set(e,n)}}));const d=new Ce;for(let e=0;e<a;e++)d.x+=r[3*e+0]/a,d.y+=r[3*e+1]/a,d.z+=r[3*e+2]/a;h.forEach(((e,t)=>{const i=t.parent;i&&(i.remove(t),i.add(e),e.updateMatrixWorld(),e.position.copy(d).applyMatrix4(e.matrixWorld))}));for(let e=0;e<a;e++){cp.set(r[3*e+0]-d.x,r[3*e+1]-d.y,r[3*e+2]-d.z),s?(op.set(s[3*e+0],s[3*e+1],s[3*e+2]),lp.set(o[3*e+0],o[3*e+1],o[3*e+2]),sp.crossVectors(lp,op).normalize(),dp.makeBasis(lp,op,sp),hp.setFromRotationMatrix(dp)):hp.set(0,0,0,1),c?up.setScalar(c[e]):l?up.set(l[3*e+0],l[3*e+1],l[3*e+2]):up.set(1,1,1),dp.compose(cp,hp,up);for(let t=0,i=u.length;t<i;t++){u[t].setMatrixAt(e,dp)}}n.batchTable=i,n.featureTable=t,n.scene.batchTable=i,n.scene.featureTable=t,e(n)}),a)}))}))}}class mp extends class{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>{if(""===this.workingPath){const t=e.split(/\\\//g);t.pop(),this.workingPath=t.join("/")}return this.parse(t)}))}parse(e){const t=new DataView(e),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("cmpt"===i,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const a=t.getUint32(8,!0);console.assert(a===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const r=t.getUint32(12,!0),s=[];let o=16;for(let t=0;t<r;t++){const t=new DataView(e,o,12),i=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3)),n=t.getUint32(4,!0),a=t.getUint32(8,!0),r=new Uint8Array(e,o,a);s.push({type:i,buffer:r,version:n}),o+=a}return{version:n,tiles:s}}}{constructor(e=Jo){super(),this.manager=e}parse(e){const t=super.parse(e),i=this.manager,n=[];for(const e in t.tiles){const{type:a,buffer:r}=t.tiles[e];switch(a){case"b3dm":{const e=r.slice(),t=new ap(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const a=t.parse(e.buffer);n.push(a);break}case"pnts":{const e=r.slice(),t=new rp(i).parse(e.buffer),a=Promise.resolve(t);n.push(a);break}case"i3dm":{const e=r.slice(),t=new pp(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const a=t.parse(e.buffer);n.push(a);break}}}return Promise.all(n).then((e=>{const t=new sr;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}const fp=new it;class gp extends sr{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?fp.copy(this.matrix):fp.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=fp.elements,t=this.matrixWorld.elements;let i=!1;for(let n=0;n<16;n++){const a=e[n],r=t[n];if(Math.abs(a-r)>Number.EPSILON){i=!0;break}}if(i){this.matrixWorld.copy(fp);const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateMatrixWorld()}}}}const yp=new Xe,vp=new it,bp=new Ce,_p=new Ce,xp=new tt,wp=[];function Sp(e,t){return e.distance-t.distance}function Mp(e,t,i){e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,i)}))}function Tp(e,t,i,n){if(i.has(e)){if(Mp(e.cached.scene,n,wp),wp.length>0){wp.length>1&&wp.sort(Sp);const e=wp[0];return wp.length=0,e}return null}const a=[],r=e.children;for(let e=0,i=r.length;e<i;e++){const i=r[e],s=i.cached,o=t.matrixWorld;vp.copy(o);const l=s.sphere;if(l&&(yp.copy(l),yp.applyMatrix4(vp),!n.ray.intersectsSphere(yp)))continue;const c=s.box,h=s.boxTransform;if(c){if(vp.multiply(h).invert(),xp.copy(n.ray),xp.applyMatrix4(vp),!xp.intersectBox(c,bp))continue;{let e;_p.setFromMatrixScale(vp),e=_p.x,Math.abs(Math.max(_p.x-_p.y,_p.x-_p.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when raycasting.");let t={distance:1/0,tile:null};a.push(t),t.distance=bp.distanceToSquared(xp.origin)*e*e,t.tile=i}}}a.sort(Sp);let s=1/0,o=null;for(let e=0,r=a.length;e<r;e++){const r=a[e];if(r.distance>s)break;{const e=r.tile,a=e.cached.scene;let l=null;if(i.has(e)?(Mp(a,n,wp),wp.length>0&&(wp.length>1&&wp.sort(Sp),l=wp[0])):l=Tp(e,t,i,n),l){const e=l.distance*l.distance;e<s&&(s=e,o=l),wp.length=0}}}return o}function Ap(e,t,i,n,a){const r=e.cached,s=t.matrixWorld;vp.copy(s);const o=r.sphere;if(o&&(yp.copy(o),yp.applyMatrix4(vp),!n.ray.intersectsSphere(yp)))return;const l=r.box,c=r.boxTransform;if(l&&(vp.multiply(c).invert(),xp.copy(n.ray).applyMatrix4(vp),!xp.intersectsBox(l)))return;const h=r.scene;if(i.has(e))return void Mp(h,n,a);const u=e.children;for(let e=0,r=u.length;e<r;e++)Ap(u[e],t,i,n,a)}let Ep={loaders:{},eventHandlerStore:{},pgl:{}};const Cp=20037508.34,Ip=Cp;class Pp{constructor(){let e={x:0,y:0,z:0},t={scaleX:1,scaleY:1,scaleZ:1},i={x:0,y:0,z:0},n="surface";this.setDatumShiftModel=a=>{void 0!==a.lon&&(e.x=a.lon),void 0!==a.alt&&(e.z=a.alt),void 0!==a.lat&&(e.y=a.lat),void 0!==a.scaleX&&(t.scaleX=a.scaleX),void 0!==a.scaleY&&(t.scaleY=a.scaleY),void 0!==a.scaleZ&&(t.scaleZ=a.scaleZ),void 0!==a.type&&(n=a.type),"ecef"===n.toLowerCase()&&a.offset&&(e.x=a.offset.x,e.y=a.offset.y,e.z=a.offset.z),"ecef"===n.toLowerCase()&&a.rotation&&(i.x=a.rotation.x,i.y=a.rotation.y,i.z=a.rotation.z)},this.convertTransform=(a,r)=>{var s=new it;switch(s.makeScale(t.scaleX,t.scaleY,t.scaleZ),null==r&&(null==n&&(n=""),r=n),r.toLowerCase()){case"surface":var o=this.CartesianFrom(a),l=this.GetWorldToLocal({x:e.x,y:e.y,z:e.z});o=this.preMult(o,l);let n=new Ce(o.x,o.z,-o.y);return n.applyMatrix4(s),n;case"ecef":o=this.CartesianFrom(a);o=this.preMult(o,s);const r=new Ce(o.x,o.z,-o.y),d=new it;return d.makeRotationFromEuler(new dt(ge.degToRad(i.x),ge.degToRad(i.y),ge.degToRad(i.z))),r.applyMatrix4(d),r.x+=e.x,r.y+=e.y,r.z+=e.z,r;case"planarglobal":return this.preMult(a,s);case"planarlocal":return(l=new it).makeTranslation(-e.x,-e.y,-e.z),a=this.preMult(a,l),a=this.preMult(a,s),new Ce(a.x,a.z,-a.y);case"mercator":var c=a.x*Cp/180,h=Math.log(Math.tan((90+a.y)*Math.PI/360))/(Math.PI/180);h=h*Ip/180;var u=a.z+e.z;return c+=e.x,h-=e.y,new Ce(c*t.scaleX,u*t.scaleY,-h*t.scaleZ);default:return{x:a.x||0,y:a.y||0,z:a.z||0}}},this.getCartesianFrom=e=>this.CartesianFrom(e),this.XYZToLLA=(a,r)=>{var s=new it;s.makeScale(t.scaleX,t.scaleY,t.scaleZ);var o=new it;switch(o.copy(s).invert(),null==r&&(r=n),r){case"surface":var l=this.GetWorldToLocal({x:e.x,y:e.y,z:e.z}),c=new it;c.copy(l).invert();let n=new Ce(a.x,-a.z,a.y);return n.applyMatrix4(o),h=this.preMult(n,c),this.fromCartesian(h);case"ecef":const r=new Ce(a.x,-a.z,a.y);r.x-=e.x,r.y-=e.y,r.z-=e.z;const s=new it;s.makeRotationFromEuler(new dt(ge.degToRad(i.x),ge.degToRad(i.y),ge.degToRad(i.z))),s.invert(),r.applyMatrix4(s);var h=this.preMult(r,o);return this.fromCartesian(h);case"planarglobal":return h=this.preMult(a,o);case"planarlocal":return(l=new it).makeTranslation(e.x,e.y,e.z),l.multiply(o),this.preMult({x:a.x,y:-a.z,z:a.y},l);case"mercator":a.x=a.x/t.scaleX-e.x,a.z=0-a.z/t.scaleZ,a.z=a.z+e.y;var u=a.x/Cp*180,d=a.z/Ip*180;d=180/Math.PI*(2*Math.atan(Math.exp(d*Math.PI/180))-.5*Math.PI);var p=a.y/t.scaleY-e.z;return new Ce(u,d,p);default:return{x:a.x,y:a.y,z:a.z}}},this.CartesianFrom=e=>{var t=e.x*Math.PI/180,i=e.y*Math.PI/180,n=Math.sqrt(Math.pow(Pp.EARTH_RADIUS_EQUATOR,2)-Math.pow(Pp.EARTH_RADIUS_POLAR,2))/Pp.EARTH_RADIUS_EQUATOR,a=Math.sqrt(1-Math.pow(n,2)*Math.pow(Math.sin(i),2)),r=Pp.EARTH_RADIUS_EQUATOR/a,s=e.z,o=(r+s)*Math.cos(i)*Math.cos(t),l=(r+s)*Math.cos(i)*Math.sin(t),c=(r*(1-Math.pow(n,2))+s)*Math.sin(i);return new Ce(o,l,c)},this.fromCartesian=e=>{var t=e.x,i=e.y,n=e.z,a=Pp.EARTH_RADIUS_EQUATOR,r=Pp.EARTH_RADIUS_POLAR,s=(a-r)/a,o=2*s-s*s,l=Math.sqrt(t*t+i*i),c=Math.atan2(n*a,l*r),h=(a*a-r*r)/(r*r),u=Math.sin(c),d=Math.cos(c),p=Math.atan((n+h*r*u*u*u)/(l-o*a*d*d*d)),m=Math.atan2(i,t),f=Math.sin(p),g=a/Math.sqrt(1-o*f*f),y=l/Math.cos(p)-g,v=180/Math.PI;return new Ce(m*v,p*v,y)},this.GetWorldToLocal=e=>{var t=this.CartesianFrom(e),i=e.x*Math.PI/180,n=e.y*Math.PI/180,a=Math.cos(i)*Math.cos(n),r=Math.sin(i)*Math.cos(n),s=Math.sin(n),o=new Ce(a,r,s),l=new Ce(-Math.sin(i),Math.cos(i),0),c=new Ce(o.x,o.y,o.z).cross(l),h=new it;h.Identity,h.set(l.x,l.y,l.z,1,c.x,c.y,c.z,1,o.x,o.y,o.z,1,0,0,0,1);var u=new it;return u.Identity,u.setPosition(-t.x,-t.y,-t.z),h.multiply(u)},this.preMult=(e,t)=>{var i=t.elements;return new Ce(i[0]*e.x+i[4]*e.y+i[8]*e.z+1*i[12],i[1]*e.x+i[5]*e.y+i[9]*e.z+1*i[13],i[2]*e.x+i[6]*e.y+i[10]*e.z+1*i[14])}}}Pp.EARTH_RADIUS_EQUATOR=6378137,Pp.EARTH_RADIUS_POLAR=6356752.31414;var Rp=6378137,Op=.0066943799901413165,Dp=484813681109536e-20,Lp=Math.PI/2,kp=1e-10,Np=.017453292519943295,Bp=57.29577951308232,zp=Math.PI/4,Up=2*Math.PI,Fp=3.14159265359,jp={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},Hp={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},Gp=/[\s_\-\/\(\)]/g;function Vp(e,t){if(e[t])return e[t];for(var i,n=Object.keys(e),a=t.toLowerCase().replace(Gp,""),r=-1;++r<n.length;)if((i=n[r]).toLowerCase().replace(Gp,"")===a)return e[i]}function Wp(e){var t,i,n,a={},r=e.split("+").map((function(e){return e.trim()})).filter((function(e){return e})).reduce((function(e,t){var i=t.split("=");return i.push(!0),e[i[0].toLowerCase()]=i[1],e}),{}),s={proj:"projName",datum:"datumCode",rf:function(e){a.rf=parseFloat(e)},lat_0:function(e){a.lat0=e*Np},lat_1:function(e){a.lat1=e*Np},lat_2:function(e){a.lat2=e*Np},lat_ts:function(e){a.lat_ts=e*Np},lon_0:function(e){a.long0=e*Np},lon_1:function(e){a.long1=e*Np},lon_2:function(e){a.long2=e*Np},alpha:function(e){a.alpha=parseFloat(e)*Np},gamma:function(e){a.rectified_grid_angle=parseFloat(e)},lonc:function(e){a.longc=e*Np},x_0:function(e){a.x0=parseFloat(e)},y_0:function(e){a.y0=parseFloat(e)},k_0:function(e){a.k0=parseFloat(e)},k:function(e){a.k0=parseFloat(e)},a:function(e){a.a=parseFloat(e)},b:function(e){a.b=parseFloat(e)},r_a:function(){a.R_A=!0},zone:function(e){a.zone=parseInt(e,10)},south:function(){a.utmSouth=!0},towgs84:function(e){a.datum_params=e.split(",").map((function(e){return parseFloat(e)}))},to_meter:function(e){a.to_meter=parseFloat(e)},units:function(e){a.units=e;var t=Vp(Hp,e);t&&(a.to_meter=t.to_meter)},from_greenwich:function(e){a.from_greenwich=e*Np},pm:function(e){var t=Vp(jp,e);a.from_greenwich=(t||parseFloat(e))*Np},nadgrids:function(e){"@null"===e?a.datumCode="none":a.nadgrids=e},axis:function(e){var t="ewnsud";3===e.length&&-1!==t.indexOf(e.substr(0,1))&&-1!==t.indexOf(e.substr(1,1))&&-1!==t.indexOf(e.substr(2,1))&&(a.axis=e)},approx:function(){a.approx=!0}};for(t in r)i=r[t],t in s?"function"==typeof(n=s[t])?n(i):a[n]=i:a[t]=i;return"string"==typeof a.datumCode&&"WGS84"!==a.datumCode&&(a.datumCode=a.datumCode.toLowerCase()),a}var Yp=/\s/,Xp=/[A-Za-z]/,Zp=/[A-Za-z84_]/,qp=/[,\]]/,Jp=/[\d\.E\-\+]/;function Qp(e){if("string"!=typeof e)throw new Error("not a string");this.text=e.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=1}function Kp(e,t,i){Array.isArray(t)&&(i.unshift(t),t=null);var n=t?{}:e,a=i.reduce((function(e,t){return $p(t,e),e}),n);t&&(e[t]=a)}function $p(e,t){if(Array.isArray(e)){var i=e.shift();if("PARAMETER"===i&&(i=e.shift()),1===e.length)return Array.isArray(e[0])?(t[i]={},void $p(e[0],t[i])):void(t[i]=e[0]);if(e.length)if("TOWGS84"!==i){if("AXIS"===i)return i in t||(t[i]=[]),void t[i].push(e);var n;switch(Array.isArray(i)||(t[i]={}),i){case"UNIT":case"PRIMEM":case"VERT_DATUM":return t[i]={name:e[0].toLowerCase(),convert:e[1]},void(3===e.length&&$p(e[2],t[i]));case"SPHEROID":case"ELLIPSOID":return t[i]={name:e[0],a:e[1],rf:e[2]},void(4===e.length&&$p(e[3],t[i]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return e[0]=["name",e[0]],void Kp(t,i,e);default:for(n=-1;++n<e.length;)if(!Array.isArray(e[n]))return $p(e,t[i]);return Kp(t,i,e)}}else t[i]=e;else t[i]=!0}else t[e]=!0}Qp.prototype.readCharicter=function(){var e=this.text[this.place++];if(4!==this.state)for(;Yp.test(e);){if(this.place>=this.text.length)return;e=this.text[this.place++]}switch(this.state){case 1:return this.neutral(e);case 2:return this.keyword(e);case 4:return this.quoted(e);case 5:return this.afterquote(e);case 3:return this.number(e);case-1:return}},Qp.prototype.afterquote=function(e){if('"'===e)return this.word+='"',void(this.state=4);if(qp.test(e))return this.word=this.word.trim(),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in afterquote yet, index '+this.place)},Qp.prototype.afterItem=function(e){return","===e?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=1)):"]"===e?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=1,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},Qp.prototype.number=function(e){if(!Jp.test(e)){if(qp.test(e))return this.word=parseFloat(this.word),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in number yet, index '+this.place)}this.word+=e},Qp.prototype.quoted=function(e){'"'!==e?this.word+=e:this.state=5},Qp.prototype.keyword=function(e){if(Zp.test(e))this.word+=e;else{if("["===e){var t=[];return t.push(this.word),this.level++,null===this.root?this.root=t:this.currentObject.push(t),this.stack.push(this.currentObject),this.currentObject=t,void(this.state=1)}if(!qp.test(e))throw new Error("havn't handled \""+e+'" in keyword yet, index '+this.place);this.afterItem(e)}},Qp.prototype.neutral=function(e){if(Xp.test(e))return this.word=e,void(this.state=2);if('"'===e)return this.word="",void(this.state=4);if(Jp.test(e))return this.word=e,void(this.state=3);if(!qp.test(e))throw new Error("havn't handled \""+e+'" in neutral yet, index '+this.place);this.afterItem(e)},Qp.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function em(e){return.017453292519943295*e}function tm(e){var t=new Qp(e).output(),i=t.shift(),n=t.shift();t.unshift(["name",n]),t.unshift(["type",i]);var a={};return $p(t,a),function(e){if("GEOGCS"===e.type?e.projName="longlat":"LOCAL_CS"===e.type?(e.projName="identity",e.local=!0):"object"==typeof e.PROJECTION?e.projName=Object.keys(e.PROJECTION)[0]:e.projName=e.PROJECTION,e.AXIS){for(var t="",i=0,n=e.AXIS.length;i<n;++i){var a=[e.AXIS[i][0].toLowerCase(),e.AXIS[i][1].toLowerCase()];-1!==a[0].indexOf("north")||("y"===a[0]||"lat"===a[0])&&"north"===a[1]?t+="n":-1!==a[0].indexOf("south")||("y"===a[0]||"lat"===a[0])&&"south"===a[1]?t+="s":-1!==a[0].indexOf("east")||("x"===a[0]||"lon"===a[0])&&"east"===a[1]?t+="e":-1===a[0].indexOf("west")&&("x"!==a[0]&&"lon"!==a[0]||"west"!==a[1])||(t+="w")}2===t.length&&(t+="u"),3===t.length&&(e.axis=t)}e.UNIT&&(e.units=e.UNIT.name.toLowerCase(),"metre"===e.units&&(e.units="meter"),e.UNIT.convert&&("GEOGCS"===e.type?e.DATUM&&e.DATUM.SPHEROID&&(e.to_meter=e.UNIT.convert*e.DATUM.SPHEROID.a):e.to_meter=e.UNIT.convert));var r=e.GEOGCS;function s(t){return t*(e.to_meter||1)}"GEOGCS"===e.type&&(r=e),r&&(r.DATUM?e.datumCode=r.DATUM.name.toLowerCase():e.datumCode=r.name.toLowerCase(),"d_"===e.datumCode.slice(0,2)&&(e.datumCode=e.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==e.datumCode&&"new_zealand_1949"!==e.datumCode||(e.datumCode="nzgd49"),"wgs_1984"!==e.datumCode&&"world_geodetic_system_1984"!==e.datumCode||("Mercator_Auxiliary_Sphere"===e.PROJECTION&&(e.sphere=!0),e.datumCode="wgs84"),"_ferro"===e.datumCode.slice(-6)&&(e.datumCode=e.datumCode.slice(0,-6)),"_jakarta"===e.datumCode.slice(-8)&&(e.datumCode=e.datumCode.slice(0,-8)),~e.datumCode.indexOf("belge")&&(e.datumCode="rnb72"),r.DATUM&&r.DATUM.SPHEROID&&(e.ellps=r.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===e.ellps.toLowerCase().slice(0,13)&&(e.ellps="intl"),e.a=r.DATUM.SPHEROID.a,e.rf=parseFloat(r.DATUM.SPHEROID.rf,10)),r.DATUM&&r.DATUM.TOWGS84&&(e.datum_params=r.DATUM.TOWGS84),~e.datumCode.indexOf("osgb_1936")&&(e.datumCode="osgb36"),~e.datumCode.indexOf("osni_1952")&&(e.datumCode="osni52"),(~e.datumCode.indexOf("tm65")||~e.datumCode.indexOf("geodetic_datum_of_1965"))&&(e.datumCode="ire65"),"ch1903+"===e.datumCode&&(e.datumCode="ch1903"),~e.datumCode.indexOf("israel")&&(e.datumCode="isr93")),e.b&&!isFinite(e.b)&&(e.b=e.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_1","Latitude of 1st standard parallel"],["standard_parallel_2","Standard_Parallel_2"],["standard_parallel_2","Latitude of 2nd standard parallel"],["false_easting","False_Easting"],["false_easting","False easting"],["false-easting","Easting at false origin"],["false_northing","False_Northing"],["false_northing","False northing"],["false_northing","Northing at false origin"],["central_meridian","Central_Meridian"],["central_meridian","Longitude of natural origin"],["central_meridian","Longitude of false origin"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["latitude_of_origin","Latitude of natural origin"],["latitude_of_origin","Latitude of false origin"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",em],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",em],["x0","false_easting",s],["y0","false_northing",s],["long0","central_meridian",em],["lat0","latitude_of_origin",em],["lat0","standard_parallel_1",em],["lat1","standard_parallel_1",em],["lat2","standard_parallel_2",em],["azimuth","Azimuth"],["alpha","azimuth",em],["srsCode","name"]].forEach((function(t){return function(e,t){var i=t[0],n=t[1];!(i in e)&&n in e&&(e[i]=e[n],3===t.length&&(e[i]=t[2](e[i])))}(e,t)})),e.long0||!e.longc||"Albers_Conic_Equal_Area"!==e.projName&&"Lambert_Azimuthal_Equal_Area"!==e.projName||(e.long0=e.longc),e.lat_ts||!e.lat1||"Stereographic_South_Pole"!==e.projName&&"Polar Stereographic (variant B)"!==e.projName||(e.lat0=em(e.lat1>0?90:-90),e.lat_ts=e.lat1)}(a),a}function im(e){var t=this;if(2===arguments.length){var i=arguments[1];"string"==typeof i?"+"===i.charAt(0)?im[e]=Wp(arguments[1]):im[e]=tm(arguments[1]):im[e]=i}else if(1===arguments.length){if(Array.isArray(e))return e.map((function(e){Array.isArray(e)?im.apply(t,e):im(e)}));if("string"==typeof e){if(e in im)return im[e]}else"EPSG"in e?im["EPSG:"+e.EPSG]=e:"ESRI"in e?im["ESRI:"+e.ESRI]=e:"IAU2000"in e?im["IAU2000:"+e.IAU2000]=e:console.log(e);return}}!function(e){e("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),e("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),e("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),e.WGS84=e["EPSG:4326"],e["EPSG:3785"]=e["EPSG:3857"],e.GOOGLE=e["EPSG:3857"],e["EPSG:900913"]=e["EPSG:3857"],e["EPSG:102113"]=e["EPSG:3857"]}(im);var nm=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];var am=["3857","900913","3785","102113"];function rm(e){if(!function(e){return"string"==typeof e}(e))return e;if(function(e){return e in im}(e))return im[e];if(function(e){return nm.some((function(t){return e.indexOf(t)>-1}))}(e)){var t=tm(e);if(function(e){var t=Vp(e,"authority");if(t){var i=Vp(t,"epsg");return i&&am.indexOf(i)>-1}}(t))return im["EPSG:3857"];var i=function(e){var t=Vp(e,"extension");if(t)return Vp(t,"proj4")}(t);return i?Wp(i):t}return function(e){return"+"===e[0]}(e)?Wp(e):void 0}function sm(e,t){var i,n;if(e=e||{},!t)return e;for(n in t)void 0!==(i=t[n])&&(e[n]=i);return e}function om(e,t,i){var n=e*t;return i/Math.sqrt(1-n*n)}function lm(e){return e<0?-1:1}function cm(e){return Math.abs(e)<=Fp?e:e-lm(e)*Up}function hm(e,t,i){var n=e*i,a=.5*e;return n=Math.pow((1-n)/(1+n),a),Math.tan(.5*(Lp-t))/n}function um(e,t){for(var i,n,a=.5*e,r=Lp-2*Math.atan(t),s=0;s<=15;s++)if(i=e*Math.sin(r),r+=n=Lp-2*Math.atan(t*Math.pow((1-i)/(1+i),a))-r,Math.abs(n)<=1e-10)return r;return-9999}function dm(e){return e}var pm=[{init:function(){var e=this.b/this.a;this.es=1-e*e,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=om(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(e){var t,i,n=e.x,a=e.y;if(a*Bp>90&&a*Bp<-90&&n*Bp>180&&n*Bp<-180)return null;if(Math.abs(Math.abs(a)-Lp)<=kp)return null;if(this.sphere)t=this.x0+this.a*this.k0*cm(n-this.long0),i=this.y0+this.a*this.k0*Math.log(Math.tan(zp+.5*a));else{var r=Math.sin(a),s=hm(this.e,a,r);t=this.x0+this.a*this.k0*cm(n-this.long0),i=this.y0-this.a*this.k0*Math.log(s)}return e.x=t,e.y=i,e},inverse:function(e){var t,i,n=e.x-this.x0,a=e.y-this.y0;if(this.sphere)i=Lp-2*Math.atan(Math.exp(-a/(this.a*this.k0)));else{var r=Math.exp(-a/(this.a*this.k0));if(-9999===(i=um(this.e,r)))return null}return t=cm(this.long0+n/(this.a*this.k0)),e.x=t,e.y=i,e},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:dm,inverse:dm,names:["longlat","identity"]}],mm={},fm=[];function gm(e,t){var i=fm.length;return e.names?(fm[i]=e,e.names.forEach((function(e){mm[e.toLowerCase()]=i})),this):(console.log(t),!0)}var ym={start:function(){pm.forEach(gm)},add:gm,get:function(e){if(!e)return!1;var t=e.toLowerCase();return void 0!==mm[t]&&fm[mm[t]]?fm[mm[t]]:void 0}},vm={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},bm=vm.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};vm.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var _m={};_m.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},_m.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},_m.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},_m.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},_m.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},_m.potsdam={towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},_m.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},_m.hermannskogel={towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Hermannskogel"},_m.osni52={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},_m.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},_m.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},_m.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},_m.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},_m.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},_m.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},_m.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},_m.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var xm={};function wm(e){if(0===e.length)return null;var t="@"===e[0];return t&&(e=e.slice(1)),"null"===e?{name:"null",mandatory:!t,grid:null,isNull:!0}:{name:e,mandatory:!t,grid:xm[e]||null,isNull:!1}}function Sm(e){return e/3600*Math.PI/180}function Mm(e,t,i){return String.fromCharCode.apply(null,new Uint8Array(e.buffer.slice(t,i)))}function Tm(e){return e.map((function(e){return[Sm(e.longitudeShift),Sm(e.latitudeShift)]}))}function Am(e,t,i){return{name:Mm(e,t+8,t+16).trim(),parent:Mm(e,t+24,t+24+8).trim(),lowerLatitude:e.getFloat64(t+72,i),upperLatitude:e.getFloat64(t+88,i),lowerLongitude:e.getFloat64(t+104,i),upperLongitude:e.getFloat64(t+120,i),latitudeInterval:e.getFloat64(t+136,i),longitudeInterval:e.getFloat64(t+152,i),gridNodeCount:e.getInt32(t+168,i)}}function Em(e,t,i,n){for(var a=t+176,r=[],s=0;s<i.gridNodeCount;s++){var o={latitudeShift:e.getFloat32(a+16*s,n),longitudeShift:e.getFloat32(a+16*s+4,n),latitudeAccuracy:e.getFloat32(a+16*s+8,n),longitudeAccuracy:e.getFloat32(a+16*s+12,n)};r.push(o)}return r}function Cm(e,t){if(!(this instanceof Cm))return new Cm(e);t=t||function(e){if(e)throw e};var i=rm(e);if("object"==typeof i){var n=Cm.projections.get(i.projName);if(n){if(i.datumCode&&"none"!==i.datumCode){var a=Vp(_m,i.datumCode);a&&(i.datum_params=i.datum_params||(a.towgs84?a.towgs84.split(","):null),i.ellps=a.ellipse,i.datumName=a.datumName?a.datumName:i.datumCode)}i.k0=i.k0||1,i.axis=i.axis||"enu",i.ellps=i.ellps||"wgs84",i.lat1=i.lat1||i.lat0;var r=function(e,t,i,n,a){if(!e){var r=Vp(vm,n);r||(r=bm),e=r.a,t=r.b,i=r.rf}return i&&!t&&(t=(1-1/i)*e),(0===i||Math.abs(e-t)<kp)&&(a=!0,t=e),{a:e,b:t,rf:i,sphere:a}}(i.a,i.b,i.rf,i.ellps,i.sphere),s=function(e,t,i,n){var a=e*e,r=t*t,s=(a-r)/a,o=0;return n?(a=(e*=1-s*(.16666666666666666+s*(.04722222222222222+.022156084656084655*s)))*e,s=0):o=Math.sqrt(s),{es:s,e:o,ep2:(a-r)/r}}(r.a,r.b,r.rf,i.R_A),o=function(e){return void 0===e?null:e.split(",").map(wm)}(i.nadgrids),l=i.datum||function(e,t,i,n,a,r,s){var o={};return o.datum_type=void 0===e||"none"===e?5:4,t&&(o.datum_params=t.map(parseFloat),0===o.datum_params[0]&&0===o.datum_params[1]&&0===o.datum_params[2]||(o.datum_type=1),o.datum_params.length>3&&(0===o.datum_params[3]&&0===o.datum_params[4]&&0===o.datum_params[5]&&0===o.datum_params[6]||(o.datum_type=2,o.datum_params[3]*=Dp,o.datum_params[4]*=Dp,o.datum_params[5]*=Dp,o.datum_params[6]=o.datum_params[6]/1e6+1))),s&&(o.datum_type=3,o.grids=s),o.a=i,o.b=n,o.es=a,o.ep2=r,o}(i.datumCode,i.datum_params,r.a,r.b,s.es,s.ep2,o);sm(this,i),sm(this,n),this.a=r.a,this.b=r.b,this.rf=r.rf,this.sphere=r.sphere,this.es=s.es,this.e=s.e,this.ep2=s.ep2,this.datum=l,this.init(),t(null,this)}else t(e)}else t(e)}function Im(e,t,i){var n,a,r,s,o=e.x,l=e.y,c=e.z?e.z:0;if(l<-Lp&&l>-1.001*Lp)l=-Lp;else if(l>Lp&&l<1.001*Lp)l=Lp;else{if(l<-Lp)return{x:-1/0,y:-1/0,z:e.z};if(l>Lp)return{x:1/0,y:1/0,z:e.z}}return o>Math.PI&&(o-=2*Math.PI),a=Math.sin(l),s=Math.cos(l),r=a*a,{x:((n=i/Math.sqrt(1-t*r))+c)*s*Math.cos(o),y:(n+c)*s*Math.sin(o),z:(n*(1-t)+c)*a}}function Pm(e,t,i,n){var a,r,s,o,l,c,h,u,d,p,m,f,g,y,v,b=1e-12,_=e.x,x=e.y,w=e.z?e.z:0;if(a=Math.sqrt(_*_+x*x),r=Math.sqrt(_*_+x*x+w*w),a/i<b){if(y=0,r/i<b)return Lp,v=-n,{x:e.x,y:e.y,z:e.z}}else y=Math.atan2(x,_);s=w/r,u=(o=a/r)*(1-t)*(l=1/Math.sqrt(1-t*(2-t)*o*o)),d=s*l,g=0;do{g++,c=t*(h=i/Math.sqrt(1-t*d*d))/(h+(v=a*u+w*d-h*(1-t*d*d))),f=(m=s*(l=1/Math.sqrt(1-c*(2-c)*o*o)))*u-(p=o*(1-c)*l)*d,u=p,d=m}while(f*f>1e-24&&g<30);return{x:y,y:Math.atan(m/Math.abs(p)),z:v}}function Rm(e){return 1===e||2===e}function Om(e,t,i){if(function(e,t){return e.datum_type===t.datum_type&&!(e.a!==t.a||Math.abs(e.es-t.es)>5e-11)&&(1===e.datum_type?e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]:2!==e.datum_type||e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]&&e.datum_params[3]===t.datum_params[3]&&e.datum_params[4]===t.datum_params[4]&&e.datum_params[5]===t.datum_params[5]&&e.datum_params[6]===t.datum_params[6])}(e,t))return i;if(5===e.datum_type||5===t.datum_type)return i;var n=e.a,a=e.es;if(3===e.datum_type){if(0!==Dm(e,!1,i))return;n=Rp,a=Op}var r=t.a,s=t.b,o=t.es;if(3===t.datum_type&&(r=Rp,s=6356752.314,o=Op),a===o&&n===r&&!Rm(e.datum_type)&&!Rm(t.datum_type))return i;if((i=Im(i,a,n),Rm(e.datum_type)&&(i=function(e,t,i){if(1===t)return{x:e.x+i[0],y:e.y+i[1],z:e.z+i[2]};if(2===t){var n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=i[5],c=i[6];return{x:c*(e.x-l*e.y+o*e.z)+n,y:c*(l*e.x+e.y-s*e.z)+a,z:c*(-o*e.x+s*e.y+e.z)+r}}}(i,e.datum_type,e.datum_params)),Rm(t.datum_type)&&(i=function(e,t,i){if(1===t)return{x:e.x-i[0],y:e.y-i[1],z:e.z-i[2]};if(2===t){var n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=i[5],c=i[6],h=(e.x-n)/c,u=(e.y-a)/c,d=(e.z-r)/c;return{x:h+l*u-o*d,y:-l*h+u+s*d,z:o*h-s*u+d}}}(i,t.datum_type,t.datum_params)),i=Pm(i,o,r,s),3===t.datum_type)&&0!==Dm(t,!0,i))return;return i}function Dm(e,t,i){if(null===e.grids||0===e.grids.length)return console.log("Grid shift grids not found"),-1;for(var n={x:-i.x,y:i.y},a={x:Number.NaN,y:Number.NaN},r=[],s=0;s<e.grids.length;s++){var o=e.grids[s];if(r.push(o.name),o.isNull){a=n;break}if(null!==o.grid){var l=o.grid.subgrids[0],c=(Math.abs(l.del[1])+Math.abs(l.del[0]))/1e4,h=l.ll[0]-c,u=l.ll[1]-c,d=l.ll[0]+(l.lim[0]-1)*l.del[0]+c,p=l.ll[1]+(l.lim[1]-1)*l.del[1]+c;if(!(u>n.y||h>n.x||p<n.y||d<n.x||(a=Lm(n,t,l),isNaN(a.x))))break}else if(o.mandatory)return console.log("Unable to find mandatory grid '"+o.name+"'"),-1}return isNaN(a.x)?(console.log("Failed to find a grid shift table for location '"+-n.x*Bp+" "+n.y*Bp+" tried: '"+r+"'"),-1):(i.x=-a.x,i.y=a.y,0)}function Lm(e,t,i){var n={x:Number.NaN,y:Number.NaN};if(isNaN(e.x))return n;var a={x:e.x,y:e.y};a.x-=i.ll[0],a.y-=i.ll[1],a.x=cm(a.x-Math.PI)+Math.PI;var r=km(a,i);if(t){if(isNaN(r.x))return n;r.x=a.x-r.x,r.y=a.y-r.y;var s,o,l=9;do{if(o=km(r,i),isNaN(o.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}s={x:a.x-(o.x+r.x),y:a.y-(o.y+r.y)},r.x+=s.x,r.y+=s.y}while(l--&&Math.abs(s.x)>1e-12&&Math.abs(s.y)>1e-12);if(l<0)return console.log("Inverse grid shift iterator failed to converge."),n;n.x=cm(r.x+i.ll[0]),n.y=r.y+i.ll[1]}else isNaN(r.x)||(n.x=e.x+r.x,n.y=e.y+r.y);return n}function km(e,t){var i,n={x:e.x/t.del[0],y:e.y/t.del[1]},a=Math.floor(n.x),r=Math.floor(n.y),s=n.x-1*a,o=n.y-1*r,l={x:Number.NaN,y:Number.NaN};if(a<0||a>=t.lim[0])return l;if(r<0||r>=t.lim[1])return l;i=r*t.lim[0]+a;var c=t.cvs[i][0],h=t.cvs[i][1];i++;var u=t.cvs[i][0],d=t.cvs[i][1];i+=t.lim[0];var p=t.cvs[i][0],m=t.cvs[i][1];i--;var f=t.cvs[i][0],g=t.cvs[i][1],y=s*o,v=s*(1-o),b=(1-s)*(1-o),_=(1-s)*o;return l.x=b*c+v*u+_*f+y*p,l.y=b*h+v*d+_*g+y*m,l}function Nm(e,t,i){var n,a,r,s=i.x,o=i.y,l=i.z||0,c={};for(r=0;r<3;r++)if(!t||2!==r||void 0!==i.z)switch(0===r?(n=s,a=-1!=="ew".indexOf(e.axis[r])?"x":"y"):1===r?(n=o,a=-1!=="ns".indexOf(e.axis[r])?"y":"x"):(n=l,a="z"),e.axis[r]){case"e":c[a]=n;break;case"w":c[a]=-n;break;case"n":c[a]=n;break;case"s":c[a]=-n;break;case"u":void 0!==i[a]&&(c.z=n);break;case"d":void 0!==i[a]&&(c.z=-n);break;default:return null}return c}function Bm(e){var t={x:e[0],y:e[1]};return e.length>2&&(t.z=e[2]),e.length>3&&(t.m=e[3]),t}function zm(e){if("function"==typeof Number.isFinite){if(Number.isFinite(e))return;throw new TypeError("coordinates must be finite numbers")}if("number"!=typeof e||e!=e||!isFinite(e))throw new TypeError("coordinates must be finite numbers")}function Um(e,t,i,n){var a;if(Array.isArray(i)&&(i=Bm(i)),function(e){zm(e.x),zm(e.y)}(i),e.datum&&t.datum&&function(e,t){return(1===e.datum.datum_type||2===e.datum.datum_type)&&"WGS84"!==t.datumCode||(1===t.datum.datum_type||2===t.datum.datum_type)&&"WGS84"!==e.datumCode}(e,t)&&(i=Um(e,a=new Cm("WGS84"),i,n),e=a),n&&"enu"!==e.axis&&(i=Nm(e,!1,i)),"longlat"===e.projName)i={x:i.x*Np,y:i.y*Np,z:i.z||0};else if(e.to_meter&&(i={x:i.x*e.to_meter,y:i.y*e.to_meter,z:i.z||0}),!(i=e.inverse(i)))return;if(e.from_greenwich&&(i.x+=e.from_greenwich),i=Om(e.datum,t.datum,i))return t.from_greenwich&&(i={x:i.x-t.from_greenwich,y:i.y,z:i.z||0}),"longlat"===t.projName?i={x:i.x*Bp,y:i.y*Bp,z:i.z||0}:(i=t.forward(i),t.to_meter&&(i={x:i.x/t.to_meter,y:i.y/t.to_meter,z:i.z||0})),n&&"enu"!==t.axis?Nm(t,!0,i):i}Cm.projections=ym,Cm.projections.start();var Fm=Cm("WGS84");function jm(e,t,i,n){var a,r,s;return Array.isArray(i)?(a=Um(e,t,i,n)||{x:NaN,y:NaN},i.length>2?void 0!==e.name&&"geocent"===e.name||void 0!==t.name&&"geocent"===t.name?"number"==typeof a.z?[a.x,a.y,a.z].concat(i.splice(3)):[a.x,a.y,i[2]].concat(i.splice(3)):[a.x,a.y].concat(i.splice(2)):[a.x,a.y]):(r=Um(e,t,i,n),2===(s=Object.keys(i)).length||s.forEach((function(n){if(void 0!==e.name&&"geocent"===e.name||void 0!==t.name&&"geocent"===t.name){if("x"===n||"y"===n||"z"===n)return}else if("x"===n||"y"===n)return;r[n]=i[n]})),r)}function Hm(e){return e instanceof Cm?e:e.oProj?e.oProj:Cm(e)}function Gm(e,t,i){e=Hm(e);var n,a=!1;return void 0===t?(t=e,e=Fm,a=!0):(void 0!==t.x||Array.isArray(t))&&(i=t,t=e,e=Fm,a=!0),t=Hm(t),i?jm(e,t,i):(n={forward:function(i,n){return jm(e,t,i,n)},inverse:function(i,n){return jm(t,e,i,n)}},a&&(n.oProj=t),n)}var Vm="AJSAJS",Wm="AFAFAF",Ym=65,Xm=73,Zm=79,qm=86,Jm=90,Qm={forward:Km,inverse:function(e){var t=nf(sf(e.toUpperCase()));if(t.lat&&t.lon)return[t.lon,t.lat,t.lon,t.lat];return[t.left,t.bottom,t.right,t.top]},toPoint:$m};function Km(e,t){return t=t||5,function(e,t){var i="00000"+e.easting,n="00000"+e.northing;return e.zoneNumber+e.zoneLetter+(p=e.easting,m=e.northing,f=e.zoneNumber,g=rf(f),y=Math.floor(p/1e5),v=Math.floor(m/1e5)%20,a=y,r=v,s=g,o=s-1,l=Vm.charCodeAt(o),c=Wm.charCodeAt(o),h=l+a-1,u=c+r,d=!1,h>Jm&&(h=h-Jm+Ym-1,d=!0),(h===Xm||l<Xm&&h>Xm||(h>Xm||l<Xm)&&d)&&h++,(h===Zm||l<Zm&&h>Zm||(h>Zm||l<Zm)&&d)&&++h===Xm&&h++,h>Jm&&(h=h-Jm+Ym-1),u>qm?(u=u-qm+Ym-1,d=!0):d=!1,(u===Xm||c<Xm&&u>Xm||(u>Xm||c<Xm)&&d)&&u++,(u===Zm||c<Zm&&u>Zm||(u>Zm||c<Zm)&&d)&&++u===Xm&&u++,u>qm&&(u=u-qm+Ym-1),String.fromCharCode(h)+String.fromCharCode(u))+i.substr(i.length-5,t)+n.substr(n.length-5,t);var a,r,s,o,l,c,h,u,d;var p,m,f,g,y,v}(function(e){var t,i,n,a,r,s,o,l,c=e.lat,h=e.lon,u=6378137,d=.00669438,p=.9996,m=ef(c),f=ef(h);l=Math.floor((h+180)/6)+1,180===h&&(l=60);c>=56&&c<64&&h>=3&&h<12&&(l=32);c>=72&&c<84&&(h>=0&&h<9?l=31:h>=9&&h<21?l=33:h>=21&&h<33?l=35:h>=33&&h<42&&(l=37));o=ef(6*(l-1)-180+3),t=d/(1-d),i=u/Math.sqrt(1-d*Math.sin(m)*Math.sin(m)),n=Math.tan(m)*Math.tan(m),a=t*Math.cos(m)*Math.cos(m),r=Math.cos(m)*(f-o),s=u*((1-d/4-3*d*d/64-5*d*d*d/256)*m-(3*d/8+3*d*d/32+45*d*d*d/1024)*Math.sin(2*m)+(15*d*d/256+45*d*d*d/1024)*Math.sin(4*m)-35*d*d*d/3072*Math.sin(6*m));var g=p*i*(r+(1-n+a)*r*r*r/6+(5-18*n+n*n+72*a-58*t)*r*r*r*r*r/120)+5e5,y=p*(s+i*Math.tan(m)*(r*r/2+(5-n+9*a+4*a*a)*r*r*r*r/24+(61-58*n+n*n+600*a-330*t)*r*r*r*r*r*r/720));c<0&&(y+=1e7);return{northing:Math.round(y),easting:Math.round(g),zoneNumber:l,zoneLetter:af(c)}}({lat:e[1],lon:e[0]}),t)}function $m(e){var t=nf(sf(e.toUpperCase()));return t.lat&&t.lon?[t.lon,t.lat]:[(t.left+t.right)/2,(t.top+t.bottom)/2]}function ef(e){return e*(Math.PI/180)}function tf(e){return e/Math.PI*180}function nf(e){var t=e.northing,i=e.easting,n=e.zoneLetter,a=e.zoneNumber;if(a<0||a>60)return null;var r,s,o,l,c,h,u,d,p,m=.9996,f=6378137,g=.00669438,y=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),v=i-5e5,b=t;n<"N"&&(b-=1e7),u=6*(a-1)-180+3,r=.006739496752268451,p=(d=b/m/6367449.145945056)+(3*y/2-27*y*y*y/32)*Math.sin(2*d)+(21*y*y/16-55*y*y*y*y/32)*Math.sin(4*d)+151*y*y*y/96*Math.sin(6*d),s=f/Math.sqrt(1-g*Math.sin(p)*Math.sin(p)),o=Math.tan(p)*Math.tan(p),l=r*Math.cos(p)*Math.cos(p),c=.99330562*f/Math.pow(1-g*Math.sin(p)*Math.sin(p),1.5),h=v/(s*m);var _=p-s*Math.tan(p)/c*(h*h/2-(5+3*o+10*l-4*l*l-9*r)*h*h*h*h/24+(61+90*o+298*l+45*o*o-1.6983531815716497-3*l*l)*h*h*h*h*h*h/720);_=tf(_);var x,w=(h-(1+2*o+l)*h*h*h/6+(5-2*l+28*o-3*l*l+8*r+24*o*o)*h*h*h*h*h/120)/Math.cos(p);if(w=u+tf(w),e.accuracy){var S=nf({northing:e.northing+e.accuracy,easting:e.easting+e.accuracy,zoneLetter:e.zoneLetter,zoneNumber:e.zoneNumber});x={top:S.lat,right:S.lon,bottom:_,left:w}}else x={lat:_,lon:w};return x}function af(e){var t="Z";return 84>=e&&e>=72?t="X":72>e&&e>=64?t="W":64>e&&e>=56?t="V":56>e&&e>=48?t="U":48>e&&e>=40?t="T":40>e&&e>=32?t="S":32>e&&e>=24?t="R":24>e&&e>=16?t="Q":16>e&&e>=8?t="P":8>e&&e>=0?t="N":0>e&&e>=-8?t="M":-8>e&&e>=-16?t="L":-16>e&&e>=-24?t="K":-24>e&&e>=-32?t="J":-32>e&&e>=-40?t="H":-40>e&&e>=-48?t="G":-48>e&&e>=-56?t="F":-56>e&&e>=-64?t="E":-64>e&&e>=-72?t="D":-72>e&&e>=-80&&(t="C"),t}function rf(e){var t=e%6;return 0===t&&(t=6),t}function sf(e){if(e&&0===e.length)throw"MGRSPoint coverting from nothing";for(var t,i=e.length,n=null,a="",r=0;!/[A-Z]/.test(t=e.charAt(r));){if(r>=2)throw"MGRSPoint bad conversion from: "+e;a+=t,r++}var s=parseInt(a,10);if(0===r||r+3>i)throw"MGRSPoint bad conversion from: "+e;var o=e.charAt(r++);if(o<="A"||"B"===o||"Y"===o||o>="Z"||"I"===o||"O"===o)throw"MGRSPoint zone letter "+o+" not handled: "+e;n=e.substring(r,r+=2);for(var l=rf(s),c=function(e,t){var i=Vm.charCodeAt(t-1),n=1e5,a=!1;for(;i!==e.charCodeAt(0);){if(++i===Xm&&i++,i===Zm&&i++,i>Jm){if(a)throw"Bad character: "+e;i=Ym,a=!0}n+=1e5}return n}(n.charAt(0),l),h=function(e,t){if(e>"V")throw"MGRSPoint given invalid Northing "+e;var i=Wm.charCodeAt(t-1),n=0,a=!1;for(;i!==e.charCodeAt(0);){if(++i===Xm&&i++,i===Zm&&i++,i>qm){if(a)throw"Bad character: "+e;i=Ym,a=!0}n+=1e5}return n}(n.charAt(1),l);h<of(o);)h+=2e6;var u=i-r;if(u%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+e;var d,p,m,f=u/2,g=0,y=0;return f>0&&(d=1e5/Math.pow(10,f),p=e.substring(r,r+f),g=parseFloat(p)*d,m=e.substring(r+f),y=parseFloat(m)*d),{easting:g+c,northing:y+h,zoneLetter:o,zoneNumber:s,accuracy:d}}function of(e){var t;switch(e){case"C":t=11e5;break;case"D":t=2e6;break;case"E":t=28e5;break;case"F":t=37e5;break;case"G":t=46e5;break;case"H":t=55e5;break;case"J":t=64e5;break;case"K":t=73e5;break;case"L":t=82e5;break;case"M":t=91e5;break;case"N":t=0;break;case"P":t=8e5;break;case"Q":t=17e5;break;case"R":t=26e5;break;case"S":t=35e5;break;case"T":t=44e5;break;case"U":t=53e5;break;case"V":t=62e5;break;case"W":t=7e6;break;case"X":t=79e5;break;default:t=-1}if(t>=0)return t;throw"Invalid zone letter: "+e}function lf(e,t,i){if(!(this instanceof lf))return new lf(e,t,i);if(Array.isArray(e))this.x=e[0],this.y=e[1],this.z=e[2]||0;else if("object"==typeof e)this.x=e.x,this.y=e.y,this.z=e.z||0;else if("string"==typeof e&&void 0===t){var n=e.split(",");this.x=parseFloat(n[0],10),this.y=parseFloat(n[1],10),this.z=parseFloat(n[2],10)||0}else this.x=e,this.y=t,this.z=i||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}lf.fromMGRS=function(e){return new lf($m(e))},lf.prototype.toMGRS=function(e){return Km([this.x,this.y],e)};var cf=.046875,hf=.01953125,uf=.01068115234375;function df(e){var t=[];t[0]=1-e*(.25+e*(cf+e*(hf+e*uf))),t[1]=e*(.75-e*(cf+e*(hf+e*uf)));var i=e*e;return t[2]=i*(.46875-e*(.013020833333333334+.007120768229166667*e)),i*=e,t[3]=i*(.3645833333333333-.005696614583333333*e),t[4]=i*e*.3076171875,t}function pf(e,t,i,n){return i*=t,t*=t,n[0]*e-i*(n[1]+t*(n[2]+t*(n[3]+t*n[4])))}function mf(e,t,i){for(var n=1/(1-t),a=e,r=20;r;--r){var s=Math.sin(a),o=1-t*s*s;if(a-=o=(pf(a,s,Math.cos(a),i)-e)*(o*Math.sqrt(o))*n,Math.abs(o)<kp)return a}return a}var ff={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=df(this.es),this.ml0=pf(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(e){var t,i,n,a=e.x,r=e.y,s=cm(a-this.long0),o=Math.sin(r),l=Math.cos(r);if(this.es){var c=l*s,h=Math.pow(c,2),u=this.ep2*Math.pow(l,2),d=Math.pow(u,2),p=Math.abs(l)>kp?Math.tan(r):0,m=Math.pow(p,2),f=Math.pow(m,2);t=1-this.es*Math.pow(o,2),c/=Math.sqrt(t);var g=pf(r,o,l,this.en);i=this.a*(this.k0*c*(1+h/6*(1-m+u+h/20*(5-18*m+f+14*u-58*m*u+h/42*(61+179*f-f*m-479*m)))))+this.x0,n=this.a*(this.k0*(g-this.ml0+o*s*c/2*(1+h/12*(5-m+9*u+4*d+h/30*(61+f-58*m+270*u-330*m*u+h/56*(1385+543*f-f*m-3111*m))))))+this.y0}else{var y=l*Math.sin(s);if(Math.abs(Math.abs(y)-1)<kp)return 93;if(i=.5*this.a*this.k0*Math.log((1+y)/(1-y))+this.x0,n=l*Math.cos(s)/Math.sqrt(1-Math.pow(y,2)),(y=Math.abs(n))>=1){if(y-1>kp)return 93;n=0}else n=Math.acos(n);r<0&&(n=-n),n=this.a*this.k0*(n-this.lat0)+this.y0}return e.x=i,e.y=n,e},inverse:function(e){var t,i,n,a,r=(e.x-this.x0)*(1/this.a),s=(e.y-this.y0)*(1/this.a);if(this.es)if(i=mf(t=this.ml0+s/this.k0,this.es,this.en),Math.abs(i)<Lp){var o=Math.sin(i),l=Math.cos(i),c=Math.abs(l)>kp?Math.tan(i):0,h=this.ep2*Math.pow(l,2),u=Math.pow(h,2),d=Math.pow(c,2),p=Math.pow(d,2);t=1-this.es*Math.pow(o,2);var m=r*Math.sqrt(t)/this.k0,f=Math.pow(m,2);n=i-(t*=c)*f/(1-this.es)*.5*(1-f/12*(5+3*d-9*h*d+h-4*u-f/30*(61+90*d-252*h*d+45*p+46*h-f/56*(1385+3633*d+4095*p+1574*p*d)))),a=cm(this.long0+m*(1-f/6*(1+2*d+h-f/20*(5+28*d+24*p+8*h*d+6*h-f/42*(61+662*d+1320*p+720*p*d))))/l)}else n=Lp*lm(s),a=0;else{var g=Math.exp(r/this.k0),y=.5*(g-1/g),v=this.lat0+s/this.k0,b=Math.cos(v);t=Math.sqrt((1-Math.pow(b,2))/(1+Math.pow(y,2))),n=Math.asin(t),s<0&&(n=-n),a=0===y&&0===b?0:cm(Math.atan2(y,b)+this.long0)}return e.x=a,e.y=n,e},names:["Fast_Transverse_Mercator","Fast Transverse Mercator"]};function gf(e){var t=Math.exp(e);return t=(t-1/t)/2}function yf(e,t){e=Math.abs(e),t=Math.abs(t);var i=Math.max(e,t),n=Math.min(e,t)/(i||1);return i*Math.sqrt(1+Math.pow(n,2))}function vf(e){var t=Math.abs(e);return t=function(e){var t=1+e,i=t-1;return 0===i?e:e*Math.log(t)/i}(t*(1+t/(yf(1,t)+1))),e<0?-t:t}function bf(e,t){for(var i,n=2*Math.cos(2*t),a=e.length-1,r=e[a],s=0;--a>=0;)i=n*r-s+e[a],s=r,r=i;return t+i*Math.sin(2*t)}function _f(e,t,i){for(var n,a,r=Math.sin(t),s=Math.cos(t),o=gf(i),l=function(e){var t=Math.exp(e);return(t+1/t)/2}(i),c=2*s*l,h=-2*r*o,u=e.length-1,d=e[u],p=0,m=0,f=0;--u>=0;)n=m,a=p,d=c*(m=d)-n-h*(p=f)+e[u],f=h*m-a+c*p;return[(c=r*l)*d-(h=s*o)*f,c*f+h*d]}var xf={init:function(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(ff.init.apply(this),this.forward=ff.forward,this.inverse=ff.inverse),this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var e=this.es/(1+Math.sqrt(1-this.es)),t=e/(2-e),i=t;this.cgb[0]=t*(2+t*(-2/3+t*(t*(116/45+t*(26/45+t*(-2854/675)))-2))),this.cbg[0]=t*(t*(2/3+t*(4/3+t*(-82/45+t*(32/45+t*(4642/4725)))))-2),i*=t,this.cgb[1]=i*(7/3+t*(t*(-227/45+t*(2704/315+t*(2323/945)))-1.6)),this.cbg[1]=i*(5/3+t*(-16/15+t*(-13/9+t*(904/315+t*(-1522/945))))),i*=t,this.cgb[2]=i*(56/15+t*(-136/35+t*(-1262/105+t*(73814/2835)))),this.cbg[2]=i*(-26/15+t*(34/21+t*(1.6+t*(-12686/2835)))),i*=t,this.cgb[3]=i*(4279/630+t*(-332/35+t*(-399572/14175))),this.cbg[3]=i*(1237/630+t*(t*(-24832/14175)-2.4)),i*=t,this.cgb[4]=i*(4174/315+t*(-144838/6237)),this.cbg[4]=i*(-734/315+t*(109598/31185)),i*=t,this.cgb[5]=i*(601676/22275),this.cbg[5]=i*(444337/155925),i=Math.pow(t,2),this.Qn=this.k0/(1+t)*(1+i*(1/4+i*(1/64+i/256))),this.utg[0]=t*(t*(2/3+t*(-37/96+t*(1/360+t*(81/512+t*(-96199/604800)))))-.5),this.gtu[0]=t*(.5+t*(-2/3+t*(5/16+t*(41/180+t*(-127/288+t*(7891/37800)))))),this.utg[1]=i*(-1/48+t*(-1/15+t*(437/1440+t*(-46/105+t*(1118711/3870720))))),this.gtu[1]=i*(13/48+t*(t*(557/1440+t*(281/630+t*(-1983433/1935360)))-.6)),i*=t,this.utg[2]=i*(-17/480+t*(37/840+t*(209/4480+t*(-5569/90720)))),this.gtu[2]=i*(61/240+t*(-103/140+t*(15061/26880+t*(167603/181440)))),i*=t,this.utg[3]=i*(-4397/161280+t*(11/504+t*(830251/7257600))),this.gtu[3]=i*(49561/161280+t*(-179/168+t*(6601661/7257600))),i*=t,this.utg[4]=i*(-4583/161280+t*(108847/3991680)),this.gtu[4]=i*(34729/80640+t*(-3418889/1995840)),i*=t,this.utg[5]=i*(-20648693/638668800),this.gtu[5]=.6650675310896665*i;var n=bf(this.cbg,this.lat0);this.Zb=-this.Qn*(n+function(e,t){for(var i,n=2*Math.cos(t),a=e.length-1,r=e[a],s=0;--a>=0;)i=n*r-s+e[a],s=r,r=i;return Math.sin(t)*i}(this.gtu,2*n))},forward:function(e){var t=cm(e.x-this.long0),i=e.y;i=bf(this.cbg,i);var n=Math.sin(i),a=Math.cos(i),r=Math.sin(t),s=Math.cos(t);i=Math.atan2(n,s*a),t=Math.atan2(r*a,yf(n,a*s)),t=vf(Math.tan(t));var o,l,c=_f(this.gtu,2*i,2*t);return i+=c[0],t+=c[1],Math.abs(t)<=2.623395162778?(o=this.a*(this.Qn*t)+this.x0,l=this.a*(this.Qn*i+this.Zb)+this.y0):(o=1/0,l=1/0),e.x=o,e.y=l,e},inverse:function(e){var t,i,n=(e.x-this.x0)*(1/this.a),a=(e.y-this.y0)*(1/this.a);if(a=(a-this.Zb)/this.Qn,n/=this.Qn,Math.abs(n)<=2.623395162778){var r=_f(this.utg,2*a,2*n);a+=r[0],n+=r[1],n=Math.atan(gf(n));var s=Math.sin(a),o=Math.cos(a),l=Math.sin(n),c=Math.cos(n);a=Math.atan2(s*c,yf(l,c*o)),t=cm((n=Math.atan2(l,c*o))+this.long0),i=bf(this.cgb,a)}else t=1/0,i=1/0;return e.x=t,e.y=i,e},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","tmerc"]};var wf={init:function(){var e=function(e,t){if(void 0===e){if((e=Math.floor(30*(cm(t)+Math.PI)/Math.PI)+1)<0)return 0;if(e>60)return 60}return e}(this.zone,this.long0);if(void 0===e)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(e)-183)*Np,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,xf.init.apply(this),this.forward=xf.forward,this.inverse=xf.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"};function Sf(e,t){return Math.pow((1-e)/(1+e),t)}var Mf={init:function(){var e=Math.sin(this.lat0),t=Math.cos(this.lat0);t*=t,this.rc=Math.sqrt(1-this.es)/(1-this.es*e*e),this.C=Math.sqrt(1+this.es*t*t/(1-this.es)),this.phic0=Math.asin(e/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+zp)/(Math.pow(Math.tan(.5*this.lat0+zp),this.C)*Sf(this.e*e,this.ratexp))},forward:function(e){var t=e.x,i=e.y;return e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+zp),this.C)*Sf(this.e*Math.sin(i),this.ratexp))-Lp,e.x=this.C*t,e},inverse:function(e){for(var t=e.x/this.C,i=e.y,n=Math.pow(Math.tan(.5*i+zp)/this.K,1/this.C),a=20;a>0&&(i=2*Math.atan(n*Sf(this.e*Math.sin(e.y),-.5*this.e))-Lp,!(Math.abs(i-e.y)<1e-14));--a)e.y=i;return a?(e.x=t,e.y=i,e):null},names:["gauss"]};var Tf={init:function(){Mf.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(e){var t,i,n,a;return e.x=cm(e.x-this.long0),Mf.forward.apply(this,[e]),t=Math.sin(e.y),i=Math.cos(e.y),n=Math.cos(e.x),a=this.k0*this.R2/(1+this.sinc0*t+this.cosc0*i*n),e.x=a*i*Math.sin(e.x),e.y=a*(this.cosc0*t-this.sinc0*i*n),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){var t,i,n,a,r;if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,r=Math.sqrt(e.x*e.x+e.y*e.y)){var s=2*Math.atan2(r,this.R2);t=Math.sin(s),i=Math.cos(s),a=Math.asin(i*this.sinc0+e.y*t*this.cosc0/r),n=Math.atan2(e.x*t,r*this.cosc0*i-e.y*this.sinc0*t)}else a=this.phic0,n=0;return e.x=n,e.y=a,Mf.inverse.apply(this,[e]),e.x=cm(e.x+this.long0),e},names:["Stereographic_North_Pole","Oblique_Stereographic","Polar_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"]};var Af={init:function(){this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=kp&&(this.k0=.5*(1+lm(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=kp&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=kp&&(this.k0=.5*this.cons*om(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/hm(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=om(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-Lp,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(e){var t,i,n,a,r,s,o=e.x,l=e.y,c=Math.sin(l),h=Math.cos(l),u=cm(o-this.long0);return Math.abs(Math.abs(o-this.long0)-Math.PI)<=kp&&Math.abs(l+this.lat0)<=kp?(e.x=NaN,e.y=NaN,e):this.sphere?(t=2*this.k0/(1+this.sinlat0*c+this.coslat0*h*Math.cos(u)),e.x=this.a*t*h*Math.sin(u)+this.x0,e.y=this.a*t*(this.coslat0*c-this.sinlat0*h*Math.cos(u))+this.y0,e):(i=2*Math.atan(this.ssfn_(l,c,this.e))-Lp,a=Math.cos(i),n=Math.sin(i),Math.abs(this.coslat0)<=kp?(r=hm(this.e,l*this.con,this.con*c),s=2*this.a*this.k0*r/this.cons,e.x=this.x0+s*Math.sin(o-this.long0),e.y=this.y0-this.con*s*Math.cos(o-this.long0),e):(Math.abs(this.sinlat0)<kp?(t=2*this.a*this.k0/(1+a*Math.cos(u)),e.y=t*n):(t=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*n+this.cosX0*a*Math.cos(u))),e.y=t*(this.cosX0*n-this.sinX0*a*Math.cos(u))+this.y0),e.x=t*a*Math.sin(u)+this.x0,e))},inverse:function(e){var t,i,n,a,r;e.x-=this.x0,e.y-=this.y0;var s=Math.sqrt(e.x*e.x+e.y*e.y);if(this.sphere){var o=2*Math.atan(s/(2*this.a*this.k0));return t=this.long0,i=this.lat0,s<=kp?(e.x=t,e.y=i,e):(i=Math.asin(Math.cos(o)*this.sinlat0+e.y*Math.sin(o)*this.coslat0/s),t=Math.abs(this.coslat0)<kp?this.lat0>0?cm(this.long0+Math.atan2(e.x,-1*e.y)):cm(this.long0+Math.atan2(e.x,e.y)):cm(this.long0+Math.atan2(e.x*Math.sin(o),s*this.coslat0*Math.cos(o)-e.y*this.sinlat0*Math.sin(o))),e.x=t,e.y=i,e)}if(Math.abs(this.coslat0)<=kp){if(s<=kp)return i=this.lat0,t=this.long0,e.x=t,e.y=i,e;e.x*=this.con,e.y*=this.con,n=s*this.cons/(2*this.a*this.k0),i=this.con*um(this.e,n),t=this.con*cm(this.con*this.long0+Math.atan2(e.x,-1*e.y))}else a=2*Math.atan(s*this.cosX0/(2*this.a*this.k0*this.ms1)),t=this.long0,s<=kp?r=this.X0:(r=Math.asin(Math.cos(a)*this.sinX0+e.y*Math.sin(a)*this.cosX0/s),t=cm(this.long0+Math.atan2(e.x*Math.sin(a),s*this.cosX0*Math.cos(a)-e.y*this.sinX0*Math.sin(a)))),i=-1*um(this.e,Math.tan(.5*(Lp+r)));return e.x=t,e.y=i,e},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)"],ssfn_:function(e,t,i){return t*=i,Math.tan(.5*(Lp+e))*Math.pow((1-t)/(1+t),.5*i)}};var Ef={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),i=this.a,n=1/this.rf,a=2*n-Math.pow(n,2),r=this.e=Math.sqrt(a);this.R=this.k0*i*Math.sqrt(1-a)/(1-a*Math.pow(t,2)),this.alpha=Math.sqrt(1+a/(1-a)*Math.pow(Math.cos(e),4)),this.b0=Math.asin(t/this.alpha);var s=Math.log(Math.tan(Math.PI/4+this.b0/2)),o=Math.log(Math.tan(Math.PI/4+e/2)),l=Math.log((1+r*t)/(1-r*t));this.K=s-this.alpha*o+this.alpha*r/2*l},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),n=-this.alpha*(t+i)+this.K,a=2*(Math.atan(Math.exp(n))-Math.PI/4),r=this.alpha*(e.x-this.lambda0),s=Math.atan(Math.sin(r)/(Math.sin(this.b0)*Math.tan(a)+Math.cos(this.b0)*Math.cos(r))),o=Math.asin(Math.cos(this.b0)*Math.sin(a)-Math.sin(this.b0)*Math.cos(a)*Math.cos(r));return e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,e.x=this.R*s+this.x0,e},inverse:function(e){for(var t=e.x-this.x0,i=e.y-this.y0,n=t/this.R,a=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),r=Math.asin(Math.cos(this.b0)*Math.sin(a)+Math.sin(this.b0)*Math.cos(a)*Math.cos(n)),s=Math.atan(Math.sin(n)/(Math.cos(this.b0)*Math.cos(n)-Math.sin(this.b0)*Math.tan(a))),o=this.lambda0+s/this.alpha,l=0,c=r,h=-1e3,u=0;Math.abs(c-h)>1e-7;){if(++u>20)return;l=1/this.alpha*(Math.log(Math.tan(Math.PI/4+r/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(c))/2)),h=c,c=2*Math.atan(Math.exp(l))-Math.PI/2}return e.x=o,e.y=c,e},names:["somerc"]},Cf=1e-7;var If={init:function(){var e,t,i,n,a,r,s,o,l,c,h,u=0,d=0,p=0,m=0,f=0,g=0,y=0;this.no_off=function(e){var t="object"==typeof e.PROJECTION?Object.keys(e.PROJECTION)[0]:e.PROJECTION;return"no_uoff"in e||"no_off"in e||-1!==["Hotine_Oblique_Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin"].indexOf(t)}(this),this.no_rot="no_rot"in this;var v=!1;"alpha"in this&&(v=!0);var b=!1;if("rectified_grid_angle"in this&&(b=!0),v&&(y=this.alpha),b&&(u=this.rectified_grid_angle*Np),v||b)d=this.longc;else if(p=this.long1,f=this.lat1,m=this.long2,g=this.lat2,Math.abs(f-g)<=Cf||(e=Math.abs(f))<=Cf||Math.abs(e-Lp)<=Cf||Math.abs(Math.abs(this.lat0)-Lp)<=Cf||Math.abs(Math.abs(g)-Lp)<=Cf)throw new Error;var _=1-this.es;t=Math.sqrt(_),Math.abs(this.lat0)>kp?(o=Math.sin(this.lat0),i=Math.cos(this.lat0),e=1-this.es*o*o,this.B=i*i,this.B=Math.sqrt(1+this.es*this.B*this.B/_),this.A=this.B*this.k0*t/e,(a=(n=this.B*t/(i*Math.sqrt(e)))*n-1)<=0?a=0:(a=Math.sqrt(a),this.lat0<0&&(a=-a)),this.E=a+=n,this.E*=Math.pow(hm(this.e,this.lat0,o),this.B)):(this.B=1/t,this.A=this.k0,this.E=n=a=1),v||b?(v?(h=Math.asin(Math.sin(y)/n),b||(u=y)):(h=u,y=Math.asin(n*Math.sin(h))),this.lam0=d-Math.asin(.5*(a-1/a)*Math.tan(h))/this.B):(r=Math.pow(hm(this.e,f,Math.sin(f)),this.B),s=Math.pow(hm(this.e,g,Math.sin(g)),this.B),a=this.E/r,l=(s-r)/(s+r),c=((c=this.E*this.E)-s*r)/(c+s*r),(e=p-m)<-Math.pi?m-=Up:e>Math.pi&&(m+=Up),this.lam0=cm(.5*(p+m)-Math.atan(c*Math.tan(.5*this.B*(p-m))/l)/this.B),h=Math.atan(2*Math.sin(this.B*cm(p-this.lam0))/(a-1/a)),u=y=Math.asin(n*Math.sin(h))),this.singam=Math.sin(h),this.cosgam=Math.cos(h),this.sinrot=Math.sin(u),this.cosrot=Math.cos(u),this.rB=1/this.B,this.ArB=this.A*this.rB,this.BrA=1/this.ArB,this.A,this.B,this.no_off?this.u_0=0:(this.u_0=Math.abs(this.ArB*Math.atan(Math.sqrt(n*n-1)/Math.cos(y))),this.lat0<0&&(this.u_0=-this.u_0)),a=.5*h,this.v_pole_n=this.ArB*Math.log(Math.tan(zp-a)),this.v_pole_s=this.ArB*Math.log(Math.tan(zp+a))},forward:function(e){var t,i,n,a,r,s,o,l,c={};if(e.x=e.x-this.lam0,Math.abs(Math.abs(e.y)-Lp)>kp){if(t=.5*((r=this.E/Math.pow(hm(this.e,e.y,Math.sin(e.y)),this.B))-(s=1/r)),i=.5*(r+s),a=Math.sin(this.B*e.x),n=(t*this.singam-a*this.cosgam)/i,Math.abs(Math.abs(n)-1)<kp)throw new Error;l=.5*this.ArB*Math.log((1-n)/(1+n)),s=Math.cos(this.B*e.x),o=Math.abs(s)<Cf?this.A*e.x:this.ArB*Math.atan2(t*this.cosgam+a*this.singam,s)}else l=e.y>0?this.v_pole_n:this.v_pole_s,o=this.ArB*e.y;return this.no_rot?(c.x=o,c.y=l):(o-=this.u_0,c.x=l*this.cosrot+o*this.sinrot,c.y=o*this.cosrot-l*this.sinrot),c.x=this.a*c.x+this.x0,c.y=this.a*c.y+this.y0,c},inverse:function(e){var t,i,n,a,r,s,o,l={};if(e.x=(e.x-this.x0)*(1/this.a),e.y=(e.y-this.y0)*(1/this.a),this.no_rot?(i=e.y,t=e.x):(i=e.x*this.cosrot-e.y*this.sinrot,t=e.y*this.cosrot+e.x*this.sinrot+this.u_0),a=.5*((n=Math.exp(-this.BrA*i))-1/n),r=.5*(n+1/n),o=((s=Math.sin(this.BrA*t))*this.cosgam+a*this.singam)/r,Math.abs(Math.abs(o)-1)<kp)l.x=0,l.y=o<0?-Lp:Lp;else{if(l.y=this.E/Math.sqrt((1+o)/(1-o)),l.y=um(this.e,Math.pow(l.y,1/this.B)),l.y===1/0)throw new Error;l.x=-this.rB*Math.atan2(a*this.cosgam-s*this.singam,Math.cos(this.BrA*t))}return l.x+=this.lam0,l},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Two_Point_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","Oblique_Mercator","omerc"]};var Pf={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<kp)){var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),i=Math.cos(this.lat1),n=om(this.e,t,i),a=hm(this.e,this.lat1,t),r=Math.sin(this.lat2),s=Math.cos(this.lat2),o=om(this.e,r,s),l=hm(this.e,this.lat2,r),c=hm(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>kp?this.ns=Math.log(n/o)/Math.log(a/l):this.ns=t,isNaN(this.ns)&&(this.ns=t),this.f0=n/(this.ns*Math.pow(a,this.ns)),this.rh=this.a*this.f0*Math.pow(c,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(e){var t=e.x,i=e.y;Math.abs(2*Math.abs(i)-Math.PI)<=kp&&(i=lm(i)*(Lp-2e-10));var n,a,r=Math.abs(Math.abs(i)-Lp);if(r>kp)n=hm(this.e,i,Math.sin(i)),a=this.a*this.f0*Math.pow(n,this.ns);else{if((r=i*this.ns)<=0)return null;a=0}var s=this.ns*cm(t-this.long0);return e.x=this.k0*(a*Math.sin(s))+this.x0,e.y=this.k0*(this.rh-a*Math.cos(s))+this.y0,e},inverse:function(e){var t,i,n,a,r,s=(e.x-this.x0)/this.k0,o=this.rh-(e.y-this.y0)/this.k0;this.ns>0?(t=Math.sqrt(s*s+o*o),i=1):(t=-Math.sqrt(s*s+o*o),i=-1);var l=0;if(0!==t&&(l=Math.atan2(i*s,i*o)),0!==t||this.ns>0){if(i=1/this.ns,n=Math.pow(t/(this.a*this.f0),i),-9999===(a=um(this.e,n)))return null}else a=-Lp;return r=cm(l/this.ns+this.long0),e.x=r,e.y=a,e},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_1SP","Lambert_Conformal_Conic_2SP","lcc"]};var Rf={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(e){var t,i,n,a,r,s,o,l=e.x,c=e.y,h=cm(l-this.long0);return t=Math.pow((1+this.e*Math.sin(c))/(1-this.e*Math.sin(c)),this.alfa*this.e/2),i=2*(Math.atan(this.k*Math.pow(Math.tan(c/2+this.s45),this.alfa)/t)-this.s45),n=-h*this.alfa,a=Math.asin(Math.cos(this.ad)*Math.sin(i)+Math.sin(this.ad)*Math.cos(i)*Math.cos(n)),r=Math.asin(Math.cos(i)*Math.sin(n)/Math.cos(a)),s=this.n*r,o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(a/2+this.s45),this.n),e.y=o*Math.cos(s)/1,e.x=o*Math.sin(s)/1,this.czech||(e.y*=-1,e.x*=-1),e},inverse:function(e){var t,i,n,a,r,s,o,l=e.x;e.x=e.y,e.y=l,this.czech||(e.y*=-1,e.x*=-1),r=Math.sqrt(e.x*e.x+e.y*e.y),a=Math.atan2(e.y,e.x)/Math.sin(this.s0),n=2*(Math.atan(Math.pow(this.ro0/r,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),t=Math.asin(Math.cos(this.ad)*Math.sin(n)-Math.sin(this.ad)*Math.cos(n)*Math.cos(a)),i=Math.asin(Math.cos(n)*Math.sin(a)/Math.cos(t)),e.x=this.long0-i/this.alfa,s=t,o=0;var c=0;do{e.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(t/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(s))/(1-this.e*Math.sin(s)),this.e/2))-this.s45),Math.abs(s-e.y)<1e-10&&(o=1),s=e.y,c+=1}while(0===o&&c<15);return c>=15?null:e},names:["Krovak","krovak"]};function Of(e,t,i,n,a){return e*a-t*Math.sin(2*a)+i*Math.sin(4*a)-n*Math.sin(6*a)}function Df(e){return 1-.25*e*(1+e/16*(3+1.25*e))}function Lf(e){return.375*e*(1+.25*e*(1+.46875*e))}function kf(e){return.05859375*e*e*(1+.75*e)}function Nf(e){return e*e*e*(35/3072)}function Bf(e,t,i){var n=t*i;return e/Math.sqrt(1-n*n)}function zf(e){return Math.abs(e)<Lp?e:e-lm(e)*Math.PI}function Uf(e,t,i,n,a){var r,s;r=e/t;for(var o=0;o<15;o++)if(r+=s=(e-(t*r-i*Math.sin(2*r)+n*Math.sin(4*r)-a*Math.sin(6*r)))/(t-2*i*Math.cos(2*r)+4*n*Math.cos(4*r)-6*a*Math.cos(6*r)),Math.abs(s)<=1e-10)return r;return NaN}var Ff={init:function(){this.sphere||(this.e0=Df(this.es),this.e1=Lf(this.es),this.e2=kf(this.es),this.e3=Nf(this.es),this.ml0=this.a*Of(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(e){var t,i,n=e.x,a=e.y;if(n=cm(n-this.long0),this.sphere)t=this.a*Math.asin(Math.cos(a)*Math.sin(n)),i=this.a*(Math.atan2(Math.tan(a),Math.cos(n))-this.lat0);else{var r=Math.sin(a),s=Math.cos(a),o=Bf(this.a,this.e,r),l=Math.tan(a)*Math.tan(a),c=n*Math.cos(a),h=c*c,u=this.es*s*s/(1-this.es);t=o*c*(1-h*l*(1/6-(8-l+8*u)*h/120)),i=this.a*Of(this.e0,this.e1,this.e2,this.e3,a)-this.ml0+o*r/s*h*(.5+(5-l+6*u)*h/24)}return e.x=t+this.x0,e.y=i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,i,n=e.x/this.a,a=e.y/this.a;if(this.sphere){var r=a+this.lat0;t=Math.asin(Math.sin(r)*Math.cos(n)),i=Math.atan2(Math.tan(n),Math.cos(r))}else{var s=Uf(this.ml0/this.a+a,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(s)-Lp)<=kp)return e.x=this.long0,e.y=Lp,a<0&&(e.y*=-1),e;var o=Bf(this.a,this.e,Math.sin(s)),l=o*o*o/this.a/this.a*(1-this.es),c=Math.pow(Math.tan(s),2),h=n*this.a/o,u=h*h;t=s-o*Math.tan(s)/l*h*h*(.5-(1+3*c)*h*h/24),i=h*(1-u*(c/3+(1+3*c)*c*u/15))/Math.cos(s)}return e.x=cm(i+this.long0),e.y=zf(t),e},names:["Cassini","Cassini_Soldner","cass"]};function jf(e,t){var i;return e>1e-7?(1-e*e)*(t/(1-(i=e*t)*i)-.5/e*Math.log((1-i)/(1+i))):2*t}var Hf=.3333333333333333,Gf=.17222222222222222,Vf=.10257936507936508,Wf=.06388888888888888,Yf=.0664021164021164,Xf=.016415012942191543;var Zf={init:function(){var e,t=Math.abs(this.lat0);if(Math.abs(t-Lp)<kp?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(t)<kp?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=jf(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(e){var t,i=[];return i[0]=e*Hf,t=e*e,i[0]+=t*Gf,i[1]=t*Wf,t*=e,i[0]+=t*Vf,i[1]+=t*Yf,i[2]=t*Xf,i}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),e=Math.sin(this.lat0),this.sinb1=jf(this.e,e)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*e*e)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(e){var t,i,n,a,r,s,o,l,c,h,u=e.x,d=e.y;if(u=cm(u-this.long0),this.sphere){if(r=Math.sin(d),h=Math.cos(d),n=Math.cos(u),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((i=this.mode===this.EQUIT?1+h*n:1+this.sinph0*r+this.cosph0*h*n)<=kp)return null;t=(i=Math.sqrt(2/i))*h*Math.sin(u),i*=this.mode===this.EQUIT?r:this.cosph0*r-this.sinph0*h*n}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(n=-n),Math.abs(d+this.lat0)<kp)return null;i=zp-.5*d,t=(i=2*(this.mode===this.S_POLE?Math.cos(i):Math.sin(i)))*Math.sin(u),i*=n}}else{switch(o=0,l=0,c=0,n=Math.cos(u),a=Math.sin(u),r=Math.sin(d),s=jf(this.e,r),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(o=s/this.qp,l=Math.sqrt(1-o*o)),this.mode){case this.OBLIQ:c=1+this.sinb1*o+this.cosb1*l*n;break;case this.EQUIT:c=1+l*n;break;case this.N_POLE:c=Lp+d,s=this.qp-s;break;case this.S_POLE:c=d-Lp,s=this.qp+s}if(Math.abs(c)<kp)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:c=Math.sqrt(2/c),i=this.mode===this.OBLIQ?this.ymf*c*(this.cosb1*o-this.sinb1*l*n):(c=Math.sqrt(2/(1+l*n)))*o*this.ymf,t=this.xmf*c*l*a;break;case this.N_POLE:case this.S_POLE:s>=0?(t=(c=Math.sqrt(s))*a,i=n*(this.mode===this.S_POLE?c:-c)):t=i=0}}return e.x=this.a*t+this.x0,e.y=this.a*i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,i,n,a,r,s,o,l,c,h,u=e.x/this.a,d=e.y/this.a;if(this.sphere){var p,m=0,f=0;if((i=.5*(p=Math.sqrt(u*u+d*d)))>1)return null;switch(i=2*Math.asin(i),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(f=Math.sin(i),m=Math.cos(i)),this.mode){case this.EQUIT:i=Math.abs(p)<=kp?0:Math.asin(d*f/p),u*=f,d=m*p;break;case this.OBLIQ:i=Math.abs(p)<=kp?this.lat0:Math.asin(m*this.sinph0+d*f*this.cosph0/p),u*=f*this.cosph0,d=(m-Math.sin(i)*this.sinph0)*p;break;case this.N_POLE:d=-d,i=Lp-i;break;case this.S_POLE:i-=Lp}t=0!==d||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(u,d):0}else{if(o=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(u/=this.dd,d*=this.dd,(s=Math.sqrt(u*u+d*d))<kp)return e.x=this.long0,e.y=this.lat0,e;a=2*Math.asin(.5*s/this.rq),n=Math.cos(a),u*=a=Math.sin(a),this.mode===this.OBLIQ?(o=n*this.sinb1+d*a*this.cosb1/s,r=this.qp*o,d=s*this.cosb1*n-d*this.sinb1*a):(o=d*a/s,r=this.qp*o,d=s*n)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(d=-d),!(r=u*u+d*d))return e.x=this.long0,e.y=this.lat0,e;o=1-r/this.qp,this.mode===this.S_POLE&&(o=-o)}t=Math.atan2(u,d),l=Math.asin(o),c=this.apa,h=l+l,i=l+c[0]*Math.sin(h)+c[1]*Math.sin(h+h)+c[2]*Math.sin(h+h+h)}return e.x=cm(this.long0+t),e.y=i,e},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4};function qf(e){return Math.abs(e)>1&&(e=e>1?1:-1),Math.asin(e)}var Jf={init:function(){Math.abs(this.lat1+this.lat2)<kp||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=om(this.e3,this.sin_po,this.cos_po),this.qs1=jf(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=om(this.e3,this.sin_po,this.cos_po),this.qs2=jf(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=jf(this.e3,this.sin_po,this.cos_po),Math.abs(this.lat1-this.lat2)>kp?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(e){var t=e.x,i=e.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var n=jf(this.e3,this.sin_phi,this.cos_phi),a=this.a*Math.sqrt(this.c-this.ns0*n)/this.ns0,r=this.ns0*cm(t-this.long0),s=a*Math.sin(r)+this.x0,o=this.rh-a*Math.cos(r)+this.y0;return e.x=s,e.y=o,e},inverse:function(e){var t,i,n,a,r,s;return e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns0>=0?(t=Math.sqrt(e.x*e.x+e.y*e.y),n=1):(t=-Math.sqrt(e.x*e.x+e.y*e.y),n=-1),a=0,0!==t&&(a=Math.atan2(n*e.x,n*e.y)),n=t*this.ns0/this.a,this.sphere?s=Math.asin((this.c-n*n)/(2*this.ns0)):(i=(this.c-n*n)/this.ns0,s=this.phi1z(this.e3,i)),r=cm(a/this.ns0+this.long0),e.x=r,e.y=s,e},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(e,t){var i,n,a,r,s=qf(.5*t);if(e<kp)return s;for(var o=e*e,l=1;l<=25;l++)if(s+=r=.5*(a=1-(n=e*(i=Math.sin(s)))*n)*a/Math.cos(s)*(t/(1-o)-i/a+.5/e*Math.log((1-n)/(1+n))),Math.abs(r)<=1e-7)return s;return null}};var Qf={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(e){var t,i,n,a,r,s,o,l=e.x,c=e.y;return n=cm(l-this.long0),t=Math.sin(c),i=Math.cos(c),a=Math.cos(n),1,(r=this.sin_p14*t+this.cos_p14*i*a)>0||Math.abs(r)<=kp?(s=this.x0+1*this.a*i*Math.sin(n)/r,o=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*i*a)/r):(s=this.x0+this.infinity_dist*i*Math.sin(n),o=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*i*a)),e.x=s,e.y=o,e},inverse:function(e){var t,i,n,a,r,s;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(t=Math.sqrt(e.x*e.x+e.y*e.y))?(a=Math.atan2(t,this.rc),i=Math.sin(a),s=qf((n=Math.cos(a))*this.sin_p14+e.y*i*this.cos_p14/t),r=Math.atan2(e.x*i,t*this.cos_p14*n-e.y*this.sin_p14*i),r=cm(this.long0+r)):(s=this.phic0,r=0),e.x=r,e.y=s,e},names:["gnom"]};var Kf={init:function(){this.sphere||(this.k0=om(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t,i,n=e.x,a=e.y,r=cm(n-this.long0);if(this.sphere)t=this.x0+this.a*r*Math.cos(this.lat_ts),i=this.y0+this.a*Math.sin(a)/Math.cos(this.lat_ts);else{var s=jf(this.e,Math.sin(a));t=this.x0+this.a*this.k0*r,i=this.y0+this.a*s*.5/this.k0}return e.x=t,e.y=i,e},inverse:function(e){var t,i;return e.x-=this.x0,e.y-=this.y0,this.sphere?(t=cm(this.long0+e.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(e.y/this.a*Math.cos(this.lat_ts))):(i=function(e,t){var i=1-(1-e*e)/(2*e)*Math.log((1-e)/(1+e));if(Math.abs(Math.abs(t)-i)<1e-6)return t<0?-1*Lp:Lp;for(var n,a,r,s,o=Math.asin(.5*t),l=0;l<30;l++)if(a=Math.sin(o),r=Math.cos(o),s=e*a,o+=n=Math.pow(1-s*s,2)/(2*r)*(t/(1-e*e)-a/(1-s*s)+.5/e*Math.log((1-s)/(1+s))),Math.abs(n)<=1e-10)return o;return NaN}(this.e,2*e.y*this.k0/this.a),t=cm(this.long0+e.x/(this.a*this.k0))),e.x=t,e.y=i,e},names:["cea"]};var $f={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,i=e.y,n=cm(t-this.long0),a=zf(i-this.lat0);return e.x=this.x0+this.a*n*this.rc,e.y=this.y0+this.a*a,e},inverse:function(e){var t=e.x,i=e.y;return e.x=cm(this.long0+(t-this.x0)/(this.a*this.rc)),e.y=zf(this.lat0+(i-this.y0)/this.a),e},names:["Equirectangular","Equidistant_Cylindrical","eqc"]};var eg={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Df(this.es),this.e1=Lf(this.es),this.e2=kf(this.es),this.e3=Nf(this.es),this.ml0=this.a*Of(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,n,a=e.x,r=e.y,s=cm(a-this.long0);if(n=s*Math.sin(r),this.sphere)Math.abs(r)<=kp?(t=this.a*s,i=-1*this.a*this.lat0):(t=this.a*Math.sin(n)/Math.tan(r),i=this.a*(zf(r-this.lat0)+(1-Math.cos(n))/Math.tan(r)));else if(Math.abs(r)<=kp)t=this.a*s,i=-1*this.ml0;else{var o=Bf(this.a,this.e,Math.sin(r))/Math.tan(r);t=o*Math.sin(n),i=this.a*Of(this.e0,this.e1,this.e2,this.e3,r)-this.ml0+o*(1-Math.cos(n))}return e.x=t+this.x0,e.y=i+this.y0,e},inverse:function(e){var t,i,n,a,r,s,o,l,c;if(n=e.x-this.x0,a=e.y-this.y0,this.sphere)if(Math.abs(a+this.a*this.lat0)<=kp)t=cm(n/this.a+this.long0),i=0;else{var h;for(s=this.lat0+a/this.a,o=n*n/this.a/this.a+s*s,l=s,r=20;r;--r)if(l+=c=-1*(s*(l*(h=Math.tan(l))+1)-l-.5*(l*l+o)*h)/((l-s)/h-1),Math.abs(c)<=kp){i=l;break}t=cm(this.long0+Math.asin(n*Math.tan(l)/this.a)/Math.sin(i))}else if(Math.abs(a+this.ml0)<=kp)i=0,t=cm(this.long0+n/this.a);else{var u,d,p,m,f;for(s=(this.ml0+a)/this.a,o=n*n/this.a/this.a+s*s,l=s,r=20;r;--r)if(f=this.e*Math.sin(l),u=Math.sqrt(1-f*f)*Math.tan(l),d=this.a*Of(this.e0,this.e1,this.e2,this.e3,l),p=this.e0-2*this.e1*Math.cos(2*l)+4*this.e2*Math.cos(4*l)-6*this.e3*Math.cos(6*l),l-=c=(s*(u*(m=d/this.a)+1)-m-.5*u*(m*m+o))/(this.es*Math.sin(2*l)*(m*m+o-2*s*m)/(4*u)+(s-m)*(u*p-2/Math.sin(2*l))-p),Math.abs(c)<=kp){i=l;break}u=Math.sqrt(1-this.es*Math.pow(Math.sin(i),2))*Math.tan(i),t=cm(this.long0+Math.asin(n*u/this.a)/Math.sin(i))}return e.x=t,e.y=i,e},names:["Polyconic","poly"]};var tg={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(e){var t,i=e.x,n=e.y-this.lat0,a=i-this.long0,r=n/Dp*1e-5,s=a,o=1,l=0;for(t=1;t<=10;t++)o*=r,l+=this.A[t]*o;var c,h=l,u=s,d=1,p=0,m=0,f=0;for(t=1;t<=6;t++)c=p*h+d*u,d=d*h-p*u,p=c,m=m+this.B_re[t]*d-this.B_im[t]*p,f=f+this.B_im[t]*d+this.B_re[t]*p;return e.x=f*this.a+this.x0,e.y=m*this.a+this.y0,e},inverse:function(e){var t,i,n=e.x,a=e.y,r=n-this.x0,s=(a-this.y0)/this.a,o=r/this.a,l=1,c=0,h=0,u=0;for(t=1;t<=6;t++)i=c*s+l*o,l=l*s-c*o,c=i,h=h+this.C_re[t]*l-this.C_im[t]*c,u=u+this.C_im[t]*l+this.C_re[t]*c;for(var d=0;d<this.iterations;d++){var p,m=h,f=u,g=s,y=o;for(t=2;t<=6;t++)p=f*h+m*u,m=m*h-f*u,f=p,g+=(t-1)*(this.B_re[t]*m-this.B_im[t]*f),y+=(t-1)*(this.B_im[t]*m+this.B_re[t]*f);m=1,f=0;var v=this.B_re[1],b=this.B_im[1];for(t=2;t<=6;t++)p=f*h+m*u,m=m*h-f*u,f=p,v+=t*(this.B_re[t]*m-this.B_im[t]*f),b+=t*(this.B_im[t]*m+this.B_re[t]*f);var _=v*v+b*b;h=(g*v+y*b)/_,u=(y*v-g*b)/_}var x=h,w=u,S=1,M=0;for(t=1;t<=9;t++)S*=x,M+=this.D[t]*S;var T=this.lat0+M*Dp*1e5,A=this.long0+w;return e.x=A,e.y=T,e},names:["New_Zealand_Map_Grid","nzmg"]};var ig={init:function(){},forward:function(e){var t=e.x,i=e.y,n=cm(t-this.long0),a=this.x0+this.a*n,r=this.y0+this.a*Math.log(Math.tan(Math.PI/4+i/2.5))*1.25;return e.x=a,e.y=r,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=cm(this.long0+e.x/this.a),i=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Math.PI/4);return e.x=t,e.y=i,e},names:["Miller_Cylindrical","mill"]};var ng={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=df(this.es)},forward:function(e){var t,i,n=e.x,a=e.y;if(n=cm(n-this.long0),this.sphere){if(this.m)for(var r=this.n*Math.sin(a),s=20;s;--s){var o=(this.m*a+Math.sin(a)-r)/(this.m+Math.cos(a));if(a-=o,Math.abs(o)<kp)break}else a=1!==this.n?Math.asin(this.n*Math.sin(a)):a;t=this.a*this.C_x*n*(this.m+Math.cos(a)),i=this.a*this.C_y*a}else{var l=Math.sin(a),c=Math.cos(a);i=this.a*pf(a,l,c,this.en),t=this.a*n*c/Math.sqrt(1-this.es*l*l)}return e.x=t,e.y=i,e},inverse:function(e){var t,i,n;return e.x-=this.x0,i=e.x/this.a,e.y-=this.y0,t=e.y/this.a,this.sphere?(t/=this.C_y,i/=this.C_x*(this.m+Math.cos(t)),this.m?t=qf((this.m*t+Math.sin(t))/this.n):1!==this.n&&(t=qf(Math.sin(t)/this.n)),i=cm(i+this.long0),t=zf(t)):(t=mf(e.y/this.a,this.es,this.en),(n=Math.abs(t))<Lp?(n=Math.sin(t),i=cm(this.long0+e.x*Math.sqrt(1-this.es*n*n)/(this.a*Math.cos(t)))):n-kp<Lp&&(i=this.long0)),e.x=i,e.y=t,e},names:["Sinusoidal","sinu"]};var ag={init:function(){},forward:function(e){for(var t=e.x,i=e.y,n=cm(t-this.long0),a=i,r=Math.PI*Math.sin(i);;){var s=-(a+Math.sin(a)-r)/(1+Math.cos(a));if(a+=s,Math.abs(s)<kp)break}a/=2,Math.PI/2-Math.abs(i)<kp&&(n=0);var o=.900316316158*this.a*n*Math.cos(a)+this.x0,l=1.4142135623731*this.a*Math.sin(a)+this.y0;return e.x=o,e.y=l,e},inverse:function(e){var t,i;e.x-=this.x0,e.y-=this.y0,i=e.y/(1.4142135623731*this.a),Math.abs(i)>.999999999999&&(i=.999999999999),t=Math.asin(i);var n=cm(this.long0+e.x/(.900316316158*this.a*Math.cos(t)));n<-Math.PI&&(n=-Math.PI),n>Math.PI&&(n=Math.PI),i=(2*t+Math.sin(2*t))/Math.PI,Math.abs(i)>1&&(i=1);var a=Math.asin(i);return e.x=n,e.y=a,e},names:["Mollweide","moll"]};var rg={init:function(){Math.abs(this.lat1+this.lat2)<kp||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Df(this.es),this.e1=Lf(this.es),this.e2=kf(this.es),this.e3=Nf(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=om(this.e,this.sinphi,this.cosphi),this.ml1=Of(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<kp?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=om(this.e,this.sinphi,this.cosphi),this.ml2=Of(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Of(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(e){var t,i=e.x,n=e.y;if(this.sphere)t=this.a*(this.g-n);else{var a=Of(this.e0,this.e1,this.e2,this.e3,n);t=this.a*(this.g-a)}var r=this.ns*cm(i-this.long0),s=this.x0+t*Math.sin(r),o=this.y0+this.rh-t*Math.cos(r);return e.x=s,e.y=o,e},inverse:function(e){var t,i,n,a;e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns>=0?(i=Math.sqrt(e.x*e.x+e.y*e.y),t=1):(i=-Math.sqrt(e.x*e.x+e.y*e.y),t=-1);var r=0;return 0!==i&&(r=Math.atan2(t*e.x,t*e.y)),this.sphere?(a=cm(this.long0+r/this.ns),n=zf(this.g-i/this.a),e.x=a,e.y=n,e):(n=Uf(this.g-i/this.a,this.e0,this.e1,this.e2,this.e3),a=cm(this.long0+r/this.ns),e.x=a,e.y=n,e)},names:["Equidistant_Conic","eqdc"]};var sg={init:function(){this.R=this.a},forward:function(e){var t,i,n=e.x,a=e.y,r=cm(n-this.long0);Math.abs(a)<=kp&&(t=this.x0+this.R*r,i=this.y0);var s=qf(2*Math.abs(a/Math.PI));(Math.abs(r)<=kp||Math.abs(Math.abs(a)-Lp)<=kp)&&(t=this.x0,i=a>=0?this.y0+Math.PI*this.R*Math.tan(.5*s):this.y0+Math.PI*this.R*-Math.tan(.5*s));var o=.5*Math.abs(Math.PI/r-r/Math.PI),l=o*o,c=Math.sin(s),h=Math.cos(s),u=h/(c+h-1),d=u*u,p=u*(2/c-1),m=p*p,f=Math.PI*this.R*(o*(u-m)+Math.sqrt(l*(u-m)*(u-m)-(m+l)*(d-m)))/(m+l);r<0&&(f=-f),t=this.x0+f;var g=l+u;return f=Math.PI*this.R*(p*g-o*Math.sqrt((m+l)*(l+1)-g*g))/(m+l),i=a>=0?this.y0+f:this.y0-f,e.x=t,e.y=i,e},inverse:function(e){var t,i,n,a,r,s,o,l,c,h,u,d;return e.x-=this.x0,e.y-=this.y0,u=Math.PI*this.R,r=(n=e.x/u)*n+(a=e.y/u)*a,u=3*(a*a/(l=-2*(s=-Math.abs(a)*(1+r))+1+2*a*a+r*r)+(2*(o=s-2*a*a+n*n)*o*o/l/l/l-9*s*o/l/l)/27)/(c=(s-o*o/3/l)/l)/(h=2*Math.sqrt(-c/3)),Math.abs(u)>1&&(u=u>=0?1:-1),d=Math.acos(u)/3,i=e.y>=0?(-h*Math.cos(d+Math.PI/3)-o/3/l)*Math.PI:-(-h*Math.cos(d+Math.PI/3)-o/3/l)*Math.PI,t=Math.abs(n)<kp?this.long0:cm(this.long0+Math.PI*(r-1+Math.sqrt(1+2*(n*n-a*a)+r*r))/2/n),e.x=t,e.y=i,e},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]};var og={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t,i,n,a,r,s,o,l,c,h,u,d,p,m,f,g,y,v,b,_,x,w,S=e.x,M=e.y,T=Math.sin(e.y),A=Math.cos(e.y),E=cm(S-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=kp?(e.x=this.x0+this.a*(Lp-M)*Math.sin(E),e.y=this.y0-this.a*(Lp-M)*Math.cos(E),e):Math.abs(this.sin_p12+1)<=kp?(e.x=this.x0+this.a*(Lp+M)*Math.sin(E),e.y=this.y0+this.a*(Lp+M)*Math.cos(E),e):(v=this.sin_p12*T+this.cos_p12*A*Math.cos(E),y=(g=Math.acos(v))?g/Math.sin(g):1,e.x=this.x0+this.a*y*A*Math.sin(E),e.y=this.y0+this.a*y*(this.cos_p12*T-this.sin_p12*A*Math.cos(E)),e):(t=Df(this.es),i=Lf(this.es),n=kf(this.es),a=Nf(this.es),Math.abs(this.sin_p12-1)<=kp?(r=this.a*Of(t,i,n,a,Lp),s=this.a*Of(t,i,n,a,M),e.x=this.x0+(r-s)*Math.sin(E),e.y=this.y0-(r-s)*Math.cos(E),e):Math.abs(this.sin_p12+1)<=kp?(r=this.a*Of(t,i,n,a,Lp),s=this.a*Of(t,i,n,a,M),e.x=this.x0+(r+s)*Math.sin(E),e.y=this.y0+(r+s)*Math.cos(E),e):(o=T/A,l=Bf(this.a,this.e,this.sin_p12),c=Bf(this.a,this.e,T),h=Math.atan((1-this.es)*o+this.es*l*this.sin_p12/(c*A)),b=0===(u=Math.atan2(Math.sin(E),this.cos_p12*Math.tan(h)-this.sin_p12*Math.cos(E)))?Math.asin(this.cos_p12*Math.sin(h)-this.sin_p12*Math.cos(h)):Math.abs(Math.abs(u)-Math.PI)<=kp?-Math.asin(this.cos_p12*Math.sin(h)-this.sin_p12*Math.cos(h)):Math.asin(Math.sin(E)*Math.cos(h)/Math.sin(u)),d=this.e*this.sin_p12/Math.sqrt(1-this.es),g=l*b*(1-(_=b*b)*(f=(p=this.e*this.cos_p12*Math.cos(u)/Math.sqrt(1-this.es))*p)*(1-f)/6+(x=_*b)/8*(m=d*p)*(1-2*f)+(w=x*b)/120*(f*(4-7*f)-3*d*d*(1-7*f))-w*b/48*m),e.x=this.x0+g*Math.sin(u),e.y=this.y0+g*Math.cos(u),e))},inverse:function(e){var t,i,n,a,r,s,o,l,c,h,u,d,p,m,f,g,y,v,b,_,x,w,S;if(e.x-=this.x0,e.y-=this.y0,this.sphere){if((t=Math.sqrt(e.x*e.x+e.y*e.y))>2*Lp*this.a)return;return i=t/this.a,n=Math.sin(i),a=Math.cos(i),r=this.long0,Math.abs(t)<=kp?s=this.lat0:(s=qf(a*this.sin_p12+e.y*n*this.cos_p12/t),o=Math.abs(this.lat0)-Lp,r=Math.abs(o)<=kp?this.lat0>=0?cm(this.long0+Math.atan2(e.x,-e.y)):cm(this.long0-Math.atan2(-e.x,e.y)):cm(this.long0+Math.atan2(e.x*n,t*this.cos_p12*a-e.y*this.sin_p12*n))),e.x=r,e.y=s,e}return l=Df(this.es),c=Lf(this.es),h=kf(this.es),u=Nf(this.es),Math.abs(this.sin_p12-1)<=kp?(s=Uf(((d=this.a*Of(l,c,h,u,Lp))-(t=Math.sqrt(e.x*e.x+e.y*e.y)))/this.a,l,c,h,u),r=cm(this.long0+Math.atan2(e.x,-1*e.y)),e.x=r,e.y=s,e):Math.abs(this.sin_p12+1)<=kp?(d=this.a*Of(l,c,h,u,Lp),s=Uf(((t=Math.sqrt(e.x*e.x+e.y*e.y))-d)/this.a,l,c,h,u),r=cm(this.long0+Math.atan2(e.x,e.y)),e.x=r,e.y=s,e):(t=Math.sqrt(e.x*e.x+e.y*e.y),f=Math.atan2(e.x,e.y),p=Bf(this.a,this.e,this.sin_p12),g=Math.cos(f),v=-(y=this.e*this.cos_p12*g)*y/(1-this.es),b=3*this.es*(1-v)*this.sin_p12*this.cos_p12*g/(1-this.es),w=1-v*(x=(_=t/p)-v*(1+v)*Math.pow(_,3)/6-b*(1+3*v)*Math.pow(_,4)/24)*x/2-_*x*x*x/6,m=Math.asin(this.sin_p12*Math.cos(x)+this.cos_p12*Math.sin(x)*g),r=cm(this.long0+Math.asin(Math.sin(f)*Math.sin(x)/Math.cos(m))),S=Math.sin(m),s=Math.atan2((S-this.es*w*this.sin_p12)*Math.tan(m),S*(1-this.es)),e.x=r,e.y=s,e)},names:["Azimuthal_Equidistant","aeqd"]};var lg={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,i,n,a,r,s,o,l=e.x,c=e.y;return n=cm(l-this.long0),t=Math.sin(c),i=Math.cos(c),a=Math.cos(n),1,((r=this.sin_p14*t+this.cos_p14*i*a)>0||Math.abs(r)<=kp)&&(s=1*this.a*i*Math.sin(n),o=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*i*a)),e.x=s,e.y=o,e},inverse:function(e){var t,i,n,a,r,s,o;return e.x-=this.x0,e.y-=this.y0,i=qf((t=Math.sqrt(e.x*e.x+e.y*e.y))/this.a),n=Math.sin(i),a=Math.cos(i),s=this.long0,Math.abs(t)<=kp?(o=this.lat0,e.x=s,e.y=o,e):(o=qf(a*this.sin_p14+e.y*n*this.cos_p14/t),r=Math.abs(this.lat0)-Lp,Math.abs(r)<=kp?(s=this.lat0>=0?cm(this.long0+Math.atan2(e.x,-e.y)):cm(this.long0-Math.atan2(-e.x,e.y)),e.x=s,e.y=o,e):(s=cm(this.long0+Math.atan2(e.x*n,t*this.cos_p14*a-e.y*this.sin_p14*n)),e.x=s,e.y=o,e))},names:["ortho"]},cg=1,hg=2,ug=3,dg=4,pg=5,mg=6,fg=1,gg=2,yg=3,vg=4;function bg(e,t,i,n){var a;return e<kp?(n.value=fg,a=0):(a=Math.atan2(t,i),Math.abs(a)<=zp?n.value=fg:a>zp&&a<=Lp+zp?(n.value=gg,a-=Lp):a>Lp+zp||a<=-(Lp+zp)?(n.value=yg,a=a>=0?a-Fp:a+Fp):(n.value=vg,a+=Lp)),a}function _g(e,t){var i=e+t;return i<-Fp?i+=Up:i>+Fp&&(i-=Up),i}var xg={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=Lp-zp/2?this.face=pg:this.lat0<=-(Lp-zp/2)?this.face=mg:Math.abs(this.long0)<=zp?this.face=cg:Math.abs(this.long0)<=Lp+zp?this.face=this.long0>0?hg:dg:this.face=ug,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(e){var t,i,n,a,r,s,o={x:0,y:0},l={value:0};if(e.x-=this.long0,t=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(e.y)):e.y,i=e.x,this.face===pg)a=Lp-t,i>=zp&&i<=Lp+zp?(l.value=fg,n=i-Lp):i>Lp+zp||i<=-(Lp+zp)?(l.value=gg,n=i>0?i-Fp:i+Fp):i>-(Lp+zp)&&i<=-zp?(l.value=yg,n=i+Lp):(l.value=vg,n=i);else if(this.face===mg)a=Lp+t,i>=zp&&i<=Lp+zp?(l.value=fg,n=-i+Lp):i<zp&&i>=-zp?(l.value=gg,n=-i):i<-zp&&i>=-(Lp+zp)?(l.value=yg,n=-i-Lp):(l.value=vg,n=i>0?-i+Fp:-i-Fp);else{var c,h,u,d,p,m;this.face===hg?i=_g(i,+Lp):this.face===ug?i=_g(i,+Fp):this.face===dg&&(i=_g(i,-Lp)),d=Math.sin(t),p=Math.cos(t),m=Math.sin(i),c=p*Math.cos(i),h=p*m,u=d,this.face===cg?n=bg(a=Math.acos(c),u,h,l):this.face===hg?n=bg(a=Math.acos(h),u,-c,l):this.face===ug?n=bg(a=Math.acos(-c),u,-h,l):this.face===dg?n=bg(a=Math.acos(-h),u,c,l):(a=n=0,l.value=fg)}return s=Math.atan(12/Fp*(n+Math.acos(Math.sin(n)*Math.cos(zp))-Lp)),r=Math.sqrt((1-Math.cos(a))/(Math.cos(s)*Math.cos(s))/(1-Math.cos(Math.atan(1/Math.cos(n))))),l.value===gg?s+=Lp:l.value===yg?s+=Fp:l.value===vg&&(s+=1.5*Fp),o.x=r*Math.cos(s),o.y=r*Math.sin(s),o.x=o.x*this.a+this.x0,o.y=o.y*this.a+this.y0,e.x=o.x,e.y=o.y,e},inverse:function(e){var t,i,n,a,r,s,o,l,c,h,u,d,p={lam:0,phi:0},m={value:0};if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,i=Math.atan(Math.sqrt(e.x*e.x+e.y*e.y)),t=Math.atan2(e.y,e.x),e.x>=0&&e.x>=Math.abs(e.y)?m.value=fg:e.y>=0&&e.y>=Math.abs(e.x)?(m.value=gg,t-=Lp):e.x<0&&-e.x>=Math.abs(e.y)?(m.value=yg,t=t<0?t+Fp:t-Fp):(m.value=vg,t+=Lp),c=Fp/12*Math.tan(t),r=Math.sin(c)/(Math.cos(c)-1/Math.sqrt(2)),s=Math.atan(r),(o=1-(n=Math.cos(t))*n*(a=Math.tan(i))*a*(1-Math.cos(Math.atan(1/Math.cos(s)))))<-1?o=-1:o>1&&(o=1),this.face===pg)l=Math.acos(o),p.phi=Lp-l,m.value===fg?p.lam=s+Lp:m.value===gg?p.lam=s<0?s+Fp:s-Fp:m.value===yg?p.lam=s-Lp:p.lam=s;else if(this.face===mg)l=Math.acos(o),p.phi=l-Lp,m.value===fg?p.lam=-s+Lp:m.value===gg?p.lam=-s:m.value===yg?p.lam=-s-Lp:p.lam=s<0?-s-Fp:-s+Fp;else{var f,g,y;c=(f=o)*f,g=(c+=(y=c>=1?0:Math.sqrt(1-c)*Math.sin(s))*y)>=1?0:Math.sqrt(1-c),m.value===gg?(c=g,g=-y,y=c):m.value===yg?(g=-g,y=-y):m.value===vg&&(c=g,g=y,y=-c),this.face===hg?(c=f,f=-g,g=c):this.face===ug?(f=-f,g=-g):this.face===dg&&(c=f,f=g,g=-c),p.phi=Math.acos(-y)-Lp,p.lam=Math.atan2(g,f),this.face===hg?p.lam=_g(p.lam,-Lp):this.face===ug?p.lam=_g(p.lam,-Fp):this.face===dg&&(p.lam=_g(p.lam,+Lp))}return 0!==this.es&&(h=p.phi<0?1:0,u=Math.tan(p.phi),d=this.b/Math.sqrt(u*u+this.one_minus_f_squared),p.phi=Math.atan(Math.sqrt(this.a*this.a-d*d)/(this.one_minus_f*d)),h&&(p.phi=-p.phi)),p.lam+=this.long0,e.x=p.lam,e.y=p.phi,e},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]},wg=[[1,22199e-21,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-9.86701e-7],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,1.8736e-8],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,9.34959e-7],[.7986,-.00755338,-500009e-10,9.35324e-7],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],Sg=[[-520417e-23,.0124,121431e-23,-845284e-16],[.062,.0124,-1.26793e-9,4.22642e-10],[.124,.0124,5.07171e-9,-1.60604e-9],[.186,.0123999,-1.90189e-8,6.00152e-9],[.248,.0124002,7.10039e-8,-2.24e-8],[.31,.0123992,-2.64997e-7,8.35986e-8],[.372,.0124029,9.88983e-7,-3.11994e-7],[.434,.0123893,-369093e-11,-4.35621e-7],[.4958,.0123198,-102252e-10,-3.45523e-7],[.5571,.0121916,-154081e-10,-5.82288e-7],[.6176,.0119938,-241424e-10,-5.25327e-7],[.6769,.011713,-320223e-10,-5.16405e-7],[.7346,.0113541,-397684e-10,-6.09052e-7],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-1.40374e-9],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],Mg=.8487,Tg=1.3523,Ag=Bp/5,Eg=18,Cg=function(e,t){return e[0]+t*(e[1]+t*(e[2]+t*e[3]))};var Ig={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"},forward:function(e){var t=cm(e.x-this.long0),i=Math.abs(e.y),n=Math.floor(i*Ag);n<0?n=0:n>=Eg&&(n=17);var a={x:Cg(wg[n],i=Bp*(i-.08726646259971647*n))*t,y:Cg(Sg[n],i)};return e.y<0&&(a.y=-a.y),a.x=a.x*this.a*Mg+this.x0,a.y=a.y*this.a*Tg+this.y0,a},inverse:function(e){var t={x:(e.x-this.x0)/(this.a*Mg),y:Math.abs(e.y-this.y0)/(this.a*Tg)};if(t.y>=1)t.x/=wg[18][0],t.y=e.y<0?-Lp:Lp;else{var i=Math.floor(t.y*Eg);for(i<0?i=0:i>=Eg&&(i=17);;)if(Sg[i][0]>t.y)--i;else{if(!(Sg[i+1][0]<=t.y))break;++i}var n=Sg[i],a=5*(t.y-n[0])/(Sg[i+1][0]-n[0]);a=function(e,t,i,n){for(var a=t;n;--n){var r=e(a);if(a-=r,Math.abs(r)<i)break}return a}((function(e){return(Cg(n,e)-t.y)/function(e,t){return e[1]+t*(2*e[2]+3*t*e[3])}(n,e)}),a,kp,100),t.x/=Cg(wg[i],a),t.y=(5*i+a)*Np,e.y<0&&(t.y=-t.y)}return t.x=cm(t.x+this.long0),t},names:["Robinson","robin"]};var Pg={init:function(){this.name="geocent"},forward:function(e){return Im(e,this.es,this.a)},inverse:function(e){return Pm(e,this.es,this.a,this.b)},names:["Geocentric","geocentric","geocent","Geocent"]},Rg=0,Og=1,Dg=2,Lg=3,kg={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}};var Ng={init:function(){if(Object.keys(kg).forEach(function(e){if(void 0===this[e])this[e]=kg[e].def;else{if(kg[e].num&&isNaN(this[e]))throw new Error("Invalid parameter value, must be numeric "+e+" = "+this[e]);kg[e].num&&(this[e]=parseFloat(this[e]))}kg[e].degrees&&(this[e]=this[e]*Np)}.bind(this)),Math.abs(Math.abs(this.lat0)-Lp)<kp?this.mode=this.lat0<0?Og:Rg:Math.abs(this.lat0)<kp?this.mode=Dg:(this.mode=Lg,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var e=this.tilt,t=this.azi;this.cg=Math.cos(t),this.sg=Math.sin(t),this.cw=Math.cos(e),this.sw=Math.sin(e)},forward:function(e){e.x-=this.long0;var t,i,n,a,r=Math.sin(e.y),s=Math.cos(e.y),o=Math.cos(e.x);switch(this.mode){case Lg:i=this.sinph0*r+this.cosph0*s*o;break;case Dg:i=s*o;break;case Og:i=-r;break;case Rg:i=r}switch(t=(i=this.pn1/(this.p-i))*s*Math.sin(e.x),this.mode){case Lg:i*=this.cosph0*r-this.sinph0*s*o;break;case Dg:i*=r;break;case Rg:i*=-s*o;break;case Og:i*=s*o}return a=1/((n=i*this.cg+t*this.sg)*this.sw*this.h1+this.cw),t=(t*this.cg-i*this.sg)*this.cw*a,i=n*a,e.x=t*this.a,e.y=i*this.a,e},inverse:function(e){e.x/=this.a,e.y/=this.a;var t,i,n,a={x:e.x,y:e.y};n=1/(this.pn1-e.y*this.sw),t=this.pn1*e.x*n,i=this.pn1*e.y*this.cw*n,e.x=t*this.cg+i*this.sg,e.y=i*this.cg-t*this.sg;var r=yf(e.x,e.y);if(Math.abs(r)<kp)a.x=0,a.y=e.y;else{var s,o;switch(o=1-r*r*this.pfact,o=(this.p-Math.sqrt(o))/(this.pn1/r+r/this.pn1),s=Math.sqrt(1-o*o),this.mode){case Lg:a.y=Math.asin(s*this.sinph0+e.y*o*this.cosph0/r),e.y=(s-this.sinph0*Math.sin(a.y))*r,e.x*=o*this.cosph0;break;case Dg:a.y=Math.asin(e.y*o/r),e.y=s*r,e.x*=o;break;case Rg:a.y=Math.asin(s),e.y=-e.y;break;case Og:a.y=-Math.asin(s)}a.x=Math.atan2(e.x,e.y)}return e.x=a.x+this.long0,e.y=a.y,e},names:["Tilted_Perspective","tpers"]};Gm.defaultDatum="WGS84",Gm.Proj=Cm,Gm.WGS84=new Gm.Proj("WGS84"),Gm.Point=lf,Gm.toPoint=Bm,Gm.defs=im,Gm.nadgrid=function(e,t){var i=new DataView(t),n=function(e){var t=e.getInt32(8,!1);if(11===t)return!1;11!==(t=e.getInt32(8,!0))&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian");return!0}(i),a=function(e,t){return{nFields:e.getInt32(8,t),nSubgridFields:e.getInt32(24,t),nSubgrids:e.getInt32(40,t),shiftType:Mm(e,56,64).trim(),fromSemiMajorAxis:e.getFloat64(120,t),fromSemiMinorAxis:e.getFloat64(136,t),toSemiMajorAxis:e.getFloat64(152,t),toSemiMinorAxis:e.getFloat64(168,t)}}(i,n);a.nSubgrids>1&&console.log("Only single NTv2 subgrids are currently supported, subsequent sub grids are ignored");var r={header:a,subgrids:function(e,t,i){for(var n=176,a=[],r=0;r<t.nSubgrids;r++){var s=Am(e,n,i),o=Em(e,n,s,i),l=Math.round(1+(s.upperLongitude-s.lowerLongitude)/s.longitudeInterval),c=Math.round(1+(s.upperLatitude-s.lowerLatitude)/s.latitudeInterval);a.push({ll:[Sm(s.lowerLongitude),Sm(s.lowerLatitude)],del:[Sm(s.longitudeInterval),Sm(s.latitudeInterval)],lim:[l,c],count:s.gridNodeCount,cvs:Tm(o)})}return a}(i,a,n)};return xm[e]=r,r},Gm.transform=Um,Gm.mgrs=Qm,Gm.version="__VERSION__",function(e){e.Proj.projections.add(ff),e.Proj.projections.add(xf),e.Proj.projections.add(wf),e.Proj.projections.add(Tf),e.Proj.projections.add(Af),e.Proj.projections.add(Ef),e.Proj.projections.add(If),e.Proj.projections.add(Pf),e.Proj.projections.add(Rf),e.Proj.projections.add(Ff),e.Proj.projections.add(Zf),e.Proj.projections.add(Jf),e.Proj.projections.add(Qf),e.Proj.projections.add(Kf),e.Proj.projections.add($f),e.Proj.projections.add(eg),e.Proj.projections.add(tg),e.Proj.projections.add(ig),e.Proj.projections.add(ng),e.Proj.projections.add(ag),e.Proj.projections.add(rg),e.Proj.projections.add(sg),e.Proj.projections.add(og),e.Proj.projections.add(lg),e.Proj.projections.add(xg),e.Proj.projections.add(Ig),e.Proj.projections.add(Pg),e.Proj.projections.add(Ng)}(Gm);var Bg="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function zg(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(i){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})})),t}function Ug(e){var t={exports:{}};return e(t,t.exports),t.exports}function Fg(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets option of @rollup/plugin-commonjs appropriately for this require call to behave properly.')}
/*!

  JSZip v3.10.1 - A JavaScript class for generating and reading zip files
  <http://stuartk.com/jszip>

  (c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
  Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

  JSZip uses the library pako released under the MIT license :
  https://github.com/nodeca/pako/blob/main/LICENSE
  */var jg=Ug((function(e,t){e.exports=function e(t,i,n){function a(s,o){if(!i[s]){if(!t[s]){if(!o&&Fg)return Fg(s);if(r)return r(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var c=i[s]={exports:{}};t[s][0].call(c.exports,(function(e){return a(t[s][1][e]||e)}),c,c.exports,e,t,i,n)}return i[s].exports}for(var r=Fg,s=0;s<n.length;s++)a(n[s]);return a}({1:[function(e,t,i){var n=e("./utils"),a=e("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(e){for(var t,i,a,s,o,l,c,h=[],u=0,d=e.length,p=d,m="string"!==n.getTypeOf(e);u<e.length;)p=d-u,a=m?(t=e[u++],i=u<d?e[u++]:0,u<d?e[u++]:0):(t=e.charCodeAt(u++),i=u<d?e.charCodeAt(u++):0,u<d?e.charCodeAt(u++):0),s=t>>2,o=(3&t)<<4|i>>4,l=1<p?(15&i)<<2|a>>6:64,c=2<p?63&a:64,h.push(r.charAt(s)+r.charAt(o)+r.charAt(l)+r.charAt(c));return h.join("")},i.decode=function(e){var t,i,n,s,o,l,c=0,h=0,u="data:";if(e.substr(0,u.length)===u)throw new Error("Invalid base64 input, it looks like a data url.");var d,p=3*(e=e.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(e.charAt(e.length-1)===r.charAt(64)&&p--,e.charAt(e.length-2)===r.charAt(64)&&p--,p%1!=0)throw new Error("Invalid base64 input, bad content length.");for(d=a.uint8array?new Uint8Array(0|p):new Array(0|p);c<e.length;)t=r.indexOf(e.charAt(c++))<<2|(s=r.indexOf(e.charAt(c++)))>>4,i=(15&s)<<4|(o=r.indexOf(e.charAt(c++)))>>2,n=(3&o)<<6|(l=r.indexOf(e.charAt(c++))),d[h++]=t,64!==o&&(d[h++]=i),64!==l&&(d[h++]=n);return d}},{"./support":30,"./utils":32}],2:[function(e,t,i){var n=e("./external"),a=e("./stream/DataWorker"),r=e("./stream/Crc32Probe"),s=e("./stream/DataLengthProbe");function o(e,t,i,n,a){this.compressedSize=e,this.uncompressedSize=t,this.crc32=i,this.compression=n,this.compressedContent=a}o.prototype={getContentWorker:function(){var e=new a(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new s("data_length")),t=this;return e.on("end",(function(){if(this.streamInfo.data_length!==t.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")})),e},getCompressedWorker:function(){return new a(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},o.createWorkerFrom=function(e,t,i){return e.pipe(new r).pipe(new s("uncompressedSize")).pipe(t.compressWorker(i)).pipe(new s("compressedSize")).withStreamInfo("compression",t)},t.exports=o},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,t,i){var n=e("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},i.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,t,i){var n=e("./utils"),a=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();t.exports=function(e,t){return void 0!==e&&e.length?"string"!==n.getTypeOf(e)?function(e,t,i,n){var r=a,s=n+i;e^=-1;for(var o=n;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e}(0|t,e,e.length,0):function(e,t,i,n){var r=a,s=n+i;e^=-1;for(var o=n;o<s;o++)e=e>>>8^r[255&(e^t.charCodeAt(o))];return-1^e}(0|t,e,e.length,0):0}},{"./utils":32}],5:[function(e,t,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(e,t,i){var n=null;n="undefined"!=typeof Promise?Promise:e("lie"),t.exports={Promise:n}},{lie:37}],7:[function(e,t,i){var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,a=e("pako"),r=e("./utils"),s=e("./stream/GenericWorker"),o=n?"uint8array":"array";function l(e,t){s.call(this,"FlateWorker/"+e),this._pako=null,this._pakoAction=e,this._pakoOptions=t,this.meta={}}i.magic="\b\0",r.inherits(l,s),l.prototype.processChunk=function(e){this.meta=e.meta,null===this._pako&&this._createPako(),this._pako.push(r.transformTo(o,e.data),!1)},l.prototype.flush=function(){s.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},l.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},l.prototype._createPako=function(){this._pako=new a[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var e=this;this._pako.onData=function(t){e.push({data:t,meta:e.meta})}},i.compressWorker=function(e){return new l("Deflate",e)},i.uncompressWorker=function(){return new l("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,t,i){function n(e,t){var i,n="";for(i=0;i<t;i++)n+=String.fromCharCode(255&e),e>>>=8;return n}function a(e,t,i,a,s,h){var u,d,p=e.file,m=e.compression,f=h!==o.utf8encode,g=r.transformTo("string",h(p.name)),y=r.transformTo("string",o.utf8encode(p.name)),v=p.comment,b=r.transformTo("string",h(v)),_=r.transformTo("string",o.utf8encode(v)),x=y.length!==p.name.length,w=_.length!==v.length,S="",M="",T="",A=p.dir,E=p.date,C={crc32:0,compressedSize:0,uncompressedSize:0};t&&!i||(C.crc32=e.crc32,C.compressedSize=e.compressedSize,C.uncompressedSize=e.uncompressedSize);var I=0;t&&(I|=8),f||!x&&!w||(I|=2048);var P=0,R=0;A&&(P|=16),"UNIX"===s?(R=798,P|=function(e,t){var i=e;return e||(i=t?16893:33204),(65535&i)<<16}(p.unixPermissions,A)):(R=20,P|=function(e){return 63&(e||0)}(p.dosPermissions)),u=E.getUTCHours(),u<<=6,u|=E.getUTCMinutes(),u<<=5,u|=E.getUTCSeconds()/2,d=E.getUTCFullYear()-1980,d<<=4,d|=E.getUTCMonth()+1,d<<=5,d|=E.getUTCDate(),x&&(M=n(1,1)+n(l(g),4)+y,S+="up"+n(M.length,2)+M),w&&(T=n(1,1)+n(l(b),4)+_,S+="uc"+n(T.length,2)+T);var O="";return O+="\n\0",O+=n(I,2),O+=m.magic,O+=n(u,2),O+=n(d,2),O+=n(C.crc32,4),O+=n(C.compressedSize,4),O+=n(C.uncompressedSize,4),O+=n(g.length,2),O+=n(S.length,2),{fileRecord:c.LOCAL_FILE_HEADER+O+g+S,dirRecord:c.CENTRAL_FILE_HEADER+n(R,2)+O+n(b.length,2)+"\0\0\0\0"+n(P,4)+n(a,4)+g+S+b}}var r=e("../utils"),s=e("../stream/GenericWorker"),o=e("../utf8"),l=e("../crc32"),c=e("../signature");function h(e,t,i,n){s.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=t,this.zipPlatform=i,this.encodeFileName=n,this.streamFiles=e,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(h,s),h.prototype.push=function(e){var t=e.meta.percent||0,i=this.entriesCount,n=this._sources.length;this.accumulate?this.contentBuffer.push(e):(this.bytesWritten+=e.data.length,s.prototype.push.call(this,{data:e.data,meta:{currentFile:this.currentFile,percent:i?(t+100*(i-n-1))/i:100}}))},h.prototype.openedSource=function(e){this.currentSourceOffset=this.bytesWritten,this.currentFile=e.file.name;var t=this.streamFiles&&!e.file.dir;if(t){var i=a(e,t,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:i.fileRecord,meta:{percent:0}})}else this.accumulate=!0},h.prototype.closedSource=function(e){this.accumulate=!1;var t=this.streamFiles&&!e.file.dir,i=a(e,t,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(i.dirRecord),t)this.push({data:function(e){return c.DATA_DESCRIPTOR+n(e.crc32,4)+n(e.compressedSize,4)+n(e.uncompressedSize,4)}(e),meta:{percent:100}});else for(this.push({data:i.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},h.prototype.flush=function(){for(var e=this.bytesWritten,t=0;t<this.dirRecords.length;t++)this.push({data:this.dirRecords[t],meta:{percent:100}});var i=this.bytesWritten-e,a=function(e,t,i,a,s){var o=r.transformTo("string",s(a));return c.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(e,2)+n(e,2)+n(t,4)+n(i,4)+n(o.length,2)+o}(this.dirRecords.length,i,e,this.zipComment,this.encodeFileName);this.push({data:a,meta:{percent:100}})},h.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},h.prototype.registerPrevious=function(e){this._sources.push(e);var t=this;return e.on("data",(function(e){t.processChunk(e)})),e.on("end",(function(){t.closedSource(t.previous.streamInfo),t._sources.length?t.prepareNextSource():t.end()})),e.on("error",(function(e){t.error(e)})),this},h.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},h.prototype.error=function(e){var t=this._sources;if(!s.prototype.error.call(this,e))return!1;for(var i=0;i<t.length;i++)try{t[i].error(e)}catch(e){}return!0},h.prototype.lock=function(){s.prototype.lock.call(this);for(var e=this._sources,t=0;t<e.length;t++)e[t].lock()},t.exports=h},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,t,i){var n=e("../compressions"),a=e("./ZipFileWorker");i.generateWorker=function(e,t,i){var r=new a(t.streamFiles,i,t.platform,t.encodeFileName),s=0;try{e.forEach((function(e,i){s++;var a=function(e,t){var i=e||t,a=n[i];if(!a)throw new Error(i+" is not a valid compression method !");return a}(i.options.compression,t.compression),o=i.options.compressionOptions||t.compressionOptions||{},l=i.dir,c=i.date;i._compressWorker(a,o).withStreamInfo("file",{name:e,dir:l,date:c,comment:i.comment||"",unixPermissions:i.unixPermissions,dosPermissions:i.dosPermissions}).pipe(r)})),r.entriesCount=s}catch(e){r.error(e)}return r}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,t,i){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var e=new n;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}(n.prototype=e("./object")).loadAsync=e("./load"),n.support=e("./support"),n.defaults=e("./defaults"),n.version="3.10.1",n.loadAsync=function(e,t){return(new n).loadAsync(e,t)},n.external=e("./external"),t.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,t,i){var n=e("./utils"),a=e("./external"),r=e("./utf8"),s=e("./zipEntries"),o=e("./stream/Crc32Probe"),l=e("./nodejsUtils");function c(e){return new a.Promise((function(t,i){var n=e.decompressed.getContentWorker().pipe(new o);n.on("error",(function(e){i(e)})).on("end",(function(){n.streamInfo.crc32!==e.decompressed.crc32?i(new Error("Corrupted zip : CRC32 mismatch")):t()})).resume()}))}t.exports=function(e,t){var i=this;return t=n.extend(t||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),l.isNode&&l.isStream(e)?a.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",e,!0,t.optimizedBinaryString,t.base64).then((function(e){var i=new s(t);return i.load(e),i})).then((function(e){var i=[a.Promise.resolve(e)],n=e.files;if(t.checkCRC32)for(var r=0;r<n.length;r++)i.push(c(n[r]));return a.Promise.all(i)})).then((function(e){for(var a=e.shift(),r=a.files,s=0;s<r.length;s++){var o=r[s],l=o.fileNameStr,c=n.resolve(o.fileNameStr);i.file(c,o.decompressed,{binary:!0,optimizedBinaryString:!0,date:o.date,dir:o.dir,comment:o.fileCommentStr.length?o.fileCommentStr:null,unixPermissions:o.unixPermissions,dosPermissions:o.dosPermissions,createFolders:t.createFolders}),o.dir||(i.file(c).unsafeOriginalName=l)}return a.zipComment.length&&(i.comment=a.zipComment),i}))}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,t,i){var n=e("../utils"),a=e("../stream/GenericWorker");function r(e,t){a.call(this,"Nodejs stream input adapter for "+e),this._upstreamEnded=!1,this._bindStream(t)}n.inherits(r,a),r.prototype._bindStream=function(e){var t=this;(this._stream=e).pause(),e.on("data",(function(e){t.push({data:e,meta:{percent:0}})})).on("error",(function(e){t.isPaused?this.generatedError=e:t.error(e)})).on("end",(function(){t.isPaused?t._upstreamEnded=!0:t.end()}))},r.prototype.pause=function(){return!!a.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,t,i){var n=e("readable-stream").Readable;function a(e,t,i){n.call(this,t),this._helper=e;var a=this;e.on("data",(function(e,t){a.push(e)||a._helper.pause(),i&&i(t)})).on("error",(function(e){a.emit("error",e)})).on("end",(function(){a.push(null)}))}e("../utils").inherits(a,n),a.prototype._read=function(){this._helper.resume()},t.exports=a},{"../utils":32,"readable-stream":16}],14:[function(e,t,i){t.exports={isNode:"undefined"!=typeof Buffer,newBufferFrom:function(e,t){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(e,t);if("number"==typeof e)throw new Error('The "data" argument must not be a number');return new Buffer(e,t)},allocBuffer:function(e){if(Buffer.alloc)return Buffer.alloc(e);var t=new Buffer(e);return t.fill(0),t},isBuffer:function(e){return Buffer.isBuffer(e)},isStream:function(e){return e&&"function"==typeof e.on&&"function"==typeof e.pause&&"function"==typeof e.resume}}},{}],15:[function(e,t,i){function n(e,t,i){var n,a=r.getTypeOf(t),o=r.extend(i||{},l);o.date=o.date||new Date,null!==o.compression&&(o.compression=o.compression.toUpperCase()),"string"==typeof o.unixPermissions&&(o.unixPermissions=parseInt(o.unixPermissions,8)),o.unixPermissions&&16384&o.unixPermissions&&(o.dir=!0),o.dosPermissions&&16&o.dosPermissions&&(o.dir=!0),o.dir&&(e=f(e)),o.createFolders&&(n=m(e))&&g.call(this,n,!0);var u="string"===a&&!1===o.binary&&!1===o.base64;i&&void 0!==i.binary||(o.binary=!u),(t instanceof c&&0===t.uncompressedSize||o.dir||!t||0===t.length)&&(o.base64=!1,o.binary=!0,t="",o.compression="STORE",a="string");var y=null;y=t instanceof c||t instanceof s?t:d.isNode&&d.isStream(t)?new p(e,t):r.prepareContent(e,t,o.binary,o.optimizedBinaryString,o.base64);var v=new h(e,y,o);this.files[e]=v}var a=e("./utf8"),r=e("./utils"),s=e("./stream/GenericWorker"),o=e("./stream/StreamHelper"),l=e("./defaults"),c=e("./compressedObject"),h=e("./zipObject"),u=e("./generate"),d=e("./nodejsUtils"),p=e("./nodejs/NodejsStreamInputAdapter"),m=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""},f=function(e){return"/"!==e.slice(-1)&&(e+="/"),e},g=function(e,t){return t=void 0!==t?t:l.createFolders,e=f(e),this.files[e]||n.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]};function y(e){return"[object RegExp]"===Object.prototype.toString.call(e)}var v={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(e){var t,i,n;for(t in this.files)n=this.files[t],(i=t.slice(this.root.length,t.length))&&t.slice(0,this.root.length)===this.root&&e(i,n)},filter:function(e){var t=[];return this.forEach((function(i,n){e(i,n)&&t.push(n)})),t},file:function(e,t,i){if(1!==arguments.length)return e=this.root+e,n.call(this,e,t,i),this;if(y(e)){var a=e;return this.filter((function(e,t){return!t.dir&&a.test(e)}))}var r=this.files[this.root+e];return r&&!r.dir?r:null},folder:function(e){if(!e)return this;if(y(e))return this.filter((function(t,i){return i.dir&&e.test(t)}));var t=this.root+e,i=g.call(this,t),n=this.clone();return n.root=i.name,n},remove:function(e){e=this.root+e;var t=this.files[e];if(t||("/"!==e.slice(-1)&&(e+="/"),t=this.files[e]),t&&!t.dir)delete this.files[e];else for(var i=this.filter((function(t,i){return i.name.slice(0,e.length)===e})),n=0;n<i.length;n++)delete this.files[i[n].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,i={};try{if((i=r.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=i.type.toLowerCase(),i.compression=i.compression.toUpperCase(),"binarystring"===i.type&&(i.type="string"),!i.type)throw new Error("No output type specified.");r.checkSupport(i.type),"darwin"!==i.platform&&"freebsd"!==i.platform&&"linux"!==i.platform&&"sunos"!==i.platform||(i.platform="UNIX"),"win32"===i.platform&&(i.platform="DOS");var n=i.comment||this.comment||"";t=u.generateWorker(this,i,n)}catch(e){(t=new s("error")).error(e)}return new o(t,i.type||"string",i.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}};t.exports=v},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,t,i){t.exports=e("stream")},{stream:void 0}],17:[function(e,t,i){var n=e("./DataReader");function a(e){n.call(this,e);for(var t=0;t<this.data.length;t++)e[t]=255&e[t]}e("../utils").inherits(a,n),a.prototype.byteAt=function(e){return this.data[this.zero+e]},a.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),i=e.charCodeAt(1),n=e.charCodeAt(2),a=e.charCodeAt(3),r=this.length-4;0<=r;--r)if(this.data[r]===t&&this.data[r+1]===i&&this.data[r+2]===n&&this.data[r+3]===a)return r-this.zero;return-1},a.prototype.readAndCheckSignature=function(e){var t=e.charCodeAt(0),i=e.charCodeAt(1),n=e.charCodeAt(2),a=e.charCodeAt(3),r=this.readData(4);return t===r[0]&&i===r[1]&&n===r[2]&&a===r[3]},a.prototype.readData=function(e){if(this.checkOffset(e),0===e)return[];var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./DataReader":18}],18:[function(e,t,i){var n=e("../utils");function a(e){this.data=e,this.length=e.length,this.index=0,this.zero=0}a.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<this.zero+e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(){},readInt:function(e){var t,i=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)i=(i<<8)+this.byteAt(t);return this.index+=e,i},readString:function(e){return n.transformTo("string",this.readData(e))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var e=this.readInt(4);return new Date(Date.UTC(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1))}},t.exports=a},{"../utils":32}],19:[function(e,t,i){var n=e("./Uint8ArrayReader");function a(e){n.call(this,e)}e("../utils").inherits(a,n),a.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,t,i){var n=e("./DataReader");function a(e){n.call(this,e)}e("../utils").inherits(a,n),a.prototype.byteAt=function(e){return this.data.charCodeAt(this.zero+e)},a.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)-this.zero},a.prototype.readAndCheckSignature=function(e){return e===this.readData(4)},a.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./DataReader":18}],21:[function(e,t,i){var n=e("./ArrayReader");function a(e){n.call(this,e)}e("../utils").inherits(a,n),a.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./ArrayReader":17}],22:[function(e,t,i){var n=e("../utils"),a=e("../support"),r=e("./ArrayReader"),s=e("./StringReader"),o=e("./NodeBufferReader"),l=e("./Uint8ArrayReader");t.exports=function(e){var t=n.getTypeOf(e);return n.checkSupport(t),"string"!==t||a.uint8array?"nodebuffer"===t?new o(e):a.uint8array?new l(n.transformTo("uint8array",e)):new r(n.transformTo("array",e)):new s(e)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,t,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\b"},{}],24:[function(e,t,i){var n=e("./GenericWorker"),a=e("../utils");function r(e){n.call(this,"ConvertWorker to "+e),this.destType=e}a.inherits(r,n),r.prototype.processChunk=function(e){this.push({data:a.transformTo(this.destType,e.data),meta:e.meta})},t.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(e,t,i){var n=e("./GenericWorker"),a=e("../crc32");function r(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(r,n),r.prototype.processChunk=function(e){this.streamInfo.crc32=a(e.data,this.streamInfo.crc32||0),this.push(e)},t.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,t,i){var n=e("../utils"),a=e("./GenericWorker");function r(e){a.call(this,"DataLengthProbe for "+e),this.propName=e,this.withStreamInfo(e,0)}n.inherits(r,a),r.prototype.processChunk=function(e){if(e){var t=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=t+e.data.length}a.prototype.processChunk.call(this,e)},t.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(e,t,i){var n=e("../utils"),a=e("./GenericWorker");function r(e){a.call(this,"DataWorker");var t=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,e.then((function(e){t.dataIsReady=!0,t.data=e,t.max=e&&e.length||0,t.type=n.getTypeOf(e),t.isPaused||t._tickAndRepeat()}),(function(e){t.error(e)}))}n.inherits(r,a),r.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var e=null,t=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":e=this.data.substring(this.index,t);break;case"uint8array":e=this.data.subarray(this.index,t);break;case"array":case"nodebuffer":e=this.data.slice(this.index,t)}return this.index=t,this.push({data:e,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(e,t,i){function n(e){this.name=e||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(e){this.emit("data",e)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(e,t){return this._listeners[e].push(t),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(e,t){if(this._listeners[e])for(var i=0;i<this._listeners[e].length;i++)this._listeners[e][i].call(this,t)},pipe:function(e){return e.registerPrevious(this)},registerPrevious:function(e){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=e.streamInfo,this.mergeStreamInfo(),this.previous=e;var t=this;return e.on("data",(function(e){t.processChunk(e)})),e.on("end",(function(){t.end()})),e.on("error",(function(e){t.error(e)})),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var e=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),e=!0),this.previous&&this.previous.resume(),!e},flush:function(){},processChunk:function(e){this.push(e)},withStreamInfo:function(e,t){return this.extraStreamInfo[e]=t,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var e in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,e)&&(this.streamInfo[e]=this.extraStreamInfo[e])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var e="Worker "+this.name;return this.previous?this.previous+" -> "+e:e}},t.exports=n},{}],29:[function(e,t,i){var n=e("../utils"),a=e("./ConvertWorker"),r=e("./GenericWorker"),s=e("../base64"),o=e("../support"),l=e("../external"),c=null;if(o.nodestream)try{c=e("../nodejs/NodejsStreamOutputAdapter")}catch(e){}function h(e,t){return new l.Promise((function(i,a){var r=[],o=e._internalType,l=e._outputType,c=e._mimeType;e.on("data",(function(e,i){r.push(e),t&&t(i)})).on("error",(function(e){r=[],a(e)})).on("end",(function(){try{var e=function(e,t,i){switch(e){case"blob":return n.newBlob(n.transformTo("arraybuffer",t),i);case"base64":return s.encode(t);default:return n.transformTo(e,t)}}(l,function(e,t){var i,n=0,a=null,r=0;for(i=0;i<t.length;i++)r+=t[i].length;switch(e){case"string":return t.join("");case"array":return Array.prototype.concat.apply([],t);case"uint8array":for(a=new Uint8Array(r),i=0;i<t.length;i++)a.set(t[i],n),n+=t[i].length;return a;case"nodebuffer":return Buffer.concat(t);default:throw new Error("concat : unsupported type '"+e+"'")}}(o,r),c);i(e)}catch(e){a(e)}r=[]})).resume()}))}function u(e,t,i){var s=t;switch(t){case"blob":case"arraybuffer":s="uint8array";break;case"base64":s="string"}try{this._internalType=s,this._outputType=t,this._mimeType=i,n.checkSupport(s),this._worker=e.pipe(new a(s)),e.lock()}catch(e){this._worker=new r("error"),this._worker.error(e)}}u.prototype={accumulate:function(e){return h(this,e)},on:function(e,t){var i=this;return"data"===e?this._worker.on(e,(function(e){t.call(i,e.data,e.meta)})):this._worker.on(e,(function(){n.delay(t,arguments,i)})),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(e){if(n.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new c(this,{objectMode:"nodebuffer"!==this._outputType},e)}},t.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,t,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,i.nodebuffer="undefined"!=typeof Buffer,i.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)i.blob=!1;else{var n=new ArrayBuffer(0);try{i.blob=0===new Blob([n],{type:"application/zip"}).size}catch(e){try{var a=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);a.append(n),i.blob=0===a.getBlob("application/zip").size}catch(e){i.blob=!1}}}try{i.nodestream=!!e("readable-stream").Readable}catch(e){i.nodestream=!1}},{"readable-stream":16}],31:[function(e,t,i){for(var n=e("./utils"),a=e("./support"),r=e("./nodejsUtils"),s=e("./stream/GenericWorker"),o=new Array(256),l=0;l<256;l++)o[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function c(){s.call(this,"utf-8 decode"),this.leftOver=null}function h(){s.call(this,"utf-8 encode")}o[254]=o[254]=1,i.utf8encode=function(e){return a.nodebuffer?r.newBufferFrom(e,"utf-8"):function(e){var t,i,n,r,s,o=e.length,l=0;for(r=0;r<o;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(n=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),l+=i<128?1:i<2048?2:i<65536?3:4;for(t=a.uint8array?new Uint8Array(l):new Array(l),r=s=0;s<l;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(n=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?t[s++]=i:(i<2048?t[s++]=192|i>>>6:(i<65536?t[s++]=224|i>>>12:(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63),t[s++]=128|i>>>6&63),t[s++]=128|63&i);return t}(e)},i.utf8decode=function(e){return a.nodebuffer?n.transformTo("nodebuffer",e).toString("utf-8"):function(e){var t,i,a,r,s=e.length,l=new Array(2*s);for(t=i=0;t<s;)if((a=e[t++])<128)l[i++]=a;else if(4<(r=o[a]))l[i++]=65533,t+=r-1;else{for(a&=2===r?31:3===r?15:7;1<r&&t<s;)a=a<<6|63&e[t++],r--;1<r?l[i++]=65533:a<65536?l[i++]=a:(a-=65536,l[i++]=55296|a>>10&1023,l[i++]=56320|1023&a)}return l.length!==i&&(l.subarray?l=l.subarray(0,i):l.length=i),n.applyFromCharCode(l)}(e=n.transformTo(a.uint8array?"uint8array":"array",e))},n.inherits(c,s),c.prototype.processChunk=function(e){var t=n.transformTo(a.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(a.uint8array){var r=t;(t=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),t.set(r,this.leftOver.length)}else t=this.leftOver.concat(t);this.leftOver=null}var s=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;0<=i&&128==(192&e[i]);)i--;return i<0||0===i?t:i+o[e[i]]>t?i:t}(t),l=t;s!==t.length&&(a.uint8array?(l=t.subarray(0,s),this.leftOver=t.subarray(s,t.length)):(l=t.slice(0,s),this.leftOver=t.slice(s,t.length))),this.push({data:i.utf8decode(l),meta:e.meta})},c.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=c,n.inherits(h,s),h.prototype.processChunk=function(e){this.push({data:i.utf8encode(e.data),meta:e.meta})},i.Utf8EncodeWorker=h},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,t,i){var n=e("./support"),a=e("./base64"),r=e("./nodejsUtils"),s=e("./external");function o(e){return e}function l(e,t){for(var i=0;i<e.length;++i)t[i]=255&e.charCodeAt(i);return t}e("setimmediate"),i.newBlob=function(e,t){i.checkSupport("blob");try{return new Blob([e],{type:t})}catch(i){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return n.append(e),n.getBlob(t)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var c={stringifyByChunk:function(e,t,i){var n=[],a=0,r=e.length;if(r<=i)return String.fromCharCode.apply(null,e);for(;a<r;)"array"===t||"nodebuffer"===t?n.push(String.fromCharCode.apply(null,e.slice(a,Math.min(a+i,r)))):n.push(String.fromCharCode.apply(null,e.subarray(a,Math.min(a+i,r)))),a+=i;return n.join("")},stringifyByChar:function(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return t},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length}catch(e){return!1}}()}};function h(e){var t=65536,n=i.getTypeOf(e),a=!0;if("uint8array"===n?a=c.applyCanBeUsed.uint8array:"nodebuffer"===n&&(a=c.applyCanBeUsed.nodebuffer),a)for(;1<t;)try{return c.stringifyByChunk(e,n,t)}catch(e){t=Math.floor(t/2)}return c.stringifyByChar(e)}function u(e,t){for(var i=0;i<e.length;i++)t[i]=e[i];return t}i.applyFromCharCode=h;var d={};d.string={string:o,array:function(e){return l(e,new Array(e.length))},arraybuffer:function(e){return d.string.uint8array(e).buffer},uint8array:function(e){return l(e,new Uint8Array(e.length))},nodebuffer:function(e){return l(e,r.allocBuffer(e.length))}},d.array={string:h,array:o,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBufferFrom(e)}},d.arraybuffer={string:function(e){return h(new Uint8Array(e))},array:function(e){return u(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:o,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBufferFrom(new Uint8Array(e))}},d.uint8array={string:h,array:function(e){return u(e,new Array(e.length))},arraybuffer:function(e){return e.buffer},uint8array:o,nodebuffer:function(e){return r.newBufferFrom(e)}},d.nodebuffer={string:h,array:function(e){return u(e,new Array(e.length))},arraybuffer:function(e){return d.nodebuffer.uint8array(e).buffer},uint8array:function(e){return u(e,new Uint8Array(e.length))},nodebuffer:o},i.transformTo=function(e,t){if(t=t||"",!e)return t;i.checkSupport(e);var n=i.getTypeOf(t);return d[n][e](t)},i.resolve=function(e){for(var t=e.split("/"),i=[],n=0;n<t.length;n++){var a=t[n];"."===a||""===a&&0!==n&&n!==t.length-1||(".."===a?i.pop():i.push(a))}return i.join("/")},i.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":n.nodebuffer&&r.isBuffer(e)?"nodebuffer":n.uint8array&&e instanceof Uint8Array?"uint8array":n.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(e){if(!n[e.toLowerCase()])throw new Error(e+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(e){var t,i,n="";for(i=0;i<(e||"").length;i++)n+="\\x"+((t=e.charCodeAt(i))<16?"0":"")+t.toString(16).toUpperCase();return n},i.delay=function(e,t,i){setImmediate((function(){e.apply(i||null,t||[])}))},i.inherits=function(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i},i.extend=function(){var e,t,i={};for(e=0;e<arguments.length;e++)for(t in arguments[e])Object.prototype.hasOwnProperty.call(arguments[e],t)&&void 0===i[t]&&(i[t]=arguments[e][t]);return i},i.prepareContent=function(e,t,r,o,c){return s.Promise.resolve(t).then((function(e){return n.blob&&(e instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(e)))&&"undefined"!=typeof FileReader?new s.Promise((function(t,i){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=function(e){i(e.target.error)},n.readAsArrayBuffer(e)})):e})).then((function(t){var h=i.getTypeOf(t);return h?("arraybuffer"===h?t=i.transformTo("uint8array",t):"string"===h&&(c?t=a.decode(t):r&&!0!==o&&(t=function(e){return l(e,n.uint8array?new Uint8Array(e.length):new Array(e.length))}(t))),t):s.Promise.reject(new Error("Can't read the data of '"+e+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))}))}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,t,i){var n=e("./reader/readerFor"),a=e("./utils"),r=e("./signature"),s=e("./zipEntry"),o=e("./support");function l(e){this.files=[],this.loadOptions=e}l.prototype={checkSignature:function(e){if(!this.reader.readAndCheckSignature(e)){this.reader.index-=4;var t=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+a.pretty(t)+", expected "+a.pretty(e)+")")}},isSignature:function(e,t){var i=this.reader.index;this.reader.setIndex(e);var n=this.reader.readString(4)===t;return this.reader.setIndex(i),n},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var e=this.reader.readData(this.zipCommentLength),t=o.uint8array?"uint8array":"array",i=a.transformTo(t,e);this.zipComment=this.loadOptions.decodeFileName(i)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,i,n=this.zip64EndOfCentralSize-44;0<n;)e=this.reader.readInt(2),t=this.reader.readInt(4),i=this.reader.readData(t),this.zip64ExtensibleData[e]={id:e,length:t,value:i}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8(),t.processAttributes()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(e=new s({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(e);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(e<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(e);var t=e;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===a.MAX_VALUE_16BITS||this.diskWithCentralDirStart===a.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===a.MAX_VALUE_16BITS||this.centralDirRecords===a.MAX_VALUE_16BITS||this.centralDirSize===a.MAX_VALUE_32BITS||this.centralDirOffset===a.MAX_VALUE_32BITS){if(this.zip64=!0,(e=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(e),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var i=this.centralDirOffset+this.centralDirSize;this.zip64&&(i+=20,i+=12+this.zip64EndOfCentralSize);var n=t-i;if(0<n)this.isSignature(t,r.CENTRAL_FILE_HEADER)||(this.reader.zero=n);else if(n<0)throw new Error("Corrupted zip: missing "+Math.abs(n)+" bytes.")},prepareReader:function(e){this.reader=n(e)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=l},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,t,i){var n=e("./reader/readerFor"),a=e("./utils"),r=e("./compressedObject"),s=e("./crc32"),o=e("./utf8"),l=e("./compressions"),c=e("./support");function h(e,t){this.options=e,this.loadOptions=t}h.prototype={isEncrypted:function(){return 1==(1&this.bitFlag)},useUTF8:function(){return 2048==(2048&this.bitFlag)},readLocalPart:function(e){var t,i;if(e.skip(22),this.fileNameLength=e.readInt(2),i=e.readInt(2),this.fileName=e.readData(this.fileNameLength),e.skip(i),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(t=function(e){for(var t in l)if(Object.prototype.hasOwnProperty.call(l,t)&&l[t].magic===e)return l[t];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,t,e.readData(this.compressedSize))},readCentralPart:function(e){this.versionMadeBy=e.readInt(2),e.skip(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4);var t=e.readInt(2);if(this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");e.skip(t),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var e=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==e&&(this.dosPermissions=63&this.externalFileAttributes),3==e&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var e=n(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=e.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=e.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=e.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=e.readInt(4))}},readExtraFields:function(e){var t,i,n,a=e.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});e.index+4<a;)t=e.readInt(2),i=e.readInt(2),n=e.readData(i),this.extraFields[t]={id:t,length:i,value:n};e.setIndex(a)},handleUTF8:function(){var e=c.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=o.utf8decode(this.fileName),this.fileCommentStr=o.utf8decode(this.fileComment);else{var t=this.findExtraFieldUnicodePath();if(null!==t)this.fileNameStr=t;else{var i=a.transformTo(e,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(i)}var n=this.findExtraFieldUnicodeComment();if(null!==n)this.fileCommentStr=n;else{var r=a.transformTo(e,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(r)}}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=n(e.value);return 1!==t.readInt(1)||s(this.fileName)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=n(e.value);return 1!==t.readInt(1)||s(this.fileComment)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null}},t.exports=h},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,t,i){function n(e,t,i){this.name=e,this.dir=i.dir,this.date=i.date,this.comment=i.comment,this.unixPermissions=i.unixPermissions,this.dosPermissions=i.dosPermissions,this._data=t,this._dataBinary=i.binary,this.options={compression:i.compression,compressionOptions:i.compressionOptions}}var a=e("./stream/StreamHelper"),r=e("./stream/DataWorker"),s=e("./utf8"),o=e("./compressedObject"),l=e("./stream/GenericWorker");n.prototype={internalStream:function(e){var t=null,i="string";try{if(!e)throw new Error("No output type specified.");var n="string"===(i=e.toLowerCase())||"text"===i;"binarystring"!==i&&"text"!==i||(i="string"),t=this._decompressWorker();var r=!this._dataBinary;r&&!n&&(t=t.pipe(new s.Utf8EncodeWorker)),!r&&n&&(t=t.pipe(new s.Utf8DecodeWorker))}catch(e){(t=new l("error")).error(e)}return new a(t,i,"")},async:function(e,t){return this.internalStream(e).accumulate(t)},nodeStream:function(e,t){return this.internalStream(e||"nodebuffer").toNodejsStream(t)},_compressWorker:function(e,t){if(this._data instanceof o&&this._data.compression.magic===e.magic)return this._data.getCompressedWorker();var i=this._decompressWorker();return this._dataBinary||(i=i.pipe(new s.Utf8EncodeWorker)),o.createWorkerFrom(i,e,t)},_decompressWorker:function(){return this._data instanceof o?this._data.getContentWorker():this._data instanceof l?this._data:new r(this._data)}};for(var c=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<c.length;u++)n.prototype[c[u]]=h;t.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,t,i){(function(e){var i,n,a=e.MutationObserver||e.WebKitMutationObserver;if(a){var r=0,s=new a(h),o=e.document.createTextNode("");s.observe(o,{characterData:!0}),i=function(){o.data=r=++r%2}}else if(e.setImmediate||void 0===e.MessageChannel)i="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){h(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(h,0)};else{var l=new e.MessageChannel;l.port1.onmessage=h,i=function(){l.port2.postMessage(0)}}var c=[];function h(){var e,t;n=!0;for(var i=c.length;i;){for(t=c,c=[],e=-1;++e<i;)t[e]();i=c.length}n=!1}t.exports=function(e){1!==c.push(e)||n||i()}}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(e,t,i){var n=e("immediate");function a(){}var r={},s=["REJECTED"],o=["FULFILLED"],l=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function h(e,t,i){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected)}function u(e,t,i){n((function(){var n;try{n=t(i)}catch(n){return r.reject(e,n)}n===e?r.reject(e,new TypeError("Cannot resolve promise with itself")):r.resolve(e,n)}))}function d(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var i=!1;function n(t){i||(i=!0,r.reject(e,t))}function a(t){i||(i=!0,r.resolve(e,t))}var s=m((function(){t(a,n)}));"error"===s.status&&n(s.value)}function m(e,t){var i={};try{i.value=e(t),i.status="success"}catch(e){i.status="error",i.value=e}return i}(t.exports=c).prototype.finally=function(e){if("function"!=typeof e)return this;var t=this.constructor;return this.then((function(i){return t.resolve(e()).then((function(){return i}))}),(function(i){return t.resolve(e()).then((function(){throw i}))}))},c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===o||"function"!=typeof t&&this.state===s)return this;var i=new this.constructor(a);return this.state!==l?u(i,this.state===o?e:t,this.outcome):this.queue.push(new h(i,e,t)),i},h.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},h.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},h.prototype.callRejected=function(e){r.reject(this.promise,e)},h.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},r.resolve=function(e,t){var i=m(d,t);if("error"===i.status)return r.reject(e,i.value);var n=i.value;if(n)p(e,n);else{e.state=o,e.outcome=t;for(var a=-1,s=e.queue.length;++a<s;)e.queue[a].callFulfilled(t)}return e},r.reject=function(e,t){e.state=s,e.outcome=t;for(var i=-1,n=e.queue.length;++i<n;)e.queue[i].callRejected(t);return e},c.resolve=function(e){return e instanceof this?e:r.resolve(new this(a),e)},c.reject=function(e){var t=new this(a);return r.reject(t,e)},c.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var i=e.length,n=!1;if(!i)return this.resolve([]);for(var s=new Array(i),o=0,l=-1,c=new this(a);++l<i;)h(e[l],l);return c;function h(e,a){t.resolve(e).then((function(e){s[a]=e,++o!==i||n||(n=!0,r.resolve(c,s))}),(function(e){n||(n=!0,r.reject(c,e))}))}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var i=e.length,n=!1;if(!i)return this.resolve([]);for(var s,o=-1,l=new this(a);++o<i;)s=e[o],t.resolve(s).then((function(e){n||(n=!0,r.resolve(l,e))}),(function(e){n||(n=!0,r.reject(l,e))}));return l}},{immediate:36}],38:[function(e,t,i){var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,t,i){var n=e("./zlib/deflate"),a=e("./utils/common"),r=e("./utils/strings"),s=e("./zlib/messages"),o=e("./zlib/zstream"),l=Object.prototype.toString,c=0,h=-1,u=0,d=8;function p(e){if(!(this instanceof p))return new p(e);this.options=a.assign({level:h,method:d,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},e||{});var t=this.options;t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new o,this.strm.avail_out=0;var i=n.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==c)throw new Error(s[i]);if(t.header&&n.deflateSetHeader(this.strm,t.header),t.dictionary){var m;if(m="string"==typeof t.dictionary?r.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(i=n.deflateSetDictionary(this.strm,m))!==c)throw new Error(s[i]);this._dict_set=!0}}function m(e,t){var i=new p(t);if(i.push(e,!0),i.err)throw i.msg||s[i.err];return i.result}p.prototype.push=function(e,t){var i,s,o=this.strm,h=this.options.chunkSize;if(this.ended)return!1;s=t===~~t?t:!0===t?4:0,"string"==typeof e?o.input=r.string2buf(e):"[object ArrayBuffer]"===l.call(e)?o.input=new Uint8Array(e):o.input=e,o.next_in=0,o.avail_in=o.input.length;do{if(0===o.avail_out&&(o.output=new a.Buf8(h),o.next_out=0,o.avail_out=h),1!==(i=n.deflate(o,s))&&i!==c)return this.onEnd(i),!(this.ended=!0);0!==o.avail_out&&(0!==o.avail_in||4!==s&&2!==s)||("string"===this.options.to?this.onData(r.buf2binstring(a.shrinkBuf(o.output,o.next_out))):this.onData(a.shrinkBuf(o.output,o.next_out)))}while((0<o.avail_in||0===o.avail_out)&&1!==i);return 4===s?(i=n.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===c):2!==s||(this.onEnd(c),!(o.avail_out=0))},p.prototype.onData=function(e){this.chunks.push(e)},p.prototype.onEnd=function(e){e===c&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Deflate=p,i.deflate=m,i.deflateRaw=function(e,t){return(t=t||{}).raw=!0,m(e,t)},i.gzip=function(e,t){return(t=t||{}).gzip=!0,m(e,t)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,t,i){var n=e("./zlib/inflate"),a=e("./utils/common"),r=e("./utils/strings"),s=e("./zlib/constants"),o=e("./zlib/messages"),l=e("./zlib/zstream"),c=e("./zlib/gzheader"),h=Object.prototype.toString;function u(e){if(!(this instanceof u))return new u(e);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=n.inflateInit2(this.strm,t.windowBits);if(i!==s.Z_OK)throw new Error(o[i]);this.header=new c,n.inflateGetHeader(this.strm,this.header)}function d(e,t){var i=new u(t);if(i.push(e,!0),i.err)throw i.msg||o[i.err];return i.result}u.prototype.push=function(e,t){var i,o,l,c,u,d,p=this.strm,m=this.options.chunkSize,f=this.options.dictionary,g=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?s.Z_FINISH:s.Z_NO_FLUSH,"string"==typeof e?p.input=r.binstring2buf(e):"[object ArrayBuffer]"===h.call(e)?p.input=new Uint8Array(e):p.input=e,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new a.Buf8(m),p.next_out=0,p.avail_out=m),(i=n.inflate(p,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&f&&(d="string"==typeof f?r.string2buf(f):"[object ArrayBuffer]"===h.call(f)?new Uint8Array(f):f,i=n.inflateSetDictionary(this.strm,d)),i===s.Z_BUF_ERROR&&!0===g&&(i=s.Z_OK,g=!1),i!==s.Z_STREAM_END&&i!==s.Z_OK)return this.onEnd(i),!(this.ended=!0);p.next_out&&(0!==p.avail_out&&i!==s.Z_STREAM_END&&(0!==p.avail_in||o!==s.Z_FINISH&&o!==s.Z_SYNC_FLUSH)||("string"===this.options.to?(l=r.utf8border(p.output,p.next_out),c=p.next_out-l,u=r.buf2string(p.output,l),p.next_out=c,p.avail_out=m-c,c&&a.arraySet(p.output,p.output,l,c,0),this.onData(u)):this.onData(a.shrinkBuf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(g=!0)}while((0<p.avail_in||0===p.avail_out)&&i!==s.Z_STREAM_END);return i===s.Z_STREAM_END&&(o=s.Z_FINISH),o===s.Z_FINISH?(i=n.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===s.Z_OK):o!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),!(p.avail_out=0))},u.prototype.onData=function(e){this.chunks.push(e)},u.prototype.onEnd=function(e){e===s.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Inflate=u,i.inflate=d,i.inflateRaw=function(e,t){return(t=t||{}).raw=!0,d(e,t)},i.ungzip=d},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,t,i){var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;i.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var n in i)i.hasOwnProperty(n)&&(e[n]=i[n])}}return e},i.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,i,n,a){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+n),a);else for(var r=0;r<n;r++)e[a+r]=t[i+r]},flattenChunks:function(e){var t,i,n,a,r,s;for(t=n=0,i=e.length;t<i;t++)n+=e[t].length;for(s=new Uint8Array(n),t=a=0,i=e.length;t<i;t++)r=e[t],s.set(r,a),a+=r.length;return s}},r={arraySet:function(e,t,i,n,a){for(var r=0;r<n;r++)e[a+r]=t[i+r]},flattenChunks:function(e){return[].concat.apply([],e)}};i.setTyped=function(e){e?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,a)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(n)},{}],42:[function(e,t,i){var n=e("./common"),a=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch(e){a=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){r=!1}for(var s=new n.Buf8(256),o=0;o<256;o++)s[o]=252<=o?6:248<=o?5:240<=o?4:224<=o?3:192<=o?2:1;function l(e,t){if(t<65537&&(e.subarray&&r||!e.subarray&&a))return String.fromCharCode.apply(null,n.shrinkBuf(e,t));for(var i="",s=0;s<t;s++)i+=String.fromCharCode(e[s]);return i}s[254]=s[254]=1,i.string2buf=function(e){var t,i,a,r,s,o=e.length,l=0;for(r=0;r<o;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(a=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(a-56320),r++),l+=i<128?1:i<2048?2:i<65536?3:4;for(t=new n.Buf8(l),r=s=0;s<l;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(a=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(a-56320),r++),i<128?t[s++]=i:(i<2048?t[s++]=192|i>>>6:(i<65536?t[s++]=224|i>>>12:(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63),t[s++]=128|i>>>6&63),t[s++]=128|63&i);return t},i.buf2binstring=function(e){return l(e,e.length)},i.binstring2buf=function(e){for(var t=new n.Buf8(e.length),i=0,a=t.length;i<a;i++)t[i]=e.charCodeAt(i);return t},i.buf2string=function(e,t){var i,n,a,r,o=t||e.length,c=new Array(2*o);for(i=n=0;i<o;)if((a=e[i++])<128)c[n++]=a;else if(4<(r=s[a]))c[n++]=65533,i+=r-1;else{for(a&=2===r?31:3===r?15:7;1<r&&i<o;)a=a<<6|63&e[i++],r--;1<r?c[n++]=65533:a<65536?c[n++]=a:(a-=65536,c[n++]=55296|a>>10&1023,c[n++]=56320|1023&a)}return l(c,n)},i.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;0<=i&&128==(192&e[i]);)i--;return i<0||0===i?t:i+s[e[i]]>t?i:t}},{"./common":41}],43:[function(e,t,i){t.exports=function(e,t,i,n){for(var a=65535&e|0,r=e>>>16&65535|0,s=0;0!==i;){for(i-=s=2e3<i?2e3:i;r=r+(a=a+t[n++]|0)|0,--s;);a%=65521,r%=65521}return a|r<<16|0}},{}],44:[function(e,t,i){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,t,i){var n=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();t.exports=function(e,t,i,a){var r=n,s=a+i;e^=-1;for(var o=a;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e}},{}],46:[function(e,t,i){var n,a=e("../utils/common"),r=e("./trees"),s=e("./adler32"),o=e("./crc32"),l=e("./messages"),c=0,h=4,u=0,d=-2,p=-1,m=4,f=2,g=8,y=9,v=286,b=30,_=19,x=2*v+1,w=15,S=3,M=258,T=M+S+1,A=42,E=113,C=1,I=2,P=3,R=4;function O(e,t){return e.msg=l[t],t}function D(e){return(e<<1)-(4<e?9:0)}function L(e){for(var t=e.length;0<=--t;)e[t]=0}function k(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(a.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function N(e,t){r._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,k(e.strm)}function B(e,t){e.pending_buf[e.pending++]=t}function z(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function U(e,t){var i,n,a=e.max_chain_length,r=e.strstart,s=e.prev_length,o=e.nice_match,l=e.strstart>e.w_size-T?e.strstart-(e.w_size-T):0,c=e.window,h=e.w_mask,u=e.prev,d=e.strstart+M,p=c[r+s-1],m=c[r+s];e.prev_length>=e.good_match&&(a>>=2),o>e.lookahead&&(o=e.lookahead);do{if(c[(i=t)+s]===m&&c[i+s-1]===p&&c[i]===c[r]&&c[++i]===c[r+1]){r+=2,i++;do{}while(c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&r<d);if(n=M-(d-r),r=d-M,s<n){if(e.match_start=t,o<=(s=n))break;p=c[r+s-1],m=c[r+s]}}}while((t=u[t&h])>l&&0!=--a);return s<=e.lookahead?s:e.lookahead}function F(e){var t,i,n,r,l,c,h,u,d,p,m=e.w_size;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=m+(m-T)){for(a.arraySet(e.window,e.window,m,m,0),e.match_start-=m,e.strstart-=m,e.block_start-=m,t=i=e.hash_size;n=e.head[--t],e.head[t]=m<=n?n-m:0,--i;);for(t=i=m;n=e.prev[--t],e.prev[t]=m<=n?n-m:0,--i;);r+=m}if(0===e.strm.avail_in)break;if(c=e.strm,h=e.window,u=e.strstart+e.lookahead,p=void 0,(d=r)<(p=c.avail_in)&&(p=d),i=0===p?0:(c.avail_in-=p,a.arraySet(h,c.input,c.next_in,p,u),1===c.state.wrap?c.adler=s(c.adler,h,p,u):2===c.state.wrap&&(c.adler=o(c.adler,h,p,u)),c.next_in+=p,c.total_in+=p,p),e.lookahead+=i,e.lookahead+e.insert>=S)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+S-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(e.lookahead+e.insert<S)););}while(e.lookahead<T&&0!==e.strm.avail_in)}function j(e,t){for(var i,n;;){if(e.lookahead<T){if(F(e),e.lookahead<T&&t===c)return C;if(0===e.lookahead)break}if(i=0,e.lookahead>=S&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+S-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-T&&(e.match_length=U(e,i)),e.match_length>=S)if(n=r._tr_tally(e,e.strstart-e.match_start,e.match_length-S),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=S){for(e.match_length--;e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+S-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart,0!=--e.match_length;);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(N(e,!1),0===e.strm.avail_out))return C}return e.insert=e.strstart<S-1?e.strstart:S-1,t===h?(N(e,!0),0===e.strm.avail_out?P:R):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?C:I}function H(e,t){for(var i,n,a;;){if(e.lookahead<T){if(F(e),e.lookahead<T&&t===c)return C;if(0===e.lookahead)break}if(i=0,e.lookahead>=S&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+S-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=S-1,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-T&&(e.match_length=U(e,i),e.match_length<=5&&(1===e.strategy||e.match_length===S&&4096<e.strstart-e.match_start)&&(e.match_length=S-1)),e.prev_length>=S&&e.match_length<=e.prev_length){for(a=e.strstart+e.lookahead-S,n=r._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-S),e.lookahead-=e.prev_length-1,e.prev_length-=2;++e.strstart<=a&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+S-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!=--e.prev_length;);if(e.match_available=0,e.match_length=S-1,e.strstart++,n&&(N(e,!1),0===e.strm.avail_out))return C}else if(e.match_available){if((n=r._tr_tally(e,0,e.window[e.strstart-1]))&&N(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return C}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=r._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<S-1?e.strstart:S-1,t===h?(N(e,!0),0===e.strm.avail_out?P:R):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?C:I}function G(e,t,i,n,a){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=a}function V(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*x),this.dyn_dtree=new a.Buf16(2*(2*b+1)),this.bl_tree=new a.Buf16(2*(2*_+1)),L(this.dyn_ltree),L(this.dyn_dtree),L(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(w+1),this.heap=new a.Buf16(2*v+1),L(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*v+1),L(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function W(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=f,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?A:E,e.adler=2===t.wrap?0:1,t.last_flush=c,r._tr_init(t),u):O(e,d)}function Y(e){var t=W(e);return t===u&&function(e){e.window_size=2*e.w_size,L(e.head),e.max_lazy_match=n[e.level].max_lazy,e.good_match=n[e.level].good_length,e.nice_match=n[e.level].nice_length,e.max_chain_length=n[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=S-1,e.match_available=0,e.ins_h=0}(e.state),t}function X(e,t,i,n,r,s){if(!e)return d;var o=1;if(t===p&&(t=6),n<0?(o=0,n=-n):15<n&&(o=2,n-=16),r<1||y<r||i!==g||n<8||15<n||t<0||9<t||s<0||m<s)return O(e,d);8===n&&(n=9);var l=new V;return(e.state=l).strm=e,l.wrap=o,l.gzhead=null,l.w_bits=n,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=r+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+S-1)/S),l.window=new a.Buf8(2*l.w_size),l.head=new a.Buf16(l.hash_size),l.prev=new a.Buf16(l.w_size),l.lit_bufsize=1<<r+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new a.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=s,l.method=i,Y(e)}n=[new G(0,0,0,0,(function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(F(e),0===e.lookahead&&t===c)return C;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+i;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,N(e,!1),0===e.strm.avail_out))return C;if(e.strstart-e.block_start>=e.w_size-T&&(N(e,!1),0===e.strm.avail_out))return C}return e.insert=0,t===h?(N(e,!0),0===e.strm.avail_out?P:R):(e.strstart>e.block_start&&(N(e,!1),e.strm.avail_out),C)})),new G(4,4,8,4,j),new G(4,5,16,8,j),new G(4,6,32,32,j),new G(4,4,16,16,H),new G(8,16,32,32,H),new G(8,16,128,128,H),new G(8,32,128,256,H),new G(32,128,258,1024,H),new G(32,258,258,4096,H)],i.deflateInit=function(e,t){return X(e,t,g,15,8,0)},i.deflateInit2=X,i.deflateReset=Y,i.deflateResetKeep=W,i.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?d:(e.state.gzhead=t,u):d},i.deflate=function(e,t){var i,a,s,l;if(!e||!e.state||5<t||t<0)return e?O(e,d):d;if(a=e.state,!e.output||!e.input&&0!==e.avail_in||666===a.status&&t!==h)return O(e,0===e.avail_out?-5:d);if(a.strm=e,i=a.last_flush,a.last_flush=t,a.status===A)if(2===a.wrap)e.adler=0,B(a,31),B(a,139),B(a,8),a.gzhead?(B(a,(a.gzhead.text?1:0)+(a.gzhead.hcrc?2:0)+(a.gzhead.extra?4:0)+(a.gzhead.name?8:0)+(a.gzhead.comment?16:0)),B(a,255&a.gzhead.time),B(a,a.gzhead.time>>8&255),B(a,a.gzhead.time>>16&255),B(a,a.gzhead.time>>24&255),B(a,9===a.level?2:2<=a.strategy||a.level<2?4:0),B(a,255&a.gzhead.os),a.gzhead.extra&&a.gzhead.extra.length&&(B(a,255&a.gzhead.extra.length),B(a,a.gzhead.extra.length>>8&255)),a.gzhead.hcrc&&(e.adler=o(e.adler,a.pending_buf,a.pending,0)),a.gzindex=0,a.status=69):(B(a,0),B(a,0),B(a,0),B(a,0),B(a,0),B(a,9===a.level?2:2<=a.strategy||a.level<2?4:0),B(a,3),a.status=E);else{var p=g+(a.w_bits-8<<4)<<8;p|=(2<=a.strategy||a.level<2?0:a.level<6?1:6===a.level?2:3)<<6,0!==a.strstart&&(p|=32),p+=31-p%31,a.status=E,z(a,p),0!==a.strstart&&(z(a,e.adler>>>16),z(a,65535&e.adler)),e.adler=1}if(69===a.status)if(a.gzhead.extra){for(s=a.pending;a.gzindex<(65535&a.gzhead.extra.length)&&(a.pending!==a.pending_buf_size||(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),k(e),s=a.pending,a.pending!==a.pending_buf_size));)B(a,255&a.gzhead.extra[a.gzindex]),a.gzindex++;a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),a.gzindex===a.gzhead.extra.length&&(a.gzindex=0,a.status=73)}else a.status=73;if(73===a.status)if(a.gzhead.name){s=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),k(e),s=a.pending,a.pending===a.pending_buf_size)){l=1;break}l=a.gzindex<a.gzhead.name.length?255&a.gzhead.name.charCodeAt(a.gzindex++):0,B(a,l)}while(0!==l);a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),0===l&&(a.gzindex=0,a.status=91)}else a.status=91;if(91===a.status)if(a.gzhead.comment){s=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),k(e),s=a.pending,a.pending===a.pending_buf_size)){l=1;break}l=a.gzindex<a.gzhead.comment.length?255&a.gzhead.comment.charCodeAt(a.gzindex++):0,B(a,l)}while(0!==l);a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),0===l&&(a.status=103)}else a.status=103;if(103===a.status&&(a.gzhead.hcrc?(a.pending+2>a.pending_buf_size&&k(e),a.pending+2<=a.pending_buf_size&&(B(a,255&e.adler),B(a,e.adler>>8&255),e.adler=0,a.status=E)):a.status=E),0!==a.pending){if(k(e),0===e.avail_out)return a.last_flush=-1,u}else if(0===e.avail_in&&D(t)<=D(i)&&t!==h)return O(e,-5);if(666===a.status&&0!==e.avail_in)return O(e,-5);if(0!==e.avail_in||0!==a.lookahead||t!==c&&666!==a.status){var m=2===a.strategy?function(e,t){for(var i;;){if(0===e.lookahead&&(F(e),0===e.lookahead)){if(t===c)return C;break}if(e.match_length=0,i=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(N(e,!1),0===e.strm.avail_out))return C}return e.insert=0,t===h?(N(e,!0),0===e.strm.avail_out?P:R):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?C:I}(a,t):3===a.strategy?function(e,t){for(var i,n,a,s,o=e.window;;){if(e.lookahead<=M){if(F(e),e.lookahead<=M&&t===c)return C;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=S&&0<e.strstart&&(n=o[a=e.strstart-1])===o[++a]&&n===o[++a]&&n===o[++a]){s=e.strstart+M;do{}while(n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&a<s);e.match_length=M-(s-a),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=S?(i=r._tr_tally(e,1,e.match_length-S),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(N(e,!1),0===e.strm.avail_out))return C}return e.insert=0,t===h?(N(e,!0),0===e.strm.avail_out?P:R):e.last_lit&&(N(e,!1),0===e.strm.avail_out)?C:I}(a,t):n[a.level].func(a,t);if(m!==P&&m!==R||(a.status=666),m===C||m===P)return 0===e.avail_out&&(a.last_flush=-1),u;if(m===I&&(1===t?r._tr_align(a):5!==t&&(r._tr_stored_block(a,0,0,!1),3===t&&(L(a.head),0===a.lookahead&&(a.strstart=0,a.block_start=0,a.insert=0))),k(e),0===e.avail_out))return a.last_flush=-1,u}return t!==h?u:a.wrap<=0?1:(2===a.wrap?(B(a,255&e.adler),B(a,e.adler>>8&255),B(a,e.adler>>16&255),B(a,e.adler>>24&255),B(a,255&e.total_in),B(a,e.total_in>>8&255),B(a,e.total_in>>16&255),B(a,e.total_in>>24&255)):(z(a,e.adler>>>16),z(a,65535&e.adler)),k(e),0<a.wrap&&(a.wrap=-a.wrap),0!==a.pending?u:1)},i.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==A&&69!==t&&73!==t&&91!==t&&103!==t&&t!==E&&666!==t?O(e,d):(e.state=null,t===E?O(e,-3):u):d},i.deflateSetDictionary=function(e,t){var i,n,r,o,l,c,h,p,m=t.length;if(!e||!e.state)return d;if(2===(o=(i=e.state).wrap)||1===o&&i.status!==A||i.lookahead)return d;for(1===o&&(e.adler=s(e.adler,t,m,0)),i.wrap=0,m>=i.w_size&&(0===o&&(L(i.head),i.strstart=0,i.block_start=0,i.insert=0),p=new a.Buf8(i.w_size),a.arraySet(p,t,m-i.w_size,i.w_size,0),t=p,m=i.w_size),l=e.avail_in,c=e.next_in,h=e.input,e.avail_in=m,e.next_in=0,e.input=t,F(i);i.lookahead>=S;){for(n=i.strstart,r=i.lookahead-(S-1);i.ins_h=(i.ins_h<<i.hash_shift^i.window[n+S-1])&i.hash_mask,i.prev[n&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=n,n++,--r;);i.strstart=n,i.lookahead=S-1,F(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=S-1,i.match_available=0,e.next_in=c,e.input=h,e.avail_in=l,i.wrap=o,u},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,t,i){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,t,i){t.exports=function(e,t){var i,n,a,r,s,o,l,c,h,u,d,p,m,f,g,y,v,b,_,x,w,S,M,T,A;i=e.state,n=e.next_in,T=e.input,a=n+(e.avail_in-5),r=e.next_out,A=e.output,s=r-(t-e.avail_out),o=r+(e.avail_out-257),l=i.dmax,c=i.wsize,h=i.whave,u=i.wnext,d=i.window,p=i.hold,m=i.bits,f=i.lencode,g=i.distcode,y=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;e:do{m<15&&(p+=T[n++]<<m,m+=8,p+=T[n++]<<m,m+=8),b=f[p&y];t:for(;;){if(p>>>=_=b>>>24,m-=_,0==(_=b>>>16&255))A[r++]=65535&b;else{if(!(16&_)){if(0==(64&_)){b=f[(65535&b)+(p&(1<<_)-1)];continue t}if(32&_){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}x=65535&b,(_&=15)&&(m<_&&(p+=T[n++]<<m,m+=8),x+=p&(1<<_)-1,p>>>=_,m-=_),m<15&&(p+=T[n++]<<m,m+=8,p+=T[n++]<<m,m+=8),b=g[p&v];i:for(;;){if(p>>>=_=b>>>24,m-=_,!(16&(_=b>>>16&255))){if(0==(64&_)){b=g[(65535&b)+(p&(1<<_)-1)];continue i}e.msg="invalid distance code",i.mode=30;break e}if(w=65535&b,m<(_&=15)&&(p+=T[n++]<<m,(m+=8)<_&&(p+=T[n++]<<m,m+=8)),l<(w+=p&(1<<_)-1)){e.msg="invalid distance too far back",i.mode=30;break e}if(p>>>=_,m-=_,(_=r-s)<w){if(h<(_=w-_)&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(M=d,(S=0)===u){if(S+=c-_,_<x){for(x-=_;A[r++]=d[S++],--_;);S=r-w,M=A}}else if(u<_){if(S+=c+u-_,(_-=u)<x){for(x-=_;A[r++]=d[S++],--_;);if(S=0,u<x){for(x-=_=u;A[r++]=d[S++],--_;);S=r-w,M=A}}}else if(S+=u-_,_<x){for(x-=_;A[r++]=d[S++],--_;);S=r-w,M=A}for(;2<x;)A[r++]=M[S++],A[r++]=M[S++],A[r++]=M[S++],x-=3;x&&(A[r++]=M[S++],1<x&&(A[r++]=M[S++]))}else{for(S=r-w;A[r++]=A[S++],A[r++]=A[S++],A[r++]=A[S++],2<(x-=3););x&&(A[r++]=A[S++],1<x&&(A[r++]=A[S++]))}break}}break}}while(n<a&&r<o);n-=x=m>>3,p&=(1<<(m-=x<<3))-1,e.next_in=n,e.next_out=r,e.avail_in=n<a?a-n+5:5-(n-a),e.avail_out=r<o?o-r+257:257-(r-o),i.hold=p,i.bits=m}},{}],49:[function(e,t,i){var n=e("../utils/common"),a=e("./adler32"),r=e("./crc32"),s=e("./inffast"),o=e("./inftrees"),l=1,c=2,h=0,u=-2,d=1,p=852,m=592;function f(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function y(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=d,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new n.Buf32(p),t.distcode=t.distdyn=new n.Buf32(m),t.sane=1,t.back=-1,h):u}function v(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,y(e)):u}function b(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?u:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,v(e))):u}function _(e,t){var i,n;return e?(n=new g,(e.state=n).window=null,(i=b(e,t))!==h&&(e.state=null),i):u}var x,w,S=!0;function M(e){if(S){var t;for(x=new n.Buf32(512),w=new n.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(l,e.lens,0,288,x,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(c,e.lens,0,32,w,0,e.work,{bits:5}),S=!1}e.lencode=x,e.lenbits=9,e.distcode=w,e.distbits=5}function T(e,t,i,a){var r,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new n.Buf8(s.wsize)),a>=s.wsize?(n.arraySet(s.window,t,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):(a<(r=s.wsize-s.wnext)&&(r=a),n.arraySet(s.window,t,i-a,r,s.wnext),(a-=r)?(n.arraySet(s.window,t,i-a,a,0),s.wnext=a,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}i.inflateReset=v,i.inflateReset2=b,i.inflateResetKeep=y,i.inflateInit=function(e){return _(e,15)},i.inflateInit2=_,i.inflate=function(e,t){var i,p,m,g,y,v,b,_,x,w,S,A,E,C,I,P,R,O,D,L,k,N,B,z,U=0,F=new n.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return u;12===(i=e.state).mode&&(i.mode=13),y=e.next_out,m=e.output,b=e.avail_out,g=e.next_in,p=e.input,v=e.avail_in,_=i.hold,x=i.bits,w=v,S=b,N=h;e:for(;;)switch(i.mode){case d:if(0===i.wrap){i.mode=13;break}for(;x<16;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(2&i.wrap&&35615===_){F[i.check=0]=255&_,F[1]=_>>>8&255,i.check=r(i.check,F,2,0),x=_=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&_)<<8)+(_>>8))%31){e.msg="incorrect header check",i.mode=30;break}if(8!=(15&_)){e.msg="unknown compression method",i.mode=30;break}if(x-=4,k=8+(15&(_>>>=4)),0===i.wbits)i.wbits=k;else if(k>i.wbits){e.msg="invalid window size",i.mode=30;break}i.dmax=1<<k,e.adler=i.check=1,i.mode=512&_?10:12,x=_=0;break;case 2:for(;x<16;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(i.flags=_,8!=(255&i.flags)){e.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=_>>8&1),512&i.flags&&(F[0]=255&_,F[1]=_>>>8&255,i.check=r(i.check,F,2,0)),x=_=0,i.mode=3;case 3:for(;x<32;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}i.head&&(i.head.time=_),512&i.flags&&(F[0]=255&_,F[1]=_>>>8&255,F[2]=_>>>16&255,F[3]=_>>>24&255,i.check=r(i.check,F,4,0)),x=_=0,i.mode=4;case 4:for(;x<16;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}i.head&&(i.head.xflags=255&_,i.head.os=_>>8),512&i.flags&&(F[0]=255&_,F[1]=_>>>8&255,i.check=r(i.check,F,2,0)),x=_=0,i.mode=5;case 5:if(1024&i.flags){for(;x<16;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}i.length=_,i.head&&(i.head.extra_len=_),512&i.flags&&(F[0]=255&_,F[1]=_>>>8&255,i.check=r(i.check,F,2,0)),x=_=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&(v<(A=i.length)&&(A=v),A&&(i.head&&(k=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),n.arraySet(i.head.extra,p,g,A,k)),512&i.flags&&(i.check=r(i.check,p,A,g)),v-=A,g+=A,i.length-=A),i.length))break e;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===v)break e;for(A=0;k=p[g+A++],i.head&&k&&i.length<65536&&(i.head.name+=String.fromCharCode(k)),k&&A<v;);if(512&i.flags&&(i.check=r(i.check,p,A,g)),v-=A,g+=A,k)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===v)break e;for(A=0;k=p[g+A++],i.head&&k&&i.length<65536&&(i.head.comment+=String.fromCharCode(k)),k&&A<v;);if(512&i.flags&&(i.check=r(i.check,p,A,g)),v-=A,g+=A,k)break e}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;x<16;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(_!==(65535&i.check)){e.msg="header crc mismatch",i.mode=30;break}x=_=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=12;break;case 10:for(;x<32;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}e.adler=i.check=f(_),x=_=0,i.mode=11;case 11:if(0===i.havedict)return e.next_out=y,e.avail_out=b,e.next_in=g,e.avail_in=v,i.hold=_,i.bits=x,2;e.adler=i.check=1,i.mode=12;case 12:if(5===t||6===t)break e;case 13:if(i.last){_>>>=7&x,x-=7&x,i.mode=27;break}for(;x<3;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}switch(i.last=1&_,x-=1,3&(_>>>=1)){case 0:i.mode=14;break;case 1:if(M(i),i.mode=20,6!==t)break;_>>>=2,x-=2;break e;case 2:i.mode=17;break;case 3:e.msg="invalid block type",i.mode=30}_>>>=2,x-=2;break;case 14:for(_>>>=7&x,x-=7&x;x<32;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if((65535&_)!=(_>>>16^65535)){e.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&_,x=_=0,i.mode=15,6===t)break e;case 15:i.mode=16;case 16:if(A=i.length){if(v<A&&(A=v),b<A&&(A=b),0===A)break e;n.arraySet(m,p,g,A,y),v-=A,g+=A,b-=A,y+=A,i.length-=A;break}i.mode=12;break;case 17:for(;x<14;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(i.nlen=257+(31&_),_>>>=5,x-=5,i.ndist=1+(31&_),_>>>=5,x-=5,i.ncode=4+(15&_),_>>>=4,x-=4,286<i.nlen||30<i.ndist){e.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;x<3;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}i.lens[j[i.have++]]=7&_,_>>>=3,x-=3}for(;i.have<19;)i.lens[j[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,B={bits:i.lenbits},N=o(0,i.lens,0,19,i.lencode,0,i.work,B),i.lenbits=B.bits,N){e.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;P=(U=i.lencode[_&(1<<i.lenbits)-1])>>>16&255,R=65535&U,!((I=U>>>24)<=x);){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(R<16)_>>>=I,x-=I,i.lens[i.have++]=R;else{if(16===R){for(z=I+2;x<z;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(_>>>=I,x-=I,0===i.have){e.msg="invalid bit length repeat",i.mode=30;break}k=i.lens[i.have-1],A=3+(3&_),_>>>=2,x-=2}else if(17===R){for(z=I+3;x<z;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}x-=I,k=0,A=3+(7&(_>>>=I)),_>>>=3,x-=3}else{for(z=I+7;x<z;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}x-=I,k=0,A=11+(127&(_>>>=I)),_>>>=7,x-=7}if(i.have+A>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=30;break}for(;A--;)i.lens[i.have++]=k}}if(30===i.mode)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,B={bits:i.lenbits},N=o(l,i.lens,0,i.nlen,i.lencode,0,i.work,B),i.lenbits=B.bits,N){e.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,B={bits:i.distbits},N=o(c,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,B),i.distbits=B.bits,N){e.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===t)break e;case 20:i.mode=21;case 21:if(6<=v&&258<=b){e.next_out=y,e.avail_out=b,e.next_in=g,e.avail_in=v,i.hold=_,i.bits=x,s(e,S),y=e.next_out,m=e.output,b=e.avail_out,g=e.next_in,p=e.input,v=e.avail_in,_=i.hold,x=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;P=(U=i.lencode[_&(1<<i.lenbits)-1])>>>16&255,R=65535&U,!((I=U>>>24)<=x);){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(P&&0==(240&P)){for(O=I,D=P,L=R;P=(U=i.lencode[L+((_&(1<<O+D)-1)>>O)])>>>16&255,R=65535&U,!(O+(I=U>>>24)<=x);){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}_>>>=O,x-=O,i.back+=O}if(_>>>=I,x-=I,i.back+=I,i.length=R,0===P){i.mode=26;break}if(32&P){i.back=-1,i.mode=12;break}if(64&P){e.msg="invalid literal/length code",i.mode=30;break}i.extra=15&P,i.mode=22;case 22:if(i.extra){for(z=i.extra;x<z;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}i.length+=_&(1<<i.extra)-1,_>>>=i.extra,x-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;P=(U=i.distcode[_&(1<<i.distbits)-1])>>>16&255,R=65535&U,!((I=U>>>24)<=x);){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(0==(240&P)){for(O=I,D=P,L=R;P=(U=i.distcode[L+((_&(1<<O+D)-1)>>O)])>>>16&255,R=65535&U,!(O+(I=U>>>24)<=x);){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}_>>>=O,x-=O,i.back+=O}if(_>>>=I,x-=I,i.back+=I,64&P){e.msg="invalid distance code",i.mode=30;break}i.offset=R,i.extra=15&P,i.mode=24;case 24:if(i.extra){for(z=i.extra;x<z;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}i.offset+=_&(1<<i.extra)-1,_>>>=i.extra,x-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===b)break e;if(A=S-b,i.offset>A){if((A=i.offset-A)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=30;break}E=A>i.wnext?(A-=i.wnext,i.wsize-A):i.wnext-A,A>i.length&&(A=i.length),C=i.window}else C=m,E=y-i.offset,A=i.length;for(b<A&&(A=b),b-=A,i.length-=A;m[y++]=C[E++],--A;);0===i.length&&(i.mode=21);break;case 26:if(0===b)break e;m[y++]=i.length,b--,i.mode=21;break;case 27:if(i.wrap){for(;x<32;){if(0===v)break e;v--,_|=p[g++]<<x,x+=8}if(S-=b,e.total_out+=S,i.total+=S,S&&(e.adler=i.check=i.flags?r(i.check,m,S,y-S):a(i.check,m,S,y-S)),S=b,(i.flags?_:f(_))!==i.check){e.msg="incorrect data check",i.mode=30;break}x=_=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;x<32;){if(0===v)break e;v--,_+=p[g++]<<x,x+=8}if(_!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=30;break}x=_=0}i.mode=29;case 29:N=1;break e;case 30:N=-3;break e;case 31:return-4;case 32:default:return u}return e.next_out=y,e.avail_out=b,e.next_in=g,e.avail_in=v,i.hold=_,i.bits=x,(i.wsize||S!==e.avail_out&&i.mode<30&&(i.mode<27||4!==t))&&T(e,e.output,e.next_out,S-e.avail_out)?(i.mode=31,-4):(w-=e.avail_in,S-=e.avail_out,e.total_in+=w,e.total_out+=S,i.total+=S,i.wrap&&S&&(e.adler=i.check=i.flags?r(i.check,m,S,e.next_out-S):a(i.check,m,S,e.next_out-S)),e.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0==w&&0===S||4===t)&&N===h&&(N=-5),N)},i.inflateEnd=function(e){if(!e||!e.state)return u;var t=e.state;return t.window&&(t.window=null),e.state=null,h},i.inflateGetHeader=function(e,t){var i;return e&&e.state?0==(2&(i=e.state).wrap)?u:((i.head=t).done=!1,h):u},i.inflateSetDictionary=function(e,t){var i,n=t.length;return e&&e.state?0!==(i=e.state).wrap&&11!==i.mode?u:11===i.mode&&a(1,t,n,0)!==i.check?-3:T(e,t,n,n)?(i.mode=31,-4):(i.havedict=1,h):u},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,t,i){var n=e("../utils/common"),a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,i,l,c,h,u,d){var p,m,f,g,y,v,b,_,x,w=d.bits,S=0,M=0,T=0,A=0,E=0,C=0,I=0,P=0,R=0,O=0,D=null,L=0,k=new n.Buf16(16),N=new n.Buf16(16),B=null,z=0;for(S=0;S<=15;S++)k[S]=0;for(M=0;M<l;M++)k[t[i+M]]++;for(E=w,A=15;1<=A&&0===k[A];A--);if(A<E&&(E=A),0===A)return c[h++]=20971520,c[h++]=20971520,d.bits=1,0;for(T=1;T<A&&0===k[T];T++);for(E<T&&(E=T),S=P=1;S<=15;S++)if(P<<=1,(P-=k[S])<0)return-1;if(0<P&&(0===e||1!==A))return-1;for(N[1]=0,S=1;S<15;S++)N[S+1]=N[S]+k[S];for(M=0;M<l;M++)0!==t[i+M]&&(u[N[t[i+M]]++]=M);if(v=0===e?(D=B=u,19):1===e?(D=a,L-=257,B=r,z-=257,256):(D=s,B=o,-1),S=T,y=h,I=M=O=0,f=-1,g=(R=1<<(C=E))-1,1===e&&852<R||2===e&&592<R)return 1;for(;;){for(b=S-I,x=u[M]<v?(_=0,u[M]):u[M]>v?(_=B[z+u[M]],D[L+u[M]]):(_=96,0),p=1<<S-I,T=m=1<<C;c[y+(O>>I)+(m-=p)]=b<<24|_<<16|x|0,0!==m;);for(p=1<<S-1;O&p;)p>>=1;if(0!==p?(O&=p-1,O+=p):O=0,M++,0==--k[S]){if(S===A)break;S=t[i+u[M]]}if(E<S&&(O&g)!==f){for(0===I&&(I=E),y+=T,P=1<<(C=S-I);C+I<A&&!((P-=k[C+I])<=0);)C++,P<<=1;if(R+=1<<C,1===e&&852<R||2===e&&592<R)return 1;c[f=O&g]=E<<24|C<<16|y-h|0}}return 0!==O&&(c[y+O]=S-I<<24|64<<16|0),d.bits=E,0}},{"../utils/common":41}],51:[function(e,t,i){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,t,i){var n=e("../utils/common"),a=0,r=1;function s(e){for(var t=e.length;0<=--t;)e[t]=0}var o=0,l=29,c=256,h=c+1+l,u=30,d=19,p=2*h+1,m=15,f=16,g=7,y=256,v=16,b=17,_=18,x=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],w=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],S=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],M=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],T=new Array(2*(h+2));s(T);var A=new Array(2*u);s(A);var E=new Array(512);s(E);var C=new Array(256);s(C);var I=new Array(l);s(I);var P,R,O,D=new Array(u);function L(e,t,i,n,a){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=a,this.has_stree=e&&e.length}function k(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function N(e){return e<256?E[e]:E[256+(e>>>7)]}function B(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function z(e,t,i){e.bi_valid>f-i?(e.bi_buf|=t<<e.bi_valid&65535,B(e,e.bi_buf),e.bi_buf=t>>f-e.bi_valid,e.bi_valid+=i-f):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function U(e,t,i){z(e,i[2*t],i[2*t+1])}function F(e,t){for(var i=0;i|=1&e,e>>>=1,i<<=1,0<--t;);return i>>>1}function j(e,t,i){var n,a,r=new Array(m+1),s=0;for(n=1;n<=m;n++)r[n]=s=s+i[n-1]<<1;for(a=0;a<=t;a++){var o=e[2*a+1];0!==o&&(e[2*a]=F(r[o]++,o))}}function H(e){var t;for(t=0;t<h;t++)e.dyn_ltree[2*t]=0;for(t=0;t<u;t++)e.dyn_dtree[2*t]=0;for(t=0;t<d;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*y]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function G(e){8<e.bi_valid?B(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function V(e,t,i,n){var a=2*t,r=2*i;return e[a]<e[r]||e[a]===e[r]&&n[t]<=n[i]}function W(e,t,i){for(var n=e.heap[i],a=i<<1;a<=e.heap_len&&(a<e.heap_len&&V(t,e.heap[a+1],e.heap[a],e.depth)&&a++,!V(t,n,e.heap[a],e.depth));)e.heap[i]=e.heap[a],i=a,a<<=1;e.heap[i]=n}function Y(e,t,i){var n,a,r,s,o=0;if(0!==e.last_lit)for(;n=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],a=e.pending_buf[e.l_buf+o],o++,0===n?U(e,a,t):(U(e,(r=C[a])+c+1,t),0!==(s=x[r])&&z(e,a-=I[r],s),U(e,r=N(--n),i),0!==(s=w[r])&&z(e,n-=D[r],s)),o<e.last_lit;);U(e,y,t)}function X(e,t){var i,n,a,r=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=p,i=0;i<l;i++)0!==r[2*i]?(e.heap[++e.heap_len]=c=i,e.depth[i]=0):r[2*i+1]=0;for(;e.heap_len<2;)r[2*(a=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[a]=0,e.opt_len--,o&&(e.static_len-=s[2*a+1]);for(t.max_code=c,i=e.heap_len>>1;1<=i;i--)W(e,r,i);for(a=l;i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],W(e,r,1),n=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=n,r[2*a]=r[2*i]+r[2*n],e.depth[a]=(e.depth[i]>=e.depth[n]?e.depth[i]:e.depth[n])+1,r[2*i+1]=r[2*n+1]=a,e.heap[1]=a++,W(e,r,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,n,a,r,s,o,l=t.dyn_tree,c=t.max_code,h=t.stat_desc.static_tree,u=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,f=t.stat_desc.extra_base,g=t.stat_desc.max_length,y=0;for(r=0;r<=m;r++)e.bl_count[r]=0;for(l[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<p;i++)g<(r=l[2*l[2*(n=e.heap[i])+1]+1]+1)&&(r=g,y++),l[2*n+1]=r,c<n||(e.bl_count[r]++,s=0,f<=n&&(s=d[n-f]),o=l[2*n],e.opt_len+=o*(r+s),u&&(e.static_len+=o*(h[2*n+1]+s)));if(0!==y){do{for(r=g-1;0===e.bl_count[r];)r--;e.bl_count[r]--,e.bl_count[r+1]+=2,e.bl_count[g]--,y-=2}while(0<y);for(r=g;0!==r;r--)for(n=e.bl_count[r];0!==n;)c<(a=e.heap[--i])||(l[2*a+1]!==r&&(e.opt_len+=(r-l[2*a+1])*l[2*a],l[2*a+1]=r),n--)}}(e,t),j(r,c,e.bl_count)}function Z(e,t,i){var n,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)a=s,s=t[2*(n+1)+1],++o<l&&a===s||(o<c?e.bl_tree[2*a]+=o:0!==a?(a!==r&&e.bl_tree[2*a]++,e.bl_tree[2*v]++):o<=10?e.bl_tree[2*b]++:e.bl_tree[2*_]++,r=a,c=(o=0)===s?(l=138,3):a===s?(l=6,3):(l=7,4))}function q(e,t,i){var n,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),n=0;n<=i;n++)if(a=s,s=t[2*(n+1)+1],!(++o<l&&a===s)){if(o<c)for(;U(e,a,e.bl_tree),0!=--o;);else 0!==a?(a!==r&&(U(e,a,e.bl_tree),o--),U(e,v,e.bl_tree),z(e,o-3,2)):o<=10?(U(e,b,e.bl_tree),z(e,o-3,3)):(U(e,_,e.bl_tree),z(e,o-11,7));r=a,c=(o=0)===s?(l=138,3):a===s?(l=6,3):(l=7,4)}}s(D);var J=!1;function Q(e,t,i,a){z(e,(o<<1)+(a?1:0),3),function(e,t,i,a){G(e),a&&(B(e,i),B(e,~i)),n.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}(e,t,i,!0)}i._tr_init=function(e){J||(function(){var e,t,i,n,a,r=new Array(m+1);for(n=i=0;n<l-1;n++)for(I[n]=i,e=0;e<1<<x[n];e++)C[i++]=n;for(C[i-1]=n,n=a=0;n<16;n++)for(D[n]=a,e=0;e<1<<w[n];e++)E[a++]=n;for(a>>=7;n<u;n++)for(D[n]=a<<7,e=0;e<1<<w[n]-7;e++)E[256+a++]=n;for(t=0;t<=m;t++)r[t]=0;for(e=0;e<=143;)T[2*e+1]=8,e++,r[8]++;for(;e<=255;)T[2*e+1]=9,e++,r[9]++;for(;e<=279;)T[2*e+1]=7,e++,r[7]++;for(;e<=287;)T[2*e+1]=8,e++,r[8]++;for(j(T,h+1,r),e=0;e<u;e++)A[2*e+1]=5,A[2*e]=F(e,5);P=new L(T,x,c+1,h,m),R=new L(A,w,0,u,m),O=new L(new Array(0),S,0,d,g)}(),J=!0),e.l_desc=new k(e.dyn_ltree,P),e.d_desc=new k(e.dyn_dtree,R),e.bl_desc=new k(e.bl_tree,O),e.bi_buf=0,e.bi_valid=0,H(e)},i._tr_stored_block=Q,i._tr_flush_block=function(e,t,i,n){var s,o,l=0;0<e.level?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return a;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return r;for(t=32;t<c;t++)if(0!==e.dyn_ltree[2*t])return r;return a}(e)),X(e,e.l_desc),X(e,e.d_desc),l=function(e){var t;for(Z(e,e.dyn_ltree,e.l_desc.max_code),Z(e,e.dyn_dtree,e.d_desc.max_code),X(e,e.bl_desc),t=d-1;3<=t&&0===e.bl_tree[2*M[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=s&&(s=o)):s=o=i+5,i+4<=s&&-1!==t?Q(e,t,i,n):4===e.strategy||o===s?(z(e,2+(n?1:0),3),Y(e,T,A)):(z(e,4+(n?1:0),3),function(e,t,i,n){var a;for(z(e,t-257,5),z(e,i-1,5),z(e,n-4,4),a=0;a<n;a++)z(e,e.bl_tree[2*M[a]+1],3);q(e,e.dyn_ltree,t-1),q(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,l+1),Y(e,e.dyn_ltree,e.dyn_dtree)),H(e),n&&G(e)},i._tr_tally=function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(C[i]+c+1)]++,e.dyn_dtree[2*N(t)]++),e.last_lit===e.lit_bufsize-1},i._tr_align=function(e){z(e,2,3),U(e,y,T),function(e){16===e.bi_valid?(B(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},{"../utils/common":41}],53:[function(e,t,i){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,t,i){(function(e){!function(e,t){if(!e.setImmediate){var i,n,a,r,s=1,o={},l=!1,c=e.document,h=Object.getPrototypeOf&&Object.getPrototypeOf(e);h=h&&h.setTimeout?h:e,i="[object process]"==={}.toString.call(e.process)?function(e){process.nextTick((function(){d(e)}))}:function(){if(e.postMessage&&!e.importScripts){var t=!0,i=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=i,t}}()?(r="setImmediate$"+Math.random()+"$",e.addEventListener?e.addEventListener("message",p,!1):e.attachEvent("onmessage",p),function(t){e.postMessage(r+t,"*")}):e.MessageChannel?((a=new MessageChannel).port1.onmessage=function(e){d(e.data)},function(e){a.port2.postMessage(e)}):c&&"onreadystatechange"in c.createElement("script")?(n=c.documentElement,function(e){var t=c.createElement("script");t.onreadystatechange=function(){d(e),t.onreadystatechange=null,n.removeChild(t),t=null},n.appendChild(t)}):function(e){setTimeout(d,0,e)},h.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var a={callback:e,args:t};return o[s]=a,i(s),s++},h.clearImmediate=u}function u(e){delete o[e]}function d(e){if(l)setTimeout(d,0,e);else{var i=o[e];if(i){l=!0;try{!function(e){var i=e.callback,n=e.args;switch(n.length){case 0:i();break;case 1:i(n[0]);break;case 2:i(n[0],n[1]);break;case 3:i(n[0],n[1],n[2]);break;default:i.apply(t,n)}}(i)}finally{u(e),l=!1}}}}function p(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(r)&&d(+t.data.slice(r.length))}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[10])(10)}));const Hg="function"==typeof atob,Gg="function"==typeof btoa,Vg="function"==typeof Buffer,Wg=("function"==typeof TextDecoder&&new TextDecoder,"function"==typeof TextEncoder&&new TextEncoder,Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=")),Yg=(e=>{let t={};return e.forEach(((e,i)=>t[e]=i)),t})(Wg),Xg=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Zg=String.fromCharCode.bind(String),qg="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(e,t=(e=>e))=>new Uint8Array(Array.prototype.slice.call(e,0).map(t)),Jg=e=>e.replace(/=/g,"").replace(/[+\/]/g,(e=>"+"==e?"-":"_")),Qg=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),Kg=e=>{let t,i,n,a,r="";const s=e.length%3;for(let s=0;s<e.length;){if((i=e.charCodeAt(s++))>255||(n=e.charCodeAt(s++))>255||(a=e.charCodeAt(s++))>255)throw new TypeError("invalid character found");t=i<<16|n<<8|a,r+=Wg[t>>18&63]+Wg[t>>12&63]+Wg[t>>6&63]+Wg[63&t]}return s?r.slice(0,s-3)+"===".substring(s):r},$g=Gg?e=>btoa(e):Vg?e=>Buffer.from(e,"binary").toString("base64"):Kg,ey=Vg?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let i=0,n=e.length;i<n;i+=4096)t.push(Zg.apply(null,e.subarray(i,i+4096)));return $g(t.join(""))},ty=(e,t=!1)=>t?Jg(ey(e)):ey(e),iy=e=>{if(e=e.replace(/\s+/g,""),!Xg.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));let t,i,n,a="";for(let r=0;r<e.length;)t=Yg[e.charAt(r++)]<<18|Yg[e.charAt(r++)]<<12|(i=Yg[e.charAt(r++)])<<6|(n=Yg[e.charAt(r++)]),a+=64===i?Zg(t>>16&255):64===n?Zg(t>>16&255,t>>8&255):Zg(t>>16&255,t>>8&255,255&t);return a},ny=Hg?e=>atob(Qg(e)):Vg?e=>Buffer.from(e,"base64").toString("binary"):iy,ay=Vg?e=>qg(Buffer.from(e,"base64")):e=>qg(ny(e),(e=>e.charCodeAt(0))),ry=e=>ay(sy(e)),sy=e=>Qg(e.replace(/[-_]/g,(e=>"-"==e?"+":"/"))),oy=ty,ly=ry;function cy(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}class hy{constructor({id:e=cy(),name:t="",type:i="color",source:n="",intensity:a=1}={}){this._id=e,this._name=t,this._type=i,this._source=n,this._intensity=a}get id(){return this._id}get name(){return this._name}set name(e){this._name=e}get type(){return this._type}set type(e){this._type=e}get source(){return this._source}set source(e){this._source=e}get intensity(){return this._intensity}set intensity(e){this._intensity=e}getCanvas({width:e,height:t,adjust:i="auto",pixelRatio:n=1}={}){if(this._source)switch(this._type.toLowerCase()){case"color":return this._colorCanvas||(this._colorCanvas=this.createColorCanvas({width:e,width:t})),this._colorCanvas;case"file":return;case"imagebitmap":return void(this._canvas||(this._canvas=this.createCanvas({width:e,width:t})))}}createCanvas({width:e,height:t,adjust:i}={}){if("imagebitmap"!==this._type)return;let n=document.createElement("canvas");return n.width=e||this._source.width,n.height=t||this._source.height,n.getContext("2d").drawImage(this._source,0,0),n}createColorCanvas({width:e,height:t}){let i=document.createElement("canvas");return i.width=e||64,i.height=t||64,i.getContext("2d").fillStyle=this._source||"#ffffaa",i.getContext("2d").fillRect(0,0,e||64,t||64),i}destroyCanvas(){this._canvas||this._canvas.parentElement.removeChild(this._canvas)}isColor(){return"color"===this._type.toLowerCase()}isFile(){return"file"===this._type.toLowerCase()}isImageBitmap(){return"imagebitmap"===this._type.toLowerCase()}isTexture(){return this.isFile()||this.isImageBitmap()}}hy._fromThreeObject=function(e,t){if(!e)return new hy({source:t});let i=new hy({id:e.uuid,name:e.name});return e.image&&(i.type="imagebitmap",i.source=e.image,i.intensity=1),i};let uy="numeric",dy="enum",py="boolean",my="text";
/**
   * [js-md5]{@link https://github.com/emn178/js-md5}
   *
   * @namespace md5
   * @version 0.7.3
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   */var fy=Ug((function(e){!function(){var t="input is invalid type",i="object"==typeof window,n=i?window:{};n.JS_MD5_NO_WINDOW&&(i=!1);var a=!i&&"object"==typeof self,r=!n.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;r?n=Bg:a&&(n=self);var s,o=!n.JS_MD5_NO_COMMON_JS&&e.exports,l=!n.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,c="0123456789abcdef".split(""),h=[128,32768,8388608,-2147483648],u=[0,8,16,24],d=["hex","array","digest","buffer","arrayBuffer","base64"],p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),m=[];if(l){var f=new ArrayBuffer(68);s=new Uint8Array(f),m=new Uint32Array(f)}!n.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!l||!n.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var g=function(e){return function(t){return new v(!0).update(t)[e]()}},y=function(e){var i=()=>"",n={};return function(a){if("string"==typeof a)return i("md5").update(a,"utf8").digest("hex");if(null==a)throw t;return a.constructor===ArrayBuffer&&(a=new Uint8Array(a)),Array.isArray(a)||ArrayBuffer.isView(a)||a.constructor===n?i("md5").update(new n(a)).digest("hex"):e(a)}};function v(e){if(e)m[0]=m[16]=m[1]=m[2]=m[3]=m[4]=m[5]=m[6]=m[7]=m[8]=m[9]=m[10]=m[11]=m[12]=m[13]=m[14]=m[15]=0,this.blocks=m,this.buffer8=s;else if(l){var t=new ArrayBuffer(68);this.buffer8=new Uint8Array(t),this.blocks=new Uint32Array(t)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}v.prototype.update=function(e){if(!this.finalized){var i,n=typeof e;if("string"!==n){if("object"!==n)throw t;if(null===e)throw t;if(l&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||l&&ArrayBuffer.isView(e)))throw t;i=!0}for(var a,r,s=0,o=e.length,c=this.blocks,h=this.buffer8;s<o;){if(this.hashed&&(this.hashed=!1,c[0]=c[16],c[16]=c[1]=c[2]=c[3]=c[4]=c[5]=c[6]=c[7]=c[8]=c[9]=c[10]=c[11]=c[12]=c[13]=c[14]=c[15]=0),i)if(l)for(r=this.start;s<o&&r<64;++s)h[r++]=e[s];else for(r=this.start;s<o&&r<64;++s)c[r>>2]|=e[s]<<u[3&r++];else if(l)for(r=this.start;s<o&&r<64;++s)(a=e.charCodeAt(s))<128?h[r++]=a:a<2048?(h[r++]=192|a>>6,h[r++]=128|63&a):a<55296||a>=57344?(h[r++]=224|a>>12,h[r++]=128|a>>6&63,h[r++]=128|63&a):(a=65536+((1023&a)<<10|1023&e.charCodeAt(++s)),h[r++]=240|a>>18,h[r++]=128|a>>12&63,h[r++]=128|a>>6&63,h[r++]=128|63&a);else for(r=this.start;s<o&&r<64;++s)(a=e.charCodeAt(s))<128?c[r>>2]|=a<<u[3&r++]:a<2048?(c[r>>2]|=(192|a>>6)<<u[3&r++],c[r>>2]|=(128|63&a)<<u[3&r++]):a<55296||a>=57344?(c[r>>2]|=(224|a>>12)<<u[3&r++],c[r>>2]|=(128|a>>6&63)<<u[3&r++],c[r>>2]|=(128|63&a)<<u[3&r++]):(a=65536+((1023&a)<<10|1023&e.charCodeAt(++s)),c[r>>2]|=(240|a>>18)<<u[3&r++],c[r>>2]|=(128|a>>12&63)<<u[3&r++],c[r>>2]|=(128|a>>6&63)<<u[3&r++],c[r>>2]|=(128|63&a)<<u[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},v.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[t>>2]|=h[3&t],t>=56&&(this.hashed||this.hash(),e[0]=e[16],e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.bytes<<3,e[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},v.prototype.hash=function(){var e,t,i,n,a,r,s=this.blocks;this.first?t=((t=((e=((e=s[0]-680876937)<<7|e>>>25)-271733879<<0)^(i=((i=(-271733879^(n=((n=(-1732584194^2004318071&e)+s[1]-117830708)<<12|n>>>20)+e<<0)&(-271733879^e))+s[2]-1126478375)<<17|i>>>15)+n<<0)&(n^e))+s[3]-1316259209)<<22|t>>>10)+i<<0:(e=this.h0,t=this.h1,i=this.h2,t=((t+=((e=((e+=((n=this.h3)^t&(i^n))+s[0]-680876936)<<7|e>>>25)+t<<0)^(i=((i+=(t^(n=((n+=(i^e&(t^i))+s[1]-389564586)<<12|n>>>20)+e<<0)&(e^t))+s[2]+606105819)<<17|i>>>15)+n<<0)&(n^e))+s[3]-1044525330)<<22|t>>>10)+i<<0),t=((t+=((e=((e+=(n^t&(i^n))+s[4]-176418897)<<7|e>>>25)+t<<0)^(i=((i+=(t^(n=((n+=(i^e&(t^i))+s[5]+1200080426)<<12|n>>>20)+e<<0)&(e^t))+s[6]-1473231341)<<17|i>>>15)+n<<0)&(n^e))+s[7]-45705983)<<22|t>>>10)+i<<0,t=((t+=((e=((e+=(n^t&(i^n))+s[8]+1770035416)<<7|e>>>25)+t<<0)^(i=((i+=(t^(n=((n+=(i^e&(t^i))+s[9]-1958414417)<<12|n>>>20)+e<<0)&(e^t))+s[10]-42063)<<17|i>>>15)+n<<0)&(n^e))+s[11]-1990404162)<<22|t>>>10)+i<<0,t=((t+=((e=((e+=(n^t&(i^n))+s[12]+1804603682)<<7|e>>>25)+t<<0)^(i=((i+=(t^(n=((n+=(i^e&(t^i))+s[13]-40341101)<<12|n>>>20)+e<<0)&(e^t))+s[14]-1502002290)<<17|i>>>15)+n<<0)&(n^e))+s[15]+1236535329)<<22|t>>>10)+i<<0,t=((t+=((n=((n+=(t^i&((e=((e+=(i^n&(t^i))+s[1]-165796510)<<5|e>>>27)+t<<0)^t))+s[6]-1069501632)<<9|n>>>23)+e<<0)^e&((i=((i+=(e^t&(n^e))+s[11]+643717713)<<14|i>>>18)+n<<0)^n))+s[0]-373897302)<<20|t>>>12)+i<<0,t=((t+=((n=((n+=(t^i&((e=((e+=(i^n&(t^i))+s[5]-701558691)<<5|e>>>27)+t<<0)^t))+s[10]+38016083)<<9|n>>>23)+e<<0)^e&((i=((i+=(e^t&(n^e))+s[15]-660478335)<<14|i>>>18)+n<<0)^n))+s[4]-405537848)<<20|t>>>12)+i<<0,t=((t+=((n=((n+=(t^i&((e=((e+=(i^n&(t^i))+s[9]+568446438)<<5|e>>>27)+t<<0)^t))+s[14]-1019803690)<<9|n>>>23)+e<<0)^e&((i=((i+=(e^t&(n^e))+s[3]-187363961)<<14|i>>>18)+n<<0)^n))+s[8]+1163531501)<<20|t>>>12)+i<<0,t=((t+=((n=((n+=(t^i&((e=((e+=(i^n&(t^i))+s[13]-1444681467)<<5|e>>>27)+t<<0)^t))+s[2]-51403784)<<9|n>>>23)+e<<0)^e&((i=((i+=(e^t&(n^e))+s[7]+1735328473)<<14|i>>>18)+n<<0)^n))+s[12]-1926607734)<<20|t>>>12)+i<<0,t=((t+=((r=(n=((n+=((a=t^i)^(e=((e+=(a^n)+s[5]-378558)<<4|e>>>28)+t<<0))+s[8]-2022574463)<<11|n>>>21)+e<<0)^e)^(i=((i+=(r^t)+s[11]+1839030562)<<16|i>>>16)+n<<0))+s[14]-35309556)<<23|t>>>9)+i<<0,t=((t+=((r=(n=((n+=((a=t^i)^(e=((e+=(a^n)+s[1]-1530992060)<<4|e>>>28)+t<<0))+s[4]+1272893353)<<11|n>>>21)+e<<0)^e)^(i=((i+=(r^t)+s[7]-155497632)<<16|i>>>16)+n<<0))+s[10]-1094730640)<<23|t>>>9)+i<<0,t=((t+=((r=(n=((n+=((a=t^i)^(e=((e+=(a^n)+s[13]+681279174)<<4|e>>>28)+t<<0))+s[0]-358537222)<<11|n>>>21)+e<<0)^e)^(i=((i+=(r^t)+s[3]-722521979)<<16|i>>>16)+n<<0))+s[6]+76029189)<<23|t>>>9)+i<<0,t=((t+=((r=(n=((n+=((a=t^i)^(e=((e+=(a^n)+s[9]-640364487)<<4|e>>>28)+t<<0))+s[12]-421815835)<<11|n>>>21)+e<<0)^e)^(i=((i+=(r^t)+s[15]+530742520)<<16|i>>>16)+n<<0))+s[2]-995338651)<<23|t>>>9)+i<<0,t=((t+=((n=((n+=(t^((e=((e+=(i^(t|~n))+s[0]-198630844)<<6|e>>>26)+t<<0)|~i))+s[7]+1126891415)<<10|n>>>22)+e<<0)^((i=((i+=(e^(n|~t))+s[14]-1416354905)<<15|i>>>17)+n<<0)|~e))+s[5]-57434055)<<21|t>>>11)+i<<0,t=((t+=((n=((n+=(t^((e=((e+=(i^(t|~n))+s[12]+1700485571)<<6|e>>>26)+t<<0)|~i))+s[3]-1894986606)<<10|n>>>22)+e<<0)^((i=((i+=(e^(n|~t))+s[10]-1051523)<<15|i>>>17)+n<<0)|~e))+s[1]-2054922799)<<21|t>>>11)+i<<0,t=((t+=((n=((n+=(t^((e=((e+=(i^(t|~n))+s[8]+1873313359)<<6|e>>>26)+t<<0)|~i))+s[15]-30611744)<<10|n>>>22)+e<<0)^((i=((i+=(e^(n|~t))+s[6]-1560198380)<<15|i>>>17)+n<<0)|~e))+s[13]+1309151649)<<21|t>>>11)+i<<0,t=((t+=((n=((n+=(t^((e=((e+=(i^(t|~n))+s[4]-145523070)<<6|e>>>26)+t<<0)|~i))+s[11]-1120210379)<<10|n>>>22)+e<<0)^((i=((i+=(e^(n|~t))+s[2]+718787259)<<15|i>>>17)+n<<0)|~e))+s[9]-343485551)<<21|t>>>11)+i<<0,this.first?(this.h0=e+1732584193<<0,this.h1=t-271733879<<0,this.h2=i-1732584194<<0,this.h3=n+271733878<<0,this.first=!1):(this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+i<<0,this.h3=this.h3+n<<0)},v.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,n=this.h3;return c[e>>4&15]+c[15&e]+c[e>>12&15]+c[e>>8&15]+c[e>>20&15]+c[e>>16&15]+c[e>>28&15]+c[e>>24&15]+c[t>>4&15]+c[15&t]+c[t>>12&15]+c[t>>8&15]+c[t>>20&15]+c[t>>16&15]+c[t>>28&15]+c[t>>24&15]+c[i>>4&15]+c[15&i]+c[i>>12&15]+c[i>>8&15]+c[i>>20&15]+c[i>>16&15]+c[i>>28&15]+c[i>>24&15]+c[n>>4&15]+c[15&n]+c[n>>12&15]+c[n>>8&15]+c[n>>20&15]+c[n>>16&15]+c[n>>28&15]+c[n>>24&15]},v.prototype.toString=v.prototype.hex,v.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,n=this.h3;return[255&e,e>>8&255,e>>16&255,e>>24&255,255&t,t>>8&255,t>>16&255,t>>24&255,255&i,i>>8&255,i>>16&255,i>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255]},v.prototype.array=v.prototype.digest,v.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(16),t=new Uint32Array(e);return t[0]=this.h0,t[1]=this.h1,t[2]=this.h2,t[3]=this.h3,e},v.prototype.buffer=v.prototype.arrayBuffer,v.prototype.base64=function(){for(var e,t,i,n="",a=this.array(),r=0;r<15;)e=a[r++],t=a[r++],i=a[r++],n+=p[e>>>2]+p[63&(e<<4|t>>>4)]+p[63&(t<<2|i>>>6)]+p[63&i];return e=a[r],n+=p[e>>>2]+p[e<<4&63]+"=="};var b=function(){var e=g("hex");r&&(e=y(e)),e.create=function(){return new v},e.update=function(t){return e.create().update(t)};for(var t=0;t<d.length;++t){var i=d[t];e[i]=g(i)}return e}();o?e.exports=b:n.md5=b}()}));class gy{constructor(e){var t=!1;this._type=e,this.pause=()=>{t=!0},this.resume=()=>{t=!1},this.update=e=>{t||"function"==typeof this.render&&this.render(e)},this.reset=()=>{},this.dispose=()=>{},this.getIsPaused=()=>t}get type(){return this._type}}class yy extends gy{constructor(e,t,i){super("DistanceController"),this.camera=e,this.object=t,this.object0=t,this.name=i,this.render=()=>{var e=this.camera.position.clone();if(null!=this.object)if(this.object.enableAutoHidebyDistance){if(null!=this.object.distance&&this.object.distance)var t=this.object.distance.distanceTo(e);else if(this.object.getWorldPosition)t=this.object.getWorldPosition(new Ce).distanceTo(e);else t=this.object.position.distanceTo(e);if(t>=this.object.minDistance&&t<=this.object.maxDistance){if(!this.object)return;{this.object.visible=this.object.activeVisible&&!0;const e=Ep.animationStore.findDrawableAnimation(this.object,"GeoGlobeVisibilityController");e&&(this.object.visible?e.resume():e.pause())}}else{if(!this.object)return;{this.object.visible=!1;const e=Ep.animationStore.findDrawableAnimation(this.object,"GeoGlobeVisibilityController");e&&e.pause()}}}else this.object.visible=this.object.activeVisible},this.reset=()=>{this.object=this.object0}}}yy.type="DistanceController",yy.prototype.isDistanceController=!0,window.logger={debug:function(){},info:function(){},warn:function(){},error:function(){},dir:function(){},time:function(){},timeEnd:function(){}},window.isDebug&&(window.logger={debug:console.debug.bind(window.console),info:console.info.bind(window.console),warn:console.warn.bind(window.console),error:console.error.bind(window.console),dir:console.dir.bind(window.console),time:console.time.bind(window.console),timeEnd:console.timeEnd.bind(window.console)});const vy=new Ce(0,1,0);Gm.defs("GEOCCS","+proj=geocent +datum=WGS84"),Gm.defs("WGS84","+proj=longlat +datum=WGS84 +no_defs"),Gm.defs("EPSG:3857","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs");var by=[],_y={degreeToRadian:(e=0)=>e/180*Math.PI,lookupSkyboxFogColor:(e,t)=>{let i="#cccccc";switch(t){case 4:e.toLowerCase().indexOf("skybox-day")>=0&&e.toLowerCase().indexOf("skybox-day2")<0&&(i="#919da9"),e.toLowerCase().indexOf("skybox-dusk")>=0&&(i="#a68d7c"),e.toLowerCase().indexOf("skybox-night")>=0&&(i="#1f5074"),e.toLowerCase().indexOf("skybox-day2")>=0&&(i="#94a8ac"),e.toLowerCase().indexOf("skybox-white")>=0&&(i="#7d8d98"),e.toLowerCase().indexOf("skybox-blue")>=0&&(i="#021629"),e.toLowerCase().indexOf("skybox-blue07")>=0&&(i="#053452"),e.toLowerCase().indexOf("skybox-real")>=0&&(i="#081225"),e.toLowerCase().indexOf("skyboxsun25deg")>=0&&(i="#a7a399"),e.toLowerCase().indexOf("pisa")>=0&&(i="#9a805b"),e.toLowerCase().indexOf("skybox-day-10")>=0&&(i="#a4d9e7"),e.toLowerCase().indexOf("skybox-day-18")>=0&&(i="#bae1f0"),e.toLowerCase().indexOf("skybox-dusk-4")>=0&&(i="#e79f86"),e.toLowerCase().indexOf("skybox-dusk-6")>=0&&(i="#d1ab87"),e.toLowerCase().indexOf("skybox-night-3")>=0&&(i="#20517a"),e.toLowerCase().indexOf("skybox-night-24")>=0&&(i="#11192c");break;default:e.toLowerCase().indexOf("skybox-day")>=0&&e.toLowerCase().indexOf("skybox-day2")<0&&(i="#a0bee0"),e.toLowerCase().indexOf("skybox-dusk")>=0&&(i="#d39c7d"),e.toLowerCase().indexOf("skybox-night")>=0&&(i="#20517a"),e.toLowerCase().indexOf("skybox-day2")>=0&&(i="#94a8ac"),e.toLowerCase().indexOf("skybox-white")>=0&&(i="#7d8d98"),e.toLowerCase().indexOf("skybox-blue")>=0&&(i="#021629"),e.toLowerCase().indexOf("skybox-blue07")>=0&&(i="#053452"),e.toLowerCase().indexOf("skybox-real")>=0&&(i="#081225"),e.toLowerCase().indexOf("skyboxsun25deg")>=0&&(i="#a7a399"),e.toLowerCase().indexOf("pisa")>=0&&(i="#9a805b"),e.toLowerCase().indexOf("skybox-day-10")>=0&&(i="#a4d8e6"),e.toLowerCase().indexOf("skybox-day-18")>=0&&(i="#a4d8e6"),e.toLowerCase().indexOf("skybox-dusk-4")>=0&&(i="#e79f86"),e.toLowerCase().indexOf("skybox-dusk-6")>=0&&(i="#d1ab87"),e.toLowerCase().indexOf("skybox-night-3")>=0&&(i="#20517a"),e.toLowerCase().indexOf("skybox-night-24")>=0&&(i="#11192c"),e.toLowerCase().indexOf("sdr-none")>=0&&(i="#343434"),e.toLowerCase().indexOf("sdr-studio-03")>=0&&(i="#d1d1c9")}const n=new Qt(i);switch(Ep.renderer.outputEncoding){case te:n.convertLinearToSRGB();break;case ie:n.convertLinearToGamma()}return`#${n.getHexString()}`},findModelInThree:(e,t)=>{if(!e||!t)return;let i;return e.children instanceof Array&&e.children.length>0&&(i=e.children.find((e=>e.name===t))),i},findNodeInThree:(e,t)=>{if(!e||!t)return;let i;return e.children instanceof Array&&e.children.length>0&&e.traverse((e=>{e.name===t&&(i=e)})),i},findNodeRecursively:(e,t)=>{if(t&&t.children&&t.children instanceof Array&&0!==t.children.length)for(let i of t.children){if(i.name===e)return i;if(i.children instanceof Array&&i.children.length>0){let t=_y.findNodeRecursively(e,i);if(t)return t}}},setThreePropertyRecursively:(e,t,i)=>{logger.debug("TRACE: util.setThreePropertyRecursively() - Entering.",e,t,i),e.children instanceof Array&&e.children.length>0&&e.traverse((e=>{e.isPoints||"cashShadow"!==t||(logger.debug("TRACE: util.setThreePropertyRecursively() - traverse.",e,t,i,_y.clone(i)),e[t]=_y.clone(i))})),logger.debug("TRACE: util.setThreePropertyRecursively() - Exiting.")},setNodePropertyRecursively:(e,t,i)=>{if(logger.debug("TRACE: util.setNodePropertyRecursively() - Entering.",e,t,i),e.children&&e.children instanceof Array&&0!==e.children.length){for(let n of e.children)logger.debug("TRACE: util.setNodePropertyRecursively() - traverse.",n,t,i,_y.clone(i)),n[t]=_y.clone(i),n.children instanceof Array&&n.children.length>0&&_y.setNodePropertyRecursively(n,t,i);logger.debug("TRACE: util.setNodePropertyRecursively() - Exiting.")}else logger.debug("TRACE: util.setNodePropertyRecursively() - Exiting.")},capableForCastingShadow:e=>!!e&&("Object3D"===e.type||"Group"===e.type||e.isMesh),genCubeUrls:(e,t)=>[(e=(e+"///").replace("////","/").replace("///","/"))+"px"+(t=("."+t).replace("..",".")),e+"nx"+t,e+"py"+t,e+"ny"+t,e+"pz"+t,e+"nz"+t],genEquirectangularUrl:(e,t)=>(e=(e+"///").replace("////","").replace("///",""))+(t=t?("."+t).replace("..","."):""),url:(e,t)=>`${e||""}///${t||""}`.replace("/////","/").replace("////","/").replace("///","/"),numberOrDefault:(e,t)=>"number"==typeof e?e:t,isBoolean:e=>"boolean"==typeof e,isNumber:e=>"number"==typeof e,isCSSColor:e=>/^#[0-9a-fA-F]{6}$/.test(e),isFunction:e=>"[object Function]"===Object.prototype.toString.call(e),deepEq(e,t,i,n){var a=Object.prototype.toString.call(e);if(a!==Object.prototype.toString.call(t))return!1;switch(a){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t}var r="[object Array]"===a;if(!r){if("object"!=typeof e||"object"!=typeof t)return!1;var s=e.constructor,o=t.constructor;if(s==o&&!(this.isFunction(s)&&s instanceof s&&this.isFunction(o)&&o instanceof o)&&"constructor"in e&&"constructor"in t)return!1}n=n||[];for(var l=(i=i||[]).length;l--;)if(i[l]===e)return n[l]===t;if(i.push(e),n.push(t),r){if((l=e.length)!==t.length)return!1;for(;l--;)if(!this.eq(e[l],t[l],i,n))return!1}else{var c,h=Object.keys(e);if(l=h.length,Object.keys(t).length!==l)return!1;for(;l--;)if(c=h[l],!t.hasOwnProperty(c)||!this.eq(e[c],t[c],i,n))return!1}return i.pop(),n.pop(),!0},eq(e,t,i,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var a=typeof e;return("function"===a||"object"===a||"object"==typeof t)&&this.deepEq(e,t,i,n)},clone:e=>{var t;if(logger.info("util.clone(): clone obj:",e),e instanceof Array){t=[];for(var i=e.length;i--;)t[i]=_y.clone(e[i]);return t}if(e instanceof Object){for(var n in t={},e)t[n]=_y.clone(e[n]);return t}return e},getSettingsRecursively:e=>{if(void 0!==e&&e){if("function"==typeof e)return"()";var t;if(e instanceof Array){t=[];for(let a=0;a<e.length;a++)if("PackedItem"===e[a].type||"FolderItem"===e[a].type||"BuildingItem"===e[a].type||"BuildingFloorItem"===e[a].type||"BuildingRoomItem"===e[a].type)if(e[a].children.length>0){(i=e[a].getSettings()).children=_y.getSettingsRecursively(e[a].children),t.push(i)}else{var i=e[a].getSettings();t.push(i)}else if("ModelItem"===e[a].type||"IconAsset"===e[a].type||"GroupItem"===e[a].type||"PaintItem"===e[a].type||"TileSetItem"===e[a].type||"GisItem"===e[a].type||"LineItem"===e[a].type||"PaperCutItem"===e[a].type||"PluginItem"===e[a].type){var n=e[a].getSettings();t.push(n)}return t}if(e instanceof Object){for(var a in t={},e)t[a]=_y.getSettingsRecursively(e[a]);return t}return e}},deepClone:e=>{if(e){var t=e instanceof Array?[]:{};for(let i in e)"object"==typeof e[i]?t[i]=_y.deepClone(e[i]):t[i]=e[i];return t}},isObject:e=>"object"==typeof e&&null!=e,cloneDeep:(e,t=new WeakMap)=>{if(!_y.isObject(e))return e;if(t.has(e))return t.get(e);if([Date,RegExp,Set,Map,WeakMap,WeakSet].includes(e.constructor))return new e.constructor(e);if(e instanceof Array)return[...e];const i=Object.getOwnPropertyDescriptors(e),n=Object.create(Object.getPrototypeOf(e),i);t.set(e,n);for(let i of Reflect.ownKeys(e))n[i]=_y.isObject(e[i])?_y.cloneDeep(e[i],t):e[i];return n},guid:()=>{function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},randomString:e=>{e=e||32;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",i=t.length,n="",a=0;a<e;a++)n+=t.charAt(Math.floor(Math.random()*i));return n},colorMultiply:(e,t)=>{if("number"!=typeof t)return e;t<0&&(t=0),t>1&&(t=1);let i=_y.colorToInteger(e);return _y.integerToColor(i*t)},integerToColor:e=>"number"!=typeof e?"#ffffff":"#{colorInt.toString(16)}",colorToInteger:e=>"string"!=typeof e?16777215:("#"===e.charAt(0)&&(e=e.substring(1)),parseInt(`0x${e}`)),colorToRGBAObject:e=>"string"!=typeof(e=""+e)?{r:1,g:1,b:1,a:1}:("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:1}:/^[0-9a-fA-F]{8}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:parseInt(e.substr(6,2),16)/255}:void 0),colorToRGBAString:e=>"string"!=typeof(e=""+e)?"rgba (1, 1, 1, 1)":("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, 1)`:/^[0-9a-fA-F]{8}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, ${parseInt(e.substr(6,2),16)/255})`:void 0),rgbAStringToColor:e=>"#"+((1<<24)+(255*e.r<<16)+(255*e.g<<8)+255*e.b).toString(16).substring(1),randomRGBAObject:()=>({r:Math.random(),g:Math.random(),b:Math.random(),a:.5+.5*Math.random()}),randomRGBAString:()=>`rgba (${Math.random()}, ${Math.random()}, ${Math.random()}, ${.5+.5*Math.random()})`,addDegrees:(e,t)=>e&&t&&e.lon&&e.lat&&t.lon&&t.lat?{lon:e.lon+t.lon,lat:e.lat+t.lat,alt:e.alt?t.alt?e.alt+t.alt:e.alt:t.alt?t.alt:0}:{lon:0,lat:0,alt:0},unifyCoordinates:(e,t)=>{if(t){switch("surface"===e.type.toLowerCase()&&(e.type="Surface"),"ecef"===e.type.toLowerCase()&&(e.type="ECEF"),"planarglobal"===e.type.toLowerCase()&&(e.type="PlanarGlobal"),"planarlocal"===e.type.toLowerCase()&&(e.type="PlanarLocal"),"default"===e.type.toLowerCase()&&(e.type="default"),e.type.toLowerCase()){case"surface":let i=t({X:e.lon,Y:e.lat,Z:e.alt},"Surface");e.x=i.x,e.y=0-i.z,e.z=0-i.y}return e}},findMeshByMaterial:(e,t,i)=>{if("function"!=typeof e.traverse)return[];let n=[];return e.traverse((e=>{if(e.material&&e.material===t&&n.push(e),e.material instanceof Array)for(let i of e.material)if(i===t){n.push(e);break}if(i instanceof Array)for(let t of i)if(e.material&&e.material===t&&n.push(e),e.material instanceof Array)for(let i of e.material)if(i===t){n.push(e);break}})),n},fetchJSON:(e,t="GET",i,n)=>{switch(t.toLowerCase()){case"get":case"delete":case"head":case"post":case"put":break;default:t="GET"}return new Promise((function(a,r){let s=new XMLHttpRequest;if(s.onreadystatechange=function(){4==s.readyState&&(200==s.status||204==s.status||304==s.status?a(s.responseText):r(new Error(s.statusText)))},s.open(t,e,!0),i instanceof Array)for(let e of i)s.setRequestHeader(e.key,e.value);s.send(JSON.stringify(n))}))},fetchContentLength:(e,t,i)=>new Promise((function(n,a){let r=new XMLHttpRequest;if(r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status||204==r.status||304==r.status){let e=r.getResponseHeader("Content-Length");n(e)}else{if(404==r.status||405==r.status)return;a(new Error(r.statusText))}},r.open("HEAD",e,!0),t instanceof Array)for(let e of t)r.setRequestHeader(e.key,e.value);r.send(JSON.stringify(i))})),fetchContentLastModified:(e,t,i)=>new Promise((function(n,a){try{if(!e||""===e)return void a();0===e.indexOf("data:")&&n("0");let r=new XMLHttpRequest;if(r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status||204==r.status||304==r.status){let e=r.getResponseHeader("Last-Modified");n(e,"")}else{if(404==r.status||405==r.status)return;a(new Error(r.statusText))}},r.open("HEAD",e,!0),t instanceof Array)for(let e of t)r.setRequestHeader(e.key,e.value);r.send(JSON.stringify(i))}catch(e){a(e)}})),applyVertexColors(e,t){const i=e.attributes.position,n=[];for(let e=0;e<i.count;e++)n.push(t.r,t.g,t.b);e.setAttribute("color",new hi(n,3))},formatWithRegex:e=>(e+"").replace(/\d{1,3}(?=(\d{3})+$)/g,"$&,"),isImage:e=>"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof Image&&e instanceof Image,lonLatToWebMercator:(e,t)=>{if("number"!=typeof e||"number"!=typeof t)return{x:0,y:0};let i=20037508.34*e/180,n=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return n=20037508.34*n/180,{x:i,y:n}},getLayerFromItem:e=>{if("PaintItem"!==e.parent.type&&"GroupItem"!==e.parent.type&&"PaintGroup"!==e.parent.type){let t=_y.getLayerFromItem(e.parent);if(t)return t}else{let t=Ep.defaultObjectTree.getItemByUUID(e.uuid);if(t&&("ModelItem"===t.type||"IconAsset"===t.type||"BuildingItem"===t.type||"PaperCutItem"===t.type))return t;{let t=_y.getNodelFromModelItem(e.parent);if(t)return t}}},getNodelFromModelItem:e=>{if("Group"!=e.parent.type){let t=_y.getNodelFromModelItem(e.parent);if(t)return t}else{let t=Ep.defaultObjectTree.getItemByUUID(e.uuid);if(t&&("ModelItem"===t.type||"ModelAsset"===t.type||"PaintItem"===t.type||"IconAsset"===t.type||"BuildingItem"===t.type))return t;{let t=_y.getNodelFromModelItem(e.parent);if(t)return t}}},nodeInModelItem:(e,t)=>{for(let i=0;i<e.length;i++)if("ModelItem"===e[i].type){if(_y.nodeInModelItemRecursion(e[i].children,t))return e[i]}else if("IconAsset"===e[i].type){if(_y.judegIconAssetFromClick(e[i].name,t))return e[i]}else if("BuildingFloorItem"===e[i].type)for(let n=0;n<e[i].children.length;n++)if("ModelItem"===e[i].children[n].type){if(_y.nodeInModelItemRecursion(e[i].children[n].children,t))return e[i].children[n]}else if("IconAsset"===e[i].children[n].type&&_y.judegIconAssetFromClick(e[i].children[n].name,t))return e[i].children[n]},nodeInModelItemRecursion:(e,t)=>{for(let i=0;i<e.length;i++){if(e[i].name===t)return e[i];if(e[i].children.length>0){let n=_y.nodeInModelItemRecursion(e[i].children,t);if(n)return n}}},judegIconAssetFromClick:(e,t)=>e+"底图"===t||e+"文字"===t||e+"图标"===t,getModelTransform:e=>{var t={};return t.position=JSON.parse(JSON.stringify(e.position)),t.rotation=JSON.parse(JSON.stringify(e.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(e.scale)),t.rotation.x=t.rotation._x=ge.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=ge.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=ge.radToDeg(t.rotation._z),t},getCopyName:(e,t=0,i)=>{let n;return n=t?`${e}${t}`:`${e}`,i.getItemByName(n)?_y.getCopyName(e,t+1,i):n},changeTransformFromBuilding:(e,t,i,n)=>(e.transform.position.x=(e.transform.position.x-t.position.x)/t.scale.x,e.transform.position.y=(e.transform.position.y-t.position.y)/t.scale.y,e.transform.position.z=(e.transform.position.z-t.position.z)/t.scale.z,i||n?n?(e.transform.position.x=(e.transform.position.x-n.position.x)/n.scale.x,e.transform.position.y=(e.transform.position.y-n.position.y)/n.scale.y,e.transform.position.z=(e.transform.position.z-n.position.z)/n.scale.z,e):(e.transform.position.x=(e.transform.position.x-i.position.x)/i.scale.x,e.transform.position.y=(e.transform.position.y-i.position.y)/i.scale.y,e.transform.position.z=(e.transform.position.z-i.position.z)/i.scale.z,e):e),changeTransformFromScene:(e,t,i,n)=>{let a=JSON.parse(JSON.stringify(e.transform)),r=new Ce,s=(t.position.x+e.transform.position.x)*t.scale.x,o=(t.position.y+e.transform.position.y)*t.scale.y,l=(t.position.z+e.transform.position.z)*t.scale.z;if(r.set(s,o,l),a.position=r,i||n){if(n){let e=new Ce,t=(n.position.x+a.position.x)*n.scale.x,i=(n.position.y+a.position.y)*n.scale.y,r=(n.position.z+a.position.z)*n.scale.z;return e.set(t,i,r),a.position=e,a}{let e=new Ce,t=(i.position.x+a.position.x)*i.scale.x,n=(i.position.y+a.position.y)*i.scale.y,r=(i.position.z+a.position.z)*i.scale.z;return e.set(t,n,r),a.position=e,a}}return a},addAllParentPosition:(e,t)=>{if(!e.parent||!e.parent.position)return t;{t.set(t.x+e.parent.position.x,t.y+e.parent.position.y,t.z+e.parent.position.z);let i=_y.addAllParentPosition(e.parent,t);if(i)return i}},recoverShowGetSettings:(e,t)=>{for(let i=0;i<e.length;i++)t[i].isVisible=e[i].isVisible,e[i].children&&e[i].children.length>0&&"ModelItem"!=t[i].type&&_y.recoverShowGetSettings(e[i].children,t[i].children)},recoverShow:(e,t)=>{for(let i=0;i<e.length;i++)t[i].isVisible=e[i].isVisible,e[i].children&&e[i].children.length>0&&_y.recoverShow(e[i].children,t[i].children)},recoverIsShowOrHide:(e,t)=>{if(e)for(let i=0;i<e.length;i++)e[i].isVisible?t[i].show():t[i].hide(),e[i].children&&e[i].children.length>0&&"ModelItem"!=t[i].type&&"PaintItem"!=t[i].type&&_y.recoverIsShowOrHide(e[i].children,t[i].children)},setObjectTreeIsHideRecursion:e=>{for(let t=0;t<e.length;t++)"ModelItem"===e[t].type||"IconAsset"===e[t].type||"GroupItem"===e[t].type||"PaintItem"===e[t].type||"LineItem"===e[t].type||"PaperCutItem"===e[t].type||"TileSetItem"===e[t].type||"PackedItem"===e[t].type||"PluginItem"===e[t].type?e[t].hide():e[t].children&&e[t].children.length>0&&_y.setObjectTreeIsHideRecursion(e[t].children)},setObjectTreeShowByUUID:(e,t)=>{for(let i=0;i<e.length;i++)e[i].getGroup&&e[i].getGroup()&&(e[i].getGroup().uuid===t?(e[i].show(),_y.setParentVisible(e[i].getGroup()),"ModelItem"!=e[i].type&&e[i].children.length>0&&_y.setObjectTreeShowRecursion(e[i].children)):e[i].children&&e[i].children.length>0&&_y.setObjectTreeShowByUUID(e[i].children,t))},setObjectTreeShowRecursion:e=>{for(let t=0;t<e.length;t++)e[t].getGroup()&&"IconAsset"!=e[t].type&&(e[t].show(),"ModelItem"!=e[t].type&&e[t].children.length>0&&_y.setObjectTreeShowRecursion(e[t].children))},setParentVisible:e=>{e.parent&&null!=e.parent.visible&&(e.parent.visible=!0,_y.setParentVisible(e.parent))},findObjectToBuilding:e=>{let t=Ep.defaultObjectTree.children;for(let i=0;i<t.length;i++)if("BuildingItem"===t[i].type&&_y.findObjectToBuildingRecursion(t[i].getGroup(),e))return t[i]},findObjectToBuildingRecursion:(e,t)=>{if(e.uuid===t)return e;if(e.children&&e.children.length>0)for(let i=0;i<e.children.length;i++)if(e.children[i]){let n=_y.findObjectToBuildingRecursion(e.children[i],t);if(n)return n}},findObjectToFloor:(e=[])=>{let t;for(let i=0;i<e.length;i++){let n=Ep.defaultObjectTree.getItemByUUID(e[i]);if(n&&"BuildingFloorItem"===n.type){t=n;break}}return t},findObjectToRoom:(e=[])=>{let t;for(let i=0;i<e.length;i++){let n=Ep.defaultObjectTree.getItemByUUID(e[i]);if(n&&"BuildingRoomItem"===n.type){t=n;break}}return t},judegParentIsVisible:e=>null!==e.parent?!1!==e.visible&&_y.judegParentIsVisible(e.parent):!1!==e.visible&&void 0,judegParentIsModelName:(e,t)=>!(!t||!t.parent)&&(null!==t.parent&&(t.parent.name===e&&"Group"===t.parent.type||_y.judegParentIsModelName(e,t.parent))),findModelItemNodeByName:(e,t)=>{if(e.name===t)return e;if(e.children&&e.children.length>0)for(let i=0;i<e.children.length;i++){let n=_y.findModelItemNodeByName(e.children[i],t);if(n)return n}},objectTreeChildrenRecursion:(e,t,i,n)=>{if("ModelItem"===e.type&&(n=e.name),e.children&&e.children.length>0)for(let a=0;a<e.children.length;a++)if(e.children[a]){if(e.children[a].name===t&&n===_y.modelName)return e.children[a].modelName=_y.modelName,[e.children[a]];if(e.children[a].children&&e.children[a].children.length>0){let r=_y.objectTreeChildrenRecursion(e.children[a],t,i,n);if(r)return r}}},setArticulation:(e,t)=>{("LineItem"==e.type||e.children&&"ModelItem"===e.type)&&t&&(t.articulations=[],t.articulationAnimations=[],e.articulations&&e.articulations.forEach((e=>{let i={type:e._type,name:e._name,values:e._values,defaultValue:e.value};t.addArticulation(i);let n=t.articulations.find((t=>t._name==e._name));n&&(n.getModelNode=()=>t.getGroup(),n.getModelItem=()=>t,e.properties.forEach((e=>{n.addProperty({nodes:e.nodes,modifiers:e.modifiers,materials:e.materials,particles:e.particles}),e.modifiers.forEach((e=>{"materialsReplace"===e.key&&e.values.forEach((e=>{e.path&&Ep.instance.preloadResource(e.path,"avwa",void 0,void 0,{needExport:!0})}))}))})),n.type==my&&n.addOrUpdateTextArticulation(),n.set(e.value),n.remark=e.remark,n.isEnable=e.isEnable,n.openThreshold=e.openThreshold)})),e.articulationAnimations&&e.articulationAnimations.forEach(((e,i)=>{t.addArticulationAnimation(e.animationName),t.articulationAnimations[i].animationSpeed=e.animationSpeed,t.articulationAnimations[i].animationType=e.animationType,t.articulationAnimations[i].isEnable=e.isEnable,e.articulationAnimationItems&&e.articulationAnimationItems.forEach((e=>{t.articulationAnimations[i].addAnimationItem({startTime:e.startTime,continueTime:e.continueTime,articulationName:e.articulationName,startState:e.startState,endState:e.endState})}))})))},setNode:(e,t,i)=>{if(e.children){"ModelItem"!==e.type&&"ModelAsset"!==e.type||(_y.modelName=e.name);for(let n=0;n<e.children.length;n++)if(e.children[n].isNode){let a=_y.objectTreeChildrenRecursion(t,e.children[n].name,_y.modelName,null);if(a&&a.length>0)for(let t in e.children[n])"id"===t||"children"===t||"isNode"===t||"material"===t||"name"===t||"modelName"===t||"getNodeMesh"===t||"setProperty"===t||e.children[n][t]instanceof Function||a[0].setProperty&&a[0].setProperty(t,e.children[n][t]);e.children[n].children&&e.children[n].children.length>0&&_y.setNode(e.children[n],t,i)}else e.children[n].children&&e.children[n].children.length>0&&_y.setNode(e.children[n],t,i)}},oldSetNode:(e,t,i)=>{if(e.children){"ModelItem"!==e.type&&"ModelAsset"!==e.type||(_y.modelName=e.name);for(let n=0;n<e.children.length;n++)if(e.children[n].isNode){_y.modelName&&i.selectNodes(_y.objectTreeChildrenRecursion(t,e.children[n].name,_y.modelName,null));for(let t in e.children[n])"children"!==t&&"isNode"!==t&&"material"!==t&&"name"!==t&&"modelName"!==t&&i.setProperty(t,e.children[n][t]);e.children[n].children&&e.children[n].children.length>0&&_y.setNode(e.children[n],t,i)}else e.children[n].children&&e.children[n].children.length>0&&_y.setNode(e.children[n],t,i)}},iconVisible:(e,t)=>{for(let i=0;i<e.length;i++)"IconAsset"===e[i].type?t?e[i].iconShow():e[i].iconHide():e[i].children&&e[i].children.length>0&&_y.iconVisible(e[i].children,t)},convertRotation:e=>{var t=new Ce(0,0,1);return e.quaternion.setFromEuler(e.rotation),t.applyQuaternion(e.quaternion),new dt((ge.radToDeg(Math.atan2(-t.y,-t.z))+180+180)%360-180,(ge.radToDeg(Math.atan2(-t.x,-t.z))+180+180)%360-180,(ge.radToDeg(Math.atan2(-t.x,-t.y))+180+180)%360-180)},interpolate:(e=[],t=1,i=50,n)=>{if(!(e instanceof Array||e instanceof Float32Array))return;if("number"!=typeof t||t<1||t>3)return void logger.warn("维度（dimension）参数不正确。取值范围是 1 - 3。");if("number"!=typeof i||i<1)return void logger.warn("最大插值数量（max）参数不正确。取值范围是正整数。");if(e.length%t!=0)return void logger.warn(`数组元素个数（${e.length}）与维度（${t}）不符，应为维度的整数倍。`);let a=1/0,r=-1/0,s=[],o=[];for(let i=0;i<e.length/t;i++){let n=[];for(let a=0;a<t;a++)n.push(e[i*t+a]);if(s.push(n),i>0){let e=0;switch(t){case 1:e=Math.abs(s[i][0]-s[i-1][0]);break;case 2:e=Math.sqrt((s[i][0]-s[i-1][0])*(s[i][0]-s[i-1][0])+(s[i][1]-s[i-1][1])*(s[i][1]-s[i-1][1]));break;case 3:e=Math.sqrt((s[i][0]-s[i-1][0])*(s[i][0]-s[i-1][0])+(s[i][1]-s[i-1][1])*(s[i][1]-s[i-1][1])+(s[i][2]-s[i-1][2])*(s[i][2]-s[i-1][2]))}if(0===e)continue;o.push(e),e>r&&(r=e),e<a&&(a=e)}}if(n&&o.length>0)return o.reduce(((e,t)=>e+t));if(!isFinite(r)||!isFinite(a))return;if(r/a<1.5)return e;let l=[];for(let e=0;e<s.length&&(l.push(s[e]),e!==s.length-1);e++){let t=Math.round(o[e]/a);logger.debug("interpolateCount, max",t,i),t=t>i?i:t,logger.debug("interpolateCount",t);for(let i=0;i<t-1;i++)l.push(_y.lerp(s[e],s[e+1],1/t+1/t*i))}let c=[];for(let e of l)c.push(...e);return c},interpolateAlongGlobe:(e=[],t=1,i=50,n,a=0)=>{if(!(e instanceof Array||e instanceof Float32Array))return;if("number"!=typeof t||t<1||t>3)return void logger.warn("维度（dimension）参数不正确。取值范围是 1 - 3。");if("number"!=typeof i||i<1)return void logger.warn("最大插值数量（max）参数不正确。取值范围是正整数。");if(e.length%t!=0)return void logger.warn(`数组元素个数（${e.length}）与维度（${t}）不符，应为维度的整数倍。`);let r=1/0,s=-1/0,o=[],l=[];for(let i=0;i<e.length/t;i++){let n=[];for(let a=0;a<t;a++)n.push(e[i*t+a]);if(o.push(n),i>0){let e=0;switch(t){case 1:e=Math.abs(o[i][0]-o[i-1][0]);break;case 2:e=Math.sqrt((o[i][0]-o[i-1][0])*(o[i][0]-o[i-1][0])+(o[i][1]-o[i-1][1])*(o[i][1]-o[i-1][1]));break;case 3:e=Math.sqrt((o[i][0]-o[i-1][0])*(o[i][0]-o[i-1][0])+(o[i][1]-o[i-1][1])*(o[i][1]-o[i-1][1])+(o[i][2]-o[i-1][2])*(o[i][2]-o[i-1][2]))}if(0===e)continue;l.push(e),e>s&&(s=e),e<r&&(r=e)}}if(n&&l.length>0)return l.reduce(((e,t)=>e+t));if(!isFinite(s)||!isFinite(r))return;let c=[];r=Math.min(r,2*Math.PI*a/128);for(let e=0;e<o.length&&(c.push(o[e]),e!==o.length-1);e++){let t=Math.round(l[e]/r);logger.debug("interpolateCount, max",t,i),t=Math.min(Math.max(6,t),i),logger.debug("interpolateCount",t);for(let i=0;i<t-1;i++){const n=_y.lerpAlongGlobe(o[e],o[e+1],1/t+1/t*i,a),r=new Ce(n[0],n[1],n[2]),s=new Ce(o[e][0],o[e][1],o[e][2]),l=new Ce(o[e+1][0],o[e+1][1],o[e+1][2]);r.setLength((s.length()+l.length())/2),c.push([r.x,r.y,r.z])}}let h=[];for(let e of c)h.push(...e);return h},interpolateAlongGlobe2D:(e=[],t=1,i=50,n,a=0)=>{if(!(e instanceof Array||e instanceof Float32Array))return;if("number"!=typeof t||2!==t)return void logger.warn("维度（dimension）参数不正确。取值范围是 2。");if("number"!=typeof i||i<1)return void logger.warn("最大插值数量（max）参数不正确。取值范围是正整数。");if(e.length%t!=0)return void logger.warn(`数组元素个数（${e.length}）与维度（${t}）不符，应为维度的整数倍。`);let r=1/0,s=-1/0,o=[],l=[];for(let i=0;i<e.length/t;i++){let n=[];for(let a=0;a<t;a++)n.push(e[i*t+a]);if(o.push(n),i>0){let e=0;switch(t){case 1:e=Math.abs(o[i][0]-o[i-1][0]);break;case 2:e=Math.sqrt((o[i][0]-o[i-1][0])*(o[i][0]-o[i-1][0])+(o[i][1]-o[i-1][1])*(o[i][1]-o[i-1][1]));break;case 3:e=Math.sqrt((o[i][0]-o[i-1][0])*(o[i][0]-o[i-1][0])+(o[i][1]-o[i-1][1])*(o[i][1]-o[i-1][1])+(o[i][2]-o[i-1][2])*(o[i][2]-o[i-1][2]))}if(0===e)continue;l.push(e),e>s&&(s=e),e<r&&(r=e)}}if(n&&l.length>0)return l.reduce(((e,t)=>e+t));if(!isFinite(s)||!isFinite(r))return;r=Math.min(r,2*Math.PI*a/128);let c=[];for(let e=0;e<o.length&&(c.push(o[e]),e!==o.length-1);e++){let t=Math.round(l[e]/r);logger.debug("interpolateCount, max",t,i),t=t>i?i:t,logger.debug("interpolateCount",t);for(let i=0;i<t-1;i++)c.push(_y.lerp(o[e],o[e+1],1/t+1/t*i))}let h=[];for(let e of c)h.push(...e);return h},lerp:(e,t,i)=>{if(e.length===t.length&&!(i<0||i>1))switch(e.length){case 1:return e+(t-e)*i;case 2:return[e[0]+(t[0]-e[0])*i,e[1]+(t[1]-e[1])*i];case 3:return[e[0]+(t[0]-e[0])*i,e[1]+(t[1]-e[1])*i,e[2]+(t[2]-e[2])*i]}},lerpAlongGlobe:(e,t,i,n=1)=>{if(e.length===t.length&&!(i<0||i>1))switch(e.length){case 3:let a,r=new Ce(e[0],e[1],e[2]),s=new Ce(t[0],t[1],t[2]),o=r.distanceTo(s),l=Math.asin(o/(2*n)),c=2*l*i,h=n*Math.cos(l)*Math.tan(l-c);return console.log(h),a=i<.5?.5-Math.abs(h/o):.5+Math.abs(h/o),[e[0]+(t[0]-e[0])*a,e[1]+(t[1]-e[1])*a,e[2]+(t[2]-e[2])*a]}},base64ToBlob:e=>{let t=e.split(";base64,"),i=t[0].split(":")[1],n=window.atob(t[1]),a=n.length,r=new Uint8Array(a);for(let e=0;e<a;++e)r[e]=n.charCodeAt(e);let s=new Blob([r],{type:i});return URL.createObjectURL(s)},calcEulerAngelsFromNormal:e=>{let t=new Ce;return e instanceof Ce&&(0!==e.x||0!==e.y||0!==e.z)?(e.x=Math.round(1e3*e.x)/1e3,e.y=Math.round(1e3*e.y)/1e3,e.z=Math.round(1e3*e.z)/1e3,t.x=0===e.y?e.z<0?-Math.PI/2:Math.PI/2:Math.atan(e.z/e.y),t.y=0,t.z=0===e.y?e.x<0?-Math.PI/2:Math.PI/2:Math.atan(e.x/e.y),logger.debug(e,t),t):t},calcQuaternionFromNormal:e=>{let t=new Ee,i=new Ce;if(!(e instanceof Ce)||0===e.x&&0===e.y&&0===e.z)return t.setFromAxisAngle(i,0),t;e.x=Math.round(1e3*e.x)/1e3,e.y=Math.round(1e3*e.y)/1e3,e.z=Math.round(1e3*e.z)/1e3,i.x=e.z,i.y=0,i.z=0-e.x;let n=e.angleTo(vy);return t.setFromAxisAngle(i,n)},isDepthTestDisabled:e=>{if(!e)return!1;if("boolean"==typeof e.depthTest)return!e.depthTest;if(e instanceof Array){for(let t of e)if(!1===t.depthTest)return!0;return!1}},markObjectsNeedsUpdate:()=>{if(Ep.objectsNeedsUpdate instanceof Array)for(let e of Ep.objectsNeedsUpdate)e&&(e.needsUpdate=!0)},addToObjectsNeedsUpdate:e=>{Ep.objectsNeedsUpdate||(Ep.objectsNeedsUpdate=[]),Ep.objectsNeedsUpdate.push(e)},removeFromObjectsNeedsUpdate:e=>{if(Ep.objectsNeedsUpdate&&0!==Ep.objectsNeedsUpdate.length)for(let t=Ep.objectsNeedsUpdate.length-1;t>=0;t--)Ep.objectsNeedsUpdate[t]===e&&Ep.objectsNeedsUpdate.splice(t,1)},disposeThreeObject:e=>{if(e)if(e.traverse){if("IconGroup"===e.type&&e.parent&&"InstancedGroup"===e.parent.type)return void _y.disposeInstancedObject(e);e.traverse((function(e){const t=Ep.animationStore.findAnimation(e.uuid,yy.type);if(t&&Ep.animationStore.remove(t),e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose){for(var i in e.material)e.material[i]&&e.material[i].dispose&&e.material[i].dispose instanceof Function&&e.material[i].dispose();e.material.dispose&&e.material.dispose()}else if(e.material&&e.material.length)for(let t=e.material.length-1;t>=0;t--){for(var i in e.material[t])e.material[t][i]&&e.material[t][i].dispose&&e.material[t][i].dispose instanceof Function&&e.material[t][i].dispose();e.material[t].dispose&&e.material[t].dispose()}e.dispose&&e.dispose()}))}else e&&e.dispose&&e.dispose()},disposeInstancedObject(e){e.traverse((function(e){e.geometry&&e.geometry.dispose&&e.geometry.dispose()}))},cloneMaterial:e=>{let t=e.clone();for(var i in t)t[i]instanceof we&&(t[i]=t[i].clone());return t},disposeMaterial:e=>{for(var t in e)e[t]instanceof we&&e[t].dispose();e.dispose()},geoCCSToLonLat:(e,t,i)=>{let n=Gm("GEOCCS","WGS84",[e,t,i]);return{lon:n[0],lat:n[1],alt:n[2]}},lonLatToGeoCCS:(e,t,i)=>{let n=Gm("WGS84","GEOCCS",[e,t,i]);return{x:n[0],y:n[1],z:n[2]}},webMercatorToLonLat:(e,t,i)=>{let n=Gm("EPSG:3857","WGS84",[e,t,i]);return{lon:n[0],lat:n[1],alt:n[2]}},lonLatToWebMercator:(e,t,i)=>{let n=Gm("WGS84","EPSG:3857",[e,t,i]);return{x:n[0],y:n[1],z:n[2]}},lonLatDistance:(e,t)=>e&&t?"number"!=typeof e.lon||"number"!=typeof e.lat||"number"!=typeof t.lon||"number"!=typeof t.lat?0:2*Math.asin(Math.sqrt(Math.pow(Math.sin((_y.degreeToRadian(e.lat)-_y.degreeToRadian(t.lat))/2),2)+Math.cos(_y.degreeToRadian(e.lat))*Math.cos(_y.degreeToRadian(t.lat))*Math.pow(Math.sin((_y.degreeToRadian(e.lon)-_y.degreeToRadian(t.lon))/2),2)))*6378137:0,getAutoRotateTime(e=1,t="CW"){let i=1;return"CCW"===t&&(i=-1),i*(1/e)*60},setMaterialParam(e,t,i,n=[]){for(let a in e)if(!n.includes(a))if(t[a]instanceof hy){for(let t in e[a])if(!n.includes(t))if(e[a][t.replace("_","")]=e[a][t],e[a][t.replace("_","")]instanceof Array);else if(e[a][t.replace("_","")]instanceof Object)for(let i in e[a][t.replace("_","")])n.includes(i)||(e[a][t.replace("_","")][i.replace("_","")]=e[a][t.replace("_","")][i]);switch(e[a].type){case"imagebitmap":let n="undefined"!=typeof ImageBitmap&&e[a].source instanceof ImageBitmap?e[a].source:void 0!==e[a].name?i.get(e[a].name)||Ep.customTextureStore.find(e[a].name):i.get(t.name+"#"+a);if(("metalnessMap"===a||"roughnessMap"===a)&&!n){let t="",r="";e.roughnessMap&&(r=e.roughnessMap.name||e.roughnessMap._name||""),e.metalnessMap&&(t=e.metalnessMap.name||e.metalnessMap._name||""),e[a].name&&(n||(n=i.get(t+r)),i.forEach((t=>{t.name.indexOf(e[a].name)>-1&&t.name.indexOf("#MetalnessAndRoughness#")>-1&&(n=t)})))}if(!n&&e[a].name&&0===e[a].name.indexOf("[[origin]]")){Ep.customTextureStore.loadTexture({url:e[a].name,name:e[a].name,onLoad:()=>{let n="undefined"!=typeof ImageBitmap&&e[a].source instanceof ImageBitmap?e[a].source:void 0!==e[a].name?i.get(e[a].name)||Ep.customTextureStore.find(e[a].name):i.get(t.name+"#"+a);t[a]={type:"imagebitmap",source:n,reset:!0}}}),console.log("可能加载的模型引用了自定义贴图，自定义贴图需要重新load");break}if(!n&&e[a].dataUrl){Ep.customTextureStore.loadTexture({url:e[a].dataUrl,name:e[a].name,onLoad:e=>{t[a]={type:"imagebitmap",source:e,reset:!0}}});break}t[a]={type:"imagebitmap",source:n,reset:!0};break;case"color":e[a].reset=!0,t[a]=e[a];break;case"file":break;default:t[a]=e[a]}}else t[a]=e[a];t&&e&&e.color&&t.color&&(t.color=e.color)},getIndices(e){const t=new Ht;function i(e,t){this.id=e,this.vertex=t,this.last=null,this.next=null}const n=[];function a(){return n.length}function r(e){const t=n.findIndex((t=>t===e));-1!==t&&n.splice(t,1),e.last.next=e.next,e.next.last=e.last}const s=e.length;if(e[0].isVector3)for(let t=0;t<s;t++){const a=new i(t,e[t]);n.push(a)}else for(let t=0;t<s;t+=3){const a=new i(t/3,new Ce(e[t],e[t+1],e[t+2]));n.push(a)}let o=n[0],l=n[n.length-1];for(;o.vertex.equals(l.vertex);){if(n.splice(n.length-1,1),n.length<3)return[];l=n[n.length-1]}for(let e=0;e<a();e++){const t=n[e];0===e?(t.last=n[a()-1],t.next=n[1]):e===a()-1?(t.last=n[a()-2],t.next=n[0]):(t.last=n[e-1],t.next=n[e+1])}function c(e,t,i,n){const a=(new Ce).subVectors(e,t),r=(new Ce).subVectors(e,i),s=(new Ce).subVectors(e,n),o=(new Ce).crossVectors(a,r),l=(new Ce).crossVectors(r,s),c=(new Ce).crossVectors(s,a);return o.z>0&&l.z>0&&c.z>0||o.z<0&&l.z<0&&c.z<0}const h=[];let u;for(;a()>=3;){let e=n[0];const i=[];for(let n=0;n<a();n++){t.set(e.last.vertex,e.vertex,e.next.vertex);const n=t.getNormal();void 0===u&&(u=n.y<0),u?n.y<0&&i.push(e):n.y>0&&i.push(e),e=e.next}const s=[...i],o=i.length;for(let e=0;e<o;e++){const t=i[e],n=t.last.vertex,a=t.vertex,r=t.next.vertex;let o=t.next.next;for(;o!==t.last;){if(c(o.vertex,n,a,r)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1);break}o=o.next}}if(s.length<=0)break;h.push(s[0].last.id),h.push(s[0].id),h.push(s[0].next.id),r(s[0])}return h},addBox(e,t=1,i="#ff0000"){if(void 0===e){for(const e of by)Ep.scene.remove(e),e.material.dispose(),e.geometry.dispose();return void(by=[])}const n=new Kt({color:i,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest}),a=new Fi(new Hi(t,t,t),n);a.position.set(e.x,e.y,e.z),by.push(a),Ep.scene.add(a)},MeshBasicMaterialToMeshStandardMaterial:e=>e instanceof Kt?new So({name:e.name,alphaMap:e.alphaMap,alphaTest:e.alphaTest,aoMap:e.aoMap,aoMapIntensity:e.aoMapIntensity,blendDst:e.blendDst,blendDstAlpha:e.blendDstAlpha,blendEquation:e.blendEquation,blendEquationAlpha:e.blendEquationAlpha,blendSrc:e.blendSrc,blendSrcAlpha:e.blendSrcAlpha,blending:e.blending,clipIntersection:e.clipIntersection,clipShadows:e.clipShadows,clippingPlanes:e.clippingPlanes,color:e.color,colorWrite:e.colorWrite,depthFunc:e.depthFunc,depthTest:e.depthTest,depthWrite:e.depthWrite,dithering:e.dithering,envMap:e.envMap,fog:e.fog,lightMap:e.lightMap,lightMapIntensity:e.lightMapIntensity,map:e.map,morphTargets:e.morphTargets,opacity:e.opacity,polygonOffset:e.polygonOffset,polygonOffsetFactor:e.polygonOffsetFactor,polygonOffsetUnits:e.polygonOffsetUnits,precision:e.precision,premultipliedAlpha:e.premultipliedAlpha,refractionRatio:e.refractionRatio,shadowSide:e.shadowSide,side:e.side,skinning:e.skinning,stencilFail:e.stencilFail,stencilFunc:e.stencilFunc,stencilFuncMask:e.stencilFuncMask,stencilRef:e.stencilRef,stencilWrite:e.stencilWrite,stencilWriteMask:e.stencilWriteMask,stencilZFail:e.stencilZFail,stencilZPass:e.stencilZPass,toneMapped:e.toneMapped,transparent:e.transparent,userData:e.userData,version:e.version,vertexColors:e.vertexColors,visible:e.visible,wireframe:e.wireframe,wireframeLinecap:e.wireframeLinecap,wireframeLinejoin:e.wireframeLinejoin,wireframeLinewidth:e.wireframeLinewidth}):e,md5:fy,getPackSettings:(e,t)=>new Promise((i=>{let n=new jg;n.file("setting.json",JSON.stringify(e)),n.generateAsync({type:"base64",streamFiles:!0,compression:"DEFLATE"},(e=>{t&&t(e)})).then((async e=>{i(e)}))})),setPackSettings:e=>new Promise((t=>{(new jg).loadAsync(e,{base64:!0}).then((e=>{e&&e.files&&e.files["setting.json"]&&e.file("setting.json").async("string").then((e=>{let i=JSON.parse(e);t(i)}))}))}))};window.navigator.userAgent&&window.navigator.userAgent.indexOf("AppleWebKit")>=0?_y.isAppleWebKit=!0:_y.isAppleWebKit=!1;const xy=Symbol("INITIAL_FRUSTUM_CULLED"),wy=new it,Sy=new it,My=new Ce,Ty=new Ce,Ay=new Ce,Ey=new Ce,Cy=new Ce(1,0,0),Iy=new Ce(0,1,0);function Py(e,t){e.traverse((e=>{e.frustumCulled=e[xy]&&t}))}class Ry extends class{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new Fd;t.unloadPriorityCallback=$d;const i=new jd;i.maxJobs=4,i.priorityCallback=Kd;const n=new jd;n.maxJobs=1,n.priorityCallback=Kd,this.lruCache=t,this.downloadQueue=i,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const i=this.tileSets[this.rootURL];i&&i.root&&Xd(i.root,e,t)}update(){const e=this.stats,t=this.lruCache,i=this.tileSets,n=i[this.rootURL];if(!(this.rootURL in i))return void this.loadRootTileSet(this.rootURL);if(!n||!n.root)return;const a=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,Zd(a,this),qd(a,this),Jd(a,this),Qd(a,this),t.scheduleUnload()}parseTile(e,t,i){return null}disposeTile(e){}preprocessNode(e,t,i){e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=function(...e){const t=/^[a-zA-Z]+:\/\//;let i=-1;for(let n=0,a=e.length;n<a;n++)t.test(e[n])&&(i=n);if(-1===i)return zd.join(...e).replace(/\\/g,"/");{const n=i<=0?e:e.slice(i),a=n[0].match(t)[0];return n[0]=n[0].substring(a.length),(a+zd.join(...n)).replace(/\\/g,"/")}}(i,e.content.uri)),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=t,e.children=e.children||[];if(e.content&&e.content.uri){const t=Ud(e.content.uri),i=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=i,e.__contentEmpty=i}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===t?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=t.__depth+1,e.refine=e.refine||t.refine)}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}fetchTileSet(e,t,i=null){return fetch(e,t).then((t=>{if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>{const n=t.asset.version;console.assert("1.0"===n||"0.0"===n,'asset.version is expected to be a string of "1.0" or "0.0"');const a=zd.dirname(e);return Xd(t.root,((e,t)=>this.preprocessNode(e,t,a)),null,i,i?i.__depth:0),t}))}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const i=this.fetchTileSet(e,this.fetchOptions).then((i=>{t[e]=i}));return i.catch((i=>{console.error(i),t[e]=i})),t[e]=i,i}}requestTileContents(e){if(0!==e.__loadingState)return;const t=this.stats,i=this.lruCache,n=this.downloadQueue,a=this.parseQueue,r=e.__externalTileSet;i.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):r?e.children.length=0:this.disposeTile(e),1===e.__loadingState?t.downloading--:2===e.__loadingState&&t.parsing--,e.__loadingState=0,e.__loadIndex++,a.remove(e),n.remove(e)})),e.__loadIndex++;const s=e.__loadIndex,o=new AbortController,l=o.signal;t.downloading++,e.__loadAbort=o,e.__loadingState=1;const c=r=>{e.__loadIndex===s&&("AbortError"!==r.name?(a.remove(e),n.remove(e),2===e.__loadingState?t.parsing--:1===e.__loadingState&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(r),e.__loadingState=4):i.remove(e))};r?n.add(e,(e=>{if(e.__loadIndex!==s)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return this.fetchTileSet(t,Object.assign({signal:l},this.fetchOptions),e)})).then((i=>{e.__loadIndex===s&&(t.downloading--,e.__loadAbort=null,e.__loadingState=3,e.children.push(i.root))})).catch(c):n.add(e,(e=>{if(e.__loadIndex!==s)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return fetch(t,Object.assign({signal:l},this.fetchOptions))})).then((t=>{if(e.__loadIndex===s){if(t.ok)return t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((i=>{if(e.__loadIndex===s)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=2,a.add(e,(e=>{if(e.__loadIndex!==s)return Promise.resolve();const t=Ud(e.content.uri);return this.parseTile(i,e,t)}))})).then((()=>{e.__loadIndex===s&&(t.parsing--,e.__loadingState=3,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch(c)}dispose(){const e=this.lruCache;this.traverse((t=>{e.remove(t)}))}}{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{Py(t,!e)})))}constructor(...e){super(...e),this.group=new gp(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,e.length>1&&(this.offset=e[1]),e.length>2&&(this.rotation=e[2]),e.length>3&&(this.scale=e[3]),this.offset||(this.offset={x:0,y:0,z:0}),this.rotation&&(this.rotation={x:_y.degreeToRadian(this.rotation.x),y:_y.degreeToRadian(this.rotation.y),z:_y.degreeToRadian(this.rotation.z)}),this.scale?"number"==typeof this.scale?this.scale={x:this.scale,y:this.scale,z:this.scale}:this.scale.x&&this.scale.y&&this.scale.z&&(this.scale={x:this.scale.x,y:this.scale.y,z:this.scale.z}):this.scale={x:1,y:1,z:1};const t=new qo;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t;const i=this;this._overridenRaycast=function(e,t){i.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,e,t)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached,i=t.box,n=t.boxTransform;return!!i&&(e.copy(i),e.applyMatrix4(n),!0)}getOrientedBounds(e,t){if(!this.root)return!1;const i=this.root.cached,n=i.box,a=i.boxTransform;return!!n&&(e.copy(n),t.copy(a),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.sphere;return!!t&&(e.copy(t),!0)}forEachLoadedModel(e){this.traverse((t=>{const i=t.cached.scene;i&&e(i,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const i=Tp(this.root,this.group,this.activeTiles,e);i&&t.push(i)}else Ap(this.root,this.group,this.activeTiles,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,i=this.cameraMap;return!i.has(e)&&(i.set(e,new ye),t.push(e),!0)}setResolution(e,t,i){const n=this.cameraMap;return!!n.has(e)&&(t instanceof ye?n.get(e).copy(t):n.get(e).set(t,i),!0)}setResolutionFromRenderer(e,t){const i=this.cameraMap;if(!i.has(e))return!1;const n=i.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,i=this.cameraMap;if(i.has(e)){const n=t.indexOf(e);return t.splice(n,1),i.delete(e),!0}return!1}fetchTileSet(e,...t){const i=super.fetchTileSet(e,...t);return i.then((t=>{this.onLoadTileSet&&Promise.resolve().then((()=>{this.onLoadTileSet(t,e)}))})),i}update(){const e=this.group,t=this.cameras,i=this.cameraMap,n=this.cameraInfo;if(0===t.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new nn,isOrthographic:!1,sseDenominator:-1,position:new Ce,invScale:-1,pixelSize:0});let a;Sy.copy(e.matrixWorld).invert(),My.setFromMatrixScale(Sy),a=My.x,Math.abs(Math.max(My.x-My.y,My.x-My.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let r=0,s=n.length;r<s;r++){const s=t[r],o=n[r],l=o.frustum,c=o.position,h=i.get(s);0!==h.width&&0!==h.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const u=s.projectionMatrix.elements;if(o.isOrthographic=1===u[15],o.isOrthographic){const e=2/u[0],t=2/u[5];o.pixelSize=Math.max(t/h.height,e/h.width)}else o.sseDenominator=2/u[5]/h.height;o.invScale=a,wy.copy(e.matrixWorld),wy.premultiply(s.matrixWorldInverse),wy.premultiply(s.projectionMatrix),l.setFromProjectionMatrix(wy),c.set(0,0,0),c.applyMatrix4(s.matrixWorld),c.applyMatrix4(Sy),c.x}super.update()}preprocessNode(e,t,i){super.preprocessNode(e,t,i),t||(Ry.boundingOffset=null,Ep._tilesGroup&&Ep._tilesGroup.rotation.set(Math.PI/-2,0,0));const n=new it;if(!e.transform&&!t){const t=e.boundingVolume;if(t.sphere||t.box){let e=[0,0,0];t.sphere&&(e=[t.sphere[0],t.sphere[1],t.sphere[2]]),t.box&&(e=[t.box[0],t.box[1],t.box[2]]);let i=_y.geoCCSToLonLat(e[0],e[1],e[2]),n=new Et;switch(n.position.set(e[0],e[1],e[2]),Ep._tilesGroup.add(n),"y".toLowerCase()){case"z":Ep._tilesGroup.rotation.set(Math.PI/-2-_y.degreeToRadian(90-i.lat),0,-_y.degreeToRadian(90+i.lon),"YXZ");break;case"y":default:Ep._tilesGroup.rotation.set(Math.PI/-2-_y.degreeToRadian(90-i.lat),0,-_y.degreeToRadian(90+i.lon),"YXZ")}if(Ep._tilesGroup.updateMatrix(),Ep._tilesGroup.updateMatrixWorld(),n.updateMatrixWorld(),Ep._tilesGroup.position.setFromMatrixPosition(n.matrixWorld),Ep._tilesGroup.position.x=-Ep._tilesGroup.position.x,Ep._tilesGroup.position.y=-Ep._tilesGroup.position.y,Ep._tilesGroup.position.z=-Ep._tilesGroup.position.z,Ep._tilesGroup.remove(n),Ep._tilesGroup.scale.set(this.scale.x,this.scale.y,this.scale.z),Ry.customTransformOrigin){let t=_y.geoCCSToLonLat(e[0],e[1],e[2]);const i=Ry.customTransformOrigin;let n=_y.lonLatDistance({lon:i.lon,lat:(i.lat+t.lat)/2},{lon:t.lon,lat:(i.lat+t.lat)/2}),a=.99664718932*_y.lonLatDistance({lon:(i.lon+t.lon)/2,lat:i.lat},{lon:(i.lon+t.lon)/2,lat:t.lat});Ep._tilesGroup.position.x+=n*Math.sign(t.lon-i.lon),Ep._tilesGroup.position.z+=a*Math.sign(t.lat-i.lat),Ep._tilesGroup.position.y+=t.alt-i.alt,Ep._tilesGroup.position.x+=this.offset.x,Ep._tilesGroup.position.y+=this.offset.y,Ep._tilesGroup.position.z+=this.offset.z}else Ry.customTransformOrigin=_y.geoCCSToLonLat(e[0],e[1],e[2]),Ep._tilesGroup.position.x+=this.offset.x,Ep._tilesGroup.position.y+=this.offset.y,Ep._tilesGroup.position.z+=this.offset.z}}if(e.transform){const i=e.transform;for(let e=0;e<16;e++)n.elements[e]=i[e];if(!t&&Ry.customTransformEnabled)if(n.identity(),this.rotation&&n.makeRotationFromEuler(new dt(this.rotation.x,-this.rotation.z,this.rotation.y)),this.scale&&Ep._tilesGroup.scale.set(this.scale.x,this.scale.y,this.scale.z),i&&Ry.customTransformOrigin){let e=_y.geoCCSToLonLat(i[12],i[13],i[14]);const t=Ry.customTransformOrigin;if(!this.rotation){const i=_y.degreeToRadian(e.lon-t.lon),a=_y.degreeToRadian(e.lat-t.lat);n.makeRotationFromEuler(new dt(i,a,0))}_y.lonLatDistance(t,{lon:e.lon,lat:t.lat}),_y.lonLatDistance(t,{lon:t.lon,lat:e.lat});let a=_y.lonLatDistance({lon:t.lon,lat:(t.lat+e.lat)/2},{lon:e.lon,lat:(t.lat+e.lat)/2}),r=.99664718932*_y.lonLatDistance({lon:(t.lon+e.lon)/2,lat:t.lat},{lon:(t.lon+e.lon)/2,lat:e.lat});_y.lonLatDistance(e,{lon:t.lon,lat:e.lat}),_y.lonLatDistance(e,{lon:e.lon,lat:t.lat}),n.elements[12]=a*Math.sign(e.lon-t.lon),n.elements[13]=r*Math.sign(e.lat-t.lat),n.elements[14]=e.alt-t.alt,this.absolutePosition={x:n.elements[12],z:-n.elements[13],y:n.elements[14]},n.elements[12]+=this.offset.x,n.elements[13]-=this.offset.z,n.elements[14]+=this.offset.y}else{Ry.customTransformOrigin=_y.geoCCSToLonLat(i[12],i[13],i[14]);let e=Ep.instance.getDatumShiftModel();if(!e){let t={lon:Ry.customTransformOrigin.lon,lat:Ry.customTransformOrigin.lat,alt:Ry.customTransformOrigin.alt,type:"surface",scaleX:1,scaleY:1,scaleZ:1},i={mode:"basepoint",type:"basepoint",mapCenter:[t.lon,t.lat],alt:t.alt};t.editor=i,Ep.instance.setDatumShiftModel(t),e=t}this.absolutePosition={x:n.elements[12],z:-n.elements[13],y:n.elements[14]},n.elements[12]+=this.offset.x,n.elements[13]-=this.offset.z,n.elements[14]+=this.offset.y}}else n.identity();t&&n.premultiply(t.cached.transform);const a=(new it).copy(n).invert();let r=null,s=null,o=null;if("box"in e.boundingVolume){const t=e.boundingVolume.box;r=new Re,s=new it,o=new it,Ty.set(t[3],t[4],t[5]),Ay.set(t[6],t[7],t[8]),Ey.set(t[9],t[10],t[11]);const i=Ty.length(),a=Ay.length(),l=Ey.length();Ty.normalize(),Ay.normalize(),Ey.normalize(),0===i&&Ty.crossVectors(Ay,Ey),0===a&&Ay.crossVectors(Ty,Ey),0===l&&Ey.crossVectors(Ty,Ay),s.set(Ty.x,Ay.x,Ey.x,t[0],Ty.y,Ay.y,Ey.y,t[1],Ty.z,Ay.z,Ey.z,t[2],0,0,0,1),s.premultiply(n),o.copy(s).invert(),r.min.set(-i,-a,-l),r.max.set(i,a,l)}let l=null;if("sphere"in e.boundingVolume){const t=e.boundingVolume.sphere;l=new Xe,l.center.set(t[0],t[1],t[2]),l.radius=t[3],l.applyMatrix4(n)}else if("box"in e.boundingVolume){const t=e.boundingVolume.box;l=new Xe,r.getBoundingSphere(l),l.center.set(t[0],t[1],t[2]),l.applyMatrix4(n)}"region"in e.boundingVolume&&console.warn("ThreeTilesRenderer: region bounding volume not supported."),e.cached={loadIndex:0,transform:n,transformInverse:a,active:!1,inFrustum:[],box:r,boxTransform:s,boxTransformInverse:o,sphere:l,region:null,scene:null,geometry:null,material:null}}parseTile(e,t,i){t._loadIndex=t._loadIndex||0,t._loadIndex++;const n=t.content.uri.split(/[\\\/]/g);n.pop();const a=n.join("/"),r=this.fetchOptions,s=this.manager,o=t._loadIndex;let l=null;switch(i){case"b3dm":const t=new ap(s);t.workingPath=a,t.fetchOptions=r,l=t.parse(e).then((e=>e.scene));break;case"pnts":l=Promise.resolve(new rp(s).parse(e).scene);break;case"i3dm":{const t=new pp(s);t.workingPath=a,t.fetchOptions=r,l=t.parse(e).then((e=>e.scene));break}case"cmpt":{const t=new mp(s);t.workingPath=a,t.fetchOptions=r,l=t.parse(e).then((e=>e.scene));break}default:console.warn(`TilesRenderer: Content type "${i}" not supported.`),l=Promise.resolve(null)}return l.then((e=>{if(e.traverse((e=>{if(e.material)if(e.material instanceof Array)e.material.forEach((e=>{for(var t in e)if(e[t]&&e[t].image&&e[t].image instanceof ImageBitmap){var i=null;for(var n in Xo.files)if(Xo.files[n]===e[t].image){i=n;break}Xo.remove(i),Zo.forEach(((e,t)=>{e===i&&Zo.delete(t)})),Zo.delete(e[t].image)}}));else for(var t in e.material)if(e.material[t]&&e.material[t].image&&e.material[t].image instanceof ImageBitmap){var i=null;for(var n in Xo.files)if(Xo.files[n]===e.material[t].image){i=n;break}Xo.remove(i),Zo.forEach(((e,t)=>{e===i&&Zo.delete(t)})),Zo.delete(e.material[t].image)}})),t._loadIndex!==o)return;const n=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",a=t.cached,r=a.transform;switch(n.toLowerCase()){case"x":wy.makeRotationAxis(Iy,-Math.PI/2);break;case"y":wy.makeRotationAxis(Cy,Math.PI/2);break;case"z":wy.identity()}e.updateMatrix(),"pnts"!==i&&e.matrix.multiply(wy),e.matrix.premultiply(r),e.matrix.decompose(e.position,e.quaternion,e.scale),e.traverse((e=>{e[xy]=e.frustumCulled})),Py(e,!this.autoDisableRendererCulling),a.scene=e,e.traverse((e=>{e.raycast=this._overridenRaycast}));const s=[],l=[],c=[];e.traverse((e=>{if(e.geometry&&l.push(e.geometry),e.receiveShadow=!0,e.material){if(e.geometry&&e.geometry.attributes&&e.geometry.attributes.position&&!e.geometry.attributes.normal){const t=[];let i=0;e.geometry.attributes.position.data&&"number"==typeof e.geometry.attributes.position.data.count&&(i=e.geometry.attributes.position.data.count),"number"==typeof e.geometry.attributes.position.count&&(i=e.geometry.attributes.position.count);for(let e=0;e<i;e++)t.push(0),t.push(1),t.push(0);e.geometry.setAttribute("normal",new hi(t,3))}const t=new Co;t.map=e.material.map,e.material.dispose(),e.material=t;const i=e.material;i.needsUpdate=!0,s.push(i);for(const e in i){const t=i[e];t&&t.isTexture&&c.push(t)}}})),a.materials=s,a.geometry=l,a.textures=c,this.onLoadModel&&this.onLoadModel(e,t)}))}disposeTile(e){const t=e.cached;if(t.scene){const r=t.materials,s=t.geometry,o=t.textures;for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=r.length;e<t;e++){for(var i in r[e])if(r[e][i]&&r[e][i].image&&r[e][i].image instanceof ImageBitmap){var n=null;for(var a in Xo.files)if(Xo.files[a]===r[e][i].image){n=a;break}Xo.remove(n),Zo.forEach(((e,t)=>{e===n&&Zo.delete(t)})),Zo.delete(r[e][i].image)}r[e].dispose()}for(let e=0,t=o.length;e<t;e++){o[e].dispose()}this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}setTileVisible(e,t){const i=e.cached.scene,n=this.visibleTiles,a=this.group;t?(a.add(i),n.add(e),i.updateMatrixWorld(!0)):(i.traverse((e=>{if(e.material)if(e.material instanceof Array)e.material.forEach((e=>{for(var t in e)if(e[t]&&e[t].image&&e[t].image instanceof ImageBitmap){var i=null;for(var n in Xo.files)if(Xo.files[n]===e[t].image){i=n;break}Xo.remove(i),Zo.forEach(((e,t)=>{e===i&&Zo.delete(t)})),Zo.delete(e[t].image)}}));else for(var t in e.material)if(e.material[t]&&e.material[t].image&&e.material[t].image instanceof ImageBitmap){var i=null;for(var n in Xo.files)if(Xo.files[n]===e.material[t].image){i=n;break}Xo.remove(i),Zo.forEach(((e,t)=>{e===i&&Zo.delete(t)})),Zo.delete(e.material[t].image)}})),a.remove(i),n.delete(e))}setTileActive(e,t){const i=this.activeTiles;t?i.add(e):i.delete(e)}calculateError(e){const t=e.cached,i=t.inFrustum,n=this.cameras,a=this.cameraInfo,r=e.boundingVolume;if("box"in r||"sphere"in r){const r=t.sphere,s=t.box,o=t.boxTransformInverse,l=t.transformInverse,c=s&&o;let h=-1/0,u=1/0;for(let t=0,d=n.length;t<d;t++){if(!i[t])continue;const n=a[t],d=n.invScale;let p;if(n.isOrthographic){const t=n.pixelSize;p=e.geometricError/(t*d)}else{let t;My.copy(n.position),c?(My.applyMatrix4(o),t=s.distanceToPoint(My)):(My.applyMatrix4(l),t=Math.max(r.distanceToPoint(My),0));const i=t*d,a=n.sseDenominator;p=e.geometricError/(i*a),u=Math.min(u,i)}h=Math.max(h,p)}e.__distanceFromCamera=u,e.__error=h}else"region"in r&&console.warn("ThreeTilesRenderer : Region bounds not supported.")}tileInView(e){const t=e.cached,i=t.sphere,n=t.inFrustum;if(i){const e=this.cameraInfo;let t=!1;for(let a=0,r=e.length;a<r;a++){e[a].frustum.intersectsSphere(i)?(t=!0,n[a]=!0):n[a]=!1}return t}return!0}}new Ce;const Oy=15360,Dy=8192,Ly="avw_scene_v2",ky="cache",Ny=[10,8,29,32,43,55,40,67],By=[58,64,1,33,75,26,38,95],zy=65535,Uy=!1,Fy=1e4;function jy(e){return(jy="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var Hy=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],Gy=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function Vy(e,t,i,n,a,r){if("string"==typeof e&&(e=document.getElementById(e)),e&&(!(e instanceof HTMLImageElement)||"naturalWidth"in e)){var s=a?"offset":"natural",o=e[s+"Width"],l=e[s+"Height"];if(e instanceof ImageBitmap&&(o=e.width,l=e.height),"string"==typeof t&&(t=document.getElementById(t)),t&&"getContext"in t){r||(t.style.width=o+"px",t.style.height=l+"px"),t.width=o,t.height=l;var c=t.getContext("2d");c.clearRect(0,0,o,l),c.drawImage(e,0,0,o,l,0,0,o,l),isNaN(i)||i<1||(n?function(e,t,i,n,a,r){if(isNaN(r)||r<1)return;r|=0;var s=Wy(e,t,i,n,a);s=function(e,t,i,n,a,r){for(var s,o=e.data,l=2*r+1,c=n-1,h=a-1,u=r+1,d=u*(u+1)/2,p=new Yy,m=p,f=1;f<l;f++)m=m.next=new Yy,f===u&&(s=m);m.next=p;for(var g=null,y=null,v=0,b=0,_=Hy[r],x=Gy[r],w=0;w<a;w++){m=p;for(var S=o[b],M=o[b+1],T=o[b+2],A=o[b+3],E=0;E<u;E++)m.r=S,m.g=M,m.b=T,m.a=A,m=m.next;for(var C=0,I=0,P=0,R=0,O=u*S,D=u*M,L=u*T,k=u*A,N=d*S,B=d*M,z=d*T,U=d*A,F=1;F<u;F++){var j=b+((c<F?c:F)<<2),H=o[j],G=o[j+1],V=o[j+2],W=o[j+3],Y=u-F;N+=(m.r=H)*Y,B+=(m.g=G)*Y,z+=(m.b=V)*Y,U+=(m.a=W)*Y,C+=H,I+=G,P+=V,R+=W,m=m.next}g=p,y=s;for(var X=0;X<n;X++){var Z=U*_>>x;if(o[b+3]=Z,0!==Z){var q=255/Z;o[b]=(N*_>>x)*q,o[b+1]=(B*_>>x)*q,o[b+2]=(z*_>>x)*q}else o[b]=o[b+1]=o[b+2]=0;N-=O,B-=D,z-=L,U-=k,O-=g.r,D-=g.g,L-=g.b,k-=g.a;var J=X+r+1;J=v+(J<c?J:c)<<2,N+=C+=g.r=o[J],B+=I+=g.g=o[J+1],z+=P+=g.b=o[J+2],U+=R+=g.a=o[J+3],g=g.next;var Q=y,K=Q.r,$=Q.g,ee=Q.b,te=Q.a;O+=K,D+=$,L+=ee,k+=te,C-=K,I-=$,P-=ee,R-=te,y=y.next,b+=4}v+=n}for(var ie=0;ie<n;ie++){var ne=o[b=ie<<2],ae=o[b+1],re=o[b+2],se=o[b+3],oe=u*ne,le=u*ae,ce=u*re,he=u*se,ue=d*ne,de=d*ae,pe=d*re,me=d*se;m=p;for(var fe=0;fe<u;fe++)m.r=ne,m.g=ae,m.b=re,m.a=se,m=m.next;for(var ge=n,ye=0,ve=0,be=0,_e=0,xe=1;xe<=r;xe++){b=ge+ie<<2;var we=u-xe;ue+=(m.r=ne=o[b])*we,de+=(m.g=ae=o[b+1])*we,pe+=(m.b=re=o[b+2])*we,me+=(m.a=se=o[b+3])*we,_e+=ne,ye+=ae,ve+=re,be+=se,m=m.next,xe<h&&(ge+=n)}b=ie,g=p,y=s;for(var Se=0;Se<a;Se++){var Me=b<<2;o[Me+3]=se=me*_>>x,se>0?(se=255/se,o[Me]=(ue*_>>x)*se,o[Me+1]=(de*_>>x)*se,o[Me+2]=(pe*_>>x)*se):o[Me]=o[Me+1]=o[Me+2]=0,ue-=oe,de-=le,pe-=ce,me-=he,oe-=g.r,le-=g.g,ce-=g.b,he-=g.a,Me=ie+((Me=Se+u)<h?Me:h)*n<<2,ue+=_e+=g.r=o[Me],de+=ye+=g.g=o[Me+1],pe+=ve+=g.b=o[Me+2],me+=be+=g.a=o[Me+3],g=g.next,oe+=ne=y.r,le+=ae=y.g,ce+=re=y.b,he+=se=y.a,_e-=ne,ye-=ae,ve-=re,be-=se,y=y.next,b+=n}}return e}(s,0,0,n,a,r),e.getContext("2d").putImageData(s,t,i)}(t,0,0,o,l,i):function(e,t,i,n,a,r){if(isNaN(r)||r<1)return;r|=0;var s=Wy(e,t,i,n,a);s=function(e,t,i,n,a,r){for(var s,o=e.data,l=2*r+1,c=n-1,h=a-1,u=r+1,d=u*(u+1)/2,p=new Yy,m=p,f=1;f<l;f++)m=m.next=new Yy,f===u&&(s=m);m.next=p;for(var g,y,v=null,b=null,_=Hy[r],x=Gy[r],w=0,S=0,M=0;M<a;M++){var T=o[S],A=o[S+1],E=o[S+2],C=u*T,I=u*A,P=u*E,R=d*T,O=d*A,D=d*E;m=p;for(var L=0;L<u;L++)m.r=T,m.g=A,m.b=E,m=m.next;for(var k=0,N=0,B=0,z=1;z<u;z++)g=S+((c<z?c:z)<<2),R+=(m.r=T=o[g])*(y=u-z),O+=(m.g=A=o[g+1])*y,D+=(m.b=E=o[g+2])*y,k+=T,N+=A,B+=E,m=m.next;v=p,b=s;for(var U=0;U<n;U++)o[S]=R*_>>x,o[S+1]=O*_>>x,o[S+2]=D*_>>x,R-=C,O-=I,D-=P,C-=v.r,I-=v.g,P-=v.b,g=w+((g=U+r+1)<c?g:c)<<2,R+=k+=v.r=o[g],O+=N+=v.g=o[g+1],D+=B+=v.b=o[g+2],v=v.next,C+=T=b.r,I+=A=b.g,P+=E=b.b,k-=T,N-=A,B-=E,b=b.next,S+=4;w+=n}for(var F=0;F<n;F++){var j=o[S=F<<2],H=o[S+1],G=o[S+2],V=u*j,W=u*H,Y=u*G,X=d*j,Z=d*H,q=d*G;m=p;for(var J=0;J<u;J++)m.r=j,m.g=H,m.b=G,m=m.next;for(var Q=0,K=0,$=0,ee=1,te=n;ee<=r;ee++)S=te+F<<2,X+=(m.r=j=o[S])*(y=u-ee),Z+=(m.g=H=o[S+1])*y,q+=(m.b=G=o[S+2])*y,Q+=j,K+=H,$+=G,m=m.next,ee<h&&(te+=n);S=F,v=p,b=s;for(var ie=0;ie<a;ie++)o[g=S<<2]=X*_>>x,o[g+1]=Z*_>>x,o[g+2]=q*_>>x,X-=V,Z-=W,q-=Y,V-=v.r,W-=v.g,Y-=v.b,g=F+((g=ie+u)<h?g:h)*n<<2,X+=Q+=v.r=o[g],Z+=K+=v.g=o[g+1],q+=$+=v.b=o[g+2],v=v.next,V+=j=b.r,W+=H=b.g,Y+=G=b.b,Q-=j,K-=H,$-=G,b=b.next,S+=n}return e}(s,0,0,n,a,r),e.getContext("2d").putImageData(s,t,i)}(t,0,0,o,l,i))}}}function Wy(e,t,i,n,a){if("string"==typeof e&&(e=document.getElementById(e)),!e||"object"!==jy(e)||!("getContext"in e))throw new TypeError("Expecting canvas with `getContext` method in processCanvasRGB(A) calls!");var r=e.getContext("2d");try{return r.getImageData(t,i,n,a)}catch(e){throw new Error("unable to access image data: "+e)}}var Yy=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.r=0,this.g=0,this.b=0,this.a=0,this.next=null};class Xy{constructor(e,t){this._definitionValue=0,this.pmremgenerator,this._definitionValue=0,this.canvas=document.createElement("canvas"),this.textureLoader=new al,this.cache=new Map,e?(this.pmremgenerator=new Vh(e),this.pmremgenerator.compileEquirectangularShader(Ep.background.isCustomSkybox)):console.error("Lost WebGLRenderer, PMERGenerator needs WebGLRenderer.")}get definition(){return this._definitionValue}set definition(e){this.definitionValueChange(e),this._definitionValue=e}getCache(e,t){if(!e||!e.name||"number"!=typeof t)return;const i=_y.md5(`${e.name}::${t}`);return this.cache.get(i)}setCache(e,t,i){if(!e||!e.name||"number"!=typeof t||!i)return;const n=_y.md5(`${e.name}::${t}`);this.cache.set(n,i)}destory(){this.cache.clear(),delete this.cache,this.canvas.remove(),this.img.remove(),this.img.destory()}cubeTextureBlur(e,t,i){if(!(e.images instanceof Array))return;if(new Qi,!e.srcImages){e.srcImages=[];for(let t=0;t<e.images.length;t++)e.srcImages[t]=e.images[t]}let n="";window.img=this.pmremgenerator.fromCubemap(e).texture.image,Vy(img,this.canvas,t,!0),n=this.canvas.toDataURL("image/png"),this.textureLoader.load(n,(e=>{"function"==typeof i&&i(e)}))}textureBlur(e,t,i){if(!e.image)return;if(e.srcImage||(e.srcImage=e.image),"function"!=typeof i)return;if(!t||t<=0)return void i(e);const n=this.getCache(e,t);if(n)return void i(n);Vy(e.image,this.canvas,t,!0);let a=this.canvas.toDataURL("image/png");this.textureLoader.load(a,(n=>{n.wrapS=d,n.name=e.name,n.flipY=!Ep.background.isCustomSkybox,this.setCache(e,t,n),"function"==typeof i&&i(n)}))}}class Zy{constructor(e){this.pmremGenerator,this.cache=new Map,e?(this.pmremGenerator=new Vh(e),this.pmremGenerator.compileEquirectangularShader(Ep.background.isCustomSkybox)):console.error("Lost WebGLRenderer, PMERGenerator needs WebGLRenderer.")}getCache(e,t,i){if(!e||!e.name||"number"!=typeof t||"number"!=typeof i)return;const n=_y.md5(`${e.name}::${t}::${i}`);return this.cache.get(n)}setCache(e,t,i,n){if(!e||!e.name||"number"!=typeof t||"number"!=typeof i||!n)return;const a=_y.md5(`${e.name}::${t}::${i}`);this.cache.set(a,n)}destory(){this.cache.clear(),delete this.cache}cubeTextureRotateY(e,t=0,i=1,n){if(!e)return;return this.pmremGenerator.fromEquirectangular(e,t,i,n).texture}}class qy{constructor({id:e=_y.guid(),name:t,children:i=[],material:n,isCastingShadow:a=!1,isReceivingShadow:r=!1,isRotating:s=!1,rotatingAxis:o="y",rotatingSpeed:l=1,isScaling:c=!1,isBreathing:h=!1,startScale:u=1,stopScale:d=2,fadeOutScale:p=1.5,scalingSpeed:m=.1,breathingSpeed:f=.1,endBreathe:g=1.5,isVisible:y=!0,isLock:v=!1,enableSSR:b=!1,modelNode:_}){this.id=e,this.name=t||this.id,this.children=i,this.material=n,this.isCastingShadow=a,this.isReceivingShadow=r,this.isRotating=s,this.rotatingAxis=o,this.rotatingSpeed=l,this.isScaling=c,this.isBreathing=h,this.startScale=u,this.stopScale=d,this.fadeOutScale=p,this.scalingSpeed=m,this.breathingSpeed=f,this.endBreathe=g,this.isVisible=y,this.isLock=v,this.enableSSR=b,this.isNode=!0;let x={};x.position=JSON.parse(JSON.stringify(_.position)),x.rotation=JSON.parse(JSON.stringify(_.rotation)),x.rotation.x=x.rotation._x,x.rotation.y=x.rotation._y,x.rotation.z=x.rotation._z,x.scale=JSON.parse(JSON.stringify(_.scale)),x.rotation.x=x.rotation._x=ge.radToDeg(x.rotation._x),x.rotation.y=x.rotation._y=ge.radToDeg(x.rotation._y),x.rotation.z=x.rotation._z=ge.radToDeg(x.rotation._z),this.transformNode=x;var w=_;this.getNodeMesh=()=>w,this.setProperty=(e,t,i)=>{switch(this[e]=t,w.userData&&(w.userData.nodeSettings={isRotating:this.isRotating,rotatingAxis:this.rotatingAxis,rotatingSpeed:this.rotatingSpeed,isScaling:this.isScaling,isBreathing:this.isBreathing,startScale:this.startScale,stopScale:this.stopScale,fadeOutScale:this.fadeOutScale,scalingSpeed:this.scalingSpeed,breathingSpeed:this.breathingSpeed,endBreathe:this.endBreathe,isLock:this.isLock}),e){case"isCastingShadow":w.castShadow=!!t,_y.setThreePropertyRecursively(w,"castShadow",!!t),_y.setNodePropertyRecursively(this,"isCastingShadow",!!t);break;case"isReceivingShadow":w.receiveShadow=!!t,_y.setThreePropertyRecursively(w,"receiveShadow",!!t),_y.setNodePropertyRecursively(this,"isReceivingShadow",!!t);break;case"isVisible":w.visible=!!t,_y.setThreePropertyRecursively(w,"visible",!!t),_y.setNodePropertyRecursively(this,"isVisible",!!t);break;case"isRotating":case"rotatingAxis":case"rotatingSpeed":Ep.scene.setNodeRotating&&Ep.scene.setNodeRotating({enabled:this.isRotating,node:w,rotatingAxis:this.rotatingAxis,rotatingSpeed:this.rotatingSpeed});break;case"isScaling":case"startScale":case"stopScale":case"fadeOutScale":case"scalingSpeed":Ep.scene.setNodeScaling&&Ep.scene.setNodeScaling({enabled:this.isScaling,node:w,startScale:this.startScale,stopScale:this.stopScale,fadeOutScale:this.fadeOutScale,scalingSpeed:this.scalingSpeed});break;case"isBreathing":case"breathingSpeed":Ep.scene.setNodeBreathing&&Ep.scene.setNodeBreathing({enabled:this.isBreathing,node:w,endBreathe:this.endBreathe,breathingSpeed:this.breathingSpeed});break;case"enableSSR":this.enableSSR&&Ep.instance.ssrOn&&setTimeout((()=>{Ep.instance.ssrOn(this.name,this.modelName)}),500);break;case"transformNode":i||(this.transformNode=t,w.position.set(t.position.x,t.position.y,t.position.z),w.scale.set(t.scale.x,t.scale.y,t.scale.z),w.rotation.order=t.rotation._order,w.rotation.x=ge.degToRad(t.rotation.x),w.rotation.y=ge.degToRad(t.rotation.y),w.rotation.z=ge.degToRad(t.rotation.z))}}}dispose(){this.children&&this.children.forEach((e=>{_y.disposeThreeObject(e)})),this.children=null,this.material instanceof Array&&(this.material.forEach((e=>{_y.disposeThreeObject(e)})),this.material=null)}}qy._fromThreeObject=function(e){let t,{uuid:i,name:n,type:a,material:r,castShadow:s,receiveShadow:o,visible:l,isLock:c,children:h,userData:u}=e;if(r instanceof Array){t=[];for(let e of r)t.push(e.name)}else t=r?r.name:void 0;let d=new qy({id:i,name:n,material:t,isCastingShadow:s,isReceivingShadow:o,isVisible:l,isLock:c,modelNode:e});if(u.nodeSettings&&(d.isRotating=u.nodeSettings.isRotating,d.rotatingAxis=u.nodeSettings.rotatingAxis,d.rotatingSpeed=u.nodeSettings.rotatingSpeed,d.isScaling=u.nodeSettings.isScaling,d.isBreathing=u.nodeSettings.isBreathing,d.startScale=u.nodeSettings.startScale,d.stopScale=u.nodeSettings.stopScale,d.fadeOutScale=u.nodeSettings.fadeOutScale,d.scalingSpeed=u.nodeSettings.scalingSpeed,d.breathingSpeed=u.nodeSettings.breathingSpeed,d.endBreathe=u.nodeSettings.endBreathe,d.isLock=u.nodeSettings.isLock),h instanceof Array)for(let e of h)d.children.push(qy._fromThreeObject(e));return d};var Jy={type:"axisTypeChange"},Qy={type:"mouseDown"},Ky={type:"mouseUp",mode:null};class $y extends pe{constructor(){super("NodeSelection");let e="centre",t=new Map,i=new Et,n=new Ce,a=new dt,r=new Ce,s=[];this.controlsState=!1;let o=e=>{let t={};t.position=JSON.parse(JSON.stringify(e.threeObject.position)),t.rotation=JSON.parse(JSON.stringify(e.threeObject.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(e.threeObject.scale)),t.rotation.x=t.rotation._x=ge.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=ge.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=ge.radToDeg(t.rotation._z),e.userObject.transformNode=t},l=e=>{let i=e.target.object.position.clone().sub(n);n=e.target.object.position.clone(),t.forEach((e=>{let t=i.clone();t.divide(e.threeObject.parent.getWorldScale(new Ce));let n=new it;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Ee)).invert(),t.applyMatrix4(n);let a=e.transform.position.clone().add(t);e.threeObject.position.copy(a),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone(),e.transform.scale=e.threeObject.scale.clone(),o(e)}))},c=i=>{let n=i.target.axis.toLocaleLowerCase();if("e"!==n&&0!==i.target.rotationAngleDelta)if("centre"===e){let e=i.target.object.position.clone();t.forEach((t=>{((e,t,i,n)=>{if(!e||!e.position)return;if(!t)return;if("x"!==i&&"y"!==i&&"z"!==i)return;const a=e.getWorldPosition(new Ce);a.sub(t);const r={x:new Ce(1,0,0),y:new Ce(0,1,0),z:new Ce(0,0,1)};a.applyAxisAngle(r[i],n),e.rotateOnWorldAxis(r[i],n);let s=e.parent.getWorldPosition(new Ce);a.add(t),a.sub(s),a.divide(e.parent.getWorldScale(new Ce));let o=new it;o.makeRotationFromQuaternion(e.parent.getWorldQuaternion(new Ee)).invert(),a.applyMatrix4(o),e.position.copy(a)})(t.threeObject,e,n,i.target.rotationAngleDelta),o(t)}))}else"oneself"===e&&t.forEach((e=>{e.threeObject[`rotate${n.toLocaleUpperCase()}`](i.target.rotationAngleDelta),o(e)}))},h=e=>{let i=e.target.object.scale.clone();t.forEach((e=>{let t=i.clone(),n=new it;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Ee)).invert(),t.applyMatrix4(n);let a=e.transform.scale;e.threeObject.scale.set(a.x*t.x,a.y*t.y,a.z*t.z),o(e)}))};this.clearSelection=()=>{s.length=0,t.clear()},this.deselectNodes=e=>{logger.warn("NodeSelection.deselectNodes(): TO BE IMPLEMENTED.")},this.dispose=()=>{s.forEach((e=>{e.dispose&&e.dispose()})),s=[],t.clear()},this.getAllProperties=()=>{if(t.size<1)return null;if(1===t.size){let e=this.getSelectionList();return t.get(e[0]).userObject}let n={};return t.forEach((e=>{for(let t in e.userObject)switch(t){case"id":case"children":case"material":break;case"isCastingShadow":case"isReceivingShadow":case"isRotating":case"rotatingAxis":case"rotatingSpeed":case"isScaling":case"startScale":case"StopScale":case"FadeOutScale":case"ScalingSpeed":n.hasOwnProperty(t)?n[t]=_y.eq(n[t],e.userObject[t])?n[t]:null:n[t]=_y.clone(e.userObject[t])}})),"centre"==e?(n.transformNode={},n.transformNode.position=JSON.parse(JSON.stringify(i.position)),n.transformNode.rotation=JSON.parse(JSON.stringify(i.rotation)),n.transformNode.rotation.x=n.transformNode.rotation._x,n.transformNode.rotation.y=n.transformNode.rotation._y,n.transformNode.rotation.z=n.transformNode.rotation._z,n.transformNode.scale=JSON.parse(JSON.stringify(i.scale)),n.transformNode.rotation.x=n.transformNode.rotation._x=ge.radToDeg(n.transformNode.rotation._x),n.transformNode.rotation.y=n.transformNode.rotation._y=ge.radToDeg(n.transformNode.rotation._y),n.transformNode.rotation.z=n.transformNode.rotation._z=ge.radToDeg(n.transformNode.rotation._z)):"oneself"==e&&(n.transformNode={},t.forEach((e=>{let t={};for(var i in t.position=JSON.parse(JSON.stringify(e.threeObject.position)),t.rotation=JSON.parse(JSON.stringify(e.threeObject.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(e.threeObject.scale)),t.rotation.x=t.rotation._x=ge.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=ge.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=ge.radToDeg(t.rotation._z),t)if(n.transformNode.hasOwnProperty(i))for(let e in t[i])n.transformNode[i]&&!n.transformNode[i].hasOwnProperty(e)?n.transformNode[i][e]=_y.clone(t[i][e]):n.transformNode[i][e]=_y.eq(n.transformNode[i][e],t[i][e])?n.transformNode[i][e]:"--";else n.transformNode[i]=_y.clone(t[i])}))),delete n.id,delete n.children,delete n.material,n},this.getProperty=(e="")=>{if(t.size<1)return null;if(1===t.size){let e=this.getSelectionList();return t.get(e[0]).userObject}switch(e){case"id":case"children":case"material":needContinue=!0}if(needContinue)return null;let i;return t.forEach((t=>{i=void 0===i?_y.clone(t.userObject[e]):_y.eq(i,t.userObject[e])?i:null})),i},this.merge=()=>(logger.warn("NodeSelection.merge(): TO BE IMPLEMENTED."),new qy),this.setProperties=e=>{if("object"==typeof e)for(let i in e){let n=!1;switch(i){case"id":case"name":case"children":case"material":n=!0}n||t.forEach((t=>{t.userObject[i]=e[i]}))}else logger.warn("NodeSelection.setProperties(): Invalid properties object specified.")},this.setProperty=(e="",i,n)=>{if(logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Entering.",e,i),""===e)return logger.warn("NodeSelection.setProperty(): No propertyName specified."),void logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Exiting.");if(e.indexOf("transformNode")>-1)this.setPropertyTransformNode(e,i);else switch(e){case"id":case"name":case"children":case"material":return logger.warn("NodeSelection.setProperty(): Given propertyName conflicts with an reserved property."),void logger.debug("TRACE: NodeSelection.    (propertyName, propertyValue) - Exiting.");default:t.forEach((t=>{if(Ep.scene){let a=t.threeObject,r=t.userObject;"Object3D"!==a.type&&"Group"!==a.type&&!a.isMesh||a.name!==r.name||r.setProperty(e,i,n)}}))}},this.setPropertyByUUID=(e,t="",i,n)=>{if(logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Entering.",t,i),""===t)return logger.warn("NodeSelection.setProperty(): No propertyName specified."),void logger.debug("TRACE: NodeSelection.setProperty (propertyName, propertyValue) - Exiting.");let a=Ep.instance.defaultObjectTree.getItemByUUID(e);a instanceof qy&&a.setProperty(t,i,n)},this.setPropertyTransformNode=(n="",a)=>{if(""===n)return;if(-1===n.indexOf("transformNode"))return;let r=n.split("-");if(Ep.transformControls.dispatchEvent(Qy),"oneself"===e)t.forEach(((e,t)=>{let i=JSON.parse(JSON.stringify(Ep.instance.getModelTransformByUUID(t)));3==r.length?i[r[1]][r[2]]=a:2==r.length&&(i[r[1]]=a),Ep.instance.setModelTransformByUUID(t,i)})),this.enableTransformControl();else if("centre"===e){let e=["x","y","z"];if("rotation"===r[1])if(3==r.length){let e=i.rotation[r[2]];i[`rotate${r[2].toUpperCase()}`](ge.degToRad(a)-e);let t={target:{axis:r[2],object:i,rotationAngleDelta:ge.degToRad(a)-e}};c(t)}else 2==r.length&&e.forEach((e=>{let t=i.rotation[e];i[`rotate${e.toUpperCase()}`](ge.degToRad(a[e])-t);let n={target:{axis:e,object:i,rotationAngleDelta:ge.degToRad(a[e])-t}};c(n)}));else if("position"===r[1])if(3==r.length){i.position[`set${r[2].toUpperCase()}`](a),l({target:{object:i}})}else 2==r.length&&e.forEach((e=>{i.position[`set${e.toUpperCase()}`](a[e]),l({target:{object:i}})}));else if("scale"===r[1])if(3==r.length){i.scale[`set${r[2].toUpperCase()}`](a),h({target:{object:i}})}else 2==r.length&&e.forEach((e=>{i.scale[`set${e.toUpperCase()}`](a[e]),h({target:{object:i}})}))}Ky.mode=Ep.transformControls.mode,Ep.transformControls.dispatchEvent(Ky)},this.selectNodes=(e,t=!1)=>{if(t||(s.length=0),!(e instanceof Array)||e.length<1)return void logger.warn("NodeSelection.selectNodes(): No node selected.");let i=!1;for(let t of e)t instanceof qy?s.push(t):i=!0;return i&&logger.warn("NodeSelection.selectNodes(): Invalid input found."),s.length},this.getSelectionList=()=>{let e=[];return t.forEach(((t,i)=>{e.push(i)})),e},this.getSelectionListByName=()=>{let e=[];return t.forEach(((t,i)=>{e.push(t.threeObject.name)})),e},this.selectObjectByUUID=(e=[])=>(t.clear(),Ep.effectStore.highlightObject(null),e.forEach((e=>{let i={threeObject:null,userObject:null,transform:{}},n=Ep.instance.defaultObjectTree.getItemByUUID(e),a=Ep.scene.getObjectByProperty("uuid",e);n&&n instanceof qy?(i.userObject=n,i.threeObject=a,i.transform.position=a.position.clone(),i.transform.rotation=a.rotation.clone(),i.transform.scale=a.scale.clone(),t.set(e,i),Ep.effectStore.highlightObject(i.threeObject,!0)):logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found.")})),this.controlsState&&this.enableTransformControl(),this.getSelectionList()),this.setSelectNodeByUUID=e=>{t.forEach(((e,t)=>{e.transform.scale=e.threeObject.scale.clone(),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone()}));let i={threeObject:null,userObject:null,transform:{}},n=Ep.instance.defaultObjectTree.getItemByUUID(e),a=Ep.scene.getObjectByProperty("uuid",e);return n&&n instanceof qy?(i.userObject=n,i.threeObject=a,i.transform.position=a.position.clone(),i.transform.rotation=a.rotation.clone(),i.transform.scale=a.scale.clone(),1==t.size&&t.forEach((e=>{e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone(),e.transform.scale=e.threeObject.scale.clone()})),t.set(e,i),Ep.effectStore.highlightObject(i.threeObject,!0),this.controlsState&&this.enableTransformControl()):logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found."),this.getSelectionList()},this.deleteSelectNodeByUUID=e=>(t.forEach(((e,t)=>{e.transform.scale=e.threeObject.scale.clone(),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone()})),t.get(e)?(Ep.effectStore.cancleHighlightObject(t.get(e).threeObject),t.delete(e),this.controlsState&&this.enableTransformControl(),this.getSelectionList()):(logger.warn("ModeSelection.deleteSelectObjectByUUID(): Invalid input found."),this.getSelectionList())),this.toggleSelectObjectByUUID=e=>(t.get(e)?this.deleteSelectNodeByUUID(e):this.setSelectNodeByUUID(e),this.getSelectionList()),this.getCenterPosition=()=>{let e=[];if(t.forEach((t=>{t.threeObject.traverse((t=>{let i=t.getWorldPosition(new Ce);if(t.geometry){t.geometry.computeBoundingBox();let n=t.geometry.boundingBox.getCenter(new Ce);i.add(n),e.push(i)}else t.children&&t.children.length||e.push(i)}))})),!e.length)return new Ce;let i=e[0].clone(),n=e[0].clone();return e.forEach((e=>{i.min(e),n.max(e)})),new Re(i,n).getCenter(new Ce)},this.enableTransformControl=()=>{if(this.disableTransformControl(),1===t.size){let e=this.getSelectionList();return void Ep.transformControls.attach(t.get(e[0]).threeObject)}if(t.size<1)return;this.controlsState=!0;let e=this.getCenterPosition();i.position.copy(e),i.rotation.set(0,0,0),i.scale.set(1,1,1),n.copy(e),a.copy(i.rotation),r.copy(i.scale),Ep.scene.add(i),Ep.transformControls.addEventListener("translate",l),Ep.transformControls.addEventListener("rotate",c),Ep.transformControls.addEventListener("scale",h),Ep.transformControls.attach(i),Ep.transformControls.showE=!1},this.disableTransformControl=()=>{Ep.transformControls.removeEventListener("translate",l),Ep.transformControls.removeEventListener("rotate",c),Ep.transformControls.removeEventListener("scale",h),Ep.transformControls.showE=!0,this.controlsState=!1,Ep.transformControls.object&&Ep.transformControls.detach()},this.onTransformControlsEvent=(e,t)=>(Ep.transformControls.addEventListener(e,t),1),this.offTransformControlsEvent=(e,t)=>(Ep.transformControls.removeEventListener(e,t),1),this.getAxisType=()=>e,this.setAxisType=t=>("centre"!=t&&"oneself"!=t||(e=t,this.dispatchEvent(Jy)),e),this.getSelectedNodeMap=()=>t}}class ev{constructor(e){let t=e;function i(e){return e=e.sort(((e,t)=>e.index-t.index))}this.type=t,this.children=[],this.isVisible=!0,this.isLock=!1,this._nodeSelection=new $y(Ep.scene),this.getType=()=>this.type,this.transform={position:{x:0,y:0,z:0},rotation:{_x:0,_y:0,_z:0,_order:"XYZ"},scale:{x:1,y:1,z:1}},this.isModel=()=>"modelitem"===t.toLowerCase(),this.isFolder=()=>"folderitem"===t.toLowerCase(),this.dispose=(e,t)=>{if(!(Ep.transformControls.object&&Ep.transformControls.object.userData&&"number"==typeof Ep.transformControls.object.userData.handlerIndex&&Ep.transformControls.object.userData.handlerIndex>=0)&&e&&Ep.instance.disableTransform(),"PackedItem"!=this.type&&this.modelItemSSROffRecursion(this.children,e),void 0===e)for(const e of this.children)e.isInstancedItem&&e.remove();for(let t=this.children.length-1;t>=0;t--)if(this.children[t].name===e){if(this.children[t].key,_y.disposeThreeObject(this.children[t].getGroup()),this.children[t].particleStoreArray&&this.children[t].particleStoreArray.forEach((e=>{e.dispose()})),this.children[t].isInstancedItem){let e=this.modelInstanced.find((e=>e.name==this.children[t].parent));if("ModelAsset"==this.children[t].type||"ModelItem"==this.children[t].type)for(let i=0;i<this.children.length;i++)this.children[i].isInstancedItem&&this.children[i].parent==e.name&&this.children[i].key>this.children[t].key&&(this.children[i].key=this.children[i].key-1);this.children[t].remove()}else this.children[t].dispose&&this.children[t].dispose(),this.getGroup().remove(this.children[t].getGroup());this.children.splice(t,1),"PaintItem"!==this.type||this.children.length||Ep.defaultObjectTree.remove(this.name)}i(this.children),Ep.instance.cutLevelByUUID(this.getGroup().uuid,!1),"LineItem"!=this.type&&"PluginItem"!=this.type||this.destroy(),t&&t(1,"删除成功")},this.traverse=(e,t)=>{if(e&&"function"==typeof e&&this.children&&this.children instanceof Array){t||(t=this.children,e(this));for(let i of t)e(i),i.children instanceof Array&&this.traverse(e,i.children)}},this.remove=(e,t)=>{Ep.instance.disableTransform(),"PackedItem"!=this.type&&this.modelItemSSROffRecursion(this.children,e);for(let t=this.children.length-1;t>=0;t--)this.children[t].name===e&&(this.getGroup().remove(this.children[t].getGroup()),this.children.splice(t,1));i(this.children),Ep.instance.cutLevelByUUID(this.getGroup().uuid,!1),t&&t(1,"删除成功")},this.hide=()=>{Ep.scene&&Ep.scene.children.map((e=>{"__sysObjectsWater"===e.name&&e.children.map((e=>{e.userData.modelName===this.name&&(e.visible=!1)}))}));let e=this.getGroup();e&&(e.visible=!1,e.activeVisible=!1),this.isVisible=!1},this.show=()=>{Ep.scene&&Ep.scene.children.map((e=>{"__sysObjectsWater"===e.name&&e.children.map((e=>{e.userData.modelName===this.name&&(e.visible=!0)}))}));let e=this.getGroup();e&&(e.visible=!0,e.activeVisible=!0),this.isVisible=!0},this.rename=(e,t)=>{if(e){for(let t=0;t<Ep.ssr.length;t++)Ep.ssr[t].modelName===this.name&&(Ep.ssr[t].modelName=e);if(this.name=e,this.getGroup().name=e,this.materialStore)for(let t in this.materialStore._materials)this.materialStore._materials[t]._modelName=e;for(let t=0;t<this.children.length;t++)this.children[t].parent&&(this.children[t].parent=e);t&&t(1,"模型重命名成功")}},this.copy=(e,t)=>{if(e){Ep.copyModel=null;for(let i=0;i<this.children.length;i++)switch(this.children[i].type){case"ModelItem":case"IconAsset":case"PaperCutItem":if(this.children[i].name===e)return Ep.copyModel=this.children[i].getSettings(),Ep.copyModel.transform.position=_y.changeTransformFromScene(Ep.copyModel,this.getGroup().parent,this.getGroup()).position,void(t&&t(1,"复制成功"));break;case"BuildingFloorItem":for(let n=0;n<this.children[i].children.length;n++)if(this.children[i].children[n].name===e)return Ep.copyModel=this.children[i].children[n].getSettings(),Ep.copyModel.transform.position=_y.changeTransformFromScene(Ep.copyModel,this.getGroup().parent,this.getGroup()).position,void(t&&t(1,"复制成功"))}}},this.paste=e=>{if(Ep.copyModel){let t=JSON.parse(JSON.stringify(Ep.copyModel));switch(t.name=_y.getCopyName(t.name+"副本",0,Ep.defaultObjectTree),this.type){case"BuildingItem":case"BuildingFloorItem":t.parent=this.name,t.index=void 0,delete t.id,this.addNoneFloor(t,(i=>{1===i&&("ModelItem"===t.type?this.pasteLater(this,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))}));break;case"BuildingRoomItem":t.parent=this.name,t.index=void 0,delete t.id,this.addNoneRoom(t,(i=>{1===i&&("ModelItem"===t.type?this.pasteLater(this,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))}));break;case"ModelItem":case"IconAsset":case"PaperCutItem":if("objectTree"===this.parent)t.parent="objectTree",t.index=void 0,delete t.id,"ModelItem"===t.type?Ep.defaultObjectTree.addModel(t,(i=>{1===i&&this.pasteLater(Ep.defaultObjectTree,t,(t=>{1===t&&e&&e(1,"粘贴成功")}))})):"IconAsset"===t.type?Ep.defaultObjectTree.addIconAsset(t,null,(t=>{1===t&&e&&e(1,"粘贴成功")})):"PaperCutItem"===t.type&&Ep.defaultObjectTree.addPaperCutItem(t,(t=>{1===t&&e&&e(1,"粘贴成功")}));else{let i=Ep.defaultObjectTree.getItemByUUID(this.getGroup().parent.uuid);i?(t.parent=i.name,t.index=i.children.length,delete t.id,"BuildingFloorItem"===i.type?i.addNoneFloor(t,(n=>{1===n&&("ModelItem"===t.type?this.pasteLater(i,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))})):"BuildingRoomItem"===i.type&&i.addNoneRoom(t,(n=>{1===n&&("ModelItem"===t.type?this.pasteLater(i,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))}))):Ep.instance.defaultObjectTree.children.forEach((i=>{"BuildingItem"===i.type&&i.children.forEach((i=>{"BuildingFloorItem"===i.type&&this.parent===i.name&&(t.parent=i.name,t.index=i.children.length,delete t.id,i.addNoneFloor(t,(n=>{1===n&&("ModelItem"===t.type?this.pasteLater(i,t,(t=>{1===t&&e&&e(1,"粘贴成功")})):e&&e(1,"粘贴成功"))})))}))}))}}}else e&&e(0,"用户没有进行复制无法粘贴")},this.pasteLater=(e,t,i)=>{if(e&&t){if("ModelItem"===t.type){let i=e.getItemByName(t.name);e.getItemByName(t.name).materialStore.applySettings(t.materials),_y.setNode(t,i,this._nodeSelection),_y.setArticulation(t,i),Ep.instance.cutLevelByUUID(e.getGroup().uuid,!1),t.children&&this.modelItemSSROnRecursion(t.children,t.name);for(let e in t.materials)t.materials[e].enableTranslation&&Ep.instance.setMaterialAnimation({name:t.materials[e].name,enableTranslation:t.materials[e].enableTranslation,translationSpeedU:t.materials[e].translationSpeedU,translationSpeedV:t.materials[e].translationSpeedV,modelName:t.name})}else"IconAsset"===t.type||t.type;i&&i(1,"成功")}else i&&i(0,"参数错误")},this.move=(e,t)=>{e||t&&t(0,"参数错误");let i=Ep.defaultObjectTree.getItemByName(e),n=null;i.getSettings().children&&"PackedItem"!=i.type&&(n=JSON.parse(JSON.stringify(i.getSettings().children))),i||t&&t(0,"目标不存在");let a=JSON.parse(JSON.stringify(i.getGroup().parent.uuid));i.parent=this.name,i.clipping=!1,this.children.push(i),this.getGroup().add(i.getGroup()),"objectTree"===parent?Ep.defaultObjectTree.remove(i.name):Ep.defaultObjectTree.getItemByUUID(a).remove(i.name),n&&this.modelItemSSROnRecursion(n,i.name),t&&t(1,"移动成功")},this.getModelTransform=(e,t)=>{var i={};for(let t=0;t<this.children.length;t++)if("ModelItem"===this.children[t].type||"IconAsset"===this.children[t].type)this.children[t].name===e&&(i=_y.getModelTransform(this.children[t].getGroup()));else if("BuildingFloorItem"===this.children[t].type)if(this.children[t].name===e)i=_y.getModelTransform(this.children[t].getGroup());else for(let n=0;n<this.children[t].children.length;n++)this.children[t].children[n].name===e&&(i=_y.getModelTransform(this.children[t].children[n].getGroup()));return t&&t(1,"获取成功"),i},this.setModelTransform=(e,t,i)=>{for(let i=0;i<this.children.length;i++)if("ModelItem"===this.children[i].type||"IconAsset"===this.children[i].type)this.children[i].name===e&&Ep.instance.setTransform(this.children[i].getGroup(),t);else if("BuildingFloorItem"===this.children[i].type)if(this.children[i].name===e)Ep.instance.setTransform(this.children[i].getGroup(),t);else for(let n=0;n<this.children[i].children.length;n++)this.children[i].children[n].name===e&&Ep.instance.setTransform(this.children[i].children[n].getGroup(),t);i&&i(1,"设置成功")},this.addModelFromScene=(e,t)=>{e||t&&t(0,"参数错误"),Ep.instance.disableTransform();let i=Ep.instance.defaultObjectTree.children.find((t=>t.name===e)),n=null;i.getSettings().children&&"PackedItem"!=i.type&&(n=JSON.parse(JSON.stringify(i.getSettings().children))),i||t&&t(0,"对象不存在"),i.index=this.children.length,i.parent=this.name,i.parentUUID=this.getGroup().uuid,this.children.push(i);var a={transform:{position:i.getGroup().position}};"BuildingItem"===this.type?_y.changeTransformFromBuilding(a,this.getGroup()):"BuildingFloorItem"===this.type?_y.changeTransformFromBuilding(a,this.getGroup().parent,this.getGroup()):"BuildingRoomItem"===this.type&&_y.changeTransformFromBuilding(a,this.getGroup().parent.parent,this.getGroup().parent,this.getGroup()),this.getGroup().add(i.getGroup()),Ep.instance.defaultObjectTree.remove(e),n&&this.modelItemSSROnRecursion(n,i.name),t&&t(1,"添加成功"),"BuildingItem"==this.type?Ep.instance.cutLevel(this.getGroup().uuid,this.floor):"BuildingFloorItem"===this.type&&Ep.instance.cutLevel(this.getGroup().parent.uuid,Ep.defaultObjectTree.getItemByUUID(this.getGroup().parent.uuid).floor)},this.removeFromBuilding=(e,t)=>{e||t&&t(0,"参数错误"),Ep.instance.disableTransform();let i=this.getItemByName(e),n=null;i.getSettings().children&&"PackedItem"!=i.type&&(n=JSON.parse(JSON.stringify(i.getSettings().children))),i||t&&t(0,"对象不存在"),i.index=void 0,i.parent="objectTree",Ep.instance.defaultObjectTree.addItem(i);var a={transform:{position:i.getGroup().position}};let r=null,s=this.getGroup(),o={};"BuildingItem"===this.type?(o=_y.changeTransformFromScene(a,s).position,r=s.uuid):"BuildingFloorItem"===this.type?(o=_y.changeTransformFromScene(a,s.parent,s).position,r=s.parent.uuid):"BuildingRoomItem"===this.type&&(o=_y.changeTransformFromScene(a,s.parent.parent,s.parent,s).position,r=s.parent.parent.uuid),i.getGroup().position.set(o.x,o.y,o.z),Ep.scene.models.add(i.getGroup()),this.remove(e),Ep.instance.clipNode(this.name,0,0,0,0),Ep.instance.cutLevelByUUID(r),n&&this.modelItemSSROnRecursion(n,i.name),t&&t(1,"移除成功")},this.modelItemSSROnRecursion=(e,t)=>{for(let i=0;i<e.length;i++)e[i].enableSSR&&Ep.instance.ssrOn(e[i].name,t),e[i].children&&e[i].children.length>0&&this.modelItemSSROnRecursion(e[i].children,t)},this.modelItemSSROffRecursion=(e,t)=>{for(let i=0;i<e.length;i++)e[i].enableSSR&&Ep.instance.ssrOff(e[i].name,t),e[i].children&&e[i].children.length>0&&this.modelItemSSROffRecursion(e[i].children,t)},this._getVisible=()=>this.isVisible,this._setVisible=e=>{this.isVisible=e},this._getLock=()=>this.isLock,this._setLock=e=>{this.isLock=e},this.lock=()=>{this.isLock=!0},this.unLock=()=>{this.isLock=!1}}}class tv extends ev{constructor(e,t){super("EffectPathItem"),this.type="EffectPathItem",this.name=e?e.name:"",this.parentGroup=null,this.object=null,this.points=[],this.pathStyle="",this.pathWidth=10,this.textureSizeCoef=0,this.speed=0,this.enableUv=!0,this.dispose=()=>{if(!this.object)return;const e=Ep.animationStore.findMaterialAnimation(this.object.children[0].material,"UVMeshLineAnimationController");e&&Ep.animationStore.remove(e),_y.disposeThreeObject(this.object),this.parentGroup.remove(this.object)}}async loadPath(e,t,i,n,a,r,s="#ff0000"){void 0!==e&&(this.waiteLoad={points:e,pathStyle:t,pathWidth:i,textureSizeCoef:n,speed:a,enableUv:r,pathColor:s});const o=this;!0!==o.loading&&(o.loading=!0,o.points=o.waiteLoad.points,o.pathStyle=o.waiteLoad.pathStyle,o.pathWidth=o.waiteLoad.pathWidth,o.textureSizeCoef=o.waiteLoad.textureSizeCoef,o.speed=o.waiteLoad.speed,o.enableUv=o.waiteLoad.enableUv,o.pathColor=o.waiteLoad.pathColor,o.waiteLoad=void 0,Ep.instance.addPath(o.name,{name:_y.guid(),renderOrder:0,points:o.points,pathType:o.pathStyle,color:o.pathColor,alpha:1,width:o.pathWidth,pass:0,isShow:!0},((e,t)=>{if(delete Ep.objectStore._objects[e.name],o.object){const i="UVMeshLineAnimationController",n=Ep.animationStore.findMaterialAnimation(o.object.children[0].material,i);o.object.children[0].geometry.dispose(),o.object.children[0].material.dispose(),o.object.children[0].material.map.dispose(),o.object.children[0].position.copy(e.children[0].position),o.object.children[0].geometry=e.children[0].geometry.clone(),o.object.children[0].material=e.children[0].material.clone();const a=t;n.material=o.object.children[0].material,n.enableU=a.enableU&&o.enableUv,n.enableV=a.enableV&&o.enableUv,n.uSpeed=a.uSpeed*o.speed,n.vSpeed=a.vSpeed*o.speed,a&&Ep.animationStore.remove(a),o.object.position.copy(e.position),e.parent.remove(e),_y.disposeThreeObject(e)}else o.object=e,o.object.name=o.name,o.parentGroup&&o.parentGroup.add(e),t.enableU=o.enableUv,t.enableV=o.enableUv,t.uSpeed*=o.speed,t.vSpeed*=o.speed;o.object.children[0].material.repeat.x/=o.textureSizeCoef,o.loading=!1,void 0!==o.waiteLoad&&o.loadPath()})))}getSettings(){return{name:this.name,points:this.points,pathStyle:this.pathStyle,pathWidth:this.pathWidth,textureSizeCoef:this.textureSizeCoef,speed:this.speed,pathColor:this.pathColor}}getGroup(){return this.object}}class iv extends gy{constructor(e,t){super("AreaLineAnimationController"),this.animationObject=e,this.resolution=t,this.render=e=>{null!=this.animationObject&&this.animationObject.resolution.set(this.resolution.x/4,this.resolution.y/4)},this.reset=()=>{},this.dispose=()=>{_y.disposeThreeObject(this.animationObject),this.animationObject=null}}}iv.type="AreaLineAnimationController";class nv extends gy{constructor(e,t,i,n,a){super("UVAnimationController"),this.material=e,this.enableU=t,this.enableV=i,this.uSpeed=n,this.vSpeed=a;let r=this._findFirstAvailableMapForUV();r&&!this.material._uvDefault&&(this.material._uvDefault={wrapS:r.wrapS,wrapT:r.wrapT,repeat:r.repeat?r.repeat.clone():void 0,offset:r.offset?r.offset.clone():void 0}),this.reset=()=>{let e=this._findFirstAvailableMapForUV();e&&this.material&&this.material._uvDefault&&(e.repeat.x=this.material._uvDefault.repeat.x,e.repeat.y=this.material._uvDefault.repeat.y,e.offset.x=this.material._uvDefault.offset.x,e.offset.y=this.material._uvDefault.offset.y)},this.dispose=()=>{_y.disposeThreeObject(this.material)}}_findFirstAvailableMapForUV(){if(this.material)return this.material.map||this.material.specularMap||this.material.displacementMap||this.material.normalMap||this.material.bumpMap||this.material.roughnessMap||this.material.metalnessMap||this.material.alphaMap||this.material.emissiveMap}render(e){null!=this.material&&(this.enableU&&(null!=this.material.map&&(this.material.map.offset.x=(this.material.map.offset.x+this.uSpeed*e)%1),null!=this.material.emissiveMap&&(this.material.emissiveMap.offset.x=(this.material.emissiveMap.offset.x+this.uSpeed*e)%1),null!=this.material.alphaMap&&(this.material.alphaMap.offset.x=(this.material.alphaMap.offset.x+this.uSpeed*e)%1),null!=this.material.normalMap&&(this.material.normalMap.offset.x=(this.material.normalMap.offset.x+this.uSpeed*e)%1),null!=this.material.bumpMap&&(this.material.bumpMap.offset.x=(this.material.bumpMap.offset.x+this.uSpeed*e)%1)),this.enableV&&(null!=this.material.map&&(this.material.map.offset.y=(this.material.map.offset.y+this.vSpeed*e)%1),null!=this.material.emissiveMap&&(this.material.emissiveMap.offset.y=(this.material.emissiveMap.offset.y+this.vSpeed*e)%1),null!=this.material.alphaMap&&(this.material.alphaMap.offset.y=(this.material.alphaMap.offset.y+this.vSpeed*e)%1),null!=this.material.normalMap&&(this.material.normalMap.offset.y=(this.material.normalMap.offset.y+this.vSpeed*e)%1),null!=this.material.bumpMap&&(this.material.bumpMap.offset.y=(this.material.bumpMap.offset.y+this.vSpeed*e)%1)))}}nv.type="UVAnimationController";let av="none",rv="round",sv="repeat",ov={translationX:"translationX",translationY:"translationY",translationZ:"translationZ",rotationX:"rotationX",rotationY:"rotationY",rotationZ:"rotationZ",scaleX:"scaleX",scaleY:"scaleY",scaleZ:"scaleZ",opacity:"opacity",colorOverlay:"colorOverlay",colorReplace:"colorReplace",stroke:"stroke",quantityFactor:"quantityFactor",USpeed:"USpeed",VSpeed:"VSpeed",materialsReplace:"materialsReplace",visible:"visible"};class lv{constructor(e,t,i,n){null==t&&null==i&&null==n?(this.color=new Qt(this._getrgbaNum(e,0)/255,this._getrgbaNum(e,1)/255,this._getrgbaNum(e,2)/255),this.alpha=this._getrgbaNum(e,3)):(this.color=new Qt(e,t,i),this.alpha=n)}_getrgbaNum(e="rgba(255,255,255,0)",t){let i=e.match(/(\d(\.\d+)?)+/g);return i[t]?parseFloat(i[t]):0}copy(e){return this.color=e.color.clone(),this.alpha=e.alpha,this}lerp(e,t){return this.color.r=this.color.r+(e.color.r-this.color.r)*t,this.color.g=this.color.g+(e.color.g-this.color.g)*t,this.color.b=this.color.b+(e.color.b-this.color.b)*t,this.alpha=this.alpha+(e.alpha-this.alpha)*t,this}clone(){return new this.constructor(this.color.r,this.color.g,this.color.b,this.alpha)}}class cv extends gy{constructor(e,t,i,n,a){super("ArticulationAnimationGroupController"),this.animationName=this.name=e,this.animationType=t,this.animationSpeed=i,this.articulationAnimations=n;let r,s=this.articulationAnimations.map((e=>e.startTime+e.continueTime)),o=[...new Set(this.articulationAnimations.map((e=>e.startTime)))],l=[...new Set(s)].sort(((e,t)=>e-t)),c=Math.max(...s)/i,h=0,u=!1,d=[];this._recordDefaultVal=(e,t,i,n,a,r="nodes")=>{d.find((n=>n.startTime==e&&n.articulationName===t&&n.articulationProperty===i))||d.push({startTime:e,articulationName:t,articulationProperty:i,articulationVal:n,articulationDiff:a,articulationType:r})};let p=-1,m=-1;this.getNodes=(e,t)=>{let i=[];for(let n of t.nodes)e.children.forEach((e=>{e.getObjectByName(n)&&i.push(e.getObjectByName(n))}));return i},this._recordDefaultStateAnimations=()=>{this.articulationAnimations.forEach((e=>{r||(r=Ep.defaultObjectTree.getItemByName(e.modelId));let t=r&&r.articulations.find((t=>t._name==e.articulationName));if(t)for(let n of t.properties){let a=0,s=0,o=this.getNodes(r.getGroup(),n);if(o.length)for(let r of n.modifiers)for(let n of o)switch(r.key){case ov.rotationX:a=t._interpolateRelativeNumeric(ov.rotationX,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.rotationX,r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.rotation.x,(s-a)/e.continueTime*i);break;case ov.rotationY:a=t._interpolateRelativeNumeric(ov.rotationY,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.rotationY,r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.rotation.y,(s-a)/e.continueTime*i);break;case ov.rotationZ:a=t._interpolateRelativeNumeric(ov.rotationZ,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.rotationZ,r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.rotation.z,(s-a)/e.continueTime*i);break;case ov.translationX:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.position.x,(s-a)/e.continueTime*i);break;case ov.translationY:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.position.y,(s-a)/e.continueTime*i);break;case ov.translationZ:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.position.z,(s-a)/e.continueTime*i);break;case ov.scaleX:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.scale.x,(s-a)/e.continueTime*i);break;case ov.scaleY:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.scale.y,(s-a)/e.continueTime*i);break;case ov.scaleZ:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.scale.z,(s-a)/e.continueTime*i);break;case ov.opacity:a=t._interpolateRelativeNumeric(ov.opacity,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.opacity,r.values,e.endState),n.traverse((t=>{"Mesh"==t.type&&(t.material instanceof Array?t.material.forEach((n=>{n.transparent=!0,this._recordDefaultVal(e.startTime,t.name+":"+n.name,r.key,n.opacity,(s-a)/e.continueTime*i)})):(t.material.transparent=!0,this._recordDefaultVal(e.startTime,t.name+":"+t.name,r.key,t.material.opacity,(s-a)/e.continueTime*i)))}));break;case ov.colorOverlay:a=t._interpolateColor(r.values,e.startState),s=t._interpolateColor(r.values,e.endState),n.traverse((t=>{if("Mesh"==t.type)if(t.material instanceof Array)t.material.forEach((n=>{let o=new lv((s.color.r-a.color.r)/e.continueTime*i,(s.color.g-a.color.g)/e.continueTime*i,(s.color.b-a.color.b)/e.continueTime*i,(s.alpha-a.alpha)/e.continueTime*i);this._recordDefaultVal(e.startTime,t.name+":"+n.name,r.key,{color:n.color,opacity:n.opacity},o),n.transparent=!0}));else{let o=new lv((s.color.r-a.color.r)/e.continueTime*i,(s.color.g-a.color.g)/e.continueTime*i,(s.color.b-a.color.b)/e.continueTime*i,(s.alpha-a.alpha)/e.continueTime*i);this._recordDefaultVal(e.startTime,n.name+":"+t.name,r.key,{color:t.material.color,opacity:t.material.opacity},o),t.material.transparent=!0}}));break;case ov.colorReplace:a=t._interpolateColor(r.values,e.startState),s=t._interpolateColor(r.values,e.endState),n.traverse((t=>{if("Mesh"==t.type)if(t.material instanceof Array)t.material.forEach((n=>{let o=new lv((s.color.r-a.color.r)/e.continueTime*i,(s.color.g-a.color.g)/e.continueTime*i,(s.color.b-a.color.b)/e.continueTime*i,(s.alpha-a.alpha)/e.continueTime*i);this._recordDefaultVal(e.startTime,t.name+":"+n.name,r.key,{map:n.map,color:n.color,opacity:n.opacity},o),n.map=null,n.transparent=!0}));else{let o=new lv((s.color.r-a.color.r)/e.continueTime*i,(s.color.g-a.color.g)/e.continueTime*i,(s.color.b-a.color.b)/e.continueTime*i,(s.alpha-a.alpha)/e.continueTime*i);this._recordDefaultVal(e.startTime,n.name+":"+t.name,r.key,{map:t.material.map,color:t.material.color,opacity:t.material.opacity},o),t.material.map=null,t.material.transparent=!0}}));break;case ov.stroke:a=t._interpolateColor(r.values,e.startState),s=t._interpolateColor(r.values,e.endState);let o=new lv((s.color.r-a.color.r)/e.continueTime*i,(s.color.g-a.color.g)/e.continueTime*i,(s.color.b-a.color.b)/e.continueTime*i,(s.alpha-a.alpha)/e.continueTime*i);this._recordDefaultVal(e.startTime,n.name,r.key,{color:a,tempColor:a.clone()},o);break;case ov.visible:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.name,r.key,n.visible,(s-a)/e.continueTime*i)}let l=[];for(let e of n.particles){let t=r.particleStoreArray.find((t=>t.name===e));t&&l.push(t)}if(l.length)for(let r of n.modifiers)for(let n of l)switch(r.key){case ov.rotationX:a=t._interpolateRelativeNumeric(ov.rotationX,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.rotationX,r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.rotation.x,(s-a)/e.continueTime*i,"particles");break;case ov.rotationY:a=t._interpolateRelativeNumeric(ov.rotationY,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.rotationY,r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.rotation.y,(s-a)/e.continueTime*i,"particles");break;case ov.rotationZ:a=t._interpolateRelativeNumeric(ov.rotationZ,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.rotationZ,r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.rotation.z,(s-a)/e.continueTime*i,"particles");break;case ov.translationX:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.position.x,(s-a)/e.continueTime*i,"particles");break;case ov.translationY:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.position.y,(s-a)/e.continueTime*i,"particles");break;case ov.translationZ:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.position.z,(s-a)/e.continueTime*i,"particles");break;case ov.scaleX:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.scale.x,(s-a)/e.continueTime*i,"particles");break;case ov.scaleY:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.scale.y,(s-a)/e.continueTime*i,"particles");break;case ov.scaleZ:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.scale.z,(s-a)/e.continueTime*i,"particles");break;case ov.opacity:a=t._interpolateRelativeNumeric(ov.opacity,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.opacity,r.values,e.endState),n.particleGroup.forEach((t=>{this._recordDefaultVal(e.startTime,n.particleModelGroup.name+":"+t.id,r.key,t.opacity,(s-a)/e.continueTime*i,"particles")}));break;case ov.quantityFactor:a=t._interpolateRelativeNumeric(ov.opacity,r.values,e.startState),s=t._interpolateRelativeNumeric(ov.opacity,r.values,e.endState),n.particleGroup.forEach((t=>{this._recordDefaultVal(e.startTime,n.particleModelGroup.name+":"+t.id,r.key,t.density,(s-a)/e.continueTime*i,"particles")}));break;case ov.colorOverlay:case ov.colorReplace:case ov.stroke:break;case ov.visible:a=t._interpolateAbsoluteNumeric(r.values,e.startState),s=t._interpolateAbsoluteNumeric(r.values,e.endState),this._recordDefaultVal(e.startTime,n.particleModelGroup.name,r.key,n.particleModelGroup.visible,null,"particles")}}}))},this._initAnimation=()=>{p=-1;let e=[],t=[],i=[];this.articulationAnimations.forEach((n=>{r||(r=Ep.defaultObjectTree.getItemByName(n.modelId));let a=r&&r.articulations.find((e=>e._name==n.articulationName));if(a)for(let o of a.properties){let l=this.getNodes(r.getGroup(),o),c=0;if(Ep.effectStore.initOutlinePass(),l.length)for(let t of o.modifiers)for(let i of l){let r=e.find((e=>e.nodeName==i.name&&e.modifierKey==t.key));if([ov.colorOverlay,ov.colorReplace].includes(t.key)&&(r=e.find((e=>e.nodeName==i.name&&[ov.colorOverlay,ov.colorReplace].includes(e.modifierKey)))),!r)switch(e.push({nodeName:i.name,modifierKey:t.key}),t.key){case ov.rotationX:c=a._interpolateRelativeNumeric(ov.rotationX,t.values,n.startState),i.rotation.x=c/180*Math.PI;break;case ov.rotationY:c=a._interpolateRelativeNumeric(ov.rotationY,t.values,n.startState),i.rotation.y=c/180*Math.PI;break;case ov.rotationZ:c=a._interpolateRelativeNumeric(ov.rotationZ,t.values,n.startState),i.rotation.z=c/180*Math.PI;break;case ov.translationX:if(c=a._interpolateAbsoluteNumeric(t.values,n.startState),i.position.x=c,i.children.length>0)i.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(i._LineItemID)if(i._LineItemID instanceof Array)i._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(i._LineItemID);e&&e.update()}break;case ov.translationY:if(c=a._interpolateAbsoluteNumeric(t.values,n.startState),i.position.y=c,i.children.length>0)i.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(i._LineItemID)if(i._LineItemID instanceof Array)i._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(i._LineItemID);e&&e.update()}break;case ov.translationZ:if(c=a._interpolateAbsoluteNumeric(t.values,n.startState),i.position.z=c,i.children.length>0)i.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(i._LineItemID)if(i._LineItemID instanceof Array)i._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(i._LineItemID);e&&e.update()}break;case ov.scaleX:c=a._interpolateAbsoluteNumeric(t.values,n.startState),i.scale.x=c;break;case ov.scaleY:c=a._interpolateAbsoluteNumeric(t.values,n.startState),i.scale.y=c;break;case ov.scaleZ:c=a._interpolateAbsoluteNumeric(t.values,n.startState),i.scale.z=c;break;case ov.opacity:c=a._interpolateRelativeNumeric(ov.opacity,t.values,n.startState),i.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.transparent=!0,e.opacity=c})):(e.material.transparent=!0,e.material.opacity=c))}));break;case ov.colorOverlay:c=a._interpolateColor(t.values,n.startState),i.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{c.alpha>0?(e.transparent=!0,e.color=c.color,e.opacity=c.alpha):(e.opacity=1,e.color=a.getDefaultVal(e.name,t.key)&&a.getDefaultVal(e.name,t.key).articulationVal.color)})):c.alpha>0?(e.material.transparent=!0,e.material.color=c.color,e.material.opacity=c.alpha):(e.material.opacity=1,e.material.color=a.getDefaultVal(e.name,t.key)&&a.getDefaultVal(e.name,t.key).articulationVal.color))}));break;case ov.colorReplace:c=a._interpolateColor(t.values,n.startState),i.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{c.alpha>0?(e.map=null,e.transparent=!0,e.color=c.color,e.opacity=c.alpha):(e.map=a.getDefaultVal(e.name,t.key)&&a.getDefaultVal(e.name,t.key).articulationVal.map,e.color=a.getDefaultVal(e.name,t.key)&&a.getDefaultVal(e.name,t.key).articulationVal.color,e.opacity=1),e.needsUpdate=!0})):(c.alpha>0?(e.material.map=null,e.material.transparent=!0,e.material.color=c.color,e.material.opacity=c.alpha):(e.material.map=a.getDefaultVal(e.name,t.key)&&a.getDefaultVal(e.name,t.key).articulationVal.map,e.material.color=a.getDefaultVal(e.name,t.key)&&a.getDefaultVal(e.name,t.key).articulationVal.color,e.material.opacity=1),e.material.needsUpdate=!0))}));break;case ov.stroke:c=a._interpolateColor(t.values,n.startState);let e=d.find((e=>e.startTime==n.startTime&&e.articulationName===i.name&&e.articulationProperty===t.key));e&&(e.articulationVal.tempColor.color=c.color.clone(),e.articulationVal.tempColor.alpha=c.alpha),Ep.effectStore.initOutlinePass(i,!0,c);break;case ov.visible:let r=a._values.findIndex((e=>e===n.startState));-1!==r&&(i.visible=t.values[r])}}let h=[];for(let e of o.materials){let t=r.findMaterial(e);t&&h.push(t)}if(h.length)for(let e of o.modifiers)for(let t of h){if(!i.find((i=>i.materialName===t.name&&i.modifierKey===e.key)))switch(i.push({materialName:t.name,modifierKey:e.key}),e.key){case ov.USpeed:if(c=a._interpolateAbsoluteNumeric(e.values,n.startState),s=Ep.animationStore.findMaterialAnimation(t._material(),nv.type))s.enableU=0!==c,s.uSpeed=c;else{let e=new nv(t._material(),0!==c,!1,c,0);s=e,Ep.animationStore.add(e)}0===s.uSpeed&&0===s.vSpeed&&s.reset();break;case ov.VSpeed:var s;if(c=a._interpolateAbsoluteNumeric(e.values,n.startState),s=Ep.animationStore.findMaterialAnimation(t._material(),nv.type))s.enableV=0!==c,s.vSpeed=c;else{let e=new nv(t._material(),!1,0!==c,0,c);s=e,Ep.animationStore.add(e)}0===s.uSpeed&&0===s.vSpeed&&s.reset();break;case ov.materialsReplace:let i=a._values.findIndex((e=>e===n.startState));e.values[i]&&e.values[i].path?Ep.instance.materialReplace({path:e.values[i].path,material:t,onLoad:()=>{},onProgress:()=>{}}):t.restore(a.getModelNode().uuid)}}let u=[];for(let e of o.particles){let t=r.particleStoreArray.find((t=>t.name===e));t&&u.push(t)}if(u.length)for(let e of o.modifiers)for(let i of u){if(!t.find((t=>t.particleName==i.name&&t.modifierKey==e.key)))switch(t.push({particleName:i.name,modifierKey:e.key}),e.key){case ov.rotationX:c=a._interpolateRelativeNumeric(ov.rotationX,e.values,n.startState),i.particleModelGroup.rotation.x=c/180*Math.PI;break;case ov.rotationY:c=a._interpolateRelativeNumeric(ov.rotationY,e.values,n.startState),i.particleModelGroup.rotation.y=c/180*Math.PI;break;case ov.rotationZ:c=a._interpolateRelativeNumeric(ov.rotationZ,e.values,n.startState),i.particleModelGroup.rotation.z=c/180*Math.PI;break;case ov.translationX:c=a._interpolateAbsoluteNumeric(e.values,n.startState),i.particleModelGroup.position.x=c;break;case ov.translationY:c=a._interpolateAbsoluteNumeric(e.values,n.startState),i.particleModelGroup.position.y=c;break;case ov.translationZ:c=a._interpolateAbsoluteNumeric(e.values,n.startState),i.particleModelGroup.position.z=c;break;case ov.scaleX:c=a._interpolateAbsoluteNumeric(e.values,n.startState),i.particleModelGroup.scale.x=c;break;case ov.scaleY:c=a._interpolateAbsoluteNumeric(e.values,n.startState),i.particleModelGroup.scale.y=c;break;case ov.scaleZ:c=a._interpolateAbsoluteNumeric(e.values,n.startState),i.particleModelGroup.scale.z=c;break;case ov.opacity:c=a._interpolateRelativeNumeric(ov.opacity,e.values,n.startState),i.particleGroup.forEach((e=>{e.opacity=c}));break;case ov.quantityFactor:c=a._interpolateRelativeNumeric(ov.opacity,e.values,n.startState),i.particleGroup.forEach((e=>{e.density=c}))}}}}))},this._recordDefaultStateAnimations(),this._initAnimation(),this._setEndAnimation=e=>{let t=l[e];this.articulationAnimations.filter((e=>e.startTime+e.continueTime==t)).forEach((e=>{r||(r=Ep.defaultObjectTree.getItemByName(e.modelId));let t=r&&r.articulations.find((t=>t._name==e.articulationName));if(t)for(let n of t.properties){let a=this.getNodes(r.getGroup(),n),s=0;if(Ep.effectStore.initOutlinePass(),a.length)for(let i of n.modifiers)for(let n of a)switch(i.key){case ov.rotationX:s=t._interpolateRelativeNumeric(ov.rotationX,i.values,e.endState),n.rotation.x=s/180*Math.PI;break;case ov.rotationY:s=t._interpolateRelativeNumeric(ov.rotationY,i.values,e.endState),n.rotation.y=s/180*Math.PI;break;case ov.rotationZ:s=t._interpolateRelativeNumeric(ov.rotationZ,i.values,e.endState),n.rotation.z=s/180*Math.PI;break;case ov.translationX:if(s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.position.x=s,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.translationY:if(s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.position.y=s,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.translationZ:if(s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.position.z=s,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.scaleX:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.scale.x=s;break;case ov.scaleY:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.scale.y=s;break;case ov.scaleZ:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.scale.z=s;break;case ov.opacity:s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.endState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.transparent=!0,e.opacity=s})):(e.material.transparent=!0,e.material.opacity=s))}));break;case ov.colorOverlay:s=t._interpolateColor(i.values,e.endState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{s.alpha>0?(e.color=s.color,e.opacity=s.alpha):(e.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.opacity=1)})):s.alpha>0?(e.material.color=s.color,e.material.opacity=s.alpha):(e.material.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.material.opacity=1))}));break;case ov.colorReplace:s=t._interpolateColor(i.values,e.endState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{s.alpha>0?(e.map=null,e.color=s.color,e.opacity=s.alpha):(e.map=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.map,e.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.opacity=1),e.needsUpdate=!0})):(s.alpha>0?(e.material.map=null,e.material.color=s.color,e.material.opacity=s.alpha):(e.material.map=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.map,e.material.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.material.opacity=1),e.material.needsUpdate=!0))}));break;case ov.stroke:s=t._interpolateColor(i.values,e.endState),Ep.effectStore.initOutlinePass(n,!0,s);break;case ov.visible:let a=t._values.findIndex((t=>t===e.endState));-1!==a&&(n.visible=i.values[a])}let o=[];for(let e of n.materials){let t=r.findMaterial(e);t&&o.push(t)}if(o.length)for(let a of n.modifiers)for(let n of o)switch(a.key){case ov.USpeed:if(s=t._interpolateAbsoluteNumeric(a.values,e.endState),i=Ep.animationStore.findMaterialAnimation(n._material(),nv.type))i.enableU=0!==s,i.uSpeed=s;else{let e=new nv(n._material(),0!==s,!1,s,0);i=e,Ep.animationStore.add(e)}0===i.uSpeed&&0===i.vSpeed&&i.reset();break;case ov.VSpeed:var i;if(s=t._interpolateAbsoluteNumeric(a.values,e.endState),i=Ep.animationStore.findMaterialAnimation(n._material(),nv.type))i.enableV=0!==s,i.vSpeed=s;else{let e=new nv(n._material(),!1,0!==s,0,s);i=e,Ep.animationStore.add(e)}0===i.uSpeed&&0===i.vSpeed&&i.reset();break;case ov.materialsReplace:let r=t._values.findIndex((t=>t===e.endState));a.values[r]&&a.values[r].path?Ep.instance.materialReplace({path:a.values[r].path,material:n,onLoad:()=>{},onProgress:()=>{}}):n.restore(t.getModelNode().uuid)}let l=[];for(let e of n.particles){let t=r.particleStoreArray.find((t=>t.name===e));t&&l.push(t)}if(l.length)for(let i of n.modifiers)for(let n of l)switch(i.key){case ov.rotationX:s=t._interpolateRelativeNumeric(ov.rotationX,i.values,e.endState),n.particleModelGroup.rotation.x=s/180*Math.PI;break;case ov.rotationY:s=t._interpolateRelativeNumeric(ov.rotationY,i.values,e.endState),n.particleModelGroup.rotation.y=s/180*Math.PI;break;case ov.rotationZ:s=t._interpolateRelativeNumeric(ov.rotationZ,i.values,e.endState),n.particleModelGroup.rotation.z=s/180*Math.PI;break;case ov.translationX:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.particleModelGroup.position.x=s;break;case ov.translationY:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.particleModelGroup.position.y=s;break;case ov.translationZ:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.particleModelGroup.position.z=s;break;case ov.scaleX:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.particleModelGroup.scale.x=s;break;case ov.scaleY:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.particleModelGroup.scale.y=s;break;case ov.scaleZ:s=t._interpolateAbsoluteNumeric(i.values,e.endState),n.particleModelGroup.scale.z=s;break;case ov.opacity:s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.endState),n.particleGroup.forEach((e=>{e.opacity=s}));break;case ov.quantityFactor:s=s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.endState),n.particleGroup.forEach((e=>{e.density=s}))}}}))},this._setStartAnimation=e=>{o[e]==parseInt(h)&&this.articulationAnimations.filter((t=>t.startTime==o[e])).forEach((e=>{r||(r=Ep.defaultObjectTree.getItemByName(e.modelId));let t=r&&r.articulations.find((t=>t._name==e.articulationName));if(t)for(let n of t.properties){let a=this.getNodes(r.getGroup(),n),s=0;if(Ep.effectStore.initOutlinePass(),a.length)for(let i of n.modifiers)for(let n of a)switch(i.key){case ov.rotationX:s=t._interpolateRelativeNumeric(ov.rotationX,i.values,e.startState),n.rotation.x=s/180*Math.PI;break;case ov.rotationY:s=t._interpolateRelativeNumeric(ov.rotationY,i.values,e.startState),n.rotation.y=s/180*Math.PI;break;case ov.rotationZ:s=t._interpolateRelativeNumeric(ov.rotationZ,i.values,e.startState),n.rotation.z=s/180*Math.PI;break;case ov.translationX:if(s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.position.x=s,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.translationY:if(s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.position.y=s,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.translationZ:if(s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.position.z=s,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.scaleX:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.scale.x=s;break;case ov.scaleY:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.scale.y=s;break;case ov.scaleZ:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.scale.z=s;break;case ov.opacity:n.traverse((n=>{"Mesh"==n.type&&(n.material instanceof Array?n.material.forEach((n=>{n.transparent=!0,s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.startState),n.opacity=s})):(n.material.transparent=!0,s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.startState),n.material.opacity=s))}));break;case ov.colorOverlay:s=t._interpolateColor(i.values,e.startState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{s.alpha>0?(e.transparent=!0,e.color=s.color,e.opacity=s.alpha):(e.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.opacity=1)})):s.alpha>0?(e.material.transparent=!0,e.material.color=s.color,e.material.opacity=s.alpha):(e.material.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.material.opacity=1))}));break;case ov.colorReplace:s=t._interpolateColor(i.values,e.startState),n.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{s.alpha>0?(e.map=null,e.transparent=!0,e.color=s.color,e.opacity=s.alpha):(e.map=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.map,e.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.opacity=1)})):s.alpha>0?(e.material.map=null,e.material.transparent=!0,e.material.color=s.color,e.material.opacity=s.alpha):(e.material.map=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.map,e.material.color=t.getDefaultVal(e.name,i.key)&&t.getDefaultVal(e.name,i.key).articulationVal.color,e.material.opacity=1))}));break;case ov.stroke:s=t._interpolateColor(i.values,e.startState);let a=d.find((t=>t.startTime==e.startTime&&t.articulationName===n.name&&t.articulationProperty===i.key));a&&(a.articulationVal.tempColor.color=s.color.clone(),a.articulationVal.tempColor.alpha=s.alpha),Ep.effectStore.initOutlinePass(n,!0,s);break;case ov.visible:let r=t._values.findIndex((t=>t===e.startState));-1!==r&&(n.visible=i.values[r])}let o=[];for(let e of n.materials){let t=r.findMaterial(e);t&&o.push(t)}if(o.length)for(let a of n.modifiers)for(let n of o)switch(a.key){case ov.USpeed:if(s=t._interpolateAbsoluteNumeric(a.values,e.startState),i=Ep.animationStore.findMaterialAnimation(n._material(),nv.type))i.enableU=0!==s,i.uSpeed=s;else{let e=new nv(n._material(),0!==s,!1,s,0);i=e,Ep.animationStore.add(e)}0===i.uSpeed&&0===i.vSpeed&&i.reset();break;case ov.VSpeed:var i;if(s=t._interpolateAbsoluteNumeric(a.values,e.startState),i=Ep.animationStore.findMaterialAnimation(n._material(),nv.type))i.enableV=0!==s,i.vSpeed=s;else{let e=new nv(n._material(),!1,0!==s,0,s);i=e,Ep.animationStore.add(e)}0===i.uSpeed&&0===i.vSpeed&&i.reset();break;case ov.materialsReplace:let r=t._values.findIndex((t=>t===e.startState));a.values[r]&&a.values[r].path?Ep.instance.materialReplace({path:a.values[r].path,material:n,onLoad:()=>{},onProgress:()=>{}}):n.restore(t.getModelNode().uuid)}let l=[];for(let e of n.particles){let t=r.particleStoreArray.find((t=>t.name===e));t&&l.push(t)}if(l.length)for(let i of n.modifiers)for(let n of l)switch(i.key){case ov.rotationX:s=t._interpolateRelativeNumeric(ov.rotationX,i.values,e.startState),n.particleModelGroup.rotation.x=s/180*Math.PI;break;case ov.rotationY:s=t._interpolateRelativeNumeric(ov.rotationY,i.values,e.startState),n.particleModelGroup.rotation.y=s/180*Math.PI;break;case ov.rotationZ:s=t._interpolateRelativeNumeric(ov.rotationZ,i.values,e.startState),n.particleModelGroup.rotation.z=s/180*Math.PI;break;case ov.translationX:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.particleModelGroup.position.x=s;break;case ov.translationY:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.particleModelGroup.position.y=s;break;case ov.translationZ:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.particleModelGroup.position.z=s;break;case ov.scaleX:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.particleModelGroup.scale.x=s;break;case ov.scaleY:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.particleModelGroup.scale.y=s;break;case ov.scaleZ:s=t._interpolateAbsoluteNumeric(i.values,e.startState),n.particleModelGroup.scale.z=s;break;case ov.opacity:s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.startState),n.particleGroup.forEach((e=>{e.opacity=s}));break;case ov.quantityFactor:s=t._interpolateRelativeNumeric(ov.opacity,i.values,e.startState),n.particleGroup.forEach((e=>{e.density=s}))}}}))},this.render=e=>{if(this.articulationAnimations&&!(this.articulationAnimations.length<=0)&&(h+=e,this.articulationAnimations.forEach((e=>{m=l.findIndex((t=>t==e.startTime+e.continueTime)),h>=(e.startTime+e.continueTime)/i&&p==m&&this._setEndAnimation(m)})),this.articulationAnimations.forEach((t=>{if(t.startTime/i<=h&&h<=(t.startTime+t.continueTime)/i){m=l.findIndex((e=>h<e/i)),m>=0&&p!=m&&(u?(this._setStartAnimation(m+1),this._setEndAnimation(m)):(m>0&&this._setEndAnimation(m-1),this._setStartAnimation(m)),p=m),r||(r=Ep.defaultObjectTree.getItemByName(t.modelId));let o=r&&r.articulations.find((e=>e._name==t.articulationName));if(o){let l=0;for(let c of o.properties){let h=this.getNodes(r.getGroup(),c);if(Ep.effectStore.initOutlinePass(),h.length)for(let i of c.modifiers)for(let n of h){if(![ov.opacity,ov.stroke,ov.colorOverlay,ov.colorReplace].includes(i.key)){let e=d.find((e=>e.startTime==t.startTime&&e.articulationName===n.name&&e.articulationProperty===i.key));l=e?e.articulationDiff:null}switch(i.key){case ov.rotationX:u?n.rotation.x-=l/180*Math.PI*e:n.rotation.x+=l/180*Math.PI*e;break;case ov.rotationY:u?n.rotation.y-=l/180*Math.PI*e:n.rotation.y+=l/180*Math.PI*e;break;case ov.rotationZ:u?n.rotation.z-=l/180*Math.PI*e:n.rotation.z+=l/180*Math.PI*e;break;case ov.translationX:if(u?n.position.x-=l*e:n.position.x+=l*e,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.translationY:if(u?n.position.y-=l*e:n.position.y+=l*e,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.translationZ:if(u?n.position.z-=l*e:n.position.z+=l*e,n.children.length>0)n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));else if(n._LineItemID)if(n._LineItemID instanceof Array)n._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const e=Ep.defaultObjectTree.getItemByUUID(n._LineItemID);e&&e.update()}break;case ov.scaleX:u?n.scale.x-=l*e:n.scale.x+=l*e;break;case ov.scaleY:u?n.scale.y-=l*e:n.scale.y+=l*e;break;case ov.scaleZ:u?n.scale.z-=l*e:n.scale.z+=l*e;break;case ov.opacity:n.traverse((n=>{"Mesh"==n.type&&(n.material instanceof Array?n.material.forEach((n=>{l=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===n.name&&e.articulationProperty===i.key)).articulationDiff,n.transparent=!0,u?n.opacity-=l*e:n.opacity+=l*e,n.opacity=o._checkOpacity(n.opacity)})):(l=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===n.name&&e.articulationProperty===i.key)).articulationDiff,n.material.transparent=!0,u?n.material.opacity-=l*e:n.material.opacity+=l*e,n.material.opacity=o._checkOpacity(n.material.opacity)))}));break;case ov.colorOverlay:n.traverse((n=>{if("Mesh"==n.type){let a;n.material instanceof Array?n.material.forEach((n=>{l=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===n.name&&e.articulationProperty===i.key)).articulationDiff,a=u?new lv(n.color.r-l.color.r*e,n.color.g-l.color.g*e,n.color.b-l.color.b*e,n.opacity-l.alpha*e):new lv(n.color.r+l.color.r*e,n.color.g+l.color.g*e,n.color.b+l.color.b*e,n.opacity+l.alpha*e),a.alpha>0?(n.color=o._checkColor(a.color),n.opacity=o._checkOpacity(a.alpha)):(n.opacity=1,n.color=o.getDefaultVal(n.name,i.key)&&o.getDefaultVal(n.name,i.key).articulationVal.color)})):(l=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===n.name&&e.articulationProperty===i.key)).articulationDiff,a=u?new lv(n.material.color.r-l.color.r*e,n.material.color.g-l.color.g*e,n.material.color.b-l.color.b*e,n.material.opacity-l.alpha*e):new lv(n.material.color.r+l.color.r*e,n.material.color.g+l.color.g*e,n.material.color.b+l.color.b*e,n.material.opacity+l.alpha*e),a.alpha>0?(n.material.color=o._checkColor(a.color),n.material.opacity=o._checkColor(a.alpha)):(n.material.opacity=1,n.material.color=o.getDefaultVal(n.name,i.key)&&o.getDefaultVal(n.name,i.key).articulationVal.color))}}));break;case ov.colorReplace:n.traverse((n=>{if("Mesh"==n.type){let a;n.material instanceof Array?n.material.forEach((n=>{l=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===n.name&&e.articulationProperty===i.key)).articulationDiff,a=u?new lv(n.color.r-l.color.r*e,n.color.g-l.color.g*e,n.color.b-l.color.b*e,n.opacity-l.alpha*e):new lv(n.color.r+l.color.r*e,n.color.g+l.color.g*e,n.color.b+l.color.b*e,n.opacity+l.alpha*e),a.alpha>0?(n.map=null,n.color=o._checkColor(a.color),n.opacity=o._checkOpacity(a.alpha)):(n.opacity=1,n.color=o.getDefaultVal(n.name,i.key)&&o.getDefaultVal(n.name,i.key).articulationVal.color,n.map=o.getDefaultVal(n.name,i.key)&&o.getDefaultVal(n.name,i.key).articulationVal.map),n.needsUpdate=!0})):(l=d.find((e=>e.startTime==t.startTime&&e.articulationName.split(":")[1]===n.name&&e.articulationProperty===i.key)).articulationDiff,a=u?new lv(n.material.color.r-l.color.r*e,n.material.color.g-l.color.g*e,n.material.color.b-l.color.b*e,n.material.opacity-l.alpha*e):new lv(n.material.color.r+l.color.r*e,n.material.color.g+l.color.g*e,n.material.color.b+l.color.b*e,n.material.opacity+l.alpha*e),a.alpha>0?(n.material.map=null,n.material.color=o._checkColor(a.color),n.material.opacity=o._checkOpacity(a.alpha)):(n.material.opacity=1,n.material.color=o.getDefaultVal(n.name,i.key)&&o.getDefaultVal(n.name,i.key).articulationVal.color,n.material.map=o.getDefaultVal(n.name,i.key)&&o.getDefaultVal(n.name,i.key).articulationVal.map),n.material.needsUpdate=!0)}}));break;case ov.stroke:let a,r=d.find((e=>e.startTime==t.startTime&&e.articulationName===n.name&&e.articulationProperty===i.key));u?(r.articulationVal.tempColor.color.r-=r.articulationDiff.color.r*e,r.articulationVal.tempColor.color.g-=r.articulationDiff.color.g*e,r.articulationVal.tempColor.color.b-=r.articulationDiff.color.b*e,r.articulationVal.tempColor.alpha-=r.articulationDiff.alpha*e):(r.articulationVal.tempColor.color.r+=r.articulationDiff.color.r*e,r.articulationVal.tempColor.color.g+=r.articulationDiff.color.g*e,r.articulationVal.tempColor.color.b+=r.articulationDiff.color.b*e,r.articulationVal.tempColor.alpha+=r.articulationDiff.alpha*e),a=new lv(r.articulationVal.tempColor.color.r,r.articulationVal.tempColor.color.g,r.articulationVal.tempColor.color.b,r.articulationVal.tempColor.alpha),r.articulationVal.tempColor.color=o._checkColor(a.color),r.articulationVal.tempColor.alpha=o._checkOpacity(a.alpha),Ep.effectStore.initOutlinePass(n,!0,new lv(r.articulationVal.tempColor.color.r,r.articulationVal.tempColor.color.g,r.articulationVal.tempColor.color.b,r.articulationVal.tempColor.alpha))}}let p=[];for(let e of c.materials){let t=r.findMaterial(e);t&&p.push(t)}if(p.length)for(let r of c.modifiers)for(let c of p){var n,a;switch(r.key){case ov.USpeed:if(n=o._interpolateAbsoluteNumeric(r.values,t.startState),a=o._interpolateAbsoluteNumeric(r.values,t.endState),l=(a-n)/t.continueTime*i,s=Ep.animationStore.findMaterialAnimation(c._material(),nv.type))s.uSpeed+=l*e,s.enableU=0!==s.uSpeed;else{let t=new nv(c._material(),l*e!=0,!1,l*e,0);s=t,Ep.animationStore.add(t)}0===s.uSpeed&&0===s.vSpeed&&s.reset();break;case ov.VSpeed:var s;if(n=o._interpolateAbsoluteNumeric(r.values,t.startState),a=o._interpolateAbsoluteNumeric(r.values,t.endState),l=(a-n)/t.continueTime*i,s=Ep.animationStore.findMaterialAnimation(c._material(),nv.type))s.vSpeed+=l*e,s.enableV=0!==s.vSpeed;else{let t=new nv(c._material(),!1,l*e!=0,0,l*e);s=t,Ep.animationStore.add(t)}0===s.uSpeed&&0===s.vSpeed&&s.reset()}}let m=[];for(let e of c.particles){let t=r.particleStoreArray.find((t=>t.name===e));t&&m.push(t)}if(m.length)for(let i of c.modifiers)for(let n of m){if(![ov.opacity,ov.stroke,ov.colorOverlay,ov.colorReplace].includes(i.key)){let e=d.find((e=>e.startTime==t.startTime&&e.articulationName===n.particleModelGroup.name&&e.articulationProperty===i.key));l=e?e.articulationDiff:null}switch(i.key){case ov.rotationX:u?n.particleModelGroup.rotation.x-=l/180*Math.PI*e:n.particleModelGroup.rotation.x+=l/180*Math.PI*e;break;case ov.rotationY:u?n.particleModelGroup.rotation.y-=l/180*Math.PI*e:n.particleModelGroup.rotation.y+=l/180*Math.PI*e;break;case ov.rotationZ:u?n.particleModelGroup.rotation.z-=l/180*Math.PI*e:n.particleModelGroup.rotation.z+=l/180*Math.PI*e;break;case ov.translationX:u?n.particleModelGroup.position.x-=l*e:n.particleModelGroup.position.x+=l*e;break;case ov.translationY:u?n.particleModelGroup.position.y-=l*e:n.particleModelGroup.position.y+=l*e;break;case ov.translationZ:u?n.particleModelGroup.position.z-=l*e:n.particleModelGroup.position.z+=l*e;break;case ov.scaleX:u?n.particleModelGroup.scale.x-=l*e:n.particleModelGroup.scale.x+=l*e;break;case ov.scaleY:u?n.particleModelGroup.scale.y-=l*e:n.particleModelGroup.scale.y+=l*e;break;case ov.scaleZ:u?n.particleModelGroup.scale.z-=l*e:n.particleModelGroup.scale.z+=l*e;break;case ov.opacity:n.particleGroup.forEach((a=>{l=d.find((e=>e.startTime==t.startTime&&e.articulationName===n.particleModelGroup.name+":"+a.id&&e.articulationProperty===i.key)).articulationDiff,u?a.opacity-=l*e:a.opacity+=l*e,a.opacity=o._checkOpacity(a.opacity)}));break;case ov.quantityFactor:n.particleGroup.forEach((a=>{l=d.find((e=>e.startTime==t.startTime&&e.articulationName===n.particleModelGroup.name+":"+a.id&&e.articulationProperty===i.key)).articulationDiff,u?a.density-=l*e:a.density+=l*e,a.density=o._checkOpacity(a.density)}))}}}}}})),a&&a({progress:h/c,target:this}),h>c||1==u))switch(h>c&&this._setEndAnimation(l.length-1),this.animationType){case av:h=0;let t=Ep.animationStore.findAnimation(this.animationName,cv.type);t&&(this.pause(),Ep.animationStore.remove(t),a&&a({progress:1,isEnd:!0,target:this})),p=-1;break;case rv:h=0,this._initAnimation();break;case sv:u=!0,h-=2*e,h<=0&&(h=0,u=!1,this._initAnimation())}},this.reset=()=>{this.pause(),this._initAnimation()}}}cv.type="ArticulationAnimationGroupController";var hv=function(e){this.targetObjects={},this.update=function(t,i){if(void 0===this.targetObjects[i])return;const n=this.targetObjects[i];if(void 0!==n.userData.moveComplete&&!0!==n.userData.moveComplete){if(n.userData.currentTime<n.userData.duration&&n.userData.duration>0){n.userData.currentTime+=t;var a=n.userData.currentTime/n.userData.duration,r={x:n.userData.startPos.x+(n.userData.targetPos.x-n.userData.startPos.x)*a,y:n.userData.startPos.y+(n.userData.targetPos.y-n.userData.startPos.y)*a,z:n.userData.startPos.z+(n.userData.targetPos.z-n.userData.startPos.z)*a};n.position.set(r.x,r.y,r.z),n.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}))}else n.position.set(n.userData.targetPos.x,n.userData.targetPos.y,n.userData.targetPos.z),n.userData.moveComplete=!0;e&&e(n)}},this.add=function(e,t){this.targetObjects[e]=t},this.remove=function(e){delete this.targetObjects[e]},this.dispose=function(){}};class uv{constructor({meshes:e=[],clippingPlanes:t=[]}){Ep.renderer.localClippingEnabled=!0;let i=[],n=[];if(e instanceof Array||!(meshs.length>0)){for(let t of e)t instanceof Fi&&i.push(t),t.traverse((e=>{e instanceof Fi&&i.push(e)}));for(let e of t)"number"==typeof e.nx&&"number"==typeof e.ny&&"number"==typeof e.nz&&"number"==typeof e.d?n.push(new Rt(new Ce(e.nx,e.ny,e.nz),e.d)):logger.warn("剪裁面参数错误。");for(let e of i)if(e.material instanceof Array)for(const t of e.material)t.clippingPlanes=n,t.clipShadows=!0;else e.material&&(e.material.clippingPlanes=n,e.material.clipShadows=!0);this.clear=()=>{for(let e of i)if(e.material instanceof Array)for(const t of e.material)t.clippingPlanes=null,t.clipShadows=null;else e.material&&(e.material.clippingPlanes=null,e.material.clipShadows=null);i=null,n=null},this.pointClipTest=e=>{let t=!0;return n.forEach((i=>{t=t&&i.distanceToPoint(e)<0})),t},this.dispose=()=>{i.forEach((e=>{_y.disposeThreeObject(e)})),i=[],n.forEach((e=>{_y.disposeThreeObject(e)})),n=[]}}}get type(){return"ClippingController"}set enabled(e){Ep.renderer.localClippingEnabled=e}}class dv extends gy{constructor(e){super("FireflyAnimationController"),this.animationObject=e,this.value=this.animationObject.uniforms.time.value,this.render=e=>{this.animationObject.uniforms.time.value+=e},this.reset=()=>{this.animationObject.uniforms.time.value=this.value}}}dv.type="FireflyAnimationController";class pv extends gy{constructor(e,t){super("FireworksAnimationController"),this.firworksArr=e,this.option=t,this.name=t.name,this.reDraw=function(e){let t=this.option.centerPos.x+Number(this.option.offset.x)+2*this.option.range*Math.random()-this.option.range,i=Number(this.option.offset.y)+this.option.bottomHeight+(this.option.topHeight-this.option.bottomHeight)*Math.random(),n=this.option.centerPos.z+Number(this.option.offset.z)+2*this.option.range*Math.random()-this.option.range;for(var a of(e.pos.x=t,e.pos.y=i,e.pos.z=n,e.speed=this.option.speed+this.option.speedR*Math.random(),e.lifetime=this.option.lifetime+this.option.lifetimeR*Math.random(),e.leaveTime=e.lifetime,e.currentTime=0,e.color=16777215*Math.random(),e.children))a.position.set(e.pos.x,e.pos.y,e.pos.z),a.dir=new Ce(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).normalize(),a.material.opacity=1},this.operationFireWork=function(e,t){for(var i of e.children)i.position.set(i.position.x+i.dir.x*e.speed*t,i.position.y+i.dir.y*e.speed*t,i.position.z+i.dir.z*e.speed*t),.1*e.lifetime>e.leaveTime&&(i.material.opacity=e.leaveTime/(10*e.lifetime));e.leaveTime-=t,e.currentTime+=t},this.render=e=>{for(var t of this.firworksArr.children)t.leaveTime<=0?this.reDraw(t):this.operationFireWork(t,e)},this.reset=()=>{}}}pv.type="FireworksAnimationController";class mv extends gy{constructor(e,t,i){super("FollowAnimationController"),this.animationObject=e,this.target=t,this.params=i,this.targetWorldPosition=new Ce,this.position0=this.animationObject.position.clone(),this.rotation0=this.animationObject.rotation.clone(),this.scale0=this.animationObject.scale.clone(),this.distance0=this.params.distance0,this.animationObject.material&&(this.color0=this.animationObject.material.color.clone(),this.transparent0=this.animationObject.material.transparent,this.opacity0=this.animationObject.material.opacity,this.animationObject.material.transparent=!0),this.validate=e=>{if(e&&"string"==typeof e.type&&(e.type=e.type.toLowerCase(),!("number"!=typeof e.limitDistance||e.limitDistance<=0))){switch(e.type){case"disappear":("number"!=typeof e.disappearDistance||e.disappearDistance>e.limitDistance)&&(e.disappearDistance=e.limitDistance);break;case"freeze":this.established=!1;break;default:return}return e.limitColor?e.limitColor=new Qt(e.limitColor):e.limitColor=void 0,e}},this.params.limit=this.validate(this.params.limit),this.render=e=>{if(this.animationObject&&this.target&&void 0!==e&&this.params.followType){switch(this.params.followType.toLowerCase()){case"position":if(!this.animationObject.position||!this.target.position)return;this.animationObject.position.copy(this.target.position),this.params.offset&&(this.animationObject.position.x+=this.params.offset.x||0,this.animationObject.position.y+=this.params.offset.y||0,this.animationObject.position.z+=this.params.offset.z||0);break;case"rotation":if(!this.animationObject.rotation||!this.target.rotation)return;this.animationObject.rotation.copy(this.target.rotation),this.params.offset&&(this.animationObject.rotation.x+=ge.degToRad(this.params.offset.x||0),this.animationObject.rotation.y+=ge.degToRad(this.params.offset.y||0),this.animationObject.rotation.z+=ge.degToRad(this.params.offset.z||0));break;case"scale":if(!this.animationObject.scale||!this.target.scale)return;this.animationObject.scale.copy(this.target.scale),this.animationObject.scale.x*=this.scale0.x,this.animationObject.scale.y*=this.scale0.y,this.animationObject.scale.z*=this.scale0.z;break;case"orientation":if(!this.target.position)return;if(!this.animationObject.rotation||!this.animationObject.scale)return;const e=this.animationObject.position.distanceTo(this.target.position);if(this.params.limit){if(this.params.limit.limitColor&&this.animationObject.material&&this.animationObject.material.color.copy(this.color0),"freeze"===this.params.limit.type&&e>this.params.limit.limitDistance&&this.established){this.params.limit.limitColor&&this.animationObject.material&&this.animationObject.material.color.copy(this.params.limit.limitColor);break}if("disappear"===this.params.limit.type&&e>this.params.limit.disappearDistance&&this.animationObject.material){const t=(e-this.params.limit.disappearDistance)/(this.params.limit.limitDistance-this.params.limit.disappearDistance);this.animationObject.material.opacity=this.opacity0*(1-t),this.params.limit.limitColor&&(this.animationObject.material.color=this.animationObject.material.color.lerp(this.params.limit.limitColor,t))}}(this.params.enableRotation||this.params.enableRotate)&&(this.target.getWorldPosition(this.targetWorldPosition),this.targetWorldPosition.y-=1,this.animationObject.lookAt(this.targetWorldPosition)),this.params.enableScale&&(this.animationObject.scale.z=this.scale0.z*(e/this.distance0))}this.established||(this.animationObject.scale.x=this.scale0.x,this.animationObject.scale.y=this.scale0.y,this.animationObject.scale.z=this.scale0.z,this.established=!0)}},this.reset=()=>{this.animationObject.position.copy(this.position0),this.animationObject.rotation.copy(this.rotation0),this.animationObject.scale.copy(this.scale0),this.animationObject.material&&(this.animationObject.material.transparent=this.transparent0,this.animationObject.material.opacity=this.opacity0,this.animationObject.material.color.copy(this.color0))}}}mv.type="FollowAnimationController";class fv extends gy{constructor(e,t,i=0,n=.5,a){super("GeoGlobeVisibilityController"),this.camera=t,this.object=e,this.origin=a||new Ce,this.visible=!0,this.globeRadius=i,this.fovDiffTolorance=n,this.objectVisible0=e.visible,this.isEnable,this.render=()=>{let e=this.origin.clone();e.applyMatrix4(this.camera.matrixWorldInverse);let i=new Ce;this.object.getWorldPosition(i),i.applyMatrix4(this.camera.matrixWorldInverse);let n=0;t.fov&&(n=Math.sin(ge.degToRad(t.fov/2))*this.globeRadius*this.fovDiffTolorance),this.visible=i.z-e.z>n,this.object.visible=this.objectVisible0&&this.visible},this.reset=()=>{this.object.visible=this.objectVisible0}}}fv.type="GeoGlobeVisibilityController";class gv extends gy{constructor(e,t,i,n){super("InstanceDistanceController"),t instanceof Qr&&"number"==typeof n&&!(n>=t.count)&&(this.name=i,this.camera=e,this.object=t,this.instanceId=n,this.matrix=new it,this.object.getMatrixAt(this.instanceId,this.matrix),this.render=()=>{if(this.object instanceof Qr)if(this.object.hideByDistance[this.instanceId]){const e=this.camera.position.clone(),t=new Ce;t.setFromMatrixPosition(this.matrix);const i=t.distanceTo(e);if(i>=this.object.minDistances[this.instanceId]&&i<=this.object.maxDistances[this.instanceId]&&this.object.visible[this.instanceId])this.object.setMatrixAt(this.instanceId,this.matrix),this.object.instanceMatrix.needsUpdate=!0;else{const e=this.matrix.clone().multiplyScalar(0);this.object.setMatrixAt(this.instanceId,e),this.object.instanceMatrix.needsUpdate=!0}}else this.object.visible[this.instanceId]&&(this.object.setMatrixAt(this.instanceId,this.matrix),this.object.instanceMatrix.needsUpdate=!0)},this.reset=()=>{this.object.setMatrixAt(this.instanceId,this.matrix)})}}gv.type="InstanceDistanceController",gv.prototype.isDistanceController=!0;class yv extends gy{constructor(e,t,i,n,a,r,s=!1,o,l=0,c=.5,h){super("InstancedBubbleAnimationController"),this.instancedMesh=e,this.instanceId=t,this.startScale=i,this.endScale=n,this.startDisappearScale=a,this.diffusionSpeed=r,this.yScale=s,this.camera=o,this.origin=h||new Ce,this.globeRadius=l,this.fovDiffTolorance=c,this.dummy=new Et,this.dummy.matrixAutoUpdate=!1,this.instancedMesh.getMatrixAt(t,this.dummy.matrix),this.matrix0=this.dummy.matrix.clone(),this.dummy.matrix.decompose(this.dummy.position,this.dummy.quaternion,this.dummy.scale),this.render=e=>{if(this.instancedMesh instanceof Qr){if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){let e=this.origin.clone();e.applyMatrix4(this.camera.matrixWorldInverse);let t=new Ce;this.dummy.getWorldPosition(t),t.applyMatrix4(this.camera.matrixWorldInverse);let i=0;this.camera.fov&&(i=Math.sin(ge.degToRad(this.camera.fov/2))*this.globeRadius*this.fovDiffTolorance),this.instancedMesh.visible[this.instanceId]=t.z-e.z>i}if(void 0===e){var t=this.endScale/100;this.dummy.scale.x+=this.diffusionSpeed*t,this.dummy.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.dummy.scale.y+=this.diffusionSpeed*t)}else this.dummy.scale.x+=this.diffusionSpeed*e,this.dummy.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.dummy.scale.y+=this.diffusionSpeed*e);if(this.diffusionSpeed>=0?this.dummy.scale.x>this.endScale&&(this.dummy.scale.x=this.startScale,this.dummy.scale.z=this.startScale,this.yScale&&(this.dummy.scale.y=this.startScale)):this.dummy.scale.x<this.endScale&&(this.dummy.scale.x=this.startScale,this.dummy.scale.z=this.startScale,this.yScale&&(this.dummy.scale.y=this.startScale)),this.instancedMesh.hideByDistance[this.instanceId]){let e=this.camera.position.clone(),t=new it,n=new Ce;this.instancedMesh.getMatrixAt(this.instanceId,t),n.setFromMatrixPosition(t);var i=n.distanceTo(e);(i<this.instancedMesh.minDistances[this.instanceId]||i>this.instancedMesh.maxDistances[this.instanceId]||!this.instancedMesh.activeVisible[this.instanceId])&&(this.dummy.scale.x=0,this.dummy.scale.y=0,this.dummy.scale.z=0)}this.instancedMesh.visible[this.instanceId]||(this.dummy.scale.x=0,this.dummy.scale.y=0,this.dummy.scale.z=0),this.dummy.updateMatrix(),this.instancedMesh.setMatrixAt(this.instanceId,this.dummy.matrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}},this.reset=()=>{this.dummy.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0),this.instanceMatrix.scale(this.dummy.scale.x,this.dummy.scale.y,this.dummy.scale.z),this.instancedMesh.setMatrixAt(this.instanceId,this.instanceMatrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}}}yv.type="InstancedBubbleAnimationController";class vv extends gy{constructor(e,t,i=!1,n="y",a=0,r=!1,s=1,o=1,l=1,c=1){super("InstancedNodeAnimationController"),this.instancedMesh=e,this.instanceId=t,this.isRotating=i,this.rotatingAxis=n,this.rotatingSpeed=a,this.isScaling=r,this.startScale=s,this.stopScale=o,this.fadeOutScale=l,this.scalingSpeed=c,this.dummy=new Et,this.dummy.matrixAutoUpdate=!1;let h=[];this.lastScales=1;for(let e=0;e<this.instancedMesh.count;e++){let t=new Ce,i=new Ee,n=new Ce(1,1,1);if(this.instancedMesh.userData?.matrices[e]&&this.instancedMesh.userData.matrices[e].matrix)this.instancedMesh.userData.matrices[e].matrix.decompose(t,i,n);else{let a=new it;this.instancedMesh.getMatrixAt(e,a),a.decompose(t,i,n)}h.push(n.clone())}if(this.rotatingAxis){const e=new Ce;switch(this.rotatingAxis.toLowerCase()){case"x":e.set(1,0,0);break;case"y":e.set(0,1,0);break;case"z":e.set(0,0,1)}this.rotatingAxis=e.normalize()}this.instanceScale=s,this.opacity=1,this.isScaling&&this.instancedMesh.material&&(this.opacity=this.instancedMesh.material.opacity||1),this.render=e=>{if(null!=this.instancedMesh){if(void 0===e?e=.016:this.isScaling&&(this.instanceScale+=this.scalingSpeed*e),this.isScaling)if(this.scalingSpeed>=0){if(this.instanceScale>this.stopScale)this.reset(),this.instancedMesh.material&&(this.instancedMesh.material.opacity=this.opacity),this.instanceScale=this.startScale;else if(this.instanceScale>this.fadeOutScale){var t=(1-(this.instanceScale-this.fadeOutScale)/(this.stopScale-this.fadeOutScale))*this.opacity;this.instancedMesh.material&&(this.instancedMesh.material.opacity=t,this.instancedMesh.material.transparent=!0)}}else if(this.instanceScale<this.stopScale)this.reset(),this.instancedMesh.material&&(this.instancedMesh.material.opacity=this.opacity),this.instanceScale=this.startScale;else if(this.instanceScale<this.fadeOutScale){t=(1-(this.fadeOutScale-this.instanceScale)/(this.stopScale-this.fadeOutScale))*this.opacity;this.instancedMesh.material&&(this.instancedMesh.material.opacity=t,this.instancedMesh.material.transparent=!0)}if(!this.instanceId&&!this.instanceId&&(this.isRotating||this.isScaling)){const t=new it;this.isRotating&&t.makeRotationAxis(this.rotatingAxis,this.rotatingSpeed*e*20/Math.PI),h.length,this.instancedMesh.count;for(let e=0;e<this.instancedMesh.count;e++){if(this.isScaling){let e=(new it).makeScale(this.instanceScale/this.lastScales,this.instanceScale/this.lastScales,this.instanceScale/this.lastScales);this.lastScales=this.instanceScale,t.multiply(e)}this.instancedMesh.userData.matrices[e].rotatingMatrix.multiply(t.clone()),this.instancedMesh.getMatrixAt(e,this.dummy.matrix),this.dummy.matrix.multiply(t),this.instancedMesh.setMatrixAt(e,this.dummy.matrix)}this.instancedMesh.instanceMatrix.needsUpdate=!0}}},this.reset=()=>{for(let e=0;e<this.instancedMesh.count;e++){this.instanceScale=1,this.oldScale=1,this.instancedMesh.getMatrixAt(e,this.dummy.matrix);let t=new Ce,i=new Ee,n=new Ce(1,1,1);this.dummy.matrix.decompose(t,i,n);let a=new it;a.compose(t,i,h[e]||h[0]),this.instancedMesh.setMatrixAt(e,a.clone())}this.instancedMesh.instanceMatrix.needsUpdate=!0}}}vv.type="InstancedNodeAnimationController";(class extends gy{constructor(e,t,i,n,a,r,s=!1){super("InstanceScaleAnimationController"),this.instancedMesh=e,this.instanceId=t,this.startScale=i,this.endScale=n,this.startDisappearScale=a,this.diffusionSpeed=r,this.yScale=s,this.dummy=new Et,this.dummy.matrixAutoUpdate=!1,this.instancedMesh.getMatrixAt(t,this.dummy.matrix),this.matrix0=this.dummy.matrix.clone(),this.dummy.matrix.decompose(this.dummy.position,this.dummy.quaternion,this.dummy.scale),this.render=e=>{if(null!=this.instancedMesh){if(void 0===e){var t=this.endScale/100;this.dummy.scale.x+=this.diffusionSpeed*t,this.dummy.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.dummy.scale.y+=this.diffusionSpeed*t)}else this.dummy.scale.x+=this.diffusionSpeed*e,this.dummy.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.dummy.scale.y+=this.diffusionSpeed*e);this.diffusionSpeed>=0?this.dummy.scale.x>this.endScale&&(this.dummy.scale.x=this.startScale,this.dummy.scale.z=this.startScale,this.yScale&&(this.dummy.scale.y=this.startScale)):this.dummy.scale.x<this.endScale&&(this.dummy.scale.x=this.startScale,this.dummy.scale.z=this.startScale,this.yScale&&(this.dummy.scale.y=this.startScale)),this.dummy.updateMatrix(),this.instancedMesh.setMatrixAt(this.instanceId,this.dummy.matrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}},this.reset=()=>{this.dummy.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0),this.instanceMatrix.scale(this.dummy.scale.x,this.dummy.scale.y,this.dummy.scale.z),this.instancedMesh.setMatrixAt(this.instanceId,this.instanceMatrix),this.instancedMesh.instanceMatrix.needsUpdate=!0}}}).type="InstanceScaleAnimationController";(class extends gy{constructor(e,t){super("MaterialRotationAnimationController"),this.material=e,this.speed=t,this.render=function(e){null!=this.material&&this.speed&&(null!=this.material.map&&(this.material.map.rotation+=this.speed*e),null!=this.material.emissiveMap&&(this.material.emissiveMap.rotation+=this.speed*e),null!=this.material.alphaMap&&(this.material.alphaMap.rotation+=this.speed*e))}}}).type="MaterialRotationAnimationController";(class extends gy{constructor(e,t,i,n,a){super("MaterialScalingAnimationController"),this.material=e,this.enableU=t,this.enableV=i,this.uSpeed=n,this.vSpeed=a}render(e){null!=this.material&&(this.enableU&&(null!=this.material.map&&(this.material.map.offset.x+=this.uSpeed*e),null!=this.material.emissiveMap&&(this.material.emissiveMap.offset.x+=this.uSpeed*e),null!=this.material.alphaMap&&(this.material.alphaMap.offset.x+=this.uSpeed*e)),this.enableV&&(null!=this.material.map&&(this.material.map.offset.y+=this.vSpeed*e),null!=this.material.emissiveMap&&(this.material.emissiveMap.offset.y+=this.vSpeed*e),null!=this.material.alphaMap&&(this.material.alphaMap.offset.y+=this.vSpeed*e)))}}).type="MaterialScalingAnimationController";class bv extends gy{constructor(e,t){super("ModelTransformAnimationController"),this.modelItem=e,this.animationObject=e.getGroup(),this.tp=(new Ce).copy(t.position),this.ts=(new Ce).copy(t.scale),this.sp=this.animationObject.position.clone(),this.ss=this.animationObject.scale.clone(),this.ss.x/=this.animationObject.userData.originalScale.x,this.ss.y/=this.animationObject.userData.originalScale.y,this.ss.z/=this.animationObject.userData.originalScale.z,this.duration=1e3*t.duration,this.current=0,this.tr=t.rotation.clone(),this.sr=this.animationObject.rotation.clone()}render(e){this.current+=1e3*e,this.current>this.duration&&(this.current=this.duration);const t=this.current/this.duration,i=(this.tp.x-this.sp.x)*t+this.sp.x,n=(this.tp.y-this.sp.y)*t+this.sp.y,a=(this.tp.z-this.sp.z)*t+this.sp.z;this.animationObject.position.set(i,n,a);const r=(this.ts.x-this.ss.x)*t+this.ss.x,s=(this.ts.y-this.ss.y)*t+this.ss.y,o=(this.ts.z-this.ss.z)*t+this.ss.z;this.animationObject.scale.set(this.animationObject.userData.originalScale.x*r,this.animationObject.userData.originalScale.y*s,this.animationObject.userData.originalScale.z*o);const l=(this.tr.x-this.sr.x)*t+this.sr.x,c=(this.tr.y-this.sr.y)*t+this.sr.y,h=(this.tr.z-this.sr.z)*t+this.sr.z;this.animationObject.rotation.set(l,c,h),this.modelItem.isIconModel&&Ep.instance.updateIconModelInterval(this.modelItem),Ep.instance.defaultModelSelection.onModelTransform(this.animationObject),this.current===this.duration&&(this.animationObject.rotation.copy(this.tr),this.remove())}remove(){Ep.animationStore.remove(this)}}bv.type="ModelTransformAnimationController";class _v extends gy{constructor(e,t=1,i="",n="default"){super("NodeBlinkingAnimationController"),this.animationObject=e,this.targetColor=new Qt(1,1,1),this.defaultColors={},this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((t=>{t.transparent=!0,this.defaultColors[e.name+t.name]=t.color.clone()})):(e.material.transparent=!0,this.defaultColors[e.name]=e.material.color.clone()))})),this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.color=this.targetColor})):e.material.color=this.targetColor)})),this.blinkingColor=new Qt(i),this.r=(this.targetColor.r-this.blinkingColor.r)/t,this.g=(this.targetColor.g-this.blinkingColor.g)/t,this.b=(this.targetColor.b-this.blinkingColor.b)/t,this.currentColor=this.targetColor,this.render=e=>{null!=this.animationObject&&(this.currentColor=0==t?this.blinkingColor:this._changeColor(this.currentColor,e),this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.color=this.currentColor})):e.material.color=this.currentColor)})))},this.reset=()=>{this.animationObject.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((t=>{t.transparent=!1,t.color=this.defaultColors[e.name+t.name]})):(e.material.transparent=!1,e.material.color=this.defaultColors[e.name]))}))},this._changeColor=(e,t)=>(e.r+=this.r*t,e.r>=1&&(e.r=this.blinkingColor.r),e.g+=this.g*t,e.g>=1&&(e.g=this.blinkingColor.g),e.b+=this.b*t,e.b>=1&&(e.b=this.blinkingColor.b),e)}}_v.type="NodeBlinkingAnimationController";class xv extends gy{constructor(e,t,i,n=!1){super("NodeBreatheAnimationController"),this.animationObject=e,this.endBreathe=t,this.diffusionSpeed=i,this.yScale=n,this.scaleX0=this.animationObject.scale.x,this.scaleY0=this.animationObject.scale.y,this.scaleZ0=this.animationObject.scale.z,this.isScale=!0,this.render=e=>{if(null!=this.animationObject)if(this.animationObject.scale.x<this.endBreathe&&!0===this.isScale)if(void 0===e){var t=this.endBreathe/100;this.animationObject.scale.x+=this.diffusionSpeed*t,this.animationObject.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*t),this.animationObject.scale.x>=this.endBreathe&&(this.isScale=!1)}else this.animationObject.scale.x+=this.diffusionSpeed*e,this.animationObject.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*e),this.animationObject.scale.x>=this.endBreathe&&(this.isScale=!1);else if(void 0===e){t=this.endBreathe/100;this.animationObject.scale.x-=this.diffusionSpeed*t,this.animationObject.scale.z-=this.diffusionSpeed*t,this.yScale&&(this.animationObject.scale.y-=this.diffusionSpeed*t),this.animationObject.scale.x<=1&&(this.isScale=!0)}else this.animationObject.scale.x-=this.diffusionSpeed*e,this.animationObject.scale.z-=this.diffusionSpeed*e,this.yScale&&(this.animationObject.scale.y-=this.diffusionSpeed*e),this.animationObject.scale.x<=1&&(this.isScale=!0)},this.reset=()=>{this.animationObject.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0)}}}xv.type="NodeBreatheAnimationController";class wv extends gy{constructor(e,t="round",i=!1,n="path",a=[],r=[0,0,0],s="",o=""){super("NodeMovingAnimationController"),this.animationObject=e,this.position=this.animationObject.position.clone(),this.rotation=this.animationObject.rotation.clone(),this.motion=t,this.speed=a[0].speed*Ep.worldScale,this.reverse=i,this.useTangent="path"===n,this.startLength=0,this.maxLength=0,this.points=[],this.tangents=[],this.lengths=[],this.rotationsY=[];const l=new Ce;this.points.push(l.copy(a[0]).clone()),this.tangents.push(l.copy(a[1]).sub(a[0]).normalize()),this.lengths.push(0),this.rotationsY.push(this.rotation.y),this.pathId=s;for(let e=1;e<a.length;e++){const t=a[e],i=a[e-1];this.points.push(l.copy(t).clone());const n=l.sub(i);this.lengths.push(n.length()),this.tangents.push(n.clone().normalize()),this.maxLength+=this.lengths[e];const r=Math.atan2(n.x,n.z),s=this.tangents[e-1],o=Math.atan2(s.x,s.z);this.rotationsY.push(this.rotationsY[e-1]+r-o)}this.offset=l.set(r[0],r[1],r[2]);let c=0,h=[],u=!1,d=0;this.getCurrent=e=>{let t,i,n=0;for(let a=0;a<h.length;a++){const r=h[a];if(n+=r.length,n>=e){t=h[a-1],i=r;break}}if(n===e)return{point:i.point,tangent:i.tangent,ratio:1};if(!t||!i)return{point:h[0].point,tangent:h[0].tangent};const a=1-(n-e)/i.length;return{point:(new Ce).lerpVectors(t.point,i.point,a),tangent:i.tangent}},this.getRotation=e=>{const t=this.rotation.clone();if(!this.useTangent)return t;t.y=e.rotationY;const i=e.clone();i.y=0;let n=i.angleTo(e);return n*=(!0===u?1:-1)*Math.sign(e.y),t.x=n,t.order="YXZ",t},this.render=e=>{if(0===this.speed)return void this.dispose();if(e>1)return;c+=e;const t=c*this.speed;if(t>this.maxLength)return void("none"===this.motion?(this.reset(),Ep.animationStore.remove(this)):(d++,this.restart()));const{point:i,tangent:n}=this.getCurrent(t),a=this.offset.clone().add(i),r=this.getRotation(n);this.animationObject.position.copy(a),this.animationObject.rotation.copy(r),o instanceof Function&&o({id:this.pathId,pass:u?1-t/this.maxLength:t/this.maxLength})},this.restart=()=>{c=0,h=[],u=!1;for(let e=0;e<this.points.length;e++){const t=this.tangents[e].clone();t.rotationY=this.rotationsY[e],h.push({point:this.points[e].clone(),tangent:t,length:this.lengths[e]})}if(this.reverse&&(u=!u),"round"===this.motion&&d%2==1&&(u=!u),u){h.reverse();const e=new dt(0,Math.PI,0);let t=0;for(let i=0;i<h.length;i++){h[i].tangent.applyEuler(e);const n=h[i].length;h[i].length=t,t=n}const i=[...this.rotationsY];i.reverse(),i.unshift(i[0]),i.pop();for(let e=0;e<h.length;e++)h[e].tangent.rotationY=i[e]-Math.PI}const{point:e,tangent:t}=this.getCurrent(0),i=this.offset.clone().add(e),n=this.getRotation(t);this.animationObject.position.copy(i),this.animationObject.rotation.copy(n),o instanceof Function&&o({id:s,pass:u?1:0})},this.reset=()=>{this.animationObject.position.copy(this.position),this.animationObject.rotation.copy(this.rotation)},this.restart()}}wv.type="NodeMovingAnimationController";class Sv extends gy{constructor(e,t,i,n,a,r,s){super("NodeRotationAnimationController"),this.animationObject=e,this.isX=t,this.isY=i,this.isZ=n,this.xSpeed=a,this.ySpeed=r,this.zSpeed=s,this.rotationX0=this.animationObject.rotation.x,this.rotationY0=this.animationObject.rotation.y,this.rotationZ0=this.animationObject.rotation.z,this.render=e=>{null!=this.animationObject&&(this.isX&&(this.animationObject.rotation.x+=this.xSpeed*e*20/Math.PI),this.isY&&(this.animationObject.rotation.y+=this.ySpeed*e*20/Math.PI),this.isZ&&(this.animationObject.rotation.z+=this.zSpeed*e*20/Math.PI))},this.reset=()=>{this.animationObject.rotation.x=this.rotationX0,this.animationObject.rotation.y=this.rotationY0,this.animationObject.rotation.z=this.rotationZ0}}}Sv.type="NodeRotationAnimationController";class Mv extends gy{constructor(e,t,i,n,a,r=!1){super("NodeScaleAnimationController"),this.animationObject=e,this.startScale=t,this.endScale=i,this.startDisappearScale=n,this.diffusionSpeed=a,this.yScale=r,this.scaleX0=this.animationObject.scale.x,this.scaleY0=this.animationObject.scale.y,this.scaleZ0=this.animationObject.scale.z,e.material?this.opacity=e.material.opacity||1:this.opacity=1,this.render=e=>{if(null!=this.animationObject){if(void 0===e){var t=this.endScale/100;this.animationObject.scale.x+=this.diffusionSpeed*t,this.animationObject.scale.z+=this.diffusionSpeed*t,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*t)}else this.animationObject.scale.x+=this.diffusionSpeed*e,this.animationObject.scale.z+=this.diffusionSpeed*e,this.yScale&&(this.animationObject.scale.y+=this.diffusionSpeed*e);if(this.diffusionSpeed>=0){if(this.animationObject.scale.x>this.endScale)if(this.animationObject.scale.x=this.startScale,this.animationObject.scale.z=this.startScale,this.yScale&&(this.animationObject.scale.y=this.startScale),this.animationObject.material)this.animationObject.material.opacity=this.opacity;else if(this.animationObject.children.length>0){var i=this;this.animationObject.traverse((function(e){e.material&&(e.material.opacity=i.opacity)}))}if(this.animationObject.scale.x>this.startDisappearScale){var n=(1-(this.animationObject.scale.x-this.startDisappearScale)/(this.endScale-this.startDisappearScale))*this.opacity;this.animationObject.material?(this.animationObject.material.opacity=n,this.animationObject.material.transparent=!0):this.animationObject.children.length>0&&this.animationObject.traverse((function(e){e.material&&(e.material.opacity=n,e.material.transparent=!0)}))}}else{if(this.animationObject.scale.x<this.endScale)if(this.animationObject.scale.x=this.startScale,this.animationObject.scale.z=this.startScale,this.yScale&&(this.animationObject.scale.y=this.startScale),this.animationObject.material)this.animationObject.material.opacity=this.opacity;else if(this.animationObject.children.length>0){i=this;this.animationObject.traverse((function(e){e.material&&(e.material.opacity=i.opacity)}))}if(this.animationObject.scale.x<this.startDisappearScale){n=(1-(this.startDisappearScale-this.animationObject.scale.x)/(this.endScale-this.startDisappearScale))*this.opacity;this.animationObject.material?(this.animationObject.material.opacity=n,this.animationObject.material.transparent=!0):this.animationObject.children.length>0&&this.animationObject.traverse((function(e){e.material&&(e.material.opacity=n,e.material.transparent=!0)}))}}}},this.reset=()=>{this.animationObject.scale.set(this.scaleX0,this.scaleY0,this.scaleZ0),this.animationObject.material?this.animationObject.material.opacity=this.opacity:this.animationObject.children.length>0&&this.animationObject.traverse((e=>{e.material&&(e.material.opacity=this.opacity)}))}}}Mv.type="NodeScaleAnimationController";class Tv extends gy{constructor(e,t){super("ODLineRollingAnimationController"),this.animationObject=e,this.speed=t,this.value=this.animationObject.userData.mesh.material.uniforms.dashOffset.value,this.render=e=>{this.animationObject.userData.mesh.material.uniforms.dashOffset.value-=parseFloat(this.speed*e/10)},this.reset=()=>{this.animationObject.userData.mesh.material.uniforms.dashOffset.value=this.value}}}Tv.type="ODLineRollingAnimationController";class Av extends gy{constructor(e,t,i){super("RainAnimationController"),this.animationObject=e,this.isFollowCamera=t,this.render=e=>{for(var t=0;t<this.animationObject.children.length;t++){var n=this.animationObject.children[t];n.position.y-=i,n.position.y<0&&(n.position.y=250*i)}if(this.isFollowCamera){let e=Ep.camera.position.x,t=Ep.camera.position.y,i=Ep.camera.position.z;this.animationObject.position.set(e,t,i)}},this.reset=()=>{}}}Av.type="RainAnimationController";class Ev extends gy{constructor(e){super("RainlineAnimationController"),this.animationObject=e,this.value=this.animationObject.uniforms.time.value,this.render=e=>{this.animationObject.uniforms.time.value+=e},this.reset=()=>{this.animationObject.uniforms.time.value=this.value}}}Ev.type="RainlineAnimationController";class Cv extends gy{constructor(e,t,i=1){if(super("SmoothTransformController"),e.isObject3D)if(t&&(t.position||t.rotation||t.scale)){if(i<=0)return t.position instanceof Ce&&this._node.position.set(t.position.x,t.position.y,t.position.z),t.rotation,t.scale instanceof Ce&&this._node.scale.set(t.scale.x,t.scale.y,t.scale.z),e.getDirectionalLightHelper&&e.getDirectionalLightHelper().update(),void(this.needsRemove=!0);this._node=e,this._transform=t,this._duration=i,this._elapseTimeTotal=0,this._originalTransform={position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone()},this._skipFrame=2,this._skipFrameCounter=0}else this.needsRemove=!0;else this.needsRemove=!0}render(e){if(!this._node)return void(this.needsRemove=!0);if(this._elapseTimeTotal+=e,this._skipFrameCounter<this._skipFrame)return void this._skipFrameCounter++;this._skipFrameCounter=0;let t=1*this._elapseTimeTotal/this._duration;return this._transform.position instanceof Ce&&this._node.position.set(this._originalTransform.position.x+t*(this._transform.position.x-this._originalTransform.position.x),this._originalTransform.position.y+t*(this._transform.position.y-this._originalTransform.position.y),this._originalTransform.position.z+t*(this._transform.position.z-this._originalTransform.position.z)),this._transform.rotation,this._transform.scale instanceof Ce&&this._node.scale.set(this._originalTransform.scale.x+t*(this._transform.scale.x-this._originalTransform.scale.x),this._originalTransform.scale.y+t*(this._transform.scale.y-this._originalTransform.scale.y),this._originalTransform.scale.z+t*(this._transform.scale.z-this._originalTransform.scale.z)),this._node.getDirectionalLightHelper&&this._node.getDirectionalLightHelper().update(),this._elapseTimeTotal>this._duration?(this._transform.position instanceof Ce&&this._node.position.set(this._transform.position.x,this._transform.position.y,this._transform.position.z),this._transform.rotation,this._transform.scale instanceof Ce&&this._node.scale.set(this._transform.scale.x,this._transform.scale.y,this._transform.scale.z),this._node.getDirectionalLightHelper&&this._node.getDirectionalLightHelper().update(),void(this.needsRemove=!0)):void 0}}Cv.type="SmoothTransformController";class Iv extends gy{constructor(e,t,i){super("SnowAnimationController"),this.animationObject=e,this.isFollowCamera=t,this.render=e=>{for(var t=0;t<this.animationObject.children.length;t++){var n=this.animationObject.children[t];n.position.y-=i,n.position.y<0&&(n.position.y=250*i)}if(this.isFollowCamera){let e=Ep.camera.position.x,t=Ep.camera.position.y,i=Ep.camera.position.z;this.animationObject.position.set(e,t,i)}},this.reset=()=>{}}}Iv.type="SnowAnimationController";class Pv extends gy{constructor(e,t,i){super("TrailAnimationController"),this.baseCarrierController=e,this.trailCon=t,this.name=i,this.render=e=>{null==this.baseCarrierController&&null==this.trailCon||(this.baseCarrierController.update(e,this.name),this.trailCon.update(e))},this.dispose=()=>{this.baseCarrierController.dispose(),this.trailCon.dispose(),this.baseCarrierController=void 0,this.trailCon=void 0}}}Pv.type="TrailAnimationController";var Rv=zg(eu),Ov=Ug((function(e,t){(function(){var i=this.THREE||Rv;if(!i)throw new Error("MeshLine requires three.js");function n(){i.BufferGeometry.call(this),this.type="MeshLine",this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this._points=[],this._geom=null,this.widthCallback=null,this.matrixWorld=new i.Matrix4,Object.defineProperties(this,{geometry:{enumerable:!0,get:function(){return this}},geom:{enumerable:!0,get:function(){return this._geom},set:function(e){this.setGeometry(e,this.widthCallback)}},points:{enumerable:!0,get:function(){return this._points},set:function(e){this.setPoints(e,this.widthCallback)}}})}function a(e,t){var n=new i.Matrix4,a=new i.Ray,r=new i.Sphere,s=new i.Vector3,o=this.geometry;if(r.copy(o.boundingSphere),r.applyMatrix4(this.matrixWorld),!1!==e.ray.intersectSphere(r,s)){n.getInverse(this.matrixWorld),a.copy(e.ray).applyMatrix4(n);var l=new i.Vector3,c=new i.Vector3,h=new i.Vector3,u=this instanceof i.LineSegments?2:1,d=o.index,p=o.attributes;if(null!==d)for(var m=d.array,f=p.position.array,g=p.width.array,y=0,v=m.length-1;y<v;y+=u){var b=m[y],_=m[y+1];l.fromArray(f,3*b),c.fromArray(f,3*_);var x=null!=g[Math.floor(y/3)]?g[Math.floor(y/3)]:1,w=e.params.Line.threshold+this.material.lineWidth*x/2,S=w*w;if(!(a.distanceSqToSegment(l,c,s,h)>S)){s.applyMatrix4(this.matrixWorld);var M=e.ray.origin.distanceTo(s);M<e.near||M>e.far||(t.push({distance:M,point:h.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this}),y=v)}}}}function r(e,t,i,n,a){var r;if(e=e.subarray||e.slice?e:e.buffer,i=i.subarray||i.slice?i:i.buffer,e=t?e.subarray?e.subarray(t,a&&t+a):e.slice(t,a&&t+a):e,i.set)i.set(e,n);else for(r=0;r<e.length;r++)i[r+n]=e[r];return i}function s(e){i.ShaderMaterial.call(this,{uniforms:Object.assign({},i.UniformsLib.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new i.Color(16777215)},opacity:{value:1},resolution:{value:new i.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new i.Vector2(1,1)}}),vertexShader:i.ShaderChunk.meshline_vert,fragmentShader:i.ShaderChunk.meshline_frag}),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(e){this.uniforms.useAlphaMap.value=e}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(e){this.uniforms.useDash.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(e){this.uniforms.repeat.value.copy(e)}}}),this.setValues(e)}n.prototype=Object.create(i.BufferGeometry.prototype),n.prototype.constructor=n,n.prototype.isMeshLine=!0,n.prototype.setMatrixWorld=function(e){this.matrixWorld=e},n.prototype.setGeometry=function(e,t){this._geometry=e,e instanceof i.Geometry?this.setPoints(e.vertices,t):e instanceof i.BufferGeometry?this.setPoints(e.getAttribute("position").array,t):this.setPoints(e,t)},n.prototype.setPoints=function(e,t){if(e instanceof Float32Array||e instanceof Array){if(this._points=e,this.widthCallback=t,this.positions=[],this.counters=[],e.length&&e[0]instanceof i.Vector3)for(var n=0;n<e.length;n++){var a=e[n],r=n/e.length;this.positions.push(a.x,a.y,a.z),this.positions.push(a.x,a.y,a.z),this.counters.push(r),this.counters.push(r)}else for(n=0;n<e.length;n+=3){r=n/e.length;this.positions.push(e[n],e[n+1],e[n+2]),this.positions.push(e[n],e[n+1],e[n+2]),this.counters.push(r),this.counters.push(r)}this.process()}else console.error("ERROR: The BufferArray of points is not instancied correctly.")},n.prototype.raycast=a,n.prototype.compareV3=function(e,t){var i=6*e,n=6*t;return this.positions[i]===this.positions[n]&&this.positions[i+1]===this.positions[n+1]&&this.positions[i+2]===this.positions[n+2]},n.prototype.copyV3=function(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]},n.prototype.process=function(){var e,t,n=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],t=this.compareV3(0,n-1)?this.copyV3(n-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(var a=0;a<n;a++){if(this.side.push(1),this.side.push(-1),e=this.widthCallback?this.widthCallback(a/(n-1)):1,this.width.push(e),this.width.push(e),this.uvs.push(a/(n-1),0),this.uvs.push(a/(n-1),1),a<n-1){t=this.copyV3(a),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);var r=2*a;this.indices_array.push(r,r+1,r+2),this.indices_array.push(r+2,r+1,r+3)}a>0&&(t=this.copyV3(a),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]))}t=this.compareV3(n-1,0)?this.copyV3(1):this.copyV3(n-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new i.BufferAttribute(new Float32Array(this.positions),3),previous:new i.BufferAttribute(new Float32Array(this.previous),3),next:new i.BufferAttribute(new Float32Array(this.next),3),side:new i.BufferAttribute(new Float32Array(this.side),1),width:new i.BufferAttribute(new Float32Array(this.width),1),uv:new i.BufferAttribute(new Float32Array(this.uvs),2),index:new i.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new i.BufferAttribute(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()},n.prototype.advance=function(e){var t=this._attributes.position.array,i=this._attributes.previous.array,n=this._attributes.next.array,a=t.length;r(t,0,i,0,a),r(t,6,t,0,a-6),t[a-6]=e.x,t[a-5]=e.y,t[a-4]=e.z,t[a-3]=e.x,t[a-2]=e.y,t[a-1]=e.z,r(t,6,n,0,a-6),n[a-6]=e.x,n[a-5]=e.y,n[a-4]=e.z,n[a-3]=e.x,n[a-2]=e.y,n[a-1]=e.z,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0},i.ShaderChunk.meshline_vert=["",i.ShaderChunk.logdepthbuf_pars_vertex,i.ShaderChunk.fog_pars_vertex,"","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute float counters;","","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform float opacity;","uniform float sizeAttenuation;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","\t vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","","    vColor = vec4( color, opacity );","    vUV = uv;","","    mat4 m = projectionMatrix * modelViewMatrix;","    vec4 finalPosition = m * vec4( position, 1.0 );","    vec4 prevPos = m * vec4( previous, 1.0 );","    vec4 nextPos = m * vec4( next, 1.0 );","","    vec2 currentP = fix( finalPosition, aspect );","    vec2 prevP = fix( prevPos, aspect );","    vec2 nextP = fix( nextPos, aspect );","","    float w = lineWidth * width;","","    vec2 dir;","    if( nextP == currentP ) dir = normalize( currentP - prevP );","    else if( prevP == currentP ) dir = normalize( nextP - currentP );","    else {","        vec2 dir1 = normalize( currentP - prevP );","        vec2 dir2 = normalize( nextP - currentP );","        dir = normalize( dir1 + dir2 );","","        vec2 perp = vec2( -dir1.y, dir1.x );","        vec2 miter = vec2( -dir.y, dir.x );","        //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","    }","","    //vec2 normal = ( cross( vec3( dir, 0. ), vec3( 0., 0., 1. ) ) ).xy;","    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );","    normal.xy *= .5 * w;","    normal *= projectionMatrix;","    if( sizeAttenuation == 0. ) {","        normal.xy *= finalPosition.w;","        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;","    }","","    finalPosition.xy += normal.xy * side;","","    gl_Position = finalPosition;","",i.ShaderChunk.logdepthbuf_vertex,i.ShaderChunk.fog_vertex&&"    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",i.ShaderChunk.fog_vertex,"}"].join("\n"),i.ShaderChunk.meshline_frag=["",i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useDash;","uniform float dashArray;","uniform float dashOffset;","uniform float dashRatio;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","void main() {","",i.ShaderChunk.logdepthbuf_fragment,"","    vec4 c = vColor;","    if( useMap == 1. ) c *= texture2D( map, vUV * repeat );","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV * repeat ).a;","    if( c.a < alphaTest ) discard;","    if( useDash == 1. ){","        c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));","    }","    gl_FragColor = c;","    gl_FragColor.a *= step(vCounters, visibility);","",i.ShaderChunk.fog_fragment,"}"].join("\n"),s.prototype=Object.create(i.ShaderMaterial.prototype),s.prototype.constructor=s,s.prototype.isMeshLineMaterial=!0,s.prototype.copy=function(e){return i.ShaderMaterial.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray.copy(e.dashArray),this.dashOffset.copy(e.dashOffset),this.dashRatio.copy(e.dashRatio),this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this},e.exports&&(t=e.exports={MeshLine:n,MeshLineMaterial:s,MeshLineRaycast:a}),t.MeshLine=n,t.MeshLineMaterial=s,t.MeshLineRaycast=a}).call(Bg)})),Dv=function(e){var t=[],i=e;this.g=new Ov.MeshLine,this.update=function(e){for(var n=i.userData.trailDuration,a=t.length-1;a>=0;a--)t[a].currentTime+e>n?t.splice(a,1):t[a].currentTime+=e;var r=i.position.clone();if(t.length<=0?t.push({pos:r,currentTime:0}):r.x==t[t.length-1].pos.x&&r.y==t[t.length-1].pos.y&&r.z==t[t.length-1].pos.z||t.push({pos:r,currentTime:0}),t.length>2){for(var s=i.userData.mesh,o=[],l=0;l<t.length;l++)o.push(t[l].pos.x),o.push(t[l].pos.y),o.push(t[l].pos.z);this.g.setPoints(o),s.geometry=this.g.geometry}},this.dispose=function(){}};(class extends gy{constructor(e){super("TreeAnimationController"),this.tree=e,this.windTime=0,this.render=e=>{null!=!this.tree&&(this.windTime+=e,this.tree.updateWindEffect(0,this.windTime),this.windTime>Number.MAX_SAFE_INTEGER-1e3&&(this.windTime=0))},this.dispose=()=>{this.tree=void 0}}}).type="TreeAnimationController";class Lv extends gy{constructor(e,t,i,n,a){super("UVMeshLineAnimationController"),this.material=e,this.enableU=t,this.enableV=i,this.uSpeed=n,this.vSpeed=a,this.reset=()=>{this.material.map&&(this.material.offset.x=0,this.material.offset.y=0)}}render(e){null!=this.material&&(this.enableU&&(this.material.offset.x+=this.uSpeed*e),this.enableV&&(this.material.offset.y+=this.vSpeed*e))}}Lv.type="UVMeshLineAnimationController";class kv extends gy{constructor(e,t=1){super("WaterAnimationController"),this._material=e,this._speed=t,this.dispose=()=>{_y.disposeThreeObject(this._material)}}get speed(){return this._speed}set speed(e){this._speed=e}render(e){null!=this._material&&(this._material.uniforms.time.value+=e*this._speed)}}kv.type="WaterAnimationController";class Nv{constructor(e=new Ce(1/0,1/0,1/0),t=new Ce(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,i=1/0,n=1/0,a=-1/0,r=-1/0,s=-1/0;for(let o=0,l=e.length;o<l;o+=3){const l=e[o],c=e[o+1],h=e[o+2];l<t&&(t=l),c<i&&(i=c),h<n&&(n=h),l>a&&(a=l),c>r&&(r=c),h>s&&(s=h)}return this.min.set(t,i,n),this.max.set(a,r,s),this}setFromBufferAttribute(e){let t=1/0,i=1/0,n=1/0,a=-1/0,r=-1/0,s=-1/0;for(let o=0,l=e.count;o<l;o++){const l=e.getX(o),c=e.getY(o),h=e.getZ(o);l<t&&(t=l),c<i&&(i=c),h<n&&(n=h),l>a&&(a=l),c>r&&(r=c),h>s&&(s=h)}return this.min.set(t,i,n),this.max.set(a,r,s),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=zv.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e){return this.makeEmpty(),this.expandByObject(e)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return void 0===e&&(console.warn("THREE.Box3: .getCenter() target is now required"),e=new Ce),this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return void 0===e&&(console.warn("THREE.Box3: .getSize() target is now required"),e=new Ce),this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;void 0!==t&&(null===t.boundingBox&&t.computeBoundingBox(),Uv.copy(t.boundingBox),Uv.applyMatrix4(e.matrixWorld),this.union(Uv));const i=e.children;for(let e=0,t=i.length;e<t;e++)"Points"!=i[e].type&&this.expandByObject(i[e]);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return void 0===t&&(console.warn("THREE.Box3: .getParameter() target is now required"),t=new Ce),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,zv),zv.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Yv),Xv.subVectors(this.max,Yv),Fv.subVectors(e.a,Yv),jv.subVectors(e.b,Yv),Hv.subVectors(e.c,Yv),Gv.subVectors(jv,Fv),Vv.subVectors(Hv,jv),Wv.subVectors(Fv,Hv);let t=[0,-Gv.z,Gv.y,0,-Vv.z,Vv.y,0,-Wv.z,Wv.y,Gv.z,0,-Gv.x,Vv.z,0,-Vv.x,Wv.z,0,-Wv.x,-Gv.y,Gv.x,0,-Vv.y,Vv.x,0,-Wv.y,Wv.x,0];return!!Jv(t,Fv,jv,Hv,Xv)&&(t=[1,0,0,0,1,0,0,0,1],!!Jv(t,Fv,jv,Hv,Xv)&&(Zv.crossVectors(Gv,Vv),t=[Zv.x,Zv.y,Zv.z],Jv(t,Fv,jv,Hv,Xv)))}clampPoint(e,t){return void 0===t&&(console.warn("THREE.Box3: .clampPoint() target is now required"),t=new Ce),t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return zv.copy(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){return void 0===e&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(e.center),e.radius=.5*this.getSize(zv).length(),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Bv[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Bv[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Bv[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Bv[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Bv[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Bv[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Bv[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Bv[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Bv)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}Nv.prototype.isBox3=!0;const Bv=[new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce],zv=new Ce,Uv=new Nv,Fv=new Ce,jv=new Ce,Hv=new Ce,Gv=new Ce,Vv=new Ce,Wv=new Ce,Yv=new Ce,Xv=new Ce,Zv=new Ce,qv=new Ce;function Jv(e,t,i,n,a){for(let r=0,s=e.length-3;r<=s;r+=3){qv.fromArray(e,r);const s=a.x*Math.abs(qv.x)+a.y*Math.abs(qv.y)+a.z*Math.abs(qv.z),o=t.dot(qv),l=i.dot(qv),c=n.dot(qv);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>s)return!1}return!0}class Qv extends gy{constructor(e){super("CameraFollowingController"),this.name=e,this.needIgnoreOne=!0,this.prevRotation,this.set=function(e,t,i,n){this.object=e;const a=this.object.position.clone();Ep.instance.setCamera({target:{x:a.x,y:a.y,z:a.z},azimuthAngle:n,inclinationAngle:i,distance:t}),this.needIgnoreOne=!0}.bind(this),this.x=0,this.y=0,this.box=new Nv}render(e){if(!this.object)return;if(!0===this.needIgnoreOne)return void(this.needIgnoreOne=!1);void 0===this.prevRotation&&(this.prevRotation=this.object.rotation.clone());const t=Ep.instance.getCamera();let i=t.azimuthAngle,n=t.inclinationAngle;const a=this.prevRotation.y/Math.PI*180;let r=this.object.rotation.y/Math.PI*180;r-a>180&&(r-=360),r-a<-180&&(r+=360);const s=(this.object.rotation.x-this.prevRotation.x)/Math.PI*180,o=r-a,l=90*e;if(0!==this.x||0!==this.y){this.x+=s,this.y+=o;const e=l*(this.x>=0?1:-1),t=l*(this.y>=0?1:-1);0!==this.x&&(Math.abs(this.x)>l?(n+=e,this.x-=e):(n+=this.x,this.x=0)),0!==this.y&&(Math.abs(this.y)>l?(i+=t,this.y-=t):(i+=this.y,this.y=0))}else if(0!==s||0!==o){const e=l*(s>=0?1:-1),t=l*(o>=0?1:-1);0!==s&&(Math.abs(s)>l?(n+=e,this.x+=s-e):n+=s),0!==o&&(Math.abs(o)>l?(i+=t,this.y+=o-t):i+=o)}this.box.setFromObject(this.object);const c=this.box.getCenter(this.object.position.clone());Ep.instance.setCamera({target:c,azimuthAngle:i,inclinationAngle:n}),this.prevRotation=this.object.rotation.clone()}}Qv.type="CameraFollowingController",Qv.prototype.isCameraFollowingController=!0;class Kv extends gy{constructor(e){super("PathBrushObjectMovingController"),this.animationObject=e.instancedItem,this.key=e.key,this.instanced=e.instanced,this.meshes=this.instanced.getMeshes(),this.helper=this.instanced.getHelper(this.key);const t=this.animationObject.getGroup().rotation.clone();this.euler=new dt(0,t.y,0,"YXZ"),this.paintPoints=[],this.paintTangents=[],this.paintLengths=[],this.startLength=0,this.maxLength=0,this.motion="loop",this.speed=0,this.delay=0,this.reverse=!1,this.useTangent=!1,this.perpendicular=!1;let i=0,n=[],a=!1,r=0,s=!1;this.visible=!0;let o=(new it).multiplyScalar(0);this.getCurrentPoint=e=>{let t,i,a=0;for(let r=0;r<n.length;r++){const s=n[r];if(a+=s.length,a>=e){t=n[r-1],i=s;break}}if(!t||!i)return{point:n[0].point,tangent:n[0].tangent};const r=1-(a-e)/i.length;return{point:(new Ce).lerpVectors(t.point,i.point,r),tangent:(new Ce).lerpVectors(t.tangent,i.tangent,r)}},this.getRotation=e=>{const t=this.euler.clone();if(!0===this.useTangent&&(t.y+=Math.atan2(e.x,e.z)),!0!==this.perpendicular){const i=e.clone();i.y=0;let n=i.angleTo(e);n*=(!0===s?1:-1)*Math.sign(e.y),t.x=n}return t.order="YXZ",t},this.updateMatrix=(e,t)=>{for(const i of this.meshes){const n=i.userData.matrices[this.key].matrix.clone(),a=new Ce,r=new Ee,s=new Ce;n.decompose(a,r,s),a.copy(e),r.setFromEuler(t),n.compose(a,r,s),n.multiply(i.matrixWorldOffset),n.multiply(i.userData.matrices[this.key].rotatingMatrix),i.setMatrixAt(this.key,n),i.instanceMatrix.needsUpdate=!0}this.helper.updatePosition(e)},this.render=e=>{if(0===this.speed)return;if(e>1)return;if("once"===this.motion&&1===r)return;if("oncePingPong"===this.motion&&2===r)return;if(!a)return i+=e,void(i>=this.delay&&(a=!0,i=0));if(i+=e,!this.visible){for(const e of this.meshes)e.setMatrixAt(this.key,o),e.instanceMatrix.needsUpdate=!0;return}const t=i*this.speed;if(t>=this.maxLength)return r++,void this.reset(!0);const n=this.getCurrentPoint(t),s=this.getRotation(n.tangent);this.updateMatrix(n.point,s)},this.reset=e=>{if(!this.paintPoints||!this.paintPoints[0])return;i=0,n=[],a=this.delay<=0,s=!1;const t=0==this.speed?1:this.speed;e||(r=0,i=this.startLength/t);for(let e=0;e<this.paintPoints.length;e++)n.push({point:this.paintPoints[e].clone(),tangent:this.paintTangents[e].clone(),length:this.paintLengths[e]});if(this.reverse){n.reverse();const e=new dt(0,Math.PI,0);let t=0;for(let i=0;i<n.length;i++){n[i].tangent.applyEuler(e);const a=n[i].length;n[i].length=t,t=a}s=!s}if(e&&("loopPingPong"===this.motion||"oncePingPong"===this.motion)&&0!==r&&r%2==1){n.reverse();const e=new dt(0,Math.PI,0);let t=0;for(let i=0;i<n.length;i++){n[i].tangent.applyEuler(e);const a=n[i].length;n[i].length=t,t=a}s=!s}const o=this.getCurrentPoint(i*t),l=this.getRotation(o.tangent);this.updateMatrix(o.point,l)},this.setVisible=e=>{this.visible=e;for(const e of this.meshes)e.setMatrixAt(this.key,o),e.instanceMatrix.needsUpdate=!0}}}Kv.type="PathBrushObjectMovingController";class $v extends gy{constructor(e){super("ExpandBuildingFloorController"),this.name=e.name,this.building=e.building,this.padding=e.padding,this.duration=e.duration,this.callback=e.callback,this.objects=[];for(const e of this.building.children)e.isBuildingFloorItem?(e.show(),this.objects.push({object:e.getGroup(),position:e.getGroup().position.clone(),y:(e.level-1)*this.padding})):e.hide();if(this.isOpen=1,this.duration<=0){for(const e of this.objects)e.object.position.y=e.position.y+e.y;this.callback&&(this.callback(1),this.callback=null)}let t=0;this.render=e=>{if(e*=this.isOpen,t+=e,t>this.duration||t<=0)return void(this.callback&&(this.callback(1),this.callback=null));const i=t/this.duration;for(const e of this.objects)e.object.position.y=e.y*i},this.reset=e=>{if(this.duration<=0){for(const e of this.objects)e.object.position.y=e.position.y;for(const e of this.building.children)e.isBuildingFloorItem?e.hide():e.show();e&&e(1)}else t=this.duration,this.isOpen=-1,this.callback=()=>{for(const e of this.building.children)e.isBuildingFloorItem?e.hide():e.show();this.callback=null,e&&e(1)}}}}$v.type="ExpandBuildingFloorController";class eb extends Yi{constructor(e=new ye){super({type:"EdgeBlurMaterial",uniforms:{inputBuffer:new jc(null),radius:new jc(1),texelSize:new jc(new ye),halfTexelSize:new jc(new ye),kernel:new jc(0),scale:new jc(1)},fragmentShader:"\n#ifdef FRAMEBUFFER_PRECISION_HIGH\n\tuniform mediump sampler2D inputBuffer;\n#else\n\tuniform lowp sampler2D inputBuffer;\n#endif\n\nuniform float radius;\nuniform vec2 texelSize;\nuniform vec2 halfTexelSize;\nuniform float kernel;\nuniform float scale;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tfloat d = distance(vec2(0.5, 0.5), vUv) - radius / 2.0;\n\tif (d <= 0.0) {\n\t\tgl_FragColor = texture2D(inputBuffer, vUv);\n\t} else {\n\t\tvec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;\n\t\tdUv *= (d * 4.0);\n\t\t// Sample top left, top right, bottom left, bottom right texels.\n\t\tvec4 sum = texture2D(inputBuffer, vec2(vUv.x - dUv.x, vUv.y + dUv.y)) \n\t\t\t+ texture2D(inputBuffer, vec2(vUv.x + dUv.x, vUv.y + dUv.y))\n\t\t\t+ texture2D(inputBuffer, vec2(vUv.x + dUv.x, vUv.y - dUv.y))\n\t\t\t+ texture2D(inputBuffer, vec2(vUv.x - dUv.x, vUv.y - dUv.y));\n\t\t// Compute the average.\n\t\tgl_FragColor = sum * 0.25;\n\t\n\t\t#ifdef DITHERING\n\t\n\t\t\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n\t\n\t\t#endif\n\t}\n\t\n}\n",vertexShader:"\nvarying vec2 vUv;\n\nvoid main() {\n\tvUv = uv;\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n}\n",blending:0,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernelSize=ib.LARGE}getKernel(){return tb[this.kernelSize]}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}}const tb=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],ib={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5};class nb extends Uu{constructor({radius:e=.8,scale:t=1,resolutionScale:i=1,width:n=ju.AUTO_SIZE,height:a=ju.AUTO_SIZE,kernelSize:r=ib.LARGE}={}){super("EdgeBlurPass"),this.renderTargetA=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B",this.resolution=new ju(this,n,a,i),this.edgeBlurMaterial=new eb,this.edgeBlurMaterial.uniforms.radius.value=e,this.edgeBlurMaterial.uniforms.scale.value=t,this.ditheredEdgeBlurMaterial=new eb,this.ditheredEdgeBlurMaterial.dithering=!0,this.dithering=!1,this.kernelSize=r}get width(){return this.resolution.width}set width(e){this.resolution.width=e}get height(){return this.resolution.height}set height(e){this.resolution.height=e}get scale(){return this.edgeBlurMaterial.uniforms.scale.value}set scale(e){this.edgeBlurMaterial.uniforms.scale.value=e,this.ditheredEdgeBlurMaterial.uniforms.scale.value=e}get kernelSize(){return this.edgeBlurMaterial.kernelSize}set kernelSize(e){this.edgeBlurMaterial.kernelSize=e,this.ditheredEdgeBlurMaterial.kernelSize=e}get radius(){return this.edgeBlurMaterial.uniforms.radius.value}set radius(e){this.edgeBlurMaterial.uniforms.radius.value=e}render(e,t,i,n,a){const r=this.scene,s=this.camera,o=this.renderTargetA,l=this.renderTargetB;let c=this.edgeBlurMaterial,h=c.uniforms;const u=c.getKernel();let d,p,m,f=t;for(this.setFullscreenMaterial(c),p=0,m=u.length-1;p<m;++p)d=0==(1&p)?o:l,h.kernel.value=u[p],h.inputBuffer.value=f.texture,e.setRenderTarget(d),e.render(r,s),f=d;this.dithering&&(c=this.ditheredEdgeBlurMaterial,h=c.uniforms,this.setFullscreenMaterial(c)),h.kernel.value=u[p],h.inputBuffer.value=f.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(r,s)}setSize(e,t){const i=this.resolution;i.base.set(e,t);const n=i.width,a=i.height;this.renderTargetA.setSize(n,a),this.renderTargetB.setSize(n,a),this.edgeBlurMaterial.setTexelSize(1/n,1/a),this.ditheredEdgeBlurMaterial.setTexelSize(1/n,1/a)}initialize(e,t,i){if(t||i!==w||(this.renderTargetA.texture.format=C,this.renderTargetB.texture.format=C),void 0!==i&&(this.renderTargetA.texture.type=i,this.renderTargetB.texture.type=i,i!==w)){const e=this.edgeBlurMaterial,t=this.ditheredEdgeBlurMaterial;e.defines.FRAMEBUFFER_PRECISION_HIGH="1",t.defines.FRAMEBUFFER_PRECISION_HIGH="1"}}static get AUTO_SIZE(){return ju.AUTO_SIZE}}var ab={defines:{DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{time:{value:0},speed:{value:1},color:{value:new Qt(1,1,1)},brightness:{value:1},size:{value:1}},vertexShader:["precision highp float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float time;","uniform float speed;","uniform float size;","attribute vec3 position;","attribute vec2 uv;","attribute vec3 translate;","varying vec2 vUv;","varying float vScale;","void main() {","vec4 pos=vec4(translate, 1.0 );","pos.x=pos.x+sin(pos.x+time*speed)*50.0;","pos.y=pos.y+sin(pos.y+time*speed)*50.0;","pos.z=pos.z+sin(pos.z+time*speed)*50.0;","vec4 mvPosition = modelViewMatrix * pos;","vec3 trTime = vec3(translate.x + time,translate.y + time,translate.z + time);","float scale = sin( trTime.x * 0.21 * 2.0 );","vScale = scale;","scale = scale * 10.0 + 10.0;","mvPosition.xyz += position*size/10.0;//* scale","vUv = uv;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","uniform float brightness;","varying vec2 vUv;","varying float vScale;","vec3 HUEtoRGB(float H){","H = mod(H,1.0);","float R = abs(H * 6.0 - 3.0) - 1.0;","float G = 2.0 - abs(H * 6.0 - 2.0);","float B = 2.0 - abs(H * 6.0 - 4.0);","return clamp(vec3(R,G,B),0.0,1.0);","}","vec3 HSLtoRGB(vec3 HSL){","vec3 RGB = HUEtoRGB(HSL.x);","float C = (1.0 - abs(2.0 * HSL.z - 1.0)) * HSL.y;","return (RGB - 0.5) * C + HSL.z;","}","void main() {","vec4 diffuseColor = texture2D( map, vUv );","gl_FragColor = vec4( diffuseColor.r * color.r, diffuseColor.g * color.g, diffuseColor.b * color.b, brightness * abs(vScale) * diffuseColor.a );","//gl_FragColor = vec4( 10,0,0, brightness * vScale * diffuseColor.w );","}"].join("\n")},rb={uniforms:{map:{value:null},bgMap:{value:null},color:{value:new Qt(1,1,1)},brightness:{value:1}},vertexShader:["precision highp float;","varying vec2 vUvv;","varying vec2 pUv;","void main() {","\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","   vUvv=uv;","   pUv=vec2(worldPosition.x,worldPosition.z);","\tgl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform sampler2D map;","uniform sampler2D bgMap;","uniform vec4 color;","uniform float brightness;","varying vec2 vUvv;","varying vec2 pUv;","void main() {","\tvec4 dColor = texture2D( map, vUvv);","   vec2 bguv=pUv;","   bguv.x*=0.1;","   bguv.y*=0.1;","\tvec4 bgColor =texture2D(bgMap,bguv);","\tvec4 finalColor =mix(dColor,bgColor,bgColor.a);//(dColor+bgColor）*color*brightness;","\tgl_FragColor =vec4(finalColor.rgb,dColor.a);","   //gl_FragColor=vec4(vReflectionFactor,vReflectionFactor,vReflectionFactor,1.0);","}"].join("\n")};class sb extends ed{constructor(e={}){const t=Object.assign({blendFunction:Qu.NORMAL},e);super("ImageAdjustmentEffect","uniform float exposure; // 曝光\nuniform float brightness; // 亮度\nuniform float contrast; // 对比度\nuniform float highlight; // 对比度\nuniform float shadow; // 对比度\nuniform float saturation; // 饱和度\nuniform vec3 hue; // 色相\nuniform float naturalSaturation; // 自然饱和度\nuniform float temperature; // 色温\nuniform float tint; // 色偏\nuniform float clarity; // 清晰度\n\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor) {\n\n    vec4 color = vec4(inputColor);\n\n    // 曝光\n    color.rgb *= pow(2.0, exposure * 5.0);\n\n    // 饱和度\n    float average = (color.r + color.g + color.b) / 3.0;\n    color.rgb = mix(vec3(average), color.rgb, saturation + 1.0);\n\n    // 自然饱和度\n\n\n    // 亮度\n    color.rgb += vec3(brightness * 0.2 - 0.5);\n\n    // 对比度\n    if(contrast > 0.0) {\n\n      color.rgb /= vec3(1.0 - contrast * 0.2);\n\n    } else {\n\n      color.rgb *= vec3(1.0 + contrast * 0.2);\n\n    }\n\n\t  color.rgb += vec3(0.5);\n\n    // 色相\n    color.rgb = vec3(dot(color.rgb, hue.xyz), dot(color.rgb, hue.zxy), dot(color.rgb, hue.yzx));\n\n    // 高光\n    if (average < 0.5) {\n      // color.rgb *= pow(2.0, shadow * 5.0);\n      color.rgb *= pow(2.0, shadow * 0.5);\n    } else if (average > 0.5) {\n      color.rgb *= pow(2.0, highlight * 0.2);\n    // } else {\n    //     float ratio = (average - 0.33) / 0.34;\n    //     color.rgb *= ratio;\n    }\n\n    // 色温\n    color.r += temperature * 0.5;\n    color.b -= temperature * 0.5;\n\n    // 色偏\n    color.r += tint * 0.5;\n    color.g -= tint * 0.5;\n\n    // 清晰度\n    // vec3 edge = texture(tex, gl_TexCoord[0].xy + vec2(1.0)/textureSize(tex, 0)).rgb;\n    // edge -= color.rgb;\n    // color.rgb += edge * clarity;\n\n    outputColor = vec4(color);\n}",{blendFunction:t.blendFunction,uniforms:new Map([["exposure",new jc(t.exposure)],["saturation",new jc(t.saturation)],["hue",new jc(t.hue)],["highlight",new jc(t.highlight)],["shadow",new jc(t.shadow)],["contrast",new jc(t.contrast)],["brightness",new jc(t.brightness)],["naturalSaturation",new jc(t.naturalSaturation)],["temperature",new jc(t.temperature)],["tint",new jc(t.tint)],["clarity",new jc(t.clarity)]])})}}const ob={defines:{BAND_MODE:2,CHROMA_SAMPLES:1},uniforms:{tDiffuse:{value:null},baseIor:{value:.075},bandOffset:{value:.003},jitterIntensity:{value:1},jitterOffset:{value:0}},vertexShader:"\n\t\tvarying vec2 vUv; \n\t\tvarying vec3 viewDir;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\tviewDir = normalize( ( modelViewMatrix * vec4( position, 1.0 ) ).xyz );\n\t\t}\n\t",fragmentShader:"\n\t\tvarying vec2 vUv;\n\t\tvarying vec3 viewDir;\n\t\tuniform float baseIor;\n\t\tuniform float bandOffset;\n\t\tuniform float jitterIntensity;\n\t\tuniform float jitterOffset;\n\t\tuniform sampler2D tDiffuse;\n\n\t\t#include <common>\n\t\tvoid main() {\n\n\t\t\tvec3 normal = vec3( ( 2.0 * vUv - vec2( 1.0 ) ), 1.0 );\n\t\t\tnormal.z = 1.0;\n\t\t\tnormal = normalize( normal );\n\n\t\t\tvec3 color;\n\n\t\t\t// if NO BANDS\n\t\t\t#if BAND_MODE == 0\n\n\t\t\tvec3 refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor );\n\t\t\tcolor = texture2D( tDiffuse, vUv + refracted.xy ).rgb;\n\n\t\t\t// if RGB or RYGCBV BANDS\n\t\t\t#else\n\n\t\t\tfloat index, randValue, offsetValue;\n\t\t\tfloat r, g, b, r_ior, g_ior, b_ior;\n\t\t\tvec3 r_refracted, g_refracted, b_refracted;\n\t\t\tvec4 r_sample, g_sample, b_sample;\n\n\t\t\t#if BAND_MODE == 2\n\t\t\tfloat y, c, v, y_ior, c_ior, v_ior;\n\t\t\tvec3 y_refracted, c_refracted, v_refracted;\n\t\t\tvec4 y_sample, c_sample, v_sample;\n\t\t\t#endif\n\n\t\t\tfor ( int i = 0; i < CHROMA_SAMPLES; i ++ ) {\n\t\t\t\tindex = float( i );\n\t\t\t\trandValue = rand( sin( index + 1. ) * gl_FragCoord.xy + vec2( jitterOffset, - jitterOffset ) ) - 0.5;\n\t\t\t\toffsetValue = index / float( CHROMA_SAMPLES ) + randValue * jitterIntensity;\n\t\t\t\t#if BAND_MODE == 1\n\t\t\t\trandValue *= 2.0;\n\t\t\t\t#endif\n\n\t\t\t\t// Paper describing functions for creating yellow, cyan, and violet bands and reforming\n\t\t\t\t// them into RGB:\n\t\t\t\t// https://web.archive.org/web/20061108181225/http://home.iitk.ac.in/~shankars/reports/dispersionraytrace.pdf\n\t\t\t\tr_ior = 1.0 + bandOffset * ( 0.0 + offsetValue );\n\t\t\t\tg_ior = 1.0 + bandOffset * ( 2.0 + offsetValue );\n\t\t\t\tb_ior = 1.0 + bandOffset * ( 4.0 + offsetValue );\n\n\t\t\t\tr_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / r_ior );\n\t\t\t\tg_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / g_ior );\n\t\t\t\tb_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / b_ior );\n\n\t\t\t\tr_sample = texture2D( tDiffuse, vUv + r_refracted.xy );\n\t\t\t\tg_sample = texture2D( tDiffuse, vUv + g_refracted.xy );\n\t\t\t\tb_sample = texture2D( tDiffuse, vUv + b_refracted.xy );\n\n\t\t\t\t#if BAND_MODE == 2\n\t\t\t\ty_ior = 1.0 + bandOffset * ( 1.0 + offsetValue );\n\t\t\t\tc_ior = 1.0 + bandOffset * ( 3.0 + offsetValue );\n\t\t\t\tv_ior = 1.0 + bandOffset * ( 5.0 + offsetValue );\n\n\t\t\t\ty_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / y_ior );\n\t\t\t\tc_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / c_ior );\n\t\t\t\tv_refracted = refract( vec3( 0.0, 0.0, - 1.0 ), normal, baseIor / v_ior );\n\n\t\t\t\ty_sample = texture2D( tDiffuse, vUv + y_refracted.xy );\n\t\t\t\tc_sample = texture2D( tDiffuse, vUv + c_refracted.xy );\n\t\t\t\tv_sample = texture2D( tDiffuse, vUv + v_refracted.xy );\n\n\t\t\t\tr = r_sample.r / 2.0;\n\t\t\t\ty = ( 2.0 * y_sample.r + 2.0 * y_sample.g - y_sample.b ) / 6.0;\n\t\t\t\tg = g_sample.g / 2.0;\n\t\t\t\tc = ( 2.0 * c_sample.g + 2.0 * c_sample.b - c_sample.r ) / 6.0;\n\t\t\t\tb = b_sample.b / 2.0;\n\t\t\t\tv = ( 2.0 * v_sample.b + 2.0 * v_sample.r - v_sample.g ) / 6.0;\n\n\t\t\t\tcolor.r += r + ( 2.0 * v + 2.0 * y - c ) / 3.0;\n\t\t\t\tcolor.g += g + ( 2.0 * y + 2.0 * c - v ) / 3.0;\n\t\t\t\tcolor.b += b + ( 2.0 * c + 2.0 * v - y ) / 3.0;\n\t\t\t\t#else\n\t\t\t\tcolor.r += r_sample.r;\n\t\t\t\tcolor.g += g_sample.g;\n\t\t\t\tcolor.b += b_sample.b;\n\t\t\t\t#endif\n\t\t\t}\n\t\t\tcolor /= float( CHROMA_SAMPLES );\n\t\t\t#endif\n\t\t\tgl_FragColor = vec4( color, 1.0 );\n\t\t}\n\t"};var lb=Ug((function(e,t){(function(){var i=this.THREE||Rv;if(!i)throw new Error("MeshLine requires three.js");function n(){i.BufferGeometry.call(this),this.type="MeshLine",this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this._points=[],this._geom=null,this.widthCallback=null,this.material=null,this.matrixWorld=new i.Matrix4,Object.defineProperties(this,{geometry:{enumerable:!0,get:function(){return this}},geom:{enumerable:!0,get:function(){return this._geom},set:function(e){this.setGeometry(e,this.widthCallback)}},points:{enumerable:!0,get:function(){return this._points},set:function(e){this.setPoints(e,this.widthCallback)}}})}function a(e,t){var n=new i.Matrix4,a=new i.Ray,r=new i.Sphere,s=new i.Vector3,o=this.geometry;if(r.copy(o.boundingSphere),r.applyMatrix4(this.matrixWorld),!1!==e.ray.intersectSphere(r,s)){n.copy(this.matrixWorld).invert(),a.copy(e.ray).applyMatrix4(n);var l=new i.Vector3,c=new i.Vector3,h=new i.Vector3,u=this instanceof i.LineSegments?2:1,d=o.index,p=o.attributes;if(null!==d)for(var m=d.array,f=p.position.array,g=p.width.array,y=0,v=m.length-1;y<v;y+=u){var b=m[y],_=m[y+1];l.fromArray(f,3*b),c.fromArray(f,3*_);var x=null!=g[Math.floor(y/3)]?g[Math.floor(y/3)]:1,w=e.params.Line.threshold+this.material.lineWidth*x/2,S=w*w;if(!(a.distanceSqToSegment(l,c,s,h)>S)){s.applyMatrix4(this.matrixWorld);var M=e.ray.origin.distanceTo(s);M<e.near||M>e.far||(t.push({distance:M,point:h.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this}),y=v)}}}}function r(e,t,i,n,a){var r;if(e=e.subarray||e.slice?e:e.buffer,i=i.subarray||i.slice?i:i.buffer,e=t?e.subarray?e.subarray(t,a&&t+a):e.slice(t,a&&t+a):e,i.set)i.set(e,n);else for(r=0;r<e.length;r++)i[r+n]=e[r];return i}function s(e){i.ShaderMaterial.call(this,{uniforms:Object.assign({},i.UniformsLib.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},maskMap:{value:null},useMaskMap:{value:0},color:{value:new i.Color(16777215)},opacity:{value:1},resolution:{value:new i.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new i.Vector2(1,1)},offset:{value:new i.Vector2(0,0)},colorPass:{value:new i.Color(16777215)},pass:{value:0},passRange:{value:.05},faceUp:{value:!1},faceOut:{value:!1},showOutline:{value:!1},outlineWidth:{value:.1},outlineColor:{value:new i.Color(16772608)}}),vertexShader:i.ShaderChunk.meshline_vert,fragmentShader:i.ShaderChunk.meshline_frag}),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(e){this.uniforms.useAlphaMap.value=e}},maskMap:{enumerable:!0,get:function(){return this.uniforms.maskMap.value},set:function(e){this.uniforms.maskMap.value=e}},useMaskMap:{enumerable:!0,get:function(){return this.uniforms.useMaskMap.value},set:function(e){this.uniforms.useMaskMap.value=e}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(e){this.uniforms.useDash.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(e){this.uniforms.repeat.value.copy(e)}},offset:{enumerable:!0,get:function(){return this.uniforms.offset.value},set:function(e){this.uniforms.offset.value.copy(e)}},colorPass:{enumerable:!0,get:function(){return this.uniforms.colorPass.value},set:function(e){this.uniforms.colorPass.value.copy(e)}},pass:{enumerable:!0,get:function(){return this.uniforms.pass.value},set:function(e){this.uniforms.pass.value=e}},passRange:{enumerable:!0,get:function(){return this.uniforms.passRange.value},set:function(e){this.uniforms.passRange.value=e}},faceUp:{enumerable:!0,get:function(){return this.uniforms.faceUp.value},set:function(e){this.uniforms.faceUp.value=e}},faceOut:{enumerable:!0,get:function(){return this.uniforms.faceOut.value},set:function(e){this.uniforms.faceOut.value=e}},showOutline:{enumerable:!0,get:function(){return this.uniforms.showOutline.value},set:function(e){this.uniforms.showOutline.value=e}},outlineWidth:{enumerable:!0,get:function(){return this.uniforms.outlineWidth.value},set:function(e){this.uniforms.outlineWidth.value=e}},outlineColor:{enumerable:!0,get:function(){return this.uniforms.outlineColor.value},set:function(e){this.uniforms.outlineColor.value=e}}}),this.setValues(e)}n.prototype=Object.create(i.BufferGeometry.prototype),n.prototype.constructor=n,n.prototype.isMeshLine=!0,n.prototype.setMatrixWorld=function(e){this.matrixWorld=e},n.prototype.setGeometry=function(e,t){this._geometry=e,e instanceof i.BufferGeometry?this.setPoints(e.getAttribute("position").array,t):this.setPoints(e,t)},n.prototype.setPoints=function(e,t){if(e instanceof Float32Array||e instanceof Array){if(this._points=e,this.widthCallback=t,this.positions=[],this.counters=[],e.length&&e[0]instanceof i.Vector3)for(var n=0;n<e.length;n++){var a=e[n],r=n/e.length;this.positions.push(a.x,a.y,a.z),this.positions.push(a.x,a.y,a.z),this.counters.push(r),this.counters.push(r)}else for(n=0;n<e.length;n+=3){r=n/e.length;this.positions.push(e[n],e[n+1],e[n+2]),this.positions.push(e[n],e[n+1],e[n+2]),this.counters.push(r),this.counters.push(r)}this.process()}else logger.error("ERROR: The BufferArray of points is not instancied correctly.")},n.prototype.raycast=function(e,t){if(!this._raycast)return void a.call(this,e,t);const n=this.geometry.attributes.position.clone(),r=this.material.resolution,s=r.x/r.y;function o(e){const t=new i.Vector2;return t.x=e.x/e.w,t.y=e.y/e.w,t.x*=s,t}const l=new i.Vector3,c=new i.Vector3,h=new i.Vector3,u=.5*this.material.lineWidth,d=this._context.camera.projectionMatrix,p=this._context.camera.projectionMatrixInverse,m=this.modelViewMatrix,f=this.modelViewMatrix.clone().invert(),g=d.clone().multiply(m);for(let e=0,t=n.count;e<t;e++){l.fromBufferAttribute(this.geometry.attributes.position,e),c.fromBufferAttribute(this.geometry.attributes.previous,e),h.fromBufferAttribute(this.geometry.attributes.next,e);const t=this.geometry.attributes.side.getX(e),n=(new i.Vector4).copy(l);n.applyMatrix4(g);const a=o(n),s=(new i.Vector4).copy(c);s.applyMatrix4(g);const m=o(s),y=(new i.Vector4).copy(h);y.applyMatrix4(g);const v=o(y),b=new i.Vector2;if(v.equals(a))b.copy(a).sub(m).normalize();else if(m.equals(a))b.copy(v).sub(a).normalize();else{const e=a.clone().sub(m),t=v.clone().sub(a);b.copy(e).add(t).normalize()}b.multiplyScalar(u);const _=new i.Vector4(-b.y,b.x);if(_.applyMatrix4(d),!this.material.sizeAttenuation){_.x*=n.w,_.y*=n.w;const e=new i.Vector4(r.x,r.y);e.applyMatrix4(d),_.x/=e.x,_.y/=e.y}n.x+=_.x*t,n.y+=_.y*t,n.applyMatrix4(p),n.applyMatrix4(f),this.geometry.attributes.position.setXYZ(e,n.x,n.y,n.z)}this._raycast(e,t),this.geometry.attributes.position.copy(n)},n.prototype.compareV3=function(e,t){var i=6*e,n=6*t;return this.positions[i]===this.positions[n]&&this.positions[i+1]===this.positions[n+1]&&this.positions[i+2]===this.positions[n+2]},n.prototype.copyV3=function(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]},n.prototype.process=function(){var e,t,n=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],t=this.compareV3(0,n-1)?this.copyV3(n-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(var a=0;a<n;a++){if(this.side.push(1),this.side.push(-1),e=this.widthCallback?this.widthCallback(a/(n-1)):1,this.width.push(e),this.width.push(e),this.uvs.push(a/(n-1),0),this.uvs.push(a/(n-1),1),a<n-1){t=this.copyV3(a),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);var r=2*a;this.indices_array.push(r,r+1,r+2),this.indices_array.push(r+2,r+1,r+3)}a>0&&(t=this.copyV3(a),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]))}if(t=this.compareV3(n-1,0)?this.copyV3(1):this.copyV3(n-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),null!==this.material&&!0===this.material.faceUp){const e=2*Math.PI;for(let t=0;t<this.positions.length;t+=3){const n=new i.Vector2(this.positions[t],this.positions[t+2]),a=new i.Vector2(this.previous[t],this.previous[t+2]),r=new i.Vector2(this.next[t],this.next[t+2]);let s=null,o=0;if(r.equals(n))s=n.clone().sub(a).normalize();else if(a.equals(n))s=r.clone().sub(n).normalize();else{const t=n.clone().sub(a).normalize(),i=r.clone().sub(n).normalize();s=t.clone().add(i).normalize();const l=(Math.atan2(t.y,t.x)+e)%e;o=(Math.atan2(i.y,i.x)+e)%e-l}const l=s.clone();s.x=-l.y,s.y=l.x;const c=this.side[Math.floor(t/3)];s.multiplyScalar(c);let h=this.material.lineWidth/2;0!==o&&(h/=Math.cos(o/2)),s.multiplyScalar(Math.abs(h)),this.positions[t]+=s.x,this.positions[t+2]+=s.y}}if(null!==this.material&&!0===this.material.faceOut){const e=2*Math.PI;let t=0;for(let n=0;n<this.positions.length;n+=3){const a=new i.Vector3(this.positions[n],this.positions[n+1],this.positions[n+2]),r=new i.Vector3(this.previous[n],this.previous[n+1],this.previous[n+2]),s=new i.Vector3(this.next[n],this.next[n+1],this.next[n+2]);let o=null,l=0;if(s.equals(a))o=a.clone().sub(r).normalize();else if(r.equals(a))o=s.clone().sub(a).normalize();else{const t=a.clone().sub(r).normalize(),i=s.clone().sub(a).normalize();o=t.clone().add(i).normalize();const n=(Math.atan2(t.y,t.x)+e)%e;l=(Math.atan2(i.y,i.x)+e)%e-n,l=t.angleTo(i)}o.cross(a).normalize();const c=this.side[Math.floor(n/3)];o.multiplyScalar(c);let h=this.material.lineWidth/2;0!==l&&(l=Math.min(l,Math.PI/1.5),h/=Math.cos(l/2)),Math.abs(h)>t&&(t=h),Math.abs(h)>1e3&&console.log(Math.abs(h),a,r,s,l),o.multiplyScalar(Math.abs(h)),this.positions[n]+=o.x,this.positions[n+1]+=o.y,this.positions[n+2]+=o.z}console.log("maxW",t)}this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new i.BufferAttribute(new Float32Array(this.positions),3),previous:new i.BufferAttribute(new Float32Array(this.previous),3),next:new i.BufferAttribute(new Float32Array(this.next),3),side:new i.BufferAttribute(new Float32Array(this.side),1),width:new i.BufferAttribute(new Float32Array(this.width),1),uv:new i.BufferAttribute(new Float32Array(this.uvs),2),index:new i.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new i.BufferAttribute(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()},n.prototype.advance=function(e){var t=this._attributes.position.array,i=this._attributes.previous.array,n=this._attributes.next.array,a=t.length;r(t,0,i,0,a),r(t,6,t,0,a-6),t[a-6]=e.x,t[a-5]=e.y,t[a-4]=e.z,t[a-3]=e.x,t[a-2]=e.y,t[a-1]=e.z,r(t,6,n,0,a-6),n[a-6]=e.x,n[a-5]=e.y,n[a-4]=e.z,n[a-3]=e.x,n[a-2]=e.y,n[a-1]=e.z,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0},i.ShaderChunk.meshline_vert=["",i.ShaderChunk.logdepthbuf_pars_vertex,i.ShaderChunk.fog_pars_vertex,"","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute float counters;","","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform vec3 colorPass;","uniform float opacity;","uniform float sizeAttenuation;","uniform bool faceUp;","uniform bool faceOut;","","varying vec2 vUV;","varying vec4 vColor;","varying vec4 vColorPass;","varying float vCounters;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","\t   vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","","    vColor = vec4( color, opacity );","    vColorPass = vec4( colorPass, opacity );","    vUV = uv;","    vec4 finalPosition;","    mat4 m = projectionMatrix * modelViewMatrix;","","    if (faceUp || faceOut) {","        vec4 positionP = vec4( position, 1.0 );","        finalPosition = m * positionP;","    } else {","        finalPosition = m * vec4( position, 1.0 );","        vec4 prevPos = m * vec4( previous, 1.0 );","        vec4 nextPos = m * vec4( next, 1.0 );","","        vec2 currentP = fix( finalPosition, aspect );","        vec2 prevP = fix( prevPos, aspect );","        vec2 nextP = fix( nextPos, aspect );","","        float w = lineWidth * width;","","        vec2 dir;","        if( nextP == currentP ) dir = normalize( currentP - prevP );","        else if( prevP == currentP ) dir = normalize( nextP - currentP );","        else {","            vec2 dir1 = normalize( currentP - prevP );","            vec2 dir2 = normalize( nextP - currentP );","            dir = normalize( dir1 + dir2 );","","            vec2 perp = vec2( -dir1.y, dir1.x );","            vec2 miter = vec2( -dir.y, dir.x );","            //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","        }","","        vec4 normal = vec4( -dir.y, dir.x, 0., 1. );","        normal.xy *= .5 * w;","        normal *= projectionMatrix;","        if( sizeAttenuation == 0. ) {","            normal.xy *= finalPosition.w;","            normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;","        }","        finalPosition.xy += normal.xy * side;","    }","    gl_Position = finalPosition;","",i.ShaderChunk.logdepthbuf_vertex,i.ShaderChunk.fog_vertex&&"    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",i.ShaderChunk.fog_vertex,"}"].join("\n"),i.ShaderChunk.meshline_frag=["",i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform sampler2D maskMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useMaskMap;","uniform float useDash;","uniform float dashArray;","uniform float dashOffset;","uniform float dashRatio;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","uniform vec2 offset;","uniform float pass;","uniform float passRange;","","uniform bool showOutline;","uniform float outlineWidth;","uniform vec3 outlineColor;","","varying vec2 vUV;","varying vec4 vColor;","varying vec4 vColorPass;","varying float vCounters;","","void main() {","",i.ShaderChunk.logdepthbuf_fragment,"","    vec4 c;","    if (vUV.x < pass - passRange) {","        c = vColorPass;","    } else if (vUV.x > pass + passRange){","        c = vColor;","    } else {","        c = mix(vColorPass, vColor, (vUV.x - (pass - passRange)) / (passRange * 2.0));","    }","    vec2 vUV2 = vUV + offset;","\n    if( showOutline ) {\n        if( vUV2.y > ( 1.0 - outlineWidth ) || vUV2.y < outlineWidth ) {\n            gl_FragColor = vec4( outlineColor, 1.0 );\n            return;\n        }\n    }\n    ","    if( useMap == 1. ) c *= texture2D( map, vUV2 * repeat );","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV2 * repeat ).a;","    if( useMaskMap == 1. ) {","        vec4 mask = texture2D( maskMap, vUV2 * repeat );","        c.a *= (( mask.r + mask.g + mask.b ) / 3.0 );","    }","    if( c.a < alphaTest ) discard;","    if( useDash == 1. ){","        c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));","    }","    gl_FragColor = c;","    gl_FragColor.a *= step(vCounters, visibility);","",i.ShaderChunk.fog_fragment,"}"].join("\n"),s.prototype=Object.create(i.ShaderMaterial.prototype),s.prototype.constructor=s,s.prototype.isMeshLineMaterial=!0,s.prototype.copy=function(e){return i.ShaderMaterial.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.maskMap=e.maskMap,this.useMaskMap=e.useMaskMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray.copy?this.dashArray.copy(e.dashArray):this.dashArray=e.dashArray,this.dashOffset.copy?this.dashOffset.copy(e.dashOffset):this.dashOffset=e.dashOffset,this.dashRatio.copy?this.dashRatio.copy(e.dashRatio):this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this.offset.copy(e.offset),this.colorPass.copy(e.colorPass),this.pass=e.pass,this.passRange=e.passRange,this.showOutline=e.showOutline,this.outlineWidth=e.outlineWidth,this.outlineColor=e.outlineColor,this},e.exports&&(t=e.exports={MeshLine:n,MeshLineMaterial:s,MeshLineRaycast:a}),t.MeshLine=n,t.MeshLineMaterial=s,t.MeshLineRaycast=a}).call(Bg)})),cb={defines:{DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{time:{value:0},speed:{value:1},color:{value:new Qt(1,1,1)},brightness:{value:1},width:{value:1},height:{value:1}},vertexShader:["precision highp float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float time;","uniform float speed;","uniform float width;","uniform float height;","attribute vec3 position;","attribute vec2 uv;","attribute vec3 translate;","varying vec2 vUv;","varying float vScale;","void main() {","vec4 pos=vec4(translate, 1.0 );","pos.y+=position.y*height;","vec4 mvPosition =  modelViewMatrix * pos;","vec3 trTime = vec3(translate.x - time,translate.y - time,translate.z - time);","float scale =  (trTime.x+trTime.y+trTime.z)*0.33*speed;","vScale = scale;","mvPosition.xyz += vec3(position.x*width,0,position.z*width);//* scale","vUv = uv;","gl_Position = projectionMatrix *mvPosition;","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","uniform float brightness;","uniform float opacity;","varying vec2 vUv;","varying float vScale;","vec3 HUEtoRGB(float H){","H = mod(H,1.0);","float R = abs(H * 6.0 - 3.0) - 1.0;","float G = 2.0 - abs(H * 6.0 - 2.0);","float B = 2.0 - abs(H * 6.0 - 4.0);","return clamp(vec3(R,G,B),0.0,1.0);","}","vec3 HSLtoRGB(vec3 HSL){","vec3 RGB = HUEtoRGB(HSL.x);","float C = (1.0 - abs(2.0 * HSL.z - 1.0)) * HSL.y;","return (RGB - 0.5) * C + HSL.z;","}","void main() {","vec2 uv=vUv;","//uv.y+=vScale;","uv.y=uv.y+mod(vScale,20.0)*0.1-1.0;","vec4 diffuseColor = texture2D( map, uv );","float alpha=diffuseColor.w;","if(uv.y>=1.0||uv.y<=0.0){","alpha=0.0;","}","gl_FragColor = vec4( diffuseColor.xyz * color *brightness , alpha*opacity );","}"].join("\n")};const hb={uniforms:{tDiffuse:{type:"t",value:null},width:{type:"f",value:0},height:{type:"f",value:0},kernel:{type:"fv1",value:[-1,-1,-1,-1,9,-1,-1,-1,-1]},intensity:{type:"f",value:.1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform float width;","uniform float height;","uniform float kernel[9];","uniform float intensity;","void main(void)","{","float step_w = intensity/width;","float step_h = intensity/height;","vec2 offset[9];","offset[0] = vec2(-step_w, -step_h);","offset[1] = vec2(0.0, -step_h);","offset[2] = vec2(step_w, -step_h);","offset[3] = vec2(-step_w, 0.0);","offset[4] = vec2(0.0, 0.0);","offset[5] = vec2(step_w, 0.0);","offset[6] = vec2(-step_w, step_h);","offset[7] = vec2(0.0, step_h);","offset[8] = vec2(step_w, step_h);","vec3 sum = vec3(0.0);","for( int i=0; i<9; i++ )","sum += texture2D(tDiffuse, vUv + offset[i]).rgb * kernel[i];","gl_FragColor = vec4(sum,1.0);","}"].join("\n")};class ub extends ed{constructor(e,{blendFunction:t=Qu.NORMAL,normalBuffer:i=null,depthBuffer:n=null,selects:a=null,width:r=ju.AUTO_SIZE,height:s=ju.AUTO_SIZE,scene:o,opacity:l=.5,groundReflector:c}={}){super("SSREffect","\nvarying vec2 vUv;\n\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform sampler2D tNormal;\nuniform sampler2D tMetalness;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float maxDistance;\nuniform float thickness;\nuniform float opacity;\nuniform float resolutionScale;\n\nfloat pointToLineDistance(vec3 x0, vec3 x1, vec3 x2) {\n  return length(cross(x0 - x1, x0 - x2)) / length(x2 - x1);\n}\n\nfloat pointPlaneDistance(vec3 point, vec3 planePoint, vec3 planeNormal) {\n  float a = planeNormal.x, b = planeNormal.y, c = planeNormal.z;\n  float x0 = point.x, y0 = point.y, z0 = point.z;\n  float x = planePoint.x, y = planePoint.y, z = planePoint.z;\n  float d = -(a * x + b * y + c * z);\n  float distance = (a * x0 + b * y0 + c * z0 + d) / sqrt(a * a + b * b + c * c);\n  return distance;\n}\n\nfloat getDepth(vec2 uv) {\n  return unpackRGBAToDepth(texture2D(tDepth, uv));\n}\n\nfloat getViewZ(const in float depth){\n  return perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n}\n\nvec3 getViewPosition(const in vec2 uv, const in float depth, const in float clipW){\n  vec4 clipPosition = vec4((vec3(uv,depth) - .5) * 2., 1.);\n  clipPosition *= clipW;\n  return (cameraInverseProjectionMatrix * clipPosition).xyz;\n}\n\nvec3 getViewNormal(const in vec2 uv){\n    return unpackRGBToNormal(texture2D(tNormal, uv).xyz);\n}\n\nvec2 viewPositionToXY(vec3 viewPosition){\n    vec2 xy;\n    vec4 clip = cameraProjectionMatrix * vec4(viewPosition, 1);\n    xy = clip.xy;\n    float clipW = clip.w;\n    xy /= clipW;\n    xy = (xy + 1.) / 2.;\n    xy *= resolution;\n    return xy;\n}\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, const in float depth, out vec4 outputColor) {\n\n  // outputColor = texture2D(tMetalness, uv);\n  // return;\n\n  vec4 normalValue = vec4(unpackRGBToNormal(texture2D(tNormal, uv).xyz), 1.0);\n  float snowRatio = normalValue.g - normalValue.r - normalValue.b;\n  if (snowRatio < 0.0) {\n    snowRatio = 0.0;\n  }\n  // normalValue = cameraInverseProjectionMatrix * normalValue;\n  // outputColor = normalValue;\n  // return;\n\n  float metalness = texture2D(tMetalness, uv).r;\n  if (metalness == 0.) {\n    outputColor = inputColor;\n    return;\n  }\n\n  vec4 reflectColor;\n  float depthValue = getDepth(uv);\n  float viewZ = getViewZ(depthValue);\n\n    if(-viewZ >= cameraFar) {\n    outputColor = inputColor;\n    return;\n  }\n\n  float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n  vec3 viewPosition = getViewPosition(vUv, depthValue, clipW);\n\n  vec2 d0 = gl_FragCoord.xy;\n  vec2 d1;\n\n  vec3 viewNormal = getViewNormal(vUv);\n\n#ifdef PERSPECTIVE_CAMERA\n  vec3 viewIncidentDir = normalize(viewPosition);\n  vec3 viewReflectDir = reflect(viewIncidentDir, viewNormal);\n#else\n  vec3 viewIncidentDir = vec3(0, 0, -1);\n  vec3 viewReflectDir = reflect(viewIncidentDir, viewNormal);\n#endif\n\n  float maxReflectRayLen = maxDistance / dot(-viewIncidentDir, viewNormal);\n\n  vec3 d1viewPosition = viewPosition + viewReflectDir * maxReflectRayLen;\n\n#ifdef PERSPECTIVE_CAMERA\n  if(d1viewPosition.z > -cameraNear){\n    float t = (-cameraNear-viewPosition.z) / viewReflectDir.z;\n    d1viewPosition = viewPosition + viewReflectDir * t;\n  }\n#endif\n\n  d1 = viewPositionToXY(d1viewPosition);\n\n  float totalLen = length(d1 - d0);\n  float xLen = d1.x - d0.x;\n  float yLen = d1.y - d0.y;\n  float totalStep = max(abs(xLen), abs(yLen));\n  float xSpan = xLen / totalStep;\n  float ySpan = yLen / totalStep;\n\n  for(float i = 0.0; i < float(768); i++){\n    if(i >= totalStep) {\n      break;\n    }\n    vec2 xy = vec2(d0.x + i * xSpan, d0.y + i * ySpan);\n    if(xy.x < 0. || xy.x > resolution.x || xy.y < 0. || xy.y > resolution.y) {\n      break;\n    }\n    float s = length(xy - d0) / totalLen;\n    vec2 uv = xy / resolution;\n    float d = getDepth(uv);\n    float vZ = getViewZ(d);\n    if(-vZ >= cameraFar) {\n      continue;\n    }\n    float cW = cameraProjectionMatrix[2][3] * vZ + cameraProjectionMatrix[3][3];\n    vec3 vP = getViewPosition(uv, d, cW);\n\n#ifdef PERSPECTIVE_CAMERA\n    float recipVPZ = 1. / viewPosition.z;\n    float viewReflectRayZ = 1. / (recipVPZ + s * (1. / d1viewPosition.z - recipVPZ));\n#else\n    float viewReflectRayZ = viewPosition.z + s * (d1viewPosition.z - viewPosition.z);\n#endif\n\n    if(viewReflectRayZ <= vZ) {\n\n      bool hit;\n\n      float away=pointToLineDistance(vP, viewPosition, d1viewPosition);\n\n      float minThickness;\n      vec2 xyNeighbor = xy;\n      xyNeighbor.x += 1.;\n      vec2 uvNeighbor = xyNeighbor / resolution;\n      vec3 vPNeighbor = getViewPosition(uvNeighbor, d, cW);\n      minThickness = vPNeighbor.x - vP.x;\n      minThickness *= 3.;\n      float tk = max(minThickness, thickness);\n\n      hit = away <= tk;\n\n      if(hit) {\n        vec3 vN = getViewNormal(uv);\n\n        if(dot(viewReflectDir,vN) >= 0.) {\n          continue;\n        }\n\n        float distance = pointPlaneDistance(vP, viewPosition, viewNormal);\n\n        if(distance > maxDistance) {\n          break;\n        }\n\n        float op = opacity;\n\n\n        float ratio = 1.0 - (distance / maxDistance);\n        float attenuation = ratio * ratio;\n        op = opacity * attenuation;\n\n\n\n        float fresnelCoe = (dot(viewIncidentDir, viewReflectDir) + 1.) / 2.;\n\t\t\t\top *= fresnelCoe;\n\n        reflectColor = texture2D(tDiffuse, uv);\n        reflectColor.a = op;\n        break;\n      }\n    }\n  }\n\n  outputColor = mix(inputColor, reflectColor, reflectColor.a);\n  // outputColor = mix(outputColor, vec4(1.0, 1.0, 1.0, 1.0), snowRatio);\n\n}\n",{blendFunction:t,attributes:td.DEPTH,uniforms:new Map([["tDiffuse",new jc(null)],["tNormal",new jc(i)],["tDepth",new jc(n)],["tMetalness",new jc(null)],["cameraNear",new jc(e.near)],["cameraFar",new jc(e.far)],["cameraProjectionMatrix",new jc(e.projectionMatrix)],["cameraInverseProjectionMatrix",new jc(e.projectionMatrixInverse)],["maxDistance",new jc(10)],["thickness",new jc(.1)],["opacity",new jc(l)],["resolutionScale",new jc(1)]]),vertexShader:"\nvarying vec2 vUv;\n\nvoid mainSupport(const in vec2 uv) {\n\n  vUv = uv;\n\n}\n"}),this.groundReflector=c,this.scene3D=o,this._selects=a,this.selective=Array.isArray(this._selects),Object.defineProperty(this,"selects",{get(){return this._selects},set(e){this._selects!==e&&(this._selects=e,Array.isArray(e)?(this.selective=!0,this.defines.SELECTIVE=!0,this.needsUpdate=!0):(this.selective=!1,this.defines.SELECTIVE=!1,this.needsUpdate=!0))}}),this.camera=e,this.originalClearColor=new Qt,this.metalnessOnMaterial=new Kt({color:"white"}),this.metalnessOnInstancedMaterial=new Kt({color:"white"}),this.metalnessOffMaterial=new Kt({color:"black"}),this.metalnessOffInstancedMaterial=new Kt({color:"black"}),this.metalnessRenderTarget=new Te(r,s,{minFilter:g,magFilter:g,format:I}),this.uniforms.get("tMetalness").value=this.metalnessRenderTarget.texture}update(e,t,i){this.uniforms.get("tDiffuse").value=t.texture,this.selective&&this.renderMetalness(e,this.metalnessOnMaterial,this.metalnessRenderTarget,0,0)}initialize(e,t,i){}renderMetalness(e,t,i,n,a){e.getClearColor(this.originalClearColor);const r=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(i),e.autoClear=!1,n=t.clearColor||n,a=t.clearAlpha||a,null!=n&&(e.setClearColor(n),e.setClearAlpha(a||0),e.clear()),this.scene3D.traverseVisible((e=>{if(e.isMesh)if(e.material instanceof Array?(e._SSRPassBackupMaterial=[],e._SSRPassBackupMaterial.push(...e.material)):e._SSRPassBackupMaterial=e.material,this._selects.includes(e))if(e.material instanceof Array)for(let t in e.material)e.material[t].disableSSR?e.material[t]=e instanceof Qr?this.metalnessOffInstancedMaterial:this.metalnessOffMaterial:e.material[t]=e instanceof Qr?this.metalnessOnInstancedMaterial:this.metalnessOnMaterial;else e.material.disableSSR?e.material=e instanceof Qr?this.metalnessOffInstancedMaterial:this.metalnessOffMaterial:e.material=e instanceof Qr?this.metalnessOnInstancedMaterial:this.metalnessOnMaterial;else e.material=e instanceof Qr?this.metalnessOffInstancedMaterial:this.metalnessOffMaterial})),e.render(this.scene3D,this.camera),this.scene3D.traverseVisible((e=>{e.isMesh&&(e._SSRPassBackupMaterial instanceof Array?(e.material=[],e.material.push(...e._SSRPassBackupMaterial)):e.material=e._SSRPassBackupMaterial)})),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(r)}}class db extends Fi{constructor(e,t={}){super(e);const i=this,n=void 0!==t.textureWidth?t.textureWidth:512,a=void 0!==t.textureHeight?t.textureHeight:512,r=void 0!==t.clipBias?t.clipBias:0,s=void 0!==t.alpha?t.alpha:1,o=void 0!==t.time?t.time:0,l=void 0!==t.waterNormals?t.waterNormals:null,c=void 0!==t.sunDirection?t.sunDirection:new Ce(.70707,.70707,0),h=new Qt(void 0!==t.sunColor?t.sunColor:16777215),u=new Qt(void 0!==t.waterColor?t.waterColor:8355711),d=void 0!==t.eye?t.eye:new Ce(0,0,0),p=void 0!==t.distortionScale?t.distortionScale:20,m=void 0!==t.side?t.side:0,f=void 0!==t.fog&&t.fog;var g=void 0!==t.reflectionRate?t.reflectionRate:.9,y=void 0!==t.yUp&&t.yUp;i.reflectionAutoUpdate=void 0===t.reflectionAutoUpdate||t.reflectionAutoUpdate;const v=new Rt,_=new Ce,x=new Ce,w=new Ce,S=new it,M=new Ce(0,0,-1),T=new Me,A=new Ce,E=new Ce,I=new Me,P=new it,R=new Zi,O=new Te(n,a,{minFilter:b,magFilter:b,format:C});ge.isPowerOfTwo(n)&&ge.isPowerOfTwo(a)||(O.texture.generateMipmaps=!1);const D={uniforms:Wi.merge([ln.fog,ln.lights,{normalSampler:{value:null},mirrorSampler:{value:null},alpha:{value:1},time:{value:0},size:{value:1},distortionScale:{value:20},textureMatrix:{value:new it},sunColor:{value:new Qt(8355711)},sunDirection:{value:new Ce(.70707,.70707,0)},eye:{value:new Ce},waterColor:{value:new Qt(5592405)},reflectionRate:{value:.9}}]),vertexShader:"\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\tuniform float time;\n\n\t\t\t\tvarying vec4 mirrorCoord;\n\t\t\t\tvarying vec4 worldPosition;\n\n\t\t\t\t#include <common>\n\t\t\t\t#include <fog_pars_vertex>\n\t\t\t\t#include <shadowmap_pars_vertex>\n\t\t\t\t#include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tmirrorCoord = modelMatrix * vec4( position, 1.0 );\n\t\t\t\t\tworldPosition = mirrorCoord.xyzw;\n\t\t\t\t\tmirrorCoord = textureMatrix * mirrorCoord;\n\t\t\t\t\tvec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tgl_Position = projectionMatrix * mvPosition;\n\n        #include <clipping_planes_vertex>\n\t\t\t\t#include <beginnormal_vertex>\n\t\t\t\t#include <defaultnormal_vertex>\n\t\t\t\t#include <logdepthbuf_vertex>\n\t\t\t\t#include <fog_vertex>\n\t\t\t\t#include <shadowmap_vertex>\n\t\t\t}",fragmentShader:"\n\t\t\t\tuniform sampler2D mirrorSampler;\n\t\t\t\tuniform float alpha;\n\t\t\t\tuniform float time;\n\t\t\t\tuniform float size;\n        uniform float distortionScale;\n        uniform float reflectionRate;\n\t\t\t\tuniform sampler2D normalSampler;\n\t\t\t\tuniform vec3 sunColor;\n\t\t\t\tuniform vec3 sunDirection;\n\t\t\t\tuniform vec3 eye;\n\t\t\t\tuniform vec3 waterColor;\n\n\t\t\t\tvarying vec4 mirrorCoord;\n\t\t\t\tvarying vec4 worldPosition;\n\n\t\t\t\tvec4 getNoise( vec2 uv ) {\n\t\t\t\t\tvec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);\n\t\t\t\t\tvec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );\n\t\t\t\t\tvec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );\n\t\t\t\t\tvec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );\n\t\t\t\t\tvec4 noise = texture2D( normalSampler, uv0 ) +\n\t\t\t\t\t\ttexture2D( normalSampler, uv1 ) +\n\t\t\t\t\t\ttexture2D( normalSampler, uv2 ) +\n\t\t\t\t\t\ttexture2D( normalSampler, uv3 );\n\t\t\t\t\treturn noise * 0.5 - 1.0;\n\t\t\t\t}\n\n\t\t\t\tvoid sunLight( const vec3 surfaceNormal, const vec3 eyeDirection, float shiny, float spec, float diffuse, inout vec3 diffuseColor, inout vec3 specularColor ) {\n\t\t\t\t\tvec3 reflection = normalize( reflect( -sunDirection, surfaceNormal ) );\n\t\t\t\t\tfloat direction = max( 0.0, dot( eyeDirection, reflection ) );\n\t\t\t\t\tspecularColor += pow( direction, shiny ) * sunColor * spec;\n\t\t\t\t\tdiffuseColor += max( dot( sunDirection, surfaceNormal ), 0.0 ) * sunColor * diffuse;\n\t\t\t\t}\n\n\t\t\t\t#include <common>\n\t\t\t\t#include <packing>\n\t\t\t\t#include <bsdfs>\n\t\t\t\t#include <fog_pars_fragment>\n\t\t\t\t#include <logdepthbuf_pars_fragment>\n\t\t\t\t#include <lights_pars_begin>\n\t\t\t\t#include <shadowmap_pars_fragment>\n        #include <shadowmask_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n\n\t\t\t\tvoid main() {\n\n          #include <clipping_planes_fragment>\n\n\t\t\t\t\t#include <logdepthbuf_fragment>\n\t\t\t\t\tvec4 noise = getNoise( worldPosition.xz * size );\n\t\t\t\t\tvec3 surfaceNormal = normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) );\n\n\t\t\t\t\tvec3 diffuseLight = vec3(0.0);\n\t\t\t\t\tvec3 specularLight = vec3(0.0);\n\n\t\t\t\t\tvec3 worldToEye = eye-worldPosition.xyz;\n\t\t\t\t\tvec3 eyeDirection = normalize( worldToEye );\n\t\t\t\t\tsunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );\n\n\t\t\t\t\tfloat distance = length(worldToEye);\n\n\t\t\t\t\tvec2 distortion = surfaceNormal.xz * ( 0.001 + 1.0 / distance ) * distortionScale;\n\t\t\t\t\tvec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );\n\n\t\t\t\t\tfloat theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );\n\t\t\t\t\tfloat rf0 = 0.3;\n\t\t\t\t\tfloat reflectance = rf0 + ( 1.0 - rf0 ) * pow( ( 1.0 - theta ), 5.0 );\n\t\t\t\t\tvec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;\n\t\t\t\t\tvec3 albedo = mix( ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(), ( vec3( 0.1 ) + reflectionSample * 0.9 * reflectionRate + reflectionSample * specularLight ), reflectance);\n\t\t\t\t\tvec3 outgoingLight = albedo;\n\t\t\t\t\tgl_FragColor = vec4( outgoingLight, alpha );\n\n\t\t\t\t\t#include <tonemapping_fragment>\n\t\t\t\t\t#include <fog_fragment>\n\t\t\t\t}"},L=new Yi({fragmentShader:D.fragmentShader,vertexShader:D.vertexShader,uniforms:Wi.clone(D.uniforms),lights:!0,side:m,fog:f});L.clipping=!0,L.uniforms.mirrorSampler.value=O.texture,L.uniforms.textureMatrix.value=P,L.uniforms.alpha.value=s,L.uniforms.time.value=o,L.uniforms.normalSampler.value=l,L.uniforms.sunColor.value=h,L.uniforms.waterColor.value=u,L.uniforms.sunDirection.value=c,L.uniforms.distortionScale.value=p,L.uniforms.reflectionRate.value=g,L.uniforms.eye.value=d,i.material=L,i.getRenderTarget=function(){return O},i.onBeforeRender=function(e,t,n){if(i.paused)return;if(x.setFromMatrixPosition(i.matrixWorld),w.setFromMatrixPosition(n.matrixWorld),S.extractRotation(i.matrixWorld),_.set(0,y?1:0,y?0:1),_.applyMatrix4(S),A.subVectors(x,w),A.dot(_)>0)return;A.reflect(_).negate(),A.add(x),S.extractRotation(n.matrixWorld),M.set(0,0,-1),M.applyMatrix4(S),M.add(w),E.subVectors(x,M),E.reflect(_).negate(),E.add(x),R.position.copy(A),R.up.set(0,1,0),R.up.applyMatrix4(S),R.up.reflect(_),R.lookAt(E),R.far=n.far,R.updateMatrixWorld(),R.projectionMatrix.copy(n.projectionMatrix),P.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),P.multiply(R.projectionMatrix),P.multiply(R.matrixWorldInverse),v.setFromNormalAndCoplanarPoint(_,x),v.applyMatrix4(R.matrixWorldInverse),T.set(v.normal.x,v.normal.y,v.normal.z,v.constant);const a=R.projectionMatrix;if(I.x=(Math.sign(T.x)+a.elements[8])/a.elements[0],I.y=(Math.sign(T.y)+a.elements[9])/a.elements[5],I.z=-1,I.w=(1+a.elements[10])/a.elements[14],T.multiplyScalar(2/T.dot(I)),a.elements[2]=T.x,a.elements[6]=T.y,a.elements[10]=T.z+1-r,a.elements[14]=T.w,d.setFromMatrixPosition(n.matrixWorld),i.reflectionAutoUpdate||i.needsUpdate){const n=e.getRenderTarget(),a=e.xr.enabled,r=e.shadowMap.autoUpdate;i.visible=!1;var s=null;for(let e=0;e<Ep.scene.children.length;e++)"__objects"===Ep.scene.children[e].name&&(s=Ep.scene.children[e].visible,Ep.scene.children[e].visible=!1);_y.iconVisible(Ep.defaultObjectTree.children,!1),e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,O.texture.encoding=n?n.texture.encoding:e.outputEncoding,e.setRenderTarget(O),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,R),i.needsUpdate=void 0,i.visible=!0;for(let e=0;e<Ep.scene.children.length;e++)"__objects"===Ep.scene.children[e].name&&(Ep.scene.children[e].visible=s);_y.iconVisible(Ep.defaultObjectTree.children,!0),e.xr.enabled=a,e.shadowMap.autoUpdate=r,e.setRenderTarget(n)}const o=n.viewport;void 0!==o&&e.state.viewport(o)}}}db.prototype.isWater=!0;class pb extends ed{constructor(e={}){const t=Object.assign({blendFunction:Qu.NORMAL,map:null},e);super("WatermarkEffect","\n#ifdef TEXTURE_PRECISION_HIGH\n\n\tuniform mediump sampler2D map;\n\n#else\n\n\tuniform lowp sampler2D map;\n\n#endif\n\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){\n  vec4 texel = texture2D(map, uv);\n  outputColor = mix(inputColor, texel, texel.a);\n}",{blendFunction:t.blendFunction,uniforms:new Map([["map",new jc(t.map)]])})}setMap(e){this.uniforms.get("map").value=e}}class mb extends gy{constructor(e){super("IconModelTrailMovingController"),this.name=e.name,this.mesh,this.passingPoints,this.geometry,this.createMesh=()=>{const e=_y.url(Ep.instance.resourceBasePath,"texture/trail/trail.png"),t=Ep.loaders.textureLoader.load(e);t.wrapS=m,t.wrapT=m,t.repeat.set(1,1);const i=new lb.MeshLineMaterial({fog:Uy,map:t,useMap:!0,color:new Qt("#ff0000"),opacity:1,resolution:new ye(window.innerWidth,window.innerHeight),sizeAttenuation:0,lineWidth:0,depthWrite:Ep.drawableDepthTest,depthTest:!0,alphaTest:0,transparent:!0,side:2,repeat:new ye(1,1),dashArray:0,dashOffset:1,dashRatio:0});this.geometry=new Ov.MeshLine,this.mesh=new Fi(this.geometry,i),this.mesh.name=this.name,this.mesh.onBeforeRender=function(){this.userData.inView=!0},Ep.objectStore.add(this.name,this.mesh)},this.createMesh(),this.set=e=>{this.modelItem=e.modelItem,this.modelObject=e.modelObject,this.passingPoints||(this.passingPoints=[{x:this.modelObject.position.x,y:this.modelObject.position.y,z:this.modelObject.position.z,elapsedTime:0}]),this.iconObject=e.iconObject,this.mesh.material.lineWidth=e.trackWidth*Ep.worldScale,this.mesh.renderOrder=this.modelObject.renderOrder,this.startPosition=this.modelObject.position.clone(),this.endPosition=e.position,this.elapsed=0,this.duration=e.duration,this.isAutoRotation=e.isAutoRotation,this.trackStyle=e.trackStyle,this.trackDuration=e.trackDuration},this.set(e),this.render=e=>{for(let t=this.passingPoints.length-1;t>=0;t--){const i=this.passingPoints[t];i.elapsedTime>=this.trackDuration?this.passingPoints.splice(t,1):i.elapsedTime+=e}if(this.elapsed<=this.duration){this.elapsed+=e;const t=this.elapsed/this.duration,i=(this.endPosition.x-this.startPosition.x)*t+this.startPosition.x,n=(this.endPosition.y-this.startPosition.y)*t+this.startPosition.y,a=(this.endPosition.z-this.startPosition.z)*t+this.startPosition.z;this.modelObject.position.x=i,this.modelObject.position.y=n,this.modelObject.position.z=a,this.passingPoints.push({x:this.modelObject.position.x,y:this.modelObject.position.y,z:this.modelObject.position.z,elapsedTime:0}),Ep.instance.updateIconModelInterval(this.modelItem)}const t=[];for(const e of this.passingPoints)t.push(e.x,e.y,e.z);this.geometry.setPoints(t)},this.dispose=()=>{Ep.objectStore.remove(this.name)}}}mb.type="IconModelTrailMovingController";class fb extends gy{constructor(e){super("DirectionalLightSmoothMovementController"),this.light=e,this.name=e.uuid,this.endAngle=0,this.duration=0,this.alwaysForward=!1,this.radius=(new ye).copy(this.light.position).length(),this.startAngle=(new ye).copy(this.light.position).angle()/Math.PI*180,this.angleUnit=0,this.elapsedTime=0}render(e){let t;this.elapsedTime+=e,this.elapsedTime>this.duration&&(this.elapsedTime=this.duration),this.alwaysForward?(t=this.startAngle+this.elapsedTime*this.angleUnit,t=t/180*Math.PI,t>=Math.PI&&(this.alwaysForward=!1,this.startAngle=0,this.duration-=this.elapsedTime,this.elapsedTime=0)):(t=this.elapsedTime*this.angleUnit+this.startAngle,t=t/180*Math.PI),this.light.position.x=this.radius*Math.cos(t),this.light.position.y=this.radius*Math.sin(t),this.light.getDirectionalLightHelper().update(),this.elapsedTime>=this.duration&&Ep.animationStore.remove(this)}set({angle:e,duration:t,alwaysForward:i}){if(0===t)return this.light.position.x=this.radius*Math.cos(e),this.light.position.y=this.radius*Math.sin(e),this.light.getDirectionalLightHelper().update(),void Ep.animationStore.remove(this);this.endAngle=e,this.startAngle=(new ye).copy(this.light.position).angle()/Math.PI*180,this.duration=t,this.alwaysForward=i,this.endAngle>this.startAngle&&(this.alwaysForward=!1),this.alwaysForward?this.angleUnit=(180-this.startAngle+this.endAngle)/this.duration:this.angleUnit=(this.endAngle-this.startAngle)/this.duration}}fb.type="DirectionalLightSmoothMovementController";class gb extends gy{constructor(e){super("InstancedIconModelController");const t=(new it).multiplyScalar(0);this.camera=e,this.endEvent=void 0,this.changed=!0,this.isShow=!0,this.currentPosition=new Ce,this.currentRotation=new Ee,this.currentScale=new Ce,this.bindData=e=>{this.data=e,this.iconModel=e.iconModel,this.modelObject=this.iconModel.modelObject,this.name=e.id,this.meshes=this.iconModel.meshes,this.index=e.index,this.matrix=e.matrix,this.articulations=JSON.parse(JSON.stringify(this.iconModel.articulations)),this.animations=JSON.parse(JSON.stringify(this.iconModel.animations)),this.matrices=[];for(const e of this.meshes)this.matrices.push(e.userData.matrixWorld.clone());this.changed=!0},this.getCurrentShowState=()=>{if(!this.data.visible)return!1;const e=this.camera.position.clone(),t=new Ce;t.setFromMatrixPosition(this.matrix);const i=t.distanceTo(e);return i>=this.data.minDistance&&i<=this.data.maxDistance},this.toggle=e=>{let i=!1;if(e&&this.meshes!==this.iconModel.toggleMeshes){for(const e of this.meshes)e.setMatrixAt(this.data.index,t),e.instanceMatrix.needsUpdate=!0;this.meshes=this.iconModel.toggleMeshes,i=!0}else if(!e&&this.meshes!==this.iconModel.meshes){for(const e of this.meshes)e.setMatrixAt(this.data.index,t),e.instanceMatrix.needsUpdate=!0;this.meshes=this.iconModel.meshes,i=!0}if(i){const e=this.meshes.length;for(let t=0;t<e;t++)this.meshes[t].setMatrixAt(this.data.index,this.matrices[t]),this.meshes[t].instanceMatrix.needsUpdate=!0;this.changed=!0}},this.updateIconPosition=()=>{const e=this.data.box.clone().applyMatrix4(this.matrix);if(this.data.icon){const t=(new Ce).copy(this.iconModel.interval),i=t.length(),n=(new ve).setFromMatrix4(this.matrix);t.applyMatrix3(n).setLength(i);const a=t.clone();this.iconModel.interval.isIn&&a.negate();const r=e.getCenter(new Ce),s=new tt(r.clone(),a.clone().normalize()),o=new Ce;s.intersectBox(e,o),this.data.icon.position.copy(o.add(t))}this.data.boxHelper&&this.data.boxHelper.box.copy(e)},this.updateMatrices=e=>{let t=!1;for(const i of this.animations)if("playing"===i.state){switch(i.elapsedTime+=e*i.speed*i.direction,i.loopType){case"none":i.elapsedTime>i.duration&&(i.elapsedTime=i.duration,i.state="stopped",this.endEvent&&this.endEvent({id:this.data.name}));break;case"round":if(i.elapsedTime>i.duration){i.elapsedTime=0;for(const e of i.items)e.state="playing"}break;case"repeat":if(i.elapsedTime<0||i.elapsedTime>i.duration){i.direction*=-1,i.elapsedTime+=e*i.speed*i.direction;for(const e of i.items)e.state="playing"}}for(const e of i.items){if("playing"!==e.state)continue;if(i.elapsedTime<e.startTime||i.elapsedTime>e.startTime+e.duration)continue;let n=1;0===e.duration?e.state="stopped":n=(i.elapsedTime-e.startTime)/e.duration;const a=this.articulations.find((t=>t.name===e.articulationName)),r=((e.endState-e.startState)*n+e.startState-a.minState)/(a.maxState-a.minState);for(const e of a.properties)this.modelObject.traverse((i=>{if(i.name!==e.nodeName)return;const n=(e.maxValue-e.minValue)*r+e.minValue;t=!0,"translationX"===e.type&&(i.position.x=n),"translationY"===e.type&&(i.position.y=n),"translationZ"===e.type&&(i.position.z=n),"rotationX"===e.type&&(i.rotation.x=n/180*Math.PI),"rotationY"===e.type&&(i.rotation.y=n/180*Math.PI),"rotationZ"===e.type&&(i.rotation.z=n/180*Math.PI),"scaleX"===e.type&&(i.scale.x=n),"scaleY"===e.type&&(i.scale.y=n),"scaleZ"===e.type&&(i.scale.z=n)}))}}for(const i of this.articulations){if("playing"!==i.state)continue;i.elapsedTime+=e,i.elapsedTime>i.duration&&(i.elapsedTime=i.duration,i.state="stopped");const n=i.elapsedTime/i.duration,a=((i.value-i.minState)*n-i.minState)/(i.maxState-i.minState);for(const e of i.properties)this.modelObject.traverse((i=>{if(i.name!==e.nodeName)return;const n=(e.maxValue-e.minValue)*a+e.minValue;t=!0,"translationX"===e.type&&(i.position.x=n),"translationY"===e.type&&(i.position.y=n),"translationZ"===e.type&&(i.position.z=n),"rotationX"===e.type&&(i.rotation.x=n/180*Math.PI),"rotationY"===e.type&&(i.rotation.y=n/180*Math.PI),"rotationZ"===e.type&&(i.rotation.z=n/180*Math.PI),"scaleX"===e.type&&(i.scale.x=n),"scaleY"===e.type&&(i.scale.y=n),"scaleZ"===e.type&&(i.scale.z=n)}))}t&&(this.modelObject.updateMatrixWorld(),this.modelObject.traverse((e=>{e.isMesh&&(this.matrices[e.userData.instancedMeshIndex]=e.matrixWorld.clone())})),this.data.box.makeEmpty(),this.data.box.expandByObject(this.modelObject),this.changed=!0)},this.setAnimationState=(e,t)=>{const i=this.animations.find((t=>t.name===e.animationName));if(i){switch(e.state){case"begin":if("stopped"===i.state){i.elapsedTime=0;for(const e of this.animations)for(const t of e.items)t.state="playing";e.startEvent&&e.startEvent({id:e.id})}i.state="playing",this.endEvent=e.endEvent;break;case"pause":if("playing"!==i.state)return void(t&&t({result:0,message:"未播放"}));i.state="paused";break;case"stop":if("stopped"===i.state)return void(t&&t({result:0,message:"未播放"}));i.elapsedTime=0,i.state="stopped",e.endEvent&&e.endEvent({id:e.id});break;case"restart":"playing"!==i.state&&"paused"!==i.state||e.endEvent&&e.endEvent({id:e.id}),i.state="playing",i.elapsedTime=0;for(const e of this.animations)for(const t of e.items)t.state="playing";e.startEvent&&e.startEvent({id:e.id}),this.endEvent=e.endEvent}t&&t({result:1,message:"成功。"})}else t&&t({result:0,message:"找不到"})},this.setArticulationState=(e,t)=>{const{data:i=[],duration:n=0}=e;for(const e of i){const t=this.articulations.find((t=>t.name===e.articulation));t&&(t.state="playing",t.elapsedTime=0,t.duration=n,t.value=e.value)}t&&t({result:1,message:"成功。"})},this.setTrail=(e,t)=>{this.matrix.decompose(this.currentPosition,this.currentRotation,this.currentScale),this.passingPoints||(this.passingPoints=[{x:this.currentPosition.x,y:this.currentPosition.y,z:this.currentPosition.z,elapsedTime:0}]),this.geometry=this.data.trail.geometry,this.startPosition=this.currentPosition.clone(),this.endPosition=e.position,this.trailElapsed=0,this.trailDuration=e.duration,this.trailLife=e.trackDuration,this.isAutoRotation=e.isAutoRotation,t&&t({result:1,message:"成功。"})},this.updateTrail=e=>{if(!this.passingPoints)return;for(let t=this.passingPoints.length-1;t>=0;t--){const i=this.passingPoints[t];i.elapsedTime>=this.trailLife?this.passingPoints.splice(t,1):i.elapsedTime+=e}if(this.trailElapsed<this.trailDuration){this.trailElapsed+=e,this.trailElapsed>this.trailDuration&&(this.trailElapsed=this.trailDuration);const t=this.trailElapsed/this.trailDuration;this.currentPosition.copy(this.endPosition),this.currentPosition.sub(this.startPosition),this.currentPosition.multiplyScalar(t),this.currentPosition.add(this.startPosition),this.passingPoints.push({x:this.currentPosition.x,y:this.currentPosition.y,z:this.currentPosition.z,elapsedTime:0}),this.matrix.compose(this.currentPosition,this.currentRotation,this.currentScale),this.data.parameters.position.x=this.currentPosition.x,this.data.parameters.position.y=this.currentPosition.y,this.data.parameters.position.z=this.currentPosition.z,this.changed=!0}let t=!1;if(this.passingPoints.length>0?(this.forceUpdate=!0,t=!0):this.forceUpdate&&(this.forceUpdate=!1,t=!0),t){const e=[];for(const t of this.passingPoints)e.push(t.x,t.y,t.z);this.geometry.setPoints(e)}},this.render=e=>{this.updateTrail(e),this.updateMatrices(e);const i=this.getCurrentShowState();if(!0===this.changed||this.isShow!==i){!0===this.changed&&this.updateIconPosition();const e=this.matrices.length;for(let n=0;n<e;n++){const e=t.clone();i&&(e.copy(this.matrices[n]),e.premultiply(this.matrix)),this.meshes[n].setMatrixAt(this.index,e),this.meshes[n].instanceMatrix.needsUpdate=!0}this.changed=!1,this.isShow=i}},this.reset=()=>{console.log("InstancedIconModelController - reset")}}}gb.type="InstancedIconModelController",gb.prototype.isDistanceController=!0,gb.prototype.isInstancedIconModelController=!0;class yb extends ev{constructor(e,t,i,n=Ep.defaultObjectTree,a){super("IconItem"),this.type=e.type,this.name=e.name,this.param=e.param,this.textParam=e.textParam,this.index=e.index?e.index:null,this.parent=e.parent?e.parent:null,this.transform=e.transform?e.transform:this.transform,this.isEditor=!0,this.isCustom=e.isCustom||!1,this._cliiping=!1,this.children=[];let r=new sr,s=null,o=-1;function l(e){Object.assign(e.uniforms,this.uniforms),e.fragmentShader="uniform vec3 outlineColor;\n"+e.fragmentShader,e.fragmentShader="uniform float outlineThickness;\n"+e.fragmentShader,e.fragmentShader="uniform vec2 resolution;\n"+e.fragmentShader,e.fragmentShader="uniform float outline;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",["#ifdef USE_MAP"," vec4 texelColor = mapTexelToLinear( texture2D( map, vUv ) );"," texelColor = mapTexelToLinear( texelColor );"," if (outline == 0.) {","\tdiffuseColor = diffuseColor * texelColor;"," } else { ","\tfloat width = 0.0;","\tif (resolution.x > resolution.y) {","\t\twidth = resolution.y;","\t} else {","\t\twidth = resolution.x;","\t}"," \tvec2 texel = vec2( 1.0 / resolution.y, 1.0 / resolution.x );"," \t#define OFFSET_COUNT_FLOAT 32."," \t#define OFFSET_COUNT 8"," \tfloat aspect = resolution.x / resolution.y;"," \tvec2 offsets[OFFSET_COUNT];"," \toffsets[0] = vec2( 0., 1.);"," \toffsets[1] = vec2( 0., -1.);"," \toffsets[2] = vec2( 1., 0. );"," \toffsets[3] = vec2( -1., 0. );"," \toffsets[4] = vec2( -0.5, 0.5);"," \toffsets[5] = vec2( 0.5, -0.5);"," \toffsets[6] = vec2( 0.5, 0.5);"," \toffsets[7] = vec2( -0.5, -0.5);"," \tfloat a = 0.0;"," \tfloat theta = 0.;"," \tfor( float i = 0.; i < OFFSET_COUNT_FLOAT; i ++ ) {","\t\ttheta = (6.283185307179586 / OFFSET_COUNT_FLOAT) * i;"," \t\tvec2 samplePoint = vec2(cos(theta) * outlineThickness, sin(theta) * outlineThickness * aspect);","  \t\tfloat val = texture2D( map, vUv + texel * samplePoint).a;","  \t\ta = max(a, val);"," \t}"," \tif (texelColor.a > 0.95) {","\t\tdiffuseColor = diffuseColor * texelColor;"," \t} else {"," \t\ttexelColor = mix( vec4(outlineColor, a), texelColor, texelColor.a );","\t\tdiffuseColor = vec4(outlineColor.x + 0.5, outlineColor.g + 0.5, outlineColor.b + 0.5, a) * texelColor;"," \t}"," }","#endif"].join("\n"))}r.renderOrder=1,r.type="IconGroup",this.getGroup=()=>r,this.add=(e,t,i,n,a)=>{if("IconItem"!==e.type&&"IconAsset"!==e.type)return;let s;if(r.name=e.name,r.position.set(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.scale&&r.scale.set(Number(e.transform.scale.x)<=0?1:e.transform.scale.x,Number(e.transform.scale.y)<=0?1:e.transform.scale.y,Number(e.transform.scale.z)<=0?1:e.transform.scale.z),void 0===e.param.iconScale&&(e.param.iconScale=1),void 0===e.textParam.labelScale&&(e.textParam.labelScale=1),""!=e.param.background){let t=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),(e=>{this.backgroundMap=d(e)}));(o=new vr({map:t,color:new Qt(e.param.backgroundColor),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits,side:2})).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},o.onBeforeCompile=l,s=new Or(o),s.name=e.name+"底图",s.type="IconBackground",s.scale.set(e.param.sizeAttenuation?Number(e.param.width)/25:Number(e.param.width)/2500,e.param.sizeAttenuation?Number(e.param.height)/25:Number(e.param.height)/2500,1),s.scale.x*=e.param.iconScale,s.scale.y*=e.param.iconScale;let i=-1;if(s.center=new ye(i*e.param.offsetV+.5,i*e.param.offsetH+.5),e.param.backgroundColor&&"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),s.material.opacity=t}r.add(s)}else{var o;(o=new vr).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},s=new Or(o),s.visible=!1,r.add(s)}e.param.path.indexOf("http")>-1&&e.param.path.indexOf("/api/sceneEditor/v1/")>-1&&(e.param.path=`[[origin]]${e.param.path.substr(e.param.path.indexOf("/v1"))}`);var p=e.param.path;return e.map&&(p=e.map),Ep.instance.customTextureStore.loadTexture({url:p,name:e.param.path,onLoad:o=>{if(o){let t=new vs(o.textureSource);t.center=new ye(.5,.5),t.repeat=new ye(-1,1),t.rotation=Math.PI;var d=new vr({map:t,color:new Qt("#ffffff"),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits,side:2}),p=new Or(d);p.name=e.name+"图标",p.type="IconAsset",p.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1),p.scale.x*=e.param.iconScale,p.scale.y*=e.param.iconScale;let i=-1;""==e.param.background?p.center=new ye(i*e.param.offsetV+.5,i*e.param.offsetH+.5):p.center=new ye(2*i*e.param.offsetV+.5,2*i*e.param.offsetH+.5),void 0!==e.param.minDistance&&(p.activeVisible=p.visible,p.enableAutoHidebyDistance=!0,p.minDistance=e.param.minDistance*Ep.worldScale,p.maxDistance=e.param.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(p.uuid,yy,Ep.camera,p)),r.add(p)}var m=null;if(null!=e.textParam&&e.textParam.enableText)void 0===e.textParam.textSize?(e.textParam.canvas=u(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text,e.textParam.padding,e.textParam.fontWeight),m=c(r,e)):m=h(r,e),m.name=e.name+"文字",m.scale.x*=e.textParam.labelScale,m.scale.y*=e.textParam.labelScale,void 0!==e.textParam.position&&("top"===e.textParam.position?m.center.set(.5-e.textParam.offsetV,0-e.textParam.offsetH):"bottom"===e.textParam.position?m.center.set(.5-e.textParam.offsetV,1-e.textParam.offsetH):"left"===e.textParam.position?m.center.set(1-e.textParam.offsetV,.5-e.textParam.offsetH):"right"===e.textParam.position&&m.center.set(0-e.textParam.offsetV,.5-e.textParam.offsetH)),void 0!==e.textParam.hiddenDistance&&(m.enableAutoHidebyDistance=!0,m.minDistance=0,m.maxDistance=e.textParam.hiddenDistance*Ep.worldScale,Ep.animationStore.addDistance(m.uuid,yy,Ep.camera,m));else{const e=new vr;(m=new Or(e)).visible=!1,r.add(m)}t?(t.add(r),"GroupItem"!==t.type&&"PaintItem"!=t.type&&"PackedItem"!=t.type||t.childrenAdd(this)):n&&(Ep.scene.models.add(r),n.addItem(this)),e.param.mode&&"3d"===e.param.mode.toLowerCase()&&(s.material.side=2,s.material.onBeforeCompile=function(e,t){l.call(s.material,e),Ep.billboardBeforeCompile.call(s.material,e)},s.raycast=Ep.billboardRaycast.bind(s),p.material.side=2,p.material.onBeforeCompile=Ep.billboardBeforeCompile,p.raycast=Ep.billboardRaycast.bind(p),m.material.side=2,m.material.onBeforeCompile=Ep.billboardBeforeCompile,m.raycast=Ep.billboardRaycast.bind(m),r.rotation.x=e.param.rotation[0]/180*Math.PI,r.rotation.y=e.param.rotation[1]/180*Math.PI,r.rotation.z=e.param.rotation[2]/180*Math.PI),i&&i(1,this),a&&a(1,this)}}),r},this.update=async function(e,t,i=!0){this.type=e.type,this.name=e.name,this.param=e.param,this.textParam=e.textParam,this.transform=e.transform,void 0===e.param.iconScale&&(e.param.iconScale=1),void 0===e.textParam.labelScale&&(e.textParam.labelScale=1),r||t&&t(0);r.name=e.name;const n=r.children[0];if(e.param.background){n.visible=!0;const t=_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),a=await function(e){return new Promise((t=>{Ep.loaders.textureLoader.load(e,(function(e){t(e)}))}))}(t);n.material.map&&n.material.map.dispose(),n.material.dispose(),n.material=new vr({map:a,color:new Qt(e.param.backgroundColor),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits}),n.material.uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:i?1:0}},n.material.onBeforeCompile=l,n.name=e.name+"底图",n.type="IconBackground";const r=e.param.sizeAttenuation,s=r?e.param.width/25:e.param.width/2500,o=r?e.param.height/25:e.param.height/2500;n.scale.set(s,o,1),n.scale.x*=e.param.iconScale,n.scale.y*=e.param.iconScale;let c=-1;if(n.center=new ye(e.param.offsetV*c+.5,e.param.offsetH*c+.5),"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),n.material.opacity=t}}else n.visible=!1;const a=r.children[1];let s=e.param.path;e.map&&(s=e.map);const o=await function(e,t){return new Promise((i=>{Ep.instance.customTextureStore.loadTexture({url:e,name:t,onLoad:function(e){i(e)}})}))}(s),d=new vs(o.textureSource);d.center=new ye(.5,.5),d.repeat=new ye(-1,1),d.rotation=Math.PI,a.material.map&&a.material.map.dispose(),a.material.map=d,a.material.color=new Qt("#ffffff"),a.material.fog=!1,a.material.depthWrite=Ep.drawableDepthTest,a.material.depthTest=Ep.drawableDepthTest,a.material.alphaTest=.1,a.material.transparent=!0,a.material.sizeAttenuation=e.param.sizeAttenuation,a.material.polygonOffset=e.param.polygonOffset,a.material.polygonOffsetFactor=e.param.polygonOffsetFactor,a.material.polygonOffsetUnits=e.param.polygonOffsetUnits,a.material.needsUpdate=!0,a.name=e.name+"图标",a.type="IconAsset",a.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1),a.scale.x*=e.param.iconScale,a.scale.y*=e.param.iconScale;""==e.param.background?a.center=new ye(-1*e.param.offsetV+.5,-1*e.param.offsetH+.5):a.center=new ye(-2*e.param.offsetV+.5,-2*e.param.offsetH+.5),void 0!==e.param.minDistance&&(a.minDistance=e.param.minDistance*Ep.worldScale,a.maxDistance=e.param.maxDistance*Ep.worldScale,a.enableAutoHidebyDistance=!0,a.activeVisible=!0,Ep.animationStore.addDistance(a.uuid,yy,Ep.camera,a));const p=r.children[2];null!=e.textParam&&e.textParam.enableText?(p.material.map&&p.material.map.dispose(),void 0===e.textParam.textSize?(e.textParam.canvas=u(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text,e.textParam.padding,e.textParam.fontWeight),c(void 0,e,p)):h(void 0,e,p),p.name=e.name+"文字",p.scale.x*=e.textParam.labelScale,p.scale.y*=e.textParam.labelScale,e.textParam.position&&("top"===e.textParam.position?p.center.set(.5-e.textParam.offsetV,0-e.textParam.offsetH):"bottom"===e.textParam.position?p.center.set(.5-e.textParam.offsetV,1-e.textParam.offsetH):"left"===e.textParam.position?p.center.set(1-e.textParam.offsetV,.5-e.textParam.offsetH):"right"===e.textParam.position&&p.center.set(0-e.textParam.offsetV,.5-e.textParam.offsetH)),void 0!==e.textParam.hiddenDistance&&(p.enableAutoHidebyDistance=!0,p.activeVisible=!0,p.minDistance=0,p.maxDistance=e.textParam.hiddenDistance*Ep.worldScale,Ep.animationStore.addDistance(p.uuid,yy,Ep.camera,p))):p.visible=!1,e.param.mode&&"3d"===e.param.mode.toLowerCase()&&(n.material.side=2,n.material.onBeforeCompile=function(e,t){l.call(n.material,e),Ep.billboardBeforeCompile.call(n.material,e)},n.raycast=Ep.billboardRaycast.bind(n),a.material.side=2,a.material.onBeforeCompile=Ep.billboardBeforeCompile,a.raycast=Ep.billboardRaycast.bind(a),p.material.side=2,p.material.onBeforeCompile=Ep.billboardBeforeCompile,p.raycast=Ep.billboardRaycast.bind(p),r.rotation.x=e.param.rotation[0]/180*Math.PI,r.rotation.y=e.param.rotation[1]/180*Math.PI,r.rotation.z=e.param.rotation[2]/180*Math.PI),t&&t(1)},this.update_old=function(e,t,i=!0){for(const e of r.children)_y.disposeThreeObject(e);if(r.clear(),this.type=e.type,this.name=e.name,this.param=e.param,this.textParam=e.textParam,this.transform=e.transform,void 0===e.param.iconScale&&(e.param.iconScale=1),void 0===e.textParam.labelScale&&(e.textParam.labelScale=1),null!=r){if(r.name=e.name,""!=e.param.background){let t=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),(e=>{this.backgroundMap=e}));(n=new vr({map:t,color:new Qt(e.param.backgroundColor),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits})).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:i?1:0}},n.onBeforeCompile=l,(a=new Or(n)).name=e.name+"底图",a.type="IconBackground",a.scale.set(e.param.sizeAttenuation?Number(e.param.width)/25:Number(e.param.width)/2500,e.param.sizeAttenuation?Number(e.param.height)/25:Number(e.param.height)/2500,1),a.scale.x*=e.param.iconScale,a.scale.y*=e.param.iconScale;let s=-1;if(a.center=new ye(e.param.offsetV*s+.5,e.param.offsetH*s+.5),"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),a.material.opacity=t}r.add(a)}else{var n,a;(n=new vr).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},(a=new Or(n)).visible=!1,r.add(a)}var s=e.param.path;e.map&&(s=e.map),Ep.instance.customTextureStore.loadTexture({url:s,name:e.param.path,onLoad:t=>{let i=new vs(t.textureSource);i.center=new ye(.5,.5),i.repeat=new ye(-1,1),i.rotation=Math.PI;var n=new vr({map:i,color:new Qt("#ffffff"),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits}),a=new Or(n);a.name=e.name+"图标",a.type="IconAsset",a.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1),a.scale.x*=e.param.iconScale,a.scale.y*=e.param.iconScale;""==e.param.background?a.center=new ye(-1*e.param.offsetV+.5,-1*e.param.offsetH+.5):a.center=new ye(-2*e.param.offsetV+.5,-2*e.param.offsetH+.5),void 0!==e.param.minDistance&&(a.minDistance=e.param.minDistance*Ep.worldScale,a.maxDistance=e.param.maxDistance*Ep.worldScale,a.enableAutoHidebyDistance=!0,a.activeVisible=!0,Ep.animationStore.addDistance(a.uuid,yy,Ep.camera,a)),r.add(a);var s=null;null!=e.textParam&&e.textParam.enableText?(e.textParam.canvas=u(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text,e.textParam.padding,e.textParam.fontWeight),(s=c(r,e)).name=e.name+"文字",s.scale.x*=e.textParam.labelScale,s.scale.y*=e.textParam.labelScale,e.textParam.position&&("top"===e.textParam.position?s.center.set(.5-e.textParam.offsetV,0-e.textParam.offsetH):"bottom"===e.textParam.position?s.center.set(.5-e.textParam.offsetV,1-e.textParam.offsetH):"left"===e.textParam.position?s.center.set(1-e.textParam.offsetV,.5-e.textParam.offsetH):"right"===e.textParam.position&&s.center.set(0-e.textParam.offsetV,.5-e.textParam.offsetH)),void 0!==e.textParam.hiddenDistance&&(s.enableAutoHidebyDistance=!0,s.activeVisible=!0,s.minDistance=0,s.maxDistance=e.textParam.hiddenDistance*Ep.worldScale,Ep.animationStore.addDistance(s.uuid,yy,Ep.camera,s))):r.add(new sr)}})}t&&t(1)},this.highlight=function(){r.children[0].material.uniforms.outline.value=1},this.cancleHighlight=function(){r.children[0].material.uniforms.outline.value=0},this.iconHide=()=>{s=r.visible,r.visible=!1},this.iconShow=()=>{r.visible=s,o!==Ep.instance.frameId&&(s=null,o=Ep.instance.frameId)},this.getSettings=()=>(r&&(this.transform.position=r.position,this.transform.rotation=r.rotation,this.transform.scale=r.scale),{name:this.name,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,param:this.param,map:this.map,backgroundMap:this.backgroundMap,textParam:this.textParam,transform:this.transform,parent:this.parent,isCustom:this.isCustom,isEditor:this.isEditor});let c=(e,t,i)=>{if(null!=t.textParam){var n=t.textParam.canvas,a=new vs(n),r=new vr({map:a,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:t.param.sizeAttenuation});i?i.material=r:(i=new Or(r),e?e.add(i):_objectStore.add(i)),i.scale.set(t.param.sizeAttenuation?.045*t.textParam.canvas.width:405e-6*t.textParam.canvas.width,t.param.sizeAttenuation?.045*t.textParam.canvas.height:405e-6*t.textParam.canvas.height,1);let s=-1;return i.center=new ye(t.textParam.offsetV*s+.5,t.textParam.offsetH*s+.5),i.type="IconAsset",i.name=t.name+"文字",i.visible=t.textParam.enableText,i}};const h=(e,t,i)=>{const n=t.textParam.textSize,a=t.textParam.text,r=t.textParam.fontFamily,s=t.textParam.color,o=t.textParam.fontBold?"bold":"normal",l=t.textParam.enableItalic?"italic":"normal",c=t.textParam.background,h=t.textParam.padding?2*t.textParam.padding:0,u=document.createElement("canvas"),d=u.getContext("2d");d.font=`${l} ${o} ${n}px ${r}`,u.width=d.measureText(a).width+h,u.height=n+h,d.fillStyle=c,d.fillRect(0,0,u.width,u.height),d.font=`${l} ${o} ${n}px ${r}`,d.fillStyle=s,d.textAlign="center",d.textBaseline="middle",d.fillText(a,u.width/2,u.height/2);const p=new vs(u),m=new vr({map:p,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:t.param.sizeAttenuation});i?i.material=m:(i=new Or(m),e.add(i)),t.param.sizeAttenuation?i.scale.set(u.width,u.height,1):i.scale.set(u.width/Ep.renderer.domElement.height,u.height/Ep.renderer.domElement.height,1);return i.center=new ye(-1*t.textParam.offsetV+.5,-1*t.textParam.offsetH+.5),i.type="IconAsset",i.name=t.name+"文字",i};let u=(e,t,i,n,a,r,s,o=0,l)=>{let c=document.createElement("canvas"),h=c.getContext("2d");var u=4.5*t,d="";i&&(d="bold");var p="";return n&&(p="italic"),h.font=`${p} ${d} ${u}px ${e}`,c.width=1.8*(h.measureText(s).width+u)+4.5*o*2,c.height=3.2*u+4.5*o*2,h.fillStyle=a,h.fillRect(0,0,c.width,c.height),h.font=`${p} ${d} ${2*u}px ${e}`,h.fillStyle=r,h.textAlign="center",h.textBaseline="middle",h.fillText(s,c.width/2,c.height/2),c},d=e=>{var t=document.createElement("canvas");return t.width=e.image.width,t.height=e.image.height,t.getContext("2d").drawImage(e.image,0,0,t.width,t.height),t.toDataURL()};this.add(e,t,i,n,a),e.isVisible?this.show():this.hide()}get clipping(){return this._cliiping}set clipping(e){this._cliiping=e,e?this.iconHide():this.isVisible&&this.iconShow()}}function vb(e){Object.assign(e.uniforms,this.uniforms),e.fragmentShader="uniform vec3 outlineColor;\n"+e.fragmentShader,e.fragmentShader="uniform float outlineThickness;\n"+e.fragmentShader,e.fragmentShader="uniform vec2 resolution;\n"+e.fragmentShader,e.fragmentShader="uniform float outline;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",["#ifdef USE_MAP"," vec4 texelColor = mapTexelToLinear( texture2D( map, vUv ) );"," texelColor = mapTexelToLinear( texelColor );"," if (outline == 0.) {","\tdiffuseColor = diffuseColor * texelColor;"," } else { ","\tfloat width = 0.0;","\tif (resolution.x > resolution.y) {","\t\twidth = resolution.y;","\t} else {","\t\twidth = resolution.x;","\t}"," \tvec2 texel = vec2( 1.0 / resolution.y, 1.0 / resolution.x );"," \t#define OFFSET_COUNT_FLOAT 32."," \t#define OFFSET_COUNT 8"," \tfloat aspect = resolution.x / resolution.y;"," \tvec2 offsets[OFFSET_COUNT];"," \toffsets[0] = vec2( 0., 1.);"," \toffsets[1] = vec2( 0., -1.);"," \toffsets[2] = vec2( 1., 0. );"," \toffsets[3] = vec2( -1., 0. );"," \toffsets[4] = vec2( -0.5, 0.5);"," \toffsets[5] = vec2( 0.5, -0.5);"," \toffsets[6] = vec2( 0.5, 0.5);"," \toffsets[7] = vec2( -0.5, -0.5);"," \tfloat a = 0.0;"," \tfloat theta = 0.;"," \tfor( float i = 0.; i < OFFSET_COUNT_FLOAT; i ++ ) {","\t\ttheta = (6.283185307179586 / OFFSET_COUNT_FLOAT) * i;"," \t\tvec2 samplePoint = vec2(cos(theta) * outlineThickness, sin(theta) * outlineThickness * aspect);","  \t\tfloat val = texture2D( map, vUv + texel * samplePoint).a;","  \t\ta = max(a, val);"," \t}"," \tif (texelColor.a > 0.95) {","\t\tdiffuseColor = diffuseColor * texelColor;"," \t} else {"," \t\ttexelColor = mix( vec4(outlineColor, a), texelColor, texelColor.a );","\t\tdiffuseColor = vec4(outlineColor.x + 0.5, outlineColor.g + 0.5, outlineColor.b + 0.5, a) * texelColor;"," \t}"," }","#endif"].join("\n"))}class bb{constructor(e,t,i){let n=e.points,a=e.scales||[],r=1;if(!(n&&n instanceof Array))return;n.length>zy&&(logger.warn(`实例对象的实例数不能超过 65535，将忽略超出的 ${n.length-zy} 个实例。`),n.splice(zy,n.length-zy)),r=n.length,this.name=e.name,this.layerName=t.name,this.type="IconAsset",this.count=r,this.points=n,this.scales=a,this.transform=e.transform,this.assetObj=e,e.randomValues,this.delta=0;var s=null,o=null,l=null,c=null,h=null,u=null;new Ce(1,1,1);var d=null;this._group=new sr,this.children=[],this.settings=[];var p=null;t.addInstanced("IconAsset",this),this.setRand=e=>{},this.getCount=()=>this.children.length,this.getIndexName=()=>this.children[this.children.length-1].name,this.getTransform=()=>this.children[this.children.length-1].transform,this.removeInstance=e=>{let t=this.settings.findIndex((t=>t.key==e));this.points.splice(t,1),this._group.remove(this.children[t]),this.children.splice(t,1),this.settings.splice(t,1)},this.addAllInstance=(i,n,a)=>{if(n&&i){this.count=this.points.length;for(let a=0;a<i.length;a++){let r=d.clone(),s=i[a],o={x:1,y:1,z:1};n.length>a&&(o=n[a]),r.type="IconGroup",r.name=t.getIndexName(e.name),r.position.set(s[0],s[1],s[2]),r.scale.set(o.x,o.y,o.z),this.children.push(r),this._group.add(r)}}},this.addInstance=(i,n)=>{if(!(i&&i instanceof Array))return;let a=this.points.length;i.length+this.points.length>zy&&(logger.warn(`实例对象的实例数不能超过 65535，将忽略超出的 ${i.length+this.points.length-zy} 个实例。`),this.points.splice(zy-this.points.length,i.length+this.points.length-zy)),this.points.push.apply(this.points,i);let{x:r,y:s,z:o}=this.transform.scale;this.scales.push.apply(this.scales,[{x:r,y:s,z:o}]),this.count=this.points.length;for(let i=a;i<this.points.length;i++){let n=d.clone(),a=this.points[i];n.type="IconGroup",n.name=t.getIndexName(e.name),n.position.set(a[0],a[1],a[2]),n.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),this.children.push(n),this._group.add(n)}};let m=e=>{if(null!=e.textParam){var t=e.textParam.canvas,i=new vs(t);u=new vr({map:i,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:e.param.sizeAttenuation}),(l=new Or(u)).scale.set(e.param.sizeAttenuation?.045*e.textParam.canvas.width:405e-6*e.textParam.canvas.width,e.param.sizeAttenuation?.045*e.textParam.canvas.height:405e-6*e.textParam.canvas.height,1);let n=-1;l.center=new ye(e.textParam.offsetV*n+.5,e.textParam.offsetH*n+.5),l.type="IconAsset",l.name=e.name+"文字",l.visible=e.textParam.enableText}},f=(e,t,i,n,a,r,s)=>{let o=document.createElement("canvas"),l=o.getContext("2d");var c=4.5*t,h="";i&&(h="bold");var u="";return n&&(u="italic"),l.font=`${u} ${h} ${c}px ${e}`,o.width=1.8*(l.measureText(s).width+c),o.height=3.2*c,l.fillStyle=a,l.fillRect(0,0,o.width,o.height),l.font=`${u} ${h} ${2*c}px ${e}`,l.fillStyle=r,l.textAlign="center",l.textBaseline="middle",l.fillText(s,o.width/2,o.height/2),o},g=e=>{var t=document.createElement("canvas");return t.width=e.image.width,t.height=e.image.height,t.getContext("2d").drawImage(e.image,0,0,t.width,t.height),t.toDataURL()};if(this.update=(e,t)=>{this.assetObj.param=e.param,this.assetObj.textParam=e.textParam;let i=Ep.defaultObjectTree.getItemByName(this.layerName),n=this.settings.map((e=>e.name));if(i.children.forEach((t=>{n.includes(t.name)&&("ModelAsset"==e.type?t.modelPath=e.path:(t.param=e.param,t.textParam=e.textParam))})),d.clear(),""!=e.param.background){let t=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),(e=>{this.backgroundMap=e}));(c=new vr({map:t,color:new Qt(e.param.backgroundColor),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits})).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},c.onBeforeCompile=vb,(p=c.clone()).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:1}},p.onBeforeCompile=vb,(s=new Or(c.clone())).name=this.assetObj.name+"底图",s.type="IconBackground",s.scale.set(e.param.sizeAttenuation?Number(e.param.width)/25:Number(e.param.width)/2500,e.param.sizeAttenuation?Number(e.param.height)/25:Number(e.param.height)/2500,1);let i=-1;if(s.center=new ye(e.param.offsetV*i+.5,e.param.offsetH*i+.5),"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),s.material.opacity=t}d.add(s)}else(c=new vr).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},c.onBeforeCompile=vb,(p=c.clone()).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:1}},p.onBeforeCompile=vb,(s=new Or(c.clone())).name=this.assetObj.name+"底图",s.type="IconBackground",s.visible=!1,d.add(s);var a=e.param.path;e.map&&(a=e.map),Ep.instance.customTextureStore.loadTexture({url:a,name:e.param.path,onLoad:t=>{let i=new vs(t.textureSource);i.center=new ye(.5,.5),i.repeat=new ye(-1,1),i.rotation=Math.PI,h=new vr({map:i,color:new Qt("#ffffff"),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits}),(o=new Or(h.clone())).name=this.assetObj.name+"图标",o.type="IconAsset",o.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1);""==e.param.background?o.center=new ye(-1*e.param.offsetV+.5,-1*e.param.offsetH+.5):o.center=new ye(-2*e.param.offsetV+.5,-2*e.param.offsetH+.5),d.add(o),null!=e.textParam&&e.textParam.enableText?(e.textParam.canvas=f(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text),m(e),l.name=this.assetObj.name+"文字"):l=new sr,d.add(l),this.children.forEach(((e,t)=>{e.children[0].visible=s.visible,e.children[0].center=s.center.clone(),e.children[1].center=o.center.clone(),l.center&&(e.children[2].center=l.center.clone()),e.children[0].material=c.clone(),e.children[0].scale.copy(s.scale),e.children[1].material=h.clone(),e.children[1].scale.copy(o.scale),e.children[2].scale.copy(l.scale),e.children[2].material=u.clone()}))}})},this.highlight=(e,t)=>{if(t||this.children.forEach((e=>{e.children[0].material=c.clone(),e.children[0].material.needsUpdate=!0})),!e)return;let i=this.children.find((t=>t.name==e));i.children[0].material=p,i.children[0].material.needsUpdate=!0},this.cancelHighlight=e=>{if(!e)return;let t=this.children.find((t=>t.name==e));t.children[0].material=c.clone(),t.children[0].material.needsUpdate=!0},this.setVisible=(e,t)=>{let i=this.settings.findIndex((t=>t.key==e)),n=this.children.find((t=>t.name==e));n&&(n.visible=t),this.settings[i].isVisible=t},this.lock=(e,t)=>{let i=this.settings.findIndex((t=>t.key==e));this.settings[i].isLock=t},this.toJSON=()=>({name:this.name,type:this.type,count:this.count,points:this.points,scales:this.scales,transform:this.transform,assetObj:this._getAssetSetting(),settings:this.settings}),this._getAssetSetting=()=>{let e=JSON.parse(JSON.stringify(this.assetObj));return e.map=this.map,e.backgroundMap=this.backgroundMap,e},((e,t,i)=>{(d=new sr).type="IconGroup",d.name=t.getIndexName(e.name),d.position.set(this.points[0][0],this.points[0][1],this.points[0][2]);let n=new Ce(this.transform.scale.x||1,this.transform.scale.y||1,this.transform.scale.z||1);if(e.scales&&e.scales.length&&(n.x=e.scales[0].x,n.y=e.scales[0].y,n.z=e.scales[0].z),d.scale.copy(n),""!=e.param.background){let t=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+e.param.background+".png"),(e=>{this.backgroundMap=g(e)}));if((c=new vr({map:t,color:new Qt(e.param.backgroundColor),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits})).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},e.param.backgroundColor&&"rgba"===e.param.backgroundColor.substring(0,4)){let t=e.param.backgroundColor.slice(4);t=t.split(","),t=parseFloat(t[3].replace(/[^0-9.]/gi,"")),c.opacity=t}c.onBeforeCompile=vb,(p=c.clone()).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:1}},p.onBeforeCompile=vb,(s=new Or(c)).name=e.name+"底图",s.type="IconBackground",s.scale.set(e.param.sizeAttenuation?Number(e.param.width)/25:Number(e.param.width)/2500,e.param.sizeAttenuation?Number(e.param.height)/25:Number(e.param.height)/2500,1);let i=-1;s.center=new ye(i*e.param.offsetV+.5,i*e.param.offsetH+.5),d.add(s)}else(c=new vr).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:0}},(p=c.clone()).uniforms={outlineColor:{value:new Qt("#ffff00")},outlineThickness:{value:65},resolution:{value:new ye(Ep.renderer.domElement.width,Ep.renderer.domElement.height)},outline:{value:1}},p.onBeforeCompile=vb,(s=new Or(c.clone())).name=e.name+"底图",s.type="IconBackground",s.visible=!1,d.add(s);var a=e.param.path;e.map&&(a=e.map),Ep.instance.customTextureStore.loadTexture({url:a,name:e.param.path,onLoad:i=>{let n=new vs(i.textureSource);n.center=new ye(.5,.5),n.repeat=new ye(-1,1),n.rotation=Math.PI,h=new vr({map:n,color:new Qt("#ffffff"),fog:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.1,transparent:!0,sizeAttenuation:e.param.sizeAttenuation,polygonOffset:e.param.polygonOffset,polygonOffsetFactor:e.param.polygonOffsetFactor,polygonOffsetUnits:e.param.polygonOffsetUnits}),(o=new Or(h.clone())).name=e.name+"图标",o.type="IconAsset",o.scale.set(e.param.sizeAttenuation?Number(e.param.width)/50:Number(e.param.width)/5e3,e.param.sizeAttenuation?Number(e.param.height)/50:Number(e.param.height)/5e3,1);""==e.param.background?o.center=new ye(-1*e.param.offsetV+.5,-1*e.param.offsetH+.5):o.center=new ye(-2*e.param.offsetV+.5,-2*e.param.offsetH+.5),d.add(o),null!=e.textParam&&e.textParam.enableText?(e.textParam.canvas=f(e.textParam.fontFamily,e.textParam.fontSize,e.textParam.fontBold,e.textParam.enableItalic,e.textParam.background,e.textParam.color,e.textParam.text),m(e),l.name=e.name+"文字",d.add(l)):d.add(new sr),this.children.push(d),this._group.type="InstancedGroup",this._group.userData.instancedGroup=this,this._group.add(d),t&&t.add(this._group)}})})(e,t),this.points.length>1){let e=this.points.splice(1),i=[];this.scales&&(i=this.scales.splice(1)),this.addAllInstance(e,i,t)}i&&i(1,this)}}class _b extends ev{constructor(e,t,i,n){super("InstancedItem"),this.type=e.type,this.name=e.name,this.index=n,this.parent=t.name,this.key=i,this.isInstancedItem=!0,this.transform=e.transform,"ModelAsset"==this.type?(this.modelPath=e.path,this.modelType=(e.modelType||"glb").toLowerCase()):(this.param=e.param,this.textParam=e.textParam);let a=t;this.instanced=t;let r=null;this.getGroup=()=>"IconAsset"===this.type?a.children.find((e=>e.name==this.key)):"ModelAsset"===this.type?a.getHelper(this.key):void 0,this.highlightInstance=e=>{a.highlight(this.key,e)},this.disableHighlight=()=>{a.highlight()},this.cancelHightLight=()=>{a.cancelHighlight(this.key)},this.update=function(e,t){this.disableHighlight(),"IconAsset"==e.type&&(a.update(e,this.key),Ep.instance.nextRender((()=>{this.highlightInstance()}),2))},this.getSettings=()=>({name:this.name,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,param:this.param,modelPath:this.modelPath,modelType:this.modelType,map:this.map,backgroundMap:this.backgroundMap,textParam:this.textParam,transform:this.transform,isCustom:this.isCustom,isEditor:this.isEditor,isInstancedItem:this.isInstancedItem,materials:a.materialStore.getSettings()}),this._getVisible=()=>this.isVisible,this._setVisible=(e,t=e)=>{this.isVisible=e,a.setVisible(this.key,this.isVisible,t),this.movingAnimation&&this.movingAnimation.setVisible(!!e)},this._getLock=()=>this.isLock,this._setLock=e=>{this.isLock=e,a.lock(this.key,this.isLock)},this.rankNode=()=>{let e=a.settings.findIndex((e=>e.key==this.key));a.settings[e].index=this.index},this.remove=()=>{a.removeInstance(this.key),this.movingAnimation&&Ep.animationStore.remove(this.movingAnimation)},this.rename=e=>{"IconAsset"==this.type&&(this.getGroup().name=e),this.name=e;let t=a.settings.findIndex((e=>e.key==this.key));a.settings[t].name=this.name,"IconAsset"==this.type&&(a.settings[t].key=this.name,this.key=this.name)},this.setTransform=e=>{this.transform=e;let t=a.settings.findIndex((e=>e.key==this.key));a.points[t]=[e.position.x,e.position.y,e.position.z];let{x:i,y:n,z:r}=e.scale;a.scales[t]={x:i,y:n,z:r}},this.iconHide=()=>{if("IconAsset"==this.type){let e=this.getGroup();r=e.visible,e.visible=!1}},this.iconShow=()=>{if("IconAsset"==this.type){this.getGroup().visible=r,r=null}},this.isVisible=e.isVisible,this.isLock=e.isLock,a.settings.push({index:this.index,name:this.name,key:this.key,isVisible:this.isVisible,isLock:this.isLock}),this.createMovingAnimation=()=>{this.movingAnimation=new Kv({instancedItem:this,instanced:t,key:this.key}),Ep.animationStore.add(this.movingAnimation)},this.setColor=e=>{a.setColorAt(this.key,new Qt(e))},this.getWorldPosition=()=>a.getWorldPosition(this.key)}}_b.prototype.isInstancedItem=!0;var xb={computeTangents:function(e){e.computeTangents(),console.warn("THREE.BufferGeometryUtils: .computeTangents() has been removed. Use BufferGeometry.computeTangents() instead.")},mergeBufferGeometries:function(e,t){for(var i=null!==e[0].index,n=new Set(Object.keys(e[0].attributes)),a=new Set(Object.keys(e[0].morphAttributes)),r={},s={},o=e[0].morphTargetsRelative,l=new wi,c=0,h=0;h<e.length;++h){var u=e[h],d=0;if(i!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(var p in u.attributes){if(!n.has(p))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+'. All geometries must have compatible attributes; make sure "'+p+'" attribute exists among all geometries, or in none of them.'),null;void 0===r[p]&&(r[p]=[]),r[p].push(u.attributes[p]),d++}if(d!==n.size)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". Make sure all geometries have the same number of attributes."),null;if(o!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(var p in u.morphAttributes){if(!a.has(p))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===s[p]&&(s[p]=[]),s[p].push(u.morphAttributes[p])}if(l.userData.mergedUserData=l.userData.mergedUserData||[],l.userData.mergedUserData.push(u.userData),t){var m;if(i)m=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". The geometry must have either an index or a position attribute"),null;m=u.attributes.position.count}l.addGroup(c,m,h),c+=m}}if(i){var f=0,g=[];for(h=0;h<e.length;++h){for(var y=e[h].index,v=0;v<y.count;++v)g.push(y.getX(v)+f);f+=e[h].attributes.position.count}l.setIndex(g)}for(var p in r){var b=this.mergeBufferAttributes(r[p]);if(!b)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+p+" attribute."),null;l.setAttribute(p,b)}for(var p in s){var _=s[p][0].length;if(0===_)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[p]=[];for(h=0;h<_;++h){var x=[];for(v=0;v<s[p].length;++v)x.push(s[p][v][h]);var w=this.mergeBufferAttributes(x);if(!w)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+p+" morphAttribute."),null;l.morphAttributes[p].push(w)}}return l},mergeBufferAttributes:function(e){for(var t,i,n,a=0,r=0;r<e.length;++r){var s=e[r];if(s.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===t&&(t=s.array.constructor),t!==s.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===i&&(i=s.itemSize),i!==s.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===n&&(n=s.normalized),n!==s.normalized)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;a+=s.array.length}var o=new t(a),l=0;for(r=0;r<e.length;++r)o.set(e[r].array,l),l+=e[r].array.length;return new ti(o,i,n)},interleaveAttributes:function(e){for(var t,i=0,n=0,a=0,r=e.length;a<r;++a){var s=e[a];if(void 0===t&&(t=s.array.constructor),t!==s.array.constructor)return console.error("AttributeBuffers of different types cannot be interleaved"),null;i+=s.array.length,n+=s.itemSize}var o=new fr(new t(i),n),l=0,c=[],h=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"],d=0;for(r=e.length;d<r;d++){var p=(s=e[d]).itemSize,m=s.count,f=new yr(o,p,l,s.normalized);c.push(f),l+=p;for(var g=0;g<m;g++)for(var y=0;y<p;y++)f[u[y]](g,s[h[y]](g))}return c},estimateBytesUsed:function(e){var t=0;for(var i in e.attributes){var n=e.getAttribute(i);t+=n.count*n.itemSize*n.array.BYTES_PER_ELEMENT}var a=e.getIndex();return t+=a?a.count*a.itemSize*a.array.BYTES_PER_ELEMENT:0},mergeVertices:function(e,t=1e-4){t=Math.max(t,Number.EPSILON);for(var i={},n=e.getIndex(),a=e.getAttribute("position"),r=n?n.count:a.count,s=0,o=Object.keys(e.attributes),l={},c={},h=[],u=["getX","getY","getZ","getW"],d=0,p=o.length;d<p;d++){l[b=o[d]]=[],(S=e.morphAttributes[b])&&(c[b]=new Array(S.length).fill().map((()=>[])))}var m=Math.log10(1/t),f=Math.pow(10,m);for(d=0;d<r;d++){var g=n?n.getX(d):d,y="",v=0;for(p=o.length;v<p;v++)for(var b=o[v],_=(w=e.getAttribute(b)).itemSize,x=0;x<_;x++)y+=~~(w[u[x]](g)*f)+",";if(y in i)h.push(i[y]);else{for(v=0,p=o.length;v<p;v++){b=o[v];var w=e.getAttribute(b),S=e.morphAttributes[b],M=(_=w.itemSize,l[b]),T=c[b];for(x=0;x<_;x++){var A=u[x];if(M.push(w[A](g)),S)for(var E=0,C=S.length;E<C;E++)T[E].push(S[E][A](g))}}i[y]=s,h.push(s),s++}}const I=e.clone();for(d=0,p=o.length;d<p;d++){b=o[d];var P=e.getAttribute(b);w=new ti(new P.array.constructor(l[b]),P.itemSize,P.normalized);if(I.setAttribute(b,w),b in c)for(v=0;v<c[b].length;v++){var R=e.morphAttributes[b][v],O=new ti(new R.array.constructor(c[b][v]),R.itemSize,R.normalized);I.morphAttributes[b][v]=O}}return I.setIndex(h),I},toTrianglesDrawMode:function(e,t){if(0===t)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(2===t||1===t){var i=e.getIndex();if(null===i){var n=[],a=e.getAttribute("position");if(void 0===a)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var r=0;r<a.count;r++)n.push(r);e.setIndex(n),i=e.getIndex()}var s=i.count-2,o=[];if(2===t)for(r=1;r<=s;r++)o.push(i.getX(0)),o.push(i.getX(r)),o.push(i.getX(r+1));else for(r=0;r<s;r++)r%2==0?(o.push(i.getX(r)),o.push(i.getX(r+1)),o.push(i.getX(r+2))):(o.push(i.getX(r+2)),o.push(i.getX(r+1)),o.push(i.getX(r)));o.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(o),l.clearGroups(),l}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e},computeMorphedAttributes:function(e){if(!0!==e.geometry.isBufferGeometry)return console.error("THREE.BufferGeometryUtils: Geometry is not of type BufferGeometry."),null;var t=new Ce,i=new Ce,n=new Ce,a=new Ce,r=new Ce,s=new Ce,o=new Ce,l=new Ce,c=new Ce;function h(e,h,u,d,p,m,f,g,y){t.fromBufferAttribute(u,m),i.fromBufferAttribute(u,f),n.fromBufferAttribute(u,g);var v=e.morphTargetInfluences;if(h.morphTargets&&d&&v){o.set(0,0,0),l.set(0,0,0),c.set(0,0,0);for(var b=0,_=d.length;b<_;b++){var x=v[b],w=d[b];0!==x&&(a.fromBufferAttribute(w,m),r.fromBufferAttribute(w,f),s.fromBufferAttribute(w,g),p?(o.addScaledVector(a,x),l.addScaledVector(r,x),c.addScaledVector(s,x)):(o.addScaledVector(a.sub(t),x),l.addScaledVector(r.sub(i),x),c.addScaledVector(s.sub(n),x)))}t.add(o),i.add(l),n.add(c)}e.isSkinnedMesh&&(e.boneTransform(m,t),e.boneTransform(f,i),e.boneTransform(g,n)),y[3*m+0]=t.x,y[3*m+1]=t.y,y[3*m+2]=t.z,y[3*f+0]=i.x,y[3*f+1]=i.y,y[3*f+2]=i.z,y[3*g+0]=n.x,y[3*g+1]=n.y,y[3*g+2]=n.z}var u,d,p,m,f,g,y,v,b,_=e.geometry,x=e.material,w=_.index,S=_.attributes.position,M=_.morphAttributes.position,T=_.morphTargetsRelative,A=_.attributes.normal,E=_.morphAttributes.position,C=_.groups,I=_.drawRange,P=new Float32Array(S.count*S.itemSize),R=new Float32Array(A.count*A.itemSize);if(null!==w)if(Array.isArray(x))for(m=0,g=C.length;m<g;m++)for(b=x[(v=C[m]).materialIndex],f=Math.max(v.start,I.start),y=Math.min(v.start+v.count,I.start+I.count);f<y;f+=3)h(e,b,S,M,T,u=w.getX(f),d=w.getX(f+1),p=w.getX(f+2),P),h(e,b,A,E,T,u,d,p,R);else for(m=Math.max(0,I.start),g=Math.min(w.count,I.start+I.count);m<g;m+=3)h(e,x,S,M,T,u=w.getX(m),d=w.getX(m+1),p=w.getX(m+2),P),h(e,x,A,E,T,u,d,p,R);else if(void 0!==S)if(Array.isArray(x))for(m=0,g=C.length;m<g;m++)for(b=x[(v=C[m]).materialIndex],f=Math.max(v.start,I.start),y=Math.min(v.start+v.count,I.start+I.count);f<y;f+=3)h(e,b,S,M,T,u=f,d=f+1,p=f+2,P),h(e,b,A,E,T,u,d,p,R);else for(m=Math.max(0,I.start),g=Math.min(S.count,I.start+I.count);m<g;m+=3)h(e,x,S,M,T,u=m,d=m+1,p=m+2,P),h(e,x,A,E,T,u,d,p,R);return{positionAttribute:S,normalAttribute:A,morphedPositionAttribute:new hi(P,3),morphedNormalAttribute:new hi(R,3)}}};class wb extends ev{constructor(e,{name:t,index:i,isVisible:n,isLock:a,transform:r,parent:s,parentUUID:o},l,c,h){super("PaintLayer"),this.type=e,this.isVisible=n,this.isLock=a,this.transform=r||this.transform,this.name=t,this.index=i,this.children=[];let u,d=l||new sr;d.name=t,d.type="PaintGroup",o?(u=Ep.scene.models.getObjectByProperty("uuid",o),u&&u!==c?u.add(d):(c.add(d),h.addItem(this))):(c.add(d),"PackedItem"==h.type?h.childrenAdd(this):h.addItem(this)),d.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),d.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),d.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),this.pathPoints=[],this.pathIndex=-1,this.getGroup=()=>d,this.add=e=>{d.add(e)},this.childrenAdd=e=>{this.children.push(e)},this.getType=()=>this.type,this.getItemByName=e=>this.children.find((t=>t.name===e)),this.resetHelper=()=>{"GroupItem"===this.type?this.children.forEach((e=>{"ModelAsset"===e.type&&e.reset()})):"PaintItem"===this.type&&this.modelInstanced.forEach((e=>{e.reset()}))}}}class Sb extends wb{constructor(e,t,i=Ep.scene.models,n=Ep.defaultObjectTree){super("GroupItem",e,t,i,n),this.removeChild=e=>new Promise((t=>{this.remove(e,(e=>{let i=0;this.children.length||(Ep.defaultObjectTree.remove(this.name),i=1),t(i)}))})),this.removeItem=(e,t)=>new Promise((i=>{let n=this.children.find((t=>t.name==e));"ModelAsset"==n.type||"ModelItem"==n.type?(n.removeInstance(t),n.points.length?i(0):this.removeChild(e).then((e=>{i(e)}))):this.removeChild(e).then((e=>{i(e)})),this.children.length||(Ep.defaultObjectTree.remove(this.name),i(1))})),this.getSettings=()=>{let e=this.getGroup();return e&&(this.transform.position=e.position,this.transform.rotation=e.rotation,this.transform.scale=e.scale),this.children.forEach((e=>{if(e.getMesh&&e.getMesh()&&e.getMesh().count){var t=[];if("ModelAsset"===e.type)for(let n=0;n<e.getMeshes()[0].count;n++){var i=new it;e.getMeshes()[0].getMatrixAt(n,i),t.push(i)}e.matrix=t}})),{name:this.name,type:this.type,children:this.children,isVisible:this.isVisible,isLock:this.isLock,index:this.index,transform:this.transform}}}}class Mb extends os{constructor(e,t=16776960,i,n,a,r){const s=new wi,o=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);s.setIndex(new ti(o,1));const l=[1,2,1,-1,2,1,-1,0,1,1,0,1,1,2,-1,-1,2,-1,-1,0,-1,1,0,-1];r&&(l.length=0,l.push(1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1)),s.setAttribute("position",new hi(l,3)),super(s,new Kr({color:t,toneMapped:!1})),this.box=e,this.type="InstancedHelper",this.isApplyMatrix=!1,this.defaultSize=new Ce,e.getSize(this.defaultSize),this.geometry.computeBoundingSphere(),this.layer=i,this.instanced=n,this._lastPostition=new Ce,this._lastRotation=new dt,this._lastScale=new Ce,this.lazyTimer=null}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}updatePosition(e){const t=new Ce;this.box.getSize(t),this.box.setFromCenterAndSize(e,t)}rotateAxis(){let{key:e}=this.userData,t=this.instanced.getTransform(e),i=new it;i.compose(t.position,this.quaternion,t.scale),this.instanced.setMatrixAt(e,i);let n=this.instanced.settings[e].name,a=this.layer.getItemByName(n),r=new dt;r.setFromQuaternion(this.quaternion),a.transform.rotation={x:r._x,y:r._y,z:r._z}}rotate(e,t){let{key:i}=this.userData,n=this.instanced.getTransform(i);this.instanced.setTransform(i,e,t,n.scale);let a=new Ce;this.box.getSize(a),this.box.setFromCenterAndSize(e,a),this.rotation.copy(t)}update(e,t,i){let{key:n}=this.userData;e=new Ce(e.x,e.y,e.z),t=new dt(t.x,t.y,t.z,t.order),i=new Ce(i.x,i.y,i.z),e.equals(this._lastPostition)&&t.equals(this._lastRotation)&&i.equals(this._lastScale)||(this._lastPostition=e.clone(),this._lastRotation=t.clone(),this._lastScale=i.clone(),this.instanced.setTransform(n,e,t,i),this.box.setFromCenterAndSize(e,this.defaultSize.clone().multiply(i)),this.rotation.copy(t))}lazyUpdate(e,t,i){if(e&&this.setPosition(e),t){let e=(new Ee).setFromEuler(t);this.setQuaternion(e)}i&&this.setScale(i)}setPosition(e){let{key:t}=this.userData,i=new it,n=new Ce;this.box.getSize(n),this.box.setFromCenterAndSize(e,n);let a=this.instanced.getTransform(t),r=new Ee;r.setFromEuler(a.rotation),i.compose(e,r,a.scale),this.instanced.setMatrixAt(t,i),this.instanced.points[t]=[e.x,e.y,e.z];let s=this.instanced.settings[t].name,o=this.layer.getItemByName(s);o&&(o.transform.position=JSON.parse(JSON.stringify(e)),this.instanced.assetObj&&(this.instanced.assetObj.points=this.instanced.points))}setQuaternion(e){this.quaternion.copy(e);let{key:t}=this.userData,i=new it,n=this.instanced.getTransform(t);i.compose(n.position,e,n.scale),this.instanced.setMatrixAt(t,i)}setScale(e){if((e=new Ce(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))).equals(this._lastScale))return;this._lastScale=e.clone();let{key:t}=this.userData,i=new it,n=this.instanced.getTransform(t);this.box.setFromCenterAndSize(this.position,this.defaultSize.clone().multiply(e));let a=new Ee;a.setFromEuler(n.rotation),i.compose(n.position,a,e),this.instanced.setMatrixAt(t,i)}}class Tb{constructor({id:e=_y.guid(),name:t="",type:i="imagebitmap",textureSource:n="",wrapS:a,wrapT:r}={}){this._id=e,this._name=t,this._type=i,this._textureSource=n,this._wrapS=a,this._wrapT=r}get id(){return this._id}get name(){return this._name}get type(){return this._type}get textureSource(){return this._textureSource}set textureSource(e){this._textureSource=e}getCanvas({width:e,height:t,adjust:i}={}){if(this._textureSource&&"imagebitmap"===this._type){if(!this._canvas){this._canvas=document.createElement("canvas"),this._canvas.width=e||this._textureSource.width,this._canvas.height=t||this._textureSource.height,this._canvas.getContext("2d").drawImage(this._textureSource,0,0,this._canvas.width,this._canvas.height)}return this._canvas}}destroyCanvas(){this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=void 0)}}Tb._fromThreeObject=function({uuid:e,name:t,type:i,image:n,rotation:a,center:r,flipY:s,wrapS:o,wrapT:l}={}){return new Tb({id:e,name:t,type:"imagebitmap",textureSource:n,wrapS:o,wrapT:l})};class Ab{constructor({materialOfThree:e,id:t=_y.guid(),name:i,type:n="metalness",mapType:a="metalness",color:r,map:s,mapIntensit:o=1,metalnessMap:l,metalnessIntensity:c=1,specularF0Texture:h,roughnessMap:u,roughnessIntensity:d=1,enableSpecularMap:p=!0,specularMapType:m,specularMap:f,specularMapIntensity:g=0,enableNormalMap:y,normalMapType:v,normalMap:b,normalMapFlipY:_,normalMapIntensity:x=1,enableDisplacement:w,displacementMap:S,displacementIntensity:M=1,enableOpacity:T,opacityType:A,opacityMap:E,opacityIntensity:C=1,opacityInverted:I=!1,emissive:P,enableEmissive:R,emissiveMap:O,emissiveIntensity:D=1,enableClearcoat:L,clearcoatMap:k,sheen:N,clearcoatThickness:B=0,clearcoatNormalMap:z,clearcoatNormalScale:U,clearcoatRoughness:F=0,clearcoatRoughnessMap:j,enableAOMap:H,aoMap:G,aoMapIntensity:V=1,enableLightMap:W,lightMap:Y,lightMapIntensity:X=1,enableUV:Z=!1,repeatU:q=1,repeatV:J=1,offsetU:Q=0,offsetV:K=0,enableTranslation:$=!1,translationSpeedU:ee=0,translationSpeedV:te=0,enableSSR:ie=!1,envMapIntensity:ne=1,side:ae,depth:re,waterFlowSpeed:se,waterOffsetY:oe,waterColor:le,waterOpacity:ce,waterReflectionRate:he,waterWave:ue,polygonOffset:de,polygonOffsetFactor:pe,polygonOffsetUnits:me}){var fe,ge=e;ge.disableSSR=!0,this._replacePath;let ye=[],ve=new Map;this._material=()=>ge,this._getRelatedNodes=()=>ye,this._getWaterAnimationList=()=>ve,this.initData=function({materialOfThree:e,id:t=_y.guid(),name:i,type:n="metalness",mapType:a="metalness",color:r,map:s,mapIntensit:o=1,metalnessMap:l,metalnessIntensity:c=1,specularF0Texture:h,roughnessMap:u,roughnessIntensity:d=1,enableSpecularMap:p=!0,specularMapType:m,specularMap:f,specularMapIntensity:g=0,enableNormalMap:y,normalMapType:v,normalMap:b,normalMapFlipY:_,normalMapIntensity:x=1,enableDisplacement:w,displacementMap:S,displacementIntensity:M=1,enableOpacity:T,opacityType:A,opacityMap:E,opacityIntensity:C=1,opacityInverted:I=!1,emissive:P,enableEmissive:R,emissiveMap:O,emissiveIntensity:D=1,enableClearcoat:L,clearcoatMap:k,sheen:N,clearcoatThickness:B=0,clearcoatNormalMap:z,clearcoatNormalScale:U,clearcoatRoughness:F=0,clearcoatRoughnessMap:j,enableAOMap:H,aoMap:G,aoMapIntensity:V=1,enableLightMap:W,lightMap:Y,lightMapIntensity:X=1,enableUV:Z=!1,repeatU:q=1,repeatV:J=1,offsetU:Q=0,offsetV:K=0,enableTranslation:$=!1,translationSpeedU:ee=0,translationSpeedV:te=0,enableSSR:ie=!1,envMapIntensity:ne=1,side:ae,depth:re,waterFlowSpeed:se,waterOffsetY:oe,waterColor:le,waterOpacity:ce,waterReflectionRate:he,waterWave:ue,polygonOffset:de,polygonOffsetFactor:pe,polygonOffsetUnits:me}){this._id=t,this._name=i,this.type=n,this._mapType=a,this._color=`#${r.getHexString()}`,this._map=hy._fromThreeObject(s,this._color),this._mapIntensit=o,this._metalnessMap=hy._fromThreeObject(l),this._metalnessIntensity=c,"color"===this._metalnessMap._type&&(this._metalnessMap._source="#ffffff"),this._roughnessMap=hy._fromThreeObject(u),"color"===this._roughnessMap._type&&(this._roughnessMap._source="#ffffff"),this._roughnessIntensity=1-Number(d),this._enableSpecularMap=!0,this._specularMapType=m,this._specularMap=hy._fromThreeObject(f),"color"===this._specularMap._type&&(this._specularMap._source="#ffffff"),this._specularMapIntensity=g,this._enableNormalMap=y,y?ge.bumpMap?this._normalMapType="bump":this._normalMapType="normal":this._normalMapType="bump",this._normalMap=hy._fromThreeObject(b),this._normalMapFlipY=_,this._normalMapIntensity=x,"color"===this._normalMap._type&&(this._normalMap._source="#ffffff"),this._enableDisplacement=w,this._displacementMap=hy._fromThreeObject(S),"color"===this._displacementMap._type&&(this._displacementMap._source="#ffffff"),this._displacementIntensity=M,this._enableOpacity=T,this._opacityType=A,this._opacityMap=hy._fromThreeObject(E),this._opacityIntensity=C,this._opacityInverted=I,"color"===this._opacityMap._type&&(this._opacityMap._source="#ffffff"),this._enableEmissive=R,this._emissiveMap=hy._fromThreeObject(O),this._emissiveIntensity=D,this._emissiveMapColor="#ffffff","color"===this._emissiveMap._type&&(this._emissiveMapColor="#"+P.getHexString()),this._enableClearcoat=L,this._clearcoatMap=hy._fromThreeObject(k),this._clearcoatColor=N?`#${N.getHexString()}`:null,this._clearcoatThickness=B,this._clearcoatNormalMap=hy._fromThreeObject(z),this._clearcoatNormalMapFlipY=!!z&&z.flipY,this._clearcoatNormalScale=U?U.x:1,this._clearcoatRoughness=F,this._clearcoatRoughnessMap=hy._fromThreeObject(j),this._enableAOMap=H,this._aoMap=hy._fromThreeObject(G),this._aoMapIntensity=V,"color"===this._aoMap._type&&(this._aoMap._source="#ffffff"),this._enableLightMap=W,this._lightMap=hy._fromThreeObject(Y),this._lightMapIntensity=X,"color"===this._lightMap._type&&(this._lightMap._source="#ffffff"),this._enableUV=Z,this._repeatU=q,this._repeatV=J,this._offsetU=Q,this._offsetV=K,this._enableTranslation=$,this._translationSpeedU=ee,this._translationSpeedV=te,this._enableSSR=ie,this._envMapIntensity=ne,this.side=ae,this._depth=re,this._waterFlowSpeed=.25,this._waterOffsetY=0,this._waterColor="#001e0f",this._waterReflectionAutoUpdate=!0,this._waterReflectionQuality=512,this._waterOpacity=.65,this._waterReflectionRate=1,this._waterWave=3.7,this._polygonOffset=de,this._polygonOffsetFactor=pe,this._polygonOffsetUnits=me},this.initData({materialOfThree:e,id:t,name:i,type:n,mapType:a,color:r,map:s,mapIntensit:o,metalnessMap:l,metalnessIntensity:c,specularF0Texture:h,roughnessMap:u,roughnessIntensity:d,enableSpecularMap:p,specularMapType:m,specularMap:f,specularMapIntensity:g,enableNormalMap:y,normalMapType:v,normalMap:b,normalMapFlipY:_,normalMapIntensity:x,enableDisplacement:w,displacementMap:S,displacementIntensity:M,enableOpacity:T,opacityType:A,opacityMap:E,opacityIntensity:C,opacityInverted:I,emissive:P,enableEmissive:R,emissiveMap:O,emissiveIntensity:D,enableClearcoat:L,clearcoatMap:k,sheen:N,clearcoatThickness:B,clearcoatNormalMap:z,clearcoatNormalScale:U,clearcoatRoughness:F,clearcoatRoughnessMap:j,enableAOMap:H,aoMap:G,aoMapIntensity:V,enableLightMap:W,lightMap:Y,lightMapIntensity:X,enableUV:Z,repeatU:q,repeatV:J,offsetU:Q,offsetV:K,enableTranslation:$,translationSpeedU:ee,translationSpeedV:te,enableSSR:ie,envMapIntensity:ne,side:ae,depth:re,waterFlowSpeed:se,waterOffsetY:oe,waterColor:le,waterOpacity:ce,waterReflectionRate:he,waterWave:ue,polygonOffset:de,polygonOffsetFactor:pe,polygonOffsetUnits:me}),this.getCacheMaterial=e=>{let t=Ep.instance.defaultObjectTree.getItemByUUID(e);if(!t)return;let i=Ep.cacheStore.find(t.modelPath);if(!i)return;let n=null;return i.resource.traverse((e=>{if(e.material)if(e.material instanceof Array)for(var t of e.material)t.name==this.name&&(n=t);else e.material.name==this.name&&(n=e.material)})),n},this.addRelatedNode=function(e){this._getRelatedNodes().push(e)},this.removeRelatedNode=function(e){this._getRelatedNodes().map(((t,i)=>{t==e&&this._getRelatedNodes().splice(i,1)}))},this.addModelName=function(e){this._modelName=e},this.replace=(e,t)=>{Ep.instance.setMaterialAnimation({name:this.name,enableTranslation:!1,translationSpeedU:0,translationSpeedV:0,modelName:this._modelName}),fe||(fe=ge.clone()),"water"===this.type&&(this.type="metalness"),this.replacePath=t;let i=_y.cloneMaterial(e);if(i.name=this.name,this._getRelatedNodes()instanceof Array){for(let e of this._getRelatedNodes())if(e.material===ge)e.material.dispose(),e.material=i;else if(e.material instanceof Array)for(let t in e.material)e.material[t]===ge&&(e.material[t].dispose(),e.material[t]=i);_y.disposeMaterial(ge),ge=i}ge.needsUpdate=!0,this.initData({materialOfThree:ge,id:ge.uuid,name:ge.name,type:"metalness",mapType:"metalness",color:ge.color,map:ge.map,mapIntensit:ge.mapIntensit,metalnessMap:ge.metalnessMap,metalnessIntensity:ge.metalness,roughnessMap:ge.roughnessMap,roughnessIntensity:ge.roughness,enableSpecularMap:!!ge.envMap,specularMapType:ge.envMap?"custom":"envmap",specularMap:ge.envMap,specularMapIntensity:ge.envMapIntensity/5,enableNormalMap:!!ge.normalMap,normalMapType:"",normalMap:ge.normalMap,normalMapFlipY:ge.normalMapFlipY,normalMapIntensity:ge.normalScale?ge.normalScale.x:1,enableDisplacement:!!ge.displacementMap,displacementMap:ge.displacementMap,displacementIntensity:ge.displacementScale,enableOpacity:ge.transparent||!!ge.alphaMap,opacityType:"blend",opacityMap:ge.alphaMap,opacityIntensity:ge.opacity,opacityInverted:!1,emissive:ge.emissive||new Qt(0,0,0),enableEmissive:!!ge.emissiveMap||!!ge.emissive&&(0!==ge.emissive.r||0!==ge.emissive.g||0!==ge.emissive.b),emissiveMap:ge.emissiveMap,emissiveIntensity:ge.emissiveIntensity,enableClearcoat:ge instanceof Mo&&""===ge.defines.PHYSICAL,clearcoatMap:ge.clearcoatMap,sheen:ge.sheen,clearcoatThickness:ge.clearcoat,clearcoatNormalMap:ge.clearcoatNormalMap,clearcoatNormalScale:ge.clearcoatNormalScale,clearcoatRoughness:ge.clearcoatRoughness,clearcoatRoughnessMap:ge.clearcoatRoughnessMap,enableAOMap:!!ge.aoMap,aoMap:ge.aoMap,aoMapIntensity:ge.aoMapIntensity,enableLightMap:!!ge.lightMap,lightMap:ge.lightMap,lightMapIntensity:ge.lightMapIntensity,enableSSR:ge.enableSSR,envMapIntensity:ge.envMapIntensity,side:ge.side,depth:ge.depthTest&&ge.depthWrite?2:ge.depthTest||ge.depthWrite?1:0,polygonOffset:ge.polygonOffset,polygonOffsetFactor:ge.polygonOffsetFactor,polygonOffsetUnits:ge.polygonOffsetUnits})},this.restore=e=>{if(Ep.instance.setMaterialAnimation({name:this.name,enableTranslation:!1,translationSpeedU:0,translationSpeedV:0,modelName:this._modelName}),!fe)return;let t=this.getCacheMaterial(e),i=Ep.defaultObjectTree.getItemByUUID(e),n=null;if(t||i&&"LineItem"==i.type&&(t=i.setDefaultMaterial(),n=i.getDefaultMaterialSetting()),!t)return;"water"===this.type&&(this.type="metalness");let a=_y.cloneMaterial(t);if(this.replacePath=void 0,a.name=this.name,this._getRelatedNodes()instanceof Array){for(let e of this._getRelatedNodes())if(e.material===ge)e.material.dispose(),e.material=a;else if(e.material instanceof Array)for(let t in e.material)e.material[t]===ge&&(e.material[t].dispose(),e.material[t]=a);_y.disposeMaterial(ge),ge=a}fe.dispose();for(let e in ge)ge[e]instanceof we&&ge[e].image&&(ge[e].name||(ge[e].name=`${ge.name}#${e}`));this.initData({materialOfThree:ge,id:ge.uuid,name:ge.name,type:"metalness",mapType:"metalness",color:ge.color,map:ge.map,mapIntensit:ge.mapIntensit,metalnessMap:ge.metalnessMap,metalnessIntensity:ge.metalness,roughnessMap:ge.roughnessMap,roughnessIntensity:ge.roughness,enableSpecularMap:!!ge.envMap,specularMapType:ge.envMap?"custom":"envmap",specularMap:ge.envMap,specularMapIntensity:ge.envMapIntensity/5,enableNormalMap:!!ge.normalMap,normalMapType:"",normalMap:ge.normalMap,normalMapFlipY:ge.normalMapFlipY,normalMapIntensity:ge.normalScale?ge.normalScale.x:1,enableDisplacement:!!ge.displacementMap,displacementMap:ge.displacementMap,displacementIntensity:ge.displacementScale,enableOpacity:ge.transparent||!!ge.alphaMap,opacityType:"blend",opacityMap:ge.alphaMap,opacityIntensity:ge.opacity,opacityInverted:!1,emissive:ge.emissive||new Qt(0,0,0),enableEmissive:!!ge.emissiveMap||!!ge.emissive&&(0!==ge.emissive.r||0!==ge.emissive.g||0!==ge.emissive.b),emissiveMap:ge.emissiveMap,emissiveIntensity:ge.emissiveIntensity,enableClearcoat:ge instanceof Mo&&""===ge.defines.PHYSICAL,clearcoatMap:ge.clearcoatMap,sheen:ge.sheen,clearcoatThickness:ge.clearcoat,clearcoatNormalMap:ge.clearcoatNormalMap,clearcoatNormalScale:ge.clearcoatNormalScale,clearcoatRoughness:ge.clearcoatRoughness,clearcoatRoughnessMap:ge.clearcoatRoughnessMap,enableAOMap:!!ge.aoMap,aoMap:ge.aoMap,aoMapIntensity:ge.aoMapIntensity,enableLightMap:!!ge.lightMap,lightMap:ge.lightMap,lightMapIntensity:ge.lightMapIntensity,enableSSR:ge.enableSSR,envMapIntensity:ge.envMapIntensity,side:ge.side,depth:ge.depthTest&&ge.depthWrite?2:ge.depthTest||a.depthWrite?1:0,polygonOffset:ge.polygonOffset,polygonOffsetFactor:ge.polygonOffsetFactor,polygonOffsetUnits:ge.polygonOffsetUnits}),ge.needsUpdate=!0,n&&i.materialStore.applySettings(n)},this.toPhysicalMaterial=()=>{if(!(ge instanceof So))return;if(ge instanceof Mo)return;const e=new Mo(ge);if(e.defines.PHYSICAL="",this._getRelatedNodes()instanceof Array){for(let t of this._getRelatedNodes())if(t.material===ge)t.material.dispose(),t.material=e;else if(t.material instanceof Array)for(let i in t.material)t.material[i]===ge&&(t.material[i].dispose(),t.material[i]=e);ge=e}},this.toStandardMaterial=()=>{ge instanceof Mo&&(ge=new So(ge))}}get replacePath(){return this._replacePath}set replacePath(e){this._replacePath=e}get material(){return this._material}get id(){return this._id}get name(){return this._name}set name(e){this._name=e}get type(){return this._type}set type(e){if(e!==this._type){switch(e.toLowerCase()){case"specular":if("water"===this._type){let e=_y.findMeshByMaterial(Ep.scene,this._material());e&&e.length||Ep.materialPreview&&Ep.materialPreview.scene&&(e=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let t of e){let e=t.getObjectByName(t.name+this._material().name+"_water_");if(e&&(_y.removeFromObjectsNeedsUpdate(e),e.geometry.dispose(),e.material.dispose(),t.remove(e),this._getWaterAnimationList())){let e=this._getWaterAnimationList().get(t);e&&(e.needsRemove=!0)}t.position.y-=this._waterOffsetY}this._material().transparent=this._material().userData.transparent,this._material().opacity=this._material().userData.opacity}let t={"skybox-blue":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-blue07":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day2":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-dusk":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-night":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-real":"texture/cubemap/CubeMap-CityDay-01_Cube.dds","skybox-day-10":"texture/cubemap/skybox-day-10/specularmap.dds","skybox-day-18":"texture/cubemap/skybox-day-18/specularmap.dds","skybox-dusk-4":"texture/cubemap/skybox-dusk-4/specularmap.dds","skybox-dusk-6":"texture/cubemap/skybox-dusk-6/specularmap.dds","skybox-night-3":"texture/cubemap/skybox-night-3/specularmap.dds","skybox-night-24":"texture/cubemap/skybox-night-24/specularmap.dds"},i=Ep.instance&&Ep.instance.getSkyboxName&&Ep.instance.getSkyboxName()||null;if(!i||""===i)return;let n=t[i]||"texture/cubemap/CubeMap-CityDay-01_Cube.dds";if(n){let e=(new tu).load(this.url(n),(function(e){e.magFilter=b,e.minFilter=b,e.mapping=s}));if(this._material().envMap=e,this.specularMapIntensity=.4,this._material().envMap.needsUpdate=!0,this._material().needsUpdate=!0,this._copies instanceof Array)for(let t of this._copies)t.envMap=e,t.envMapIntensity=2,t.envMap.needsUpdate=!0}if("custom"===this._specularMapType){if(this._material().envMap=null,this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)e.envMap=null;this.specularMap=this._specularMap}break;case"water":if("specular"===this._type&&("envmap"===this._specularMapType?this._material().envMap=void 0:"regular"===this._specularMapType&&(this.specularMap=this._specularMap),this.specularMapIntensity=.2,this._material().needsUpdate=!0,this._copies instanceof Array))for(let e of this._copies)e.envMap=null,e.envMapIntensity=1;let a=_y.findMeshByMaterial(Ep.scene,this._material(),this._copies);a&&a.length||Ep.materialPreview&&Ep.materialPreview.scene&&(a=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let e of a){if(e.isWater=!0,e.parent instanceof Et){let t=e.parent.getObjectByName(e.parent.name+this._material().name+"_water_");if(t instanceof Fi&&(t.geometry.dispose(),t.material.dispose(),t.parent.remove(t),this._getWaterAnimationList())){let t=this._getWaterAnimationList().get(e);t&&(t.needsRemove=!0)}}for(let t=0;t<e.children.length;t++)if(-1!=e.children[t].name.indexOf(e.name+this._material().name+"_water_")&&(_y.removeFromObjectsNeedsUpdate(e.children[t]),e.children[t].geometry.dispose(),e.children[t].material.dispose(),e.remove(e.children[t]),t--,this._getWaterAnimationList())){let t=this._getWaterAnimationList().get(e);t&&(t.needsRemove=!0)}if(e.geometry,e.geometry instanceof wi){let t=e.geometry.clone();if(e.geometry.groups.length>0){let i=0;for(let t in e.material)e.material[t]===this._material()&&(i=parseInt(t));let n=e.geometry.groups.find((e=>e.materialIndex===i));t.clearGroups(),t.addGroup(n.start,n.count,0),t.setDrawRange(n.start,n.count)}let i=new db(t,{textureWidth:this.waterReflectionQuality,textureHeight:this.waterReflectionQuality,waterNormals:(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/water/waternormals.jpg"),(function(e){e.wrapS=e.wrapT=d})),alpha:this.waterOpacity||.65,sunDirection:new Ce,sunColor:16777215,waterColor:this.waterColor||7695,distortionScale:this.waterWave||3.7,fog:!0,reflectionRate:this.waterReflectionRate||1,yUp:!0,reflectionAutoUpdate:this.waterReflectionAutoUpdate});i.name=e.name+this._material().name+"_water_";const n=.39*Math.PI,a=2*Math.PI*(.205-.5);let r=new Ce;r.x=Math.cos(a),r.y=Math.sin(a)*Math.sin(n),r.z=Math.sin(a)*Math.cos(n),i.receiveShadow=!0,i.material.transparent=!0,i.material.uniforms.sunDirection.value.copy(r).normalize(),i.needsUpdate=!0,e.add(i),_y.addToObjectsNeedsUpdate(i),e.userData.y=e.position.y,e.position.y=e.userData.y+this._waterOffsetY;let s=new kv(i.material,this.waterFlowSpeed||.25);this._getWaterAnimationList().set(e,s),Ep.animationStore&&Ep.animationStore.add(s)}}if(this._material().userData||(this._material().userData={}),this._material(),this._material().userData.transparent=this._material().transparent,this._material().userData.opacity=this._material().opacity,this._material().transparent=!0,this._material().opacity=0,this._copies instanceof Array)for(let e of this._copies)e.userData||(e.userData={}),e.userData.transparent=e.transparent,e.userData.opacity=e.opacity,e.transparent=!0,e.opacity=0;break;case"metalness":if("water"===this._type){let e=_y.findMeshByMaterial(Ep.scene,this._material(),this._copies);e&&e.length||Ep.materialPreview&&Ep.materialPreview.scene&&(e=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let t of e){let e=t.getObjectByName(t.name+this._material().name+"_water_");if(e&&(_y.removeFromObjectsNeedsUpdate(e),e.geometry.dispose(),e.material.dispose(),t.remove(e),this._getWaterAnimationList())){let e=this._getWaterAnimationList().get(t);e&&(e.needsRemove=!0)}t.position.y-=this._waterOffsetY}if(this._material().transparent=this._material().userData.transparent,this._material().opacity=this._material().userData.opacity,this._copies instanceof Array)for(let e of this._copies)e.transparent=e.userData.transparent,e.opacity=e.userData.opacity}if("specular"===this._type&&(this._type=e,"envmap"===this._specularMapType?this._material().envMap=void 0:"regular"===this._specularMapType&&(this.specularMap=this._specularMap),this.specularMapIntensity=.2,this._material().needsUpdate=!0,this._copies instanceof Array))for(let e of this._copies)e.envMap=null,e.envMapIntensity=1}this._type=e}}get mapType(){return this._mapType}set mapType(e){}get color(){return logger.debug("TRACE: Material.color (getter) - Entering."),this._color}set color(e){logger.debug("TRACE: Material.color (setter) - Entering."),logger.debug("TRACE: Material.color (setter) - Exiting."),this._color=e;let t=new Qt(e);if(this._material()){if(this._material().color){let e=_y.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit}else{this._material().color=t;let e=_y.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit}this._material().needsUpdate=!0}if(this._copies instanceof Array)for(let e of this._copies)if(e)if(e.color){let t=_y.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit}else{e.color=new Qt(t);let t=_y.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit}}get map(){return logger.debug("TRACE: Material.map (getter) - Entering."),logger.debug("TRACE: Material.map (getter) - Exiting."),void 0===this._map._source&&"imagebitmap"===this._map._type&&(this._map._source=this._color,this._map._type="color"),this._map}set map({type:e="color",source:t="#ffffff",reset:i=!1}){if(logger.debug("TRACE: Material.map (setter) - Entering."),"color"===e.toLowerCase()){if(!_y.isCSSColor(t))return void logger.debug("TRACE: Material.map (setter) - Exiting.");if(this._map._source?this._map._name=this._map._source._name:this._map._name=null,this._color=t,this._material())if(this._material().map&&(this._material().needsUpdate=!0),this._material().color){let e=_y.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit,this._material().map=null}else{this._material().color=new Qt(this._color);let e=_y.colorToRGBAObject(this._color);this._material().color.r=e.r*this._mapIntensit,this._material().color.g=e.g*this._mapIntensit,this._material().color.b=e.b*this._mapIntensit,this._material().map=null}if(this._copies instanceof Array)for(let e of this._copies)if(e)if(e.color){let t=_y.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit,e.map=null}else{e.color=new Qt(this._color);let t=_y.colorToRGBAObject(this._color);e.color.r=t.r*this._mapIntensit,e.color.g=t.g*this._mapIntensit,e.color.b=t.b*this._mapIntensit,e.map=null}if(i){if(this._map._type="imagebitmap",this._map._name=void 0,this._map._source=void 0,this._material()&&this._material().map&&(this._material().map.dispose(),this._material().map=null,this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&e.map&&(e.map.dispose(),e.map=null);logger.debug("TRACE: Material.map (setter) - Exiting.")}return Ep.defaultObjectTree.children.map((e=>{"LineItem"==e.type&&e.update()})),void logger.debug("TRACE: Material.map (setter) - Exiting.")}if("imagebitmap"===e.toLowerCase()){if(t&&"#ffffff"!==t&&""!==t){if(this._map.type="imagebitmap",this._map._name=t.name,this._map.source=t,this._material()&&(this._material().map?this._material().map.image!==t.textureSource&&(this._material().map=this._material().map.clone(),this._material().map.image=t.textureSource,this._material().map.name=t.name,this._material().map.needsUpdate=!0):(this._material().map=new we(t.textureSource),this._material().map.name=t.name,this._material().map.encoding=3001,this._material().map.flipY=!1,this._material().map.format=1022,this._material().map.version=10,this._material().needsUpdate=!0),"number"==typeof this._map.source._wrapS&&this._map.source._wrapS>=1e3&&(this._material().map.wrapS=this._map.source._wrapS),"number"==typeof this._map.source._wrapT&&this._map.source._wrapT>=1e3&&(this._material().map.wrapT=this._map.source._wrapT),this.enableUV&&(this.enableUV=!0),this._material().color?this._material().color.setStyle(this._color):this._material().color=new Qt(this._color)),this._copies instanceof Array)for(let e of this._copies)e&&(e.map?(e.map=e.map.clone(),e.map.image=t.textureSource,e.map.name=t.name):(e.map=new we(t.textureSource),e.map.name=t.name,e.map.encoding=3001,e.map.flipY=!1,e.map.format=1022,e.map.version=10),"number"==typeof this._map.source._wrapS&&this._map.source._wrapS>=1e3&&(e.map.wrapS=this._map.source._wrapS),"number"==typeof this._map.source._wrapT&&this._map.source._wrapT>=1e3&&(e.map.wrapT=this._map.source._wrapT),this.enableUV&&(this.enableUV=!0),e.color?e.color.setStyle(this._color):e.color=new Qt(this._color));return this.mapIntensit=this.mapIntensit,Ep.defaultObjectTree.children.map((e=>{"LineItem"==e.type&&e.update()})),void logger.debug("TRACE: Material.map (setter) - Exiting.")}if(this._map._type="imagebitmap",this._map._name="",this._map._source="",this._material()&&this._material().map&&(this._material().map.dispose&&this._material().map.dispose(),this._material().map=void 0,this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&e.map&&(e.map.dispose&&e.map.dispose(),e.map=void 0,e.needsUpdate=!0);return Ep.defaultObjectTree.children.map((e=>{"LineItem"==e.type&&e.update()})),void logger.debug("TRACE: Material.map (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.map (setter) - Exiting.")}get mapIntensit(){return logger.debug("TRACE: Material.mapIntensit (getter) - Entering."),this._mapIntensit}set mapIntensit(e){if(logger.debug("TRACE: Material.mapIntensit (setter) - Entering."),logger.debug("TRACE: Material.mapIntensit (setter) - Exiting."),this._mapIntensit=e,this._material()){if(this._color){let t=_y.colorToRGBAObject(this._color);this._material().color.r=t.r*e,this._material().color.g=t.g*e,this._material().color.b=t.b*e}this._material().needsUpdate=!0}if(this._copies instanceof Array)for(let t of this._copies)if(t&&this._color){let i=_y.colorToRGBAObject(this._color);t.color.r=i.r*e,t.color.g=i.g*e,t.color.b=i.b*e}}get metalnessMap(){return logger.debug("TRACE: Material.metalnessMap (getter) - Entering."),logger.debug("TRACE: Material.metalnessMap (getter) - Exiting."),this._metalnessMap}set metalnessMap({type:e,source:t}){if(logger.debug("TRACE: Material.metalnessMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Tb){if(this._metalnessMap.type="imagebitmap",this._metalnessMap._name=t.name,this._metalnessMap.source=t,this._material()&&(this._material().metalnessMap&&this._material().metalnessMap.image!==this._metalnessMap.source.textureSource?(this._material().metalnessMap.image=this._metalnessMap.source.textureSource,this._material().metalnessMap.name=this._metalnessMap.source.name,this._material().metalnessMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().metalnessMap||(this._material().metalnessMap=new we(this._metalnessMap.source.textureSource),this._material().metalnessMap.name=this._metalnessMap.source.name,this._material().metalnessMap.flipY=!1,this._material().metalnessMap.needsUpdate=!0,this._material().needsUpdate=!0),"number"==typeof this._metalnessMap.source._wrapS&&this._metalnessMap.source._wrapS>=1e3&&(this._material().metalnessMap.wrapS=this._metalnessMap.source._wrapS),"number"==typeof this._metalnessMap.source._wrapT&&this._metalnessMap.source._wrapT>=1e3&&(this._material().metalnessMap.wrapT=this._metalnessMap.source._wrapT),this.enableUV&&(this.enableUV=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(e.metalnessMap?(e.metalnessMap.image=this._metalnessMap.source.textureSource,e.metalnessMap.name=this._metalnessMap.source.name):(e.metalnessMap=new we(this._metalnessMap.source.textureSource),e.metalnessMap.name=this._metalnessMap.source.name,e.metalnessMap.flipY=!1),"number"==typeof this._metalnessMap.source._wrapS&&this._metalnessMap.source._wrapS>=1e3&&(e.metalnessMap.wrapS=this._metalnessMap.source._wrapS),"number"==typeof this._metalnessMap.source._wrapT&&this._metalnessMap.source._wrapT>=1e3&&(e.metalnessMap.wrapT=this._metalnessMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.metalnessMap.needsUpdate=!0),e.needsUpdate=!0;logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}else{if("imagebitmap"===e.toLowerCase()&&!t){if(this._material()&&(this._material().metalnessMap=null,this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&(e.metalnessMap=null),e.needsUpdate=!0;return this._metalnessMap.type="imagebitmap",this._metalnessMap._name="",this._metalnessMap.source="",void logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}}get metalnessIntensity(){return logger.debug("TRACE: Material.metalnessIntensity (getter) - Entering."),logger.debug("TRACE: Material.metalnessIntensity (getter) - Exiting."),this._metalnessIntensity}set metalnessIntensity(e){if(logger.debug("TRACE: Material.metalnessIntensity (setter) - Entering."),this._metalnessIntensity=e,this._material().metalness=this._metalnessIntensity,this._copies instanceof Array)for(let e of this._copies)e.metalness=this._metalnessIntensity;logger.debug("TRACE: Material.metalnessIntensity (setter) - Exiting.")}get roughnessMap(){return logger.debug("TRACE: Material.roughnessMap (getter) - Entering."),logger.debug("TRACE: Material.roughnessMap (getter) - Exiting."),this._roughnessMap}set roughnessMap({type:e,source:t}){if(logger.debug("TRACE: Material.roughnessMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Tb){if(this._roughnessMap.type="imagebitmap",this._roughnessMap._name=t.name,this._roughnessMap.source=t,this._material()&&(this._material().roughnessMap&&this._material().roughnessMap.image!==this._roughnessMap.source.textureSource?(this._material().roughnessMap.image=this._roughnessMap.source.textureSource,this._material().roughnessMap.name=this._roughnessMap.source.name,this._material().roughnessMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().roughnessMap||(this._material().roughnessMap=new we(this._roughnessMap.source.textureSource),this._material().roughnessMap.name=this._roughnessMap.source.name,this._material().roughnessMap.flipY=!1,this._material().roughnessMap.needsUpdate=!0,this._material().needsUpdate=!0),"number"==typeof this._roughnessMap.source._wrapS&&this._roughnessMap.source._wrapS>=1e3&&(this._material().roughnessMap.wrapS=this._roughnessMap.source._wrapS),"number"==typeof this._roughnessMap.source._wrapT&&this._roughnessMap.source._wrapT>=1e3&&(this._material().roughnessMap.wrapT=this._roughnessMap.source._wrapT),this.enableUV&&(this.enableUV=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(e.roughnessMap?(e.roughnessMap.image=this._roughnessMap.source.textureSource,e.roughnessMap.name=this._roughnessMap.source.name):(e.roughnessMap=new we(this._roughnessMap.source.textureSource),e.roughnessMap.name=this._roughnessMap.source.name,e.roughnessMap.flipY=!1),"number"==typeof this._roughnessMap.source._wrapS&&this._roughnessMap.source._wrapS>=1e3&&(e.roughnessMap.wrapS=this._roughnessMap.source._wrapS),"number"==typeof this._roughnessMap.source._wrapT&&this._roughnessMap.source._wrapT>=1e3&&(e.roughnessMap.wrapT=this._roughnessMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.roughnessMap.needsUpdate=!0);logger.debug("TRACE: Material.roughnessMap (setter) - Exiting.")}else{if("imagebitmap"===e.toLowerCase()&&!t){if(this._material()&&(this._material().roughnessMap=null,this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&(e.roughnessMap=null);return this._roughnessMap.type="imagebitmap",this._roughnessMap._name="",this._roughnessMap.source="",void logger.debug("TRACE: Material.metalnessMap (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.roughnessMap (setter) - Exiting.")}}get roughnessIntensity(){return logger.debug("TRACE: Material.roughnessIntensity (getter) - Entering."),logger.debug("TRACE: Material.roughnessIntensity (getter) - Exiting."),this._roughnessIntensity}set roughnessIntensity(e){if(logger.debug("TRACE: Material.roughnessIntensity (setter) - Entering."),this._roughnessIntensity=e,this._material().roughness=1-Number(this._roughnessIntensity),this._copies instanceof Array)for(let e of this._copies)e.roughness=1-Number(this._roughnessIntensity);logger.debug("TRACE: Material.roughnessIntensity (setter) - Exiting.")}get enableSpecularMap(){return logger.debug("TRACE: Material.enableSpecularMap (getter) - Entering."),logger.debug("TRACE: Material.enableSpecularMap (getter) - Exiting."),this._enableSpecularMap}set enableSpecularMap(e){if(logger.debug("TRACE: Material.enableSpecularMap (setter) - Entering."),"specular"!==this._type)if("boolean"==typeof e){if(this._enableSpecularMap=e,this._enableSpecularMap)this.specularMap=this._specularMap;else if("specular"!==this.type&&(this._material()&&(this._material().envMap=null,this._material().needsUpdate=!0),this._copies instanceof Array))for(let e of this._copies)e.envMap=null;logger.debug("TRACE: Material.enableSpecularMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableSpecularMap (setter) - Exiting.");else logger.debug("TRACE: Material.enableSpecularMap (setter) - Exiting.")}get specularMapType(){return this._specularMapType}set specularMapType(e){this._specularMapType=e,"specular"!==this._type?"envmap"===e?(this._material().envMap=void 0,this._material().needsUpdate=!0):"regular"===e&&(this.specularMap=this._specularMap):logger.debug("TRACE: Material.specularMapType (setter) - Exiting.")}get specularMap(){return logger.debug("TRACE: Material.specularMap (getter) - Entering."),logger.debug("TRACE: Material.specularMap (getter) - Exiting."),this._specularMap}set specularMap({type:e,source:t}){if(logger.debug("TRACE: Material.specularMap (setter) - Entering."),"specular"!==this._type)if("color"===e.toLowerCase()&&(this._material().envMap=void 0,this._material().needsUpdate=!0),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t)){if(this._specularMap.type="imagebitmap",this._specularMap._name=t.name,this._specularMap.source=t,"envmap"===this._specularMapType)return void logger.debug("TRACE: Material.specularMap (setter) - Exiting.");if("specular"===this._type)return void logger.debug("TRACE: Material.specularMap (setter) - Exiting.");if(!this._enableSpecularMap)return void logger.debug("TRACE: Material.specularMap (setter) - Exiting.");if(this._material()&&(t?(this._material().envMap=new we(this._specularMap.source.textureSource),this._material().envMap.name=this._specularMap.source.name,this._material().envMap.flipY=!1,this._material().envMap.mapping=l,this._material().envMap.needsUpdate=!0,this._material().needsUpdate=!0):(this._material().envMap=void 0,this._material().needsUpdate=!0)),this._copies instanceof Array)for(let e of this._copies)if(e){let t=(new tu).load(this.url("texture/cubemap/CubeMap-CityDay-01_Cube.dds"),(function(e){e.magFilter=b,e.minFilter=b,e.mapping=s}));e.envMap=t,e.envMap.needsUpdate=!0}logger.debug("TRACE: Material.specularMap (setter) - Exiting.")}else if("file"!==e.toLowerCase()||"string"!=typeof t||""===t)logger.debug("TRACE: Material.specularMap (setter) - Exiting.");else{if(this._material()){if(this._specularMap.type="file",this._specularMap.source=t,this._material().envMap){let e=(new tu).load(this.url(t),(function(e){e.magFilter=b,e.minFilter=b,e.mapping=s}));this._material().envMap=e}else{let e=(new tu).load(this.url(t),(function(e){e.magFilter=b,e.minFilter=b,e.mapping=s}));this._material().envMap=e}this._material().envMap.needsUpdate=!0}if(this._copies instanceof Array)for(let e of this._copies)if(e){if(this._specularMap.type="file",this._specularMap.source=t,e.envMap){let i=(new tu).load(this.url(t),(function(e){e.magFilter=b,e.minFilter=b,e.mapping=s}));e.envMap=i}else{let i=(new tu).load(this.url(t),(function(e){e.magFilter=b,e.minFilter=b,e.mapping=s}));e.envMap=i}e.envMap.needsUpdate=!0}logger.debug("TRACE: Material.specularMap (setter) - Exiting.")}else logger.debug("TRACE: Material.specularMap (setter) - Exiting.")}get specularMapIntensity(){return logger.debug("TRACE: Material.specularMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.specularMapIntensity (getter) - Exiting."),this._specularMapIntensity}set specularMapIntensity(e){if(logger.debug("TRACE: Material.specularMapIntensity (setter) - Entering."),this._specularMapIntensity=e,logger.debug("TRACE: Material.specularMapIntensity (setter) - Exiting."),this._material().envMapIntensity=5*this._specularMapIntensity,this._copies instanceof Array)for(let e of this._copies)e.envMapIntensity=5*this._specularMapIntensity}get enableNormalMap(){return logger.debug("TRACE: Material.enableNormalMap (getter) - Entering."),logger.debug("TRACE: Material.enableNormalMap (getter) - Exiting."),this._enableNormalMap}set enableNormalMap(e){if(logger.debug("TRACE: Material.enableNormalMap (setter) - Entering."),"boolean"==typeof e){if(this._enableNormalMap=e,this._enableNormalMap)this.normalMap={type:this._normalMap.type,source:this._normalMap.source,name:this._normalMap.name};else if(this._material().normalMap=null,this._material().bumpMap=null,this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)e.normalMap=null,e.bumpMap=null;logger.debug("TRACE: Material.enableNormalMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableNormalMap (setter) - Exiting.")}get normalMapType(){return logger.debug("TRACE: Material.normalMapType (getter) - Entering."),logger.debug("TRACE: Material.normalMapType (getter) - Exiting."),this._normalMapType}set normalMapType(e){if(logger.debug("TRACE: Material.normalMapType (setter) - Entering."),this._normalMapType=e,this._enableNormalMap){if(logger.debug("TRACE: Material.normalMapType (setter) - Exiting."),this._material()&&"imagebitmap"===this._normalMap.type&&("normal"===this._normalMapType?(this._material().bumpMap=null,this._material().bumpScale=0,this._normalMap.source?(this._material().normalMap?this._normalMap.source.textureSource?(this._material().normalMap.image=this._normalMap.source.textureSource,this._material().normalMap.name=this._normalMap.source.name):(this._material().normalMap.image=this._normalMap.source,this._material().normalMap.name=this._normalMap.name):(this._material().normalMap=new we(this._normalMap.source.textureSource||this._normalMap.source),this._material().normalMap.name=this._normalMap.source.name||this._normalMap.name,this._material().normalMap.flipY=!1,this._material().normalMap.encoding=3001,this._material().normalMap.format=1022,this._material().normalMap.version=10),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(this._material().normalMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(this._material().normalMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._material().normalMap.needsUpdate=!0):this._material().normalMap=null,this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(this._material().normalMap=null,this._normalMap.source?(this._material().bumpMap?this._normalMap.source.textureSource?(this._material().bumpMap.image=this._normalMap.source.textureSource,this._material().bumpMap.name=this._normalMap.source.name):(this._material().bumpMap.image=this._normalMap.source,this._material().bumpMap.name=this._normalMap.name):(this._material().bumpMap=new we(this._normalMap.source.textureSource||this._normalMap.source),this._material().bumpMap.name=this._normalMap.source.name||this._normalMap.name,this._material().bumpMap.encoding=3001,this._material().bumpMap.flipY=!1,this._material().bumpMap.format=1022,this._material().bumpMap.version=10),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(this._material().bumpMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(this._material().bumpMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._material().bumpMap.needsUpdate=!0):this._material().bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=10&&(this._material().bumpScale=this._normalMapIntensity)),this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&"imagebitmap"===this._normalMap.type&&("normal"===this._normalMapType?(e.bumpMap=null,e.bumpScale=0,this._normalMap.source?(e.normalMap?this._normalMap.source.textureSource?(e.normalMap.image=this._normalMap.source.textureSource,e.normalMap.name=this._normalMap.source.name):e.normalMap.image=this._normalMap.source:(e.normalMap=new we(this._normalMap.source.textureSource),e.normalMap.name=this._normalMap.source.name,e.normalMap.flipY=!1,e.normalMap.encoding=3001,e.normalMap.format=1022,e.normalMap.version=10,this.enableUV&&(this.enableUV=!0)),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(e.normalMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(e.normalMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.normalMap.needsUpdate=!0):e.normalMap=null,e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(e.normalMap=null,this._normalMap.source?(e.bumpMap?this._normalMap.source.textureSource?(e.bumpMap.image=this._normalMap.source.textureSource,e.bumpMap.name=this._normalMap.source.name):(e.bumpMap.image=this._normalMap.source,e.bumpMap.name=this._normalMap.name):(e.bumpMap=new we(this._normalMap.source.textureSource),e.bumpMap.name=this._normalMap.source.name,e.bumpMap.encoding=3001,e.bumpMap.flipY=!1,e.bumpMap.format=1022,e.bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(e.bumpMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(e.bumpMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.bumpMap.needsUpdate=!0):e.bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=10&&(e.bumpScale=this._normalMapIntensity)))}else logger.debug("TRACE: Material.normalMapType (setter) - Exiting.")}get normalMap(){return logger.debug("TRACE: Material.normalMap (getter) - Entering."),logger.debug("TRACE: Material.normalMap (getter) - Exiting."),this._normalMap}set normalMap({type:e,source:t,name:i=""}){if(logger.debug("TRACE: Material.normalMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t||void 0===t)){if(this._normalMap.type="imagebitmap",t&&t.name?this._normalMap._name=t.name:this._normalMap._name=""!==i?i:null,t&&(this._normalMap.name=t.name,this._normalMap.source=t),""!==t&&void 0!==t||(this._normalMap.source=void 0),!this._enableNormalMap)return void logger.debug("TRACE: Material.normalMap (setter) - Exiting.");if(this._material()&&("normal"===this._normalMapType?(this._material().bumpMap=null,this._normalMap.source?(this._material().normalMap?this._normalMap.source.textureSource?(this._material().normalMap.image=this._normalMap.source.textureSource,this._material().normalMap.name=this._normalMap.source.name):(this._material().normalMap.image=this._normalMap.source,this._material().normalMap.name=this._normalMap.name):(this._material().normalMap=new we(this._normalMap.source.textureSource),this._material().normalMap.name=this._normalMap.source.name,this._material().normalMap.encoding=3001,this._material().normalMap.flipY=!1,this._material().normalMap.format=1022,this._material().normalMap.version=10,this.enableUV&&(this.enableUV=!0)),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(this._material().normalMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(this._material().normalMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._material().normalMap.needsUpdate=!0):this._material().normalMap=null,this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(this._material().normalMap=null,this._normalMap.source?(this._material().bumpMap?this._normalMap.source.textureSource?(this._material().bumpMap.image=this._normalMap.source.textureSource,this._material().bumpMap.name=this._normalMap.source.name):(this._material().bumpMap.image=this._normalMap.source,this._material().bumpMap.name=this._normalMap.name):(this._material().bumpMap=new we(this._normalMap.source.textureSource),this._material().bumpMap.name=this._normalMap.source.name,this._material().bumpMap.encoding=3001,this._material().bumpMap.flipY=!1,this._material().bumpMap.format=1022,this._material().bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(this._material().bumpMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(this._material().bumpMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._material().bumpMap.needsUpdate=!0):this._material().bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=10&&(this._material().bumpScale=this._normalMapIntensity)),this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)e&&("normal"===this._normalMapType?(e.bumpMap=null,this._normalMap.source?(e.normalMap?this._normalMap.source.textureSource?(e.normalMap.image=this._normalMap.source.textureSource,e.normalMap.name=this._normalMap.source.name):(e.normalMap.image=this._normalMap.source,e.normalMap.name=this._normalMap.name):(e.normalMap=new we(this._normalMap.source.textureSource||this._normalMap.source),e.normalMap.name=this._normalMap.source.name||this._normalMap.name,e.normalMap.encoding=3001,e.normalMap.flipY=!1,e.normalMap.format=1022,e.normalMap.version=10,this.enableUV&&(this.enableUV=!0)),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(e.normalMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(e.normalMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.normalMap.needsUpdate=!0):e.normalMap=null,e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity)):"bump"===this._normalMapType&&(e.normalMap=null,this._normalMap.source?(e.bumpMap?this._normalMap.source.textureSource?(e.bumpMap.image=this._normalMap.source.textureSource,e.bumpMap.name=this._normalMap.source.name):(e.bumpMap.image=this._normalMap.source,e.bumpMap.name=this._normalMap.name):(e.bumpMap=new we(this._normalMap.source.textureSource||this._normalMap.source),e.bumpMap.name=this._normalMap.source.name||this._normalMap.name,e.bumpMap.encoding=3001,e.bumpMap.flipY=!1,e.bumpMap.format=1022,e.bumpMap.version=10,this.enableUV&&(this.enableUV=!0)),"number"==typeof this._normalMap.source._wrapS&&this._normalMap.source._wrapS>=1e3&&(e.bumpMap.wrapS=this._normalMap.source._wrapS),"number"==typeof this._normalMap.source._wrapT&&this._normalMap.source._wrapT>=1e3&&(e.bumpMap.wrapT=this._normalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.bumpMap.needsUpdate=!0):e.bumpMap=null,this._normalMapIntensity>=0&&this._normalMapIntensity<=10&&(e.bumpScale=this._normalMapIntensity)));logger.debug("TRACE: Material.normalMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.normalMap (setter) - Exiting.")}get normalMapIntensity(){return logger.debug("TRACE: Material.normalMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.normalMapIntensity (getter) - Exiting."),this._normalMapIntensity}set normalMapIntensity(e){if(logger.debug("TRACE: Material.normalMapIntensity (setter) - Entering."),this._normalMapIntensity=e,this._enableNormalMap){if("normal"===this._normalMapType?this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity):"bump"===this._normalMapType&&this._normalMapIntensity>=0&&this._normalMapIntensity<=10&&(this._material().bumpScale=this._normalMapIntensity),this._material()&&(this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)"normal"===this._normalMapType?e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity):"bump"===this._normalMapType&&this._normalMapIntensity>=0&&this._normalMapIntensity<=10&&(e.bumpScale=this._normalMapIntensity);logger.debug("TRACE: Material.normalMapIntensity (setter) - Exiting.")}else logger.debug("TRACE: Material.normalMapIntensity (setter) - Exiting.")}get normalMapTextureFlipY(){return logger.debug("TRACE: Material.normalMapTextureFlipY (getter) - Entering."),logger.debug("TRACE: Material.normalMapTextureFlipY (getter) - Exiting."),this._normalMapTextureFlipY}set normalMapTextureFlipY(e){if(logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Entering."),"boolean"==typeof e)if(this._normalMapTextureFlipY=e,this._enableNormalMap){if(this._material().normalScale?(this._material().normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._material().normalScale.y=this._material().normalScale.x):this._material().normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity),this._copies instanceof Array)for(let e of this._copies)e.normalScale?(e.normalScale.x=this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,e.normalScale.y=e.normalScale.x):e.normalScale=new ye(this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity,this._normalMapTextureFlipY?-this._normalMapIntensity:this._normalMapIntensity);logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Exiting.")}else logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Exiting.");else logger.debug("TRACE: Material.normalMapTextureFlipY (setter) - Exiting.")}get enableDisplacement(){return logger.debug("TRACE: Material.enableDisplacement (getter) - Entering."),logger.debug("TRACE: Material.enableDisplacement (getter) - Exiting."),this._enableDisplacement}set enableDisplacement(e){if(logger.debug("TRACE: Material.enableDisplacement (setter) - Entering."),"boolean"==typeof e){if(this._enableDisplacement=e,this._enableDisplacement)this.displacementMap=this._displacementMap;else if(this._material().displacementMap=null,this._copies instanceof Array)for(let e of this._copies)e.displacementMap=null;this._material()&&(this._material().needsUpdate=!0),logger.debug("TRACE: Material.enableDisplacement (setter) - Exiting.")}else logger.debug("TRACE: Material.enableDisplacement (setter) - Exiting.")}get displacementMap(){return logger.debug("TRACE: Material.displacementMap (getter) - Entering."),logger.debug("TRACE: Material.displacementMap (getter) - Exiting."),this._displacementMap}set displacementMap({type:e,source:t}){if(logger.debug("TRACE: Material.displacementMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t)){if(this._displacementMap.type="imagebitmap",this._displacementMap._name=t.name,t instanceof Tb&&(this._displacementMap.source=t),""===t&&(this._displacementMap.source=void 0),!this._enableDisplacement)return void logger.debug("TRACE: Material.displacementMap (setter) - Exiting.");if(this._material()&&(this._displacementMap.source?this._material().displacementMap&&this._material().displacementMap.image!==this._displacementMap.source.textureSource?(this._material().displacementMap.image=this._displacementMap.source.textureSource,this._material().displacementMap.name=this._displacementMap.source.name,this._material().displacementMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().displacementMap||(this._material().displacementMap=new we(this._displacementMap.source.textureSource),this._material().displacementMap.name=this._displacementMap.source.name,this._material().displacementMap.flipY=!1,this.enableUV&&(this.enableUV=!0),this._material().displacementMap.needsUpdate=!0,this._material().needsUpdate=!0):(this._material().displacementMap=null,this._material().needsUpdate=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(this._displacementMap.source?(e.displacementMap?(e.displacementMap.image=this._displacementMap.source.textureSource,e.displacementMap.name=this._displacementMap.source.name):(e.displacementMap=new we(this._displacementMap.source.textureSource),e.displacementMap.name=this._displacementMap.source.name,e.displacementMap.flipY=!1,this.enableUV&&(this.enableUV=!0)),e.displacementMap.needsUpdate=!0):e.displacementMap=null);logger.debug("TRACE: Material.displacementMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.displacementMap (setter) - Exiting.")}get displacementIntensity(){return logger.debug("TRACE: Material.displacementIntensity (getter) - Entering."),logger.debug("TRACE: Material.displacementIntensity (getter) - Exiting."),this._displacementIntensity}set displacementIntensity(e){if(logger.debug("TRACE: Material.displacementIntensity (setter) - Entering."),this._displacementIntensity=e,this._material().displacementScale=this._displacementIntensity,this._copies instanceof Array)for(let e of this._copies)e.displacementScale=this._displacementIntensity;logger.debug("TRACE: Material.displacementIntensity (setter) - Exiting.")}get enableOpacity(){return logger.debug("TRACE: Material.enableOpacity (getter) - Entering."),logger.debug("TRACE: Material.enableOpacity (getter) - Exiting."),this._enableOpacity}set enableOpacity(e){if(logger.debug("TRACE: Material.enableOpacity (setter) - Entering."),"boolean"==typeof e){if("water"!==this._type){if(this._enableOpacity=e,this._enableOpacity?(this._material().transparent=!0,this._material().opacity=this._opacityIntensity,this.opacityMap=this._opacityMap):(this._material().transparent=!1,this._material().opacity=1,this._material().alphaMap=null,this._material().needsUpdate=!0),this._copies instanceof Array)for(let e of this._copies)this._enableOpacity?(e.transparent=!0,e.opacity=this._opacityIntensity,this.opacityMap=this._opacityMap):(e.transparent=!1,e.opacity=1,e.alphaMap=null);logger.debug("TRACE: Material.enableOpacity (setter) - Exiting.")}}else logger.debug("TRACE: Material.enableOpacity (setter) - Exiting.")}get opacityType(){return logger.debug("TRACE: Material.opacityType (getter) - Entering."),logger.debug("TRACE: Material.opacityType (getter) - Exiting."),this._opacityType}set opacityType(e){if(logger.debug("TRACE: Material.opacityType (setter) - Entering."),"string"==typeof e){switch(e.toLowerCase()){case"blend":case"mask":case"refraction":case"refracting":break;default:return void logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}switch(this._opacityType=e,this._opacityType.toLowerCase()){case"blend":case"mask":case"refraction":case"refracting":break;default:return void logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}else logger.debug("TRACE: Material.opacityType (setter) - Exiting.")}get opacityMap(){return logger.debug("TRACE: Material.opacityMap (getter) - Entering."),logger.debug("TRACE: Material.opacityMap (getter) - Exiting."),this._opacityMap}set opacityMap({type:e,source:t}){if(logger.debug("TRACE: Material.opacityMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t)){if(this._opacityMap.type="imagebitmap",this._opacityMap._name=t.name,t instanceof Tb&&(this._opacityMap.source=t),""===t&&(this._opacityMap.source=void 0),!this._enableOpacity)return void logger.debug("TRACE: Material.opacityMap (setter) - Exiting.");if(this._material()&&(this._opacityMap.source?(this._material().transparent=!0,this._material().opacity=this._opacityIntensity,this._material().alphaMap?(this._material().alphaMap=new we(this._opacityMap.source.textureSource),this._material().alphaMap.name=this._specularMap.source.name,this._material().alphaMap.flipY=!1,this._material().alphaMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().alphaMap||(this._material().alphaMap=new we(this._opacityMap.source.textureSource),this._material().alphaMap.name=this._opacityMap.source.name,this._material().alphaMap.flipY=!1,this._material().alphaMap.needsUpdate=!0,this._material().needsUpdate=!0),"number"==typeof this._opacityMap.source._wrapS&&this._opacityMap.source._wrapS>=1e3&&(this._material().alphaMap.wrapS=this._opacityMap.source._wrapS),"number"==typeof this._opacityMap.source._wrapT&&this._opacityMap.source._wrapT>=1e3&&(this._material().alphaMap.wrapT=this._opacityMap.source._wrapT),this.enableUV&&(this.enableUV=!0)):(this._material().alphaMap=null,this._material().needsUpdate=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(this._opacityMap.source?(e.transparent=!0,e.opacity=this._opacityIntensity,e.alphaMap?(e.alphaMap.image=this._opacityMap.source.textureSource,e.alphaMap.name=this._opacityMap.source.name):(e.alphaMap=new we(this._opacityMap.source.textureSource),e.alphaMap.name=this._opacityMap.source.name,e.alphaMap.flipY=!1),"number"==typeof this._opacityMap.source._wrapS&&this._opacityMap.source._wrapS>=1e3&&(e.alphaMap.wrapS=this._opacityMap.source._wrapS),"number"==typeof this._opacityMap.source._wrapT&&this._opacityMap.source._wrapT>=1e3&&(e.alphaMap.wrapT=this._opacityMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.alphaMap.needsUpdate=!0):e.alphaMap=null,e.needsUpdate=!0);logger.debug("TRACE: Material.opacityMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.opacityMap (setter) - Exiting.")}get opacityIntensity(){return logger.debug("TRACE: Material.opacityIntensity (getter) - Entering."),logger.debug("TRACE: Material.opacityIntensity (getter) - Exiting."),this._opacityIntensity}set opacityIntensity(e){if(logger.debug("TRACE: Material.opacityIntensity (setter) - Entering."),this._opacityIntensity=e,this._enableOpacity){if(this._material()&&(this._material().transparent=!0,this._material().opacity=this._opacityIntensity),this._copies instanceof Array)for(let e of this._copies)e&&(e.transparent=!0,e.opacity=this._opacityIntensity);logger.debug("TRACE: Material.opacityIntensity (setter) - Exiting.")}else logger.debug("TRACE: Material.opacityIntensity (setter) - Exiting.")}get enableEmissive(){return logger.debug("TRACE: Material.enableEmissive (getter) - Entering."),logger.debug("TRACE: Material.enableEmissive (getter) - Exiting."),this._enableEmissive}set enableEmissive(e){if(logger.debug("TRACE: Material.enableEmissive (setter) - Entering."),"boolean"==typeof e){if(this._enableEmissive=e,this._enableEmissive)this.emissiveMap=this.emissiveMap,this.emissiveMapColor=this.emissiveMapColor;else if(this._material().emissiveMap=void 0,this._material().emissive&&(this._material().emissive.r=0,this._material().emissive.g=0,this._material().emissive.b=0),this._material().emissiveIntensity=0,this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)void 0===e.emissiveMap?e.emissiveMap=void 0:e.emissiveMap.image=void 0,e.emissive&&(e.emissive.r=0,e.emissive.g=0,e.emissive.b=0),e.emissiveIntensity=0;logger.debug("TRACE: Material.enableEmissive (setter) - Exiting.")}else logger.debug("TRACE: Material.enableEmissive (setter) - Exiting.")}get emissiveMapColor(){return this._emissiveMapColor}set emissiveMapColor(e){if(this._emissiveMapColor=e,this._enableEmissive){if(this._material()&&(this._material().emissive&&this._material().emissive.setStyle(this._emissiveMapColor),this._material().emissiveIntensity=this._emissiveIntensity),this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)e&&(e.emissive&&e.emissive.setStyle(this._emissiveMapColor),e.emissiveIntensity=this._emissiveIntensity);logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}else logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}get emissiveMap(){return logger.debug("TRACE: Material.emissiveMap (getter) - Entering."),logger.debug("TRACE: Material.emissiveMap (getter) - Exiting."),this._emissiveMap.color=this.emissiveMapColor,this._emissiveMap._color=this.emissiveMapColor,this._emissiveMap}set emissiveMap({type:e,source:t,color:i,reset:n=!1}){if(logger.debug("TRACE: Material.emissiveMap (setter) - Entering."),"color"===e.toLowerCase())return _y.isCSSColor(i)?(this.emissiveMap._source?this.emissiveMap._name=this.emissiveMap._source._name:this.emissiveMap._name=void 0,this.emissiveMapColor=i,void(n&&(this._material().emissiveMap=void 0))):void logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.");if("imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||void 0===t||""===t)){if(this._emissiveMap._type="imagebitmap",this._emissiveMap._name=t?t.name:"",t instanceof Tb&&(this._emissiveMap.source=t),""!==t&&void 0!==t||(this._emissiveMap.source="",this._material().emissiveMap=void 0),!this._enableEmissive)return void logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.");if(this._material()&&(this._emissiveMap.source?(this._material().emissiveMap?("object"==typeof this._material().emissiveMap?(this._material().emissiveMap.image=this._emissiveMap.source.textureSource||this._emissiveMap.source,this._material().emissiveMap.name=this._emissiveMap.source.name||this._emissiveMap.name):(this._material().emissiveMap=new we(this._emissiveMap.source.textureSource||this._emissiveMap.source),this._material().emissiveMap.name=this._emissiveMap.source.name||this._emissiveMap.name),this._material().emissive&&0==this._material().emissive.r&&0==this._material().emissive.g&&0==this._material().emissive.b&&(this._material().emissive.r=1,this._material().emissive.g=1,this._material().emissive.b=1)):(this._material().emissiveMap=new we(this._emissiveMap.source.textureSource||this._emissiveMap.source),this._material().emissiveMap.name=this._emissiveMap.source.name||this._emissiveMap.name,this._material().emissiveMap.encoding=3001,this._material().emissiveMap.flipY=!1,this._material().emissiveMap.format=1022,this._material().emissiveMap.version=10,this._material().emissive&&0==this._material().emissive.r&&0==this._material().emissive.g&&0==this._material().emissive.b&&(this._material().emissive.r=1,this._material().emissive.g=1,this._material().emissive.b=1)),"number"==typeof this._emissiveMap.source._wrapS&&this._emissiveMap.source._wrapS>=1e3&&(this._material().emissiveMap.wrapS=this._emissiveMap.source._wrapS),"number"==typeof this._emissiveMap.source._wrapT&&this._emissiveMap.source._wrapT>=1e3&&(this._material().emissiveMap.wrapT=this._emissiveMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._material().emissiveIntensity=this._emissiveIntensity,this._material().emissiveMap.needsUpdate=!0):this._material().emissiveMap=void 0),this._copies instanceof Array)for(let e of this._copies)e&&(this._emissiveMap.source?(e.emissiveMap?(e.emissiveMap.image=this._emissiveMap.source.textureSource||this._emissiveMap.source,e.emissiveMap.name=this._emissiveMap.source.name||this._emissiveMap.name,e.emissive&&(e.emissive.r=1,e.emissive.g=1,e.emissive.b=1)):(e.emissiveMap=new we(this._emissiveMap.source.textureSource||this._emissiveMap.source),e.emissiveMap.name=this._emissiveMap.source.name||this._emissiveMap.name,e.emissiveMap.encoding=3001,e.emissiveMap.flipY=!1,e.emissiveMap.format=1022,e.emissiveMap.version=10,e.emissive&&0==e.emissive.r&&0==e.emissive.g&&0==e.emissive.b&&(e.emissive.r=1,e.emissive.g=1,e.emissive.b=1)),"number"==typeof this._emissiveMap.source._wrapS&&this._emissiveMap.source._wrapS>=1e3&&(e.emissiveMap.wrapS=this._emissiveMap.source._wrapS),"number"==typeof this._emissiveMap.source._wrapT&&this._emissiveMap.source._wrapT>=1e3&&(e.emissiveMap.wrapT=this._emissiveMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.emissiveIntensity=this._emissiveIntensity,e.emissiveMap.needsUpdate=!0):e.emissiveMap=void 0);return this.emissiveMapColor=this._emissiveMapColor,void logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}e.toLowerCase(),logger.debug("TRACE: Material.emissiveMap (setter) - Exiting.")}get emissiveIntensity(){return logger.debug("TRACE: Material.emissiveIntensity (getter) - Entering."),logger.debug("TRACE: Material.emissiveIntensity (getter) - Exiting."),this._emissiveIntensity}set emissiveIntensity(e){if(logger.debug("TRACE: Material.emissiveIntensity (setter) - Entering."),this._emissiveIntensity=e,this._material().emissiveIntensity=this._emissiveIntensity,this._copies instanceof Array)for(let e of this._copies)e.emissiveIntensity=this._emissiveIntensity;logger.debug("TRACE: Material.emissiveIntensity (setter) - Exiting.")}get enableClearcoat(){return logger.debug("TRACE: Material.enableClearcoat (getter) - Entering."),logger.debug("TRACE: Material.enableClearcoat (getter) - Exiting."),this._enableClearcoat}set enableClearcoat(e){if(logger.debug("TRACE: Material.enableClearcoat (setter) - Entering."),"boolean"==typeof e){if(this._enableClearcoat=e,this._enableClearcoat)this.toPhysicalMaterial(),this.clearcoatMap=this._clearcoatMap,this.clearcoatColor=this._clearcoatColor,this.clearcoatThickness=this._clearcoatThickness,this.clearcoatNormalMap=this._clearcoatNormalMap,this.clearcoatRoughness=this._clearcoatRoughness,this.clearcoatRoughnessMap=this._clearcoatRoughnessMap;else if(this._material().clearcoatMap=void 0,this._material().clearcoat=0,this._material().sheen=null,this._material().clearcoatNormalMap=void 0,this._material().clearcoatRoughnessMap=void 0,this._material().clearcoatRoughness=0,this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)e.clearcoat=0,e.clearcoatNormalMap=null,e.clearcoatRoughnessMap=null,e.clearcoatRoughness=0,e.clearcoatMap=null,e.needsUpdate=!0;logger.debug("TRACE: Material.enableClearcoat (setter) - Exiting.")}else logger.debug("TRACE: Material.enableClearcoat (setter) - Exiting.")}get clearcoatMap(){return logger.debug("TRACE: Material.clearcoatMap (getter) - Entering."),logger.debug("TRACE: Material.clearcoatMap (getter) - Exiting."),this._clearcoatMap.color=this.clearcoatColor,this._clearcoatMap._color=this.clearcoatColor,this._clearcoatMap}set clearcoatMap({type:e,source:t,color:i,reset:n=!1}){if(logger.debug("TRACE: Material.clearcoatMap (setter) - Entering."),"color"===e.toLowerCase()&&(this.clearcoatColor=i),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t)){if(this._clearcoatMap.type="imagebitmap",this._clearcoatMap._name=t.name,t instanceof Tb&&(this._clearcoatMap.source=t),""===t&&(this._clearcoatMap.source=void 0),!this._enableClearcoat)return void logger.debug("TRACE: Material.clearcoatMap (setter) - Exiting.");if(this._enableClearcoat&&this.toPhysicalMaterial(),this._material()&&(this._clearcoatMap.source?(this._material().clearcoatMap&&this._material().clearcoatMap.image!==(this._clearcoatMap.source.textureSource||this._clearcoatMap.source)?(this._material().clearcoatMap.image=this._clearcoatMap.source.textureSource||this._clearcoatMap.source,this._material().clearcoatMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().clearcoatMap||(this._material().clearcoatMap=new we(this._clearcoatMap.source.textureSource||this._clearcoatMap.source),this._material().clearcoatMap.flipY=!1,this._material().clearcoatMap.needsUpdate=!0,this._material().needsUpdate=!0),"number"==typeof this._clearcoatMap.source._wrapS&&this._clearcoatMap.source._wrapS>=1e3&&(this._material().clearcoatMap.wrapS=this._clearcoatMap.source._wrapS),"number"==typeof this._clearcoatMap.source._wrapT&&this._clearcoatMap.source._wrapT>=1e3&&(this._material().clearcoatMap.wrapT=this._clearcoatMap.source._wrapT),this.enableUV&&(this.enableUV=!0)):(this._material().clearcoatMap=null,this._material().needsUpdate=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(this._clearcoatMap.source?(e.clearcoatMap?e.clearcoatMap.image=this._clearcoatMap.source.textureSource||this._clearcoatMap.source:(e.clearcoatMap=new we(this._clearcoatMap.source.textureSource||this._clearcoatMap.source),e.clearcoatMap.flipY=!1),"number"==typeof this._clearcoatMap.source._wrapS&&this._clearcoatMap.source._wrapS>=1e3&&(e.clearcoatMap.wrapS=this._clearcoatMap.source._wrapS),"number"==typeof this._clearcoatMap.source._wrapT&&this._clearcoatMap.source._wrapT>=1e3&&(e.clearcoatMap.wrapT=this._clearcoatMap.source._wrapT),this.enableUV&&(this.enableUV=!0)):e.clearcoatMap=null,e.needsUpdate=!0);logger.debug("TRACE: Material.clearcoatMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.clearcoatMap (setter) - Exiting.")}get clearcoatColor(){return this._clearcoatColor}set clearcoatColor(e){if(logger.debug("TRACE: Material.clearcoatColor (getter) - Entering."),logger.debug("TRACE: Material.clearcoatColor (getter) - Exiting."),this._clearcoatColor=e,e){let t=new Qt(e);this._material()&&this.enableClearcoat&&(this._material().sheen=t,this._material().needsUpdate=!0)}else this._material()&&this.enableClearcoat&&(this._material().sheen=null,this._material().needsUpdate=!0)}get clearcoatThickness(){return logger.debug("TRACE: Material.clearcoatThickness (getter) - Entering."),logger.debug("TRACE: Material.clearcoatThickness (getter) - Exiting."),this._clearcoatThickness}set clearcoatThickness(e){if(logger.debug("TRACE: Material.clearcoatThickness (setter) - Entering."),"number"==typeof e){if(this._enableClearcoat&&this.toPhysicalMaterial(),this._clearcoatThickness=e,this._enableClearcoat&&(this._material().clearcoat=this._clearcoatThickness,this._copies instanceof Array))for(let e of this._copies)e.clearcoat=this._clearcoatThickness;logger.debug("TRACE: Material.clearcoatThickness (setter) - Exiting.")}else logger.debug("TRACE: Material.clearcoatThickness (setter) - Exiting.")}get clearcoatNormalMap(){return logger.debug("TRACE: Material.clearcoatNormalMap (getter) - Entering."),logger.debug("TRACE: Material.clearcoatNormalMap (getter) - Exiting."),this._clearcoatNormalMap}set clearcoatNormalMap({type:e,source:t,reset:i=!1}){if(logger.debug("TRACE: Material.clearcoatNormalMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t)){if(this._clearcoatNormalMap.type="imagebitmap",this._clearcoatNormalMap._name=t.name,t instanceof Tb&&(this._clearcoatNormalMap.source=t),""===t&&(this._clearcoatNormalMap.source=void 0),this._enableClearcoat&&this.toPhysicalMaterial(),!this._enableClearcoat)return void logger.debug("TRACE: Material.clearcoatNormalMap (setter) - Exiting.");if(this._material()&&(this._clearcoatNormalMap.source?(this._material().clearcoatNormalMap&&this._material().clearcoatNormalMap.image!==(this._clearcoatNormalMap.source.textureSource||this._clearcoatNormalMap.source)?(this._material().clearcoatNormalMap.image=this._clearcoatNormalMap.source.textureSource||this._clearcoatNormalMap.source,this._material().clearcoatNormalMap.flipY=!1,this._material().clearcoatNormalMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().clearcoatNormalMap||(this._material().clearcoatNormalMap=new we(this._clearcoatNormalMap.source.textureSource||this._clearcoatNormalMap.source),this._material().clearcoatNormalMap.flipY=!1,this._material().clearcoatNormalMap.needsUpdate=!0,this._material().needsUpdate=!0),"number"==typeof this._clearcoatNormalMap.source._wrapS&&this._clearcoatNormalMap.source._wrapS>=1e3&&(this._material().clearcoatNormalMap.wrapS=this._clearcoatNormalMap.source._wrapS),"number"==typeof this._clearcoatNormalMap.source._wrapT&&this._clearcoatNormalMap.source._wrapT>=1e3&&(this._material().clearcoatNormalMap.wrapT=this._clearcoatNormalMap.source._wrapT),this.enableUV&&(this.enableUV=!0)):(this._material().clearcoatNormalMap=null,this._material().needsUpdate=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(this._clearcoatNormalMap.source?e.clearcoatNormalMap?(e.clearcoatNormalMap.needsUpdate=!0,e.clearcoatNormalMap.image=this._clearcoatNormalMap.source.textureSource||this._clearcoatNormalMap.source):(e.clearcoatNormalMap=new we(this._clearcoatNormalMap.source.textureSource||this._clearcoatNormalMap.source),e.clearcoatNormalMap.flipY=!1):e.clearcoatNormalMap=null,"number"==typeof this._clearcoatNormalMap.source._wrapS&&this._clearcoatNormalMap.source._wrapS>=1e3&&(e.clearcoatNormalMap.wrapS=this._clearcoatNormalMap.source._wrapS),"number"==typeof this._clearcoatNormalMap.source._wrapT&&this._clearcoatNormalMap.source._wrapT>=1e3&&(e.clearcoatNormalMap.wrapT=this._clearcoatNormalMap.source._wrapT),this.enableUV&&(this.enableUV=!0),e.needsUpdate=!0);logger.debug("TRACE: Material.clearcoatNormalMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.clearcoatNormalMap (setter) - Exiting.")}get clearcoatNormalScale(){return logger.debug("TRACE: Material.clearcoatNormalScale (getter) - Entering."),logger.debug("TRACE: Material.clearcoatNormalScale (getter) - Exiting."),this._clearcoatNormalScale}set clearcoatNormalScale(e){if(logger.debug("TRACE: Material.clearcoatNormalScale (setter) - Entering."),"number"==typeof e){if(this._enableClearcoat&&this.toPhysicalMaterial(),this._clearcoatNormalScale=e,this._enableClearcoat){if(this._material().clearcoatNormalScale instanceof ye?this._material().clearcoatNormalScale.set(Math.abs(this._clearcoatNormalScale),this._clearcoatNormalScale):this._material().clearcoatNormalScale=new ye(Math.abs(this._clearcoatNormalScale),this._clearcoatNormalScale),this._copies instanceof Array)for(let e of this._copies)e.clearcoatNormalScale instanceof ye?e.clearcoatNormalScale.set(Math.abs(this._clearcoatNormalScale),this._clearcoatNormalScale):e.clearcoatNormalScale=new ye(Math.abs(this._clearcoatNormalScale),this._clearcoatNormalScale);logger.debug("TRACE: Material.clearcoatNormalScale (setter) - Exiting.")}}else logger.debug("TRACE: Material.clearcoatNormalScale (setter) - Exiting.")}get clearcoatNormalMapFlipY(){return this._clearcoatNormalMapFlipY}set clearcoatNormalMapFlipY(e){this._clearcoatNormalMapFlipY=e,this._enableClearcoat&&this._material()&&this._material().clearcoatNormalMap&&(this._material().clearcoatNormalMap.flipY=!1,this._material().clearcoatNormalMap.needsUpdate=!0,this._material().needsUpdate=!0)}get clearcoatRoughness(){return logger.debug("TRACE: Material.clearcoatRoughness (getter) - Entering."),logger.debug("TRACE: Material.clearcoatRoughness (getter) - Exiting."),this._clearcoatRoughness}set clearcoatRoughness(e){if(logger.debug("TRACE: Material.clearcoatRoughness (setter) - Entering."),"number"==typeof e){if(this._enableClearcoat&&this.toPhysicalMaterial(),this._clearcoatRoughness=e,this._enableClearcoat){if(this._material().clearcoatRoughness=this._clearcoatRoughness,this._copies instanceof Array)for(let e of this._copies)e.clearcoatRoughness=this._clearcoatRoughness;logger.debug("TRACE: Material.clearcoatRoughness (setter) - Exiting.")}}else logger.debug("TRACE: Material.clearcoatRoughness (setter) - Exiting.")}get clearcoatRoughnessMap(){return logger.debug("TRACE: Material.clearcoatRoughnessMap (getter) - Entering."),logger.debug("TRACE: Material.clearcoatRoughnessMap (getter) - Exiting."),this._clearcoatRoughnessMap}set clearcoatRoughnessMap({type:e,source:t,reset:i=!1}){if(logger.debug("TRACE: Material.clearcoatRoughnessMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&(t instanceof Tb||_y.isImage(t)||""===t)){if(this._clearcoatRoughnessMap.type="imagebitmap",this._clearcoatRoughnessMap._name=t.name,t instanceof Tb&&(this._clearcoatRoughnessMap.source=t),""===t&&(this._clearcoatRoughnessMap.source=void 0),this._enableClearcoat&&this.toPhysicalMaterial(),!this._enableClearcoat)return void logger.debug("TRACE: Material.clearcoatRoughnessMap (setter) - Exiting.");if(this._material()&&(this._clearcoatRoughnessMap.source?(this._material().clearcoatRoughnessMap&&this._material().clearcoatRoughnessMap.image!==(this._clearcoatRoughnessMap.source.textureSource||this._clearcoatRoughnessMap.source)?(this._material().clearcoatRoughnessMap.image=this._clearcoatRoughnessMap.source.textureSource||this._clearcoatRoughnessMap.source,this._material().clearcoatRoughnessMap.needsUpdate=!0,this._material().needsUpdate=!0):this._material().clearcoatRoughnessMap||(this._material().clearcoatRoughnessMap=new we(this._clearcoatRoughnessMap.source.textureSource||this._clearcoatRoughnessMap.source),this._material().clearcoatRoughnessMap.flipY=!1,this._material().clearcoatRoughnessMap.needsUpdate=!0,this._material().needsUpdate=!0),"number"==typeof this._clearcoatRoughnessMap.source._wrapS&&this._clearcoatRoughnessMap.source._wrapS>=1e3&&(this._material().clearcoatRoughnessMap.wrapS=this._clearcoatRoughnessMap.source._wrapS),"number"==typeof this._clearcoatRoughnessMap.source._wrapT&&this._clearcoatRoughnessMap.source._wrapT>=1e3&&(this._material().clearcoatRoughnessMap.wrapT=this._clearcoatRoughnessMap.source._wrapT),this.enableUV&&(this.enableUV=!0)):(this._material().clearcoatRoughnessMap=null,this._material().needsUpdate=!0)),this._copies instanceof Array)for(let e of this._copies)e&&(this._clearcoatRoughnessMap.source?(e.clearcoatRoughnessMap?e.clearcoatRoughnessMap.image=this._clearcoatRoughnessMap.source.textureSource||this._clearcoatRoughnessMap.source:(e.clearcoatRoughnessMap=new we(this._clearcoatRoughnessMap.source.textureSource||this._clearcoatRoughnessMap.source),e.clearcoatRoughnessMap.flipY=!1),"number"==typeof this._clearcoatRoughnessMap.source._wrapS&&this._clearcoatRoughnessMap.source._wrapS>=1e3&&(e.clearcoatRoughnessMap.wrapS=this._clearcoatRoughnessMap.source._wrapS),"number"==typeof this._clearcoatRoughnessMap.source._wrapT&&this._clearcoatRoughnessMap.source._wrapT>=1e3&&(e.clearcoatRoughnessMap.wrapT=this._clearcoatRoughnessMap.source._wrapT),this.enableUV&&(this.enableUV=!0)):e.clearcoatRoughnessMap=null,e.needsUpdate=!0);logger.debug("TRACE: Material.clearcoatRoughnessMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.clearcoatRoughnessMap (setter) - Exiting.")}get enableAOMap(){return logger.debug("TRACE: Material.enableAOMap (getter) - Entering."),logger.debug("TRACE: Material.enableAOMap (getter) - Exiting."),this._enableAOMap}set enableAOMap(e){if(logger.debug("TRACE: Material.enableAOMap (setter) - Entering."),"boolean"==typeof e){if(this._enableAOMap=e,this._enableAOMap){if(this.aoMap=this._aoMap,this._getRelatedNodes()instanceof Array)for(let e of this._getRelatedNodes())e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new ti(e.geometry.attributes.uv.array,2))}else if(this._material().aoMap=null,this._material().needsUpdate=!0,this._copies instanceof Array)for(let e of this._copies)e.aoMap=null,e.needsUpdate=!0;logger.debug("TRACE: Material.enableAOMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableAOMap (setter) - Exiting.")}get aoMap(){return logger.debug("TRACE: Material.aoMap (getter) - Entering."),logger.debug("TRACE: Material.aoMap (getter) - Exiting."),this._aoMap}set aoMap({type:e,source:t}){if(logger.debug("TRACE: Material.aoMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Tb||_y.isImage(t)||""===t){if(this._aoMap.type="imagebitmap",this._aoMap._name=t.name,this._aoMap.source=t,!this._enableAOMap)return void logger.debug("TRACE: Material.aoMap (setter) - Exiting.");if(this._material()){if(this._material().aoMap?""===this._aoMap.source?this._material().aoMap=null:(this._material().aoMap.image=this._aoMap.source.textureSource,this._material().aoMap.name=this._aoMap.source.name):""===this._aoMap.source?this._material().aoMap=null:(this._material().aoMap=new we(this._aoMap.source.textureSource),this._material().aoMap.name=this._aoMap.source.name,this._material().aoMap.flipY=!1),"number"==typeof this._aoMap.source._wrapS&&this._aoMap.source._wrapS>=1e3&&(this._material().aoMap.wrapS=this._aoMap.source._wrapS),"number"==typeof this._aoMap.source._wrapT&&this._aoMap.source._wrapT>=1e3&&(this._material().aoMap.wrapT=this._aoMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._getRelatedNodes()instanceof Array)for(let e of this._getRelatedNodes())e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new ti(e.geometry.attributes.uv.array,2));this._material().aoMap&&(this._material().aoMap.needsUpdate=!0),this._material().needsUpdate=!0}if(this._copies instanceof Array)for(let e of this._copies)if(e){if(e.aoMap?""===this._aoMap.source?e.aoMap=null:(e.aoMap.image=this._aoMap.source.textureSource,e.aoMap.name=this._aoMap.source.name):(e.aoMap=new we(this._aoMap.source.textureSource),e.aoMap.name=this._aoMap.source.name,e.aoMap.flipY=!1),"number"==typeof this._aoMap.source._wrapS&&this._aoMap.source._wrapS>=1e3&&(e.aoMap.wrapS=this._aoMap.source._wrapS),"number"==typeof this._aoMap.source._wrapT&&this._aoMap.source._wrapT>=1e3&&(e.aoMap.wrapT=this._aoMap.source._wrapT),this.enableUV&&(this.enableUV=!0),this._getRelatedNodes()instanceof Array)for(let e of this._getRelatedNodes())e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new ti(e.geometry.attributes.uv.array,2));e.aoMap&&(e.aoMap.needsUpdate=!0),e.needsUpdate=!0}logger.debug("TRACE: Material.aoMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.aoMap (setter) - Exiting.")}get aoMapIntensity(){return logger.debug("TRACE: Material.aoMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.aoMapIntensity (getter) - Exiting."),this._aoMapIntensity}set aoMapIntensity(e){if(logger.debug("TRACE: Material.aoMapIntensity (setter) - Entering."),this._aoMapIntensity=e,this._material().aoMapIntensity=this._aoMapIntensity,this._copies instanceof Array)for(let e of this._copies)e.aoMapIntensity=this._aoMapIntensity;logger.debug("TRACE: Material.aoMapIntensity (setter) - Exiting.")}get enableLightMap(){return logger.debug("TRACE: Material.enableLightMap (getter) - Entering."),logger.debug("TRACE: Material.enableLightMap (getter) - Exiting."),this._enableLightMap}set enableLightMap(e){if(logger.debug("TRACE: Material.enableLightMap (setter) - Entering."),"boolean"==typeof e){if(this._enableLightMap=e,this._enableLightMap){if(this.lightMap=this._lightMap,this._getRelatedNodes()instanceof Array)for(let e of this._getRelatedNodes())e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new ti(e.geometry.attributes.uv.array,2))}else if(this._material().lightMap=null,this._copies instanceof Array)for(let e of this._copies)e.lightMap=null;logger.debug("TRACE: Material.enableLightMap (setter) - Exiting.")}else logger.debug("TRACE: Material.enableLightMap (setter) - Exiting.")}get lightMap(){return logger.debug("TRACE: Material.lightMap (getter) - Entering."),logger.debug("TRACE: Material.lightMap (getter) - Exiting."),this._lightMap}set lightMap({type:e,source:t}){if(logger.debug("TRACE: Material.lightMap (setter) - Entering."),"imagebitmap"===e.toLowerCase()&&t instanceof Tb||_y.isImage(t)||""===t){if(this._lightMap.type="imagebitmap",this._lightMap._name=t.name,this._lightMap.source=t,!this._enableLightMap)return void logger.debug("TRACE: Material.lightMap (setter) - Exiting.");if(this._material()){if(this._material().lightMap?""===this._lightMap.source?this._material().lightMap=null:(this._material().lightMap.image=this._lightMap.source.textureSource,this._material().lightMap.name=this._lightMap.source.name):(this._material().lightMap=new we(this._lightMap.source.textureSource),this._material().lightMap.name=this._lightMap.source.name,this._material().lightMap.flipY=!1,this.enableUV&&(this.enableUV=!0)),this._getRelatedNodes()instanceof Array)for(let e of this._getRelatedNodes())e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new ti(e.geometry.attributes.uv.array,2));this._material().lightMap&&(this._material().lightMap.needsUpdate=!0)}if(this._copies instanceof Array)for(let e of this._copies)if(e){if(e.lightMap?""===this._lightMap.source?e.lightMap=null:(e.lightMap.image=this._lightMap.source.textureSource,e.lightMap.name=this._lightMap.source.name):(e.lightMap=new we(this._lightMap.source.textureSource),e.lightMap.name=this._lightMap.source.name,e.lightMap.flipY=!1,this.enableUV&&(this.enableUV=!0)),this._getRelatedNodes()instanceof Array)for(let e of this._getRelatedNodes())e.geometry&&e.geometry.attributes&&e.geometry.attributes.uv&&!e.geometry.attributes.uv2&&e.geometry.setAttribute("uv2",new ti(e.geometry.attributes.uv.array,2));e.lightMap&&(e.lightMap.needsUpdate=!0)}logger.debug("TRACE: Material.lightMap (setter) - Exiting.")}else e.toLowerCase(),logger.debug("TRACE: Material.lightMap (setter) - Exiting.")}get lightMapIntensity(){return logger.debug("TRACE: Material.lightMapIntensity (getter) - Entering."),logger.debug("TRACE: Material.lightMapIntensity (getter) - Exiting."),this._lightMapIntensity}set lightMapIntensity(e){if(logger.debug("TRACE: Material.lightMapIntensity (setter) - Entering."),this._lightMapIntensity=e,this._material().lightMapIntensity=this._lightMapIntensity,this._copies instanceof Array)for(let e of this._copies)e.lightMapIntensity=this._lightMapIntensity;logger.debug("TRACE: Material.lightMapIntensity (setter) - Exiting.")}get side(){return logger.debug("TRACE: Material.side (getter) - Entering."),logger.debug("TRACE: Material.side (getter) - Exiting."),this._side}set side(e){switch(logger.debug("TRACE: Material.side (setter) - Entering."),this._side=e,this._side){case 0:this._material().side=0,this._material().shadowSide=0;break;case 1:this._material().side=1,this._material().shadowSide=1;break;case 2:this._material().side=2,this._material().shadowSide=2}if(this._copies instanceof Array)for(let e of this._copies)switch(this._side){case 0:e.side=0;break;case 1:e.side=1;break;case 2:e.side=2}logger.debug("TRACE: Material.side (setter) - Exiting.")}get depth(){return logger.debug("TRACE: Material.depth (getter) - Entering."),logger.debug("TRACE: Material.depth (getter) - Exiting."),this._depth}set depth(e){switch(logger.debug("TRACE: Material.depth (setter) - Entering."),this._depth=e,this._depth){case 0:this._material().depthWrite=!1,this._material().depthTest=!1;break;case 1:this._material().depthWrite=!1,this._material().depthTest=!0;break;case 2:this._material().depthWrite=!0,this._material().depthTest=!0}if(this._copies instanceof Array)for(let e of this._copies)switch(this._depth){case 0:e.depthWrite=!1,e.depthTest=!1;break;case 1:e.depthWrite=!1,e.depthTest=!0;break;case 2:e.depthWrite=!0,e.depthTest=!0}logger.debug("TRACE: Material.depth (setter) - Exiting.")}get waterFlowSpeed(){return logger.debug("TRACE: Material.waterFlowSpeed (getter) - Entering."),logger.debug("TRACE: Material.waterFlowSpeed (getter) - Exiting."),this._waterFlowSpeed}set waterFlowSpeed(e){if(logger.debug("TRACE: Material.waterFlowSpeed (setter) - Entering."),this._waterFlowSpeed=e,"water"!=this._type)return;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t)if(i.getObjectByName(i.name+this._material().name+"_water_")){let t=Ep.animationStore.findMaterialAnimation(i.getObjectByName(i.name+this._material().name+"_water_").material,"WaterAnimationController");t&&(t.speed=e)}logger.debug("TRACE: Material.waterFlowSpeed (setter) - Exiting.")}get waterOffsetY(){return logger.debug("TRACE: Material.waterOffsetY (getter) - Entering."),logger.debug("TRACE: Material.waterOffsetY (getter) - Exiting."),this._waterOffsetY}set waterOffsetY(e){if(logger.debug("TRACE: Material.waterOffsetY (setter) - Entering."),this._waterOffsetY=e,"water"!=this._type)return;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){i.position.y=i.userData.y+e;let t=Ep.defaultObjectTree.getItemByUUID(i.uuid);t&&(t.transformNode=Ep.instance.getModelTransformByUUID(i.uuid))}logger.debug("TRACE: Material.waterOffsetY (setter) - Exiting.")}get waterColor(){return logger.debug("TRACE: Material.waterColor (getter) - Entering."),logger.debug("TRACE: Material.waterColor (getter) - Exiting."),this._waterColor}set waterColor(e){if(logger.debug("TRACE: Material.waterColor (setter) - Entering."),"water"!=this._type)return;this._waterColor=e;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){let t=i.getObjectByName(i.name+this._material().name+"_water_");t&&(t.material.uniforms.waterColor.value=new Qt(e))}logger.debug("TRACE: Material.waterColor (setter) - Exiting.")}get waterReflectionAutoUpdate(){return logger.debug("TRACE: Material.waterReflectionAutoUpdate (getter) - Entering."),logger.debug("TRACE: Material.waterReflectionAutoUpdate (getter) - Exiting."),this._waterReflectionAutoUpdate}set waterReflectionAutoUpdate(e){if(logger.debug("TRACE: Material.waterReflectionAutoUpdate (setter) - Entering."),"water"!=this._type)return;this._waterReflectionAutoUpdate=e;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){let t=i.getObjectByName(i.name+this._material().name+"_water_");t&&(t.reflectionAutoUpdate=e,t.needsUpdate=!0)}logger.debug("TRACE: Material.waterReflectionAutoUpdate (setter) - Exiting.")}get waterReflectionQuality(){return logger.debug("TRACE: Material.waterReflectionQuality (getter) - Entering."),logger.debug("TRACE: Material.waterReflectionQuality (getter) - Exiting."),this._waterReflectionQuality}set waterReflectionQuality(e){if(logger.debug("TRACE: Material.waterReflectionQuality (setter) - Entering."),"water"!=this._type)return;this._waterReflectionQuality=e;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){let t=i.getObjectByName(i.name+this._material().name+"_water_");t&&t.getRenderTarget().setSize(e,e)}logger.debug("TRACE: Material.waterReflectionQuality (setter) - Exiting.")}get waterOpacity(){return logger.debug("TRACE: Material.waterOpacity (getter) - Entering."),logger.debug("TRACE: Material.waterOpacity (getter) - Exiting."),this._waterOpacity}set waterOpacity(e){if(logger.debug("TRACE: Material.waterOpacity (setter) - Entering."),this._waterOpacity=e,"water"!=this._type)return;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){let t=i.getObjectByName(i.name+this._material().name+"_water_");t&&(t.material.uniforms.alpha.value=e)}logger.debug("TRACE: Material.waterOpacity (setter) - Exiting.")}get waterReflectionRate(){return logger.debug("TRACE: Material.waterReflectionRate (getter) - Entering."),logger.debug("TRACE: Material.waterReflectionRate (getter) - Exiting."),this._waterReflectionRate}set waterReflectionRate(e){if(logger.debug("TRACE: Material.waterReflectionRate (setter) - Entering."),this._waterReflectionRate=e,"water"!=this._type)return;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){let t=i.getObjectByName(i.name+this._material().name+"_water_");t&&(t.material.uniforms.reflectionRate.value=e)}logger.debug("TRACE: Material.waterReflectionRate (setter) - Exiting.")}get waterWave(){return logger.debug("TRACE: Material.waterWave (getter) - Entering."),logger.debug("TRACE: Material.waterWave (getter) - Exiting."),this._waterWave}set waterWave(e){if(logger.debug("TRACE: Material.waterWave (setter) - Entering."),this._waterWave=e,"water"!=this._type)return;let t=_y.findMeshByMaterial(Ep.scene,this._material());t&&t.length||Ep.materialPreview&&Ep.materialPreview.scene&&(t=_y.findMeshByMaterial(Ep.materialPreview.scene,this._material(),this._copies));for(let i of t){let t=i.getObjectByName(i.name+this._material().name+"_water_");t&&(t.material.uniforms.distortionScale.value=e)}logger.debug("TRACE: Material.waterWave (setter) - Exiting.")}get enableSSR(){return logger.debug("TRACE: Material.enableSSR (getter) - Entering."),logger.debug("TRACE: Material.enableSSR (getter) - Exiting."),this._enableSSR}set enableSSR(e){if(logger.debug("TRACE: Material.enableSSR (setter) - Entering."),"boolean"==typeof e){if(Ep&&Ep.effectStore&&Ep.effectStore.visualEffect&&Ep.effectStore.visualEffect._passes&&Ep.effectStore.visualEffect._passes.ssrPass&&Ep.effectStore.visualEffect._passes.ssrPass.ssrEffect){if(this._enableSSR=e,this._enableSSR){Ep.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects||(Ep.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects=[]);for(let e=0;e<this._getRelatedNodes().length;e++)Ep.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects.includes(this._getRelatedNodes()[e])||Ep.effectStore.visualEffect._passes.ssrPass.ssrEffect.selects.push(this._getRelatedNodes()[e])}this._material().disableSSR=!this._enableSSR,logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}}else logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}get enableSSRMirror(){return logger.debug("TRACE: Material.enableSSR (getter) - Entering."),logger.debug("TRACE: Material.enableSSR (getter) - Exiting."),this._enableSSR}set enableSSRMirror(e){if(logger.debug("TRACE: Material.enableSSR (setter) - Entering."),"boolean"==typeof e){if(this._enableSSR=e,this._enableSSR){this._enableSSR=!0;let e=null;for(let t=0;t<Ep.envMapIntensity.length;t++)Ep.envMapIntensity[t].name===this.material().name&&Ep.envMapIntensity[t].modelName===this._modelName&&(e=Ep.envMapIntensity[t]);e?e.Intensity=this._envMapIntensity:Ep.envMapIntensity.push({name:this.material().name,modelName:this._modelName,Intensity:1}),this._getRelatedNodes().forEach((e=>{let t,i=Ep.instance.defaultObjectTree.getItemByName(this._modelName);for(let n=0;n<i.children.length&&(t=_y.findModelItemNodeByName(i.children[n],e.name),!t);n++);t&&t.enableSSR&&Ep.instance.addCubeCamera(this._modelName,e,this._name)}))}else{this._enableSSR=!1;for(let e=0;e<Ep.envMapIntensity.length;e++)Ep.envMapIntensity[e].name===this.material().name&&Ep.envMapIntensity[e].modelName===this._modelName&&(Ep.envMapIntensity[e].Intensity=1);setTimeout((()=>{this._getRelatedNodes().forEach((e=>{for(let t=0;t<Ep.ssr.length;t++)if(Ep.ssr[t].nodeName===e.name&&Ep.ssr[t].modelName===this._modelName){if(!Ep.instance.findMaterialInModel(Ep.ssr[t].modelName,Ep.ssr[t].materialName)._material().envMap)return;Ep.instance.findMaterialInModel(Ep.ssr[t].modelName,Ep.ssr[t].materialName)._material().envMap.dispose(),Ep.instance.findMaterialInModel(Ep.ssr[t].modelName,Ep.ssr[t].materialName)._material().envMap=null,Ep.ssr.splice(t,1),t--}}))}),10)}logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}else logger.debug("TRACE: Material.enableSSR (setter) - Exiting.")}get envMapIntensity(){return logger.debug("TRACE: Material.enableSSR (getter) - Entering."),logger.debug("TRACE: Material.enableSSR (getter) - Exiting."),this._envMapIntensity}set envMapIntensity(e){}get enableTranslation(){return logger.debug("TRACE: Material.enableTranslation (getter) - Entering."),logger.debug("TRACE: Material.enableTranslation (getter) - Exiting."),this._enableTranslation}set enableTranslation(e){logger.debug("TRACE: Material.enableTranslation (setter) - Entering."),this._enableTranslation=e,logger.debug("TRACE: Material.enableTranslation (setter) - Exiting.")}get translationSpeedU(){return logger.debug("TRACE: Material.translationSpeedU (getter) - Entering."),logger.debug("TRACE: Material.translationSpeedU (getter) - Exiting."),this._translationSpeedU}set translationSpeedU(e){logger.debug("TRACE: Material.translationSpeedU (setter) - Entering."),this._translationSpeedU=e,logger.debug("TRACE: Material.translationSpeedU (setter) - Exiting.")}get translationSpeedV(){return logger.debug("TRACE: Material.translationSpeedV (getter) - Entering."),logger.debug("TRACE: Material.translationSpeedV (getter) - Exiting."),this._translationSpeedV}set translationSpeedV(e){logger.debug("TRACE: Material.translationSpeedV (setter) - Entering."),this._translationSpeedV=e,logger.debug("TRACE: Material.translationSpeedV (setter) - Exiting.")}get enableUV(){return logger.debug("TRACE: Material.enableUV (getter) - Entering."),logger.debug("TRACE: Material.enableUV (getter) - Exiting."),this._enableUV}set enableUV(e){logger.debug("TRACE: Material.enableUV (setter) - Entering."),this._enableUV=e;let t=["map","metalnessMap","roughnessMap","normalMap","bumpMap","alphaMap","emissiveMap","clearcoatMap","clearcoatNormalMap","clearcoatRoughnessMap","aoMap"];if(this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(this._material()._uvDefault||(this._material()._uvDefault={repeat:e.repeat?e.repeat.clone():void 0,offset:e.offset?e.offset.clone():void 0}),e.repeat.set(this.repeatU,this.repeatV),e.offset.set(this.offsetU,this.offsetV)),t.forEach((e=>{this._material()[e]&&this._material()[e].wrapS!==d&&(this._material()[e].wrapS=d,this._material()[e].wrapT=d,this._material()[e].needsUpdate=!0)}))}else{let e=this._findFirstAvailableMapForUV();e&&this._material()._uvDefault&&(e.repeat.set(this._material()._uvDefault.repeat.x,this._material()._uvDefault.repeat.y),e.offset.set(this._material()._uvDefault.offset.x,this._material()._uvDefault.offset.y)),t.forEach((e=>{this._material()[e]&&this[`_${e}`]&&this[`_${e}`].source&&this._material()[e].wrapS!==this[`_${e}`].source._wrapS&&(this._material()[e].wrapS=this[`_${e}`].source._wrapS,this._material()[e].wrapT=this[`_${e}`].source._wrapT,this._material()[e].needsUpdate=!0)}))}logger.debug("TRACE: Material.enableUV (setter) - Exiting.")}get repeatU(){return logger.debug("TRACE: Material.repeatU (getter) - Entering."),logger.debug("TRACE: Material.repeatU (getter) - Exiting."),this._repeatU}set repeatU(e){if(logger.debug("TRACE: Material.repeatU (setter) - Entering."),this._repeatU=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.repeat.x=this._repeatU),this.enableUV&&(this.enableUV=!0)}logger.debug("TRACE: Material.repeatU (setter) - Exiting.")}get repeatV(){return logger.debug("TRACE: Material.repeatV (getter) - Entering."),logger.debug("TRACE: Material.repeatV (getter) - Exiting."),this._repeatV}set repeatV(e){if(logger.debug("TRACE: Material.repeatV (setter) - Entering."),this._repeatV=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.repeat.y=this._repeatV),this.enableUV&&(this.enableUV=!0)}logger.debug("TRACE: Material.repeatV (setter) - Exiting.")}get offsetU(){return logger.debug("TRACE: Material.offsetU (getter) - Entering."),logger.debug("TRACE: Material.offsetU (getter) - Exiting."),this._offsetU}set offsetU(e){if(logger.debug("TRACE: Material.offsetU (setter) - Entering."),this._offsetU=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.offset.x=this.offsetU)}logger.debug("TRACE: Material.offsetU (setter) - Exiting.")}get offsetV(){return logger.debug("TRACE: Material.offsetV (getter) - Entering."),logger.debug("TRACE: Material.offsetV (getter) - Exiting."),this._offsetV}set offsetV(e){if(logger.debug("TRACE: Material.offsetV (setter) - Entering."),this._offsetV=e,this._enableUV){let e=this._findFirstAvailableMapForUV();e&&(e.offset.y=this.offsetV)}logger.debug("TRACE: Material.offsetV (setter) - Exiting.")}get relatedNodes(){return logger.debug("TRACE: Material.relatedNodes (getter) - Entering."),logger.debug("TRACE: Material.relatedNodes (getter) - Exiting."),this._getRelatedNodes()}set resourceBasePath(e){this._resourceBasePath=e}get modelName(){return this._modelName}set modelName(e){}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){this._polygonOffset=e,this._material()&&(this._material().polygonOffset=e)}get polygonOffsetFactor(){return this._polygonOffsetFactor}set polygonOffsetFactor(e){this._polygonOffsetFactor=e,this._material()&&(this._material().polygonOffsetFactor=e)}get polygonOffsetUnits(){return this._polygonOffsetUnits}set polygonOffsetUnits(e){this._polygonOffsetUnits=e,this._material()&&(this._material().polygonOffsetUnits=e)}url(e){return`${this._resourceBasePath}///${e}`.replace("/////","/").replace("////","/").replace("///","/")}getSettings(){let e={};for(var t in this)t.indexOf("_")>-1&&-1==t.indexOf("relatedNodes")&&(e[t.replace("_","")]=this[t.replace("_","")]);return e}_findFirstAvailableMapForUV(){if(this._material())return this._material().map||this._material().specularMap||this._material().displacementMap||this._material().normalMap||this._material().bumpMap||this._material().roughnessMap||this._material().metalnessMap||this._material().alphaMap||this._material().emissiveMap||this._material().clearcoatMap||this._material().clearcoatNormalMap||this._material().clearcoatRoughnessMap||this._material().aoMap}}Ab._toThreeObject=function(e,t){new To},Ab._fromThreeObject=function(e,t=""){if(!e)return;let i=new Ab({materialOfThree:e,id:e.uuid,name:e.name,type:"metalness",mapType:"metalness",color:e.color,map:e.map,mapIntensit:e.mapIntensit,metalnessMap:e.metalnessMap,metalnessIntensity:e.metalness,roughnessMap:e.roughnessMap,roughnessIntensity:e.roughness,enableSpecularMap:!!e.envMap,specularMapType:e.envMap?"custom":"envmap",specularMap:e.envMap,specularMapIntensity:e.envMapIntensity/5,enableNormalMap:!!e.normalMap,normalMapType:"",normalMap:e.normalMap,normalMapFlipY:e.normalMapFlipY,normalMapIntensity:e.normalScale?e.normalScale.x:1,enableDisplacement:!!e.displacementMap,displacementMap:e.displacementMap,displacementIntensity:e.displacementScale,enableOpacity:e.transparent||!!e.alphaMap,opacityType:"blend",opacityMap:e.alphaMap,opacityIntensity:e.opacity,opacityInverted:!1,emissive:e.emissive||new Qt(0,0,0),enableEmissive:!!e.emissiveMap||!!e.emissive&&(0!==e.emissive.r||0!==e.emissive.g||0!==e.emissive.b),emissiveMap:e.emissiveMap,emissiveIntensity:e.emissiveIntensity,enableClearcoat:e instanceof Mo&&""===e.defines.PHYSICAL,clearcoatMap:e.clearcoatMap,sheen:e.sheen,clearcoatThickness:e.clearcoat,clearcoatNormalMap:e.clearcoatNormalMap,clearcoatNormalScale:e.clearcoatNormalScale,clearcoatRoughness:e.clearcoatRoughness,clearcoatRoughnessMap:e.clearcoatRoughnessMap,enableAOMap:!!e.aoMap,aoMap:e.aoMap,aoMapIntensity:e.aoMapIntensity,enableLightMap:!!e.lightMap,lightMap:e.lightMap,lightMapIntensity:e.lightMapIntensity,enableSSR:e.enableSSR,envMapIntensity:e.envMapIntensity,side:e.side,depth:e.depthTest&&e.depthWrite?2:e.depthTest||e.depthWrite?1:0,polygonOffset:e.polygonOffset,polygonOffsetFactor:e.polygonOffsetFactor,polygonOffsetUnits:e.polygonOffsetUnits});return i._resourceBasePath=t,i};class Eb{constructor(e){this._materials=new Object,this._textureStore=e}add(e,t,i,n){let a=this._materials[e];if(void 0!==a)if(a._material().uuid===t.uuid)a.addRelatedNode(i);else{if(i.material instanceof Array){for(let e=0;e<i.material.length;e++)if(i.material[e].name===a.name){i.material[e]=a._material();break}}else i.material=a._material();a.addRelatedNode(i)}else this._materials[e]=Ab._fromThreeObject(t,Ep.instance.resourceBasePath),this._materials[e].addRelatedNode(i),this._materials[e].addModelName(n)}clear(){this._materials=[]}find(e){return this._materials[e]}getAll(){return this._materials}remove(e){if(null!=this._materials[e])return delete this._materials[e],!0}getSettings(){let e={};for(let t in this._materials){let i={};for(let e in this._materials[t])"_id"!==e&&"_material"!==e&&"_relatedNodes"!==e&&"_copies"!==e&&"function"!=typeof this._materials[t][e]&&(this._materials[t][e]instanceof hy?(i[e.replace("_","")]=this._materials[t][e],i[e.replace("_","")]._id&&delete i[e.replace("_","")]._id):i[e.replace("_","")]=this._materials[t][e]);e[t]=i}return e}applySettings(e,t,i){if(e)for(let n in e){let a=this.find(n);a&&(e[n].replacePath?Ep.instance.materialReplace({path:e[n].replacePath,material:a,onLoad:()=>{this.setMaterialParam(e,n,a,t,i)},onProgress:()=>{}},t,i):(delete a.replacePath,delete a._replacePath,this.setMaterialParam(e,n,a,t,i)))}else logger.error("无效的材质设置。")}setMaterialParam(e,t,i,n,a){for(let n in e[t])if(i[n]instanceof hy){for(let i in e[t][n])e[t][n][i.replace("_","")]=e[t][n][i];switch(e[t][n].type){case"imagebitmap":let a="undefined"!=typeof ImageBitmap&&e[t][n].source instanceof ImageBitmap?e[t][n].source:void 0!==e[t][n].name?this._textureStore.find(e[t][n].name)||Ep.instance.customTextureStore.find(e[t][n].name):this._textureStore.find(t+"#"+n);if(("metalnessMap"===n||"roughnessMap"===n)&&!a){let i="",r="";e[t].roughnessMap&&(r=e[t].roughnessMap.name||e[t].roughnessMap._name||""),e[t].metalnessMap&&(i=e[t].metalnessMap.name||e[t].metalnessMap._name||"");let s=Ep.instance.getTextures();e[t][n].name&&(a||(a=this._textureStore.find(r+i)),a=s.find((i=>i.name.indexOf(e[t][n].name)>-1&&i.name.indexOf("#MetalnessAndRoughness#")>-1)))}if(!a&&e[t][n].name&&0===e[t][n].name.indexOf("[[origin]]")){Ep.instance.customTextureStore.loadTexture({url:e[t][n].name,name:e[t][n].name,onLoad:()=>{let a="undefined"!=typeof ImageBitmap&&e[t][n].source instanceof ImageBitmap?e[t][n].source:void 0!==e[t][n].name?this._textureStore.find(e[t][n].name)||Ep.instance.customTextureStore.find(e[t][n].name):this._textureStore.find(t+"#"+n);i[n]={type:"imagebitmap",source:a,reset:!0}}}),console.log("可能加载的模型引用了自定义贴图，自定义贴图需要重新load");break}i[n]={type:"imagebitmap",source:a,reset:!0};break;case"color":e[t][n].reset=!0,i[n]=e[t][n];break;case"file":default:i[n]=e[t][n]}}else i[n]=e[t][n];e[t].color&&(i.color=e[t].color),Ep.instance&&Ep.instance.setMaterialAnimation({name:t,enableTranslation:i.enableTranslation,translationSpeedU:_y.numberOrDefault(i.translationSpeedU,0),translationSpeedV:_y.numberOrDefault(i.translationSpeedV,0),modelName:i._modelName},n,a),Ep.defaultObjectTree.children.map((e=>{"LineItem"==e.type&&e.getModelLine().curveUpdate()}))}dispose(){for(const e in this._materials)Object.hasOwnProperty.call(this._materials,e)&&_y.disposeThreeObject(this._materials[e]);this._materials=null,this._textureStore.dispose&&this._textureStore.dispose()}}function Cb(e,t){var i=e.__state.conversionName.toString(),n=Math.round(e.r),a=Math.round(e.g),r=Math.round(e.b),s=e.a,o=Math.round(e.h),l=e.s.toFixed(1),c=e.v.toFixed(1);if(t||"THREE_CHAR_HEX"===i||"SIX_CHAR_HEX"===i){for(var h=e.hex.toString(16);h.length<6;)h="0"+h;return"#"+h}return"CSS_RGB"===i?"rgb("+n+","+a+","+r+")":"CSS_RGBA"===i?"rgba("+n+","+a+","+r+","+s+")":"HEX"===i?"0x"+e.hex.toString(16):"RGB_ARRAY"===i?"["+n+","+a+","+r+"]":"RGBA_ARRAY"===i?"["+n+","+a+","+r+","+s+"]":"RGB_OBJ"===i?"{r:"+n+",g:"+a+",b:"+r+"}":"RGBA_OBJ"===i?"{r:"+n+",g:"+a+",b:"+r+",a:"+s+"}":"HSV_OBJ"===i?"{h:"+o+",s:"+l+",v:"+c+"}":"HSVA_OBJ"===i?"{h:"+o+",s:"+l+",v:"+c+",a:"+s+"}":"unknown format"}var Ib=Array.prototype.forEach,Pb=Array.prototype.slice,Rb={BREAK:{},extend:function(e){return this.each(Pb.call(arguments,1),(function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(i){this.isUndefined(t[i])||(e[i]=t[i])}.bind(this))}),this),e},defaults:function(e){return this.each(Pb.call(arguments,1),(function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(i){this.isUndefined(e[i])&&(e[i]=t[i])}.bind(this))}),this),e},compose:function(){var e=Pb.call(arguments);return function(){for(var t=Pb.call(arguments),i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},each:function(e,t,i){if(e)if(Ib&&e.forEach&&e.forEach===Ib)e.forEach(t,i);else if(e.length===e.length+0){var n,a=void 0;for(a=0,n=e.length;a<n;a++)if(a in e&&t.call(i,e[a],a)===this.BREAK)return}else for(var r in e)if(t.call(i,e[r],r)===this.BREAK)return},defer:function(e){setTimeout(e,0)},debounce:function(e,t,i){var n=void 0;return function(){var a=this,r=arguments;function s(){n=null,i||e.apply(a,r)}var o=i||!n;clearTimeout(n),n=setTimeout(s,t),o&&e.apply(a,r)}},toArray:function(e){return e.toArray?e.toArray():Pb.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return isNaN(e)})),isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return e instanceof Function}},Ob=[{litmus:Rb.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:Cb},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:Cb},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:Cb},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:Cb}}},{litmus:Rb.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:Rb.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:Rb.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(Rb.isNumber(e.r)&&Rb.isNumber(e.g)&&Rb.isNumber(e.b)&&Rb.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(Rb.isNumber(e.r)&&Rb.isNumber(e.g)&&Rb.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(Rb.isNumber(e.h)&&Rb.isNumber(e.s)&&Rb.isNumber(e.v)&&Rb.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(Rb.isNumber(e.h)&&Rb.isNumber(e.s)&&Rb.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],Db=void 0,Lb=void 0,kb=function(){Lb=!1;var e=arguments.length>1?Rb.toArray(arguments):arguments[0];return Rb.each(Ob,(function(t){if(t.litmus(e))return Rb.each(t.conversions,(function(t,i){if(Db=t.read(e),!1===Lb&&!1!==Db)return Lb=Db,Db.conversionName=i,Db.conversion=t,Rb.BREAK})),Rb.BREAK})),Lb},Nb=void 0,Bb={hsv_to_rgb:function(e,t,i){var n=Math.floor(e/60)%6,a=e/60-Math.floor(e/60),r=i*(1-t),s=i*(1-a*t),o=i*(1-(1-a)*t),l=[[i,o,r],[s,i,r],[r,i,o],[r,s,i],[o,r,i],[i,r,s]][n];return{r:255*l[0],g:255*l[1],b:255*l[2]}},rgb_to_hsv:function(e,t,i){var n=Math.min(e,t,i),a=Math.max(e,t,i),r=a-n,s=void 0;return 0===a?{h:NaN,s:0,v:0}:(s=e===a?(t-i)/r:t===a?2+(i-e)/r:4+(e-t)/r,(s/=6)<0&&(s+=1),{h:360*s,s:r/a,v:a/255})},rgb_to_hex:function(e,t,i){var n=this.hex_with_component(0,2,e);return n=this.hex_with_component(n,1,t),n=this.hex_with_component(n,0,i)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(e,t,i){return i<<(Nb=8*t)|e&~(255<<Nb)}},zb="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ub=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Fb=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),jb=function e(t,i,n){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,i);if(void 0===a){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in a)return a.value;var s=a.get;return void 0!==s?s.call(n):void 0},Hb=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},Gb=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},Vb=function(){function e(){if(Ub(this,e),this.__state=kb.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return Fb(e,[{key:"toString",value:function(){return Cb(this)}},{key:"toHexString",value:function(){return Cb(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),e}();function Wb(e,t,i){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space||Vb.recalculateRGB(this,t,i),this.__state[t]},set:function(e){"RGB"!==this.__state.space&&(Vb.recalculateRGB(this,t,i),this.__state.space="RGB"),this.__state[t]=e}})}function Yb(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space||Vb.recalculateHSV(this),this.__state[t]},set:function(e){"HSV"!==this.__state.space&&(Vb.recalculateHSV(this),this.__state.space="HSV"),this.__state[t]=e}})}Vb.recalculateRGB=function(e,t,i){if("HEX"===e.__state.space)e.__state[t]=Bb.component_from_hex(e.__state.hex,i);else{if("HSV"!==e.__state.space)throw new Error("Corrupted color state");Rb.extend(e.__state,Bb.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}},Vb.recalculateHSV=function(e){var t=Bb.rgb_to_hsv(e.r,e.g,e.b);Rb.extend(e.__state,{s:t.s,v:t.v}),Rb.isNaN(t.h)?Rb.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=t.h},Vb.COMPONENTS=["r","g","b","h","s","v","hex","a"],Wb(Vb.prototype,"r",2),Wb(Vb.prototype,"g",1),Wb(Vb.prototype,"b",0),Yb(Vb.prototype,"h"),Yb(Vb.prototype,"s"),Yb(Vb.prototype,"v"),Object.defineProperty(Vb.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(Vb.prototype,"hex",{get:function(){return"HEX"!==this.__state.space&&(this.__state.hex=Bb.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var Xb=function(){function e(t,i){Ub(this,e),this.initialValue=t[i],this.domElement=document.createElement("div"),this.object=t,this.property=i,this.__onChange=void 0,this.__onFinishChange=void 0}return Fb(e,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),e}(),Zb={};Rb.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},(function(e,t){Rb.each(e,(function(e){Zb[e]=t}))}));var qb=/(\d+(\.\d+)?)px/;function Jb(e){if("0"===e||Rb.isUndefined(e))return 0;var t=e.match(qb);return Rb.isNull(t)?0:parseFloat(t[1])}var Qb={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,i){var n=i,a=t;Rb.isUndefined(a)&&(a=!0),Rb.isUndefined(n)&&(n=!0),e.style.position="absolute",a&&(e.style.left=0,e.style.right=0),n&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,i,n){var a=i||{},r=Zb[t];if(!r)throw new Error("Event type "+t+" not supported.");var s=document.createEvent(r);switch(r){case"MouseEvents":var o=a.x||a.clientX||0,l=a.y||a.clientY||0;s.initMouseEvent(t,a.bubbles||!1,a.cancelable||!0,window,a.clickCount||1,0,0,o,l,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var c=s.initKeyboardEvent||s.initKeyEvent;Rb.defaults(a,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),c(t,a.bubbles||!1,a.cancelable,window,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.keyCode,a.charCode);break;default:s.initEvent(t,a.bubbles||!1,a.cancelable||!0)}Rb.defaults(s,n),e.dispatchEvent(s)},bind:function(e,t,i,n){var a=n||!1;return e.addEventListener?e.addEventListener(t,i,a):e.attachEvent&&e.attachEvent("on"+t,i),Qb},unbind:function(e,t,i,n){var a=n||!1;return e.removeEventListener?e.removeEventListener(t,i,a):e.detachEvent&&e.detachEvent("on"+t,i),Qb},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var i=e.className.split(/ +/);-1===i.indexOf(t)&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return Qb},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var i=e.className.split(/ +/),n=i.indexOf(t);-1!==n&&(i.splice(n,1),e.className=i.join(" "))}else e.className=void 0;return Qb},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return Jb(t["border-left-width"])+Jb(t["border-right-width"])+Jb(t["padding-left"])+Jb(t["padding-right"])+Jb(t.width)},getHeight:function(e){var t=getComputedStyle(e);return Jb(t["border-top-width"])+Jb(t["border-bottom-width"])+Jb(t["padding-top"])+Jb(t["padding-bottom"])+Jb(t.height)},getOffset:function(e){var t=e,i={left:0,top:0};if(t.offsetParent)do{i.left+=t.offsetLeft,i.top+=t.offsetTop,t=t.offsetParent}while(t);return i},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},Kb=function(e){function t(e,i){Ub(this,t);var n=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),a=n;return n.__prev=n.getValue(),n.__checkbox=document.createElement("input"),n.__checkbox.setAttribute("type","checkbox"),Qb.bind(n.__checkbox,"change",(function(){a.setValue(!a.__prev)}),!1),n.domElement.appendChild(n.__checkbox),n.updateDisplay(),n}return Hb(t,e),Fb(t,[{key:"setValue",value:function(e){var i=jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),i}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(Xb),$b=function(e){function t(e,i,n){Ub(this,t);var a=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),r=n,s=a;if(a.__select=document.createElement("select"),Rb.isArray(r)){var o={};Rb.each(r,(function(e){o[e]=e})),r=o}return Rb.each(r,(function(e,t){var i=document.createElement("option");i.innerHTML=t,i.setAttribute("value",e),s.__select.appendChild(i)})),a.updateDisplay(),Qb.bind(a.__select,"change",(function(){var e=this.options[this.selectedIndex].value;s.setValue(e)})),a.domElement.appendChild(a.__select),a}return Hb(t,e),Fb(t,[{key:"setValue",value:function(e){var i=jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),i}},{key:"updateDisplay",value:function(){return Qb.isActive(this.__select)?this:(this.__select.value=this.getValue(),jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this))}}]),t}(Xb),e_=function(e){function t(e,i){Ub(this,t);var n=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),a=n;function r(){a.setValue(a.__input.value)}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),Qb.bind(n.__input,"keyup",r),Qb.bind(n.__input,"change",r),Qb.bind(n.__input,"blur",(function(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())})),Qb.bind(n.__input,"keydown",(function(e){13===e.keyCode&&this.blur()})),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return Hb(t,e),Fb(t,[{key:"updateDisplay",value:function(){return Qb.isActive(this.__input)||(this.__input.value=this.getValue()),jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(Xb);function t_(e){var t=e.toString();return t.indexOf(".")>-1?t.length-t.indexOf(".")-1:0}var i_=function(e){function t(e,i,n){Ub(this,t);var a=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),r=n||{};return a.__min=r.min,a.__max=r.max,a.__step=r.step,Rb.isUndefined(a.__step)?0===a.initialValue?a.__impliedStep=1:a.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(a.initialValue))/Math.LN10))/10:a.__impliedStep=a.__step,a.__precision=t_(a.__impliedStep),a}return Hb(t,e),Fb(t,[{key:"setValue",value:function(e){var i=e;return void 0!==this.__min&&i<this.__min?i=this.__min:void 0!==this.__max&&i>this.__max&&(i=this.__max),void 0!==this.__step&&i%this.__step!=0&&(i=Math.round(i/this.__step)*this.__step),jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,i)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=t_(e),this}}]),t}(Xb);var n_=function(e){function t(e,i,n){Ub(this,t);var a=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,n));a.__truncationSuspended=!1;var r=a,s=void 0;function o(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}function l(e){var t=s-e.clientY;r.setValue(r.getValue()+t*r.__impliedStep),s=e.clientY}function c(){Qb.unbind(window,"mousemove",l),Qb.unbind(window,"mouseup",c),o()}return a.__input=document.createElement("input"),a.__input.setAttribute("type","text"),Qb.bind(a.__input,"change",(function(){var e=parseFloat(r.__input.value);Rb.isNaN(e)||r.setValue(e)})),Qb.bind(a.__input,"blur",(function(){o()})),Qb.bind(a.__input,"mousedown",(function(e){Qb.bind(window,"mousemove",l),Qb.bind(window,"mouseup",c),s=e.clientY})),Qb.bind(a.__input,"keydown",(function(e){13===e.keyCode&&(r.__truncationSuspended=!0,this.blur(),r.__truncationSuspended=!1,o())})),a.updateDisplay(),a.domElement.appendChild(a.__input),a}return Hb(t,e),Fb(t,[{key:"updateDisplay",value:function(){var e,i,n;return this.__input.value=this.__truncationSuspended?this.getValue():(e=this.getValue(),i=this.__precision,n=Math.pow(10,i),Math.round(e*n)/n),jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(i_);function a_(e,t,i,n,a){return n+(e-t)/(i-t)*(a-n)}var r_=function(e){function t(e,i,n,a,r){Ub(this,t);var s=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,{min:n,max:a,step:r})),o=s;function l(e){e.preventDefault();var t=o.__background.getBoundingClientRect();return o.setValue(a_(e.clientX,t.left,t.right,o.__min,o.__max)),!1}function c(){Qb.unbind(window,"mousemove",l),Qb.unbind(window,"mouseup",c),o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}function h(e){var t=e.touches[0].clientX,i=o.__background.getBoundingClientRect();o.setValue(a_(t,i.left,i.right,o.__min,o.__max))}function u(){Qb.unbind(window,"touchmove",h),Qb.unbind(window,"touchend",u),o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}return s.__background=document.createElement("div"),s.__foreground=document.createElement("div"),Qb.bind(s.__background,"mousedown",(function(e){document.activeElement.blur(),Qb.bind(window,"mousemove",l),Qb.bind(window,"mouseup",c),l(e)})),Qb.bind(s.__background,"touchstart",(function(e){if(1!==e.touches.length)return;Qb.bind(window,"touchmove",h),Qb.bind(window,"touchend",u),h(e)})),Qb.addClass(s.__background,"slider"),Qb.addClass(s.__foreground,"slider-fg"),s.updateDisplay(),s.__background.appendChild(s.__foreground),s.domElement.appendChild(s.__background),s}return Hb(t,e),Fb(t,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",jb(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(i_),s_=function(e){function t(e,i,n){Ub(this,t);var a=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),r=a;return a.__button=document.createElement("div"),a.__button.innerHTML=void 0===n?"Fire":n,Qb.bind(a.__button,"click",(function(e){return e.preventDefault(),r.fire(),!1})),Qb.addClass(a.__button,"button"),a.domElement.appendChild(a.__button),a}return Hb(t,e),Fb(t,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),t}(Xb),o_=function(e){function t(e,i){Ub(this,t);var n=Gb(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));n.__color=new Vb(n.getValue()),n.__temp=new Vb(0);var a=n;n.domElement=document.createElement("div"),Qb.makeSelectable(n.domElement,!1),n.__selector=document.createElement("div"),n.__selector.className="selector",n.__saturation_field=document.createElement("div"),n.__saturation_field.className="saturation-field",n.__field_knob=document.createElement("div"),n.__field_knob.className="field-knob",n.__field_knob_border="2px solid ",n.__hue_knob=document.createElement("div"),n.__hue_knob.className="hue-knob",n.__hue_field=document.createElement("div"),n.__hue_field.className="hue-field",n.__input=document.createElement("input"),n.__input.type="text",n.__input_textShadow="0 1px 1px ",Qb.bind(n.__input,"keydown",(function(e){13===e.keyCode&&u.call(this)})),Qb.bind(n.__input,"blur",u),Qb.bind(n.__selector,"mousedown",(function(){Qb.addClass(this,"drag").bind(window,"mouseup",(function(){Qb.removeClass(a.__selector,"drag")}))})),Qb.bind(n.__selector,"touchstart",(function(){Qb.addClass(this,"drag").bind(window,"touchend",(function(){Qb.removeClass(a.__selector,"drag")}))}));var r,s=document.createElement("div");function o(e){p(e),Qb.bind(window,"mousemove",p),Qb.bind(window,"touchmove",p),Qb.bind(window,"mouseup",c),Qb.bind(window,"touchend",c)}function l(e){m(e),Qb.bind(window,"mousemove",m),Qb.bind(window,"touchmove",m),Qb.bind(window,"mouseup",h),Qb.bind(window,"touchend",h)}function c(){Qb.unbind(window,"mousemove",p),Qb.unbind(window,"touchmove",p),Qb.unbind(window,"mouseup",c),Qb.unbind(window,"touchend",c),d()}function h(){Qb.unbind(window,"mousemove",m),Qb.unbind(window,"touchmove",m),Qb.unbind(window,"mouseup",h),Qb.unbind(window,"touchend",h),d()}function u(){var e=kb(this.value);!1!==e?(a.__color.__state=e,a.setValue(a.__color.toOriginal())):this.value=a.__color.toString()}function d(){a.__onFinishChange&&a.__onFinishChange.call(a,a.__color.toOriginal())}function p(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=a.__saturation_field.getBoundingClientRect(),i=e.touches&&e.touches[0]||e,n=i.clientX,r=i.clientY,s=(n-t.left)/(t.right-t.left),o=1-(r-t.top)/(t.bottom-t.top);return o>1?o=1:o<0&&(o=0),s>1?s=1:s<0&&(s=0),a.__color.v=o,a.__color.s=s,a.setValue(a.__color.toOriginal()),!1}function m(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=a.__hue_field.getBoundingClientRect(),i=1-((e.touches&&e.touches[0]||e).clientY-t.top)/(t.bottom-t.top);return i>1?i=1:i<0&&(i=0),a.__color.h=360*i,a.setValue(a.__color.toOriginal()),!1}return Rb.extend(n.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),Rb.extend(n.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:n.__field_knob_border+(n.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),Rb.extend(n.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),Rb.extend(n.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),Rb.extend(s.style,{width:"100%",height:"100%",background:"none"}),c_(s,"top","rgba(0,0,0,0)","#000"),Rb.extend(n.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(r=n.__hue_field).style.background="",r.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",r.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",r.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",r.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",r.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",Rb.extend(n.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:n.__input_textShadow+"rgba(0,0,0,0.7)"}),Qb.bind(n.__saturation_field,"mousedown",o),Qb.bind(n.__saturation_field,"touchstart",o),Qb.bind(n.__field_knob,"mousedown",o),Qb.bind(n.__field_knob,"touchstart",o),Qb.bind(n.__hue_field,"mousedown",l),Qb.bind(n.__hue_field,"touchstart",l),n.__saturation_field.appendChild(s),n.__selector.appendChild(n.__field_knob),n.__selector.appendChild(n.__saturation_field),n.__selector.appendChild(n.__hue_field),n.__hue_field.appendChild(n.__hue_knob),n.domElement.appendChild(n.__input),n.domElement.appendChild(n.__selector),n.updateDisplay(),n}return Hb(t,e),Fb(t,[{key:"updateDisplay",value:function(){var e=kb(this.getValue());if(!1!==e){var t=!1;Rb.each(Vb.COMPONENTS,(function(i){if(!Rb.isUndefined(e[i])&&!Rb.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}}),this),t&&Rb.extend(this.__color.__state,e)}Rb.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,n=255-i;Rb.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,c_(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),Rb.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+n+","+n+","+n+",.7)"})}}]),t}(Xb),l_=["-moz-","-o-","-webkit-","-ms-",""];function c_(e,t,i,n){e.style.background="",Rb.each(l_,(function(a){e.style.cssText+="background: "+a+"linear-gradient("+t+", "+i+" 0%, "+n+" 100%); "}))}var h_=function(e,t){var i=t||document,n=document.createElement("style");n.type="text/css",n.innerHTML=e;var a=i.getElementsByTagName("head")[0];try{a.appendChild(n)}catch(e){}},u_='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>',d_=function(e,t){var i=e[t];return Rb.isArray(arguments[2])||Rb.isObject(arguments[2])?new $b(e,t,arguments[2]):Rb.isNumber(i)?Rb.isNumber(arguments[2])&&Rb.isNumber(arguments[3])?Rb.isNumber(arguments[4])?new r_(e,t,arguments[2],arguments[3],arguments[4]):new r_(e,t,arguments[2],arguments[3]):Rb.isNumber(arguments[4])?new n_(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new n_(e,t,{min:arguments[2],max:arguments[3]}):Rb.isString(i)?new e_(e,t):Rb.isFunction(i)?new s_(e,t,""):Rb.isBoolean(i)?new Kb(e,t):null};var p_=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},m_=function(){function e(){Ub(this,e),this.backgroundElement=document.createElement("div"),Rb.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),Qb.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),Rb.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var t=this;Qb.bind(this.backgroundElement,"click",(function(){t.hide()}))}return Fb(e,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),Rb.defer((function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"}))}},{key:"hide",value:function(){var e=this,t=function t(){e.domElement.style.display="none",e.backgroundElement.style.display="none",Qb.unbind(e.domElement,"webkitTransitionEnd",t),Qb.unbind(e.domElement,"transitionend",t),Qb.unbind(e.domElement,"oTransitionEnd",t)};Qb.bind(this.domElement,"webkitTransitionEnd",t),Qb.bind(this.domElement,"transitionend",t),Qb.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-Qb.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-Qb.getHeight(this.domElement)/2+"px"}}]),e}();h_(function(e){if(e&&"undefined"!=typeof window){var t=document.createElement("style");return t.setAttribute("type","text/css"),t.innerHTML=e,document.head.appendChild(t),e}}(".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n"));var f_="Default",g_=function(){try{return!!window.localStorage}catch(e){return!1}}(),y_=void 0,v_=!0,b_=void 0,__=!1,x_=[],w_=function e(t){var i=this,n=t||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),Qb.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],n=Rb.defaults(n,{closeOnTop:!1,autoPlace:!0,width:e.DEFAULT_WIDTH}),n=Rb.defaults(n,{resizable:n.autoPlace,hideable:n.autoPlace}),Rb.isUndefined(n.load)?n.load={preset:f_}:n.preset&&(n.load.preset=n.preset),Rb.isUndefined(n.parent)&&n.hideable&&x_.push(this),n.resizable=Rb.isUndefined(n.parent)&&n.resizable,n.autoPlace&&Rb.isUndefined(n.scrollable)&&(n.scrollable=!0);var a,r=g_&&"true"===localStorage.getItem(C_(this,"isLocal")),s=void 0,o=void 0;if(Object.defineProperties(this,{parent:{get:function(){return n.parent}},scrollable:{get:function(){return n.scrollable}},autoPlace:{get:function(){return n.autoPlace}},closeOnTop:{get:function(){return n.closeOnTop}},preset:{get:function(){return i.parent?i.getRoot().preset:n.load.preset},set:function(e){i.parent?i.getRoot().preset=e:n.load.preset=e,function(e){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].value===e.preset&&(e.__preset_select.selectedIndex=t)}(this),i.revert()}},width:{get:function(){return n.width},set:function(e){n.width=e,D_(i,e)}},name:{get:function(){return n.name},set:function(e){n.name=e,o&&(o.innerHTML=n.name)}},closed:{get:function(){return n.closed},set:function(t){n.closed=t,n.closed?Qb.addClass(i.__ul,e.CLASS_CLOSED):Qb.removeClass(i.__ul,e.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=t?e.TEXT_OPEN:e.TEXT_CLOSED)}},load:{get:function(){return n.load}},useLocalStorage:{get:function(){return r},set:function(e){g_&&(r=e,e?Qb.bind(window,"unload",s):Qb.unbind(window,"unload",s),localStorage.setItem(C_(i,"isLocal"),e))}}}),Rb.isUndefined(n.parent)){if(this.closed=n.closed||!1,Qb.addClass(this.domElement,e.CLASS_MAIN),Qb.makeSelectable(this.domElement,!1),g_&&r){i.useLocalStorage=!0;var l=localStorage.getItem(C_(this,"gui"));l&&(n.load=JSON.parse(l))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=e.TEXT_CLOSED,Qb.addClass(this.__closeButton,e.CLASS_CLOSE_BUTTON),n.closeOnTop?(Qb.addClass(this.__closeButton,e.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(Qb.addClass(this.__closeButton,e.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),Qb.bind(this.__closeButton,"click",(function(){i.closed=!i.closed}))}else{void 0===n.closed&&(n.closed=!0);var c=document.createTextNode(n.name);Qb.addClass(c,"controller-name"),o=S_(i,c);Qb.addClass(this.__ul,e.CLASS_CLOSED),Qb.addClass(o,"title"),Qb.bind(o,"click",(function(e){return e.preventDefault(),i.closed=!i.closed,!1})),n.closed||(this.closed=!1)}n.autoPlace&&(Rb.isUndefined(n.parent)&&(v_&&(b_=document.createElement("div"),Qb.addClass(b_,"dg"),Qb.addClass(b_,e.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(b_),v_=!1),b_.appendChild(this.domElement),Qb.addClass(this.domElement,e.CLASS_AUTO_PLACE)),this.parent||D_(i,n.width)),this.__resizeHandler=function(){i.onResizeDebounced()},Qb.bind(window,"resize",this.__resizeHandler),Qb.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),Qb.bind(this.__ul,"transitionend",this.__resizeHandler),Qb.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),n.resizable&&O_(this),s=function(){g_&&"true"===localStorage.getItem(C_(i,"isLocal"))&&localStorage.setItem(C_(i,"gui"),JSON.stringify(i.getSaveObject()))},this.saveToLocalStorageIfPossible=s,n.parent||((a=i.getRoot()).width+=1,Rb.defer((function(){a.width-=1})))};function S_(e,t,i){var n=document.createElement("li");return t&&n.appendChild(t),i?e.__ul.insertBefore(n,i):e.__ul.appendChild(n),e.onResize(),n}function M_(e){Qb.unbind(window,"resize",e.__resizeHandler),e.saveToLocalStorageIfPossible&&Qb.unbind(window,"unload",e.saveToLocalStorageIfPossible)}function T_(e,t){var i=e.__preset_select[e.__preset_select.selectedIndex];i.innerHTML=t?i.value+"*":i.value}function A_(e,t){var i=e.getRoot(),n=i.__rememberedObjects.indexOf(t.object);if(-1!==n){var a=i.__rememberedObjectIndecesToControllers[n];if(void 0===a&&(a={},i.__rememberedObjectIndecesToControllers[n]=a),a[t.property]=t,i.load&&i.load.remembered){var r=i.load.remembered,s=void 0;if(r[e.preset])s=r[e.preset];else{if(!r.Default)return;s=r.Default}if(s[n]&&void 0!==s[n][t.property]){var o=s[n][t.property];t.initialValue=o,t.setValue(o)}}}}function E_(e,t,i,n){if(void 0===t[i])throw new Error('Object "'+t+'" has no property "'+i+'"');var a=void 0;if(n.color)a=new o_(t,i);else{var r=[t,i].concat(n.factoryArgs);a=d_.apply(e,r)}n.before instanceof Xb&&(n.before=n.before.__li),A_(e,a),Qb.addClass(a.domElement,"c");var s=document.createElement("span");Qb.addClass(s,"property-name"),s.innerHTML=a.property;var o=document.createElement("div");o.appendChild(s),o.appendChild(a.domElement);var l=S_(e,o,n.before);return Qb.addClass(l,w_.CLASS_CONTROLLER_ROW),a instanceof o_?Qb.addClass(l,"color"):Qb.addClass(l,zb(a.getValue())),function(e,t,i){if(i.__li=t,i.__gui=e,Rb.extend(i,{options:function(t){if(arguments.length>1){var n=i.__li.nextElementSibling;return i.remove(),E_(e,i.object,i.property,{before:n,factoryArgs:[Rb.toArray(arguments)]})}if(Rb.isArray(t)||Rb.isObject(t)){var a=i.__li.nextElementSibling;return i.remove(),E_(e,i.object,i.property,{before:a,factoryArgs:[t]})}},name:function(e){return i.__li.firstElementChild.firstElementChild.innerHTML=e,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof r_){var n=new n_(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});Rb.each(["updateDisplay","onChange","onFinishChange","step","min","max"],(function(e){var t=i[e],a=n[e];i[e]=n[e]=function(){var e=Array.prototype.slice.call(arguments);return a.apply(n,e),t.apply(i,e)}})),Qb.addClass(t,"has-slider"),i.domElement.insertBefore(n.domElement,i.domElement.firstElementChild)}else if(i instanceof n_){var a=function(t){if(Rb.isNumber(i.__min)&&Rb.isNumber(i.__max)){var n=i.__li.firstElementChild.firstElementChild.innerHTML,a=i.__gui.__listening.indexOf(i)>-1;i.remove();var r=E_(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]});return r.name(n),a&&r.listen(),r}return t};i.min=Rb.compose(a,i.min),i.max=Rb.compose(a,i.max)}else i instanceof Kb?(Qb.bind(t,"click",(function(){Qb.fakeEvent(i.__checkbox,"click")})),Qb.bind(i.__checkbox,"click",(function(e){e.stopPropagation()}))):i instanceof s_?(Qb.bind(t,"click",(function(){Qb.fakeEvent(i.__button,"click")})),Qb.bind(t,"mouseover",(function(){Qb.addClass(i.__button,"hover")})),Qb.bind(t,"mouseout",(function(){Qb.removeClass(i.__button,"hover")}))):i instanceof o_&&(Qb.addClass(t,"color"),i.updateDisplay=Rb.compose((function(e){return t.style.borderLeftColor=i.__color.toString(),e}),i.updateDisplay),i.updateDisplay());i.setValue=Rb.compose((function(t){return e.getRoot().__preset_select&&i.isModified()&&T_(e.getRoot(),!0),t}),i.setValue)}(e,l,a),e.__controllers.push(a),a}function C_(e,t){return document.location.href+"."+t}function I_(e,t,i){var n=document.createElement("option");n.innerHTML=t,n.value=t,e.__preset_select.appendChild(n),i&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function P_(e,t){t.style.display=e.useLocalStorage?"block":"none"}function R_(e){var t=e.__save_row=document.createElement("li");Qb.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),Qb.addClass(t,"save-row");var i=document.createElement("span");i.innerHTML="&nbsp;",Qb.addClass(i,"button gears");var n=document.createElement("span");n.innerHTML="Save",Qb.addClass(n,"button"),Qb.addClass(n,"save");var a=document.createElement("span");a.innerHTML="New",Qb.addClass(a,"button"),Qb.addClass(a,"save-as");var r=document.createElement("span");r.innerHTML="Revert",Qb.addClass(r,"button"),Qb.addClass(r,"revert");var s=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?Rb.each(e.load.remembered,(function(t,i){I_(e,i,i===e.preset)})):I_(e,f_,!1),Qb.bind(s,"change",(function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value})),t.appendChild(s),t.appendChild(i),t.appendChild(n),t.appendChild(a),t.appendChild(r),g_){var o=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block","true"===localStorage.getItem(C_(0,"isLocal"))&&l.setAttribute("checked","checked"),P_(e,o),Qb.bind(l,"change",(function(){e.useLocalStorage=!e.useLocalStorage,P_(e,o)}))}var c=document.getElementById("dg-new-constructor");Qb.bind(c,"keydown",(function(e){!e.metaKey||67!==e.which&&67!==e.keyCode||y_.hide()})),Qb.bind(i,"click",(function(){c.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),y_.show(),c.focus(),c.select()})),Qb.bind(n,"click",(function(){e.save()})),Qb.bind(a,"click",(function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)})),Qb.bind(r,"click",(function(){e.revert()}))}function O_(e){var t=void 0;function i(i){return i.preventDefault(),e.width+=t-i.clientX,e.onResize(),t=i.clientX,!1}function n(){Qb.removeClass(e.__closeButton,w_.CLASS_DRAG),Qb.unbind(window,"mousemove",i),Qb.unbind(window,"mouseup",n)}function a(a){return a.preventDefault(),t=a.clientX,Qb.addClass(e.__closeButton,w_.CLASS_DRAG),Qb.bind(window,"mousemove",i),Qb.bind(window,"mouseup",n),!1}e.__resize_handle=document.createElement("div"),Rb.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),Qb.bind(e.__resize_handle,"mousedown",a),Qb.bind(e.__closeButton,"mousedown",a),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function D_(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function L_(e,t){var i={};return Rb.each(e.__rememberedObjects,(function(n,a){var r={},s=e.__rememberedObjectIndecesToControllers[a];Rb.each(s,(function(e,i){r[i]=t?e.initialValue:e.getValue()})),i[a]=r})),i}function k_(e){0!==e.length&&p_.call(window,(function(){k_(e)})),Rb.each(e,(function(e){e.updateDisplay()}))}w_.toggleHide=function(){__=!__,Rb.each(x_,(function(e){e.domElement.style.display=__?"none":""}))},w_.CLASS_AUTO_PLACE="a",w_.CLASS_AUTO_PLACE_CONTAINER="ac",w_.CLASS_MAIN="main",w_.CLASS_CONTROLLER_ROW="cr",w_.CLASS_TOO_TALL="taller-than-window",w_.CLASS_CLOSED="closed",w_.CLASS_CLOSE_BUTTON="close-button",w_.CLASS_CLOSE_TOP="close-top",w_.CLASS_CLOSE_BOTTOM="close-bottom",w_.CLASS_DRAG="drag",w_.DEFAULT_WIDTH=245,w_.TEXT_CLOSED="Close Controls",w_.TEXT_OPEN="Open Controls",w_._keydownHandler=function(e){"text"===document.activeElement.type||72!==e.which&&72!==e.keyCode||w_.toggleHide()},Qb.bind(window,"keydown",w_._keydownHandler,!1),Rb.extend(w_.prototype,{add:function(e,t){return E_(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return E_(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;Rb.defer((function(){t.onResize()}))},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&b_.removeChild(this.domElement);var e=this;Rb.each(this.__folders,(function(t){e.removeFolder(t)})),Qb.unbind(window,"keydown",w_._keydownHandler,!1),M_(this)},addFolder:function(e){if(void 0!==this.__folders[e])throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var i=new w_(t);this.__folders[e]=i;var n=S_(this,i.domElement);return Qb.addClass(n,"folder"),i},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],M_(e);var t=this;Rb.each(e.__folders,(function(t){e.removeFolder(t)})),Rb.defer((function(){t.onResize()}))},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=Qb.getOffset(e.__ul).top,i=0;Rb.each(e.__ul.childNodes,(function(t){e.autoPlace&&t===e.__save_row||(i+=Qb.getHeight(t))})),window.innerHeight-t-20<i?(Qb.addClass(e.domElement,w_.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-20+"px"):(Qb.removeClass(e.domElement,w_.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&Rb.defer((function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"})),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:Rb.debounce((function(){this.onResize()}),50),remember:function(){if(Rb.isUndefined(y_)&&((y_=new m_).domElement.innerHTML=u_),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;Rb.each(Array.prototype.slice.call(arguments),(function(t){0===e.__rememberedObjects.length&&R_(e),-1===e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)})),this.autoPlace&&D_(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=L_(this)),e.folders={},Rb.each(this.__folders,(function(t,i){e.folders[i]=t.getSaveObject()})),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=L_(this),T_(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=L_(this,!0)),this.load.remembered[e]=L_(this),this.preset=e,I_(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){Rb.each(this.__controllers,(function(t){this.getRoot().load.remembered?A_(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())}),this),Rb.each(this.__folders,(function(e){e.revert(e)})),e||T_(this.getRoot(),!1)},listen:function(e){var t=0===this.__listening.length;this.__listening.push(e),t&&k_(this.__listening)},updateDisplay:function(){Rb.each(this.__controllers,(function(e){e.updateDisplay()})),Rb.each(this.__folders,(function(e){e.updateDisplay()}))}});var N_=w_;class B_{constructor(e,t){this.times=e||[],this.values=t||[]}lerp(e){if(0==this.times.length)return;let t=0,i=this.times.length;for(;t<i&&e>this.times[t];)t++;if(0==t)return this.values[0];if(t==i)return this.values[i-1];const n=(e-this.times[t-1])/(this.times[t]-this.times[t-1]);return this.values[0]instanceof Ce?this.values[t-1].clone().lerp(this.values[t],n):this.values[t-1]+n*(this.values[t]-this.values[t-1])}clone(){const e=[...this.times],t=[...this.values];return new this.constructor(e,t)}}const z_=e=>{const t={};return new Qt(e).getHSL(t),new Ce(t.h,t.s,t.l)},U_={fire:function(){return{name:"火焰",shapeType:"sphere",position:new Ce(0,0,0),positionRadius:2,velocityShape:"cube",velocity:new Ce(0,20,0),sizeTween:new B_([0,.3,1],[1,15,1]),opacityTween:new B_([.7,1],[1,0]),colorTween:new B_([.5,1],[new Ce(.02,1,.5),new Ce(.05,1,0)]),colorChange:!0,textureURL:"texture/particles/smoke.png",pointSec:200}},snow:function(){return{name:"雪花",pointNum:200,shapeType:"cube",position:new Ce(0,30,0),positionRange:new Ce(50,0,50),velocityShape:"cube",velocity:new Ce(0,-10,0),velocityRange:new Ce(5,2,5),angle:0,angleRange:720,angleVelocity:0,angleVelocityRange:60,sizeTween:new B_([0,.25],[.2,2]),opacityTween:new B_([2,3],[.8,0]),deathAge:60,pointDeathAge:5,textureURL:"texture/particles/snowflake.png",pointSec:200}},water:function(){return{name:"喷泉",shapeType:"cube",positionRange:new Ce(1,2,1),velocity:new Ce(0,13,0),velocityRange:new Ce(7,5,7),acceleration:new Ce(0,-7,0),velocityShape:"cube",sizeTween:new B_([0,.25,4],[.2,3,.3]),colorTween:new B_([0,.5],[new Ce(.5,.1,.8),new Ce(.5,.9,.3)]),colorChange:!0,opacityTween:new B_([0,.2,3.5],[0,1,0]),deathAge:60,pointDeathAge:4,textureURL:"texture/particles/snowflake.png"}},smoke:function(){return{name:"烟雾",position:new Ce(0,2,0),sizeTween:new B_([0,1],[0,8]),positionRange:new Ce(1,10,1),velocity:new Ce(0,10,0),velocityRange:new Ce(4,5,4),acceleration:new Ce(0,-1,0),textureURL:"texture/particles/smoke.png",opacityTween:new B_([0,.3,2],[0,.5,0]),pointDeathAge:2,pointSec:100}},music:function(){return{name:"音符",sizeTween:new B_([0,3,10],[1,5,0]),positionRange:new Ce(10,0,10),acceleration:new Ce(0,-.1,0),velocity:new Ce(0,1,0),velocityRange:new Ce(5,-1,5),shapeType:"cube",velocityShape:"cube",textureURL:"texture/particles/yinfu.png",pointSec:10,pointDeathAge:10,angleRange:360,angleVelocity:20,colorTween:new B_([0,5,10],[z_("green"),z_("red"),z_("blue")]),colorChange:!0,opacityTween:new B_([0,5,10],[0,1,.1]),colorToRange:!0}},fireFly:function(){return{name:"萤火虫",shapeType:"cube",positionRange:new Ce(50,50,50),velocityShape:"cube",velocityRange:new Ce(2,2,2),textureURL:"texture/particles/spark.png",color:new Ce(.3,1,.6),colorRange:z_("blue"),colorToRange:!0,size:4,sizeRange:2,pointSec:20,pointDeathAge:8}}};const F_=Math.PI/180;class j_{constructor(e){this.shapeType="sphere",this.position=new Ce,this.positionRange=new Ce,this.startPos=new Ce,this.startPosRange=new Ce(50,0,50),this.positionRadius=0,this.positionRadiusRange=0,this.velocityShape="cube",this.velocity=new Ce,this.velocityRange=new Ce,this.waySpeed=0,this.waySpeedRange=0,this.speed=0,this.speedRange=0,this.acceleration=new Ce,this.accelerationRange=new Ce,this.inherit=!1,this.alive=0,this.age=0,this.deathAge=1,this._ageRandom=0,this.angle=0,this.angleRange=0,this.angleVelocity=0,this.angleVelocityRange=0,this.angleAcceleration=0,this.angleAccelerationRange=0,this.size=0,this.sizeRange=0,this.sizeRangePec=0,this._sizeTween=null,this.sizeTween=null,this.startSize=0,this.finalSize=0,this.startOpacity=0,this.finalOpacity=0,this.opacity=1,this.opacityRange=0,this._opacityTween=null,this.opacityTween=null,this.color=new Qt,this.colorRange=new Qt,this.colorTween=null,this.gravity=!1,this.offsetPos=new Ce(0,0,0),this.dataCombine(e),this.dataSave(),this.createRandomData()}dataSave(){this.defaultPosition=this.position.clone()}dataCombine(e){Object.assign(this,e),this.sizeTween=this._sizeTween.clone(),this.opacityTween=this._opacityTween.clone(),this.ageRandom=this._ageRandom}createRandomData(){if(this.deathAge=this.randomChange(this.deathAge,this.ageRandom),this.startPos=this.randomChange(this.startPos,this.startPosRange),"cube"==this.shapeType)this.position=this.randomChange(this.position,this.positionRange);else if("sphere"==this.shapeType){this.positionRadius=this.randomChange(this.positionRadius,this.positionRadiusRange);const e=2*Math.random()-1,t=2*Math.PI*Math.random(),i=Math.sqrt(1-e*e),n=new Ce(i*Math.cos(t),i*Math.sin(t),e);this.position=(new Ce).addVectors(this.position,n.multiplyScalar(this.positionRadius))}if(0==this.inherit&&this.position.add(this.offsetPos),"cube"==this.velocityShape){const e=this.waySpeed*this.waySpeedRange;this.waySpeed=this.randomChange(this.waySpeed,e),this.velocity.normalize();const t=this.velocityRange.clone();this.velocity=this.randomChange(this.velocity,t),this.velocity.normalize(),this.velocity.multiplyScalar(this.waySpeed)}else if("sphere"==this.velocityShape){const e=(new Ce).subVectors(this.position,this.defaultPosition),t=this.randomChange(this.speed,this.speedRange);this.velocity=e.normalize().multiplyScalar(t)}if(this.acceleration=this.randomChange(this.acceleration,this.accelerationRange),this.angle=this.randomChange(this.angle,this.angleRange),this.angleVelocity=this.randomChange(this.angleVelocity,this.angleVelocityRange),this.angleAcceleration=this.randomChange(this.angleAcceleration,this.angleAccelerationRange),this.sizeTween.times.length>0){const e=this.startSize*this.sizeRangePec;this.sizeTween.values[0]=this.randomChange(this.startSize,e);const t=this.finalSize*this.sizeRangePec;this.sizeTween.values[1]=this.randomChange(this.finalSize,t)}else this.size=this.randomChange(this.size,this.sizeRange);if(this.opacityTween.times.length>0){const e=this.startOpacity*this.opacityRange;this.opacityTween.values[0]=this.randomChange(this.startOpacity,e);const t=this.finalOpacity*this.opacityRange;this.opacityTween.values[1]=this.randomChange(this.finalOpacity,t)}else this.opacity=this.randomChange(this.opacity,this.opacityRange);const e=this.randomChange(this.color,this.colorRange);this.color=(new Qt).setHSL(e.x,e.y,e.z)}randomChange(e,t){if(e instanceof Ce&&t instanceof Ce){const i=new Ce(Math.random()-.5,Math.random()-.5,Math.random()-.5);return(new Ce).addVectors(e,(new Ce).multiplyVectors(t,i))}return e+t*(Math.random()-.5)}update(e){if(this.position.add(this.velocity.clone().multiplyScalar(e)),1==this.gravity&&this.velocity.add(this.acceleration.clone().multiplyScalar(e)),this.angle+=this.angleVelocity*F_*e,this.angleVelocity+=this.angleAcceleration*F_*e,this.sizeTween.times.length>0&&(this.size=this.sizeTween.lerp(this.age)),this.opacityTween.times.length>0&&(this.opacity=this.opacityTween.lerp(this.age)),this.colorTween.times.length>0){const e=this.colorTween.lerp(this.age);this.color=(new Qt).setHSL(e.x,e.y,e.z)}this.age+=e}}class H_{constructor(e={name:"粒子发射器",size:1,pointSec:200},t,i){this._instanceObj=t,this.moveState=!1,this.paintOffset=null,this._initInstanceData(),this.initPosHelperBox(),this.initData(e),this._initOther(),this.setFamily(i),this.setParams(e),this.initInstance(),this.createInstanceDataArray(),this.updateAcceleration(),this.getMaxOpacity(),this.getMaxSize(),this.createParticle(),this.onAliveChangeCallback=null}_initInstanceData(){this.helperArray=[],this.helper1Array=[],this.helper2Array=[]}initInstance(){this.updateBindingMatrix(),this.instancedObject?this.instanceCount=this.instancedObject.count:this.instanceCount=0}updateBindingMatrix(){const e=this._instanceObj.getMeshes();for(let t=0;t<e.length;t++)e[t].originalName&&e[t].originalName==this.storeBindingName&&(this.instancedObject=e[t])}createInstanceDataArray(){if(this.instanceData={},0==this.instanceCount){const e=new it;this.instanceData[0]={points:[],matrix:e}}for(let e=0;e<this.instanceCount;e++){const t=new it;this.updateBindingMatrix(),this.instancedObject.matrixWorld.needsUpdate=!0,this.instancedObject.getMatrixAt(e,t),this.instanceData[e]={points:[],matrix:t},this.createInstancePosHelper(e,t)}}updateInstanceMatrixData(e){const t=new it;this.updateBindingMatrix(),this.instancedObject.matrixWorld.needsUpdate=!0,this.instancedObject.getMatrixAt(e,t),this.instanceData[e]={points:[],matrix:t}}initData(e){let t;this._pointSec=100,this.name=null,this.position=new Ce,this.shapeType="cube",this.positionRange=new Ce,this.positionRadius=0,this.positionRadiusRange=0,this.velocityShape="cube",this.velocity=new Ce,this.velocityRange=new Ce,this.speed=0,this.speedRange=0,this.acceleration=new Ce,this.accelerationRange=new Ce,this.age=0,this._deathAge=60,this.pointAge=0,this.pointDeathAge=1,this.pointDeathAgeRange=0,this.alive=!1,this._loop=!0,this.pointNum=this._pointSec*this.instanceCount*this._deathAge,this.angle=0,this.angleRange=0,this.angleVelocity=0,this.angleVelocityRange=0,this.angleAcceleration=0,this.angleAccelerationRange=0,this._size=0,this._sizeRange=0,this._sizeRangePec=0,this._sizeTween=new B_([0,1],[0,0]),this._opacity=1,this._opacityRange=0,this.opacityTween=new B_([0,1],[1,1]),this.color=new Ce(1,1,1),this.colorRange=new Ce(0,0,0),this.colorToRange=!1,this.colorTween=new B_([0,1],[new Ce(1,1,1),new Ce(1,1,1)]),this.colorChange=!1,this.textureURL=e.textureURL,this.textureName=e.textureName||"",t=this.textureURL?0===this.textureURL.indexOf("http")||0===this.textureURL.indexOf("[[origin]]")||0===this.textureURL.indexOf("data:image/")?this.textureURL:_y.url(Ep.instance.resourceBasePath,this.textureURL):_y.url(Ep.instance.resourceBasePath,"texture/particles/star.png"),Ep.customTextureStore.loadTexture({url:t,name:this.textureName||t,onLoad:e=>{this._texture=new vs(e.textureSource),this._texture.flipY=!1,this.material&&(this.material.uniforms.maps.value=this._texture)}}),this._blendMode="AdditiveBlending",this._inherit=!1,this._speedArrow=!1,this.gravity=!1,this.deathpec=0,this._wayAngle=new dt(0,0,0,"XYZ"),this.wayAngle=new dt(0,0,0,"XYZ"),this._wayAngleHelperObject=new Et,this._wayAngleHelperObject.name="方向旋转辅助节点",this._waySpeed=this.velocity.length(),this._waySpeedRange=0,this._wayDirect=new Ce(0,1,0),this._wayAngleRange=0,this._wayAngleDirect=new Ce(0,1,0),this._far=0,this._near=0,this.offsetPos=new Ce,this._offsetPositionHelperObject=new Et,this._wayAngleHelperObject.name="偏移辅助节点",this._visibles=!0,this._visibleObjects=null,this._gravityValue=0,this._startSize=0,this._finalSize=0,this._startOpacity=1,this._finalOpacity=1,this._back=!1,this.storeBindingName=null}set pointDeathAges(e){this.pointDeathAge=e,this.pointSec=this._pointSec}get pointDeathAges(){return this.pointDeathAge}set rotSpeedRange(e=0){const t=e/100;this.angleVelocityRange=this.angleVelocity*t}get rotSpeedRange(){return this.angleVelocityRange/this.angleVelocity*100}set lookFar(e){this._far=e,this.material&&(this.material.uniforms.viewFar.value=this._far)}get lookFar(){return this._far}set lookNear(e){this._near=e,this.material&&(this.material.uniforms.viewNear.value=this._near)}get lookNear(){return this._near}set pointAgeRange(e){this.deathpec=e/100,this.pointDeathAgeRange=this.pointDeathAge*this.deathpec,this.pointSec=this._pointSec}get pointAgeRange(){return 100*this.deathpec}set wayAngleRange(e){this._wayAngleRange=e/100;const t=new Ce(1,1,1).multiplyScalar(this._wayAngleRange);this.velocityRange.copy(t)}get wayAngleRange(){return 100*this._wayAngleRange}set waySpeed(e){this._waySpeed=e;const t=this.updateVec3Rotate();this.velocity.copy(t)}get waySpeed(){return this._waySpeed}set waySpeedRange(e){this._waySpeedRange=e/100}get waySpeedRange(){return 100*this._waySpeedRange}set wayAngleX(e){e=ge.degToRad(e),this.wayAngle.x=e,this._wayAngleHelperObject.rotation.x=this.wayAngle.x}get wayAngleX(){return ge.radToDeg(this.wayAngle.x)}set wayAngleY(e){e=ge.degToRad(e),this.wayAngle.y=e,this._wayAngleHelperObject.rotation.y=this.wayAngle.y}get wayAngleY(){return ge.radToDeg(this.wayAngle.y)}set wayAngleZ(e){e=ge.degToRad(e),this.wayAngle.z=e,this._wayAngleHelperObject.rotation.z=this.wayAngle.z}get wayAngleZ(){return ge.radToDeg(this.wayAngle.z)}updateVec3Rotate(){const e=this._wayDirect.clone();return e.applyEuler(this._wayAngle),e}updateVec3RotateRange(e){const t=this._wayAngleDirect.clone();return t.applyEuler(e),t}set gravityValue(e){this._gravityValue=-e}get gravityValue(){return-this._gravityValue}updateAcceleration(){if(this.gravity){const e=this._gravityValue;if(this._inherit)this.acceleration.set(0,e,0);else{this.acceleration.set(0,e,0),this.posHelper.updateWorldMatrix();const t=this.posHelper.matrixWorld.clone();t.invert();const i=new it;i.extractRotation(t),this.acceleration.applyMatrix4(i)}}}updateInstanceAcceleration(e){let t=new Ce;if(this.gravity){const e=this._gravityValue;t.set(0,e,0)}return t}getMaxOpacity(){if(this.opacityTween.values.length>0){let e;for(let t=0,i=this.opacityTween.values.length;t<i;t++)null==e&&(e=this.opacityTween.values[t],this.opacityMaxNum=t),this.opacityTween.values[t]>e&&(e=this.opacityTween.values[t],this.opacityMaxNum=t)}}getMaxSize(){if(this._sizeTween.values.length>0){let e;for(let t=0,i=this._sizeTween.values.length;t<i;t++)null==e&&(e=this._sizeTween.values[t],this.sizeMaxNum=t),this._sizeTween.values[t]>e&&(e=this._sizeTween.values[t],this.sizeMaxNum=t)}}_initOther(){this.panelsVisible=!1,this.parentName=null,this.id=ge.generateUUID();let e=null;this.setFamily=t=>{t!=e&&(e=t)},this.getFamily=()=>e}setFamilyMatrix(e,t){e&&null!=t&&(this.familyMatrix=new it,this.familyMatrix.fromArray(e,t),this.originParentPosition=new Ce,this.originParentPosition.setFromMatrixPosition(this.familyMatrix))}get opacity(){return this._opacity}set opacity(e){this._opacity=e,null!=this.opacityMaxNum&&(this.opacityTween.values[this.opacityMaxNum]=this._opacity)}get opacityRange(){return 100*this._opacityRange}set opacityRange(e){const t=e/100;this._opacityRange=t}set startSize(e){this._startSize=e,this._sizeTween.values[0]=this._startSize}get startSize(){return this._sizeTween.values[0]}set finalSize(e){this._finalSize=e,this._sizeTween.values[1]=this._finalSize}get finalSize(){return this._sizeTween.values[1]}set startOpacity(e){this._startOpacity=e,this.opacityTween.values[0]=e}get startOpacity(){return this._startOpacity}set finalOpacity(e){this._finalOpacity=e,this.opacityTween.values[1]=e}get finalOpacity(){return this._finalOpacity}set size(e){this._size=e,null!=this.sizeMaxNum&&(this._sizeTween.values[this.sizeMaxNum]=this._size)}get size(){return this._size}set sizeRange(e){this._sizeRangePec=e/100,this._sizeRange=this._sizeRangePec*this._size}get sizeRange(){return 100*this._sizeRangePec}get pointSec(){return this._pointSec}set pointSec(e){this._pointSec=e,this.mesh&&this.particleNumChange(this._pointSec)}reset(){this.particleNumChange(this._pointSec)}set state(e){this.alive=e,this.age=0}get state(){return this.alive}set loop(e){this._loop=e,this.alive=!0,this.age=0}get loop(){return this._loop}set map(e){let t;this.textureURL=e,t=this.textureURL?0===this.textureURL.indexOf("http")||0===this.textureURL.indexOf("[[origin]]")||0===this.textureURL.indexOf("data:image/")?this.textureURL:_y.url(Ep.instance.resourceBasePath,this.textureURL):_y.url(Ep.instance.resourceBasePath,"texture/particles/star.png"),Ep.customTextureStore.loadTexture({url:t,name:this.textureName||t,onLoad:e=>{this._texture=new vs(e.textureSource),this._texture.flipY=!1,this.material&&(this.material.uniforms.maps.value=this._texture)}})}get map(){return this._texture}set deathAge(e){this.state=!1,this._deathAge=e,this.state=!0}get deathAge(){return this._deathAge}get startColor(){let e=this.getColor(this.color);return 1==this.colorChange&&(e=this.getColor(this.colorTween.values[0])),e}set startColor(e){this.color=this.toColor(e),this.colorTween.values[0]=this.toColor(e)}get finalColor(){return this.getColor(this.colorTween.values[1])}set finalColor(e){this.colorTween.values[1]=this.toColor(e)}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.mesh&&(this.mesh.material.blending=eu[this._blendMode])}setParent(e){this.mesh.parent?e.uuid!=this.mesh.parent.uuid&&(this.mesh.parent.remove(this.mesh),this.posHelper.parent.remove(this.posHelper),this.parentName=e.name,e.add(this.mesh),e.add(this.posHelper),e.add(this._offsetPositionHelperObject),e.add(this._wayAngleHelperObject)):(this.parentName=e.name,e.add(this.mesh),e.add(this.posHelper),e.add(this._offsetPositionHelperObject),e.add(this._wayAngleHelperObject))}setParentByUUID(e){const t=this.getFamily().getObjectByProperty("uuid",e);t?this.setParent(t):(console.warn("由于没有找到对应的uuid,该父对象将设置为默认的group"),this.setParent(this.getFamily()))}setParentByName(e){const t=this.getFamily().getObjectByName(e);t?this.setParent(t):(console.warn("由于没有找到对应的name,该父对象将设置为默认的group"),this.setParent(this.getFamily()))}setParams(e){for(let t in e)t.indexOf("size")>-1&&!t.indexOf("_")>-1&&(e[`_${t}`]=e[t]);this.familyMatrixArray=e.familyMatrixArray,this.familyMatrixOffset=e.familyMatrixOffset,this.setFamilyMatrix(e.familyMatrixArray,e.familyMatrixOffset),e.inheritPos=!1;let t,i=e.alive;e.alive=!1,Object.assign(this,e),this.updateVelocity(),this.alive=void 0===i||i,this.deathpec=this.pointDeathAgeRange/this.pointDeathAge,this._pointSec=e.pointSec,this.id=ge.generateUUID(),this.pointNum=this._pointSec*this._deathAge,t=this.textureURL?0===this.textureURL.indexOf("http")||0===this.textureURL.indexOf("[[origin]]")||0===this.textureURL.indexOf("data:image/")?this.textureURL:_y.url(Ep.instance.resourceBasePath,this.textureURL):_y.url(Ep.instance.resourceBasePath,"texture/particles/star.png"),Ep.customTextureStore.loadTexture({url:t,name:this.textureName||t,onLoad:e=>{this._texture=new vs(e.textureSource),this._texture.flipY=!1,this.material&&(this.material.uniforms.maps.value=this._texture)}}),this.colorTween.values.length>0&&(this.color=this.colorTween.values[0]);const n=this.updateVec3Rotate();this.velocity.copy(n)}getParams(){return{position:this.position,positionRange:this.positionRange,shapeType:this.shapeType,positionRadius:this.positionRadius,velocityShape:this.velocityShape,velocity:this.velocity,velocityRange:this.velocityRange,speed:this.speed,speedRange:this.speedRange,acceleration:this.acceleration,accelerationRange:this.accelerationRange,age:this.pointAge,deathAge:this.pointDeathAge,ageRandom:this.pointDeathAgeRange,angle:this.angle,angleRange:this.angleRange,angleVelocity:this.angleVelocity,angleVelocityRange:this.angleVelocityRange,angleAcceleration:this.angleAcceleration,angleAccelerationRange:this.angleAccelerationRange,size:this._size,sizeRange:this._sizeRange,sizeTween:this._sizeTween,opacity:this._opacity,opacityRange:this._opacityRange,opacityTween:this.opacityTween,color:this.color,startColor:this.startColor,finalColor:this.finalColor,colorRange:this.colorRange,colorTween:this.colorTween,_loop:this._loop,_texture:this._texture,pointNum:this.pointNum}}initPointStartData(e,t){let i;1==this.colorToRange?this.colorRange=new Ce(1,1,1):this.colorRange=new Ce(0,0,0),this.colorTween.times[1]=this.pointDeathAge,this._sizeTween.times[1]=this.pointDeathAge,this.opacityTween.times[1]=this.pointDeathAge,i=1==this.colorChange?this.colorTween:new B_;let n=new Ce,a=new Ce(0,0,0);this.instancedObject&&this.instancedObject.matrixWorld&&a.setFromMatrixPosition(this.instancedObject.parent.matrix);let r=this._wayDirect.clone();const s=this.updateInstanceAcceleration(e);if(this.helper2Array[t]){let e;this.moveState?e=this.helper2Array[t].matrixWorld.clone():(e=this.helper2Array[t].matrixWorld.clone(),e.multiply(this.instancedObject.matrix)),n.setFromMatrixPosition(e);const i=new it;i.extractRotation(this.helperArray[t].matrixWorld);const a=new it;a.makeRotationFromEuler(this.wayAngle),i.multiply(a),r.applyMatrix4(i)}else n.setFromMatrixPosition(e);return this.moveState?(this.paintOffset&&(n.sub(this.paintOffset),n.sub(this.paintOffset)),n.sub(a)):n.sub(a),this.pointMatrixData=new j_({pointNum:this._pointSec,position:n,positionRange:this.positionRange,shapeType:this.shapeType,positionRadius:this.positionRadius,positionRadiusRange:this.positionRadiusRange,velocityShape:this.velocityShape,velocity:r,velocityRange:this.velocityRange,speed:this.speed,speedRange:this.speedRange,acceleration:s,accelerationRange:this.accelerationRange,age:this.pointAge,deathAge:this.pointDeathAge,deathAgeRange:this.pointDeathAge,_ageRandom:this.pointDeathAgeRange,angle:this.angle,angleRange:this.angleRange,angleVelocity:this.angleVelocity,angleVelocityRange:this.angleVelocityRange,angleAcceleration:this.angleAcceleration,angleAccelerationRange:this.angleAccelerationRange,size:this._size,sizeRange:this._sizeRange,sizeRangePec:this._sizeRangePec,_sizeTween:this._sizeTween,opacity:this._opacity,opacityRange:this._opacityRange,_opacityTween:this.opacityTween,color:this.color,colorRange:this.colorRange,colorTween:i,deathAge:this.pointDeathAge,waySpeed:this._waySpeed,waySpeedRange:this._waySpeedRange,offsetPos:new Ce(0,0,0),inherit:this._inherit,startSize:this._startSize,finalSize:this._finalSize,startOpacity:this._startOpacity,finalOpacity:this._finalOpacity}),this.pointMatrixData}resize(e){this.material.uniforms.resize.value=e}createParticle(){this.geometry=new wi,this.pointAnimationData=[];const e=[],t=[],i=[],n=[],a=[],r=[],s=[];for(let o=0;o<this.pointNum;o++){let l=o%this.instanceCount;isNaN(l)&&(l=0),this.pointAnimationData[o]=this.initPointStartData(this.instanceData[l].matrix,l),e[3*o]=this.pointAnimationData[o].position.x,e[3*o+1]=this.pointAnimationData[o].position.y,e[3*o+2]=this.pointAnimationData[o].position.z,t[o]=this.pointAnimationData[o].angle,i[o]=this.pointAnimationData[o].size,n[o]=this.pointAnimationData[o].opacity,a[3*o]=this.pointAnimationData[o].color.r,a[3*o+1]=this.pointAnimationData[o].color.g,a[3*o+2]=this.pointAnimationData[o].color.b,r[o]=this.pointAnimationData[o].alive,s[3*o]=this.pointAnimationData[o].startPos.x,s[3*o+1]=this.pointAnimationData[o].startPos.y,s[3*o+2]=this.pointAnimationData[o].startPos.z}this.geometry.setAttribute("position",new hi(e,3)),this.geometry.setAttribute("startPos",new hi(s,3)),this.geometry.setAttribute("angle",new hi(t,1)),this.geometry.setAttribute("size",new hi(i,1)),this.geometry.setAttribute("opacity",new hi(n,1)),this.geometry.setAttribute("color",new hi(a,3)),this.geometry.setAttribute("visible",new hi(r,1)),this.material=new Yi({uniforms:{maps:{value:this._texture},density:{value:0},viewNear:{value:this._near},viewFar:{value:this._far},resize:{value:0},scale:{value:new Ce(1,1,1)}},vertexShader:"\n\nattribute float angle;\nattribute float size;\nattribute float opacity;\nattribute vec3 color;\nattribute float visible;\n\nvarying float v_Angle;\nvarying float v_Opacity;\nvarying vec3 v_Color;\n\n\nvarying vec3 v_startPos;\nattribute vec3 startPos;\nuniform float density;//更改粒子消失比例\nvarying float v_visibleNum;\nvarying float vDistance;\nuniform float resize;\nuniform vec3 scale;\n\nfloat random(in vec2 st){\n    return fract(sin(dot(st.xy,\n                vec2(12.9898,78.233)))\n            *43758.5453123);\n        }\n        \n        float noise(in vec2 st){\n            vec2 i=floor(st);\n            vec2 f=fract(st);\n            \n            // Four corners in 2D of a tile\n            float a=random(i);\n            float b=random(i+vec2(1.,0.));\n            float c=random(i+vec2(0.,1.));\n            float d=random(i+vec2(1.,1.));\n            \n            // Smooth Interpolation\n            \n            // Cubic Hermine Curve.  Same as SmoothStep()\n            vec2 u=f*f*(3.-2.*f);\n            // u = smoothstep(0.,1.,f);\n            \n            // Mix 4 coorners percentages\n            return mix(a,b,u.x)+\n            (c-a)*u.y*(1.-u.x)+\n            (d-b)*u.x*u.y;\n        }\n\nvoid main(){\n\n    v_startPos=startPos;\n    vec3 noisemap=vec3(noise(startPos.xz*1.0));\n    float visibleNum=smoothstep(density,density+.001,noisemap.r);\n    v_visibleNum=visibleNum;\n    \n    v_Angle=angle;\n    v_Opacity=opacity;\n    if(visible>.5){\n        v_Color=color;\n    }else{\n        v_Color=vec3(0.);\n        v_Opacity=0.;\n    }\n\n    vec3 position2=vec3(position.x/scale.x,position.y/scale.y,position.z/scale.z);\n\n    vec4 ppos=modelViewMatrix*vec4(position2,1.);\n    gl_Position=projectionMatrix*ppos;\n    float values=1.;\n    if(resize!=0.){\n        values=values*(resize/960.);\n    }\n    gl_PointSize=size*(300./length(ppos.xyz))*values;\n    vDistance=distance(cameraPosition,position);\n}",fragmentShader:"\n\nuniform sampler2D maps;\nvarying float v_Angle;\nvarying float v_Opacity;\nvarying vec3 v_Color;\nvarying float v_visibleNum;\nuniform float density;\nuniform float viewNear;\nuniform float viewFar;\nvarying float vDistance;\n\nmat2 rotate2d(float _angle){\n    return mat2(cos(_angle),-sin(_angle),\n    sin(_angle),cos(_angle));\n}\n\nvoid main(){\n    \n    vec4 Colors=vec4(v_Color,v_Opacity);\n    // gl_FragColor=Colors;\n    \n    // gl_FragColor=vec4(1.,1.,1.,v_Opacity);\n    vec2 uvs=vec2(gl_PointCoord.x,gl_PointCoord.y);\n    uvs-=.5;\n    uvs=rotate2d(v_Angle)*uvs;\n    \n    vec4 textures=texture2D(maps,uvs+.5);\n    \n    gl_FragColor=Colors*textures;\n\n    if(vDistance>=viewNear&&vDistance<=viewFar){\n        if(density!=0.){\n            gl_FragColor.a=min(gl_FragColor.a,v_visibleNum);\n        }\n     \n    }\n    else{\n        if(viewFar==0.&&viewNear==0.||viewFar<viewNear){\n            if(density!=0.){\n                gl_FragColor.a=min(gl_FragColor.a,v_visibleNum);\n             \n               \n            }\n         \n        }else{\n            gl_FragColor.a=0.;\n       \n         \n        }\n   \n\n    }\n}",transparent:!0,alphaTest:.5,depthWrite:!1,blending:eu[this._blendMode],side:2}),this.mesh=new ms(this.geometry,this.material),this.mesh.frustumCulled=!1,this.mesh.styleType="particle",this.mesh.system=this}set density(e){e=1-e,this.mesh.material.uniforms.density.value=e}get density(){return 1-this.mesh.material.uniforms.density.value}updateInstanceMatrix(){this.initInstance(),this.createInstanceDataArray(),this.particleNumChange(this._pointSec)}particleNumChange(e=200){this.state=!1,this._pointSec=e;const t=this._pointSec*this.instanceCount*this._deathAge;this.pointNum=Math.ceil(t);const i=[],n=[],a=[],r=[],s=[],o=[],l=[];for(let e=0;e<this.pointNum;e++){let t=e%this.instanceCount;isNaN(t)&&(t=0),this.pointAnimationData[e]=this.initPointStartData(this.instanceData[t].matrix,t),i[3*e]=this.pointAnimationData[e].position.x,i[3*e+1]=this.pointAnimationData[e].position.y,i[3*e+2]=this.pointAnimationData[e].position.z,n[e]=this.pointAnimationData[e].angle,a[e]=this.pointAnimationData[e].size,r[e]=this.pointAnimationData[e].opacity,s[3*e]=this.pointAnimationData[e].color.r,s[3*e+1]=this.pointAnimationData[e].color.g,s[3*e+2]=this.pointAnimationData[e].color.b,o[e]=this.pointAnimationData[e].alive,l[3*e]=this.pointAnimationData[e].startPos.x,l[3*e+1]=this.pointAnimationData[e].startPos.y,l[3*e+2]=this.pointAnimationData[e].startPos.z}this.mesh.geometry.setAttribute("position",new hi(i,3)),this.mesh.geometry.setAttribute("startPos",new hi(l,3)),this.mesh.geometry.setAttribute("angle",new hi(n,1)),this.mesh.geometry.setAttribute("size",new hi(a,1)),this.mesh.geometry.setAttribute("opacity",new hi(r,1)),this.mesh.geometry.setAttribute("color",new hi(s,3)),this.mesh.geometry.setAttribute("visible",new hi(o,1)),Ep.instance.nextRender((()=>{this.state=!0,this._back=!0}))}initPosHelperBox(){this.posHelper=new Et,this.posHelper.name="辅助父节点",this.posHelper2=new Et,this.posHelper2.name="辅助子节点",this.posHelper3=new Et,this.posHelper3.name="辅助父节点一",this.posHelper.add(this.posHelper2),this.posHelper.add(this.posHelper3)}testBox(e=10,t="green"){return new Fi(new Hi(e,e,e),new So({color:t,wireframe:!0}))}createInstancePosHelper(e,t){const i=new Et;i.name="p0",i.matrixAutoUpdate=!1,this.getFamily().add(i);const n=new Et;n.name="p1";const a=new Et;a.name="p2",i.add(n),i.add(a),i.applyMatrix4(t),this.helperArray[e]=i,this.helper1Array[e]=n,this.helper2Array[e]=a}updateInstancePosHelper(e){this.instancedObject.getMatrixAt(e,this.helperArray[e].matrix),this.familyMatrix&&(this.helperArray[e].matrix.multiply(this.familyMatrix),this.moveState||this.getFamily().position.set(0,0,0)),this.helper1Array[e].position.copy(this.position),this.helper2Array[e].matrixWorldNeedsUpdate=!0,this.helper2Array[e].position.copy(this.offsetPos.clone().add(this.position))}updatePosBox(){this.posHelper2&&(this.posHelper2.position.copy(this.position),this.posHelper2.rotation.copy(this._wayAngle),this.posHelper2.updateWorldMatrix()),this.posHelper3&&(this.posHelper3.position.copy(this.posHelper2.position),this.posHelper3.position.add(this.offsetPos),this.posHelper3.updateWorldMatrix())}setPosApply(){this.posHelper.applyMatrix4(this.mesh.matrix),this.getFamily().remove(this.mesh),this.updateVelocity(),this.updatePos(),this.reset(),Ep.scene.add(this.mesh)}updatePos(){this.posHelper3.position.copy(this.posHelper2.position),this.posHelper3.position.add(this.offsetPos),this.posHelper3.updateWorldMatrix();const e=this.posHelper3.matrixWorld,t=new Ce;t.setFromMatrixPosition(e),this.position.copy(t)}backPosApply(){this.mesh&&this.mesh.parent&&this.mesh.parent==Ep.scene&&(Ep.scene.remove(this.mesh),this.mesh.applyMatrix4(this.posHelper.matrix),this.position.copy(this.posHelper2.position),this.updateVelocity(),this.reset(),this.getFamily().add(this.mesh))}updateVelocity(){if(this.posHelper2.rotation.copy(this.wayAngle),this._inherit){const e=new dt(0,0,0);this.posHelper2.updateWorldMatrix();const t=this.posHelper2.matrixWorld;e.setFromRotationMatrix(t),this._wayAngle.copy(e);const i=this.updateVec3Rotate();this.velocity.copy(i)}else{this._wayAngle.copy(this.posHelper2.rotation);const e=this.updateVec3Rotate();this.velocity.copy(e)}}updateInstanceVelocity(e){const t=new dt;t.setFromRotationMatrix(matrix);const i=this._wayDirect.clone(),n=new dt(t.x+this.wayAngle.x,-t.y+this.wayAngle.y,-t.z+this.wayAngle.z);return i.applyEuler(n),i}set inheritPos(e){e?this.getFamily()?(this._inherit=e,this._back=this._inherit,this.setPosApply()):Ep.instance.nextRender((()=>{this.inheritPos=!0})):(this._inherit=e,this.backPosApply())}get inheritPos(){return this._inherit}set speedArrow(e){if(this.mesh&&this.mesh.parent)if(this._speedArrow=e,this._speedArrow){if(!this.arrowHelper){const e=new Ce;e.copy(this.velocity),e.normalize(),this.arrowHelper=new wh(e,this.position,this.velocity.distanceTo(new Ce(0,0,0)),"#FF0036"),this.arrowHelper.traverse((e=>{e.material&&(e.material.depthTest=!1,e.material.transparent=!0,e.renderOrder=12e9)})),this._wayAngleHelperObject.parent.add(this.arrowHelper)}}else this.arrowHelper&&(this._wayAngleHelperObject.parent.remove(this.arrowHelper),this.arrowHelper=null)}get speedArrow(){return this._speedArrow}checkFamilyVisible(e){1==this._visibles&&e&&(e.isScene||(0==e.visible?(this._visibleObjects=e,this.mesh.visible=!1,this._visibles=!1):this.checkFamilyVisible(e.parent)))}checkHide(e,t){e&&(e.isScene||(0==e.visible?"function"==typeof t&&t(!1):this.checkHide(e.parent,t)))}checkFamilyVisible2(){this._visibles=!0,this.checkHide(this.getFamily(),(e=>{this._visibles=!1})),this.mesh.visible=this._visibles}updateVec3RotateParam(e){const t=this._wayDirect.clone();return t.applyEuler(e),t}update(e){if(this.checkFamilyVisible2(),!this._visibles)return;if(this._offsetPositionHelperObject.position.copy(this.offsetPos),this._wayAngleHelperObject.position.copy(this.offsetPos),this.arrowHelper){this.arrowHelper.position.copy(this.offsetPos);const e=new Ce;let t=this.updateVec3RotateParam(this.posHelper2.rotation);e.copy(t),this.arrowHelper.setDirection(e),this.arrowHelper.scale.setScalar(Ep.camera.position.distanceTo(this.posHelper2.getWorldPosition(new Ce))/5)}this._inherit?(1==this._visibles||0==this._visibles&&this._visibleObjects&&1==this._visibleObjects.visible&&(this.mesh.visible=!0,this._visibles=!0),this.updatePos()):this.updatePosBox();const t=this.geometry.attributes.position.array,i=this.geometry.attributes.angle.array,n=this.geometry.attributes.size.array,a=this.geometry.attributes.opacity.array,r=this.geometry.attributes.color.array,s=this.geometry.attributes.visible.array,o=this.geometry.attributes.startPos.array,l=[];for(let o=0;o<this.pointNum;o++){const c=this.pointAnimationData[o];if(this._back&&this._inherit){o<this.pointNum-1?c.age=c.deathAge+1:this._back=!1}1==c.alive&&(c.gravity=this.gravity,c.update(e),c.age>c.deathAge&&(c.alive=0,l.push(o)),t[3*o]=c.position.x,t[3*o+1]=c.position.y,t[3*o+2]=c.position.z,i[o]=c.angle,n[o]=c.size,a[o]=c.opacity,r[3*o]=c.color.r,r[3*o+1]=c.color.g,r[3*o+2]=c.color.b,s[o]=c.alive)}if(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.angle.needsUpdate=!0,this.geometry.attributes.size.needsUpdate=!0,this.geometry.attributes.opacity.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.attributes.visible.needsUpdate=!0,this.alive){if(this.age<this.pointDeathAge){let t=Math.round(this._pointSec*this.instanceCount*(this.age+0)),i=Math.round(this._pointSec*this.instanceCount*(this.age+e));i>this.pointNum&&(i=this.pointNum);for(let e=t;e<i;e++)this.pointAnimationData[e].alive=1}for(let e=0;e<l.length;e++){const i=l[e];let n=i%this.instanceCount;isNaN(n)&&(n=0),this.updateInstanceMatrixData(i),this.updateInstancePosHelper(n),this.pointAnimationData[i]=this.initPointStartData(this.instanceData[n].matrix,n),this.pointAnimationData[i].alive=1,t[3*i]=this.pointAnimationData[i].position.x,t[3*i+1]=this.pointAnimationData[i].position.y,t[3*i+2]=this.pointAnimationData[i].position.z,o[3*i]=this.pointAnimationData[i].startPos.x,o[3*i+1]=this.pointAnimationData[i].startPos.y,o[3*i+2]=this.pointAnimationData[i].startPos.z}this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.startPos.needsUpdate=!0,this.age+=e,this.deathpec=this.pointDeathAgeRange/this.pointDeathAge,this.age>this._deathAge&&!this.loop&&(this.alive=!1,this.onAliveChangeCallback&&this.onAliveChangeCallback(this))}}showPanel(){let e;this.panels=new N_,e=this.name?this.name:"粒子动画管理器";const t=this.panels.addFolder(e);t.open(),t.add(this,"_pointSec",0,1e3,1).name("粒子数量").onChange((e=>{this.particleNumChange(e)})),t.add(this,"density",0,1,.01).name("粒子密度百分比");const i=t.addFolder("基础设置");i.open(),i.add(this,"shapeType",["sphere","cube"]).name("初始位置类型").onChange((e=>{this.shapeType=e}));const n=i.addFolder("cube类型初始位置"),a=n.addFolder("cube位置初始范围");a.add(this.position,"x",-500,500,1).name("位置X").onChange((e=>{this.position.x=e})),a.add(this.position,"y",-500,500,1).name("位置Y").onChange((e=>{this.position.y=e})),a.add(this.position,"z",-500,500,1).name("位置Z").onChange((e=>{this.position.z=e}));const r=n.addFolder("cube位置随机范围");r.add(this.positionRange,"x",-500,500,1).name("x").onChange((e=>{this.positionRange.x=e})),r.add(this.positionRange,"y",-500,500,1).name("y").onChange((e=>{this.positionRange.y=e})),r.add(this.positionRange,"z",-500,500,1).name("z").onChange((e=>{this.positionRange.z=e}));const s=i.addFolder("sphere类型初始位置");s.add(this,"positionRadius",0,100,.1).name("球体发射半径").onChange((e=>{this.positionRadius=e})),s.add(this,"positionRadiusRange",0,100,.1).name("球体发射半径随机范围").onChange((e=>{this.positionRadiusRange=e})),i.add(this,"velocityShape",["sphere","cube"]).name("发射方向类型").onChange((e=>{this.velocityShape=e}));const o=i.addFolder("发射类型cube速度");o.add(this,"speedArrow").name("方向辅助"),o.add(this.velocity,"x",-50,50,.1).name("x").listen().onChange((e=>{this.velocity.x=e})),o.add(this.velocity,"y",-50,50,.1).name("y").listen().onChange((e=>{this.velocity.y=e})),o.add(this.velocity,"z",-50,50,.1).name("z").listen().onChange((e=>{this.velocity.z=e})),o.add(this,"wayAngleX",-180,180),o.add(this,"wayAngleY",-180,180),o.add(this,"wayAngleZ",-180,180),o.add(this,"waySpeed",0,100).listen(),o.add(this,"waySpeedRange",0,100).listen(),o.add(this,"wayAngleRange",0,720);const l=o.addFolder("发射类型cube随机速度范围");l.add(this.velocityRange,"x",-50,50,.1).name("x").onChange((e=>{this.velocity.x=e})),l.add(this.velocityRange,"y",-50,50,.1).name("y").onChange((e=>{this.velocity.y=e})),l.add(this.velocityRange,"z",-50,50,.1).name("z").onChange((e=>{this.velocity.z=e}));const c=i.addFolder("发射类型sphere速度");c.add(this,"speed",0,100,.1).name("球状发射速度").onChange((e=>{this.speed=e})),c.add(this,"speedRange",0,100,.1).name("球状发射速度变化范围").onChange((e=>{this.speedRange=e}));const h=i.addFolder("加速度"),u=h.addFolder("初始化加速度");u.add(this,"gravity").name("加速度影响"),u.add(this.acceleration,"x",-100,100,.1).name("x").onChange((e=>{this.acceleration.x=e})),u.add(this.acceleration,"y",-100,100,.1).name("y").onChange((e=>{this.acceleration.y=e})),u.add(this.acceleration,"z",-100,100,.1).name("z").onChange((e=>{this.acceleration.z=e}));const d=h.addFolder("加速度随机范围");d.add(this.accelerationRange,"x",-100,100,.1).name("x").onChange((e=>{this.accelerationRange.x=e})),d.add(this.accelerationRange,"y",-100,100,.1).name("y").onChange((e=>{this.accelerationRange.y=e})),d.add(this.accelerationRange,"z",-100,100,.1).name("z").onChange((e=>{this.accelerationRange.z=e}));const p=t.addFolder("时间周期");p.add(this,"age",0,120,.1).name("播放时间").listen().onChange((e=>{this.age=e})),p.add(this,"_deathAge",0,120,1).name("生命周期").onChange((e=>{this._deathAge=e})),p.add(this,"pointDeathAge",0,120,1).name("内部粒子生命周期").onChange((e=>{this.pointDeathAge=e})),p.add(this,"alive").name("持续播放").onChange((e=>{this.alive=e})),p.add(this,"pointDeathAgeRange",0,100).name("粒子周期随机"),p.add(this,"_loop").name("是否循环").onChange((e=>{this._loop=e}));const m=t.addFolder("粒子状态"),f=m.addFolder("角度状态");f.add(this,"angle",0,360,.1).name("初始化角度").onChange((e=>{this.angle=e})),f.add(this,"angleRange",0,360,.1).name("初始化角度随机范围").onChange((e=>{this.angleRange=e})),f.add(this,"angleVelocity",0,360,.1).name("角度旋转速度").onChange((e=>{this.angleVelocity=e})),f.add(this,"angleVelocityRange",0,360,.1).name("角度旋转速度随机范围").onChange((e=>{this.angleVelocityRange=e})),f.add(this,"angleAcceleration",0,360,.1).name("角度加速度").onChange((e=>{this.angleAcceleration=e})),f.add(this,"angleAccelerationRange",0,360,.1).name("角度加速度范围").onChange((e=>{this.angleAccelerationRange=e}));const g=m.addFolder("大小状态");g.add(this,"size",0,100,.1).name("大小尺寸").onChange((e=>{this._size=e})),g.add(this,"sizeRange",0,100,.1).name("大小随机范围").onChange((e=>{this._sizeRange=e}));const y=g.addFolder("大小变化动画");let v={startTime:this._sizeTween.times[0]||0,centerTime:this._sizeTween.times[1]||0,finalTime:this._sizeTween.times[2]||0,startTws:this._sizeTween.values[0]||0,centerTws:this._sizeTween.values[1]||0,finalTws:this._sizeTween.values[2]||0};y.add(v,"startTime",0,60,1).name("起始时间").onChange((e=>{this._sizeTween.times[0]=e})),y.add(v,"centerTime",0,60,1).name("时间节点一").onChange((e=>{this._sizeTween.times[1]=e})),y.add(v,"finalTime",0,60,1).name("时间节点二").onChange((e=>{this._sizeTween.times[2]=e})),y.add(v,"startTws",0,100,.1).name("初始状态").onChange((e=>{this._sizeTween.values[0]=e})),y.add(v,"centerTws",0,100,.1).name("中间状态").onChange((e=>{this._sizeTween.values[1]=e})),y.add(v,"finalTws",0,100,.1).name("最终状态").onChange((e=>{this._sizeTween.values[2]=e}));const b={startTime:this.opacityTween.times[0]||0,centerTime:this.opacityTween.times[1]||0,finalTime:this.opacityTween.times[2]||0,startTws:this.opacityTween.values[0]||0,centerTws:this.opacityTween.values[1]||0,finalTws:this.opacityTween.values[2]||0},_=m.addFolder("透明度状态");_.add(this,"opacity",0,1,.01).name("透明度").onChange((e=>{this._opacity=e})),_.add(this,"opacityRange",0,1,.01).name("透明度范围").onChange((e=>{this.opacityRange=e}));const x=_.addFolder("透明参数渐变动画");x.add(b,"startTime",0,60,.1).name("初始时间").onChange((e=>{this.opacityTween.times[0]=e})),x.add(b,"centerTime",0,60,.1).name("状态时间一").onChange((e=>{this.opacityTween.times[1]=e})),x.add(b,"finalTime",0,60,.1).name("状态时间二").onChange((e=>{this.opacityTween.times[2]=e})),x.add(b,"startTws",0,1,.01).name("初始透明状态").onChange((e=>{this.opacityTween.values[0]=e})),x.add(b,"centerTws",0,1,.01).name("透明状态一").onChange((e=>{this.opacityTween.values[1]=e})),x.add(b,"finalTws",0,1,.01).name("透明状态二").onChange((e=>{this.opacityTween.values[2]=e}));const w=m.addFolder("粒子颜色状态");m.add(this,"lookFar",0,1e3).name("最大可见距离"),m.add(this,"lookNear",0,1e3).name("最小可见距离");const S={color:this.getColor(this.color),colorRange:this.getColor(this.colorRange),startTime:this.colorTween.times[0]||0,centerTime:this.colorTween.times[1]||0,finalTime:this.colorTween.times[2]||0,startTW:this.getColor(this.colorTween.values[0]),centerTW:this.getColor(this.colorTween.values[1]),finalTW:this.getColor(this.colorTween.values[2])};w.addColor(S,"color").name("初始化颜色").onChange((e=>{this.color=this.toColor(e)})),w.addColor(S,"colorRange").name("颜色随机范围").onChange((e=>{this.colorRange=this.toColor(e)}));const M=w.addFolder("粒子颜色动画（注:先颜色后时间）");M.add(S,"startTime",0,60,.1).name("初始时间").onChange((e=>{this.colorTween.times[0]=e})),M.add(S,"centerTime",0,60,.1).name("时间状态一").onChange((e=>{this.colorTween.times[1]=e})),M.add(S,"finalTime",0,60,.1).name("时间状态二").onChange((e=>{this.colorTween.times[2]=e})),M.addColor(S,"startTW").name("初始颜色状态").onChange((e=>{this.colorTween.values[0]=this.toColor(e)})),M.addColor(S,"centerTW").name("颜色状态一").onChange((e=>{this.colorTween.values[1]=this.toColor(e)})),M.addColor(S,"finalTW").name("颜色状态二").onChange((e=>{this.colorTween.values[2]=this.toColor(e)}));const T={changeTex:()=>{this.importImg((e=>{const t=(new al).load(e,(e=>{e.flipY=!1}));this.textureURL=e,this.map=t}))},export:()=>{this.exportDate(),alert("具体参数请看控制台")},modelView:"AdditiveBlending"};t.add(T,"changeTex").name("更换贴图"),t.add(T,"export").name("导出调整参数"),t.add(this,"blendMode",["AdditiveBlending","NormalBlending"]).name("混合模式").onChange((e=>{this._blendMode=e,this.mesh.material.blending=eu[this._blendMode]})),this.panelsVisible=!0,document.getElementsByClassName("dg ac")[0].style.zIndex=1e5}destroyPanel(){this.panelsVisible=!1,this.panels.destroy()}getColor(e){if(e){return`#${(new Qt).setHSL(e.x,e.y,e.z).getHexString()}`}return`#${(new Qt).setHSL(0,0,0).getHexString()}`}toColor(e){let t=new Qt(e).getHSL({});return new Ce(t.h,t.s,t.l)}importImg(e){let t=document.createElement("input");t.type="file";const i=()=>{if(!t.files)return;const n=t.files[0];if(n.type.match(/image.*/)){const a=new FileReader;a.onload=()=>{const n=a.result;e&&e(n),t.removeEventListener("change",i,!1),t=null},a.readAsDataURL(n)}};t.addEventListener("change",i,!1),t.click()}exportDate(){let e=this._inherit;return{pointSec:this._pointSec,name:this.name,id:this.id,position:this.posHelper2.position,shapeType:this.shapeType,positionRange:this.positionRange,positionRadius:this.positionRadius,positionRadiusRange:this.positionRadiusRange,velocityShape:this.velocityShape,velocity:this.velocity,velocityRange:this.velocityRange,speed:this.speed,speedRange:this.speedRange,gravity:this.gravity,gravityValue:this.gravityValue,_deathAge:this._deathAge,pointDeathAge:this.pointDeathAge,pointDeathAges:this.pointDeathAges,_loop:this._loop,loop:this.loop,pointNum:this.pointNum,angle:this.angle,angleRange:this.angleRange,angleVelocity:this.angleVelocity,angleVelocityRange:this.angleVelocityRange,angleAcceleration:this.angleAcceleration,angleAccelerationRange:this.angleAccelerationRange,size:this._size,sizeRange:this.sizeRange,sizeTween:this._sizeTween,opacity:this._opacity,opacityRange:this.opacityRange,opacityTween:this.opacityTween,color:this.getColor(this.color),colorRange:this.getColor(this.colorRange),colorToRange:this.colorToRange,colorTween:(e=>{const t={times:[],values:[]};t.times=e.times;for(let i=0;i<e.values.length;i++){const n=this.getColor(e.values[i]);t.values[i]=n}return t})(this.colorTween),colorChange:this.colorChange,startColor:this.startColor,finalColor:this.finalColor,textureURL:this.textureURL,textureName:this.textureName,parentName:this.parentName,blendMode:this.blendMode,inheritPos:e,pointDeathAgeRange:this.pointDeathAgeRange,_wayAngle:this._wayAngle,_waySpeed:this._waySpeed,_waySpeedRange:this._waySpeedRange,_wayDirect:this._wayDirect,_wayAngleRange:this._wayAngleRange,_wayAngleDirect:this._wayAngleDirect,_far:this._far,_near:this._near,rotSpeedRange:this.rotSpeedRange,lookFar:this.lookFar,lookNear:this.lookNear,pointAgeRange:this.pointAgeRange,wayAngleRange:this.wayAngleRange,waySpeed:this.waySpeed,waySpeedRange:this.waySpeedRange,wayAngleX:this.wayAngleX,wayAngleY:this.wayAngleY,wayAngleZ:this.wayAngleZ,startSize:this.startSize,finalSize:this.finalSize,offsetPos:this.offsetPos,speedArrow:this.speedArrow,startOpacity:this._startOpacity,finalOpacity:this._finalOpacity,alive:this.alive,storeBindingName:this.storeBindingName,familyMatrixArray:this.familyMatrixArray,familyMatrixOffset:this.familyMatrixOffset}}dispose(){this.disposeHelperArray(),this.mesh.parent.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose()}disposeHelperArray(){this.helper1Array=[],this.helperArray=[],this.helper2Array=[]}}const G_=(e,t)=>{let i=document.createElement("input");i.type="file";const n=()=>{if(!i.files)return;const a=i.files[0];if(a.type.match(/image.*/)){const t=new FileReader;t.onload=()=>{const a=t.result;"function"==typeof e&&e(a),i.removeEventListener("change",n,!1),i=null},t.readAsDataURL(a)}else{const e=new FileReader;e.onload=()=>{const a=e.result;"function"==typeof t&&t(a),i.removeEventListener("change",n,!1),i=null},e.readAsText(a)}};i.addEventListener("change",n,!1),i.click()};class V_ extends class extends class{constructor(e){this.initAttribute(),this.initData(),this.createParticle();let t,i=e;this._getScene=()=>{if(i)return i;console.error("未设置scene传入")},this._setScene=e=>{i=e},this.setParent=e=>{e.isObject3D&&(e.add(this._mesh),e.add(this._wayAngleHelperObject),e.add(this._offsetPositionHelperObject),t=e)},this.getParent=()=>t}initData(){this.id=ge.generateUUID(),this._position=new Ce(0,0,0),this._pointNum=1e3,this._inherit=!1,this._play=!1,this._pause=!1,this._gravity=!1,this._gravityValue=0,this._loop=!0,this._out=!1,this._timeLoopValue=0,this._deathAges=10,this._visible=!0,this.lerp=0,this._wayAngleHelperObject=new Et,this._wayAngleHelperObject.isForParticle=!0,this._wayAngleHelperObject.name="方向旋转辅助节点",this._offsetPositionHelperObject=new Et,this.initArrow(),this.timeID=null}initAttribute(){this.CUBE=1,this.SPHERE=0}initArrow(){this._arrow=!1,this._createArrow=()=>{this._arrowDir=this._material.uniforms.translatoryVelocityWay.value.clone();const e=this._material.uniforms.offset.value.clone();this._arrowHelper=new wh(this._arrowDir.normalize(),e,20,"#FF0036"),this._arrowHelper.traverse((e=>{e.material&&(e.material.depthWrite=!1,e.material.depthTest=!1),e.renderOrder=1/0})),this._mesh?this._material.uniforms.JointType.value==this.CUBE?(0==this._inherit?this._mesh.add(this._arrowHelper):this._helper&&(this._helper.add(this._arrowHelper),this._arrowHelper.position.set(0,0,0)),this._arrow=!0):console.warn("当前运动类型不支持显示arrow"):(this._destroyArrow(),console.warn("您还未创建粒子"))},this._destroyArrow=()=>{this._arrowHelper&&(this._arrowHelper.parent&&this._arrowHelper.parent.remove(this._arrowHelper),this._arrowHelper=null,this._arrow=!1)}}set arrow(e){e?this._arrowHelper||this._createArrow():this._destroyArrow()}get arrow(){return this._arrow}setPointNum(e){this._pointNum=e;const t=[],i=[],n=[],a=[];for(let e=0;e<this._pointNum;e++)t[3*e]=this._position.x,t[3*e+1]=this._position.y,t[3*e+2]=this._position.z,i[e]=e,n[3*e]=Math.random(),n[3*e+1]=Math.random(),n[3*e+2]=Math.random(),a[3*e]=0,a[3*e+1]=0,a[3*e+2]=0;if(this._geometry.setAttribute("position",new hi(t,3)),this._geometry.setAttribute("pointsID",new hi(i,1)),this._geometry.setAttribute("randomValue",new hi(n,3)),this._geometry.setAttribute("inheritVelocityWay",new hi(a,3)),this._inherit){let e=new Ce(0,0,0);this._mesh.getWorldPosition(e);const t=this._material.uniforms.translatoryVelocityWay.value.clone(),i=new Ee;this._mesh.getWorldQuaternion(i),t.applyQuaternion(i)}}createParticle(){this._geometry=new wi,this.setPointNum(this._pointNum),this._material=new Yi({uniforms:{_PI:{value:Math.PI},_play:{value:!1},hidePlay:{value:!0},_playDensity:{value:1},age:{value:5},ageRange:{value:0},_loop:{value:this._loop},playSpeed:{value:1},viewDensity:{value:1},offset:{value:new Ce(0,0,0)},startPos:{value:new Ce(0,0,0)},inherit:{value:this._inherit},inheritParentMatrix:{value:new it},_parentPosition:{value:new Ce(0,0,0)},shapeType:{value:this.SPHERE},startPosRange:{value:new Ce(0,0,0)},startRadius:{value:0},startRadiusRange:{value:0},motionSpacing:{value:.1},JointType:{value:this.SPHERE},translatoryVelocitySpeed:{value:0},translatoryVelocityWay:{value:new Ce(0,1,0)},translatoryVelocitySpeedRange:{value:0},translatoryVelocityWayRange:{value:new Ce(0,0,0)},diffusionVelocity:{value:50},diffusionVelocityRange:{value:0},acceleration:{value:new Ce(0,0,0)},accelerationRange:{value:new Ce(0,0,0)},useGravity:{value:this._gravity},gravityAcceleration:{value:new Ce(0,this._gravityValue,0)},_inheritGravity:{value:this._gravityValue},pointSize:{value:10},pointSizeRange:{value:0},useSizeAnimate:{value:!0},sizeEndAnimate:{value:1},times:{value:0},color:{value:new Ce(1,1,1)},colorRange:{value:new Qt(0)},useColorAnimate:{value:!1},colorEndAnimate:{value:new Ce(1,1,1)},map:{value:null},useMap:{value:!1},opacity:{value:1},opacityRange:{value:0},useOpacityAnimate:{value:!0},opacityEndAnimate:{value:1},angle:{value:0},angleRange:{value:0},angleSpeed:{value:90},angleSpeedRange:{value:0},angleAcceleration:{value:0},angleAccelerationRange:{value:0},viewFar:{value:0},viewNear:{value:0},resize:{value:0}},vertexShader:"#define GLSLIFY 1\n#define CUBE 1\n#define SPHERE 0\nattribute float pointsID;attribute vec3 randomValue;uniform float _PI;uniform bool _play;uniform float _playDensity;uniform float age;uniform float ageRange;uniform bool hidePlay;uniform bool _loop;uniform float playSpeed;uniform float viewDensity;uniform vec3 offset;uniform vec3 startPos;uniform bool inherit;uniform mat4 inheritParentMatrix;uniform vec3 _parentPosition;attribute vec3 inheritVelocityWay;uniform float _inheritGravity;uniform int shapeType;uniform vec3 startPosRange;uniform float startRadius;uniform float startRadiusRange;uniform float motionSpacing;uniform float pointSize;uniform float pointSizeRange;uniform bool useSizeAnimate;uniform float sizeEndAnimate;uniform float times;uniform int JointType;uniform float translatoryVelocitySpeed;uniform vec3 translatoryVelocityWay;uniform float translatoryVelocitySpeedRange;uniform vec3 translatoryVelocityWayRange;uniform float diffusionVelocity;uniform float diffusionVelocityRange;uniform vec3 acceleration;uniform vec3 accelerationRange;uniform bool useGravity;uniform vec3 gravityAcceleration;uniform float resize;varying float vVisible;varying float vPointsIDValue;varying float vAge;varying float vTimeValue;varying vec3 vRandom;varying float vCameraDistance;float rand(float x){return fract(sin(x)*100000.);}float rand2(float min,float max){return min+max*(rand(pointsID)-.5);}vec3 randVec3(vec3 min,vec3 max){return min+max*(vec3(rand(pointsID+.001),rand(pointsID+.002),rand(pointsID+.003))-.5);}float tweenValue(float interpolation,float startValue,float endValue,float timeValues,float ages){float lerpValue=mod(timeValues-interpolation,ages);lerpValue=(lerpValue/ages);float changeValue=endValue-startValue;return startValue+(changeValue*lerpValue);}float random(in vec2 st){return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123);}float noise(in vec2 st){vec2 i=floor(st);vec2 f=fract(st);float a=random(i);float b=random(i+vec2(1.,0.));float c=random(i+vec2(0.,1.));float d=random(i+vec2(1.,1.));vec2 u=f*f*(3.-2.*f);return mix(a,b,u.x)+(c-a)*u.y*(1.-u.x)+(d-b)*u.x*u.y;}mat4 inverse_mat4(mat4 m){float Coef00=m[2][2]*m[3][3]-m[3][2]*m[2][3];float Coef02=m[1][2]*m[3][3]-m[3][2]*m[1][3];float Coef03=m[1][2]*m[2][3]-m[2][2]*m[1][3];float Coef04=m[2][1]*m[3][3]-m[3][1]*m[2][3];float Coef06=m[1][1]*m[3][3]-m[3][1]*m[1][3];float Coef07=m[1][1]*m[2][3]-m[2][1]*m[1][3];float Coef08=m[2][1]*m[3][2]-m[3][1]*m[2][2];float Coef10=m[1][1]*m[3][2]-m[3][1]*m[1][2];float Coef11=m[1][1]*m[2][2]-m[2][1]*m[1][2];float Coef12=m[2][0]*m[3][3]-m[3][0]*m[2][3];float Coef14=m[1][0]*m[3][3]-m[3][0]*m[1][3];float Coef15=m[1][0]*m[2][3]-m[2][0]*m[1][3];float Coef16=m[2][0]*m[3][2]-m[3][0]*m[2][2];float Coef18=m[1][0]*m[3][2]-m[3][0]*m[1][2];float Coef19=m[1][0]*m[2][2]-m[2][0]*m[1][2];float Coef20=m[2][0]*m[3][1]-m[3][0]*m[2][1];float Coef22=m[1][0]*m[3][1]-m[3][0]*m[1][1];float Coef23=m[1][0]*m[2][1]-m[2][0]*m[1][1];const vec4 SignA=vec4(1.0,-1.0,1.0,-1.0);const vec4 SignB=vec4(-1.0,1.0,-1.0,1.0);vec4 Fac0=vec4(Coef00,Coef00,Coef02,Coef03);vec4 Fac1=vec4(Coef04,Coef04,Coef06,Coef07);vec4 Fac2=vec4(Coef08,Coef08,Coef10,Coef11);vec4 Fac3=vec4(Coef12,Coef12,Coef14,Coef15);vec4 Fac4=vec4(Coef16,Coef16,Coef18,Coef19);vec4 Fac5=vec4(Coef20,Coef20,Coef22,Coef23);vec4 Vec0=vec4(m[1][0],m[0][0],m[0][0],m[0][0]);vec4 Vec1=vec4(m[1][1],m[0][1],m[0][1],m[0][1]);vec4 Vec2=vec4(m[1][2],m[0][2],m[0][2],m[0][2]);vec4 Vec3=vec4(m[1][3],m[0][3],m[0][3],m[0][3]);vec4 Inv0=SignA*(Vec1*Fac0-Vec2*Fac1+Vec3*Fac2);vec4 Inv1=SignB*(Vec0*Fac0-Vec2*Fac3+Vec3*Fac4);vec4 Inv2=SignA*(Vec0*Fac1-Vec1*Fac3+Vec3*Fac5);vec4 Inv3=SignB*(Vec0*Fac2-Vec1*Fac4+Vec2*Fac5);mat4 Inverse=mat4(Inv0,Inv1,Inv2,Inv3);vec4 Row0=vec4(Inverse[0][0],Inverse[1][0],Inverse[2][0],Inverse[3][0]);float Determinant=dot(m[0],Row0);Inverse/=Determinant;return Inverse;}void main(){vRandom=randomValue;vec3 noiseMap=vec3(noise(randomValue.xz));float densityValue=viewDensity*_playDensity;float visibleNum=smoothstep(densityValue-.00001,densityValue,noiseMap.r);if(visibleNum>.5){vVisible=0.;}else{vVisible=1.;}if(vVisible!=0.){float playSpeedValue=1.;if(_play==true){playSpeedValue=playSpeed;}float timeValue=times*playSpeedValue;vTimeValue=timeValue;vec3 firstPos=startPos;float pointsIDValue=pointsID*motionSpacing;vPointsIDValue=pointsIDValue;vAge=rand2(age,ageRange*age);vec3 departurePosition;if(shapeType==CUBE){departurePosition=randVec3(firstPos,startPosRange);}else if(shapeType==SPHERE){float InitialRadius=rand2(startRadius,startRadiusRange);float z=rand(pointsIDValue+.032)*2.-1.;float t=_PI*2.*rand(pointsIDValue+.033);float r=sqrt(1.-z*z);departurePosition=vec3(r*cos(t),r*sin(t),z);departurePosition*=InitialRadius;departurePosition+=firstPos;}if(inherit==true){}vec3 accelerationValue=acceleration+accelerationRange*rand(pointsIDValue);if(useGravity==true){if(inherit==true){accelerationValue+=vec3(0.,_inheritGravity,0.);}else{accelerationValue+=gravityAcceleration;}}vec3 innerPos;if(inherit==false){innerPos=vec3(0.);innerPos+=offset;}else{innerPos=position;}vec3 launchPosition=innerPos+departurePosition;bool _startComp=false;bool stopLoop=false;if(_loop==false){_startComp=true;}else{stopLoop=false;}if(timeValue>=pointsIDValue){float ageValue=mod(timeValue-pointsIDValue,vAge);if(ageValue<=0.1){vVisible=0.;}if(_startComp==true){if(timeValue/pointsIDValue>=2.){stopLoop=true;}}if(stopLoop==false){accelerationValue*=ageValue;vec3 newVelocity;if(JointType==CUBE){vec3 velocityWay=translatoryVelocityWay;if(inherit==true){velocityWay=inheritVelocityWay;}velocityWay=normalize(velocityWay);vec3 finalWay=randVec3(velocityWay,translatoryVelocityWayRange);finalWay=normalize(finalWay);vec3 translatoryVelocityValue=finalWay*(translatoryVelocitySpeed+translatoryVelocitySpeedRange*randomValue.x);translatoryVelocityValue+=accelerationValue;newVelocity=translatoryVelocityValue*ageValue;}else if(JointType==SPHERE){float diffusionVelocityValue=rand2(diffusionVelocity,diffusionVelocityRange);vec3 wayPos=launchPosition-firstPos;if(inherit){wayPos-=_parentPosition;}else{wayPos-=offset;}if(wayPos==vec3(0.)){newVelocity=(vec3(0.)*diffusionVelocityValue+accelerationValue)*ageValue;}else{newVelocity=(normalize(wayPos)*diffusionVelocityValue+accelerationValue)*ageValue;}}launchPosition+=newVelocity;}else{vVisible=0.;}}vec4 worldLaunchPosition=modelViewMatrix*vec4(launchPosition,1.);vCameraDistance=distance(cameraPosition,worldLaunchPosition.xyz);gl_Position=projectionMatrix*modelViewMatrix*vec4(launchPosition,1.);float sizeValue=pointSize;if(useSizeAnimate==true){sizeValue=tweenValue(pointsIDValue,pointSize,sizeEndAnimate,timeValue,vAge);}sizeValue=rand2(sizeValue,pointSizeRange/100.*sizeValue);vec4 ppos=modelViewMatrix*vec4(launchPosition,1.);sizeValue=sizeValue*(300./length(ppos.xyz));float values=1.;if(resize!=0.){values=values*(resize/960.);}gl_PointSize=sizeValue*values;if(hidePlay==true){vVisible=0.;}}}",fragmentShader:"#define GLSLIFY 1\n#define PI 3.1415926\nuniform float _PI;uniform vec3 color;uniform vec3 colorRange;uniform bool useColorAnimate;uniform vec3 colorEndAnimate;uniform sampler2D map;uniform bool useMap;uniform float opacity;uniform bool useOpacityAnimate;uniform float opacityRange;uniform float opacityEndAnimate;uniform float angle;uniform float angleRange;uniform float angleSpeed;uniform float angleSpeedRange;uniform float angleAcceleration;uniform float angleAccelerationRange;uniform float viewFar;uniform float viewNear;varying float vVisible;varying float vPointsIDValue;varying float vAge;varying float vTimeValue;varying vec3 vRandom;varying float vCameraDistance;float rand(float x){return fract(sin(x)*233.0);}float rand2(float min,float max){return min+max*(rand(vPointsIDValue)-0.5);}vec3 randVec3(vec3 min,vec3 max){return min+max*(vec3(rand(vPointsIDValue+0.013),rand(vPointsIDValue+0.02),rand(vPointsIDValue+0.03))-0.5);}float tweenValue(float interpolation,float startValue,float endValue,float timeValues){float lerpValue=mod(timeValues-interpolation,vAge);lerpValue=(lerpValue/vAge);float changeValue=endValue-startValue;return startValue+(changeValue*lerpValue);}vec3 tweenValueVec3(float interpolation,vec3 startVec3,vec3 endVec3,float timeValues){return vec3(tweenValue(interpolation,startVec3.x,endVec3.x,timeValues),tweenValue(interpolation,startVec3.y,endVec3.y,timeValues),tweenValue(interpolation,startVec3.z,endVec3.z,timeValues));}mat2 rotate2d(float _angle){return mat2(cos(_angle),-sin(_angle),sin(_angle),cos(_angle));}float euclideanModulo(float n,float m){return fract((fract(n/m)+m)/m);}float hue2rgb(float p,float q,float t){if(t<0.){t+=1.;}if(t>1.){t-=1.;}if(t<1./6.){return p+(q-p)*6.*t;}if(t<1./2.){return q;}if(t<2./3.){return p+(q-p)*6.*(2./3.-t);}return p;}vec3 setHSL(float h,float s,float l){h=euclideanModulo(h,1.);s=clamp(s,0.,1.);l=clamp(l,0.,1.);if(s==0.){return vec3(l);}else{float p=l<=.5 ? l*(1.+s): l+s-(l*s);float q=(2.*l)-p;float r=hue2rgb(q,p,h+1./3.);float g=hue2rgb(q,p,h);float b=hue2rgb(q,p,h-1./3.);return vec3(r,g,b);}}void main(){if(vVisible!=0.){vec2 uv=vec2(1.-gl_PointCoord.x,gl_PointCoord.y);float angleValue=angle+angle*vPointsIDValue;angleValue=rand2(angleValue,angleRange*angleValue);float rotateSpeed=rand2(angleSpeed,angleSpeedRange*angleSpeed);float ageValue=mod(vTimeValue-vPointsIDValue,vAge);float angleAccelerationValue=rand2(angleAcceleration,angleAccelerationRange*angleAcceleration);angleAccelerationValue*=ageValue;rotateSpeed+=angleAccelerationValue;angleValue+=(rotateSpeed*vTimeValue);uv-=.5;uv=rotate2d(-angleValue/180.*PI)*uv;uv+=0.5;vec3 exportColor=randVec3(color,colorRange);if(useColorAnimate==true){exportColor=tweenValueVec3(vPointsIDValue,color,colorEndAnimate,vTimeValue);}exportColor=setHSL(exportColor.x,exportColor.y,exportColor.z);float alphaValue=1.;if(useMap==true){vec4 mapColor=texture2D(map,uv);exportColor=exportColor*mapColor.rgb;alphaValue=mapColor.a;}if(vVisible<0.5){alphaValue=0.;}if(vTimeValue<=vPointsIDValue){alphaValue=0.;}float opacityValue=opacity;if(useOpacityAnimate==true){opacityValue=tweenValue(vPointsIDValue,opacity,opacityEndAnimate,vTimeValue);opacityValue*=opacity;}opacityValue=rand2(opacityValue,opacityRange*opacityValue);alphaValue*=opacityValue;if(viewFar>viewNear){if(vCameraDistance>viewNear&&vCameraDistance<viewFar){}else{alphaValue=0.;}}if(alphaValue==0.){discard;}gl_FragColor=vec4(exportColor,alphaValue);}else{discard;}}",transparent:!0,depthWrite:!1,blending:2}),this._mesh=new ms(this._geometry,this._material),this._mesh.frustumCulled=!1}updateTransformHelper(){this._wayAngleHelperObject&&(this._inherit?this._helper&&this._wayAngleHelperObject.position.copy(this._helper.position.clone()):this._wayAngleHelperObject.position.copy(this._material.uniforms.offset.value)),this._offsetPositionHelperObject&&(this._inherit?this._helper&&this._offsetPositionHelperObject.position.copy(this._helper.position.clone()):this._offsetPositionHelperObject.position.copy(this._material.uniforms.offset.value))}computeGravity(){if(this._mesh){this._mesh.updateWorldMatrix();const e=this._mesh.matrixWorld.clone();e.invert();const t=new it;t.extractRotation(e);const i=new Ce(0,.5*this._gravityValue,0);return i.applyMatrix4(t),i}}setInheritChange(e){if(e){this._helper&&this._helper.parent&&(this._helper.parent.remove(this._helper),this._helper=null),this._helper=new Et;const e=this._mesh.parent;e.add(this._helper),this._helper.position.copy(this._material.uniforms.offset.value.clone()),this._helper.rotation.copy(this._mesh.rotation.clone()),this._helper.scale.copy(this._mesh.scale.clone()),e.remove(this._mesh),this._mesh.position.set(0,0,0),this._mesh.rotation.set(0,0,0),this._mesh.scale.setScalar(1),this._arrowHelper&&(this._mesh.remove(this._arrowHelper),this._helper.add(this._arrowHelper),this._arrowHelper.position.set(0,0,0)),this._helper.updateWorldMatrix();let t=new Ce(0,0,0);this._helper.getWorldPosition(t);const i=this._material.uniforms.translatoryVelocityWay.value.clone(),n=new Ee;this._helper.getWorldQuaternion(n),i.applyQuaternion(n),this.resetInnerPosition(t,i),this._getScene().add(this._mesh)}else if(this._helper){this._getScene().remove(this._mesh);this.getParent().add(this._mesh),this._mesh.rotation.copy(this._helper.rotation.clone()),this._mesh.scale.copy(this._helper.scale.clone()),this._arrowHelper&&(this._helper.remove(this._arrowHelper),this._mesh.add(this._arrowHelper),this._arrowHelper.position.copy(this._material.uniforms.offset.value.clone())),this._helper.parent&&(this._helper.parent.remove(this._helper),this._helper=null)}}computeInherit2(){this._helper&&this._helper.position.copy(this._material.uniforms.offset.value.clone());let e=this._helper.matrixWorld.clone();const t=this._material.uniforms.age.value,i=this._geometry.attributes.position.array,n=this._geometry.attributes.inheritVelocityWay.array,a=this._material.uniforms.motionSpacing.value,r=this._material.uniforms.times.value*this._material.uniforms.playSpeed.value;let s=new Ce(0,0,0),o=new Ee,l=new Ce(0,0,0);e.decompose(s,o,l);const c=this._material.uniforms.translatoryVelocityWay.value.clone();c.applyQuaternion(o);for(let e=0;e<this._pointNum;e++){const o=e*a;if(r>o){(r-o)%t<=.1&&(i[3*e]=s.x,i[3*e+1]=s.y,i[3*e+2]=s.z,n[3*e]=c.x,n[3*e+1]=c.y,n[3*e+2]=c.z)}}this._geometry.attributes.position.needsUpdate=!0,this._geometry.attributes.inheritVelocityWay.needsUpdate=!0,this._material.uniforms._parentPosition.value.copy(s)}testUpdateWorldPosition(){}differenceInterval(e,t,i,n,a,r){for(let s=0;s<t;s++){const t=e+s;t<=this._pointNum&&(i[3*t]=n.x,i[3*t+1]=n.y,i[3*t+2]=n.z,a[3*t]=r.x,a[3*t+1]=r.y,a[3*t+2]=r.z);const o=e-s;o>0&&(i[3*o]=n.x,i[3*o+1]=n.y,i[3*o+2]=n.z,a[3*o]=r.x,a[3*o+1]=r.y,a[3*o+2]=r.z)}}resetInnerPosition(e=new Ce(0,0,0),t=new Ce(0,0,0)){const i=this._geometry.attributes.position.array,n=this._geometry.attributes.inheritVelocityWay.array;for(let a=0;a<this._pointNum;a++)i[3*a]=e.x,i[3*a+1]=e.y,i[3*a+2]=e.z,n[3*a]=t.x,n[3*a+1]=t.y,n[3*a+2]=t.z;this._geometry.attributes.position.needsUpdate=!0,this._geometry.attributes.inheritVelocityWay.needsUpdate=!0}checkHide(e,t){e&&(e.isScene||(0==e.visible?"function"==typeof t&&t(!1):this.checkHide(e.parent,t)))}checkFamilyVisible2(){this._visible=!0,this.checkHide(this.getFamily(),(e=>{this._visible=!1})),this._mesh.visible=this._visible}update(e){this.checkFamilyVisible2(),this._visible&&(this._arrowHelper&&(this._helper?this._arrowHelper.scale.setScalar(Ep.camera.position.distanceTo(this._helper.getWorldPosition(new Ce))/50):this._arrowHelper.scale.setScalar(Ep.camera.position.distanceTo(this._mesh.getWorldPosition(new Ce))/50)),this._material&&(this._inherit&&this.computeInherit2(),this._pause||(this._material.uniforms.times.value+=e),this._timeLoopValue=this._material.uniforms.times.value%this._material.uniforms.age.value/this._material.uniforms.age.value*100,0==this._loop&&this._timeLoopValue>=98&&(this.timeID||(this.timeID=setTimeout((e=>{this._play=!1}),500))),this._play?(this._material.uniforms._play.value=this._play,this._material.uniforms._playDensity.value<1&&(this._material.uniforms._playDensity.value+=.01)):(this._material.uniforms._playDensity.value>0&&(this._material.uniforms._playDensity.value-=.01),this._material.uniforms._playDensity.value<=0&&(this._material.uniforms._play.value=this._play)),this._gravity&&(this._inherit?this._material.uniforms._inheritGravity.value=.5*this._gravityValue:this._material.uniforms.gravityAcceleration.value=this.computeGravity()),this.updateTransformHelper()))}dispose(){this._mesh.parent.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.material.dispose(),this._geometry=null,this._material=null}}{constructor(e,t){super(e),t&&this.applyJSON(t)}set pointNum(e){this._pointNum=e,this.motionSpacing=this.allPointAge/this._pointNum,this.setPointNum(this._pointNum)}get pointNum(){return this._pointNum}set play(e){"boolean"==typeof e?(this._play=e,this._material.uniforms._play.value=e,1==e&&(this.loop=this._loop,this._material.uniforms.hidePlay.value=!1,this._material.uniforms.times.value=0)):console.warn("value必须为boolean值")}get play(){return this._material.uniforms._play.value}set pause(e){"boolean"==typeof e?this._pause=e:console.warn("value必须为boolean值")}get pause(){return this._pause}set loop(e){"boolean"==typeof e&&(this._loop=e,this.timeID=null)}get loop(){return this._loop}set pointAge(e){this._material.uniforms.age.value=e}get pointAge(){return this._material.uniforms.age.value}set pointAgeRanges(e){this._material.uniforms.ageRange.value=e/100}get pointAgeRanges(){return 100*this._material.uniforms.ageRange.value}set allPointAge(e){this._deathAges=e,this.motionSpacing=this.allPointAge/this._pointNum}get allPointAge(){return this._deathAges}set playSpeed(e){this._material.uniforms.playSpeed.value=e}get playSpeed(){return this._material.uniforms.playSpeed.value}set density(e){e>=0||e<=1?this._material.uniforms.viewDensity.value=e:console.warn("超出值域范围，请检查")}get density(){return this._material.uniforms.viewDensity.value}set offset(e){e.isVector3?this._material.uniforms.offset.value=e:console.warn("value must Vector3")}get offset(){return this._material.uniforms.offset.value}set position(e){e.isVector3?this._material.uniforms.startPos.value=e:console.warn("value must Vector3")}get position(){return this._material.uniforms.startPos.value}set inherit(e){"boolean"==typeof e&&(1==e||this._geometry&&this.resetInnerPosition(),this._material.uniforms.inherit.value=e,this._inherit=e,this.setInheritChange(this._inherit))}get inherit(){return this._inherit=this._material.uniforms.inherit.value,this._inherit}set shapeType(e){const t=e.toUpperCase();this._material.uniforms.shapeType.value=this[t]}get shapeType(){return this._material.uniforms.shapeType.value==this.CUBE?"CUBE":this._material.uniforms.shapeType.value==this.SPHERE?"SPHERE":void 0}set positionRange(e){e.isVector3?this._material.uniforms.startPosRange.value=e:console.warn("value must Vector3")}get positionRange(){return this._material.uniforms.startPosRange.value}set radius(e){this._material.uniforms.startRadius.value=e}get radius(){return this._material.uniforms.startRadius.value}set radiusRange(e){this._material.uniforms.startRadiusRange.value=e}get radiusRange(){return this._material.uniforms.startRadiusRange.value}set motionSpacing(e){this._material.uniforms.motionSpacing.value=e}get motionSpacing(){return this._material.uniforms.motionSpacing.value}set JointType(e){const t=e.toUpperCase();this._material.uniforms.JointType.value=this[t],"sphere"==t.toLocaleLowerCase()&&(this.arrow=!1)}get JointType(){return this._material.uniforms.JointType.value==this.CUBE?"CUBE":this._material.uniforms.JointType.value==this.SPHERE?"SPHERE":void 0}set velocityWay(e){e.isVector3&&(this._material.uniforms.translatoryVelocityWay.value=e.normalize(),this._arrowHelper&&this._arrowHelper.setDirection(this._material.uniforms.translatoryVelocityWay.value.normalize()))}get velocityWay(){return this._material.uniforms.translatoryVelocityWay.value}set velocitySpeed(e){this._material.uniforms.translatoryVelocitySpeed.value=e,this._arrowHelper}get velocitySpeed(){return this._material.uniforms.translatoryVelocitySpeed.value}set velocityWayRange(e){e.isVector3&&(this._material.uniforms.translatoryVelocityWayRange.value=e)}get velocityWayRange(){return this._material.uniforms.translatoryVelocityWayRange.value}set velocitySpeedRange(e){this._material.uniforms.translatoryVelocitySpeedRange.value=e}get velocitySpeedRange(){return this._material.uniforms.translatoryVelocitySpeedRange.value}set diffusionVelocity(e){this._material.uniforms.diffusionVelocity.value=e}get diffusionVelocity(){return this._material.uniforms.diffusionVelocity.value}set diffusionVelocityRange(e){this._material.uniforms.diffusionVelocityRange.value=e}get diffusionVelocityRange(){return this._material.uniforms.diffusionVelocityRange.value}set acceleration(e){e.isVector3?this._material.uniforms.acceleration.value=e:console.warn("value must Vector3")}get acceleration(){return this._material.uniforms.acceleration.value}set accelerationRange(e){e.isVector3?this._material.uniforms.accelerationRange.value=e:console.warn("value must Vector3")}get accelerationRange(){return this._material.uniforms.accelerationRange.value}set gravity(e){this._gravity=e,this._material.uniforms.useGravity.value=this._gravity}get gravity(){return this._gravity}set gravityValue(e){this._gravityValue=-e}get gravityValue(){return-this._gravityValue}set size(e){this._material.uniforms.pointSize.value=e}get size(){return this._material.uniforms.pointSize.value}set sizeRanges(e){0<=e<=100&&(this._material.uniforms.pointSizeRange.value=e)}get sizeRanges(){return this._material.uniforms.pointSizeRange.value}set useSizeAnimate(e){"boolean"==typeof e?this._material.uniforms.useSizeAnimate.value=e:console.warn("该属性不生效,请输入boolean")}get useSizeAnimate(){return this._material.uniforms.useSizeAnimate.value}set sizeEndAnimate(e){this._material.uniforms.sizeEndAnimate.value=e}get sizeEndAnimate(){return this._material.uniforms.sizeEndAnimate.value}set maps(e){"string"==typeof e?(this._material.uniforms.useMap.value=!0,this._material.uniforms.map.value=(new al).load(e)):(this._material.uniforms.map.value=e,this._material.uniforms.useMap.value=null!=e&&null!=e)}get maps(){return this._material.uniforms.map.value}set color(e){const t={h:0,s:0,l:0};new Qt(e).getHSL(t),this._material.uniforms.color.value=new Ce(t.h,t.s,t.l)}get color(){const e=new Qt,t=this._material.uniforms.color.value;return e.setHSL(t.x,t.y,t.z),`#${e.getHexString()}`}set useColorAnimate(e){"boolean"==typeof e?this._material.uniforms.useColorAnimate.value=e:console.warn("该属性不生效,请输入boolean")}get useColorAnimate(){return this._material.uniforms.useColorAnimate.value}set colorRange(e){this._material.uniforms.colorRange.value=new Qt(e)}get colorRange(){return`#${this._material.uniforms.colorRange.value.getHexString()}`}set colorEndAnimate(e){const t={h:0,s:0,l:0};new Qt(e).getHSL(t),this._material.uniforms.colorEndAnimate.value=new Ce(t.h,t.s,t.l)}get colorEndAnimate(){const e=new Qt,t=this._material.uniforms.colorEndAnimate.value;return e.setHSL(t.x,t.y,t.z),`#${e.getHexString()}`}set opacity(e){this._material.uniforms.opacity.value=e}get opacity(){return this._material.uniforms.opacity.value}set useOpacityAnimate(e){"boolean"==typeof e?this._material.uniforms.useOpacityAnimate.value=e:console.warn("该属性不生效,请输入boolean")}get useOpacityAnimate(){return this._material.uniforms.useOpacityAnimate.value}set opacityRange(e){this._material.uniforms.opacityRange.value=e/100}get opacityRange(){return 100*this._material.uniforms.opacityRange.value}set opacityEndAnimate(e){this._material.uniforms.opacityEndAnimate.value=e}get opacityEndAnimate(){return this._material.uniforms.opacityEndAnimate.value}set angle(e){this._material.uniforms.angle.value=e}get angle(){return this._material.uniforms.angle.value}set angleRange(e){this._material.uniforms.angleRange.value=e/100}get angleRange(){return 100*this._material.uniforms.angleRange.value}set angleSpeed(e){this._material.uniforms.angleSpeed.value=e}get angleSpeed(){return this._material.uniforms.angleSpeed.value}set angleSpeedRange(e){this._material.uniforms.angleSpeedRange.value=e/100}get angleSpeedRange(){return 100*this._material.uniforms.angleSpeedRange.value}set angleAcceleration(e){this._material.uniforms.angleAcceleration.value=e}get angleAcceleration(){return this._material.uniforms.angleAcceleration.value}set angleAccelerationRange(e){this._material.uniforms.angleAccelerationRange.value=e/100}get angleAccelerationRange(){return 100*this._material.uniforms.angleAccelerationRange.value}set lookFar(e){this._material.uniforms.viewFar.value=e}get lookFar(){return this._material.uniforms.viewFar.value}set lookNear(e){this._material.uniforms.viewNear.value=e}get lookNear(){return this._material.uniforms.viewNear.value}set blending(e){"string"==typeof e?"AdditiveBlending"==e||"NormalBlending"==e?this._material.blending=eu[e]:console.warn("没有这种类型，请检查你输入的字符串，当前应用不生效"):"number"==typeof e&&(this._material.blending=e)}get blending(){return 1==this._material.blending?"NormalBlending":2==this._material.blending?"AdditiveBlending":void 0}_setMap(){G_((e=>{this.maps=(new al).load(e)}))}_clearMap(){this.maps=null}toJSON(){let e;return this.maps&&this.maps.isTexture&&this.maps.image&&(e=this.maps.image.currentSrc),{pointNum:this.pointNum,play:this.play,pause:this.pause,loop:this.loop,pointAge:this.pointAge,pointAgeRanges:this.pointAgeRanges,allPointAge:this.allPointAge,playSpeed:this.playSpeed,density:this.density,offset:this.offset,position:this.position,inherit:this.inherit,shapeType:this.shapeType,positionRange:this.positionRange,radius:this.radius,radiusRange:this.radiusRange,JointType:this.JointType,velocityWay:this.velocityWay,velocitySpeed:this.velocitySpeed,velocityWayRange:this.velocityWayRange,velocitySpeedRange:this.velocitySpeedRange,diffusionVelocity:this.diffusionVelocity,diffusionVelocityRange:this.diffusionVelocityRange,acceleration:this.acceleration,accelerationRange:this.accelerationRange,size:this.size,sizeRanges:this.sizeRanges,useSizeAnimate:this.useSizeAnimate,sizeEndAnimate:this.sizeEndAnimate,maps:e,color:this.color,useColorAnimate:this.useColorAnimate,colorRange:this.colorRange,colorEndAnimate:this.colorEndAnimate,opacity:this.opacity,useOpacityAnimate:this.useOpacityAnimate,opacityRange:this.opacityRange,opacityEndAnimate:this.opacityEndAnimate,angle:this.angle,angleRange:this.angleRange,angleSpeed:this.angleSpeed,angleSpeedRange:this.angleSpeedRange,angleAcceleration:this.angleAcceleration,angleAccelerationRange:this.angleAccelerationRange,lookFar:this.lookFar,lookNear:this.lookNear,blending:this.blending}}applyJSON(e){let t={};for(let i in e)null!=e[i].x&&null!=e[i].y&&null!=e[i].z?t[i]=new Ce(e[i].x,e[i].y,e[i].z):"inheritPos"==i||(t[i]=e[i]);Object.assign(this,t),this.inherit=!1,e.inheritPos&&setTimeout((()=>{this.inherit=!0}),500),this._gui&&this.showControlPanel()}toJSONFile(){((e,t="particleStyle")=>{const i=JSON.stringify(e,void 0,4),n=new Blob([i],{type:"text/json"}),a=document.createElement("a");a.download=`${t}.json`,a.href=window.URL.createObjectURL(n),a.dataset.downloadurl=["text/json",a.download,a.href].join(":"),a.click()})(this.toJSON())}readJSONFile(){G_(null,(e=>{this.applyJSON(JSON.parse(e))}))}showControlPanel(){this._gui&&(this._gui.destroy(),this._gui=null),this._gui2&&(this._gui2.destroy(),this._gui2=null),this._gui=new N_,this._gui2=new N_;const e=this._gui.addFolder("粒子运动状态调试器");e.add(this,"pointNum"),e.add(this,"play").listen(),e.add(this,"pause"),e.add(this,"loop"),e.add(this,"_timeLoopValue").listen().name("播放时长"),e.add(this,"pointAge",0,10,.1),e.add(this,"pointAgeRanges",0,100,.1).name("pointAgeRanges(%)"),e.add(this,"allPointAge",0,60,.1),e.add(this,"playSpeed",.001,10,.001),e.add(this,"density",0,1,.001);const t=e.addFolder("起始偏移位置");t.add(this.offset,"x",-1e3,1e3,.1),t.add(this.offset,"y",-1e3,1e3,.1),t.add(this.offset,"z",-1e3,1e3,.1);const i=e.addFolder("起始发射位置");i.add(this.position,"x",-1e3,1e3,.1),i.add(this.position,"y",-1e3,1e3,.1),i.add(this.position,"z",-1e3,1e3,.1),e.add(this,"inherit"),e.add(this,"shapeType",["CUBE","SPHERE"]);const n=e.addFolder("起始发射位置范围");n.add(this.positionRange,"x",-1e3,1e3,.1),n.add(this.positionRange,"y",-1e3,1e3,.1),n.add(this.positionRange,"z",-1e3,1e3,.1),e.add(this,"radius",0,1e3,.1),e.add(this,"radiusRange",0,600,.1),e.add(this,"motionSpacing",0,2,1e-4).listen(),e.add(this,"JointType",["CUBE","SPHERE"]);const a=e.addFolder("cube运动类型方向");a.add(this,"arrow").listen(),a.add(this.velocityWay,"x",-1,1,.01).onChange((()=>{this._arrowHelper&&this._arrowHelper.setDirection(this._material.uniforms.translatoryVelocityWay.value.normalize())})),a.add(this.velocityWay,"y",-1,1,.01).onChange((()=>{this._arrowHelper&&this._arrowHelper.setDirection(this._material.uniforms.translatoryVelocityWay.value.normalize())})),a.add(this.velocityWay,"z",-1,1,.01).onChange((()=>{this._arrowHelper&&this._arrowHelper.setDirection(this._material.uniforms.translatoryVelocityWay.value.normalize())})),e.add(this,"velocitySpeed",-1e3,1e3,.1);const r=e.addFolder("cube运动类型方向随机范围");r.add(this.velocityWayRange,"x",0,1,.01),r.add(this.velocityWayRange,"y",0,1,.01),r.add(this.velocityWayRange,"z",0,1,.01),e.add(this,"velocitySpeedRange",-1e3,1e3,.1),e.add(this,"diffusionVelocity",-200,200,.1),e.add(this,"diffusionVelocityRange",-200,200,.1);const s=e.addFolder("运动加速度");s.add(this.acceleration,"x",-1e3,1e3,.1),s.add(this.acceleration,"y",-1e3,1e3,.1),s.add(this.acceleration,"z",-1e3,1e3,.1);const o=e.addFolder("运动加速度随机范围百分比");o.add(this.accelerationRange,"x",-1e3,1e3,.1),o.add(this.accelerationRange,"y",-1e3,1e3,.1),o.add(this.accelerationRange,"z",-1e3,1e3,.1),e.add(this,"gravity"),e.add(this,"gravityValue",-100,100),e.add(this,"size",.1,1e3,.1),e.add(this,"sizeRanges",0,100,.01).name("sizeRange(%)").onChange((()=>{this.useSizeAnimate&&console.warn("当前属性不生效,请检查useSizeAnimate是否关闭")})),e.add(this,"useSizeAnimate").onChange((()=>{console.warn("启动该属性，尺寸大小随机不生效")})),e.add(this,"sizeEndAnimate",0,100).onChange((()=>{0==this.useSizeAnimate&&console.warn("当前属性不生效,请检查useSizeAnimate是否开启")}));const l=this._gui2.addFolder("粒子样式编辑器");l.add(this,"_setMap").name("maps"),l.add(this,"_clearMap").name("clearMap"),l.addColor(this,"color"),l.add(this,"useColorAnimate"),l.addColor(this,"colorRange").onChange((()=>{this.useColorAnimate&&console.warn("当前属性不生效,请检查useColorAnimate是否关闭")})),l.addColor(this,"colorEndAnimate").onChange((()=>{this.useColorAnimate||console.warn("当前属性不生效,请检查useColorAnimate是否开启")})),l.add(this,"opacity",0,1,.01),l.add(this,"useOpacityAnimate"),l.add(this,"opacityRange",0,100,.01).name("opacityRange(%)"),l.add(this,"opacityEndAnimate",0,1,.01),l.add(this,"angle",-180,180,.1),l.add(this,"angleRange",0,100,.01).name("angleRange(%)"),l.add(this,"angleSpeed",-180,180,.1),l.add(this,"angleSpeedRange",0,100,.01).name("angleSpeedRange(%)"),l.add(this,"angleAcceleration",-180,180,.1),l.add(this,"angleAccelerationRange",0,100,.01).name("angleAccelerationRange(%)"),l.add(this,"lookFar",0,1e3,.1),l.add(this,"lookNear",0,1e4,.1),l.add(this,"blending",["NormalBlending","AdditiveBlending"]),l.add(this,"toJSONFile").name("exportToJSON"),l.add(this,"readJSONFile").name("readJSONToApply")}destroyControlPanel(){this._gui&&(this._gui.destroy(),this._gui=null),this._gui2&&(this._gui2.destroy(),this._gui2=null)}}{constructor(e,t){super(Ep.scene),this.initConversionAttribute(),t&&this.setParent(t),this.applySetting(e),this._getParam=()=>e}initConversionAttribute(){this.name="默认粒子";let e=null;this.setFamily=t=>{e=t},this.getFamily=()=>e,this._waySpeed=1,this._waySpeedRange=0,this._wayAngleRange=0,this._wayDirect=new Ce(0,1,0),this._wayAngleDirect=new Ce(0,1,0),this._wayAngle=new dt(0,0,0,"XYZ"),this._texture=null,this._resize=!1}exportDate(){let e=this._inherit;let t=[];this.getFamily().matrix.clone().toArray(t,0);return{pointSec:this.pointNum,name:this.name,id:this.id,position:new Ce(0,0,0),shapeType:this.shapeType.toLowerCase(),positionRange:this.positionRange,positionRadius:this.positionRadius,positionRadiusRange:this.positionRadiusRange,velocityShape:this.velocityShape,velocity:this.velocity,velocityRange:this.velocityRange,speed:this.speed,speedRange:this.speedRange,gravity:this.gravity,gravityValue:this.gravityValue,pointDeathAges:this.pointDeathAges,_deathAge:this._deathAge,loop:this.loop,pointNum:this.pointNum,angle:this.angle,angleRange:this.angleRange,angleVelocity:this.angleVelocity,angleVelocityRange:this.angleVelocityRange,angleAcceleration:this.angleAcceleration,angleAccelerationRange:this.angleAccelerationRange,size:this.size,sizeRange:this.sizeRange,sizeTween:{times:[0,1],values:[this.size,this.sizeEndAnimate]},opacity:this._opacity,opacityRange:this.opacityRange,opacityTween:{times:[0,1],values:[this.opacity,this.opacityEndAnimate]},color:this.color,colorRange:this.colorRange,colorToRange:this.colorToRange,colorTween:(e=>{const t={times:[],values:[]};return t.times=[0,1],t.values[0]=this.color,t.values[1]=this.colorEndAnimate,t})(this.colorTween),colorChange:this.colorChange,startColor:this.startColor,finalColor:this.finalColor,textureURL:this.textureURL,textureName:this.textureName,_texture:this._texture,parentName:this.parentName,blendMode:this.blendMode,inheritPos:e,pointDeathAgeRange:this.pointDeathAgeRange,_wayAngle:this._wayAngle,_waySpeed:this._waySpeed,_waySpeedRange:this._waySpeedRange,_wayDirect:this._wayDirect,_wayAngleRange:this._wayAngleRange,_wayAngleDirect:this._wayAngleDirect,_far:this._far,_near:this._near,rotSpeedRange:this.rotSpeedRange,lookFar:this.lookFar,lookNear:this.lookNear,pointAgeRange:this.pointAgeRange,wayAngleRange:this.wayAngleRange,waySpeed:this.waySpeed,waySpeedRange:this.waySpeedRange,wayAngleX:this.wayAngleX,wayAngleY:this.wayAngleY,wayAngleZ:this.wayAngleZ,startSize:this.startSize,finalSize:this.finalSize,offsetPos:this.offsetPos,speedArrow:this.speedArrow,startOpacity:this.startOpacity,finalOpacity:this.finalOpacity,alive:this.alive,storeBindingName:this.storeBindingName,familyMatrixArray:t,familyMatrixOffset:0,state:this.state,densityValue:this.density,version:"GPU"}}applySetting(e){let t,i={};for(let t in e)null!=e[t]&&null!=e[t]&&("pointNum"==t||("shapeType"==t?i[t]=e[t].toUpperCase():"color"==t||"colorRange"==t?e.color.isVector3?i[t]=this.getColor(e[t]):i[t]=e[t]:t.indexOf("Tween")>-1?"colorTween"==t?i.colorEndAnimate=this.getColor(e[t].values[1]):"opacityTween"==t?null!=e[t].values[1]&&null!=e[t].values[1]&&(i.opacityEndAnimate=e[t].values[1]):"sizeTween"==t&&null!=e[t].values[1]&&null!=e[t].values[1]&&(i.sizeEndAnimate=e[t].values[1]):"densityValue"==t?i.density=e[t]:"velocity"==t||"velocityRange"==t||(t.indexOf("_")>-1?"_deathAge"==t&&(i._deathAge=e[t]):i[t]=e[t])));null==i.state&&(i.state=!0),0==i.state?(this._resize=!1,this.state=!1):1==i.state&&(this._resize=!0,this.state=!0,this._material.uniforms.hidePlay.value=!1),"GPU"!=i.version&&(i.pointSec*=10,i.positionRadiusRange&&(i.radiusRange=i.positionRadiusRange,delete i.positionRadiusRange,i._deathAge/=4)),this.applyJSON(i),null!=i.wayAngleRange&&(this.wayAngleRange=i.wayAngleRange),null!=i.pointAgeRange&&(this.pointAgeRange=i.pointAgeRange),e.textureURL=e.textureURL,e.textureName=e.textureName||"",t=e.textureURL?0===e.textureURL.indexOf("http")||0===e.textureURL.indexOf("[[origin]]")||0===e.textureURL.indexOf("data:image/")?e.textureURL:_y.url(Ep.instance.resourceBasePath,e.textureURL):_y.url(Ep.instance.resourceBasePath,"texture/particles/star.png"),Ep.customTextureStore.loadTexture({url:t,name:e.textureName||t,onLoad:e=>{this._texture=new vs(e.textureSource),this._texture.flipY=!1,this.maps=this._texture}})}setParentByUUID(e){const t=this.getFamily().getObjectByProperty("uuid",e);t?this.setParent(t):(console.warn("由于没有找到对应的uuid,该父对象将设置为默认的group"),this.setParent(this.getFamily()))}setParentByName(e){const t=this.getFamily().getObjectByName(e);t?this.setParent(t):(console.warn("由于没有找到对应的name,该父对象将设置为默认的group"),this.setParent(this.getFamily()))}showPanel(){this.showControlPanel()}destroyPanel(){this.destroyControlPanel()}getColor(e){if(e){return`#${(new Qt).setHSL(e.x,e.y,e.z).getHexString()}`}return`#${(new Qt).setHSL(0,0,0).getHexString()}`}resize(e){this._resize&&(this._material.uniforms.resize.value=e,this._material.uniforms.times.value+=100)}set pointDeathAges(e){this.pointAge=e}get pointDeathAges(){return this.pointAge}set rotSpeedRange(e){const t=e/100;this.angleSpeedRange=this.angleSpeed*t}get rotSpeedRange(){return this.angleSpeedRange/this.angleSpeed*100}set pointAgeRange(e){this.pointAgeRanges=e>=100?100:e}get pointAgeRange(){return this.pointAgeRanges}set waySpeed(e){this._waySpeed=e,this.velocitySpeed=this._waySpeed}get waySpeed(){return this._waySpeed}set waySpeedRange(e){this._waySpeedRange=e/100*this._waySpeed,this.velocitySpeedRange=this._waySpeedRange}get waySpeedRange(){return this._waySpeedRange/this._waySpeed*100}set wayAngleX(e){const t=ge.degToRad(e);this._wayAngle.x=t,this._wayAngleDirect.copy(this._wayDirect.clone().applyEuler(this._wayAngle)),this.velocity=this._wayAngleDirect.normalize().multiplyScalar(this._waySpeed)}get wayAngleX(){return ge.radToDeg(this._wayAngle.x)}set wayAngleY(e){const t=ge.degToRad(e);this._wayAngle.y=t,this._wayAngleDirect.copy(this._wayDirect.clone().applyEuler(this._wayAngle)),this.velocity=this._wayAngleDirect.normalize().multiplyScalar(this._waySpeed)}get wayAngleY(){return ge.radToDeg(this._wayAngle.y)}set wayAngleZ(e){const t=ge.degToRad(e);this._wayAngle.z=t,this._wayAngleDirect.copy(this._wayDirect.clone().applyEuler(this._wayAngle)),this.velocity=this._wayAngleDirect.normalize().multiplyScalar(this._waySpeed)}get wayAngleZ(){return ge.radToDeg(this._wayAngle.z)}set wayAngleRange(e){this._wayAngleRange=e/100;const t=new Ce(1,1,1).multiplyScalar(this._wayAngleRange);this.velocityRange=t}get wayAngleRange(){return 100*this._wayAngleRange}set startSize(e){this.size=e}get startSize(){return this.size}set sizeRange(e){this.sizeRanges=e}get sizeRange(){return this.sizeRanges}set finalSize(e){this.sizeEndAnimate=e}get finalSize(){return this.sizeEndAnimate}set startOpacity(e){this.opacity=e}get startOpacity(){return this.opacity}set finalOpacity(e){this.opacityEndAnimate=e}get finalOpacity(){return this.opacityEndAnimate}set pointSec(e){this.pointNum=e}get pointSec(){return this.pointNum}reset(){this.resetInnerPosition()}set state(e){this.play=e}get state(){return this.play}set _deathAge(e){this.allPointAge=e}get _deathAge(){return this.allPointAge}set startColor(e){this.color=e}get startColor(){return this.color}set colorChange(e){this.useColorAnimate=e}get colorChange(){return this.useColorAnimate}set finalColor(e){this.colorEndAnimate=e}get finalColor(){return this.colorEndAnimate}set blendMode(e){this.blending=e}get blendMode(){return this.blending}set inheritPos(e){this.inherit=e}get inheritPos(){return this.inherit}set speedArrow(e){this.arrow=e}get speedArrow(){return this.arrow}set velocity(e){this.velocityWay=e}get velocity(){return this.velocityWay}set velocityRange(e){this.velocityWayRange=e}get velocityRange(){return this.velocityWayRange}set positionRadius(e){this.radius=e}get positionRadius(){return this.radius}set positionRadiusRange(e){this.radius=e}get positionRadiusRange(){return this.radius}set velocityShape(e){this.JointType=e}get velocityShape(){return this.JointType.toLowerCase()}set speed(e){this.diffusionVelocity=e}get speed(){return this.diffusionVelocity}set speedRange(e){}get speedRange(){return 0}set colorToRange(e){this.useColorAnimate=1!=e}get colorToRange(){return 1!=this.useColorAnimate}set angleVelocity(e){this.angleSpeed=e}get angleVelocity(){return this.angleSpeed}set angleVelocityRange(e){this.angleSpeedRange=e}get angleVelocityRange(){return this.angleSpeedRange}set pointDeathAgeRange(e){}get pointDeathAgeRange(){return 1}set offsetPos(e){this.offset=e}get offsetPos(){return this.offset}set map(e){let t;this.textureURL=e,t=this.textureURL?0===this.textureURL.indexOf("http")||0===this.textureURL.indexOf("[[origin]]")||0===this.textureURL.indexOf("data:image/")?this.textureURL:_y.url(Ep.instance.resourceBasePath,this.textureURL):_y.url(Ep.instance.resourceBasePath,"texture/particles/star.png"),Ep.customTextureStore.loadTexture({url:t,name:this.textureName||t,onLoad:e=>{this._texture=new vs(e.textureSource),this._texture.flipY=!1,this.maps=this._texture}})}get map(){return this._texture}updateParticleMaterialMatrix(){this.testUpdateWorldPosition()}clone(){const e=this.exportDate(),t=new this.constructor(JSON.parse(JSON.stringify(e)));return t.setFamily(this.getFamily()),e.parentName?t.setParentByName(e.parentName):t.setParent(this.getFamily()),t.id=ge.generateUUID(),t}}let W_=0;class Y_{constructor(e){this.getModelItem=()=>e,this.initArrayFunc(),this._initGroups(),this.initData(),this.setParent(this.getModelItem().getGroup()),this.panelsVisible=!1,this.needsRemove=!1,this.isParticleStore=!0}initData(){this.particleGroup=[],this.particleNum=0,this.particleAnimateData=[];let e=this.getModelItem().getGroup();this.getParent=()=>e,this.setParent=t=>{this.particleModelGroup.parent&&this.particleModelGroup.parent.remove(this.particleModelGroup),e=t,this.updateAllParticleData((t=>{t instanceof V_&&(t.storeBindingName=e.name)})),e.add(this.particleModelGroup)},this.id=ge.generateUUID(),this._state=!0}initArrayFunc(){this.arrayRemove=function(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)}}_initGroups(){this.particleModelGroup=new sr,this.particleModelGroup.name="粒子管理器组",this.particleModelGroup.isForParticle=!0}set name(e){this.particleModelGroup.name=e,this._name=e}get name(){return this.particleModelGroup.name}resize(e){for(let t=0,i=this.particleGroup.length;t<i;t++)this.particleGroup[t].resize(e)}getParticleAnimation(e){e&&e.traverse((e=>{if(e.isPoints&&"particle"==e.styleType){let t;null!=e.system.name&&""!=e.system.name?t=e.system.name:(t=`粒子动画${this.particleNum}`,this.particleNum++),e.system.name=t,this.particleGroup.push(e.system)}}))}setParentByName(e){const t=this.getModelItem().getGroup();if(t){for(let i=0,n=t.children.length;i<n;i++)if(t.children[i]){let n;"function"==typeof t.children[i].getObjectByName?n=t.children[i].getObjectByName(e):t.children[i].getGroup()&&"function"==typeof t.children[i].getGroup().getObjectByName&&(n=t.children[i].getGroup().getObjectByName(e)),n&&this.setParent(n)}this.parentName&&(console.warn("由于没有找到对应的name,该父对象将设置为默认的group"),this.setParent(this.getParent().children[0]))}else console.warn("由于没有找到对应的name,该父对象将设置为默认的group"),this.setParent(this.getParent().children[0])}addParticle(e={name:"粒子发射器",pointNum:10,shapeType:"cube",position:new Ce(0,0,0),velocityShape:"cube",velocity:new Ce(0,0,0),waySpeed:3,startSize:1,finalSize:1,size:1,pointSec:10}){let t,i;"object"==typeof e?t=e:"string"==typeof e&&(t=(e=>{if(e)return U_[e]()})(e),t._texture=(new al).load(_y.url(Ep.instance.resourceBasePath,t.textureURL)));const n=this.particleModelGroup;this.getModelItem()instanceof X_?i=new H_(t,this.getModelItem(),n):(t.storeBindingName=this.getParent().name,i=new V_(t,n,this.getModelItem())),i.setFamily(n),e.parentName?i.setParentByName(e.parentName):i.setParent(n),""!=i.name||i.name||(i.name=`粒子动画${this.particleNum}`,this.particleNum++),this.particleGroup.push(i)}copyParticle(e){let t;for(let i=0;i<this.particleGroup.length;i++)this.particleGroup[i].id==e&&(t=this.particleGroup[i].clone());if(!t)throw error;return this.particleGroup.push(t),t}getState(){if(this.particleGroup.length>0)for(let e=0;e<this.particleGroup.length;e++);else console.warn("当前场景内部没有动画。。。。。。")}updateAllParticleData(e){for(let t=0;t<this.particleGroup.length;t++)"function"==typeof e&&e(this.particleGroup[t])}testGetData(e){const t=this.getParent(),i=new Ce;e.getWorldScale(i),window.scaleArray||(window.scaleArray=[]),window.scaleArray.push(`${t.scale.x},${t.scale.y},${t.scale.z},   ,${i.x},${i.y},${i.z}||`);const n=new Ce;e.getWorldPosition(n),window.positionArray||(window.positionArray=[]),window.positionArray.push(`${t.position.x},${t.position.y},${t.position.z},   ,${n.x},${n.y},${n.z}||`);const a=new dt,r=new Ee;e.getWorldQuaternion(r),a.setFromQuaternion(r),window.rotateArray||(window.rotateArray=[]),window.rotateArray.push(`${t.rotation.x},${t.rotation.y},${t.rotation.z},    ,${a.x},${a.y},${a.z}||`),window.matrixArray||(window.matrixArray=[]),window.matrixArray.push(`${t.matrix},    ,${e.matrixWorld}||`)}update(e){for(let t=0;t<this.particleGroup.length;t++)this.particleGroup[t].update(e),window.catchData&&this.testGetData(this.particleGroup[t]._mesh)}updateInstancedMatrix(){for(let e=0;e<this.particleGroup.length;e++)this.particleGroup[e].updateInstanceMatrix()}resetAll(){for(let e=0;e<this.particleGroup.length;e++)this.particleGroup[e].reset()}updateParticleMaterialMatrix(){this.particleGroup.forEach((e=>{e.testUpdateWorldPosition&&e.computeInherit2()}))}initGUI(){this.gui=new N_}set nameFolder(e){this.parentGUI.domElement.innerText=e}showPanel(){this.initGUI(),this.parentGUI=this.gui.addFolder("动画管理器");for(let e=0;e<this.particleGroup.length;e++)this.addPanelList(this.parentGUI,this.particleGroup[e]);this.panelsVisible=!0,document.getElementsByClassName("dg ac")[0].style.zIndex=1e5}addPanelList(e,t){const i={obs:t,state:t.state,name:t.name+W_,showPanel:!1};W_++;const n=e.addFolder(i.name);n.add(i,"state").name(`${i.name}动画`).onChange((e=>{i.obs.state=e})),n.add(i,"showPanel").name(`${i.name}的控制面板`).onChange((e=>{e?i.obs.showPanel():i.obs.destroyPanel()})),n.add(this,"clearOne").name("删除动画").onChange((t=>{this.remove(i.obs),e.removeFolder(n)}))}clearOne(e){this.arrayRemove(this.particleGroup,e)}remove(e){1==e.panelsVisible&&e.destroyPanel(),this.clearOne(e),e.dispose()}removeAll(){for(var e=this.particleGroup.length-1;e>=0;e--)this.remove(this.particleGroup[e])}destroyPanel(){this.gui.destroy(),this.panelsVisible=!1}getParticleStoreSetting(){const e={particleData:null,name:null};e.particleData=this.getSetting(),e.name=this.name,e.parentName=this.getParent()?this.getParent().name:"",e.position=this.particleModelGroup.position.clone();let t={};return t.x=ge.radToDeg(this.particleModelGroup.rotation.x),t.y=ge.radToDeg(this.particleModelGroup.rotation.y),t.z=ge.radToDeg(this.particleModelGroup.rotation.z),e.rotation=t,e}getSetting(){this.particleAnimateData=[];const e=this.particleGroup.length;for(let t=0;t<e;t++)this.particleAnimateData.push(this.particleGroup[t].exportDate());return this.particleAnimateData}applyParticleSettings(e){e&&(e.parentName&&this.setParentByName(e.parentName),e.position&&this.particleModelGroup.position.set(e.position.x,e.position.y,e.position.z),e.rotation&&this.particleModelGroup.rotation.set(ge.degToRad(e.rotation.x),ge.degToRad(e.rotation.y),ge.degToRad(e.rotation.z)),e.particleData&&this.applySetting(e.particleData))}applySetting(e){const t=e=>{let t=new Qt(e).getHSL({});return new Ce(t.h,t.s,t.l)},i=e=>{const i=e;for(let n=0;n<e.values.length;n++){const a=t(e.values[n]);i.values[n]=a}return i};for(let n=0;n<e.length;n++)if(e[n]){let a={};Object.assign(a,e[n]),a.position=this.JsonToVec3(a.position),a.positionRange=this.JsonToVec3(a.positionRange),a.velocity=this.JsonToVec3(a.velocity),a.velocityRange=this.JsonToVec3(a.velocityRange),a.acceleration&&(a.acceleration=this.JsonToVec3(a.acceleration),a.acceleration.multiplyScalar(-1)),a.accelerationRange&&(a.accelerationRange=this.JsonToVec3(a.accelerationRange)),a.offsetPos&&(a.offsetPos=this.JsonToVec3(a.offsetPos)),a.sizeTween&&(a.sizeTween=this.JsonTomTween(a.sizeTween)),a._sizeTween&&(a._sizeTween=this.JsonTomTween(a._sizeTween)),a.opacityTween=this.JsonTomTween(a.opacityTween),a.color=t(a.color),a.colorRange=t(a.colorRange),a.colorTween=i(a.colorTween),a.colorTween=this.JsonTomTween(a.colorTween),a._wayDirect=this.JsonToVec3(a._wayDirect),a._wayAngleDirect=this.JsonToVec3(a._wayAngleDirect),a._wayAngle=this.JsontoEuler(a._wayAngle),delete a.speedArrow,this.addParticle(a)}}setParentByUUID(e){const t=this.getModelItem().getGroup().getObjectByProperty("uuid",e);t?this.setParent(t):(console.warn("由于没有找到对应的uuid,该父对象将设置为默认的group"),this.setParent(this.getParent()))}dispose(){this.particleModelGroup.traverse((e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e=null}));const e=this.particleModelGroup.parent;e&&e.remove(this.particleModelGroup),this.particleModelGroup=null,this._initGroups();for(let e=0;e<this.particleGroup.length;e++)this.particleGroup[e].dispose();this.particleGroup.splice(0,this.particleGroup.length),this.particleAnimateData.splice(0,this.particleAnimateData.length),this.particleNum=0}JsonToVec3(e){if("object"==typeof e)return new Ce(e.x,e.y,e.z)}JsontoEuler(e){if("object"==typeof e)return new dt(e.x,e.y,e.z,"XYZ")}JsonTomTween(e){if(e){for(let t=0;t<e.values.length;t++)"object"==typeof e.values[t]&&(e.values[t]=this.JsonToVec3(e.values[t]));return new B_(e.times,e.values)}}set state(e){this._state=e;for(let t=0;t<this.particleGroup.length;t++)this.particleGroup[t].state=e}get state(){return this._state}clone(){const e=new this.constructor(this.getModelItem()),t=this.getParticleStoreSetting();return e.applyParticleSettings(JSON.parse(JSON.stringify(t))),e}}class X_{constructor({path:e,gltf:t,name:i,children:n,count:a=1,transform:r,points:s,matrix:o,randomValues:l,rotateY:c=0,newMatrix:h,particleStores:u}={},d,p,m,f){if(!(s&&s instanceof Array))return;s.length>zy&&(logger.warn(`实例对象的实例数不能超过 65535，将忽略超出的 ${s.length-zy} 个实例。`),s.splice(zy,s.length-zy)),a=s.length,this.name=i,this.children=n||[],this.type="ModelAsset",this.count=a,this.points=s,this.transform=r,this.matrix=[],this.path=e,this.materialStore=new Eb(Ep.textureStore,Ep.instance),this.particleStoreArray=[],this.animations=[];let g=null,y=[],v={},b=d,_=new Re,x=new Ce,w=new Ce(1,1,1),S=[],M=l;this.newMatrix=h||{},this.visible={},this.settings=[];let T=new it;T.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);let A=null,E=null;"GroupItem"===d.type?d.childrenAdd(this):d.addInstanced("ModelAsset",this),this.rotateY=c,this.setRand=e=>{M=e},this.getRand=()=>M,this.getCount=()=>this.count,this.getHelper=e=>S.length>e?S[e]:null,this.getGroup=()=>b,this.timeID=null,this.updateParticleStore=()=>{this.timeID&&clearTimeout(this.timeID),this.timeID=setTimeout((()=>{this.particleStoreArray.map((e=>{e.updateInstancedMatrix()}))}),1500)},this.restoreInstanceFromMatrix=e=>{if(e){for(let t=0;t<e.length;t++){let i=new it;i.fromArray(e[t].elements);for(let e of y)e.userData.matrices[t]={matrix:i.clone(),rotatingMatrix:i.clone().identity()},e.matrixWorldOffset?e.setMatrixAt(t,i.clone().multiply(e.matrixWorldOffset)):e.setMatrixAt(t,i.clone()),e.instanceMatrix.needsUpdate=!0;let n=new Re,a=new Ce,r=new dt;if(i.decompose(a,r,w),n.setFromCenterAndSize(a,x.clone().multiply(w)),"PaintItem"===b.type){let e=new Mb(n,16776960,b,this);e.visible=!1,e.userData.key=t,e.name="helper"+t,e.defaultSize=x.clone(),e.applyMatrix4(i),e.updateMatrix(),b.add(e),S.push(e)}}this.updateParticleStore()}},this.removeInstance=(e,t)=>{if(!("number"!=typeof e||e>this.points)){if("PaintItem"===b.type){delete this.newMatrix[e];for(let t=e;t<this.points.length-1;t++){for(let e of y){let i=new it;e.getMatrixAt(t+1,i),e.setMatrixAt(t,i),e.instanceMatrix.needsUpdate=!0}this.settings[t+1].key=this.settings[t+1].key-1,S.length>t+1&&(S[t+1].userData.key=S[t+1].userData.key-1)}for(let e of y)e.count-=1;S.length>e&&(b.getGroup().remove(S[e]),S.splice(e,1)),this.points.splice(e,1),this.settings.splice(e,1);for(const t in this.newMatrix)if(t>=e){let e=new it;e=this.newMatrix[t].clone?this.newMatrix[t].clone():e.fromArray(this.newMatrix[t].elements),this.newMatrix[t-1]=e,delete this.newMatrix[t]}}else if("GroupItem"===b.type){for(let t=e;t<this.points.length-1;t++)for(let e of y){let i=new it;e.getMatrixAt(t+1,i),e.setMatrixAt(t,i),e.instanceMatrix.needsUpdate=!0}for(let e of y)e.count-=1;this.points.splice(e,1)}this.updateParticleStore(),t&&t(1)}},this.addInstance=(e,t)=>{if(!(e&&e instanceof Array))return;let i=this.points.length;e.length+this.points.length>zy&&(logger.warn(`实例对象的实例数不能超过 65535，将忽略超出的 ${e.length+this.points.length-zy} 个实例。`),this.points.splice(zy-this.points.length,e.length+this.points.length-zy)),this.points.push.apply(this.points,e),this.count=this.points.length;for(let e of y)e.count=this.count;for(let e=i;e<this.points.length;e++){let t=C(this.points[e]),i=(new Ce).setFromMatrixPosition(t),n=new Re;for(let i of y){i.userData.matrices[e]={matrix:t.clone(),rotatingMatrix:t.clone().identity()};let n=t.clone();i.matrixWorldOffset&&n.multiply(i.matrixWorldOffset),i.setMatrixAt(e,n),i.instanceMatrix.needsUpdate=!0,i.setColorAt(e,new Qt),i.instanceColor.needsUpdate=!0;let a=I(v[i.name]);a&&P(a,i,e,n)}if("PaintItem"===b.type){n.setFromCenterAndSize(i,x.clone().multiply(w));let a=new Mb(n,16776960,b,this);a.userData.key=e,a.visible=!1,a.name="helper"+e,a.defaultSize=x.clone(),this.transform.rotation&&a.rotation.set(0-this.transform.rotation._x,0-this.transform.rotation._y,0-this.transform.rotation._z),a.applyMatrix4(t),a.updateMatrix(),b.add(a),S.push(a)}}this.updateParticleStore()},this.getTransform=e=>{let t=new it;if(this.settings[e].isVisible){if(y[0].getMatrixAt(e,t),y[0].matrixWorldOffset){const e=y[0].matrixWorldOffset.clone();e.invert(),t.multiply(e)}}else t=this.newMatrix[e].clone?this.newMatrix[e].clone():t.fromArray(this.newMatrix[e].elements);let i=new Ce,n=new Ee,a=new Ce;return t.decompose(i,n,a),{position:i,rotation:(new dt).setFromQuaternion(n),scale:a}},this.setTransform=(e,t,i,n)=>{let a=new it,r=new Ee;r.setFromEuler(i),a.compose(t,r,n),this.setMatrixAt(e,a);let s=this.settings[e].name;b.getItemByName(s).transform={position:JSON.parse(JSON.stringify(t)),rotation:{x:i._x,y:i._y,z:i._z},scale:JSON.parse(JSON.stringify(n))},this.points[e]=[t.x,t.y,t.z],this.assetObj&&(this.assetObj.points=this.points)},this.setMatrixAt=(e,t,i)=>{if(this.settings[e].isVisible||i)for(let i of y)i.matrixWorldOffset?i.setMatrixAt(e,t.clone().multiply(i.matrixWorldOffset)):i.setMatrixAt(e,t),i.instanceMatrix.needsUpdate=!0;else this.newMatrix[e]=t.clone()},this.traverse=(e,t)=>{if(e&&"function"==typeof e&&this.children&&this.children instanceof Array){t||(t=this.children);for(let i of t)e(i),i.children instanceof Array&&this.traverse(e,i.children)}};let C=(e,t)=>{let i=t?t.getGroup().rotation:new dt,n=t?t.getGroup().scale:new Ce(1,1,1),a=new Ce(e[0]/n.x,e[1]/n.y,e[2]/n.z);a=a.applyEuler(i);let r=new Et;r.position.set(a[0],a[1],a[2]),r.position.set(a.x,a.y,a.z);let s=1;M&&M.scaleMax&&M.scaleMin&&M.scaleFlag&&(s=Math.random()*(M.scaleMax-M.scaleMin)+M.scaleMin),r.scale.set(this.transform.scale.x*s,this.transform.scale.y*s,this.transform.scale.z*s),w=r.scale.clone();let o=0;M&&(o=ge.degToRad(Math.random()*(M.rotateMax-M.rotateMin)+M.rotateMin)),this.rotateY=o,r.rotation.set(this.transform.rotation._x,this.transform.rotation._y+o,this.transform.rotation._z);let l=b.getGroup();l.updateMatrixWorld();let c=l.matrixWorld.clone().invert();return r.applyMatrix4(c),r.updateMatrix(),r.matrix.clone()},I=e=>{let t;for(let i=0;i<this.children.length&&(this.traverse((i=>{i.name===e.name&&(t=i)})),!t);i++);return t},P=(e,t,i,n)=>{let a=new it;if(!n&&t.length>i&&(n=t.getMatrixAt(i)),e.transform){let{position:r,rotation:s,scale:o}=e.transform;r&&(r=new Ce(r.x,r.y,r.z)),s&&(s=new dt(s._x,s._y,s._z)),o&&(o=new Ce(o.x,o.y,o.z));let l=(new Ee).setFromEuler(s);a.compose(r,l,o),n.multiply(a),t.setMatrixAt(i,n),E=n,E.needsUpdate=!0,t.instanceMatrix.needsUpdate=!0}},R=e=>{let t=I(e);if(t&&!t.isVisible)return;const i=e.sourceModelKey;let n=e.geometry.clone(),a=e.material;if(a instanceof Array)for(let e of a){if(e instanceof Kt){let t=_y.MeshBasicMaterialToMeshStandardMaterial(e);a[a.indexOf(e)]=t,e=t}if(e instanceof So){e.alphaTest=.05,e.depthWrite=!0,e.depthTest=!0,e.vertexColors=!1,e.needsUpdate=!0;for(let t in e)if(e[t]instanceof we&&e[t].image){if(!Ep.textureStore){_y.disposeMaterial(e);break}Ep.textureStore.add(e[t].name||`${e.name}#${t}`,e[t],i)}}}else{if(a instanceof Kt){a=_y.MeshBasicMaterialToMeshStandardMaterial(a)}if(a instanceof So){a.alphaTest=.05,a.depthWrite=!0,a.depthTest=!0,a.vertexColors=!1,a.needsUpdate=!0;for(let e in a)if(a[e]instanceof we&&a[e].image){if(!Ep.textureStore){_y.disposeMaterial(a);break}Ep.textureStore.add(a[e].name||`${a.name}#${e}`,a[e],i)}}}if(g=new Qr(n,a,zy),g.userData.matrices={},g.geometry.computeBoundingBox(),g.instanceColor=new ti(new Float32Array(196605),3),_.expandByObject(e),a instanceof Array)for(let e of a)this.materialStore.add(e.name,e,g,this.name);else this.materialStore.add(a.name,a,g,this.name);g.count=this.count,g.name=`${this.name}#${y.length}`,g.castShadow=!0,g.receiveShadow=!0,v[g.name]=e,g.instanceMatrix.setUsage(ue),g.matrixWorldOffset=e.matrixWorld.clone();for(let e=0;e<this.count;e++){let i=new it;if(g.userData.matrices[e]={rotatingMatrix:i.clone()},0===e?(A||(A=C(this.points[e])),i=A.clone()):i=C(this.points[e]),g.userData.matrices[e].matrix=i.clone(),i.multiply(g.matrixWorldOffset),g.setMatrixAt(e,i),E=i,g.instanceMatrix.needsUpdate=!0,g.setColorAt(e,new Qt),g.instanceColor.needsUpdate=!0,t){if(t.isRotating||t.isScaling){let e=Ep.animationStore.findNodeAnimation(g,vv.type);e&&(e.reset(),Ep.animationStore.remove(e)),e=new vv(g,null,t.isRotating,t.rotatingAxis,t.rotatingSpeed,t.isScaling,t.startScale,t.stopScale,t.fadeOutScale,t.scalingSpeed),Ep.animationStore.add(e),this.animations.push(e)}P(t,g,e,i),g.receiveShadow=t.isReceivingShadow,g.castShadow=t.isCastingShadow;break}}for(let e=0;e<this.count;e++)g.setColorAt(e,new Qt),g.instanceColor.needsUpdate=!0;g.originalName=e.name,g.originalUUID=e.uuid,b.add(g),y.push(g)};if(this.getMesh=()=>g,this.getMeshes=()=>y,this.hide=()=>{y.visible=!1},this.show=()=>{y.visible=!0},this.reset=()=>{S.forEach((e=>{e.visible=!1}))},this._hideInstanced=e=>{if(this.newMatrix[e])return;let t=new it;g.getMatrixAt(e,t);for(const t in this.newMatrix)if(t!=e&&this.settings[t].isVisible){let e=this.newMatrix[t];this.setMatrixAt(t,e.clone(),!0),delete this.newMatrix[t]}this.newMatrix[e]=t.clone();let i=t.clone();i.multiplyMatrices(t,T),this.setMatrixAt(e,i,!0)},this.highlight=(e,t)=>{void 0!==e&&!0===t||this.reset(),void 0!==e&&S[e]&&(S[e].visible=this.settings[e].isVisible,t||Ep.transformControls.attach(S[e]))},this.cancelHighlight=e=>{void 0===e&&this.reset(),S[e]&&(S[e].visible=!1,Ep.transformControls.Object===S[e]&&Ep.transformControls.detach())},this.setVisible=(e,t,i=t)=>{if(this.settings[e].isVisible=t,S[e].visible=i,t&&this.newMatrix[e]){let t=new it;t=this.newMatrix[e].clone?this.newMatrix[e].clone():t.fromArray(this.newMatrix[e].elements),this.setMatrixAt(e,t,!0),delete this.newMatrix[e]}else t||this._hideInstanced(e)},this.lock=(e,t)=>{this.settings[e].isLock=t,S[e].visible=!this.settings[e].isLock&&this.settings[e].isVisible},t){if(t.scene.updateMatrixWorld(!0),o){if(this.name===t.scene.name)R(t.scene);else{let e=t.scene.children.find((e=>e.name.indexOf(this.name)>=0));e&&R(e)}_.getSize(x),this.restoreInstanceFromMatrix(o)}p&&p(1,this)}else{if(!e)return;let t=this;Ep.cacheStore.load({path:e,type:"glb",onLoad:e=>{var i;if(e.updateMatrixWorld(!0),e.traverse((e=>{"Mesh"===e.type&&R(e)})),_.getSize(x),o)(i=b instanceof Sb?b.getItemByName(this.name):b.getInstanced("ModelAsset",this.name))&&i.restoreInstanceFromMatrix&&i.restoreInstanceFromMatrix(o);else if("PaintItem"===b.type){let e=new Re;e.setFromCenterAndSize(new Ce(t.points[0][0],t.points[0][1],t.points[0][2]),x.clone().multiply(w));let i=new Mb(e,16776960,b,t);i.defaultSize=x.clone(),i.userData.key=0,i.visible=!1,i.name="helper0",this.transform.rotation&&i.rotation.set(0-this.transform.rotation._x,0-this.transform.rotation._y,0-this.transform.rotation._z),E&&(i.updateMatrix(),E=void 0),b.add(i),S.push(i)}p&&p(1,this)},onProgress:m,onError:f}),this.addParticleStore=e=>{const t=new Y_(this);return t.name=e,Ep.animationStore.add(t),this.particleStoreArray.push(t),t},this.removeParticleStore=e=>{for(let a=0;a<this.particleStoreArray.length;a++)this.particleStoreArray[a].name==e&&(Ep.animationStore.remove(this.particleStoreArray[a]),t=this.particleStoreArray,i=this.particleStoreArray[a],n=void 0,(n=t.indexOf(i))>-1&&t.splice(n,1));var t,i,n},this.getParticleSettings=()=>{let e=[];for(let t=0;t<this.particleStoreArray.length;t++){const i=this.particleStoreArray[t].getParticleStoreSetting();e.push(i)}return e},this.applyParticleSettings=e=>{for(let t=0;t<e.length;t++){this.addParticleStore(e[t].name).applyParticleSettings(e[t])}},u&&this.applyParticleSettings(u)}this.setColorAt=(e,t)=>{for(let i of y)i.setColorAt(e,new Qt(t)),i.instanceColor.needsUpdate=!0},this.getWorldPosition=e=>{let t=new it;if(this.settings[e].isVisible){if(y[0].getMatrixAt(e,t),y[0].matrixWorldOffset){const e=y[0].matrixWorldOffset.clone();e.invert(),t.multiply(e)}}else t=this.newMatrix[e].clone?this.newMatrix[e].clone():t.fromArray(this.newMatrix[e].elements);const i=b.getGroup();return i.updateMatrix(),t.premultiply(i.matrix),(new Ce).setFromMatrixPosition(t)}}}class Z_{constructor({nodes:e=[],modifiers:t,materials:i=[],particles:n=[]}={}){this.nodes=e,this.modifiers=t,this.materials=i,this.particles=n,this.addModifier=(e,t)=>{},this.updateModifier=(e,t)=>{},this.removeModifier=e=>{},this.clone=()=>{const e=[...this.nodes],t=[...this.materials],i=[...this.particles],n=[];for(const e of this.modifiers)n.push({key:e.key,values:[...e.values]});return new this.constructor({nodes:e,modifiers:n,materials:t,particles:i})}}}class q_ extends gy{constructor(e,t,i=1,n,a,r,s,o,l="nodes",c){super("ArticulationAnimationController"),this.name=e+t.name+n,this.animationObject=t,this.duration=i,this.animationType=n,this.initVal=a,this.targetVal=r,this.bindType=l,this._currentTime=0,this._diffValue,[ov.stroke,ov.colorOverlay,ov.colorReplace].includes(this.animationType)||(this._diffValue=(r-a)/i),this._checkOpacity=e=>(e<0&&(e=0),e>1&&(e=1),e),this.render=n=>{if(null!=this.animationObject){if(i-this._currentTime<n||this._currentTime>=i){switch(this.animationType){case ov.rotationX:this.animationObject.rotation.x=r/180*Math.PI;break;case ov.rotationY:this.animationObject.rotation.y=r/180*Math.PI;break;case ov.rotationZ:this.animationObject.rotation.z=r/180*Math.PI;break;case ov.translationX:this.animationObject.position.x=r;break;case ov.translationY:this.animationObject.position.y=r;break;case ov.translationZ:this.animationObject.position.z=r;break;case ov.scaleX:this.animationObject.scale.x=r;break;case ov.scaleY:this.animationObject.scale.y=r;break;case ov.scaleZ:this.animationObject.scale.z=r;break;case ov.opacity:"nodes"===l?t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.transparent=!0,e.opacity=this._checkOpacity(r)})):(e.material.transparent=!0,e.material.opacity=this._checkOpacity(r)))})):"particles"===l&&t.particleGroup.forEach((e=>{e.opacity=this._checkOpacity(r)}));break;case ov.quantityFactor:"particles"===l&&t.particleGroup.forEach((e=>{e.density=this._checkOpacity(r)}));break;case ov.colorOverlay:t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.color=r.color.clone(),e.opacity=r.alpha,e.opacity<=0&&(e.opacity=1,e.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color)})):(e.material.color=r.color.clone(),e.material.opacity=r.alpha,e.material.opacity<=0&&(e.material.opacity=1,e.material.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color)))}));break;case ov.colorReplace:t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{e.map=null,e.color=r.color.clone(),e.opacity=r.alpha,e.opacity<=0&&(e.opacity=1,e.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color,e.map=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.map,e.needsUpdate=!0)})):(e.material.map=null,e.material.color=r.color.clone(),e.material.opacity=r.alpha,e.material.opacity<=0&&(e.material.opacity=1,e.material.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color,e.material.map=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.map,e.material.needsUpdate=!0)))}));break;case ov.stroke:Ep.effectStore.initOutlinePass(t,!1,r);break;case ov.USpeed:if("materials"===l){let e=Ep.animationStore.findMaterialAnimation(this.animationObject._material(),nv.type);if(e)e.enableU=0!==r,e.uSpeed=r;else{let t=new nv(this.animationObject._material(),0!==r,!1,r,0);e=t,Ep.animationStore.add(t)}0===e.uSpeed&&0===e.vSpeed&&e.reset()}break;case ov.VSpeed:if("materials"===l){let e=Ep.animationStore.findMaterialAnimation(this.animationObject._material(),nv.type);if(e)e.enableV=0!==r,e.vSpeed=r;else{let t=new nv(this.animationObject._material(),!1,0!==r,0,r);e=t,Ep.animationStore.add(t)}0===e.uSpeed&&0===e.vSpeed&&e.reset()}break;case ov.materialsReplace:"materials"===l&&(r&&r.path?Ep.instance.materialReplace({path:r.path,material:t,onLoad:()=>{},onProgress:()=>{}}):t.restore(e));break;case ov.visible:this.animationObject.visible=r}return this.needsRemove=!0,this._currentTime=0,void(c&&c())}switch(this._currentTime+=n,this.animationType){case ov.rotationX:this.animationObject.rotation.x+=this._diffValue/180*Math.PI*n;break;case ov.rotationY:this.animationObject.rotation.y+=this._diffValue/180*Math.PI*n;break;case ov.rotationZ:this.animationObject.rotation.z+=this._diffValue/180*Math.PI*n;break;case ov.translationX:this.animationObject.position.x+=this._diffValue*n,this.animationObject.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));break;case ov.translationY:this.animationObject.position.y+=this._diffValue*n,this.animationObject.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));break;case ov.translationZ:this.animationObject.position.z+=this._diffValue*n,this.animationObject.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}));break;case ov.scaleX:this.animationObject.scale.x+=this._diffValue*n;break;case ov.scaleY:this.animationObject.scale.y+=this._diffValue*n;break;case ov.scaleZ:this.animationObject.scale.z+=this._diffValue*n;break;case ov.opacity:"nodes"===l?t.traverse((e=>{"Mesh"==e.type&&(e.material instanceof Array?e.material.forEach((e=>{this._diffValue=(r-e.opacity)/i,e.transparent=!0,e.opacity+=this._diffValue*n,e.opacity=this._checkOpacity(e.opacity),s&&(e.opacity=s(e.opacity))})):(this._diffValue=(r-e.material.opacity)/i,e.material.transparent=!0,e.material.opacity+=this._diffValue*n,e.material.opacity=this._checkOpacity(e.material.opacity),s&&(e.material.opacity=s(e.material.opacity))))})):"particles"===l&&t.particleGroup.forEach((e=>{e.opacity+=this._diffValue*n,e.opacity=this._checkOpacity(e.opacity),s&&(e.opacity=s(e.opacity))}));break;case ov.quantityFactor:"particles"===l&&t.particleGroup.forEach((e=>{e.density+=this._diffValue*n,e.density=this._checkOpacity(e.density),s&&(e.density=s(e.density))}));break;case ov.colorOverlay:"nodes"===l&&t.traverse((e=>{if("Mesh"==e.type){let t;e.material instanceof Array?e.material.forEach((e=>{r.alpha>0?(e.transparent=!0,this._diffValue=new lv((e.color.r-r.color.r)/i,(e.color.g-r.color.g)/i,(e.color.b-r.color.b)/i,(e.opacity-r.alpha)/i),t=new lv(e.color.r+this._diffValue.color.r*n,e.color.g+this._diffValue.color.g*n,e.color.b+this._diffValue.color.b*n,e.opacity+this._diffValue.alpha*n),s&&(e.color=s(t.color)),e.opacity=this._checkOpacity(t.alpha)):(e.opacity=1,e.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color)})):r.alpha>0?(e.material.transparent=!0,this._diffValue=new lv((e.material.color.r-r.color.r)/i,(e.material.color.g-r.color.g)/i,(e.material.color.b-r.color.b)/i,(e.material.opacity-r.alpha)/i),t=new lv(e.material.color.r+this._diffValue.color.r*n,e.material.color.g+this._diffValue.color.g*n,e.material.color.b+this._diffValue.color.b*n,e.material.opacity+this._diffValue.alpha*n),s&&(e.material.color=s(t.color)),e.material.opacity=this._checkOpacity(t.alpha)):(e.material.opacity=1,e.material.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color)}}));break;case ov.colorReplace:"nodes"===l&&t.traverse((e=>{if("Mesh"==e.type){let t;e.material instanceof Array?e.material.forEach((e=>{r.alpha>0?(e.map=null,e.transparent=!0,this._diffValue=new lv((e.color.r-r.color.r)/i,(e.color.g-r.color.g)/i,(e.color.b-r.color.b)/i,(e.opacity-r.alpha)/i),t=new lv(e.color.r+this._diffValue.color.r*n,e.color.g+this._diffValue.color.g*n,e.color.b+this._diffValue.color.b*n,e.opacity+this._diffValue.alpha*n),s&&(e.color=s(t.color)),e.opacity=this._checkOpacity(t.alpha)):(e.opacity=1,e.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color,e.map=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.map,e.needsUpdate=!0)})):r.alpha>0?(e.material.map=null,e.material.transparent=!0,this._diffValue=new lv((e.material.color.r-r.color.r)/i,(e.material.color.g-r.color.g)/i,(e.material.color.b-r.color.b)/i,(e.material.opacity-r.alpha)/i),t=new lv(e.material.color.r+this._diffValue.color.r*n,e.material.color.g+this._diffValue.color.g*n,e.material.color.b+this._diffValue.color.b*n,e.material.opacity+this._diffValue.alpha*n),s&&(e.material.color=s(t.color)),e.material.opacity=this._checkOpacity(t.alpha)):(e.material.opacity=1,e.material.color=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.color,e.material.map=o&&o(e.name,this.animationType)&&o(e.name,this.animationType).articulationVal.map,e.material.needsUpdate=!0)}}));break;case ov.stroke:"nodes"===l&&(this._diffValue=new lv((r.color.r-a.color.r)/i,(r.color.g-a.color.g)/i,(r.color.b-a.color.b)/i,(r.alpha-a.alpha)/i),a.color.r+=this._diffValue.color.r*n,a.color.g+=this._diffValue.color.g*n,a.color.b+=this._diffValue.color.b*n,a.alpha+=this._diffValue.alpha*n,a.alpha=this._checkOpacity(a.alpha),Ep.effectStore.initOutlinePass(t,!1,new lv(a.color.r,a.color.g,a.color.b,a.alpha)));break;case ov.USpeed:if("materials"===l){let e=Ep.animationStore.findMaterialAnimation(this.animationObject._material(),nv.type);if(e)e.uSpeed+=this._diffValue*n,e.enableU=0!==e.uSpeed;else{let t=new nv(this.animationObject._material(),this._diffValue*n!=0,!1,this._diffValue*n,0);e=t,Ep.animationStore.add(t)}0===e.uSpeed&&0===e.vSpeed&&e.reset()}break;case ov.VSpeed:if("materials"===l){let e=Ep.animationStore.findMaterialAnimation(this.animationObject._material(),nv.type);if(e)e.vSpeed+=this._diffValue*n,e.enableV=0!==e.vSpeed;else{let t=new nv(this.animationObject._material(),!1,this._diffValue*n!=0,0,this._diffValue*n);e=t,Ep.animationStore.add(t)}0===e.uSpeed&&0===e.vSpeed&&e.reset()}break;case ov.materialsReplace:break;case ov.visible:this.animationObject.visible=a}}},this.dispose=()=>{this.animationObject=null}}}q_.type="ArticulationAnimationController";class J_{constructor({type:e="numeric",name:t="",values:i=[],defaultValue:n}={}){let a=e,r=t,s=i,o=n,l=!1;this.properties=[],this.value=n,this.remark,this.isEnable=!0,this.openThreshold=!1;let c=[],h=[];function u(e,t,i,n){if("string"==typeof e)if("string"==typeof t&&""!==t)if(i instanceof Array&&!(i.length<1)){switch(e){case uy:if(2!==i.length)return void logger.warn(`关节参数错误（values）：${i}，numeric 类型的关节 values 参数应为 2 个数字组成的数组。`);if("number"!=typeof i[0]||"number"!=typeof i[1])return void logger.warn(`关节参数错误（values）：${i}，numeric 类型的关节 values 参数应为 2 个数字组成的数组。`);if(i[0]>i[1])return void logger.warn(`关节参数错误（values）：${i}，numeric 类型的关节 values[0] 应小于等于 values[1]。`);if("number"!=typeof n)return void logger.warn(`关节参数错误（values）：${i}，numeric 类型的关节 defaultValue 值应为数值。`);if(n<i[0]||n>i[1])return void logger.warn(`关节参数错误（defaultValue）：${n}，numeric 类型的关节 defaultValue 值应在 values[0] 和 values[1] 之间。`);break;case dy:let t=!1;for(let e of i){if("string"!=typeof e&&"number"!=typeof e)return void logger.warn(`关节参数错误（values）：${i}，enum 类型的关节 values 参数应为字符串或数值组成的数组。`);n===e&&(t=!0)}if(!t)return void logger.warn(`关节参数错误（defaultValue）：${n}，enum 类型的关节 defaultValue 应该为 values 参数中定义过的枚举值之一。`);break;case py:if(i=[!1,!0],"boolean"!=typeof n)return void logger.warn(`关节参数错误（defaultValue）：${n}，boolean 类型的关节 defaultValue 应该为 true 或 false 之一。`);break;case my:break;default:return void logger.warn(`关节参数错误（type）：${e}，不支持的类型`)}l=!0}else logger.warn(`关节参数错误（values）：${i}。`);else logger.warn(`关节参数错误（name）：${t}。`);else logger.warn(`关节参数错误（type）：${e}。`)}this._recordDefaultVal=(e,t,i,n="nodes")=>{h.find((i=>i.articulationName===e&&i.articulationProperty===t))||h.push({articulationName:e,articulationProperty:t,articulationVal:i,articulationType:n})},this._delDefaultVal=(e,t)=>{let i=h.findIndex((i=>i.articulationName===e&&i.articulationProperty===t));i>-1&&h.splice(i,1)},u(e,t,i,n),this.update=({type:e,name:t,values:i,defaultValue:n}={})=>{"string"!=typeof e||e===a?u(e,t=t||r,i=i||s,n=null==n?o:n):logger.warn(`关节参数错误（type）：${e}，不支持修改关节的类型。`)},this.addProperty=({nodes:e,modifiers:t,materials:i,particles:n})=>{let a=new Z_({nodes:e,modifiers:t,materials:i,particles:n});this.properties.push(a)},this.removePropertyByIndex=e=>{this.properties.splice(e,1)},this.getSettings=()=>({openThreshold:this.openThreshold,type:a,_type:a,name:r,_name:r,values:s?s.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)):void 0,_values:s?s.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)):void 0,defaultValue:this.value instanceof Object?JSON.parse(JSON.stringify(this.value)):this.value,_defaultValue:this.value instanceof Object?JSON.parse(JSON.stringify(this.value)):this.value,isValid:l,_isValid:l,value:this.value instanceof Object?JSON.parse(JSON.stringify(this.value)):this.value,isEnable:this.isEnable,textArticulations:c?JSON.parse(JSON.stringify(c)):void 0,_textArticulations:c?JSON.parse(JSON.stringify(c)):void 0,_properties:this.properties?this.properties.map((e=>({nodes:e.nodes.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)),materials:e.materials.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)),particles:e.particles.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)),modifiers:e.modifiers.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e))}))):void 0,properties:this.properties?this.properties.map((e=>({nodes:e.nodes.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)),materials:e.materials.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)),particles:e.particles.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e)),modifiers:e.modifiers.map((e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e))}))):void 0,remark:this.remark}),this.getName=()=>r,this.setName=e=>{e&&""!==e&&(r=e)},this.getType=()=>a,this.setType=e=>{a=e},this.getModifierTypes=()=>({translationX:"translateX",translationY:"translateY",translationZ:"translateZ",rotationX:"rotateX",rotationY:"rotateY",rotationZ:"rotateZ",scaleX:"scaleX",scaleY:"scaleY",scaleZ:"scaleZ",opacity:"opacity",colorOverlay:"colorOverlay",colorReplace:"colorReplace",stroke:"stroke"}),this._getMaterialData=(e,t,i)=>{let n=e.map((e=>new Promise((t=>{e&&e.path?Ep.instance.preloadResource(e.path,"avwa",(()=>{t()}),void 0):t()}))));Promise.all(n).then((e=>i()))},this._interpolateAbsoluteNumeric=(t,i)=>{if((s[1]===s[0]||t[1]===t[0])&&dy!==e)return Number(t[0]);switch(e){case uy:let e=Number(t[0]),a=Number(t[1]);if(this.openThreshold)return Number(i-s[0])/Number(s[1]-s[0])*Number(a-e)+e;{let n=Math.max(...s),r=Math.min(...s);return i>=n?Number(t[s.indexOf(n)]):i<=r?Number(t[s.indexOf(r)]):Number(i-s[0])/Number(s[1]-s[0])*Number(a-e)+e}case dy:case py:let r=s.findIndex((e=>e===i));return r<0?o:Number(t[r]);default:return Number(n)}},this._interpolateRelativeNumeric=(t,i,n)=>{if(t==ov.rotationX||t==ov.rotationY||t==ov.rotationZ){if((s[1]===s[0]||i[1]===i[0])&&e!==dy)return Number(i[0]);switch(e){case uy:let e=Number(i[0]),t=Number(i[1]);if(this.openThreshold)return Number(n-s[0])/Number(s[1]-s[0])*Number(t-e)+e;{let a=Math.max(...s),r=Math.min(...s);return n>=a?Number(i[s.indexOf(a)]):n<=r?Number(i[s.indexOf(r)]):Number(n-s[0])/Number(s[1]-s[0])*Number(t-e)+e}case dy:case py:let a=s.findIndex((e=>e===n));return Number(a<0?o:i[a])}}else if(t==ov.opacity){if((s[1]===s[0]||i[1]===i[0])&&e!==dy)return.01*Number(i[0]);let t=Number(i[0]),r=Number(i[1]),l=0;switch(e){case uy:l=Number(n-s[0])/Number(s[1]-s[0])*Number(r-t)+t,l*=.01;break;case dy:r=Number(i[i.length-1]),l=(a=s.findIndex((e=>e===n)))<0?.01*Number(o):.01*Number(i[a]);break;case py:var a;l=(a=s.findIndex((e=>e===n)))<0?.01*Number(o):.01*Number(i[a])}return l<=0?0:l>=1?1:l}},this._interpolateColor=(t,n)=>{if(i[1]===i[0]&&e!==dy)return new lv(t[0]);switch(e){case uy:let e=Number(n-i[0])/Number(i[1]-i[0]),a=new lv(t[0]),r=new lv(t[1]);return a.lerp(r,e);case dy:case py:let o=s.findIndex((e=>e===n));return o<0?new lv(255,255,255,0):new lv(t[o])}},this._checkColor=e=>(e.r<0&&(e.r=0),e.r>1&&(e.r=1),e.g<0&&(e.g=0),e.g>1&&(e.g=1),e.b<0&&(e.b=0),e.b>1&&(e.b=1),e),this._checkOpacity=e=>(e<0&&(e=0),e>1&&(e=1),e),this.getNode=(e,t)=>{let i;return e.children.forEach((e=>{e.getObjectByName(t)&&(i=e.getObjectByName(t))})),i},this.getNodes=(e,t)=>{let i=[];for(let n of t.nodes)e.children.forEach((e=>{e.getObjectByName(n)&&i.push(e.getObjectByName(n))}));return i},this.set=(e,t,i)=>{if(!this.isValid()||"function"!=typeof this.getModelNode||null==Ep||null==Ep.animationStore)return void logger.warn("正在设置的关节无效。");this.value=o=e;let n=this.getModelNode();const r=new Map;if(a!=my)for(let i of this.properties){let a=this.getNodes(n,i);if(a.length){Ep.effectStore&&Ep.effectStore.initOutlinePass();for(let o of i.modifiers)for(let i of a){let a,l=Ep&&Ep.animationStore&&Ep.animationStore.findAnimation&&Ep.animationStore.findAnimation(n.name+i.name+o.key,q_.type);switch(l&&Ep.animationStore.remove(l),o.key){case ov.rotationX:this._recordDefaultVal(i.name,o.key,i.rotation.x),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.rotation.x/Math.PI*180,this._interpolateRelativeNumeric(ov.rotationX,o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.rotation.set(this._interpolateRelativeNumeric(ov.rotationX,o.values,e)/180*Math.PI,i.rotation.y,i.rotation.z);break;case ov.rotationY:this._recordDefaultVal(i.name,o.key,i.rotation.y),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.rotation.y/Math.PI*180,this._interpolateRelativeNumeric(ov.rotationY,o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.rotation.set(i.rotation.x,this._interpolateRelativeNumeric(ov.rotationY,o.values,e)/180*Math.PI,i.rotation.z);break;case ov.rotationZ:this._recordDefaultVal(i.name,o.key,i.rotation.z),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.rotation.z/Math.PI*180,this._interpolateRelativeNumeric(ov.rotationZ,o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.rotation.set(i.rotation.x,i.rotation.y,this._interpolateRelativeNumeric(ov.rotationZ,o.values,e)/180*Math.PI);break;case ov.translationX:this._recordDefaultVal(i.name,o.key,i.position.x),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.position.x,this._interpolateAbsoluteNumeric(o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.position.set(this._interpolateAbsoluteNumeric(o.values,e),i.position.y,i.position.z);break;case ov.translationY:this._recordDefaultVal(i.name,o.key,i.position.y),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.position.y,this._interpolateAbsoluteNumeric(o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.position.set(i.position.x,this._interpolateAbsoluteNumeric(o.values,e),i.position.z);break;case ov.translationZ:this._recordDefaultVal(i.name,o.key,i.position.z),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.position.z,this._interpolateAbsoluteNumeric(o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.position.set(i.position.x,i.position.y,this._interpolateAbsoluteNumeric(o.values,e));break;case ov.scaleX:this._recordDefaultVal(i.name,o.key,i.scale.x),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.scale.x,this._interpolateAbsoluteNumeric(o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.scale.set(this._interpolateAbsoluteNumeric(o.values,e),i.scale.y,i.scale.z);break;case ov.scaleY:this._recordDefaultVal(i.name,o.key,i.scale.y),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.scale.y,this._interpolateAbsoluteNumeric(o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.scale.set(i.scale.x,this._interpolateAbsoluteNumeric(o.values,e),i.scale.z);break;case ov.scaleZ:this._recordDefaultVal(i.name,o.key,i.scale.z),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal,t&&t>0?(a=new q_(n.name,i,t,o.key,i.scale.z,this._interpolateAbsoluteNumeric(o.values,e),void 0,void 0,void 0,(()=>s(a))),r.set(a,!0)):i.scale.set(i.scale.x,i.scale.y,this._interpolateAbsoluteNumeric(o.values,e));break;case ov.opacity:t&&t>0?(a=new q_(n.name,i,t,o.key,o.values[0],this._interpolateRelativeNumeric(ov.opacity,o.values,e),this._checkOpacity,void 0,void 0,(()=>s(a))),r.set(a,!0)):(i.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((t=>{let i=t.opacity,n=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.opacity));n&&(i=n.articulationVal);let a=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.colorOverlay));a&&(i=a.articulationVal.opacity);let r=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.colorReplace));r&&(i=r.articulationVal.opacity),this._recordDefaultVal(e.name+":"+t.name,o.key,i)}));else{let t=e.material.opacity,n=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.opacity));n&&(t=n.articulationVal);let a=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorOverlay));a&&(t=a.articulationVal.opacity);let r=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorReplace));r&&(t=r.articulationVal.opacity),this._recordDefaultVal(i.name+":"+e.name,o.key,t)}})),i.traverse((t=>{"Mesh"==t.type&&(t.material instanceof Array?t.material.forEach((t=>{t.transparent=!0,t.opacity=this._interpolateRelativeNumeric(ov.opacity,o.values,e)})):(t.material.transparent=!0,t.material.opacity=this._interpolateRelativeNumeric(ov.opacity,o.values,e)))})));break;case ov.colorOverlay:let l=this._interpolateColor(o.values,e);t&&t>0?(a=new q_(n.name,i,t,o.key,new lv(o.values[0]),l,this._checkColor,this.getDefaultVal,void 0,(()=>s(a))),r.set(a,!0)):(i.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((t=>{let i=t.opacity,n=new Qt(t.color),a=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.colorOverlay));a&&(n=new Qt(a.articulationVal.color),i=a.articulationVal.opacity);let r=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.opacity));r&&(i=r);let s=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.colorReplace));s&&(n=new Qt(s.articulationVal.color),i=s.articulationVal.opacity),this._recordDefaultVal(e.name+":"+t.name,o.key,{color:n,opacity:i})}));else{let t=e.material.opacity,n=new Qt(e.material.color),a=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorOverlay));a&&(n=new Qt(a.articulationVal.color),t=a.articulationVal.opacity);let r=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.opacity));r&&(t=r);let s=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorReplace));s&&(n=new Qt(s.articulationVal.color),t=s.articulationVal.opacity),this._recordDefaultVal(i.name+":"+e.name,o.key,{color:n,opacity:t})}})),i.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((e=>{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorReplace));t||(e.transparent=!0,e.color=l.color,e.opacity=l.alpha,t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorOverlay)),e.opacity<=0&&(e.opacity=1,e.color=t&&new Qt(t.articulationVal.color)))}));else{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorReplace));t||(e.material.transparent=!0,e.material.color=l.color,e.material.opacity=l.alpha,t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorOverlay)),e.material.opacity<=0&&(e.material.opacity=1,e.material.color=t&&new Qt(t.articulationVal.color)))}})));break;case ov.colorReplace:let c=this._interpolateColor(o.values,e);if(t&&t>0)a=new q_(n.name,i,t,o.key,new lv(o.values[0]),c,this._checkColor,this.getDefaultVal,void 0,(()=>s(a))),r.set(a,!0);else{let e=[];i.traverse((t=>{if("Mesh"==t.type)if(t.material instanceof Array)t.material.forEach((i=>{let n=i.opacity,a=new Qt(i.color),r=h.find((e=>e.articulationName.indexOf(i.name)>-1&&e.articulationProperty===ov.colorReplace));r&&(n=r.articulationVal.opacity,a=new Qt(r.articulationVal.color));let s=h.find((e=>e.articulationName.indexOf(i.name)>-1&&e.articulationProperty===ov.opacity));s&&(n=s);let l=h.find((e=>e.articulationName.indexOf(i.name)>-1&&e.articulationProperty===ov.colorOverlay));l&&(n=l.articulationVal.opacity,a=new Qt(l.articulationVal.color)),this._recordDefaultVal(t.name+":"+i.name,o.key,{map:i.map,color:a,opacity:n}),e.push(i)}));else{let n=t.material.opacity,a=new Qt(t.material.color),r=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.colorReplace));r&&(n=r.articulationVal.opacity,a=new Qt(r.articulationVal.color));let s=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.opacity));s&&(n=s);let l=h.find((e=>e.articulationName.indexOf(t.name)>-1&&e.articulationProperty===ov.colorOverlay));l&&(n=l.articulationVal.opacity,a=new Qt(l.articulationVal.color)),this._recordDefaultVal(i.name+":"+t.name,o.key,{map:t.material.map,color:a,opacity:n}),e.push(t.material)}})),e.forEach((e=>{e.map=null,e.transparent=!0,e.needsUpdate=!0})),i.traverse((e=>{if("Mesh"==e.type)if(e.material instanceof Array)e.material.forEach((e=>{if(c.alpha>0)e.transparent=!0,e.map=null,e.color=c.color,e.opacity=c.alpha;else{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorReplace));t&&(e.opacity=1,e.map=t.articulationVal.map,e.color=new Qt(t.articulationVal.color),e.needsUpdate=!0)}}));else if(c.alpha>0)e.material.transparent=!0,e.material.map=null,e.material.color=c.color,e.material.opacity=c.alpha;else{let t=h.find((t=>t.articulationName.indexOf(e.name)>-1&&t.articulationProperty===ov.colorReplace));t&&(e.material.opacity=1,e.material.map=t.articulationVal.map,e.material.color=new Qt(t.articulationVal.color),e.material.needsUpdate=!0)}}))}break;case ov.stroke:if(t&&t>0){let l,c=h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key));c?(l=c.articulationVal,this._delDefaultVal(i.name,o.key),this._recordDefaultVal(i.name,o.key,this._interpolateColor(o.values,e))):(this._recordDefaultVal(i.name,o.key,this._interpolateColor(o.values,e)),l=new lv(o.values[0])),a=new q_(n.name,i,t,o.key,l,this._interpolateColor(o.values,e),this._checkColor,void 0,void 0,(()=>s(a))),r.set(a,!0)}else Ep.effectStore&&Ep.effectStore.initOutlinePass(i,!0,this._interpolateColor(o.values,e));break;case ov.visible:this._recordDefaultVal(i.name,o.key,i.visible),h.find((e=>e.articulationName===i.name&&e.articulationProperty===o.key)).articulationVal;let u=this._values.findIndex((t=>t===e));if(t&&t>0)a=new q_(n.name,i,t,o.key,i.visible,o.values[u],void 0,void 0,void 0,(()=>s(a))),r.set(a,!0);else{let t=this._values.findIndex((t=>t===e));i.visible=o.values[t]}}a&&Ep.animationStore.add(a)}}else logger.warn("正在设置的关节无效，无法找到指定的节点。");let o=[];for(let e of i.materials){let t=this.getModelItem().findMaterial(e);t&&o.push(t)}if(o.length)for(let a of i.modifiers)for(let i of o){let o,l=Ep&&Ep.animationStore&&Ep.animationStore.findAnimation&&Ep.animationStore.findAnimation(n.name+i.name+a.key,q_.type);switch(l&&Ep.animationStore.remove(l),a.key){case ov.USpeed:if(t&&t>0)o=new q_(n.name,i,t,a.key,i.translationSpeedU,this._interpolateAbsoluteNumeric(a.values,e),(()=>{}),(()=>{}),"materials",(()=>s(o))),r.set(o,!0);else{let t=Ep.animationStore.findMaterialAnimation(i._material(),nv.type);if(t)t.enableU=0!==this._interpolateAbsoluteNumeric(a.values,e),t.uSpeed=this._interpolateAbsoluteNumeric(a.values,e);else{let n=new nv(i._material(),0!==this._interpolateAbsoluteNumeric(a.values,e),!1,this._interpolateAbsoluteNumeric(a.values,e),0);t=n,Ep.animationStore.add(n)}0===t.uSpeed&&0===t.vSpeed&&Ep.animationStore.remove(t)}break;case ov.VSpeed:if(t&&t>0)o=new q_(n.name,i,t,a.key,i.translationSpeedV,this._interpolateAbsoluteNumeric(a.values,e),(()=>{}),(()=>{}),"materials",(()=>s(o))),r.set(o,!0);else{let t=Ep.animationStore.findMaterialAnimation(i._material(),nv.type);if(t)t.enableV=0!==this._interpolateAbsoluteNumeric(a.values,e),t.vSpeed=this._interpolateAbsoluteNumeric(a.values,e);else{let n=new nv(i._material(),!1,0!==this._interpolateAbsoluteNumeric(a.values,e),0,this._interpolateAbsoluteNumeric(a.values,e));t=n,Ep.animationStore.add(n)}0===t.uSpeed&&0===t.vSpeed&&Ep.animationStore.remove(t)}break;case ov.materialsReplace:if(t&&t>0)this._getMaterialData(a.values,i,(()=>{const n=this._values.findIndex((e=>e===this._defaultValue)),r=this._values.findIndex((t=>t===e));o=new q_(this.getModelNode().uuid,i,t,a.key,a.values[n],a.values[r],(()=>{}),(()=>{}),"materials",(()=>s(o))),Ep.animationStore.add(o)})),r.set(o,!0);else{let t=this._values.findIndex((t=>t===e));a.values.forEach(((e,n)=>{t===n?e&&e.path?Ep.instance.materialReplace({path:e.path,material:i,onLoad:()=>{},onProgress:()=>{},newImport:!0}):i.restore(this.getModelNode().uuid):e.path&&Ep.instance.preloadResource(e.path,"avwa",void 0,void 0,{needExport:!0,newImport:!0})}))}}o&&Ep.animationStore.add(o)}let l=[];for(let e of i.particles){let t=this.getModelItem().particleStoreArray.find((t=>t.name===e));t&&l.push(t)}if(l.length)for(let a of i.modifiers)for(let i of l){let o,l=Ep&&Ep.animationStore&&Ep.animationStore.findAnimation&&Ep.animationStore.findAnimation(n.name+i.particleModelGroup.name+a.key,q_.type);switch(l&&Ep.animationStore.remove(l),a.key){case ov.rotationX:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.rotation.x,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.rotation.x/Math.PI*180,this._interpolateRelativeNumeric(ov.rotationX,a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.rotation.set(this._interpolateRelativeNumeric(ov.rotationX,a.values,e)/180*Math.PI,i.particleModelGroup.rotation.y,i.particleModelGroup.rotation.z);break;case ov.rotationY:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.rotation.y,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.rotation.y/Math.PI*180,this._interpolateRelativeNumeric(ov.rotationY,a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.rotation.set(i.particleModelGroup.rotation.x,this._interpolateRelativeNumeric(ov.rotationY,a.values,e)/180*Math.PI,i.particleModelGroup.rotation.z);break;case ov.rotationZ:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.rotation.z,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.rotation.z/Math.PI*180,this._interpolateRelativeNumeric(ov.rotationZ,a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.rotation.set(i.particleModelGroup.rotation.x,i.particleModelGroup.rotation.y,this._interpolateRelativeNumeric(ov.rotationZ,a.values,e)/180*Math.PI);break;case ov.translationX:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.position.x,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.position.x,this._interpolateAbsoluteNumeric(a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.position.set(this._interpolateAbsoluteNumeric(a.values,e),i.particleModelGroup.position.y,i.particleModelGroup.position.z);break;case ov.translationY:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.position.y,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.position.y,this._interpolateAbsoluteNumeric(a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.position.set(i.particleModelGroup.position.x,this._interpolateAbsoluteNumeric(a.values,e),i.particleModelGroup.position.z);break;case ov.translationZ:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.position.z,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.position.z,this._interpolateAbsoluteNumeric(a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.position.set(i.particleModelGroup.position.x,i.particleModelGroup.position.y,this._interpolateAbsoluteNumeric(a.values,e));break;case ov.scaleX:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.scale.x,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.scale.x,this._interpolateAbsoluteNumeric(a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.scale.set(this._interpolateAbsoluteNumeric(a.values,e),i.particleModelGroup.scale.y,i.particleModelGroup.scale.z);break;case ov.scaleY:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.scale.y,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.scale.y,this._interpolateAbsoluteNumeric(a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.scale.set(i.particleModelGroup.scale.x,this._interpolateAbsoluteNumeric(a.values,e),i.particleModelGroup.scale.z);break;case ov.scaleZ:this._recordDefaultVal(i.particleModelGroup.name,a.key,i.particleModelGroup.scale.z,"particles"),h.find((e=>e.articulationName===i.particleModelGroup.name&&e.articulationProperty===a.key)).articulationVal,t&&t>0?(o=new q_(n.name,i.particleModelGroup,t,a.key,i.particleModelGroup.scale.z,this._interpolateAbsoluteNumeric(a.values,e),void 0,void 0,void 0,(()=>s(o))),r.set(o,!0)):i.particleModelGroup.scale.set(i.particleModelGroup.scale.x,i.particleModelGroup.scale.y,this._interpolateAbsoluteNumeric(a.values,e));break;case ov.opacity:t&&t>0?(o=new q_(n.name,i,t,a.key,a.values[0],this._interpolateRelativeNumeric(ov.opacity,a.values,e),this._checkOpacity,(()=>{}),"particles",(()=>s(o))),r.set(o,!0)):i.particleGroup.forEach((t=>{this._recordDefaultVal(i.particleModelGroup.name+":"+t.id,a.key,t.opacity,"particles"),t.opacity=this._interpolateRelativeNumeric(ov.opacity,a.values,e)}));break;case ov.quantityFactor:t&&t>0?(o=new q_(n.name,i,t,a.key,a.values[0],this._interpolateRelativeNumeric(ov.opacity,a.values,e),(e=>e),(()=>{}),"particles",(()=>s(o))),r.set(o,!0)):i.particleGroup.forEach((t=>{this._recordDefaultVal(i.particleModelGroup.name+":"+t.id,a.key,t.density,"particles"),t.density=this._interpolateRelativeNumeric(ov.opacity,a.values,e)}))}o&&Ep.animationStore.add(o)}}t<=0&&s();const s=e=>{void 0!==e&&r.set(e,!1);let t=!0;r.forEach((e=>{!0===e&&(t=!1)})),t&&i&&i()}},this.nodesReset=(e,t)=>{if(h.length<=0)return;let i=this.getModelNode();if(a!=my)for(let n of e){let e=this.getNode(i,n);e&&t&&t.forEach((t=>{let i;switch(t){case ov.rotationX:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.rotation.x=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.rotationY:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.rotation.y=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.rotationZ:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.rotation.z=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.translationX:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.position.x=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.translationY:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.position.y=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.translationZ:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.position.z=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.scaleX:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.scale.x=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.scaleY:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.scale.y=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.scaleZ:i=h.find((i=>i.articulationName===e.name&&i.articulationProperty===t)),i&&(e.scale.z=i.articulationVal,this._delDefaultVal(e.name,t));break;case ov.opacity:e.traverse((n=>{"Mesh"==n.type&&(n.material instanceof Array?n.material.forEach((e=>{i=h.find((i=>i.articulationName===n.name+":"+e.name&&i.articulationProperty===t)),i&&(e.opacity=i.articulationVal,this._delDefaultVal(n.name+":"+e.name,t))})):(i=h.find((i=>i.articulationName===e.name+":"+n.name&&i.articulationProperty===t)),i&&(n.material.opacity=i.articulationVal,this._delDefaultVal(e.name+":"+n.name,t))))}));break;case ov.colorOverlay:e.traverse((n=>{"Mesh"==n.type&&(n.material instanceof Array?n.material.forEach((e=>{i=h.find((i=>i.articulationName.indexOf(e.name)>-1&&i.articulationProperty===t)),i&&(e.color=i.articulationVal.color,e.opacity=i.articulationVal.opacity,this._delDefaultVal(n.name+":"+e.name,t))})):(i=h.find((e=>e.articulationName.indexOf(n.name)>-1&&e.articulationProperty===t)),i&&(n.material.color=i.articulationVal.color,n.material.opacity=i.articulationVal.opacity,this._delDefaultVal(e.name+":"+n.name,t))))}));break;case ov.colorReplace:e.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((e=>{if(i=h.find((i=>i.articulationName.indexOf(e.name)>-1&&i.articulationProperty===t)),i){let a=i.articulationVal;e.map=a.map,e.color=new Qt(a.color),e.opacity=a.opacity,e.needsUpdate=!0,this._delDefaultVal(n.name+":"+e.name,t)}}));else if(i=h.find((e=>e.articulationName.indexOf(n.name)>-1&&e.articulationProperty===t)),i){let a=i.articulationVal;n.material.map=a.map,n.material.color=new Qt(a.color),n.material.opacity=a.opacity,n.material.needsUpdate=!0,this._delDefaultVal(e.name+":"+n.name,t)}}));break;case ov.stroke:Ep.effectStore.initOutlinePass()}}))}else c.forEach((t=>{t.traverse((t=>{if(e.inclues(t.name)){let e=i.getObjectByName(t.parent.name),n=e.children.findIndex((e=>e.name==t.name));e.children.splice(n,1),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose()}}))}))},this.particlesReset=(e,t)=>{if(!(h.length<=0)&&a!=my)for(let i of e){let e=this.getModelItem().particleStoreArray.find((e=>e.name===i));e&&t&&t.forEach((t=>{let i;switch(t){case ov.rotationX:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.rotation.x=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.rotationY:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.rotation.y=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.rotationZ:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.rotation.z=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.translationX:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.position.x=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.translationY:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.position.y=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.translationZ:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.position.z=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.scaleX:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.scale.x=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.scaleY:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.scale.y=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.scaleZ:i=h.find((i=>i.articulationName===e.particleModelGroup.name&&i.articulationProperty===t)),i&&(e.particleModelGroup.scale.z=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name,t));break;case ov.opacity:e.particleGroup.forEach((n=>{i=h.find((i=>i.articulationName===e.particleModelGroup.name+":"+n.id&&i.articulationProperty===t)),n.opacity=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name+":"+n.id,t)}));break;case ov.quantityFactor:e.particleGroup.forEach((n=>{i=h.find((i=>i.articulationName===e.particleModelGroup.name+":"+n.id&&i.articulationProperty===t)),n.density=i.articulationVal,this._delDefaultVal(e.particleModelGroup.name+":"+n.id,t)}))}}))}},this.materialsReset=(e,t)=>{if(a!=my)for(let i of e){let e=this.getModelItem().findMaterial(i);e&&t&&t.forEach((t=>{switch(t){case ov.USpeed:(i=Ep.animationStore.findMaterialAnimation(e._material(),nv.type))&&(i.enableU=0!==e.translationSpeedU&&e.enableTranslation,i.uSpeed=e.enableTranslation?e.translationSpeedU:0,0===i.uSpeed&&0===i.vSpeed&&Ep.animationStore.remove(i));break;case ov.VSpeed:var i;(i=Ep.animationStore.findMaterialAnimation(e._material(),nv.type))&&(i.enableV=0!==e.translationSpeedV&&e.enableTranslation,i.vSpeed=e.enableTranslation?e.translationSpeedV:0,0===i.uSpeed&&0===i.vSpeed&&Ep.animationStore.remove(i))}}))}},this.addOrUpdateTextArticulation=()=>{let e=this.getModelNode();c.forEach((t=>{t.traverse((t=>{let i=e.getObjectByName(t.parent.name),n=i.children.findIndex((e=>e.name==t.name));i.children.splice(n,1),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose()}))})),c=[],this.properties.forEach(((t,i)=>{t.nodes.forEach(((n,a)=>{let o=e.getObjectByName(n);if(o){let e=o.name+r+i+a,n=o.children.findIndex((t=>t.name==e));n>-1&&(o.children[n].material.dispose(),o.children[n].geometry.dispose(),o.children.splice(n,1));let l=function({labelFontFamily:e="微软雅黑",labelFontSize:t=3,labelFontBold:i=!1,labelEnableItalic:n=!1,labelBackground:a="rgb(0,0,0)",labelColor:r="rgb(1,1,1)",labelText:s="标题文字"}){let o=document.createElement("canvas"),l=o.getContext("2d"),c=t,h="";i&&(h="bold");let u="";return n&&(u="italic"),l.font=`${u} ${h} ${c}px ${e}`,l.textAlign="center",l.textBaseline="middle",o.width=1.8*(l.measureText(s).width+c),o.height=3.2*c,l.fillStyle=a,l.fillRect(0,0,o.width,o.height),l.font=`${u} ${h} ${2*c}px ${e}`,l.fillStyle=r,l.textAlign="center",l.textBaseline="middle",l.fillText(s,o.width/2,o.height/2),o}(s[0]),h=new vs(l),u=new vr({map:h,color:16777215,fog:Uy,depthWrite:!0,depthTest:!1,depthFunc:1,sizeAttenuation:!0}),d=new Or(u);d.scale.set(.005*l.width,.005*l.height,1);let p=t.modifiers.find((e=>"x"==e.key)).values[0],m=t.modifiers.find((e=>"y"==e.key)).values[0],f=t.modifiers.find((e=>"z"==e.key)).values[0];d.position.set(p,m,f),d.name=e,d.parent=o,o.children.push(d),c.push(d)}}))}))},this.deleteArticulation=()=>{let e=this.getModelNode();if(a!=my)for(let i of this.properties){let n=this.getNodes(e,i);if(n.length)for(let e of i.modifiers)for(let t of n){let i=0;if(h.find((i=>(i.articulationName.indexOf(t.name)>-1||i.articulationName===t.name)&&i.articulationProperty===e.key)))switch(e.key){case ov.rotationX:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.rotation.set(i,t.rotation.y,t.rotation.z),this._delDefaultVal(t.name,e.key);break;case ov.rotationY:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.rotation.set(t.rotation.x,i,t.rotation.z),this._delDefaultVal(t.name,e.key);break;case ov.rotationZ:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.rotation.set(t.rotation.x,t.rotation.y,i),this._delDefaultVal(t.name,e.key);break;case ov.translationX:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.position.set(i,t.position.y,t.position.z),this._delDefaultVal(t.name,e.key);break;case ov.translationY:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.position.set(t.position.x,i,t.position.z),this._delDefaultVal(t.name,e.key);break;case ov.translationZ:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.position.set(t.position.x,t.position.y,i),this._delDefaultVal(t.name,e.key);break;case ov.scaleX:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.scale.set(i,t.scale.y,t.scale.z),this._delDefaultVal(t.name,e.key);break;case ov.scaleY:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.scale.set(t.scale.x,i,t.scale.z),this._delDefaultVal(t.name,e.key);break;case ov.scaleZ:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.scale.set(t.scale.x,t.scale.y,i),this._delDefaultVal(t.name,e.key);break;case ov.opacity:t.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((t=>{t.transparent=!1;let a=h.find((i=>i.articulationName.indexOf(t.name)>-1&&i.articulationProperty===e.key));a&&(i=a.articulationVal,t.opacity=i,this._delDefaultVal(n.name+":"+t.name,e.key))}));else{let a=h.find((t=>t.articulationName.indexOf(n.name)>-1&&t.articulationProperty===e.key));a&&(i=a.articulationVal,n.material.transparent=!1,n.material.opacity=i,this._delDefaultVal(t.name+":"+n.name,e.key))}}));break;case ov.colorOverlay:t.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((t=>{let a=h.find((i=>i.articulationName===n.name+":"+t.name&&i.articulationProperty===e.key));a&&(i=a.articulationVal,t.color=i.color,t.opacity=i.opacity,this._delDefaultVal(n.name+":"+t.name,e.key))}));else{let a=h.find((i=>i.articulationName===t.name+":"+n.name&&i.articulationProperty===e.key));a&&(i=a.articulationVal,n.material.color=i.color,n.material.opacity=i.opacity,this._delDefaultVal(t.name+":"+n.name,e.key))}}));break;case ov.colorReplace:t.traverse((n=>{if("Mesh"==n.type)if(n.material instanceof Array)n.material.forEach((t=>{let a=h.find((i=>i.articulationName.indexOf(t.name)>-1&&i.articulationProperty===e.key));a&&(i=a.articulationVal,t.map=i.map,t.color=i.color,t.opacity=i.opacity,t.needsUpdate=!0,this._delDefaultVal(n.name+":"+t.name,e.key))}));else{let a=h.find((t=>t.articulationName.indexOf(n.name)>-1&&t.articulationProperty===e.key));a&&(i=a.articulationVal,n.material.map=i.map,n.material.color=i.color,n.material.transparent=i.opacity,n.material.needsUpdate=!0,this._delDefaultVal(t.name+":"+n.name,e.key))}}));break;case ov.stroke:Ep.effectStore.initOutlinePass();break;case ov.visible:i=h.find((i=>i.articulationName===t.name&&i.articulationProperty===e.key)).articulationVal,t.visible=i,this._delDefaultVal(t.name,e.key)}}else logger.warn("正在设置的关节无效，无法找到指定的节点。");let a=[];for(let e of i.materials){let t=this.getModelItem().findMaterial(e);t&&a.push(t)}if(a.length)for(let e of i.modifiers)for(let i of a)switch(e.key){case ov.USpeed:(t=Ep.animationStore.findMaterialAnimation(i._material(),nv.type))&&(t.enableU=0!==i.translationSpeedU&&i.enableTranslation,t.uSpeed=i.enableTranslation?i.translationSpeedU:0,0===t.uSpeed&&0===t.vSpeed&&Ep.animationStore.remove(t));break;case ov.VSpeed:var t;(t=Ep.animationStore.findMaterialAnimation(i._material(),nv.type))&&(t.enableV=0!==i.translationSpeedV&&i.enableTranslation,t.vSpeed=i.enableTranslation?i.translationSpeedV:0,0===t.uSpeed&&0===t.vSpeed&&Ep.animationStore.remove(t));break;case ov.materialsReplace:i.restore(this.getModelNode().uuid)}let r=[];for(let e of i.particles){let t=this.getModelItem().particleStoreArray.find((t=>t.name===e));t&&r.push(t)}if(r.length)for(let e of i.modifiers)for(let t of r){let i=0;switch(e.key){case ov.rotationX:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.rotation.x=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.rotationY:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.rotation.y=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.rotationZ:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.rotation.z=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.translationX:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.position.x=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.translationY:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.position.y=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.translationZ:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.position.z=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.scaleX:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.scale.x=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.scaleY:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.scale.y=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.scaleZ:i=h.find((i=>i.articulationName===t.particleModelGroup.name&&i.articulationProperty===e.key)),i&&(t.particleModelGroup.scale.z=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name,e.key));break;case ov.opacity:t.particleGroup.forEach((n=>{i=h.find((i=>i.articulationName===t.particleModelGroup.name+":"+n.id&&i.articulationProperty===e.key)),n.opacity=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name+":"+n.id,e.key)}));break;case ov.quantityFactor:t.particleGroup.forEach((n=>{i=h.find((i=>i.articulationName===t.particleModelGroup.name+":"+n.id&&i.articulationProperty===e.key)),n.density=i.articulationVal,this._delDefaultVal(t.particleModelGroup.name+":"+n.id,e.key)}))}}}},this.getDefaultVal=(e,t)=>h.find((i=>i.articulationName.indexOf(e)>-1&&i.articulationProperty===t)),this.isValid=()=>l,this.getValues=()=>s,this.setValues=e=>{s=e},this.getDefaultValue=()=>o,this.setDefaultValue=e=>{o=e},this.clone=()=>{const e=new this.constructor({type:a,name:r,values:s,defaultValue:o});e.value=this.value,e.remark=this.remark,e.isEnable=this.isEnable;for(const t of this.properties)e.properties.push(t.clone());return e}}get name(){return this.getName()}set name(e){this.setName(e)}get type(){return this.getType()}set type(e){logger.warn("不支持修改关节的类型。")}toJSON(){return this.getSettings()}}class Q_{constructor({startTime:e,continueTime:t,articulationName:i,startState:n,endState:a,modelId:r}){this.startTime=Number(e),this.continueTime=Number(t),this.articulationName=i,this.startState=n,this.endState=a;let s=r;this.getModelId=()=>s,this.setModelId=e=>{s=e},this.clone=()=>new this.constructor({startTime:this.startTime,continueTime:this.continueTime,articulationName:this.articulationName,startState:this.startState,endState:this.endState,modelId:s})}get modelId(){return this.getModelId()}set modelId(e){this.setModelId(e)}}class K_{constructor(e,t){this.animationName=e,this.animationType=av,this.animationSpeed=1;let i=t;this.isEnable=!1,this.articulationAnimationItems=[];let n=[];this.addAnimationItem=({startTime:e,continueTime:t,articulationName:n,startState:a,endState:r})=>{let s=new Q_({startTime:e,continueTime:t,articulationName:n,startState:a,endState:r,modelId:i});this.articulationAnimationItems.push(s)},this.play=e=>{let t=Ep.animationStore.findAnimation(i+this.animationName,cv.type);t&&(t.reset(),Ep.animationStore.remove(t)),t=new cv(i+this.animationName,this.animationType,this.animationSpeed,this.articulationAnimationItems,e),Ep.animationStore.add(t),this.animationType==av&&n.push(t)},this.pause=()=>{let e=Ep.animationStore.findAnimation(i+this.animationName,cv.type);e&&e.pause()},this.resume=e=>{let t=Ep.animationStore.findAnimation(i+this.animationName,cv.type);t?(t.resume(),e&&e({result:1,message:""})):e&&e({result:0,message:"未播放"})},this.reset=()=>{let e=Ep.animationStore.findAnimation(i+this.animationName,cv.type);if(e&&(e.reset(),Ep.animationStore.remove(e)),this.animationType==av){let e=n.findIndex((e=>e.animationName==i+this.animationName));e>-1&&(n[e].reset(),n.splice(e,1))}},this.delete=()=>{let e=Ep.animationStore.findAnimation(i+this.animationName,cv.type);e&&(e.reset(),Ep.animationStore.remove(e))},this.getParentUUId=()=>i,this.setParentUUId=e=>{i=e},this.getArticulationAnimationTemps=()=>n,this.clone=()=>{const e=new this.constructor(this.animationName,i);e.animationType=this.animationType,e.animationSpeed=this.animationSpeed,e.isEnable=this.isEnable;for(const t of this.articulationAnimationItems)e.articulationAnimationItems.push(t.clone());return e}}get parentUUId(){return this.getParentUUId}set parentUUId(e){this.setParentUUId(e)}}class $_ extends ev{constructor({id:e=_y.guid(),name:t,children:i=[],index:n,isLock:a,isVisible:r,loadModel:s,modelPath:o,modelType:l="glb",parent:c,parentUUID:h,transform:u},d,p,m){super("ModelItem"),this.id=e,this.name=t||this.id,this.modelPath=o,this.modelType=l.toLowerCase(),this.children=i,this.materialStore=new Eb(Ep.textureStore,Ep.instance),this.particleStoreArray=[],this.type="ModelItem",this.index=n,this.parent=c,this.articulations=[],this.articulationAnimations=[],this.parentUUID=h;let f=m||null;var g;if(this.addParticleStore=e=>{const t=new Y_(this);return t.name=e,Ep.animationStore.add(t),this.particleStoreArray.push(t),t},this.copyParticleStore=e=>{let t,i=1;for(let i=0;i<this.particleStoreArray.length;i++)this.particleStoreArray[i].name==e&&(t=this.particleStoreArray[i]);const n=t.clone();for(n.name=`${t.name}_${i}`;this.particleStoreArray.some((e=>e.name===n.name));)i++,n.name=`${t.name}_${i}`;return Ep.animationStore.add(n),this.particleStoreArray.push(n),n},this.removeParticleStore=e=>{const t=function(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)};for(let i=0;i<this.particleStoreArray.length;i++)this.particleStoreArray[i].name==e&&(Ep.animationStore.remove(this.particleStoreArray[i]),t(this.particleStoreArray,this.particleStoreArray[i]))},this.getParticleSettings=()=>{let e=[];for(let t=0;t<this.particleStoreArray.length;t++){const i=this.particleStoreArray[t].getParticleStoreSetting();e.push(i)}return e},this.applyParticleSettings=e=>{for(let t=0;t<e.length;t++){this.addParticleStore(e[t].name).applyParticleSettings(e[t])}},this.addArticulation=({type:e,name:t,values:i,defaultValue:n})=>{let a=new J_({type:e,name:t,values:i,defaultValue:n});a.isValid()&&(a.getModelNode=()=>g,a.getModelItem=()=>this,a._type=a.getType(),a._name=a.getName(),a._values=a.getValues(),a._defaultValue=a.getDefaultValue(),this.articulations.push(a))},this.deleteArticulation=e=>{let t=this.articulations.findIndex((t=>t.name==e));this.articulations[t].deleteArticulation(),this.articulations.splice(t,1)},this.addArticulationAnimation=e=>{let t=new K_(e,this.name);this.articulationAnimations.push(t)},this.playArticulationAnimation=(e,t)=>{let i=this.articulationAnimations.find((t=>t.animationName===e));i&&i.play(t)},this.pauseArticulationAnimation=e=>{let t=this.articulationAnimations.find((t=>t.animationName===e));t&&t.pause()},this.resumeArticulationAnimation=(e,t)=>{let i=this.articulationAnimations.find((t=>t.animationName===e));i?i.resume(t):t&&t({result:0,message:"找不到"})},this.resetArticulationAnimation=e=>{let t=this.articulationAnimations.find((t=>t.animationName===e));t&&t.reset()},this.deleteArticulationAnimation=e=>{let t=this.articulationAnimations.findIndex((t=>t.animationName===e));t>-1&&(this.articulationAnimations[t].delete(),this.articulationAnimations.splice(t,1))},this.materialStore.getModelNode=()=>g,this.getGroup=()=>g,this.findMaterial=e=>this.materialStore.find(e),this.getMaterials=()=>this.materialStore.getAll(),this.applyState=()=>{if(g&&""!==Ep.stateStore.getCurrentState()){let e=Ep.stateStore.findState(Ep.stateStore.getCurrentState());e.settings.models&&e.settings.models[this.name]&&"boolean"==typeof e.settings.models[this.name].visible&&(g.visible=e.settings.models[this.name].visible)}},this.scale=(e=1,t=1,i=1)=>{g&&g.scale.set(e,t,i)},this.translate=(e=0,t=0,i=0)=>{g&&g.position.set(e,t,i)},this.rotateX=e=>{g&&g.rotateX(_y.degreeToRadian(e))},this.rotateY=e=>{g&&g.rotateY(_y.degreeToRadian(e))},this.rotateZ=e=>{g&&g.rotateZ(_y.degreeToRadian(e))},this.findNode=(e="")=>_y.findNodeRecursively(e,g),this.hideNode=(e="")=>{let t=_y.findNodeRecursively(e,g);t&&(t.visible=!1)},this.showNode=(e="")=>{let t=_y.findNodeRecursively(e,g);t&&(t.visible=!0)},this.getSettings=()=>(g&&(this.transform.position=g.position,this.transform.rotation=g.rotation,this.transform.scale=g.scale),{id:this.id,name:this.name,modelPath:this.modelPath,modelType:this.modelType,articulations:this.articulations.map((e=>e.getSettings?e.getSettings():e)),articulationAnimations:this.articulationAnimations,particleStores:this.getParticleSettings(),children:this.children,materials:this.materialStore.getSettings(),transform:this.transform,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,parent:this.parent}),this._fbxLoad=()=>{},this._glbLoad=()=>{},this.addModel=(e,t,i)=>(logger.debug("TRACE: ModelItem.addModel() - Entering.",e),e=e||{},logger.debug("TRACE: ModelItem.addModel() - Leaving and return a Promise."),new Promise(((n,a)=>{if(Ep.loaders.gltfLoader||(t&&t(0,"No loader initiated."),a(new Error("No loader initiated."))),e.name||(e.name=_y.guid()),e.modelPath.toLowerCase().indexOf("#disablecache")>-0){let r=i=>{(g=i.scene).name=e.name,e.transform&&(e.transform.position&&null!=e.transform.position.x&&g.position.set(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation&&null!=e.transform.rotation._x&&(g.rotation.x=e.transform.rotation._x,g.rotation.y=e.transform.rotation._y,g.rotation.z=e.transform.rotation._z),e.transform.scale&&(null!=e.transform.scale.x?g.scale.set(e.transform.scale.x,e.transform.scale.y,e.transform.scale.z):"number"==typeof e.transform.scale&&g.scale.set(e.transform.scale,e.transform.scale,e.transform.scale))),f?f.add(g):Ep.scene.models.add(g);const a=g.sourceModelKey;if(g.traverse((t=>{if(_y.capableForCastingShadow(t)&&(t.castShadow=!0,t.receiveShadow=!0),t.material instanceof Array)for(let i of t.material){if(i instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(i);e.needsUpdate=!0,t.material[t.material.indexOf(i)]=e,i=e}if(i instanceof So){i.alphaTest=.05,i.depthWrite=!0,i.depthTest=!0,i.vertexColors=!1,i.needsUpdate=!0;for(let e in i)i[e]instanceof we&&i[e].image&&Ep.textureStore.add(i[e].name||`${i.name}#${e}`,i[e],a);this.materialStore.add(i.name,i,t,e.name)}}else{if(t.material instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(t.material);e.needsUpdate=!0,t.material=e}if(t.material instanceof So){t.material.alphaTest=.05,t.material.depthWrite=!0,t.material.depthTest=!0,t.material.vertexColors=!1,t.material.needsUpdate=!0;for(let e in t.material)t.material[e]instanceof we&&t.material[e].image&&Ep.textureStore.add(t.material[e].name||`${t.material.name}#${e}`,t.material[e],a);this.materialStore.add(t.material.name,t.material,t,e.name)}}})),i.animations instanceof Array&&i.animations.length>0){let e=new Fc(g);e.clipAction(i.animations[0]).play(),Ep.animationMixers.push(e)}this.children=qy._fromThreeObject(g).children,e.isVisible=null==e.isVisible||e.isVisible,e.isVisible?this.show():this.hide(),this._setLock(e.isLock),n(),setTimeout((()=>{Ep.instance.focus(),t&&t(1,g,this)}),500)};return void("fbx"==e.modelType.toLowerCase()?Ep.loaders.fbxLoader.load(e.modelPath.replace("#disablecache",""),(e=>r(e)),i,(e=>{t?t(0,e):logger.debug(e),a(e)})):Ep.loaders.gltfLoader.load(e.modelPath.replace("#disablecache",""),(e=>r(e)),i,(e=>{t?t(0,e):logger.debug(e),a(e)})))}const r=_y.md5(e.modelPath);Ep.cacheStore.load({path:e.modelPath,type:e.modelType||"glb",onLoad:i=>{if((g=i).sourceModelKey=r,g.name=e.name,e.transform&&(e.transform.position&&null!=e.transform.position.x&&g.position.set(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation&&null!=e.transform.rotation._x&&(g.rotation.x=e.transform.rotation._x,g.rotation.y=e.transform.rotation._y,g.rotation.z=e.transform.rotation._z),e.transform.scale&&(null!=e.transform.scale.x?g.scale.set(e.transform.scale.x,e.transform.scale.y,e.transform.scale.z):"number"==typeof e.transform.scale&&g.scale.set(e.transform.scale,e.transform.scale,e.transform.scale))),f)f.add(g),"PaintItem"!=f.type&&"PackedItem"!=f.type||f.childrenAdd(this);else{if(!Ep.scene)return void _y.disposeThreeObject(g);Ep.scene.models.add(g)}"fbx"==e.modelType?window._needReplace[this.name]={modelNode:g,modelItem:this}:(g.traverse((t=>{if(_y.capableForCastingShadow(t)&&(t.castShadow=!0,t.receiveShadow=!0),t.material instanceof Array)for(let i of t.material){if(i instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(i);e.needsUpdate=!0,t.material[t.material.indexOf(i)]=e,i=e}if(i instanceof So){i.alphaTest=.05,i.depthWrite=!0,i.depthTest=!0,i.vertexColors=!1,i.needsUpdate=!0;for(let e in i)i[e]instanceof we&&i[e].image&&Ep.textureStore.add(i[e].name||`${i.name}#${e}`,i[e],r);this.materialStore.add(i.name,i,t,e.name)}}else{if(t.material instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(t.material);e.needsUpdate=!0,t.material=e}if(t.material instanceof So){t.material.alphaTest=.05,t.material.depthWrite=!0,t.material.depthTest=!0,t.material.vertexColors=!1,t.material.needsUpdate=!0;for(let e in t.material)t.material[e]instanceof we&&t.material[e].image&&Ep.textureStore.add(t.material[e].name||`${t.material.name}#${e}`,t.material[e],r);this.materialStore.add(t.material.name,t.material,t,e.name)}}})),this.children=qy._fromThreeObject(g).children),e.isVisible=null==e.isVisible||e.isVisible,e.isVisible?this.show():this.hide(),this._setLock(e.isLock),n(),Ep.instance.focus(),t&&t(1,i,this),Ep.paintControls&&Ep.paintControls.updateWorld()},onProgress:i,onError:i=>{t&&t(0,i),logger.debug(i+e.modelPath+"模型加载失败！"),a(i)}})}))),null!=s&&s instanceof Et){if(g=s,"fbx"==this.modelType)return void(window._needReplace[this.name]={modeNode:s,modelItem:this});const e=g.sourceModelKey;g.traverse((t=>{if(_y.capableForCastingShadow(t)&&(t.castShadow=!0,t.receiveShadow=!0),t.material instanceof Array)for(let i of t.material){if(i instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(i);e.needsUpdate=!0,t.material[t.material.indexOf(i)]=e,i=e}if(i instanceof So){i.alphaTest=.05,i.depthWrite=!0,i.depthTest=!0,i.vertexColors=!1,i.needsUpdate=!0;for(let t in i)i[t]instanceof we&&i[t].image&&Ep.textureStore.add(i[t].name||`${i.name}#${t}`,i[t],e);this.materialStore.add(i.name,i,t,s.name)}}else{if(t.material instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(t.material);e.needsUpdate=!0,t.material=e}if(t.material instanceof So){t.material.alphaTest=.05,t.material.depthWrite=!0,t.material.depthTest=!0,t.material.vertexColors=!1,t.material.needsUpdate=!0;for(let i in t.material)t.material[i]instanceof we&&t.material[i].image&&Ep.textureStore.add(t.material[i].name||`${t.material.name}#${i}`,t.material[i],e);this.materialStore.add(t.material.name,t.material,t,s.name)}}})),this.children=qy._fromThreeObject(g).children}else this.addModel({name:t,modelPath:o,modelType:l,transform:u,isVisible:r,isLock:a},d,p);this.updateTransform=e=>{e.transform&&(e.transform.position&&null!=e.transform.position.x&&g.position.set(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation&&null!=e.transform.rotation._x&&(g.rotation.x=e.transform.rotation._x,g.rotation.y=e.transform.rotation._y,g.rotation.z=e.transform.rotation._z),e.transform.scale&&(null!=e.transform.scale.x?g.scale.set(e.transform.scale.x,e.transform.scale.y,e.transform.scale.z):"number"==typeof e.transform.scale&&g.scale.set(e.transform.scale,e.transform.scale,e.transform.scale)))},this.updateMaterialStore=()=>{this.materialStore=new Eb(Ep.textureStore,Ep.instance);const e=g.sourceModelKey;g.traverse((t=>{if(_y.capableForCastingShadow(t)&&(t.castShadow=!0,t.receiveShadow=!0),t.material instanceof Array)for(let i of t.material){if(i instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(i);e.needsUpdate=!0,t.material[t.material.indexOf(i)]=e,i=e}if(i instanceof So){i.alphaTest=.05,i.depthWrite=!0,i.depthTest=!0,i.vertexColors=!1,i.needsUpdate=!0;for(let t in i)i[t]instanceof we&&i[t].image&&Ep.textureStore.add(i[t].name||`${i.name}#${t}`,i[t],e);this.materialStore.add(i.name,i,t,g.name)}}else{if(t.material instanceof Kt){let e=_y.MeshBasicMaterialToMeshStandardMaterial(t.material);e.needsUpdate=!0,t.material=e}if(t.material instanceof So){t.material.alphaTest=.05,t.material.depthWrite=!0,t.material.depthTest=!0,t.material.vertexColors=!1,t.material.needsUpdate=!0;for(let i in t.material)t.material[i]instanceof we&&t.material[i].image&&Ep.textureStore.add(t.material[i].name||`${t.material.name}#${i}`,t.material[i],e);this.materialStore.add(t.material.name,t.material,t,g.name)}}}))},this.updateChildren=()=>{this.children=qy._fromThreeObject(g).children},this.updateModel=({newModelStyle:e,next:t,onProgress:i,onLoad:n,modelType:a="glb"}=(params={}))=>{if(!e)return;if(!t)return;let r=new Map,s=new Map,o=new Set,l=new Set,c=new Set,h=new Set;Ep.cacheStore.load({path:e.modelPath,type:a,onLoad:i=>{let n=i;n.name=g.name,e.name=g.name,g.traverse((e=>{if(e instanceof db)return;if(e.material)if(e.material instanceof Array)for(let t in e.material)r.set(e.material[t].name,e.material[t]);else r.set(e.material.name,e.material);n.getObjectByName(e.name)||o.add(e)})),n.traverse((e=>{if(!(e instanceof db)&&e.material)if(e.material instanceof Array)for(let t in e.material)s.set(e.material[t].name,e.material[t]);else s.set(e.material.name,e.material)})),r.forEach(((e,t)=>{s.has(t)||l.add(e)}));let u=JSON.parse(JSON.stringify(this.articulations));u.forEach&&u.forEach(((e,t)=>{e.properties.forEach&&e.properties.forEach(((e,i)=>{o.forEach((i=>{let n=e.nodes.indexOf(i.name);n>-1&&(e.nodes.splice(n,1),c.add(this.articulations[t]))})),e.nodes.length||(e.nodes=["请选择关节对象"])}))})),this.articulationAnimations.forEach((e=>{e.articulationAnimationItems.forEach((t=>{c.forEach((i=>{i._name===t.articulationName&&h.add(e)}))}))}));let d=Array.from(o).map((e=>e.name)),p=Array.from(l).map((e=>e.name)),m=Array.from(c).map((e=>e._name)),f=Array.from(h).map((e=>e.animationName));t&&t({deleteNodeNameList:d,deleteMaterialNameList:p,deleteJointNameList:m,deleteAnimationNameList:f},(t=>{if(t){let t=JSON.parse(JSON.stringify(this.getSettings()));if(t.modelPath===e.modelPath)return;t.articulations=u,t.modelPath=e.modelPath,this.modelPath=e.modelPath,this.modelType=a;let i=g.uuid,r=g.parent;r.remove(g),n.uuid=i,r.add(n),g=n,this.updateMaterialStore(),this.updateChildren(),Ep.instance.defaultObjectTree.applyObjectSetting(e),Ep.instance.defaultObjectTree.applyObjectSetting(t),this.updateTransform(t)}}))},onProgress:e=>{i&&i(e)},onError:e=>{n&&n(0)}})},this.getObjectInfo=()=>{let e={width:0,height:0,depth:0,size:0,faces:0,vertices:0,nodes:0,materials:0},t=Ep.cacheStore._cache.get(fy(this.modelPath));e.size=(t.size/1024/1024).toFixed(2);let i=new Nv;return this.getGroup&&this.getGroup()&&i.setFromObject(this.getGroup()),e.width=(i.max.x-i.min.x).toFixed(3),e.height=(i.max.y-i.min.y).toFixed(3),e.depth=(i.max.z-i.min.z).toFixed(3),this.getGroup().traverse((t=>{if(t instanceof ms||t instanceof as);else if(t==this.getGroup()||t.isForParticle||(e.nodes+=1),t.geometry){let i=null;i=t.geometry.index?t.geometry.index.count:t.geometry.attributes.position.count,e.vertices+=i,e.faces=e.vertices/3}})),e.materials=Object.keys(this.materialStore._materials).length,e}}}class ex extends wb{constructor(e,t,i=Ep.scene.models,n=Ep.defaultObjectTree){super("PaintItem",e,t,i,n),this.modelInstanced=[],this.iconInstanced=[],this.effectPathItems=[];let a=0;if(e.pathBrushProperties){this.pathIndex=e.pathBrushProperties.pathIndex,this.pathPoints=[];for(let t of e.pathBrushProperties.pathPoints)this.pathPoints.push(new Ce(t.x,t.y,t.z));this.pathBrushAssets=e.pathBrushProperties.pathBrushAssets,this.pathBrushOptions=e.pathBrushProperties.options,this.pathBrushMode=e.pathBrushProperties.pathBrushMode,this.pathBrushCategory=e.pathBrushProperties.pathBrushCategory,this.pathBrushFrozen=e.pathBrushProperties.pathBrushFrozen,this.pathBrushLinePoints=e.pathBrushProperties.pathBrushLinePoints,Ep.paintControls.addBrushPath(e.name,this.pathIndex,this.pathPoints)}this.addEffectPath=e=>{e.parentGroup=this.getGroup(),this.effectPathItems.push(e)},this.removeEffectPath=e=>{const t=this.effectPathItems.findIndex((t=>t===e));-1!==t&&this.effectPathItems.splice(t,1),e.dispose&&e.dispose()};const r=this.dispose;this.dispose=(e,t)=>{if(void 0===e){for(const e of this.effectPathItems)e.dispose&&e.dispose();this.effectPathItems=[];let e=this.pathIndex;if(e>-1){Ep.paintControls.removePaintPath(e);for(let t=0;t<Ep.defaultObjectTree.children.length;t++){let i=Ep.defaultObjectTree.children[t];"PaintItem"===i.type&&i.pathIndex>e&&(i.pathIndex-=1,i.pathBrushProperties&&(i.pathBrushProperties.pathIndex-=1))}}}r&&r(e,t)},this.childrenRemove=e=>{for(let t=this.children.length-1;t>=0;t--)this.children[t].name===e&&(this.children[t].dispose&&this.children[t].dispose(),this.children.splice(t,1))},this.getInstanced=(e,t)=>"ModelAsset"==e?this.modelInstanced.find((e=>e.name==t)):"IconAsset"==e?this.iconInstanced.find((e=>e.name==t)):void 0,this.addInstanced=(e,t)=>{"ModelAsset"==e?this.modelInstanced.push(t):"IconAsset"==e&&this.iconInstanced.push(t)},this.getIndexName=e=>{if(!this.children.length)return a=2,`${e}_1`;if(0===a&&(a=this.children.length+1),a){let t=`${e}_${a}`;for(;;){a++;if(0===this.children.filter((e=>e.name===t)).length)break;t=`${e}_${a}`}return t}let t=this.children[this.children.length-1].name,i=t.lastIndexOf("_");return a=Number(t.substr(i+1))+1||0,this.getIndexName(e)},this.updateLast=e=>{let t=e.lastIndexOf("_"),i=Number(e.substr(t+1))+1||0;i>a&&(a=i)},this.removeItem=(e,t,i)=>new Promise((t=>{let n=this.children.find((t=>t.name==e));if(n.isInstancedItem){if("ModelAsset"==n.type||"ModelItem"==n.type)for(let e=0;e<this.children.length;e++)this.children[e].isInstancedItem&&this.children[e].parent==n.parent&&this.children[e].key>n.key&&(this.children[e].key=this.children[e].key-1);this.childrenRemove(e),n.remove(),"preview"===i&&a--,t(1)}else this.remove(e,(e=>{this.children.length||Ep.defaultObjectTree.remove(this.name),t(e)}));if(!this.children.length)if(this.parent&&"objectTree"!=this.parent){Ep.defaultObjectTree.getItemByName(this.parent).remove(this.name)}else Ep.defaultObjectTree.remove(this.name)})),this.rankNode=(e,t)=>{let i=this.children.find((e=>e.name==t)),n=i.index,a=JSON.parse(JSON.stringify(this.children));if(a.sort(((e,t)=>e.index-t.index)),"up"==e&&n==a[0].index||"down"==e&&n==a[a.length-1].index)return;let r=this._getBrotherNode(e,i.index);r&&(i.index=r.index,r.index=n,i.isInstancedItem&&i.rankNode(),r.isInstancedItem&&r.rankNode())},this._getBrotherNode=(e,t)=>{if(-1==t||t==this.children.length+1)return null;let i="up"==e?t-1:t+1,n=this.children.find((e=>e.index==i));if(n)return n;this._getBrotherNode(e,i)},this.rename=(e,t)=>{if(!e)return;for(let t=0;t<Ep.ssr.length;t++)Ep.ssr[t].modelName===this.name&&(Ep.ssr[t].modelName=e);let i=this.name;if(this.name=e,this.getGroup().name=e,this.materialStore)for(let t in this.materialStore._materials)this.materialStore._materials[t]._modelName=e;for(let t=0;t<this.iconInstanced.length;t++)this.iconInstanced[t].layerName&&(this.iconInstanced[t].layerName=e);"pathbrush"===this.pathBrushMode&&Ep.paintControls.renamePathLayer(i,e),t&&t(1,"重命名成功")},this.getSettings=()=>{let e=this.getGroup();e&&(this.transform.position=e.position,this.transform.rotation=e.rotation,this.transform.scale=e.scale);let t=[];this.modelInstanced.forEach((e=>{let i={name:e.name,children:e.children,type:"ModelAsset",isVisible:e.isVisible,count:e.count,points:e.points,transform:e.transform,matrix:[],delta:0,path:e.path,settings:e.settings,newMatrix:e.newMatrix,materials:e.materialStore.getSettings(),particleStores:e.getParticleSettings(),randomValues:e.getRand(),rotateY:e.rotateY};if(e.getMesh&&e.getMesh()&&e.getMesh().count){if(e.getMeshes()[0].matrixWorldOffset){const t=e.getMeshes()[0].matrixWorldOffset.clone();t.invert();for(let a=0;a<e.getMeshes()[0].count;a++){var n=new it;e.getMeshes()[0].getMatrixAt(a,n),i.matrix.push(n.clone().multiply(t))}}else for(let t=0;t<e.getMeshes()[0].count;t++){n=new it;e.getMeshes()[0].getMatrixAt(t,n),i.matrix.push(n)}t.push(i)}}));let i=[];this.children.forEach((e=>{e.isInstancedItem||i.push(e.getSettings()),e.isInstancedItem&&e.movingAnimation&&i.push({type:"movingObject",instanced:e.instanced.name,key:e.key,lineIndex:e.movingAnimation.lineIndex,startLength:e.movingAnimation.startLength,maxLength:e.movingAnimation.maxLength,reverse:e.movingAnimation.reverse,speed:e.movingAnimation.speed,useTangent:e.movingAnimation.useTangent,perpendicular:e.movingAnimation.perpendicular,delay:e.movingAnimation.delay,euler:{x:e.movingAnimation.euler.x,y:e.movingAnimation.euler.y,z:e.movingAnimation.euler.z}})}));const n=[];return this.effectPathItems.forEach((e=>{n.push(e.getSettings())})),{name:this.name,type:this.type,children:i,isVisible:this.isVisible,isLock:this.isLock,index:this.index,transform:this.transform,iconInstanced:this.iconInstanced,modelInstanced:t,effectPathItems:n,pathBrushProperties:{pathIndex:this.pathIndex,pathPoints:this.pathPoints,options:this.pathBrushOptions,pathBrushAssets:this.pathBrushAssets,pathBrushMode:this.pathBrushMode,pathBrushCategory:this.pathBrushCategory,pathBrushFrozen:this.pathBrushFrozen,pathBrushLinePoints:this.pathBrushLinePoints}}}}}const tx=1024;function ix(e,t,i,n,a,r){const s=e.image,{data:o}=s,l=3072*r;o[3*t+l+0]=i,o[3*t+l+1]=n,o[3*t+l+2]=a}class nx{constructor(e,t=1){const i=e.clone(),n=function(e=1){const t=new Float32Array(4096*e*3),i=new $i(t,tx,4*e,C,T);return i.wrapS=d,i.wrapY=d,i.magFilter=g,i.needsUpdate=!0,i}(t),a={spineTexture:{value:n},pathOffset:{type:"f",value:0},pathSegment:{type:"f",value:1},spineOffset:{type:"f",value:161},spineLength:{type:"f",value:400},flow:{type:"i",value:1}};i.traverse((function(e){(e instanceof Fi||e instanceof Qr)&&(e.material=e.material.clone(),function(e,t,i=1){e.__ok||(e.__ok=!0,e.onBeforeCompile=e=>{if(e.__modified)return;e.__modified=!0,Object.assign(e.uniforms,t);const n=`\n\t\tuniform sampler2D spineTexture;\n\t\tuniform float pathOffset;\n\t\tuniform float pathSegment;\n\t\tuniform float spineOffset;\n\t\tuniform float spineLength;\n\t\tuniform int flow;\n\n\t\tfloat textureLayers = ${4*i}.;\n\t\tfloat textureStacks = 1.;\n\n\t\t${e.vertexShader}\n\t\t`.replace("#include <beginnormal_vertex>","").replace("#include <defaultnormal_vertex>","").replace("#include <begin_vertex>","").replace(/void\s*main\s*\(\)\s*\{/,"\nvoid main() {\n#include <beginnormal_vertex>\n\nvec4 worldPos = modelMatrix * vec4(position, 1.);\n\nbool bend = flow > 0;\nfloat xWeight = bend ? 0. : 1.;\n\n#ifdef USE_INSTANCING\nfloat pathOffsetFromInstanceMatrix = instanceMatrix[3][2];\nfloat spineLengthFromInstanceMatrix = instanceMatrix[3][0];\nfloat spinePortion = bend ? (worldPos.x + spineOffset) / spineLengthFromInstanceMatrix : 0.;\nfloat mt = (spinePortion * pathSegment + pathOffset + pathOffsetFromInstanceMatrix)*textureStacks;\n#else\nfloat spinePortion = bend ? (worldPos.x + spineOffset) / spineLength : 0.;\nfloat mt = (spinePortion * pathSegment + pathOffset)*textureStacks;\n#endif\n\nmt = mod(mt, textureStacks);\nfloat rowOffset = floor(mt);\n\n#ifdef USE_INSTANCING\nrowOffset += instanceMatrix[3][1] * 4.;\n#endif\n\nvec3 spinePos = texture2D(spineTexture, vec2(mt, (0. + rowOffset + 0.5) / textureLayers)).xyz;\nvec3 a =        texture2D(spineTexture, vec2(mt, (1. + rowOffset + 0.5) / textureLayers)).xyz;\nvec3 b =        texture2D(spineTexture, vec2(mt, (2. + rowOffset + 0.5) / textureLayers)).xyz;\nvec3 c =        texture2D(spineTexture, vec2(mt, (3. + rowOffset + 0.5) / textureLayers)).xyz;\nmat3 basis = mat3(a, b, c);\n\nvec3 transformed = basis\n\t* vec3(worldPos.x * xWeight, worldPos.y * 1., worldPos.z * 1.)\n\t+ spinePos;\n\nvec3 transformedNormal = normalMatrix * (basis * objectNormal);\n\t\t\t").replace("#include <project_vertex>","vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\t\t\t\tgl_Position = projectionMatrix * mvPosition;");e.vertexShader=n})}(e.material,a,t))})),this.curveArray=new Array(t),this.curveLengthArray=new Array(t),this.object3D=i,this.splineTexure=n,this.uniforms=a}updateCurve(e,t){if(e>=this.curveArray.length)throw Error("Index out of range for Flow");const i=t.getLength();this.uniforms.spineLength.value=i,this.curveLengthArray[e]=i,this.curveArray[e]=t,function(e,t,i=0){const n=Math.floor(1024);t.arcLengthDivisions=n/2,t.updateArcLengths();const a=t.getSpacedPoints(n),r=t.computeFrenetFrames(n,!0);for(let t=0;t<n;t++){const n=Math.floor(t/tx),s=t%tx;let o=a[t];ix(e,s,o.x,o.y,o.z,0+n+4*i),o=r.tangents[t],ix(e,s,o.x,o.y,o.z,1+n+4*i),o=r.normals[t],ix(e,s,o.x,o.y,o.z,2+n+4*i),o=r.binormals[t],ix(e,s,o.x,o.y,o.z,3+n+4*i)}e.needsUpdate=!0}(this.splineTexure,t,e)}moveAlongCurve(e){this.uniforms.pathOffset.value+=e}}new it;let ax=!1;class rx extends wi{constructor(e,t=10,i=2,n=!1,a,r=!1,s=!1){super(),this.type="FacetsGeometry",this._segment=t,this._width=i,this._closed=n,this.params={path:e,segment:this._segment,width:this._width,closed:this._closed,depth:r},this.update=()=>{this._points=[];const t=[],i=[],n=[],r=[],o=[],l=[],c=[],h=e=>{e==this._points.length&&(e-=1);const r=this._points[e-1],o=this._points[e],h=this._points[e+1];let u,d,p,m;if(!r&&o&&h)p=h.clone().sub(o);else if(r)p=o.clone().sub(r);else{const e=r.clone().sub(o),t=h.clone().sub(o);p=e.add(t)}p.normalize(),ax=!1,0==p.x&&0==p.z&&(ax=!0,p=s?new Ce(0,0,1):new Ce(1,0,0)),m=new Ce(p.z,p.y,-p.x),s&&0==ax?m.applyAxisAngle(p,Math.PI/2):m.y=0,m.normalize(),u=this._points[e].clone().add(m.clone().multiplyScalar(this.params.width)),d=this._points[e].clone().add(m.clone().negate().multiplyScalar(this.params.width)),t.push(u.x,u.y,u.z),t.push(d.x,d.y,d.z),l.push(this.params.depth),l.push(this.params.depth),c.push(a.x,a.y,a.z),c.push(a.x,a.y,a.z),i.push(0,1,0),i.push(0,1,0);const f=e/this.params.segment,g=new ye(0,f),y=new ye(1,f);n.push(g.x,g.y),n.push(y.x,y.y)};(()=>{let t=new Ce;for(let i=0;i<=this.params.segment;i++){t=e.getPointAt(i/this.params.segment,t);const n=t.clone();this._points.push(n),o.push(n.x,n.y,n.z),o.push(n.x,n.y,n.z)}})(),(()=>{for(let e=0,t=this._points.length;e<t;e++)h(e);h(0==this.params.closed?this.params.segment:0)})(),(()=>{const e=2*this.params.segment;for(let t=0;t<e;t+=2){const e=t,i=t+1,n=t+2,a=t+3;r.push(e,i,n),r.push(n,i,a)}})(),(()=>{this.setIndex(r),this.setAttribute("position",new hi(t,3)),this.setAttribute("normal",new hi(i,3)),this.setAttribute("uv",new hi(n,2)),this.setAttribute("centers",new hi(o,3)),this.setAttribute("sizeView",new hi(l,1)),this.setAttribute("modelCenter",new hi(c,3))})()},this.update()}}class sx extends wi{constructor(e,t=64,i=1,n=8,a=0,r=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:n,closed:r,angle:a},this.update=()=>{let e=this.parameters;const t=e.path.computeFrenetFrames(e.tubularSegments,e.closed);this.tangents=t.tangents,this.normals=t.normals,this.binormals=t.binormals;const i=new Ce,n=new Ce,a=new ye;let r=new Ce;const s=[],o=[],l=[],c=[];function h(a){r=e.path.getPointAt(a/e.tubularSegments,r);const l=t.normals[a],c=t.binormals[a];for(let t=0;t<=e.radialSegments;t++){let a=t/e.radialSegments*Math.PI*2;a+=e.angle;const h=Math.sin(a),u=-Math.cos(a);n.x=u*l.x+h*c.x,n.y=u*l.y+h*c.y,n.z=u*l.z+h*c.z,n.normalize(),o.push(n.x,n.y,n.z),i.x=r.x+e.radius*n.x,i.y=r.y+e.radius*n.y,i.z=r.z+e.radius*n.z,s.push(i.x,i.y,i.z)}}!function(){for(let t=0;t<e.tubularSegments;t++)h(t);h(!1===e.closed?e.tubularSegments:0),function(){for(let t=0;t<=e.tubularSegments;t++)for(let i=0;i<=e.radialSegments;i++)a.x=t/e.tubularSegments,a.y=i/e.radialSegments,l.push(a.y,a.x)}(),function(){for(let t=1;t<=e.tubularSegments;t++)for(let i=1;i<=e.radialSegments;i++){const n=(e.radialSegments+1)*(t-1)+(i-1),a=(e.radialSegments+1)*t+(i-1),r=(e.radialSegments+1)*t+i,s=(e.radialSegments+1)*(t-1)+i;c.push(n,a,s),c.push(a,r,s)}}()}(),this.setIndex(c),this.setAttribute("position",new hi(s,3)),this.setAttribute("normal",new hi(o,3)),this.setAttribute("uv",new hi(l,2))},this.update()}toJSON(){const e=wi.prototype.toJSON.call(this);return e.path=this.parameters.path.toJSON(),e}}class ox extends wi{constructor(e,t){super(),this.isVectorLine=!0,this.type="VectorLine",this._segment=t,this._path=e,this.getPath=()=>e,this.update=()=>{this.positions=[],this.counters=[],this.previous=[],this.indices=[],this.next=[],this.side=[],this.width=[],this.uvs=[],this.usePathToGetPoint(this._path),this.getProcess(),this.combineAttribute2(),this.computeBoundingSphere(),this.computeBoundingBox()},this.update()}usePathToGetPoint(e){let t=new Ce;for(let i=0;i<this._segment;i++){const n=i/this._segment;t=e.getPoint(n,t),this.positions.push(t.x,t.y,t.z),this.positions.push(t.x,t.y,t.z),this.counters.push(n),this.counters.push(n)}t=e.getPoint(1,t),this.positions.push(t.x,t.y,t.z),this.positions.push(t.x,t.y,t.z),this.counters.push(1),this.counters.push(1)}getPointFromBufferGeometry(e){for(var t=0;t<e.length;t+=3){var i=t/e.length;this.positions.push(e[t],e[t+1],e[t+2]),this.positions.push(e[t],e[t+1],e[t+2]),this.counters.push(i),this.counters.push(i)}}curveToBufferGeometry(e){const t=[];let i=new Ce;for(let n=0;n<this._segment;n++)i=e.getPoint(n/this._segment,i),t.push(i.x,i.y,i.z);const n=new wi;return n.setAttribute("position",new hi(t,3)),n}compareVec3(e,t){var i=6*e,n=6*t;return this.positions[i]===this.positions[n]&&this.positions[i+1]===this.positions[n+1]&&this.positions[i+2]===this.positions[n+2]}copyVec3(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}getProcess(){let e,t=this._segment+1;e=this.compareVec3(0,t-1)?this.copyVec3(t-2):this.copyVec3(0),this.previous.push(e[0],e[1],e[2]),this.previous.push(e[0],e[1],e[2]);for(let n=0;n<t;n++){this.side.push(1),this.side.push(-1);const a=1;if(this.width.push(a),this.width.push(a),this.uvs.push(n/(t-1),0),this.uvs.push(n/(t-1),1),n<t-1){e=this.copyVec3(n),this.previous.push(e[0],e[1],e[2]),this.previous.push(e[0],e[1],e[2]);var i=2*n;this.indices.push(i,i+1,i+2),this.indices.push(i+2,i+1,i+3)}n>0&&(e=this.copyVec3(n),this.next.push(e[0],e[1],e[2]),this.next.push(e[0],e[1],e[2]))}e=this.compareVec3(t-1,0)?this.copyVec3(1):this.copyVec3(t-1),this.next.push(e[0],e[1],e[2]),this.next.push(e[0],e[1],e[2])}combineAttribute(){this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices)),this._attributes.index.needsUpdate=!0):this._attributes={position:new ti(new Float32Array(this.positions),3),previous:new ti(new Float32Array(this.previous),3),next:new ti(new Float32Array(this.next),3),side:new ti(new Float32Array(this.side),1),width:new ti(new Float32Array(this.width),1),uv:new ti(new Float32Array(this.uvs),2),index:new ti(new Uint16Array(this.indices),1),counters:new ti(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index)}combineAttribute2(){this.setAttribute("position",new hi(this.positions,3)),this.setAttribute("previous",new hi(this.previous,3)),this.setAttribute("next",new hi(this.next,3)),this.setAttribute("side",new hi(this.side,1)),this.setAttribute("width",new hi(this.width,1)),this.setAttribute("uv",new hi(this.uvs,2)),this.setAttribute("counters",new hi(this.counters,1)),this.setIndex(this.indices)}}class lx extends Yi{constructor(e){super({uniforms:Object.assign({},ln.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:0},useAlphaMap:{value:0},color:{value:new Qt(16777215)},opacity:{value:1},resolution:{value:new ye(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new ye(1,1)}}),transparent:!0,vertexShader:"#define GLSLIFY 1\nattribute vec3 previous;attribute vec3 next;attribute float side;attribute float width;attribute float counters;uniform vec2 resolution;uniform float lineWidth;uniform vec3 color;uniform float opacity;uniform float sizeAttenuation;varying vec2 vUv;varying vec4 vColor;varying float vCounters;vec2 fix(vec4 i,float aspect){vec2 res=i.xy/i.w;res.x*=aspect;vCounters=counters;return res;}void main(){float aspect=resolution.x/resolution.y;vColor=vec4(color,opacity);vUv=uv;mat4 m=projectionMatrix*modelViewMatrix;vec4 finalPos=m*vec4(position,1.);vec4 prevPos=m*vec4(previous,1.);vec4 nextPos=m*vec4(next,1.);vec2 currentP=fix(finalPos,aspect);vec2 prevP=fix(prevPos,aspect);vec2 nextP=fix(nextPos,aspect);float wid=lineWidth*width;vec2 dir;if(nextP==currentP){dir=normalize(currentP-prevP);}else if(prevP==currentP){dir=normalize(nextP-currentP);}else{vec2 dir1=normalize(currentP-prevP);vec2 dir2=normalize(nextP-currentP);dir=normalize(dir1+dir2);vec2 perp=vec2(-dir1.y,dir1.x);vec2 miter=vec2(-dir.y,dir.x);}vec4 normal=vec4(-dir.y,dir.x,0.,1.);normal.xy*=.5*wid;normal*=projectionMatrix;if(sizeAttenuation==0.){normal.xy*=finalPos.w;normal.xy/=(vec4(resolution,0.,1.)*projectionMatrix).xy;}finalPos.xy+=normal.xy*side;gl_Position=finalPos;}",fragmentShader:"#ifdef GL_ES\nprecision mediump float;\n#define GLSLIFY 1\n#endif\nuniform vec3 color;uniform float opacity;uniform sampler2D map;uniform sampler2D alphaMap;uniform float useMap;uniform float useAlphaMap;uniform float useDash;uniform float dashArray;uniform float dashOffset;uniform float dashRatio;uniform float visibility;uniform float alphaTest;uniform vec2 repeat;varying vec2 vUv;varying vec4 vColor;varying float vCounters;void main(){vec4 cs=vColor;if(useMap==1.){cs*=texture2D(map,vUv*repeat);}if(useAlphaMap==1.){cs.a*=texture2D(alphaMap,vUv*repeat).a;}if(cs.a<alphaTest){discard;}if(useDash==1.){cs.a*=ceil(mod(vCounters+dashOffset,dashArray)-(dashArray*dashRatio));}gl_FragColor=cs;gl_FragColor.a*=step(vCounters,visibility);}"}),this.isVectorLineMaterial=!0,this.type="VectorLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(e){this.uniforms.useAlphaMap.value=e}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(e){this.uniforms.useDash.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(e){this.uniforms.repeat.value.copy(e)}}}),this.setValues(e)}}class cx extends wi{constructor(e,t=2,i,n="transverse"){super(),this.type="RightAngleFacetsGeometry",this.vecTo=n,t&&(this._width=t),null==i&&console.warn("angleFold is null请联系作者,咨询使用说明"),this._angleFold=i,this._pointArray=e,this.update=()=>{this.positions=[],this.uvs=[],this.normals=[],this.indices=[],4==this._pointArray.length&&(this._pointArray.push(this._pointArray[this._pointArray.length-1]),this._pointArray.splice(1,0,this._pointArray[0])),this.usePoints(this._pointArray,this._angleFold),this.computerUV(),this.computeIndex(),this.combineAttribute()},this.update()}usePoints(e,t="XYZ"){if(e){this.points=e,this._segNum=this.points.length;const i=this.points[2].clone().sub(this.points[1]).normalize(),n=this.points[3].clone().sub(this.points[2]).normalize(),a=this.points[4].clone().sub(this.points[3]).normalize();if("transverse"==this.vecTo)for(let e=0,i=this._segNum;e<i;e++)if(e<=1){const t=a.clone().multiplyScalar(this._width),i=t.clone().negate();t.add(this.points[e]),i.add(this.points[e]),this.positions.push(t.x,t.y,t.z),this.positions.push(i.x,i.y,i.z),this.normals.push(n.x,n.y,n.z),this.normals.push(n.x,n.y,n.z)}else if(e>=i-2){const t=n.clone().multiplyScalar(this._width),i=t.clone().negate();t.add(this.points[e]),i.add(this.points[e]),this.positions.push(i.x,i.y,i.z),this.positions.push(t.x,t.y,t.z);const a=n.clone();this.normals.push(a.x,a.y,a.z),this.normals.push(a.x,a.y,a.z)}else{const i=this.points[e-1].clone().sub(this.points[e]).normalize(),n=this.points[e+1].clone().sub(this.points[e]).normalize(),r=i.clone().add(n).normalize();let s,o;if("XYZ"==t?(s=r.z,o=r.x):"ZYX"==t?(s=r.x,o=r.z):"YZX"==t?(s=r.x,o=r.y):"XZY"==t?(s=r.y,o=r.x):"YXZ"==t?(s=r.z,o=r.y):"ZXY"==t&&(s=r.y,o=r.z),0==s){const t=a.clone().multiplyScalar(this._width),i=t.clone().negate();t.add(this.points[e]),i.add(this.points[e]),this.positions.push(t.x,t.y,t.z),this.positions.push(i.x,i.y,i.z),this.normals.push(r.x,r.y,r.z),this.normals.push(r.x,r.y,r.z)}if(0==o){const t=i.angleTo(n)/2,a=this._width/Math.sin(t),s=r.clone().multiplyScalar(a),o=s.clone().negate();s.add(this.points[e]),o.add(this.points[e]),r.negate(),this.positions.push(s.x,s.y,s.z),this.positions.push(o.x,o.y,o.z),this.normals.push(r.x,r.y,r.z),this.normals.push(r.x,r.y,r.z)}}else if("vertical"==this.vecTo)for(let e=0,r=this._segNum;e<r;e++)if(e<=1){const t=n.clone().multiplyScalar(this._width),i=t.clone().negate();t.add(this.points[e]),i.add(this.points[e]),this.positions.push(t.x,t.y,t.z),this.positions.push(i.x,i.y,i.z),this.normals.push(a.x,a.y,a.z),this.normals.push(a.x,a.y,a.z)}else if(e>=r-2){const t=i.clone().multiplyScalar(this._width),a=t.clone().negate();t.add(this.points[e]),a.add(this.points[e]),this.positions.push(a.x,a.y,a.z),this.positions.push(t.x,t.y,t.z);const r=n.clone();this.normals.push(r.x,r.y,r.z),this.normals.push(r.x,r.y,r.z)}else{const n=this.points[e-1].clone().sub(this.points[e]).normalize(),r=this.points[e+1].clone().sub(this.points[e]).normalize(),s=n.clone().add(r).normalize();let o,l;if("XYZ"==t?(o=s.z,l=s.x):"ZYX"==t?(o=s.x,l=s.z):"YZX"==t?(o=s.x,l=s.y):"XZY"==t?(o=s.y,l=s.x):"YXZ"==t?(o=s.z,l=s.y):"ZXY"==t&&(o=s.y,l=s.z),0==o){const t=n.angleTo(r)/2,i=this._width/Math.sin(t),o=s.clone().multiplyScalar(i),l=o.clone().negate();o.add(this.points[e]),l.add(this.points[e]),this.positions.push(o.x,o.y,o.z),this.positions.push(l.x,l.y,l.z),this.normals.push(a.x,a.y,a.z),this.normals.push(a.x,a.y,a.z)}if(0==l){const t=i.clone().multiplyScalar(this._width).negate(),n=t.clone().negate();t.add(this.points[e]),n.add(this.points[e]),this.positions.push(t.x,t.y,t.z),this.positions.push(n.x,n.y,n.z),this.normals.push(s.x,s.y,s.z),this.normals.push(s.x,s.y,s.z)}}}}computeFullLength(){let e=0;for(let t=0;t<this._segNum;t++)if(this.points[t+1]){e+=this.points[t].distanceTo(this.points[t+1])}return e}computerUV(){const e=this.computeFullLength();let t=0;for(let i=0,n=this._segNum;i<n;i++){const n=new ye(0,t/e),a=new ye(1,t/e);this.uvs.push(n.x,n.y),this.uvs.push(a.x,a.y),this.points[i+1]&&(t+=this.points[i].distanceTo(this.points[i+1]))}}computeIndex(){for(let e=0,t=2*(this._segNum-1);e<t;e+=2){const t=e,i=e+1,n=e+2,a=e+3;this.indices.push(t,i,n),this.indices.push(n,i,a)}}combineAttribute(){this.setAttribute("position",new hi(this.positions,3)),this.setAttribute("uv",new hi(this.uvs,2)),this.setAttribute("normal",new hi(this.normals,3)),this.setIndex(this.indices)}}class hx{constructor(e,t){this.initAttribute(),this.initDate(t),this.arrayToLine(),this.type="modelLine",this.isModelLine=!0,this.parent=e,this.id=ge.generateUUID()}initDate(e){this.pointLineArray=e||[[30,10,30],[0,20,0],[-30,15,40]]}initAttribute(){this.pointLineArray=[],this.samplesNum=200,this.HelperBoxGroup=new sr,this.HelperBoxGroup.name="辅助几何体选择组",this.HelperBoxArray=[],this.beClickObject=null,this._TPOL=!1,this._TPOLHeight=-5,this._SPL=!1,this._SPLStyle="XYZ",this.defaultGeoMat=new So({name:"modelLineMaterial",color:"green",metalness:.1,roughness:.3,transparent:!0,side:2}),this.vectorLineMat=new lx({useMap:!1,color:new Qt("red"),opacity:1,resolution:new ye(window.innerWidth,window.innerHeight),sizeAttenuation:!1,lineWidth:50}),this._parent=null,this._editing=!0,this._helperBoxView=!0,this._lineLineWidth=.01,this._lineDashed=!1,this._lineDashScale=.1,this._geoTubularSegments=20,this._geoRadius=2,this._geoRadialSegments=8,this._geoAngle=0,this._geoClosed=!1,this._showGui=!1,this._startObject=null,this._finalObject=null,this.startPosOffset=new Ce,this.finalPosOffset=new Ce,this._extend=!1,this._extendLength=5,this._meshType="subline",this._hightLight=!1,this.labelGroup=new sr,this.labelGroup.name="模型线标签组",this._vectorLineWidth=10,this._rightAngleWidth=4,this._rightAngleType="transverse",this._meshLineAngle=0,this._meshLineSegment=10,this._meshLineWidth=1,this._vectorLineSegment=100,this._planeSizeView=!1,this._materialStore=null,this._vertical=!1}setDefaultMat(e){this._materialStore=e}set highLight(e){this._hightLight=e,this.mesh&&(this._hightLight?Ep.effectStore.highlightObject(this.mesh):Ep.effectStore.cancleHighlightObject(this.mesh))}get highLight(){return this._hightLight}set parent(e){e&&(this._parent=e,this.HelperBoxGroup.parent||this._parent.add(this.HelperBoxGroup),this.curve.mesh.parent||this._parent.add(this.curve.mesh),this.mesh&&this._parent.add(this.mesh),this.labelGroup.parent||this._parent.add(this.labelGroup))}get parent(){return this._parent}set EditMode(e){this._parent?(this._editing=e,1==this._editing?this.HelperBoxGroup.visible=!0:0==this._editing&&(this.HelperBoxGroup.visible=!1,this.curve.mesh.visible=!1)):console.warn("您未设置夫对象,编辑模式失效，请设置好父对象")}get EditMode(){return this._editing}arrayToLine(){const e=[];for(let t=0,i=this.pointLineArray.length;t<i;t++){const i=this.arrayToVec3(this.pointLineArray[t]),n=this.createHelperBox(i);e.push(n.position)}this.initCurve(e),this.createLineGeo()}arrayToVec3(e){return new Ce(e[0],e[1],e[2])}initCurve(e){let t=new pl(e);return t.curveType="catmullrom",this.curve=t}initCurve2(e){let t=new Tl;for(let i=0,n=e.length-1;i<n;i++){const n=new _l(e[i],e[i+1]);t.curves.push(n)}return this.curve=t}initCurve3(e){let t=new Tl;for(let i=0,n=e.length-2;i<n;i++){const n=new wl(e[i],e[i+1],e[i+2]);t.curves.push(n)}return this.curve=t}curveUpdate(){const e=this.curve.mesh.geometry.attributes.position;let t=[];this.updateBindPos(),1==this._TPOL&&this.tpolUpdate(),1==this._SPL&&this.spatialPolylineUpdate();let i=new Ce;this.curve.updateArcLengths();for(let n=0,a=this.samplesNum;n<a;n++){const r=n/(a-1);this.curve.getPoint(r,i),e.setXYZ(n,i.x,i.y,i.z),t.push(i.x,i.y,i.z)}if(e.needsUpdate=!0,this._hightLight&&Ep.effectStore.cancleHighlightObject(this.mesh),this.mesh){if(this._materialStore&&this._materialStore.getAll().modelLineMaterial.removeRelatedNode(this.mesh),"fatLine"==this._meshType)this.mesh.geometry.setPositions(t);else if("tubeGeometry"==this._meshType)this.mesh.geometry.update();else if("boxGeometry"==this._meshType)this.clearGenerate(),this.generateBox();else if("faceGeometry"==this._meshType)this.mesh.geometry.update(),this.updateMeshPlaneMat();else if("vectorLineGeometry"==this._meshType)this.mesh.geometry.update(),this.updateVectorMat();else if("RightAngleFacetsGeometry"==this._meshType){const e=[];for(let t=0;t<this.HelperBoxArray.length;t++)e.push(this.HelperBoxArray[t].position);this.mesh.geometry._pointArray=e,this.mesh.geometry.update(),this.updateRightAngleLineMat()}this._materialStore&&this._materialStore.getAll().modelLineMaterial.addRelatedNode(this.mesh),this.mesh&&(this.mesh.frustumCulled=!1)}}createBox(e){const t=new Kt({color:16777215*Math.random(),depthWrite:!1,depthTest:!1,wireframe:!0}),i=new Fi(new Hi(5,5,5),t);return i.renderOrder=1e4,e&&i.position.copy(e),i}createPoints(e){const t=new vr({color:16777215*Math.random()}),i=new Or(t);return e&&i.position.copy(e),i}set hideHelperBox(e){this._helperBoxView=e}get hideHelperBox(){return this._helperBoxView}createHelperBox(e){const t=this.createBox(e);return this.HelperBoxGroup.add(t),this.HelperBoxArray.push(t),t}addHelperBox(e){if(e&&(this.beClickObject=e),this.beClickObject){const e=this.getArrayPosition(this.HelperBoxArray,this.beClickObject),t=this.createBox(),i=this.HelperBoxArray[e],n=this.HelperBoxArray[e-1];if(n){const e=i.position,a=n.position;t.position.set((e.x+a.x)/2,(e.y+a.y)/2,(e.z+a.z)/2)}else t.position.set(0,0,0);this.HelperBoxArray.splice(e,0,t),this.HelperBoxGroup.add(t),this.curve.points.splice(e,0,t.position),this.curveUpdate()}else console.warn("未选择任意点");this.beClickObject=null}removeHelperBox(e){if(e&&(this.beClickObject=e),this.HelperBoxArray.length>2)if(this.beClickObject){const e=this.getArrayPosition(this.HelperBoxArray,this.beClickObject);this.PointRemoveEvent&&this.PointRemoveEvent(),this.HelperBoxArray.splice(e,1),this.HelperBoxGroup.remove(this.beClickObject),this.curve.points.splice(e,1),this.curveUpdate(),this.beClickObject.geometry.dispose(),this.beClickObject.material.dispose(),this.beClickObject=null}else console.warn("未选择任意点");else console.warn("当前线段上的点不能再删除了,如需继续删除，请调用销毁方法");this.beClickObject=null}createLineGeo(){const e=new wi;e.setAttribute("position",new ti(new Float32Array(3*this.samplesNum),3)),this.curve.mesh=new as(e,new Kr({color:"#000EFF"})),this.curve.mesh.visible=!1}set tension(e){this.curve.tension=e,this.curveUpdate()}get tension(){return this.curve.tension}set closed(e){this.curve.closed=e,this.curveUpdate()}get closed(){return this.curve.closed}set curveType(e){this.curve.curveType=e,this.curveUpdate()}get curveType(){return this.curve.curveType}getArrayPosition(e,t){for(let i=0,n=e.length;i<n;i++)if(e[i]==t)return i;return-1}generateFatLine(){if(this.mesh)console.warn("已经有生成了几何体了，请清除当前生成的对象再试");else{const e=[];let t=new Ce;for(let i=0,n=this.samplesNum;i<n;i++){const a=i/(n-1);this.curve.getPoint(a,t),e.push(t.x,t.y,t.z)}const i=new cu;i.setPositions(e);const n=new ou({color:"red",linewidth:this._lineLineWidth,dashed:this._lineDashed,dashScale:this._lineDashScale});1==this._lineDashed?n.defines.USE_DASH="":delete n.defines.USE_DASH;const a=new hu(i,n);a.computeLineDistances(),this.mesh=a,this._parent&&this._parent.add(this.mesh),this._meshType="fatLine",this._hightLight&&Ep.effectStore.cancleHighlightObject(this.mesh)}}set lineLineWidth(e){this.mesh?"Line2"==this.mesh.type?(this._lineLineWidth=e,this.mesh.material.linewidth=this._lineLineWidth,this.mesh.material.needsUpdate=!0):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get lineLineWidth(){return this._lineLineWidth}set lineDashed(e){this.mesh?"Line2"==this.mesh.type?(this._lineDashed=e,this.mesh.material.dashed=this._lineDashed,e?this.mesh.material.defines.USE_DASH="":delete this.mesh.material.defines.USE_DASH,this.mesh.material.needsUpdate=!0):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get lineDashed(){return this._lineDashed}set lineDashScale(e){this.mesh?"Line2"==this.mesh.type?(this._lineDashScale=e,this.mesh.material.dashScale=this._lineDashScale,this.mesh.material.needsUpdate=!0):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get lineDashScale(){return this._lineDashScale}set geometryMaterial(e){this.defaultGeoMat=e}get geometryMaterial(){return this.defaultGeoMat}generateGeometry(e){if(this.mesh)console.warn("已经有生成了几何体了，请清除当前生成的对象再试");else{e&&(this._geoTubularSegments=e);const t=new sx(this.curve,this._geoTubularSegments,this._geoRadius,this._geoRadialSegments,this._geoAngle,this._geoClosed);this._materialStore&&(this.defaultGeoMat=this._materialStore.getAll().modelLineMaterial._material());const i=new Fi(t,this.defaultGeoMat);this.mesh=i,this.name&&(this.mesh.name=this.name),this._parent&&this._parent.add(this.mesh),this._meshType="tubeGeometry",this._hightLight&&Ep.effectStore.highlightObject(this.mesh)}}set geoTubularSegments(e){this.mesh?"Mesh"==this.mesh.type?(this._geoTubularSegments=e,this.mesh&&this.mesh.geometry.parameters&&(this.mesh.geometry.parameters.tubularSegments=this._geoTubularSegments),this.curveUpdate()):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get geoTubularSegments(){return this._geoTubularSegments}set geoRadius(e){this.mesh?"Mesh"==this.mesh.type?(this._geoRadius=e,this.mesh&&this.mesh.geometry.parameters&&(this.mesh.geometry.parameters.radius=this._geoRadius),this.curveUpdate()):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get geoRadius(){return this._geoRadius}set geoRadialSegments(e){this.mesh?"Mesh"==this.mesh.type?(this._geoRadialSegments=e,this.mesh&&this.mesh.geometry.parameters&&(this.mesh.geometry.parameters.radialSegments=this._geoRadialSegments),this.curveUpdate()):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get geoRadialSegments(){return this._geoRadialSegments}set geoClosed(e){this.mesh?"Mesh"==this.mesh.type?(this._geoClosed=e,this.mesh&&this.mesh.geometry.parameters&&(this.mesh.geometry.parameters.closed=this._geoClosed),this.curveUpdate()):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get geoClosed(){return this._geoClosed}set geoAngle(e){this.mesh?"Mesh"==this.mesh.type?(this._geoAngle=e,this.curveUpdate()):console.warn("应用不生效（当前属性不适用于该对象，请检查生成的对象）"):console.warn("还未创建对象，请检查创建的对象")}get geoAngle(){return this._geoAngle}clearGenerate(){this.mesh?(this._hightLight&&Ep.effectStore.cancleHighlightObject(this.mesh),this.mesh.parent&&(this._parent.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.mesh=null)):console.warn("没有生成的对象可以被清除")}tPOLMode(e=!0){3==this.HelperBoxArray.length?(this._TPOL=e,this.curveUpdate()):console.warn("两点一线模式必须得三个点才可以，请检查锚点数量")}tpolUpdate(){const e=this.HelperBoxArray[0].position,t=this.HelperBoxArray[2].position,i={x:(e.x+t.x)/2,y:(e.y+t.y)/2,z:(e.z+t.z)/2};this.HelperBoxArray[1].position.set(i.x,i.y+this._TPOLHeight,i.z)}set TPOL(e){this.tPOLMode(e)}get TPOL(){return this._TPOL}set TPOLHeight(e){1==this._TPOL?(this._TPOLHeight=e,this.curveUpdate()):console.warn("TPOL模式没打开")}get TPOLHeight(){return this._TPOLHeight}set SPL(e){this.spatialPolylineMode(e)}get SPL(){return this._SPL}set SPLStyle(e){this._SPLStyle=e,"RightAngleFacetsGeometry"==this._meshType&&(this.clearGenerate(),this.generateRightAngleFaceLine()),this.curveUpdate()}get SPLStyle(){return this._SPLStyle}spatialPolylineMode(e){4==this.HelperBoxArray.length||6==this.HelperBoxArray.length&&this._extend?(this._SPL=e,this.curveUpdate()):console.warn("SPL模式只能四个点才可以,请检查锚点数量")}spatialPolylineUpdate(){let e=this.HelperBoxArray[0].position;this.HelperBoxArray[1].position,this.HelperBoxArray[2].position;let t=this.HelperBoxArray[3].position;const i={p1:1,p2:2};this._extend&&(i.p1=2,i.p2=3,e=this.HelperBoxArray[1].position,t=this.HelperBoxArray[4].position),e.x==t.x&&(e.x+=.01,t.x-=.01),e.y==t.y&&(e.y+=.01,t.y-=.01),e.z==t.z&&(e.z+=.01,t.z-=.01),"XYZ"==this._SPLStyle?(this.HelperBoxArray[i.p1].position.set(t.x,e.y,e.z),this.HelperBoxArray[i.p2].position.set(t.x,t.y,e.z)):"XZY"==this._SPLStyle?(this.HelperBoxArray[i.p1].position.set(t.x,e.y,e.z),this.HelperBoxArray[i.p2].position.set(t.x,e.y,t.z)):"YXZ"==this._SPLStyle?(this.HelperBoxArray[i.p1].position.set(e.x,t.y,e.z),this.HelperBoxArray[i.p2].position.set(t.x,t.y,e.z)):"YZX"==this._SPLStyle?(this.HelperBoxArray[i.p1].position.set(e.x,t.y,e.z),this.HelperBoxArray[i.p2].position.set(e.x,t.y,t.z)):"ZYX"==this._SPLStyle?(this.HelperBoxArray[i.p1].position.set(e.x,e.y,t.z),this.HelperBoxArray[i.p2].position.set(e.x,t.y,t.z)):"ZXY"==this._SPLStyle&&(this.HelperBoxArray[i.p1].position.set(e.x,e.y,t.z),this.HelperBoxArray[i.p2].position.set(t.x,e.y,t.z)),this._extend&&this.updateExtendDistance()}startObject(e){this._startObject=e,this.curveUpdate()}finalObject(e){this._finalObject=e,this.curveUpdate()}updateBindPos(){let e=0;if(this._extend&&(e=1),this._startObject){const t=new Ce;this._startObject.getWorldPosition(t),this.HelperBoxArray[0+e].position.copy(t.clone().add(this.startPosOffset))}if(this._finalObject){const t=new Ce;this._finalObject.getWorldPosition(t);const i=this.HelperBoxArray.length;this.HelperBoxArray[i-1-e].position.copy(t.clone().add(this.finalPosOffset))}}getCenter(e){const t=new Re;return this.curve.mesh.geometry.computeBoundingBox(),t.copy(this.curve.mesh.geometry.boundingBox).applyMatrix4(this.curve.mesh.matrixWorld),t.getCenter(e)}getCenter2(){this.curve.updateArcLengths();const e=new Ce;return this.curve.getPoint(.5,e),e}set extendLength(e){this._extendLength=e}get extendLength(){return this._extendLength<1e-4?0:this._extendLength}set extendLength(e){this._extendLength=e,this.curveUpdate()}get extendLength(){return this._extendLength}set extend(e){this.extendLineMode(e)}get extend(){return this._extend}extendLineMode(e=!0){if(this._SPL){if(1==e){const t=this.HelperBoxArray[0].position.clone(),i=this.HelperBoxArray[3].position.clone();this.addHelperBox(this.HelperBoxArray[0]),this.addHelperBox(this.HelperBoxArray[1]),this.HelperBoxArray[1].position.copy(t),this.HelperBoxArray[4].position.copy(i),this._extend=e}else if(0==e){this._extend=e;const t=this.HelperBoxArray[1].position.clone(),i=this.HelperBoxArray[4].position.clone();this.removeHelperBox(this.HelperBoxArray[0]),this.removeHelperBox(this.HelperBoxArray[1]),this.HelperBoxArray[0].position.copy(t),this.HelperBoxArray[3].position.copy(i)}this.curveUpdate()}else console.warn("请检查SPL模式是否开启")}updateExtendDistance(){if(0!=this._extendLength){const e=new Ce;e.subVectors(this.HelperBoxArray[1].position,this.HelperBoxArray[2].position).normalize(),e.multiplyScalar(this._extendLength),this.HelperBoxArray[0].position.copy(this.HelperBoxArray[1].position.clone().add(e));const t=new Ce;t.subVectors(this.HelperBoxArray[4].position,this.HelperBoxArray[3].position).normalize(),t.multiplyScalar(this._extendLength),this.HelperBoxArray[5].position.copy(this.HelperBoxArray[4].position.clone().add(t))}else this.HelperBoxArray[0].position.copy(this.HelperBoxArray[1].position),this.HelperBoxArray[5].position.copy(this.HelperBoxArray[4].position)}generateBox(){if(this.mesh)console.warn("已经有生成了几何体了，请清除当前生成的对象再试");else{const e=this.samplesNum,t=this.createCurveBox(2*e,10,10,e,10,10);this._materialStore&&(this.defaultGeoMat=this._materialStore.getAll().modelLineMaterial._material());const i=new Fi(t,this.defaultGeoMat);this.mesh=this.flowObject(i),this.name&&(this.mesh.name=this.name),this._parent&&this._parent.add(this.mesh),this._meshType="boxGeometry",this._hightLight&&Ep.effectStore.highlightObject(this.mesh)}}createCurveBox(e=10,t=10,i=10,n=1,a=1,r=1){return new Hi(e,t,i,n,a,r)}flowObject(e){const t=new nx(e);return t.updateCurve(0,this.curve),t.moveAlongCurve(.5),t.object3D}set meshLineSegment(e){this._meshLineSegment=e,this.mesh&&this.mesh.geometry.params&&(this.mesh.geometry.params.segment=this._meshLineSegment),this.curveUpdate()}get meshLineSegment(){return this._meshLineSegment}set meshLineWidth(e){this._meshLineWidth=e,this.mesh&&this.mesh.geometry.params&&(this.mesh.geometry.params.width=this._meshLineWidth),this.curveUpdate()}get meshLineWidth(){return this._meshLineWidth}set meshLineAngle(e){this._meshLineAngle=e,this.mesh&&this.mesh.geometry.params&&(this.mesh.geometry.params.angle=this._meshLineAngle),this.curveUpdate()}get meshLineAngle(){return this._meshLineAngle}set planeSizeView(e){this._planeSizeView=!e,this.mesh&&this.mesh.geometry.params&&(this.mesh.geometry.params.depth=this._planeSizeView),this.curveUpdate()}get planeSizeView(){return this._planeSizeView}generateMeshPlane(){if(this.mesh)console.warn("已经有生成了几何体了，请清除当前生成的对象再试");else{const e=new rx(this.curve,this._meshLineSegment,this._meshLineWidth,!1,this.getCenter(),this._planeSizeView,this._vertical);this._materialStore&&(this.defaultGeoMat=this._materialStore.getAll().modelLineMaterial._material().clone(),this.defaultGeoMat.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("void main() {",["attribute float sizeView;","attribute vec3 centers;","attribute vec3 modelCenter;","void main() {"].join("\n")),e.vertexShader=e.vertexShader.replace("#include <fog_vertex>",["#include <fog_vertex>","if(sizeView==1.){","float dis=distance(cameraPosition,modelCenter);","dis/=100.;","vec3 nor=position-centers;","vec3 pos=nor*dis;"," gl_Position=projectionMatrix*modelViewMatrix*vec4(position+pos,1.);","}"].join("\n"))});const t=new Fi(e,this.defaultGeoMat);this.mesh=t,this.name&&(this.mesh.name=this.name),this.mesh.type="faceMesh",this._parent&&this._parent.add(this.mesh),this._meshType="faceGeometry",this._hightLight&&Ep.effectStore.highlightObject(this.mesh)}}updateMeshPlaneMat(){this._materialStore&&(this.defaultGeoMat=this._materialStore.getAll().modelLineMaterial._material()),this.mesh.material=this.defaultGeoMat}usePoint(e){this.HelperBoxArray.map((e=>{this.HelperBoxGroup.remove(e),e.geometry.dispose(),e.material.dispose(),e=null})),this.HelperBoxArray.splice(0),this.curve.points.splice(0);for(let t=0,i=e.length;t<i;t++){const i=new Ce(e[t][0],e[t][1],e[t][2]),n=this.createHelperBox(i);this.curve.points.push(n.position)}this.curveUpdate()}addLabel(e,t,i){const n=document.createElement("canvas");n.width=1024,n.height=960;const a=n.getContext("2d");a.font="200px Georgia",a.fillText(e,0,n.height/3);const r=new vs(n),s=new vr({map:r}),o=new Or(s);return t&&o.position.copy(t),this.labelGroup.add(o),o.scale.setScalar(10),"function"==typeof i&&i(o),o}addLabel2(e,t=this.getCenter2(),i=this.name){const n=new vs(e),a=new vr({map:n,sizeAttenuation:!1,depthTest:Ep.drawableDepthTest,depthWrite:Ep.drawableDepthTest}),r=new Or(a);r.name=i,t&&r.position.set(t.x,t.y,t.z),this.labelGroup.add(r);const s=414e-6*e.width,o=414e-6*e.height;return r.scale.set(s,o,1),"function"==typeof callback&&callback(r),console.log("标签创建完成",r),this.sprite=r}updateLabel2(e,t){if(this.sprite){this.sprite.material.map=new vs(e),this.sprite.material.needsUpdate=!0;const i=414e-6*e.width,n=414e-6*e.height;this.sprite.scale.set(i,n,1),t&&this.sprite.position.copy(t),console.log("标签更新完成")}}destoryLabel(){this.sprite&&(this.labelGroup.remove(this.sprite),this.sprite.material.dispose(),this.sprite=null)}set vectorLineWidth(e){this._vectorLineWidth=10*e,this.vectorLineMat.lineWidth=this._vectorLineWidth}get vectorLineWidth(){return this._vectorLineWidth/10}set vectorLineSegment(e){this._vectorLineSegment=e,this.mesh&&(this.mesh.geometry._segment=this._vectorLineSegment),this.curveUpdate()}get vectorLineSegment(){return this._vectorLineSegment}generateVecLine(){if(this.mesh)console.warn("已经有生成了几何体了，请清除当前生成的对象再试");else{const e=new ox(this.curve,this._vectorLineSegment);if(this._materialStore){const e=this._materialStore.getAll().modelLineMaterial._material();e.map?(this.vectorLineMat.useMap=!0,this.vectorLineMat.needsUpdate=!0):this.vectorLineMat.useMap=!1,e.alphaMap&&(this.vectorLineMat.useAlphaMap=!0,this.vectorLineMat.alphaMap=e.alphaMap),this.vectorLineMat.map=e.map,this.vectorLineMat.color=e.color,this.vectorLineMat.opacity=e.opacity,this.vectorLineMat.transparent=e.transparent}const t=new Fi(e,this.vectorLineMat);this.mesh=t,this.name&&(this.mesh.name=this.name),this.mesh.type="vectorLine",this._parent&&this._parent.add(this.mesh),this._meshType="vectorLineGeometry",this._hightLight&&Ep.effectStore.highlightObject(this.mesh)}}updateVectorMat(){if(this._materialStore){const e=this._materialStore.getAll().modelLineMaterial._material();e.map?(this.vectorLineMat.useMap=!0,this.vectorLineMat.needsUpdate=!0):this.vectorLineMat.useMap=!1,e.alphaMap&&(this.vectorLineMat.useAlphaMap=!0,this.vectorLineMat.alphaMap=e.alphaMap),this.vectorLineMat.map=e.map,this.vectorLineMat.color=e.color,this.vectorLineMat.opacity=e.opacity,this.vectorLineMat.transparent=e.transparent}this.mesh.material=this.vectorLineMat}computeOneLine(e,t){const i=t.clone().sub(e);i.normalize(),i.x=Math.abs(i.x),i.y=Math.abs(i.y),i.z=Math.abs(i.z);const n=new Ce(0,0,1),a=new Ce(0,1,0),r=new Ce(1,0,0);return!!(i.equals(n)||i.equals(a)||i.equals(r))}generateRightAngleFaceLine(){if(this._SPL)if(this.mesh)console.warn("已经有生成了几何体了，请清除当前生成的对象再试");else{const e=[];for(let t=0;t<this.HelperBoxArray.length;t++)e.push(this.HelperBoxArray[t].position);let t;if(this.computeOneLine(e[0],e[this.HelperBoxArray.length-1])){const i=[e[0],e[this.HelperBoxArray.length-1]],n=new pl(i);n.curveType="catmullrom",t=new rx(n,2,this._rightAngleWidth,0,!1)}else t=new cx(e,this._rightAngleWidth,this._SPLStyle,this._rightAngleType);this._materialStore&&(this.defaultGeoMat=this._materialStore.getAll().modelLineMaterial._material());const i=new Fi(t,this.defaultGeoMat);this.mesh=i,this.name&&(this.mesh.name=this.name),this.mesh.type="rightAngleLine",this._parent&&this._parent.add(this.mesh),this._meshType="RightAngleFacetsGeometry",this._hightLight&&Ep.effectStore.highlightObject(this.mesh)}else console.warn("请开启SPL模式")}updateRightAngleLineMat(){this._materialStore&&(this.defaultGeoMat=this._materialStore.getAll().modelLineMaterial._material()),this.mesh.material=this.defaultGeoMat}set RightAngleWidth(e){this._rightAngleWidth=e,this.mesh&&(this.mesh.geometry._width=this._rightAngleWidth),this.curveUpdate()}get RightAngleWidth(){return this._rightAngleWidth}set RightAngleType(e){this._rightAngleType=e,"vertical"==this._rightAngleType?this._vertical=!0:"transverse"==this._rightAngleType&&(this._vertical=!1),this.mesh&&(this.mesh.geometry.vecTo=this._rightAngleType),"faceGeometry"==this._meshType&&(this.clearGenerate(),this.generateMeshPlane()),this.curveUpdate()}get RightAngleType(){return this._rightAngleType}initControlPanel(){this.gui=new N_,this.gui.add(this,"EditMode").name("自由编辑模式").onChange((t=>{e.closed=1-t}));let e=this.gui.addFolder("线编辑器(自由编辑模式打开的时候使用)");e.add(this,"addHelperBox").name("添加锚点"),e.add(this,"removeHelperBox").name("删除锚点"),e.add(this,"tension",0,1).name("tension"),e.add(this,"closed").name("是否闭合"),e.add(this,"curveType",["centripetal","chordal","catmullrom"]).name("曲线类型"),e.closed=!1;const t=e.addFolder("偏移模式"),i=t.addFolder("起点偏移");i.add(this.startPosOffset,"x").name("x"),i.add(this.startPosOffset,"y").name("y"),i.add(this.startPosOffset,"z").name("z");const n=t.addFolder("终点偏移");n.add(this.finalPosOffset,"x").name("x"),n.add(this.finalPosOffset,"y").name("y"),n.add(this.finalPosOffset,"z").name("z"),this.gui.add(this,"TPOL").name("两点一线模式"),this.gui.add(this,"TPOLHeight",-50,50).name("两点一线模式高度"),this.gui.add(this,"SPL").name("SPL模式"),this.gui.add(this,"SPLStyle",["XYZ","XZY","YXZ","YZX","ZYX","ZXY"]).name("SPL样式"),this.gui.add(this,"extend").name("延长线模式"),this.gui.add(this,"extendLength",0,100).name("延长距离"),this.gui.add(this,"generateFatLine").name("生成宽度线");let a=this.gui.addFolder("宽度线调整面板");a.add(this,"lineLineWidth",0,.2,.01).name("线宽"),a.add(this,"lineDashed").name("虚线显示"),a.add(this,"lineDashScale",0,1,.01).name("虚线大小"),this.gui.add(this,"generateGeometry").name("生成几何管道");let r=this.gui.addFolder("几何体调整面板");r.add(this,"geoTubularSegments",1,1e3,1).name("几何管道分段"),r.add(this,"geoRadius",1,50).name("几何体半径"),r.add(this,"geoRadialSegments",1,100,1).name("几何体半径分段"),r.add(this,"geoAngle",0,2*Math.PI).name("几何体旋转"),r.add(this,"geoClosed").name("几何体闭合"),this.gui.add(this,"generateBox").name("生成方块几何体"),this.gui.add(this,"generateMeshPlane").name("面片线");let s=this.gui.addFolder("面片线调整面板");s.add(this,"meshLineSegment",1,500,1).name("面片线细分"),s.add(this,"meshLineWidth",0,20).name("面片线宽度"),s.add(this,"planeSizeView").name("面片线近大远小"),s.add(this,"meshLineAngle",-180,180).name("面片线旋转角度"),this.gui.add(this,"generateVecLine").name("生成模型矢量线");const o=this.gui.addFolder("模型矢量线");o.add(this.vectorLineMat,"lineWidth",0,200).name("线宽"),o.addColor(this.vectorLineMat,"color").name("颜色"),o.add(this.vectorLineMat,"opacity",0,1).name("透明度"),o.add(this.vectorLineMat,"sizeAttenuation").name("近大远小"),this.gui.add(this,"generateRightAngleFaceLine").name("生成直角拐角线");const l=this.gui.addFolder("直角拐角线参数");l.add(this,"RightAngleWidth",0,10).name("线宽"),l.add(this,"RightAngleType",["vertical","transverse"]).name("方向类型"),this.gui.add(this,"clearGenerate").name("清除生成的对象")}destroyPanel(){this.gui&&this.gui.destroy()}set showControlPanel(e){this._showGui=e,1==this._showGui?this.gui||(this.initControlPanel(),document.getElementsByClassName("dg ac")[0].style.zIndex=1e5):0==this._showGui&&this.destroyPanel()}get showControlPanel(){return this._showGui}destroy(){this.HelperBoxGroup&&(this.HelperBoxGroup.parent&&this.HelperBoxGroup.parent.remove(this.HelperBoxGroup),this.HelperBoxGroup.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.material.dispose(),e=null}))),this.HelperBoxGroup=null,this.curve.mesh.parent&&(this.curve.mesh.parent.remove(this.curve.mesh),this.curve.mesh=null),this.mesh&&this.mesh.parent&&(this.mesh.parent.remove(this.mesh),this.mesh=null),this.labelGroup&&(this.labelGroup.parent.remove(this.labelGroup),this.sprite&&(this.labelGroup.remove(this.sprite),this.sprite.material.dispose())),this._parent=null}}class ux extends ev{constructor(e,t,i,n="core"){super("LineItem"),this.name=e.name||"line",this.isLineItem=!0,this.type="LineItem",this.parentUUID=i.uuid,this.isVisible=!0,this.materialStore=new Eb(Ep.textureStore,Ep.instance),this.articulations=[],this.articulationAnimations=[],this._connectType="straight",this._styleType="geometryLine",this._lineStyle="样式A",this._startModelUUID=null,this._finalModelUUID=null,this._startParentModelUUID=null,this._finalParentModelUUID=null,this._finalOffset={x:0,y:0,z:0},this._startOffset={x:0,y:0,z:0},this._lastStartUUID=null,this._lastFinalUUID=null,this._smoothness=10,this._radius=1,this._extendRide=0,this.index=e.index?e.index:void 0,this.zoom=!0,this.restoreMaterial=null,this._sizeView=!1;let a=i;this.getParent=()=>a,this.setParent=e=>{e&&(a=e)};let r=null;this.addModelLine=e=>{r=new hx(this.getParent()),r.name=e,r.EditMode=!1},this.addModelLine(this.name),this.getModelLine=()=>r,this._color="green",this.paramsModelLine(),this.getGroup=()=>this.getModelLine().curve.mesh,this.getModelLine().TPOL=!0;const s=this.getModelLine().mesh;this.materialStore.add(s.material.name,s.material,s,this.name),this.updateMaterial(),e.materials||"interface"==e.used?t&&t(1,this):(t&&t(1,this),this.setDefaultMaterial((()=>{}))),this.show=()=>{this.getModelLine().mesh.visible=!0,this.getModelLine().labelGroup.visible=!0,this.isVisible=!0},this.hide=()=>{this.getModelLine().mesh.visible=!1,this.getModelLine().labelGroup.visible=!1,this.edit=!1,this.isVisible=!1},e&&this.applySetting(e)}initRestoreMaterial(){Ep.instance.customTextureStore.loadTexture({url:_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),name:"__AVW__FLOW_LIGHT_TEXTURE",onLoad:e=>{if(e){const e=new Eb(Ep.textureStore,Ep.instance);let t=JSON.parse(JSON.stringify({modelLineMaterial:{name:"modelLineMaterial",type:"metalness",mapType:"metalness",color:"#FF0000",map:{_name:"",_type:"imagebitmap",_source:"",_intensity:1},mapIntensit:1,metalnessMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},metalnessIntensity:0,roughnessMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},roughnessIntensity:1,enableSpecularMap:!0,specularMapType:"envmap",specularMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},specularMapIntensity:.2,enableNormalMap:!1,normalMapType:"bump",normalMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},normalMapIntensity:1,enableDisplacement:!1,displacementMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},displacementIntensity:1,enableOpacity:!1,opacityType:"blend",opacityMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},opacityIntensity:1,opacityInverted:!1,enableEmissive:!0,emissiveMap:{_name:"grd.png",_type:"imagebitmap",_source:{_id:"797DC8C5-6FE5-4D53-A86D-B4421281CB98",_name:"grd.png",_type:"imagebitmap",_textureSource:{},_wrapS:1e3,_wrapT:1e3,sourceModelKey:"2c353dc77d8b83925b41e2a097002890"},_intensity:1,color:"#FFF783",_color:"#FFF783"},emissiveIntensity:2,emissiveMapColor:"#FFF783",enableClearcoat:!1,clearcoatMap:{_name:"",_type:"color",_source:"",_intensity:1,color:null,_color:null},clearcoatColor:null,clearcoatThickness:0,clearcoatNormalMap:{_name:"",_type:"color",_source:"",_intensity:1},clearcoatNormalMapFlipY:!1,clearcoatNormalScale:1,clearcoatRoughness:0,clearcoatRoughnessMap:{_name:"",_type:"color",_source:"",_intensity:1},enableAOMap:!1,aoMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},aoMapIntensity:1,enableLightMap:!1,lightMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},lightMapIntensity:1,enableUV:!1,repeatU:1,repeatV:1,offsetU:0,offsetV:0,enableTranslation:!0,translationSpeedU:0,translationSpeedV:.2,enableSSR:!1,envMapIntensity:1,side:2,depth:2,waterFlowSpeed:.25,waterOffsetY:0,waterColor:"#001e0f",waterReflectionAutoUpdate:!0,waterReflectionQuality:512,waterOpacity:.65,waterReflectionRate:1,waterWave:3.7,polygonOffset:!1,polygonOffsetFactor:0,polygonOffsetUnits:0,resourceBasePath:"./lib/scene/",modelName:"LineTest"}}));t.modelLineMaterial.emissiveMap._name=_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),t.modelLineMaterial.emissiveMap._source._name=_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),t.modelLineMaterial.modelName=this.name,e.applySettings(t),this.restoreMaterial=e.getAll().modelLineMaterial._material().clone()}}})}usePoint(e){e&&this.getModelLine().usePoint(e)}rename(e){this.name=e}paramsModelLine(){this.getModelLine().curveUpdate(),this.styleType=this._styleType}computePosCombine(){if(this._startModelUUID&&this._finalModelUUID){let e=this.getModelByUUID(this._startModelUUID),t=this.getModelByUUID(this._finalModelUUID),i=e.getWorldPosition(),n=t.getWorldPosition();return i.x==n.x||i.y==n.y||i.z==n.z}return console.warn("当前未绑定任意模型，请检查绑定设置"),null}set connectType(e){this._connectType=e,"norm"==this._connectType?3==this.getModelLine().HelperBoxArray.length&&(this.getModelLine().tension=0,this.getModelLine().TPOL=!1,this.getModelLine().beClickObject=this.getModelLine().HelperBoxArray[1],this.getModelLine().addHelperBox(),this.getModelLine().SPL=!0,this.getModelLine().extend=!0,this.styleType=this._styleType,this.getModelLine().geoTubularSegments=300,this.computePosCombine()):"straight"==this._connectType&&(4==this.getModelLine().HelperBoxArray.length||6==this.getModelLine().HelperBoxArray.length&&this.getModelLine()._extend)&&(this.getModelLine().extend=!1,this.getModelLine().tension=.5,this.getModelLine().beClickObject=this.getModelLine().HelperBoxArray[1],this.styleType=this._styleType,this.getModelLine().SPL=!1,this.getModelLine().removeHelperBox(),this.getModelLine().TPOL=!0,this.smoothness=this._smoothness),this.extendRide=this._extendRide,this._canvas&&this.updateLable(this._canvas)}get connectType(){return this._connectType}set edit(e){this.getModelLine().EditMode=e}get edit(){return this.getModelLine().EditMode}set styleType(e){this._styleType=e,this.getModelLine().mesh&&this.getModelLine().clearGenerate(),"geometryLine"==this._styleType?(this.getModelLine().generateGeometry(),"norm"==this._connectType?this.getModelLine().geoTubularSegments=300:this.smoothness=this._smoothness):"vectorLine"==this._styleType?(this.getModelLine().generateVecLine(),"norm"==this._connectType?this.getModelLine().vectorLineSegment=300:this.smoothness=this._smoothness):"faceLine"==this._styleType&&("norm"==this._connectType?this.getModelLine().generateRightAngleFaceLine():"straight"==this._connectType&&this.getModelLine().generateMeshPlane(),this.smoothness=this._smoothness),this.getModelLine().mesh.name=this.name,this.radius=this._radius,this._canvas&&this.updateLable(this._canvas)}get styleType(){return this._styleType}set angle(e){this.getModelLine().geoAngle=e}get angle(){return this.getModelLine().geoAngle}set lineStyle(e){this._lineStyle=e}get lineStyle(){return this._lineStyle}getModelByUUID(e){return this.getParent().getObjectByProperty("uuid",e)}getModelByName(e){return this.getParent().getObjectByName(e)}clearLineItemID(e){if(e){const t=this.getModelByUUID(e);if(t&&t._LineItemID)if(t._LineItemID instanceof Array)if(t._LineItemID.length>1){const e=t._LineItemID.indexOf(this.getGroup().uuid);t._LineItemID.splice(e,1)}else t._LineItemID[0]==this.getGroup().uuid&&(t._LineItemID=null);else t._LineItemID=null}}setLineItemID(e){if(e._LineItemID){if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.push(this.getGroup().uuid);else{const t=e._LineItemID;e._LineItemID=[],e._LineItemID.push(t,this.getGroup().uuid)}}else e._LineItemID=this.getGroup().uuid}set startObject(e){let t;this.clearLineItemID(this._lastStartUUID),this._startParentModelUUID=e.parentNode,this._startModelUUID=e.chooseNode,this._lastStartUUID=this._startModelUUID,this._startModelUUID&&(t=this.getModelByUUID(this._startModelUUID)),t&&(this.setLineItemID(t),this.getModelLine().startObject(t))}get startObject(){const e=this.getModelByUUID(this._startModelUUID);let t=null;e&&(t=e.name);let i=null;const n=this.getModelByUUID(this._startParentModelUUID);return n&&(i=n.name),{parentNode:i,chooseNode:t}}set finalObject(e){let t;this.clearLineItemID(this._lastFinalUUID),this._finalParentModelUUID=e.parentNode,this._finalModelUUID=e.chooseNode,this._lastFinalUUID=this._finalModelUUID,this._finalModelUUID&&(t=this.getModelByUUID(this._finalModelUUID)),t&&(this.setLineItemID(t),this.getModelLine().finalObject(t))}get finalObject(){const e=this.getModelByUUID(this._finalModelUUID);let t=null;e&&(t=e.name);let i=null;const n=this.getModelByUUID(this._finalParentModelUUID);return n&&(i=n.name),{parentNode:i,chooseNode:t}}set startOffset(e){this._startOffset.x=e.x,this._startOffset.y=e.y,this._startOffset.z=e.z,this.getModelLine().startPosOffset.set(this._startOffset.x,this._startOffset.y,this._startOffset.z),this.update()}get startOffset(){return this._startOffset}set finalOffset(e){this._finalOffset.x=e.x,this._finalOffset.y=e.y,this._finalOffset.z=e.z,this.getModelLine().finalPosOffset.set(this._finalOffset.x,this._finalOffset.y,this._finalOffset.z),this.update()}get finalOffset(){return this._finalOffset}set sectionAccuracy(e){this.getModelLine().geoRadialSegments=e,this.getModelLine().geoAngle=4==e?Math.PI/4:0}get sectionAccuracy(){return this.getModelLine().geoRadialSegments}set radius(e){this._radius=e,"Line2"==this.getModelLine().mesh.type?this.getModelLine().lineLineWidth=this._radius/50:"faceMesh"==this.getModelLine().mesh.type?this.getModelLine().meshLineWidth=this._radius:"vectorLine"==this.getModelLine().mesh.type?this.getModelLine().vectorLineWidth=this._radius:"rightAngleLine"==this.getModelLine().mesh.type?this.getModelLine().RightAngleWidth=this._radius:this.getModelLine().geoRadius=this._radius}get radius(){return this._radius}set rightAngleWay(e){this.getModelLine().RightAngleType=e,this.getModelLine().curveUpdate()}get rightAngleWay(){return this.getModelLine().RightAngleType}set curvature(e){this.getModelLine().TPOLHeight=e}get curvature(){return this.getModelLine().TPOLHeight}set smoothness(e){this._smoothness=e,"faceMesh"==this.getModelLine().mesh.type?this.getModelLine().meshLineSegment=this._smoothness:"vectorLine"==this.getModelLine().mesh.type?this.getModelLine().vectorLineSegment=this._smoothness:this.getModelLine().geoTubularSegments=this._smoothness}get smoothness(){return this._smoothness}get center(){return this.getModelLine().getCenter2()}get sizeView(){return this._sizeView}set sizeView(e){this._sizeView=e,this._sizeView?(this.getModelLine().planeSizeView=!0,this.getModelLine().vectorLineMat.sizeAttenuation=!0):(this.getModelLine().planeSizeView=!1,this.getModelLine().vectorLineMat.sizeAttenuation=!1),this.getModelLine().curveUpdate()}update(){this.getModelLine().curveUpdate(),this.getModelLine().sprite&&this.updateLable(this._canvas),this.isVisible?this.show():this.hide()}updateMaterial(){this.getModelLine().setDefaultMat(this.materialStore)}applySetting(e,t){if(e.unuseParent){if(e.startObject&&e.startObject.parentNode){const t=this.getModelByName(e.startObject.parentNode);t&&(e.startObject.parentNode=t.uuid);const i=this.getModelByName(e.startObject.chooseNode);i&&(e.startObject.chooseNode=i.uuid)}if(e.finalObject){const t=this.getModelByName(e.finalObject.parentNode);t&&(e.finalObject.parentNode=t.uuid);const i=this.getModelByName(e.finalObject.chooseNode);i&&(e.finalObject.chooseNode=i.uuid)}}else e.startObject&&e.startObject.parentNode&&e.startObject.chooseNode&&this.getParent().traverse((t=>{t.name==e.startObject.chooseNode&&t.parent.name==e.startObject.parentNode&&(e.startObject.parentNode=t.parent.uuid,e.startObject.chooseNode=t.uuid)})),e.finalObject&&e.finalObject.parentNode&&e.finalObject.chooseNode&&this.getParent().traverse((t=>{t.name==e.finalObject.chooseNode&&t.parent.name==e.finalObject.parentNode&&(e.finalObject.parentNode=t.parent.uuid,e.finalObject.chooseNode=t.uuid)}));e.isVisible&&(e.isVisible?this.show():this.hide()),e.type&&(e.type="LineItem");let i=this.index;Object.assign(this,e),this.index=i,e.materials&&(this.materialStore.applySettings(e.materials),this.getModelLine().curveUpdate()),this.getModelLine().mesh&&(this.getModelLine().mesh.name=this.name),"function"==typeof t&&t(this),this._canvas?(this.updateLable(e.canvas),this._canvas=e.canvas):this.addLable(e.canvas)}set color(e){this._color=e,this.getModelLine().mesh.material.color=new Qt(this._color),this.getModelLine().mesh.material.needsUpdate=!0}get color(){return this._color}set SPLStyle(e){this.getModelLine().SPLStyle=e}get SPLStyle(){return this.getModelLine().SPLStyle}set extendRide(e){this._extendRide=e,0==e&&(e+=1e-6),this.getModelLine().extendLength=e}get extendRide(){return this._extendRide}getMaterials(){return this.materialStore.getAll()}addArticulation({type:e,name:t,values:i,defaultValue:n}){let a=new J_({type:e,name:t,values:i,defaultValue:n});a.isValid()&&(a.getModelNode=()=>this.getModelLine().mesh,a.getModelItem=()=>this,a._type=a.getType(),a._name=a.getName(),a._values=a.getValues(),a._defaultValue=a.getDefaultValue(),this.articulations.push(a))}deleteArticulation(e){let t=this.articulations.findIndex((t=>t.name==e));this.articulations[t].deleteArticulation(),this.articulations.splice(t,1)}findMaterial(e){return this.materialStore.find(e)}highlight(){this.edit=!0,this.getModelLine().highLight=!0}cancleHighlight(){this.edit=!1,this.getModelLine().highLight=!1}useTexture(e,t=!1){if(e){const i=(new al).load(e,(e=>{e.wrapS=e.wrapT=d,e.repeat.set(5,1),e.rotation=Math.PI/2}));this.getModelLine().mesh.material.map=i,this.getModelLine().mesh.material.transparent=t,this._color&&(this.color=this._color),this.getModelLine().mesh.material.needsUpdate=!0}}useAlphaTexture(e,t=!1){if(e){const i=(new al).load(e,(e=>{e.wrapS=e.wrapT=d,e.repeat.set(5,1),e.rotation=Math.PI/2}));this.getModelLine().mesh.material.alphaMap=i,this.getModelLine().mesh.material.transparent=t,this._color&&(this.color=this._color),this.getModelLine().mesh.material.needsUpdate=!0}}addLable(e){if(e){this._canvas=e;const t=this.center;this.getModelLine().addLabel2(e,t,this.name)}}updateLable(e){if(e)if(this._canvas){const t=this.center;this.getModelLine().updateLabel2(e,t)}else this.addLable(e);else this._canvas&&(this.getModelLine().destoryLabel(),this._canvas=null)}getDefaultMaterialSetting(){let e={modelLineMaterial:{name:"modelLineMaterial",type:"metalness",mapType:"metalness",color:"#FF0000",map:{_name:"",_type:"imagebitmap",_source:"",_intensity:1},mapIntensit:1,metalnessMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},metalnessIntensity:0,roughnessMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},roughnessIntensity:1,enableSpecularMap:!0,specularMapType:"envmap",specularMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},specularMapIntensity:.2,enableNormalMap:!1,normalMapType:"bump",normalMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},normalMapIntensity:1,enableDisplacement:!1,displacementMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},displacementIntensity:1,enableOpacity:!1,opacityType:"blend",opacityMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},opacityIntensity:1,opacityInverted:!1,enableEmissive:!0,emissiveMap:{_name:"grd.png",_type:"imagebitmap",_source:{_id:"797DC8C5-6FE5-4D53-A86D-B4421281CB98",_name:"grd.png",_type:"imagebitmap",_textureSource:{},_wrapS:1e3,_wrapT:1e3,sourceModelKey:"2c353dc77d8b83925b41e2a097002890"},_intensity:1,color:"#FFF783",_color:"#FFF783"},emissiveIntensity:2,emissiveMapColor:"#FFF783",enableClearcoat:!1,clearcoatMap:{_name:"",_type:"color",_source:"",_intensity:1,color:null,_color:null},clearcoatColor:null,clearcoatThickness:0,clearcoatNormalMap:{_name:"",_type:"color",_source:"",_intensity:1},clearcoatNormalMapFlipY:!1,clearcoatNormalScale:1,clearcoatRoughness:0,clearcoatRoughnessMap:{_name:"",_type:"color",_source:"",_intensity:1},enableAOMap:!1,aoMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},aoMapIntensity:1,enableLightMap:!1,lightMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},lightMapIntensity:1,enableUV:!1,repeatU:1,repeatV:1,offsetU:0,offsetV:0,enableTranslation:!0,translationSpeedU:0,translationSpeedV:.2,enableSSR:!1,envMapIntensity:1,side:2,depth:2,waterFlowSpeed:.25,waterOffsetY:0,waterColor:"#001e0f",waterReflectionAutoUpdate:!0,waterReflectionQuality:512,waterOpacity:.65,waterReflectionRate:1,waterWave:3.7,polygonOffset:!1,polygonOffsetFactor:0,polygonOffsetUnits:0,resourceBasePath:"./lib/scene/",modelName:"LineTest"}};return e.modelLineMaterial.emissiveMap._name=_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),e.modelLineMaterial.emissiveMap._source._name=_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),e.modelLineMaterial.modelName=this.name,e}setDefaultMaterial(e){Ep.instance.customTextureStore.loadTexture({url:_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),name:"__AVW__FLOW_LIGHT_TEXTURE",onLoad:t=>{if(t){let t=JSON.parse(JSON.stringify({modelLineMaterial:{name:"modelLineMaterial",type:"metalness",mapType:"metalness",color:"#FF0000",map:{_name:"",_type:"imagebitmap",_source:"",_intensity:1},mapIntensit:1,metalnessMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},metalnessIntensity:0,roughnessMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},roughnessIntensity:1,enableSpecularMap:!0,specularMapType:"envmap",specularMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},specularMapIntensity:.2,enableNormalMap:!1,normalMapType:"bump",normalMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},normalMapIntensity:1,enableDisplacement:!1,displacementMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},displacementIntensity:1,enableOpacity:!1,opacityType:"blend",opacityMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},opacityIntensity:1,opacityInverted:!1,enableEmissive:!0,emissiveMap:{_name:"grd.png",_type:"imagebitmap",_source:{_id:"797DC8C5-6FE5-4D53-A86D-B4421281CB98",_name:"grd.png",_type:"imagebitmap",_textureSource:{},_wrapS:1e3,_wrapT:1e3,sourceModelKey:"2c353dc77d8b83925b41e2a097002890"},_intensity:1,color:"#FFF783",_color:"#FFF783"},emissiveIntensity:2,emissiveMapColor:"#FFF783",enableClearcoat:!1,clearcoatMap:{_name:"",_type:"color",_source:"",_intensity:1,color:null,_color:null},clearcoatColor:null,clearcoatThickness:0,clearcoatNormalMap:{_name:"",_type:"color",_source:"",_intensity:1},clearcoatNormalMapFlipY:!1,clearcoatNormalScale:1,clearcoatRoughness:0,clearcoatRoughnessMap:{_name:"",_type:"color",_source:"",_intensity:1},enableAOMap:!1,aoMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},aoMapIntensity:1,enableLightMap:!1,lightMap:{_name:"",_type:"color",_source:"#ffffff",_intensity:1},lightMapIntensity:1,enableUV:!1,repeatU:1,repeatV:1,offsetU:0,offsetV:0,enableTranslation:!0,translationSpeedU:0,translationSpeedV:.2,enableSSR:!1,envMapIntensity:1,side:2,depth:2,waterFlowSpeed:.25,waterOffsetY:0,waterColor:"#001e0f",waterReflectionAutoUpdate:!0,waterReflectionQuality:512,waterOpacity:.65,waterReflectionRate:1,waterWave:3.7,polygonOffset:!1,polygonOffsetFactor:0,polygonOffsetUnits:0,resourceBasePath:"./lib/scene/",modelName:"LineTest"}}));t.modelLineMaterial.emissiveMap._name=_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),t.modelLineMaterial.emissiveMap._source._name=_y.url(Ep.instance.resourceBasePath,"texture/line/grd.png"),t.modelLineMaterial.modelName=this.name,this.materialStore.applySettings(t),this.restoreMaterial=this.materialStore.getAll().modelLineMaterial._material().clone(),this.updateMaterial(),e&&e()}}})}getSettings(){let e=null;return this.restoreMaterial&&this.restoreMaterial.isMeshStandardMaterial&&(e=this.restoreMaterial.toJSON()),{id:this.getGroup().uuid,name:this.name,type:"LineItem",isLock:this._getLock(),isVisible:this.isVisible,index:this.index,startObject:this.startObject,finalObject:this.finalObject,startOffset:this.startOffset,finalOffset:this.finalOffset,sectionAccuracy:this.sectionAccuracy,radius:this._radius,curvature:this.curvature,smoothness:this.smoothness,SPLStyle:this.SPLStyle,materials:this.materialStore.getSettings(),articulations:this.articulations.map((e=>e.getSettings?e.getSettings():e)),extendRide:this.extendRide,articulationAnimations:[],zoom:this.zoom,rightAngleWay:this.rightAngleWay,sizeView:this.sizeView,lineStyle:this.lineStyle,connectType:this.connectType,styleType:this.styleType,restoreMaterial:e}}toJSON(){return this.getSettings()}destroy(){this._lastStartUUID&&this.clearLineItemID(this._lastStartUUID),this._lastFinalUUID&&this.clearLineItemID(this._lastFinalUUID),this.getModelLine().destroy(),this._canvas&&(this._canvas=null)}getObjectInfo(){let e={width:0,height:0,depth:0,size:0,faces:0,vertices:0,nodes:1,materials:1},t=new Re,i=this.getModelLine().mesh;return i?(t.setFromObject(i),e.width=(t.max.x-t.min.x).toFixed(3),e.height=(t.max.y-t.min.y).toFixed(3),e.depth=(t.max.z-t.min.z).toFixed(3),e.vertices=i.geometry.index.count,e.faces=e.vertices/3,e.materials=1):e.vertices=this.getModelLine().curve.mesh.geometry.attributes.position.count,e}}Ep.paperCutPlaneGeometryMap||(Ep.paperCutPlaneGeometryMap=new Map);let dx=e=>{let t,i;if(Ep.paperCutPlaneGeometryMap.has(e.map.image))t=Ep.paperCutPlaneGeometryMap.get(e.map.image);else{let i,n;"width"===(e.map.image.width>e.map.image.height?"width":"height")?(i=1,n=1/e.map.image.width*e.map.image.height):(i=1/e.map.image.height*e.map.image.width,n=1),t=new sn(i,n),t.translate(0,n/2,0),Ep.paperCutPlaneGeometryMap.set(e.map.image,t)}return i=e instanceof Kt?e:new Kt({color:e.color instanceof Qt?e.color:new Color(16777215),map:e.map,alphaMap:e.alphaMap,transparent:"boolean"!=typeof e.transparent||e.transparent,fog:"boolean"!=typeof e.fog||e.fog}),new Fi(t,i)};class px extends Et{constructor(e,t){super(),this.isPaperCut=!0,this.type="PaperCut",this._name="",this._faceCamera=!1,t&&t.faceCamera?(this.object3D=dx(e),this.object3D.onBeforeRender=function(){Ep.instance.nextRender((()=>{this.lookAt(Ep.camera.position)}))}):(this.object3D=dx(e),this.object3D.onBeforeRender=function(){Ep.instance.nextRender((()=>{if(Ep.camera&&Ep.camera.position){let e=this.getWorldPosition(new Ce);const t=Math.atan2(Ep.camera.position.x-e.x,Ep.camera.position.z-e.z);this.rotation.set(0,t,0)}}))}),this.object3D.name=this.name,this.add(this.object3D)}updateFace(){if(this.faceCamera)this.object3D.lookAt(Ep.camera.position);else if(Ep.camera&&Ep.camera.position){let e=this.object3D.getWorldPosition(new Ce);const t=Math.atan2(Ep.camera.position.x-e.x,Ep.camera.position.z-e.z);this.object3D.rotation.set(0,t,0)}}set faceCamera(e){if("boolean"!=typeof e||this._faceCamera===e)return;let t;e?(this.object3D=dx(this.object3D.material),this.object3D.onBeforeRender=function(){Ep.instance.nextRender((()=>{this.lookAt(Ep.camera.position)}))}):(t=dx(this.object3D.material),t.onBeforeRender=function(){if(Ep.camera&&Ep.camera.position){let e=this.getWorldPosition(new Ce);const t=Math.atan2(Ep.camera.position.x-e.x,Ep.camera.position.z-e.z);this.rotation.set(0,t,0)}}),this.remove(this.object3D),this.object3D=t,this.add(this.object3D),this._faceCamera=e}get faceCamera(){return this._faceCamera}set name(e){this._name=e,this.object3D&&(this.object3D.name=e)}get name(){return this._name}}var mx=Ug((function(e){var t=e.exports=function(e){return new i(e)};function i(e){this.value=e}function n(e,t,i){var n=[],s=[],h=!0;return function e(u){var d=i?a(u):u,p={},m=!0,f={node:d,node_:u,path:[].concat(n),parent:s[s.length-1],parents:s,key:n.slice(-1)[0],isRoot:0===n.length,level:n.length,circular:null,update:function(e,t){f.isRoot||(f.parent.node[f.key]=e),f.node=e,t&&(m=!1)},delete:function(e){delete f.parent.node[f.key],e&&(m=!1)},remove:function(e){o(f.parent.node)?f.parent.node.splice(f.key,1):delete f.parent.node[f.key],e&&(m=!1)},keys:null,before:function(e){p.before=e},after:function(e){p.after=e},pre:function(e){p.pre=e},post:function(e){p.post=e},stop:function(){h=!1},block:function(){m=!1}};if(!h)return f;function g(){if("object"==typeof f.node&&null!==f.node){f.keys&&f.node_===f.node||(f.keys=r(f.node)),f.isLeaf=0==f.keys.length;for(var e=0;e<s.length;e++)if(s[e].node_===u){f.circular=s[e];break}}else f.isLeaf=!0,f.keys=null;f.notLeaf=!f.isLeaf,f.notRoot=!f.isRoot}g();var y=t.call(f,f.node);return void 0!==y&&f.update&&f.update(y),p.before&&p.before.call(f,f.node),m?("object"!=typeof f.node||null===f.node||f.circular||(s.push(f),g(),l(f.keys,(function(t,a){n.push(t),p.pre&&p.pre.call(f,f.node[t],t);var r=e(f.node[t]);i&&c.call(f.node,t)&&(f.node[t]=r.node),r.isLast=a==f.keys.length-1,r.isFirst=0==a,p.post&&p.post.call(f,r),n.pop()})),s.pop()),p.after&&p.after.call(f,f.node),f):f}(e).node}function a(e){if("object"==typeof e&&null!==e){var t;if(o(e))t=[];else if("[object Date]"===s(e))t=new Date(e.getTime?e.getTime():e);else if(function(e){return"[object RegExp]"===s(e)}(e))t=new RegExp(e);else if(function(e){return"[object Error]"===s(e)}(e))t={message:e.message};else if(function(e){return"[object Boolean]"===s(e)}(e))t=new Boolean(e);else if(function(e){return"[object Number]"===s(e)}(e))t=new Number(e);else if(function(e){return"[object String]"===s(e)}(e))t=new String(e);else if(Object.create&&Object.getPrototypeOf)t=Object.create(Object.getPrototypeOf(e));else if(e.constructor===Object)t={};else{var i=e.constructor&&e.constructor.prototype||e.__proto__||{},n=function(){};n.prototype=i,t=new n}return l(r(e),(function(i){t[i]=e[i]})),t}return e}i.prototype.get=function(e){for(var t=this.value,i=0;i<e.length;i++){var n=e[i];if(!t||!c.call(t,n)){t=void 0;break}t=t[n]}return t},i.prototype.has=function(e){for(var t=this.value,i=0;i<e.length;i++){var n=e[i];if(!t||!c.call(t,n))return!1;t=t[n]}return!0},i.prototype.set=function(e,t){for(var i=this.value,n=0;n<e.length-1;n++){var a=e[n];c.call(i,a)||(i[a]={}),i=i[a]}return i[e[n]]=t,t},i.prototype.map=function(e){return n(this.value,e,!0)},i.prototype.forEach=function(e){return this.value=n(this.value,e,!1),this.value},i.prototype.reduce=function(e,t){var i=1===arguments.length,n=i?this.value:t;return this.forEach((function(t){this.isRoot&&i||(n=e.call(this,n,t))})),n},i.prototype.paths=function(){var e=[];return this.forEach((function(t){e.push(this.path)})),e},i.prototype.nodes=function(){var e=[];return this.forEach((function(t){e.push(this.node)})),e},i.prototype.clone=function(){var e=[],t=[];return function i(n){for(var s=0;s<e.length;s++)if(e[s]===n)return t[s];if("object"==typeof n&&null!==n){var o=a(n);return e.push(n),t.push(o),l(r(n),(function(e){o[e]=i(n[e])})),e.pop(),t.pop(),o}return n}(this.value)};var r=Object.keys||function(e){var t=[];for(var i in e)t.push(i);return t};function s(e){return Object.prototype.toString.call(e)}var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},l=function(e,t){if(e.forEach)return e.forEach(t);for(var i=0;i<e.length;i++)t(e[i],i,e)};l(r(i.prototype),(function(e){t[e]=function(t){var n=[].slice.call(arguments,1),a=new i(t);return a[e].apply(a,n)}}));var c=Object.hasOwnProperty||function(e,t){return t in e}}));class fx extends ev{constructor({name:e="untitled",index:t,parent:i,children:n,isVisible:a,isLock:r,transform:s,loadModel:o,floor:l,room:c,parentUUID:h},u,d,p){if(super("BuildingItem"),-1==e.indexOf("/")){this.name=e,this.children=[];var m=o||new sr;if(m.name=e,this.type="BuildingItem",this.parent=i,this.parentUUID=h,this.index=t,this.floor=l,this.room=c,this.transform=s||this.transform,m.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),m.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),m.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),o||u.add(m),this.getGroup=()=>m,this.addItem=e=>{this.children.push(e),this.children=this.children.sort(this.compare("level",!1))},this.compare=(e,t)=>(i,n)=>{var a=i[e],r=n[e];return t?a-r:r-a},this.setCut=(e,t)=>(this.level=e,this.room=t,!1),this.addFloor=(e,t,i)=>{!this.getItemByName(e.name)||e.loadModel?(e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isVisible=null==e.isVisible||e.isVisible,e.isLock=null!=e.isLock&&e.isLock,this.addItem(new Ex(e,m,t,i))):logger.warn(`当前位置已经存在名称为“${e.name}”的对象。`)},this.addNoneFloor=(e,t,i)=>{if(m.children.find((t=>t.name===e.name))&&!e.loadModel)return void logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`);e.index=this.children.length,e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isNoExcursion||(e=_y.changeTransformFromBuilding(e,m));let n=[];switch(e.type){case"ModelItem":new $_(e,((e,i,n)=>{this.addItem(n),t&&t(e,i,n)}),(t=>{i&&i({name:e.name,parent:this.name,loaded:t.loaded})}),m);break;case"PaintItem":let a=[],r=new ex(e);r.parent=this.name,n=[],e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,r)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":a.push(new Promise((t=>{new $_(e,((i,a,s)=>{_y.setArticulation(e,s),s.materialStore&&n.push({caller:s.materialStore,signatrue:"applySettings",args:[e.materials,r.name]}),t(1)}),(e=>{}),r)})));break;case"PaperCutItem":new Mx(e,r)._setLock(e.isLock)}}));let s=e.iconInstanced;for(let e=0;e<s.length;e++)new bb(s[e].assetObj,r,((t,i)=>{for(let t=0;t<s[e].points.length;t++){let n=JSON.parse(JSON.stringify(s[e].assetObj));n.transform.position.x=s[e].points[t][0],n.transform.position.y=s[e].points[t][1],n.transform.position.z=s[e].points[t][2],s[e].scales&&s[e].scales.length>t?n.transform.scale=s[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=s[e].settings[t].name,n.isVisible=s[e].settings[t].isVisible,n.isLock=s[e].settings[t].isLock;let a=new _b(n,i,s[e].settings[t].key,s[e].settings[t].index);i.children[t].name=n.name,r.childrenAdd(a),n.isVisible||(a.getGroup().visible=n.isVisible)}}));const o=e;if(r.pathBrushLinePoints)for(const e of r.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let l=e.modelInstanced,c=e;for(let e=0;e<l.length;e++)a.push(new Promise((t=>{new X_(l[e],r,((i,a)=>{for(let t=0;t<l[e].points.length;t++){let i=JSON.parse(JSON.stringify(l[e]));i.transform={position:{x:l[e].points[t][0],y:l[e].points[t][1],z:l[e].points[t][2]}},i.name=l[e].settings[t].name,i.isVisible=l[e].settings[t].isVisible,i.isLock=l[e].settings[t].isLock;let n=new _b(i,a,l[e].settings[t].key,l[e].settings[t].index);r.childrenAdd(n);const s=o.children.find((i=>"movingObject"===i.type&&i.instanced===a.name&&i.key===l[e].settings[t].key));if(s){const e=r.pathBrushLinePoints[s.lineIndex];e&&(n.createMovingAnimation(),n.movingAnimation.euler.set(s.euler.x,s.euler.y,s.euler.z),n.movingAnimation.startLength=s.startLength,n.movingAnimation.maxLength=s.maxLength,n.movingAnimation.reverse=s.reverse,n.movingAnimation.speed=s.speed,n.movingAnimation.useTangent=s.useTangent,n.movingAnimation.perpendicular=s.perpendicular,n.movingAnimation.paintPoints=e.points,n.movingAnimation.paintTangents=e.tangents,n.movingAnimation.paintLengths=e.lengths,n.movingAnimation.lineIndex=s.lineIndex,n.movingAnimation.delay=s.delay,n.movingAnimation.reset());let t=new Ce;c.pathBrushProperties&&c.pathBrushProperties.options&&c.pathBrushProperties.options.offset&&(t.x=c.pathBrushProperties.options.offset.x,t.y=c.pathBrushProperties.options.offset.y,t.z=c.pathBrushProperties.options.offset.z,a.particleStoreArray&&a.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else r.pathBrushOptions&&r.pathBrushOptions.type&&("C"!==r.pathBrushOptions.type&&"D"!==r.pathBrushOptions.type||a.getHelper(n.key).rotation.set(0,0,0))}r.children.sort(((e,t)=>e.index-t.index)),a.materialStore&&n.push({caller:a.materialStore,signatrue:"applySettings",args:[l[e].materials,r.name,a.name]}),t(i)}),(e=>{}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});r.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}a.length?Promise.all(a).then((e=>{if(r.pathBrushLinePoints||r.pathBrushOptions&&r.pathBrushOptions.type&&("C"!==r.pathBrushOptions.type&&"D"!==r.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:r})),this.addItem(r),n.length>0)for(let e of n)e.caller[e.signatrue](...e.args);t&&t(1,r,r)})):(this.addItem(r),t&&t(1,r,r));break;case"IconAsset":let h=new yb(e,null,null,null);h._setLock(e.isLock),m.add(h.getGroup()),this.addItem(h),t(1);break;case"PaperCutItem":let u=new Mx(e,null,null,null);u._setLock(e.isLock),Ep.scene.models.remove(Ep.scene.models.getObjectByName(u.name)),m.add(u.getGroup()),this.addItem(u),t(1);break;case"PackedItem":let d=[],p=new Tx({assetObj:e});n=[],e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,p)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":d.push(new Promise((t=>{new $_(e,((i,a,r)=>{_y.setArticulation(e,r),r.materialStore&&n.push({caller:r.materialStore,signatrue:"applySettings",args:[e.materials,p.name]}),t(1)}),(e=>{}),p)})));break;case"PaperCutItem":new Mx(e,p)._setLock(e.isLock);break;case"PaintItem":d.push(new Promise((t=>{let i=[],a=new ex(e,null,p.getGroup(),p);e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,a)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":i.push(new Promise((t=>{new $_(e,((i,r,s)=>{_y.setArticulation(e,s),s.materialStore&&n.push({caller:s.materialStore,signatrue:"applySettings",args:[e.materials,a.name]}),t(1)}),(e=>{}),a)})));break;case"PaperCutItem":new Mx(e,a)._setLock(e.isLock)}}));let r=e.iconInstanced;for(let e=0;e<r.length;e++)new bb(r[e].assetObj,a,((t,i)=>{for(let t=0;t<r[e].points.length;t++){let n=JSON.parse(JSON.stringify(r[e].assetObj));n.transform.position.x=r[e].points[t][0],n.transform.position.y=r[e].points[t][1],n.transform.position.z=r[e].points[t][2],r[e].scales&&r[e].scales.length>t?n.transform.scale=r[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=r[e].settings[t].name,n.isVisible=r[e].settings[t].isVisible,n.isLock=r[e].settings[t].isLock;let s=new _b(n,i,r[e].settings[t].key,r[e].settings[t].index);i.children[t].name=n.name,a.childrenAdd(s),n.isVisible||(s.getGroup().visible=n.isVisible)}}));const s=e;if(a.pathBrushLinePoints)for(const e of a.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let o=e.modelInstanced,l=e;for(let e=0;e<o.length;e++)i.push(new Promise((t=>{new X_(o[e],a,((i,n)=>{for(let t=0;t<o[e].points.length;t++){let i=JSON.parse(JSON.stringify(o[e]));i.transform={position:{x:o[e].points[t][0],y:o[e].points[t][1],z:o[e].points[t][2]}},i.name=o[e].settings[t].name,i.isVisible=o[e].settings[t].isVisible,i.isLock=o[e].settings[t].isLock;let r=new _b(i,n,o[e].settings[t].key,o[e].settings[t].index);a.childrenAdd(r);const c=s.children.find((i=>"movingObject"===i.type&&i.instanced===n.name&&i.key===o[e].settings[t].key));if(c){const e=a.pathBrushLinePoints[c.lineIndex];e&&(r.createMovingAnimation(),r.movingAnimation.euler.set(c.euler.x,c.euler.y,c.euler.z),r.movingAnimation.startLength=c.startLength,r.movingAnimation.maxLength=c.maxLength,r.movingAnimation.reverse=c.reverse,r.movingAnimation.speed=c.speed,r.movingAnimation.useTangent=c.useTangent,r.movingAnimation.perpendicular=c.perpendicular,r.movingAnimation.paintPoints=e.points,r.movingAnimation.paintTangents=e.tangents,r.movingAnimation.paintLengths=e.lengths,r.movingAnimation.lineIndex=c.lineIndex,r.movingAnimation.delay=c.delay,r.movingAnimation.reset());let t=new Ce;l.pathBrushProperties&&l.pathBrushProperties.options&&l.pathBrushProperties.options.offset&&(t.x=l.pathBrushProperties.options.offset.x,t.y=l.pathBrushProperties.options.offset.y,t.z=l.pathBrushProperties.options.offset.z,n.particleStoreArray&&n.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||n.getHelper(r.key).rotation.set(0,0,0))}a.children.sort(((e,t)=>e.index-t.index)),n.materialStore.applySettings(o[e].materials,a.name,n.name),t(i)}),(e=>{}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});a.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}i.length?Promise.all(i).then((e=>{a.pathBrushLinePoints||a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:a})),t(1)})):t(1)})))}})),d.length?Promise.all(d).then((e=>{p.pathBrushLinePoints||p.pathBrushOptions&&p.pathBrushOptions.type&&("C"!==p.pathBrushOptions.type&&"D"!==p.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:p})),setTimeout((()=>{if(n.length>0)for(let e of n)e.caller[e.signatrue](...e.args)}),1e3),m.add(p.getGroup()),this.addItem(p),t&&t(1,p,p)})):(m.add(p.getGroup()),this.addItem(p),t&&t(1,p,p))}},this.getItemByName=e=>{let t=this.children.find((t=>t.name===e));if(t)return t},this.getSettings=()=>(m&&(this.transform.position=m.position,this.transform.rotation=m.rotation,this.transform.scale=m.scale),{name:this.name,children:this.children,transform:this.transform,type:this.type,parent:this.parent,isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,floor:this.floor,room:this.room}),null!=n&&n.length>0){let e=this;if(null!=o&&o){let t=[];n.map((i=>{o.children.map((n=>{n.name===i.name&&(i.loadModel=n,["ModelItem","PaintItem","IconAsset","ModelAsset","IconItem","PaperCutItem","PackedItem"].includes(i.type)?(i.isNoExcursion=!0,t.push(new Promise((t=>{e.addNoneFloor(i,(e=>{t(e)}),p)})))):"BuildingFloorItem"===i.type&&t.push(new Promise((t=>{e.addFloor(i,(e=>{t(e)}),p)}))))}))})),Promise.all(t).then((e=>{d&&d(1)}))}else{let t=[];n.map((i=>{["ModelItem","PaintItem","IconAsset","ModelAsset","IconItem","PaperCutItem","PackedItem"].includes(i.type)?(i.isNoExcursion=!0,t.push(new Promise((t=>{e.addNoneFloor(i,(e=>{t(e)}),p)})))):"BuildingFloorItem"===i.type&&t.push(new Promise((t=>{e.addFloor(i,(e=>{t(e)}),p)})))})),Promise.all(t).then((e=>{d&&d(1)}))}}else d&&d(1,this);a?this.show():this.hide(),r?this.lock():this.unLock()}else logger.warn('创建文件夹中名称不能使用"/"')}}class gx extends ev{constructor(e="untitled",t={},i){if(super("FolderItem"),this.name=e,-1==e.indexOf("/")){this.children=[],this.path=t.path?t.path+"/"+e:"/"+e;var n=new sr;n.name=e,Ep.scene.noneModels.add(n),this.type="FolderItem",this.index=i,this.group=()=>n,this.addItem=(e,t)=>{this.children.push(e),t&&t(1,"文件夹创建成功")},this.addFolder=(e="untitled",t,i)=>{this.children.find((t=>t.isFolder()&&t.name===e))?logger.warn(`当前位置已经存在名称为“${e}”的文件夹。`):this.addItem(new gx(e,t,this.children.length),i)},this.addModel=(e,t,i)=>{this.children.find((t=>t.isModel()&&t.name===e.name))?logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`):("number"!=typeof e.index&&(e.index=this.children.length),this.addItem(new $_(e,t,i)))},this.getSettings=()=>({name:this.name,path:this.path,children:this.children,transform:this.transform,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index}),this.rename=(e,t)=>{e&&(this.name=e,t&&t(1,"模型重命名成功"))}}else logger.warn('创建文件夹中名称不能使用"/"')}}class yx extends ev{constructor(e,t){super("LoadModelItem"),this.materialStore=new Eb(Ep.textureStore,Ep.instance),this.type="ModelItem",this.addModel=(e,t)=>{for(let t=e.children.length-1;t>=0;t--)Ep.scene.models.add(e.children[t]);for(let e=Ep.scene.models.children.length-1;e>=0;e--)for(let i=t.length-1;i>=0;i--)if(t[i].name===Ep.scene.models.children[e].userData.name&&("IconAsset"===t[i].type||"GroupItem"===t[i].type||"PaintItem"===t[i].type||"PackedItem"===t[i].type)){Ep.scene.models.remove(Ep.scene.models.children[e]);break}const i=e.sourceModelKey;e.traverse((e=>{if(_y.capableForCastingShadow(e)&&(e.castShadow=!0,e.receiveShadow=!0),e.material instanceof Kt){let t=_y.MeshBasicMaterialToMeshStandardMaterial(e.material);e.material=t}if(e.material instanceof So){e.material.alphaTest=.05,e.material.depthWrite=!0,e.material.depthTest=!0,e.material.vertexColors=!1,e.material.needsUpdate=!0;for(let t in e.material)e.material[t]instanceof we&&e.material[t].image&&Ep.textureStore.add(e.material[t].name||`${e.material.name}#${t}`,e.material[t],i)}}))},this.addModel(e,t)}}class vx extends ev{constructor(e,t){super("PluginItem"),this.isPluginItem=!0;const i=new Et;this.getGroup=()=>i,this.id=this.getGroup().uuid,this.type="PluginItem",this.name=e.name?e.name:"plugin",this.isVisible=!0,e.pluginName?(this.pluginName=e.pluginName,this.loadPlugin(this.pluginName,(e=>{"function"==typeof t&&t(1,this)}))):(console.warn("未输入插件名称,请加载插件"),"function"==typeof t&&t(1,this));const n=this.dispose;this.dispose=(e,t)=>{null==e&&this.destroy(t),n&&n(e,t)},this.show=()=>{this.visible(!0)},this.hide=()=>{this.visible(!1)}}loadPlugin(e,t){Ep.instance.loadPlugin(e,(e=>{this.plugin||(this.plugin=e,this.plugin.init()),"function"==typeof t&&t(e)}))}getSettings(){if(this.plugin){const e=this.plugin.getPluginSetting();return{id:this.getGroup().uuid,citySceneID:this.citySceneID,name:this.name,type:this.type,isLock:this._getLock(),isVisible:this.isVisible,index:this.index,pluginName:this.pluginName,pluginData:e}}console.error("插件没有加载完全,无法保存数据")}applySetting(e,t){e&&(Object.assign(this,e),this.plugin?(this.visible(e.isVisible),this.plugin.applySettings(e.pluginData,(()=>{"function"==typeof t&&t(this.plugin)}))):this.loadPlugin(e.pluginName,(i=>{this.visible(e.isVisible),this.plugin.applySettings(e.pluginData,(()=>{"function"==typeof t&&t(i)}))})),this.visible(e.isVisible))}visible(e=!1){this.isVisible=e,this.plugin?this.plugin.hideAll(e):console.warn("请检查插件是否正确加载")}locate(){this.plugin?this.plugin.getAllBuildingCenter():console.warn("请检查插件是否正确加载")}destroy(e){this.plugin.destroy(e)}getClickArray(){return this.plugin.getClickArray()}}class bx extends ev{constructor(e,t){super("TileSetItem");const i=[{name:"errorTarget",defaultValue:6},{name:"errorThreshold",defaultValue:1/0},{name:"cacheSizeMax",defaultValue:800},{name:"cacheSizeMin",defaultValue:600},{name:"workers",defaultValue:6},{name:"scale",defaultValue:1}];(e=JSON.parse(JSON.stringify(e))).errorThreshold=1/0;for(let t of i)e[t.name]=Number(e[t.name]),isNaN(e[t.name])&&(e[t.name]=t.defaultValue);this.layerId=void 0===e.id?"":e.id,this.url=e.url,this.offset=e.offset,this.rotation=e.rotation,this.scale=e.scale||1,this.errorTarget=e.errorTarget||6,this.errorThreshold=e.errorThreshold,this.cacheSizeMax=e.cacheSizeMax||800,this.cacheSizeMin=e.cacheSizeMin||600,this.format="B3DM",this.lod="",this.workers=e.workers||6,this.transform=e.transform,this.name=e.name,this.type="TileSetItem",this.isVisible=void 0===e.isVisible||e.isVisible,this.firstLoad=!0,Ry.customTransformEnabled=!0;let n=null,a=new sr;this.id=a.uuid,this.getGroup=()=>{let e=null;return e=n?n.group:a,e};let r=Ep.instance.getDatumShiftModel();if(!Ry.customTransformOrigin&&r&&r.type)switch(r.type.toLowerCase()){case"surface":Ry.customTransformOrigin={lon:r.lon,lat:r.lat,alt:r.alt};break;case"mercator":Ry.customTransformOrigin={lon:r.origin[0],lat:r.origin[1],alt:-r.alt}}let s=Ep.scene.getObjectByName("__tilesGroup");s||(s=new sr,s.name="__tilesGroup",s.rotateX(Math.PI/-2),Ep._tilesGroup=s,Ep.scene.add(s)),Ep.instance._tilesRenderers instanceof Map||(Ep.instance._tilesRenderers=new Map);const o=fy(e.url);if(this.urlHash=o,Ep.instance._tilesRenderers.has(o))return logger.warn(`已经存在来自 ${e.url} 的 3DTiles，无法重复添加。`),void(t&&t({result:0,message:`来自地址 ${e.url} 的 3DTiles 已存在!`}));if(Ep.instance.defaultObjectTree.getItemByName(e.name))return logger.warn(`已经存在名为 ${e.name} 的 3DTiles，无法重复添加。`),void(t&&t({result:0,message:`名为 ${e.name} 的 3DTiles 已存在!`}));let l=e.url;-1!=l.indexOf("[[origin]]")&&(l=l.replace("[[origin]]",Ep.origin)),_y.fetchJSON(l,"get").then((i=>{if(!i)return logger.warn(`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`),void(t&&t({result:0,message:`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`}));n=new Ry(l,e.offset,e.rotation,e.scale),n.manager.addHandler(/\.gltf$/,Ep.loaders.gltfLoader),n.preprocessURL=e=>{let t;return logger.debug(`倾斜摄影url-----${e}`),t="string"==typeof e?e.replace(/\+/g,"%2B"):e,logger.debug(`倾斜摄影newUrl-----${t}`),t},n.urlHash=o,n.group.uuid=a.uuid,n.group.visible=this.isVisible,n.group.layerId=this.layerId,n.onLoadTileSet=()=>{Ep.instance._tilesNeedRerender=!0,e.isApi&&this.firstLoad&&(t&&t({result:1,message:"成功!"}),this.firstLoad=!1)},n.onLoadModel=(e,t)=>{Ep.instance._tilesNeedRerender=!0},n.fetchOptions.mode="cors",n.setCamera(Ep.camera),n.setResolutionFromRenderer(Ep.camera,Ep.renderer),n.errorTarget=e.errorTarget?e.errorTarget:6,n.errorThreshold=1/0,0===Ep.instance._tilesRenderers.size?(n.lruCache.maxSize=e.cacheSizeMax,n.lruCache.minSize=e.cacheSizeMin,n.lruCache.unloadPercent=.1,n.downloadQueue.maxJobs=e.workers,n.parseQueue.maxJobs=n.downloadQueue.maxJobs):(n.lruCache=Ep.instance._tilesRenderers.get(Array.from(Ep.instance._tilesRenderers.keys())[0]).lruCache,n.downloadQueue=Ep.instance._tilesRenderers.get(Array.from(Ep.instance._tilesRenderers.keys())[0]).downloadQueue,n.parseQueue=Ep.instance._tilesRenderers.get(Array.from(Ep.instance._tilesRenderers.keys())[0]).parseQueue,n.lruCache.maxSize+=e.cacheSizeMax,n.lruCache.minSize+=e.cacheSizeMin,n.downloadQueue.maxJobs+=e.workers,n.downloadQueue.maxJobs=Math.min(n.downloadQueue.maxJobs,64),n.parseQueue.maxJobs=n.downloadQueue.maxJobs),Ep.instance._tilesRenderers.set(o,n),Ep.instance._tilesNeedRerender=!0,n.group.name=e.name,Ep._tilesGroup.add(n.group),this.id=n.group.uuid,this.index=e.index?e.index:void 0,void 0!==e.centerTranslate&&n.group.position.set(...e.centerTranslate),void 0!==e.centerRotation&&n.group.rotation.set(e.centerRotation[0]/180*Math.PI,e.centerRotation[1]/180*Math.PI,e.centerRotation[2]/180*Math.PI),this.loadErrorState=!1,e.isApi||t&&t({result:1,message:"添加成功!",objectItem:this}),Ep.instance.defaultObjectTree.addItem(this)})).catch((i=>{console.log(i),this.loadErrorState=!0,this.dispose(),logger.warn(`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`),t&&t({result:0,message:`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`,data:e,type:"TileSetItem"})})),this.dispose=(e=!1)=>{let t=Ep.instance._tilesRenderers.get(this.urlHash);t&&(t.lruCache.maxSize-=this.cacheSizeMax,t.lruCache.minSize-=this.cacheSizeMin,t.dispose(),_y.disposeThreeObject(n.group),n.lruCache.itemSet.forEach(((e,t)=>{t.__loadAbort?(t.__loadAbort.abort(),t.__loadAbort=null):t.__externalTileSet?t.children.length=0:n.disposeTile(t),n.lruCache.itemSet.delete(t)})),n.group.parent.remove(n.group),Ep.instance._tilesRenderers.delete(this.urlHash)),0!==Ep.instance._tilesRenderers.size||e||(Ep.instance._tilesNeedRerender=!1,Ry.customTransformOrigin&&(Ry.customTransformOrigin=void 0))},this.getSettings=()=>({id:this.id,name:this.name,modelPath:"",modelType:"",articulations:[],articulationAnimations:[],children:[],materials:[],transform:this.transform,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,parent:"objectTree",url:this.url,offset:this.offset,rotation:this.rotation,scale:this.scale,errorTarget:this.errorTarget,errorThreshold:this.errorThreshold,cacheSizeMax:this.cacheSizeMax,cacheSizeMin:this.cacheSizeMin,workers:this.workers,tiles:{format:this.format,url:this.url,cacheSizeMin:this.cacheSizeMin,cacheSizeMax:this.cacheSizeMax,errorTarget:this.errorTarget,scale:this.scale},tilesTransform:{position:this.offset,rotation:this.rotation},loadErrorState:this.loadErrorState}),this.update=async(e,t,i=!1)=>{const r=fy(e.url);if(e.url!==this.url&&Ep.instance._tilesRenderers.has(r))return logger.warn(`已经存在来自 ${e.url} 的 3DTiles，无法重复添加。`),void(t&&t({result:0,message:`来自地址 ${e.url} 的 3DTiles 已存在!`}));let s=e.url;-1!=s.indexOf("[[origin]]")&&(s=s.replace("[[origin]]",Ep.origin)),e.errorThreshold=1/0,this.layerId=void 0===e.id?"":e.id,this.urlHash=r,this.url=e.url||this.url,this.offset=e.offset||this.offset,this.rotation=e.rotation||this.rotation,this.scale=e.scale||this.scale,this.errorTarget=e.errorTarget||this.errorTarget,this.errorThreshold=e.errorThreshold||this.errorThreshold,this.format="",this.lod="",this.workers=e.workers||this.workers,this.transform=e.transform||this.transform,this.name=e.name||this.name,this.isVisible=void 0===e.isVisible||e.isVisible,_y.fetchJSON(s,"get").then((o=>{if(!o)return logger.warn(`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`),void(t&&t({result:0,message:`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`}));this.dispose(!0),e=JSON.parse(JSON.stringify(e));const l=[{name:"errorTarget",defaultValue:6},{name:"errorThreshold",defaultValue:1/0},{name:"cacheSizeMax",defaultValue:800},{name:"cacheSizeMin",defaultValue:600},{name:"workers",defaultValue:6},{name:"scale",defaultValue:1}];for(let t of l)e[t.name]=Number(e[t.name]),isNaN(e[t.name])&&(e[t.name]=t.defaultValue);if(i){let e=Ep.instance.getDatumShiftModel();Ry.customTransformOrigin={lon:e.lon,lat:e.lat,alt:e.alt}}else Ry.customTransformOrigin&&(Ry.customTransformOrigin=void 0);n=new Ry(s,e.offset,e.rotation,e.scale),n.manager.addHandler(/\.gltf$/,Ep.loaders.gltfLoader),n.preprocessURL=e=>{let t;return logger.debug(`倾斜摄影url-----${e}`),t="string"==typeof e?e.replace(/\+/g,"%2B"):e,logger.debug(`倾斜摄影newUrl-----${t}`),t},n.group.uuid=a.uuid,n.urlHash=r,n.group.visible=this.isVisible,n.group.layerId=this.layerId,n.onLoadTileSet=()=>{Ep.instance._tilesNeedRerender=!0},n.onLoadModel=()=>{Ep.instance._tilesNeedRerender=!0},n.fetchOptions.mode="cors",n.setCamera(Ep.camera),n.setResolutionFromRenderer(Ep.camera,Ep.renderer),n.errorTarget=e.errorTarget,n.errorThreshold=1/0,0===Ep.instance._tilesRenderers.size?(n.lruCache.maxSize=e.cacheSizeMax,n.lruCache.minSize=e.cacheSizeMin,this.cacheSizeMax=e.cacheSizeMax||this.cacheSizeMax,this.cacheSizeMin=e.cacheSizeMin||this.cacheSizeMin,n.lruCache.unloadPercent=.1,n.downloadQueue.maxJobs=e.workers,n.parseQueue.maxJobs=n.downloadQueue.maxJobs):(n.lruCache=Ep.instance._tilesRenderers.get(Array.from(Ep.instance._tilesRenderers.keys())[0]).lruCache,n.downloadQueue=Ep.instance._tilesRenderers.get(Array.from(Ep.instance._tilesRenderers.keys())[0]).downloadQueue,n.parseQueue=Ep.instance._tilesRenderers.get(Array.from(Ep.instance._tilesRenderers.keys())[0]).parseQueue,n.lruCache.maxSize-=this.cacheSizeMax,n.lruCache.minSize-=this.cacheSizeMin,n.lruCache.maxSize+=e.cacheSizeMax,n.lruCache.minSize+=e.cacheSizeMin,this.cacheSizeMax=e.cacheSizeMax||this.cacheSizeMax,this.cacheSizeMin=e.cacheSizeMin||this.cacheSizeMin,n.downloadQueue.maxJobs+=e.workers,n.downloadQueue.maxJobs=Math.min(n.downloadQueue.maxJobs,64),n.parseQueue.maxJobs=n.downloadQueue.maxJobs),Ep.instance._tilesRenderers.set(r,n),Ep.instance._tilesNeedRerender=!0,n.group.name=e.name,Ep._tilesGroup.add(n.group),this.id=n.group.uuid,this.loadErrorState=!1,t&&t({result:1,message:"修改成功!"})})).catch((()=>{this.loadErrorState=!0,logger.warn(`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`),t&&t({result:0,message:`名为 ${e.name} 的 3DTiles 加载失败，请检查：倾斜摄影地址是否正确，地址是否有安全证书，数据服务器是否允许跨域。`})}))},this.rename=e=>{this.name=e,this.getGroup().name=e}}}const _x=[{img:"suggest-one",text:"进入“Windows设置”，选择“系统”项"},{img:"suggest-two",text:"在“显示”里面找到“图形设置”进行性能首选项设置"},{img:"suggest-three",text:"点击“浏览”"},{img:"suggest-four",text:"选择谷歌浏览器的应用程序即安装位置，并添加"},{img:"suggest-five",text:"添加完成后，点击“选项”"},{img:"suggest-six",text:"在图形规格中选择“高性能”，并保存。"}];let xx=[];class wx{static onUpgradeSuggest(){let e=document.getElementsByTagName("body")[0];this.body=e;let t=document.createElement("div");this.SuggestTip=t,t.setAttribute("id","SuggestTip"),t.className="SuggestTip",t.innerHTML='\n          <span class="suggestTip-text">性能优化建议</span>\n        ';let i="";for(var n=0;n<=10;n++)i=`${i}${10*n}% {\n        background:linear-gradient(90deg, transparent,rgba(255,0,0,${.5+.05*n}),transparent);\n      }`;let a=document.createElement("style");a.innerText=`@keyframes suggest {\n      ${i}\n    }\n    .SuggestTip {\n      animation: suggest 1s linear infinite alternate;\n    }`,t.appendChild(a);let r=document.createElement("div");r.innerText="×",r.className="SuggestTipCancel",r.style="border-radius:1px;\n                                  width: 15px;\n                                  height: 15px;\n                                  border:1px solid #FFB973;\n                                  background: #822403;\n                                  color: #FEB772;\n                                  display:flex;\n                                  justify-content: center;\n                                  align-items:center;\n                                  margin-left:8px;\n                                  font-size: 20px;\n                                  cursor: pointer;\n                                  box-sizing:border-box;\n                                  padding: 0 1px 1px 0;\n                                  font-weight: 900;",t.appendChild(r),r.addEventListener("click",this.offUpgradeSuggest);let s=document.createElement("style");s.innerText=".SuggestTipCancel:hover { opacity: .7 }",t.appendChild(s),t.style="background:linear-gradient(90deg, transparent,red,transparent);\n                            font-size: 15px;\n                            color: #FFE599;\n                            display:flex;\n                            justify-content: center;\n                            align-items:center;\n                            position:absolute;\n                            top: 55px;\n                            left: 50%;\n                            transform:translateX(-50%);\n                            width: 267px;\n                            height: 28px;\n                            cursor:pointer;\n                            z-index: 999;\n                            ",Ep.instance.container.appendChild(t),t.addEventListener("click",this.onUpgradeSuggestPanel)}static offUpgradeSuggest(e){let t=wx;e&&e.stopPropagation(),t.SuggestTip&&Ep.instance.container&&Ep.instance.container.removeChild(t.SuggestTip),t.SuggestTip=null,e&&t.detectFPSTimer&&(clearInterval(t.detectFPSTimer),t.detectFPSTimer=null,t.offState=!0)}static getExtension(){let e=document.createElement("canvas").getContext("experimental-webgl"),t=e.getExtension("WEBGL_debug_renderer_info");return{renderer:e.getParameter(t.UNMASKED_RENDERER_WEBGL),vendor:e.getParameter(t.UNMASKED_VENDOR_WEBGL)}}static onUpgradeSuggestPanel(e){let t=wx;if(e&&e.stopPropagation(),t.upgradeSuggestPanel)return;let i=document.getElementsByTagName("body")[0];t.body=i;let n=document.createElement("div");n.style="width: 100%;\n                                 height: 100%;\n                                 position:absolute;\n                                 top:0;\n                                 left:0;\n                                 z-index: 9999999;",n.tabIndex=0,i.addEventListener("keydown",t.keyDownEvent),i.appendChild(n),t.upgradeSuggestPanel=n;let a=document.createElement("div");a.style="width: 706px;\n                      height: 566px;\n                      position: absolute;\n                      top: 50%;\n                      left: 50%;\n                      transform:translate(-50%,-50%);\n                      background: #18181b;\n                      border: 1px solid #606374;\n                      display:flex;\n                      flex-direction:column;\n                      ",n.appendChild(a),this.resizeResetPanelStyle=()=>{let e=window.document.documentElement.clientWidth,t=window.document.documentElement.clientHeight;if(e<706||t<568){let i=t/568,n=e/706,r=Math.min(n,i);a.style.transform=`scale(${r})translate(-${50/r}%,-${50/r}%)`}else a.style.transform="translate(-50%,-50%)"},this.resizeResetPanelStyle(),window.addEventListener("resize",this.resizeResetPanelStyle);let r=document.createElement("div");r.style="width: 100%;\n                            height: 32px;\n                            background: #333437;\n                            margin-bottom: 1px;\n                            display:flex;\n                            align-items:center;\n                            position:relative",a.appendChild(r);let s=document.createElement("div");s.innerText="!",s.style="box-sizing:border-box;\n                         width: 18px;\n                         height:18px;\n                         border-radius:50%;\n                         border: 2px solid #FF5C26;\n                         margin-left:10px;\n                         display:flex;\n                         align-items:center;\n                         justify-content: center;\n                         color: #FF5C26;\n                         font-weight: 900;\n                         font-size: 12px;",r.appendChild(s);let o=document.createElement("span");o.innerText="性能优化建议",o.style="font-size:14px;\n                       color: #CCCCCC;\n                       margin-left:10px;",r.appendChild(o);let l=document.createElement("span");l.innerText="×",l.className="suggest-cancelIcon",l.style="position:absolute;\n                        right: 10px;\n                        font-size: 26px;\n                        color:#D7DBE8;\n                        cursor: pointer;\n                        top: -2px;",l.addEventListener("click",t.offUpgradeSuggestPanel),r.appendChild(l);let c=document.createElement("style");c.innerText=".suggest-cancelIcon:hover { opacity: .7 }",r.appendChild(c);let h=document.createElement("div");h.style="flex:1;\n                       border-top: 1px solid #424653;\n                       background:#2b2c2f;\n                       display:flex;\n                       flex-direction:column;",a.appendChild(h);let u=document.createElement("div");u.className="performanceSuggest-body-top-text-box",u.innerHTML='<p class="performanceSuggest-body-top-text-box-title">您当前场景的平均帧数低于推荐帧数，为获得更好的浏览体验，建议您更换性能较好的PC或者有独立显卡的笔记本电脑：</p>\n                                <p class="performanceSuggest-body-top-text-box-levelOne">如果您使用的是PC，请使用型号为NVIDIA GTX 1660同级别或以上级别的独立显卡。</p>\n                                <p class="performanceSuggest-body-top-text-box-levelOne">如果您使用的是有独立显卡的笔记本电脑，请进行如下设置：</p>',h.appendChild(u);let d=document.createElement("style");d.innerText=".performanceSuggest-body-top-text-box {\n                                       padding:20px 35px;\n                                       color:#CCCCCC; \n                                       font-size: 14px;\n                                      }\n                                      .performanceSuggest-body-top-text-box > p {\n                                        line-height: 28px;\n                                      }\n                                     .performanceSuggest-body-top-text-box\n                                      > .performanceSuggest-body-top-text-box-levelOne {\n                                        font-weight: 500;\n                                        padding-left: 18px;\n                                        position: relative;\n                                      }\n                                      .performanceSuggest-body-top-text-box\n                                       > .performanceSuggest-body-top-text-box-levelOne::before {\n                                         content: '';\n                                         display: block;\n                                         width: 5px;\n                                         height: 5px;\n                                         background: #FF5C26;\n                                         border-radius: 50%;\n                                         position: absolute;\n                                         left: 3px;\n                                         top: 50%;\n                                         transform: translateY(-50%);\n                                      }",u.appendChild(d);let p=0,m=document.createElement("div");m.className="suggest-bodyBottomBox",m.style="display:flex;\n                           justify-content:space-between;\n                           align-items:center;\n                           padding:0 35px 20px 35px;\n                           flex:1;\n                           user-select: none;\n                           position:relative;";let f=document.createElement("span");f.innerText="<",f.style.opacity="0.2";let g=document.createElement("div"),y=document.createElement("img"),v=`texture/ui/${_x[p].img}.png`;y.src=_y.url(Ep.instance.resourceBasePath,v);let b=document.createElement("p");b.innerHTML=`${_x[p].text}${_x[p].linkText?`<a target="_blank" href="${_x[p].linkUrl}" >${_x[p].linkText}</a>`:""}`,b.style="font-size: 16px;\n                            color:#ccc;\n                            text-align:center;",g.appendChild(y),g.appendChild(b);let _=document.createElement("span");_.innerText=">";let x=document.createElement("span");x.innerText=`${p+1}/${_x.length}`,x.style="position:absolute;\n                          right: 32px;\n                          bottom: 45px;\n                          color: #FF5B26;\n                          font-size: 24px;\n                          transform: scale(1);";let w=document.createElement("style");w.innerText=".suggest-bodyBottomBox > span { font-size: 40px;color:#EEEEEE;transform: scaleY(2.1);cursor:pointer }",f.addEventListener("click",(e=>{if(e&&e.stopPropagation(),p<=0)return;p--,f.style.opacity=p<=0?"0.2":"1",_.style.opacity=p>=_x.length-1?"0.2":"1",x.innerText=`${p+1}/${_x.length}`;let t=`texture/ui/${_x[p].img}.png`;y.src=_y.url(Ep.instance.resourceBasePath,t),b.innerHTML=`${_x[p].text}${_x[p].linkText?`<a target="_blank" href="${_x[p].linkUrl}" >${_x[p].linkText}</a>`:""}`})),_.addEventListener("click",(e=>{if(e&&e.stopPropagation(),p>=_x.length-1)return;p++,f.style.opacity=p<=0?"0.2":"1",_.style.opacity=p>=_x.length-1?"0.2":"1",x.innerText=`${p+1}/${_x.length}`;let t=`texture/ui/${_x[p].img}.png`;y.src=_y.url(Ep.instance.resourceBasePath,t),b.innerHTML=`${_x[p].text}${_x[p].linkText?`<a style="color:#27b1df;" target="_blank" href="${_x[p].linkUrl}" >${_x[p].linkText}</a>`:""}`})),m.appendChild(f),m.appendChild(g),m.appendChild(_),m.appendChild(w),m.appendChild(x),h.appendChild(m);let S=document.createElement("div");S.style="width: 100%;\n                         height: 39px;\n                         margin-top:1px;\n                         background: #313235;\n                         position:relative;\n                         display:flex;\n                         justify-content: flex-end;\n                         align-items:center",a.appendChild(S);let M=document.createElement("span");M.innerText="确定",M.className="suggest-button-ok",M.style="width: 48px;\n                      height: 24px;\n                      background:#1B66F0;\n                      color: #FFFFFF;\n                      font-size: 12px;\n                      display:flex;\n                      justify-content: center;\n                      align-items:center;\n                      margin-right: 10px;\n                      cursor: pointer;\n                      border-radius:2px;",M.addEventListener("click",t.offUpgradeSuggestPanel),S.appendChild(M);let T=document.createElement("style");T.innerText=".suggest-button-ok:hover { opacity: .7 }",S.appendChild(T)}static offUpgradeSuggestPanel(e){let t=wx;e&&e.stopPropagation(),window.removeEventListener("resize",this.resizeResetPanelStyle),t.body.removeChild(t.upgradeSuggestPanel),t.upgradeSuggestPanel=null}static checkSuggestOn(){this.detectFPSTimeout&&(clearInterval(this.detectFPSTimeout),this.detectFPSTimeout=null),this.detectFPSTimer&&(clearInterval(this.detectFPSTimer),this.detectFPSTimer=null),this.detectFPSTimeout=setTimeout((()=>{this.detectFPSTimer=setInterval((()=>{if(!Ep.instance.getStatistics())return;if(0===Ep.instance.getStatistics().fps)return;if(xx.push(Ep.instance.getStatistics().fps),xx.length>5&&(xx.reverse(),xx.length=5,xx.reverse()),xx.length<5)return;let e=0;xx.forEach((t=>{e+=t}));let t=e/xx.length;t<15&&!this.SuggestTip&&(this.onUpgradeSuggest(),xx.length=0),t>=15&&this.SuggestTip&&(this.offUpgradeSuggest(),xx.length=0)}),1e3)}),1e4)}static keyDownEvent(e){let t=wx;13==e.keyCode&&(t.offUpgradeSuggestPanel(),t.body.removeEventListener("keydown",wx.keyDownEvent))}static dispose(){this.detectFPSTimeout&&(clearInterval(this.detectFPSTimeout),this.detectFPSTimeout=null),this.detectFPSTimer&&(clearInterval(this.detectFPSTimer),this.detectFPSTimer=null),this.offUpgradeSuggest({e:1,stopPropagation:()=>{}})}}class Sx extends ev{constructor(e){super("ObjectTree"),this.children=[],this._nodeSelection=new $y(e),this.parentNode=null,this.lastIndex=3,this.fixIndex=3,this.minIndex=1e9,this.getGroup=()=>Ep.scene.models,this.washIndex=e=>{if("GisItem"!=e.type)return"PluginItem"==e.type?(e.pluginName||(e.pluginName="GISCity"),void(e.index=2)):(e.index?e.index<this.fixIndex&&(e.index=this.fixIndex):(e.index=this.lastIndex,this.lastIndex+=1),this.minIndex>e.index&&(this.minIndex=e.index),e.index>=this.lastIndex&&(this.lastIndex=e.index+1),this.children.some((t=>t.index==e.index))?(e.index+=1,void this.washIndex(e)):void 0);e.index=1},this.addItem=(e,t)=>{this.washIndex(e),this.children.push(e),t&&t(1)},this.addFolder=(e="untitled",t,i,n,a)=>{this.children.find((t=>t.isFolder()&&t.name===e))?logger.warn(`当前位置已经存在名称为“${e}”的文件夹。`):null!=t.children?this.addItem(this.recursionAddFolderOrModel(t,n,a),i):this.addItem(new gx(e,{}),i)},this.recursionAddFolderOrModel=(e,t,i)=>{if("FolderItem"===e.type){let n=new gx(e.name,{});if(e.children.length>0)for(let a of e.children)n.children.push(this.recursionAddFolderOrModel(a,t,i));return n}switch(e.type){case"ModelItem":return new $_(e,t,i)}},this.addModel=(e,t,i,n)=>{!this.children.find((t=>t.name===e.name))||e.loadModel?(e.parent="objectTree",e.parentUUID="objectTreeUUID",new $_(e,((i,n,a)=>{Ep.hasUpgradeSuggest&&wx.checkSuggestOn(),i?(this.addItem(a),t&&t(i,n,a)):t&&t(i,n),"fbx"==e.modelType&&this._replaceModel(window._needReplace[e.name]),this.applyObjectSetting(e)}),i,n)):logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`)},this.addIconAsset=(e,t=null,i)=>{delete e.textParam.canvas;var n=_y.deepClone(e);n.nameRepetition||(n.name=_y.getCopyName(n.name,null,this)),n.parent="objectTree",n.isVisible=!0,new yb(n,null,i)},this.addPaperCutItem=(e,t)=>{(e=_y.deepClone(e)).name||(e.name=_y.getCopyName(e.name,null,this)),e.parent="objectTree",this.addItem(new Mx(e,this,t))},this.loadModel=(e,t,i)=>{if(!this.children.find((t=>t.name===e.name)))return logger.debug("TRACE: ModelItem.addModel() - Entering.",e),e=e||{},logger.debug("TRACE: ModelItem.addModel() - Leaving and return a Promise."),new Promise(((n,a)=>{Ep.loaders.gltfLoader||(t&&t(0,"No loader initiated."),a(new Error("No loader initiated."))),e.name||(e.name=_y.guid()),Ep.cacheStore.load({path:e.modelPath,secretKey:e.secretKey,type:"AVWS",onLoad:async e=>{if("20230317-PACK-AVWS"===e.children[0].userData.dhExtension.VERSION){let i=await _y.setPackSettings(e.children[0].userData.dhExtension.pack);i.VERSION="20230317-PACK-AVWS",i.view.camera.duration=0,Ep.instance.applySettings(i,(()=>{n(),setTimeout((()=>{Ep.instance.focus()}),500),Ep.paintControls&&Ep.paintControls.updateWorld(),t&&t(1,i)}))}else if("20220602-NEW-AVWS"===e.children[0].userData.dhExtension.VERSION){(i=_y.cloneDeep(e.children[0].userData.dhExtension)).view.camera.duration=0,Ep.instance.applySettings(i,(()=>{n(),setTimeout((()=>{Ep.instance.focus()}),500),Ep.paintControls&&Ep.paintControls.updateWorld(),t&&t(1,i)}))}else{let a,r=e.children[0].children;a=e.children[0].userData.dhExtension.objectTree?e.children[0].userData.dhExtension.objectTree.children:e.children[0].userData.dhExtension.models;for(const e of r)for(const t of a){if(e.userData.name!=t.name)continue;let i=_y.cloneDeep(t);if(i.loadModel=e,"ModelItem"==t.type&&this.addItem(new $_(i)),"IconAsset"==t.type&&new yb(i,null),"GroupItem"==t.type){let e=new Sb(i);i.children.forEach((t=>{switch(t.type){case"IconAsset":new yb(t,e);break;case"ModelAsset":logger.debug(i,t);let n={name:t.name,gltf:{scene:i.loadModel},transform:t.transform,points:t.points,matrix:t.matrix},a=e.children.find((e=>e.name===n.name));a?a.restoreInstanceFromMatrix(n.matrix):new X_(n,e)}}))}else if("PaintItem"==t.type){let e=new ex(i);i.children.map((t=>{switch(t.type){case"IconAsset":new yb(t,e);break;case"ModelAsset":case"ModelItem":let n={name:t.name,type:t.type,modelPath:t.modelPath,modelType:t.modelType,loadModel:i.loadModel.children.find((e=>e.name==t.name)),transform:t.transform,isVisible:t.isVisible};e.childrenAdd(new $_(n)),e.getGroup().add(n.loadModel)}}));let t=i.iconInstanced;for(let i=0;i<t.length;i++)new bb(t[i].assetObj,e,(e=>{}));let n=i.modelInstanced;for(let t=0;t<n.length;t++){let a=i.loadModel.children.find((e=>"Mesh"===e.type&&e.name==`${n[t].name}#0`));a&&(a.name=n[t].name,n[t].gltf={scene:a}),new X_(n[t],e)}}"BuildingItem"==t.type&&Ep.instance.defaultObjectTree.addBuilding(i)}var i=_y.cloneDeep(e.children[0].userData.dhExtension);new yx(e.children[0],a),t&&t(1,i),n(),setTimeout((()=>{Ep.instance.focus()}),500),Ep.paintControls&&Ep.paintControls.updateWorld()}},onProgress:i,onError:e=>{t?t(0,e):logger.debug(e),a(e)}})}));logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`)},this.addBuilding=(e,t,i,n=Ep.scene.models)=>{this.children.find((t=>t.name===e.name))?logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`):(e.parent="objectTree",e.parentUUID="objectTreeUUID",e.isVisible=null==e.isVisible||e.isVisible,e.floor=null!=e.floor?e.floor:null,this.addItem(new fx(e,n,t,i)))},this.addLineItem=(e,t,i=Ep.scene)=>{new ux(e,((e,i)=>{this.addItem(i),t&&t(e,i)}),i,e.used)},this.addPluginItem=(e,t)=>{new vx(e,((e,i)=>{this.addItem(i),t&&t(e,i)}),parent,e.used)},this.findItem=e=>{if(e)return e=e.split("/"),mx(this.children).get(e)},this.findItemByName=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let i=this.objectTreeRecursion(this.children[t],e);if(i)return i}},this.objectTreeRecursion=(e,t)=>{if(t&&e)if("ModelItem"===e.type||"LineItem"===e.type){if(e.name===t)return e}else{if(!(e.children instanceof Array))return;for(let i=0;i<e.children.length;i++){let n=this.objectTreeRecursion(e.children[i],t);if(n)return n}}},this.findItemByObject3D=e=>{if(!(e instanceof Et))return;let t=e;for(;t.parent&&t.parent.name!==Ep.scene.models.name&&t.parent.name!==Ep.scene.name;)t=t.parent;return this.getItemByName(t.name)},this.getParentIds=e=>{if(!(e instanceof Et))return;let t=[],i=e;for(;i.parent.name!==Ep.scene.models.name;)i=i.parent,t.push(i.uuid);return t},this.getItemByIndex=e=>{if("number"==typeof e&&!(e>=this.children.length))return this.children[e]},this.findNodeByName=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let i=this.nodeRecursion(this.children[t],e);if(i)return i}},this.nodeRecursion=(e,t)=>{if(t&&e){if(e.name===t)return e;if(e.children.length>0)for(let i=0;i<e.children.length;i++){if(e.children[i].name===t)return e.children[i];if(e.children[i].children&&e.children[i].children.length>0){let n=this.nodeRecursion(e.children[i],t);if(n)return n}}}},this.getAsset=(e,t,i)=>{if("string"==typeof e&&""!==e)if(i){let n=this.children.find((e=>e.name==i)),a=this.iconAssetRecursion(n,e,t);if(a)return a}else for(let i=0;i<this.children.length;i++){if("PaintItem"===this.children[i].type)continue;let n=this.iconAssetRecursion(this.children[i],e,t);if(n)return n}},this.iconAssetRecursion=(e,t,i)=>{if(e)if(e.type===i){if(e.name===t)return e}else if(e.children&&e.children.length>0)for(let n=0;n<e.children.length;n++)if(e.children[n].type===i){if(e.children[n].name===t)return e.children[n]}else if(e.children[n].children&&e.children[n].children.length>0){let a=this.iconAssetRecursion(e.children[n],t,i);if(a)return a}},this.rankUp=(e,t,i=this.children)=>{i.sort(((e,t)=>e.index-t.index));let n=i.findIndex((t=>t.name===e));if(n<0){let n=i.filter((e=>["FolderItem","BuildingItem","BuildingFloorItem","BuildingRoomItem"].includes(e.type)&&e.children.lenght));for(let i=0;i<n.length.length;i++)this.rankUp(e,t,n[i].children);return}if(0==n)return void(t&&t(0,"已是第一名无法上移"));let a=i[n].index;if(a<this.fixIndex)t&&t(0,"固定位置对象不支持移动");else if(a===this.minIndex)return void(t&&t(0,"已是第一名无法上移"));i[n].index=i[n-1].index,i[n-1].index=a,t&&t(1,"成功")},this.rankDown=(e,t,i=this.children)=>{i.sort(((e,t)=>e.index-t.index));let n=i.findIndex((t=>t.name===e));if(n<0){let n=i.filter((e=>["FolderItem","BuildingItem","BuildingFloorItem","BuildingRoomItem"].includes(e.type)&&e.children.lenght));for(let i=0;i<n.length.length;i++)this.rankDown(e,t,n[i].children);return}if(n==i.length-1)return void(t&&t(0,"已是最后一名无法下移"));let a=i[n].index;a<this.fixIndex?t&&t(0,"固定位置对象不支持移动"):a===this.lastIndex-1?t&&t(0,"已是第一名无法上移"):(i[n].index=i[n+1].index,i[n+1].index=a,t&&t(1,"成功"))},this.traverse=(e,t)=>{if(e&&"function"==typeof e&&this.children&&this.children instanceof Array){t||(t=this.children);for(let i of t)e(i),i.children instanceof Array&&this.traverse(e,i.children)}},this.findMaterialRecursion=(e,t)=>{if(e.name===t&&"ModelItem"==e.type)return e;if(e.children.length>0)for(let i=0;i<e.children.length;i++){if(e.children[i].name===t&&"ModelItem"==e.children[i].type)return e.children[i];if(e.children[i].children&&e.children[i].children.length>0){let n=this.findMaterialRecursion(e.children[i],t);if(n)return n}}},this.findModelFromBuilding=(e=this.children,t,i)=>{if(t)for(let a=0;a<e.length;a++){let r=null;if("modelUUID"===i?r=e[a].getGroup?e[a].getGroup().uuid:e[a].id:"modelName"===i&&(r=e[a].name),t===r){if("objectTree"===e[a].parent)return e[a];if(n=this.findModelFromBuilding(this.children,e[a].parentUUID,"modelUUID"))return n}else if(e[a].children&&e[a].children.length>0){var n;if(n=this.findModelFromBuilding(e[a].children,t,i))return n}}},this.hideItemByName=e=>{let t=this.getItemByName(e);t&&("ModelItem"===t.type||"IconAsset"===t.type?this.modelIsHide(t,!1):"FolderItem"===t.type&&this.folderItemIsHideRecursion(t,!1))},this.showItemByName=e=>{let t=this.getItemByName(e);t&&("ModelItem"===t.type||"IconAsset"===t.type?this.modelIsHide(t,!0):"FolderItem"===t.type&&this.folderItemIsHideRecursion(t,!0))},this.folderItemIsHideRecursion=(e,t)=>{if(e._setVisible(t),!(e.children<=0))for(let i=0;i<e.children.length;i++)"ModelItem"===e.children[i].type?this.modelIsHide(e.children[i],t):"FolderItem"!==e.children[i].type&&"BuildingItem"!==children.type||this.folderItemIsHideRecursion(e.children[i],t)},this.modelIsHide=(e,t)=>{e._setVisible(t),e.getGroup().visible=t,Ep.scene.children.map((i=>{"__sysObjectsWater"===i.name&&i.children.map((i=>{i.userData.modelName===e.name&&(i.visible=t)}))}))},this.renameItem=(e,t,i)=>{e&&t&&("ModelItem"===this.getItemByName(t).type&&(Ep.scene.models.getObjectByName(t).name=e),this.getItemByName(t).rename(e,i))},this.nodeInObject=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++)return this.nodeInObjectRecursion(this.children[t],e)},this.nodeInObjectRecursion=(e,t)=>{if(t&&e)if("ModelItem"===e.type){if(e.children.length>0)for(let i=0;i<e.children.length;i++)if(this.modelItemRecursion(e.children[i],t))return e}else if("FolderItem"===e.type)for(let i=0;i<e.children.length;i++)return this.nodeInObjectRecursion(e.children[i],t)},this.modelItemRecursion=(e,t)=>{if(e.name===t)return!0;if(e.children.length>0)for(let i=0;i<e.children.length;i++)return this.modelItemRecursion(e.children[i],t)},this.objectTreeRemove=(e,t)=>{if(t&&e)for(let i=e.length-1;i>=0;i--)e[i].name===t?e.splice(i,1):this.objectTreeRemove(e[i],t)},this.removeAsset=(e,t)=>{e&&this.removeAssetRecursion(this.children,e,t)},this.removeAssetRecursion=(e,t,i)=>{for(let n=0;n<e.length;n++)if("IconAsset"===e[n].type){if(e[n].name===t)return Ep.scene.models.remove(Ep.scene.models.getObjectByName(e[n].name)),e.splice(n,1),void(i&&i(1,"删除成功"))}else"BuildingItem"===e[n].type&&e[n].children.length>0&&this.removeAssetRecursion(e[n].children,t,i)},this.removeItem=(e,t)=>{e&&this.removeItemRecursion(this.children,e,t)},this.removeItemRecursion=(e,t,i)=>{for(let n=0;n<e.length;n++)if("ModelItem"===e[n].type){if(e[n].name===t)return Ep.scene.models.remove(Ep.scene.models.getObjectByName(e[n].name)),e.splice(n,1),void(i&&i(1,"删除成功"))}else if("FolderItem"===e[n].type||"BuildingItem"===e[n].type){if(e[n].name===t)return Ep.scene.models.remove(Ep.scene.models.getObjectByName(e[n].name)),e.splice(n,1),void(i&&i(1,"删除成功"));e[n].children.length>0&&this.removeItemRecursion(e[n].children,t,i)}},this.getItemByName=e=>{if("string"==typeof e&&""!==e){if("__tilesGroup"===e)for(let t=0;t<this.children.length;t++)if(this.children[t]&&this.children[t].getGroup()&&this.children[t].getGroup().parent&&this.children[t].getGroup().parent.name===e)return this.children[t];if("__pgl"===e)for(let t=0;t<this.children.length;t++)if(this.children[t]&&this.children[t].getGroup()&&this.children[t].getGroup().name===e)return this.children[t];for(let t=0;t<this.children.length;t++){let i=this.itemRecursion(this.children[t],e);if(i)return i}}},this.itemRecursion=(e,t)=>{if(t&&e){if(e.name===t)return e;if(("FolderItem"===e.type||"PackedItem"===e.type||"BuildingItem"===e.type||"BuildingFloorItem"===e.type||"BuildingRoomItem"===e.type)&&e.children.length>0)for(let i=0;i<e.children.length;i++){let n=this.itemRecursion(e.children[i],t);if(n)return n}}},this.getItemByUUID=e=>{if("string"==typeof e&&""!==e)for(let t=0;t<this.children.length;t++){let i=this.getItemByUUIDRecursion(this.children[t],e);if(i)return i}},this.getItemByUUIDRecursion=(e,t)=>{if(t&&e)if(e.getGroup){if(e.getGroup()&&e.getGroup().uuid===t)return e;if(e.children&&e.children.length>0)for(let i=0;i<e.children.length;i++){let n=this.getItemByUUIDRecursion(e.children[i],t);if(n)return n}}else{if(e.id===t)return e;if(e.children&&e.children.length>0)for(let i=0;i<e.children.length;i++){let n=this.getItemByUUIDRecursion(e.children[i],t);if(n)return n}}},this.pack=(e,t)=>{if(!(e instanceof Array))return;let i=[],n=null;for(let t=0;t<e.length;t++){const n=e[t];if("number"!=typeof n)continue;let a=this.getItemByIndex(n);a&&["ModelItem","IconItem","ModelAsset","IconAsset","PaperCutItem","LineItem","PaintItem"].includes(a.type)?i.push(a):console.warn("Index invalid for packing: ",n)}if(i.length>0){for(let e of i)this.remove(e.name);n=new Tx({items:i})}"function"==typeof t&&t(n.name)},this.setIndex=(e,t)=>{e&&t&&(this.lastIndex=e,this.minIndex=t)},this.getSettings=()=>{let e=this.lastIndex,t=this.minIndex;return JSON.parse(JSON.stringify({children:_y.getSettingsRecursively(this.children),lastIndex:e,minIndex:t}))},this.applySettings=(e,t,i,n=!1)=>{if(e)if(e.children)if(e.children instanceof Object){this.lastIndex=e.lastIndex>this.lastIndex?e.lastIndex:this.lastIndex,this.minIndex=e.minIndex>=3?e.minIndex:this.minIndex;for(let t in e.children)this.applyObjectSetting(e.children[t],n);n&&Ep.animationStore.getAnimations().forEach((e=>{e.isParticleStore&&!e.isPreview&&setTimeout((()=>{e.resetAll()}),50)}))}else logger.error("无效的模型设置。");else logger.error("无效的模型设置。");else logger.error("无效的模型设置。")},this.applyChildrenSettings=(e,t,i)=>{let n=this;i&&e.forEach((e=>{if("ModelItem"===e.type||"ModelAsset"===e.type||"LineItem"===e.type){let a=n.findMaterialRecursion(i,e.name);if(!a)return;setTimeout((()=>{a.materialStore&&!t&&a.materialStore.applySettings(e.materials),_y.setArticulation(e,a),a.hide&&!e.isVisible?a.hide():a.show&&e.isVisible&&a.show(),e.particleStores&&e.particleStores.length>0&&!t&&a.applyParticleSettings(e.particleStores)}),200)}else if("PaintItem"===e.type){let a=i.getItemByName(e.name);n.applyChildrenSettings(e.children,t,a),e.modelInstanced.forEach((t=>{let i=n.getItemByName(e.name).getInstanced("ModelAsset",t.name);i&&setTimeout((()=>{i.materialStore.applySettings(t.materials,e.name,t.name)}),500)}))}else if(["PackedItem","BuildingFloorItem","BuildingRoomItem"].includes(e.type)){let a=i.getItemByName(e.name);n.applyChildrenSettings(e.children,t,a)}}))},this.applyObjectSetting=(e,t=!1)=>{let i=this,n=i.getItemByName(e.name);if(n){if(_y.setNode(e,n,this._nodeSelection,!0),"BuildingItem"===e.type)this.applyChildrenSettings(e.children,t,n),n.floor=e.floor,n.room=e.room;else if("ModelItem"===e.type||"ModelAsset"===e.type){e.type="ModelItem",i.findMaterialRecursion(n,e.name)&&n.materialStore&&!t&&n.materialStore.applySettings(e.materials),_y.setArticulation(e,n),e.particleStores&&e.particleStores.length>0&&!t&&n.applyParticleSettings(e.particleStores)}else"PaintItem"===e.type?(e.children.forEach((i=>{if("ModelItem"===i.type){let a=n.getItemByName(i.name);a&&(a.materialStore&&!t&&a.materialStore.applySettings(i.materials,e.name),_y.setArticulation(i,a),i.particleStores&&i.particleStores.length>0&&!t&&a.applyParticleSettings(i.particleStores))}})),e.modelInstanced.forEach((t=>{let n=i.getItemByName(e.name).getInstanced("ModelAsset",t.name);n&&n.materialStore.applySettings(t.materials,e.name,t.name)}))):"LineItem"===e.type?_y.setArticulation(e,n):"PackedItem"===e.type&&this.applyChildrenSettings(e.children,t,n);if(void 0!==e.isVisible&&(e.isVisible?n.show():n.hide()),n._setLock(e.isLock),e.animations instanceof Array)for(let t of e.animations){let n=[];for(let e of t.tracks){let t;switch(e.type){case"bool":t=new zo(e.name,e.times,e.values);break;case"color":t=new Uo(e.name,e.times,e.values);break;case"number":t=new Fo(e.name,e.times,e.values);break;case"quaternion":t=new Ho(e.name,e.times,e.values);break;case"string":t=new Go(e.name,e.times,e.values);break;case"vector":t=new Vo(e.name,e.times,e.values);break;default:t=Bo(e.name,e.times,e.values)}n.push(t)}let a=new Wo(t.name,t.duration,n);i._models[e.name].animations.push(a)}void 0!==e.isVisible&&(e.isVisible?n.show():n.hide())}},this._replaceModel=e=>{e&&(e.modelNode.traverse((t=>{if(_y.capableForCastingShadow(t)&&(t.castShadow=!0,t.receiveShadow=!0),t.material instanceof Array)for(let i of t.material){let n=this._replaceMaterial(i);n&&(t.material=n,t.material.needsUpdate=!0,e.modelItem.materialStore.add(t.material.name,t.material,t,e.modelNode.name))}else{let i=this._replaceMaterial(t.material);i&&(t.material=i,t.material.needsUpdate=!0,e.modelItem.materialStore.add(t.material.name,t.material,t,e.modelNode.name))}})),e.modelItem.children=qy._fromThreeObject(e.modelNode).children)},this._replaceMaterial=e=>{if(!e)return;let t=["name","alphaMap","aoMap","aoMapIntensity","bumpMap","bumpScale","color","displacementMap","displacementScale","displacementBias","emissive","emissiveMap","emissiveIntensity","envMap","lightMap","lightMapIntensity","map","normalMap","normalMapType","normalScale","alphaTest","depthTest","depthWrite","opacity","shadowSide","side","transparent","visible"],i=new So;if(e instanceof To||e instanceof Co){for(let n of t)if(e[n]&&(e[n].clone?i[n]=e[n].clone():i[n]=e[n],e[n]instanceof we||e[n]&&e[n].isTexture)){let t=window._textureMap[e[n].name];if(!t)continue;let{image:a,mapping:r,wrapS:s,wrapT:o,magFilter:l,minFilter:c,format:h,type:u,anisotropy:d}=t,p=null;p=new vs(a,r,s,o,l,c,h,u,d),p.name=t.name,Ep.textureStore.add(e[n].name||`${e.name}#${n}`,p),i[n]=p}if(i.emissiveMap&&0==i.emissive.toJSON()&&(i.emissive=new Qt(1,1,1)),!i.envMap&&e.specularMap){let t=window._textureMap[e.specularMap.name];if(!t)return i;let{image:n,mapping:a,wrapS:r,wrapT:s,magFilter:o,minFilter:l,format:c,type:h,anisotropy:u}=t,d=new vs(n,a,r,s,o,l,c,h,u);d.name=t.name,Ep.textureStore.add(e.specularMap.name||`${e.name}#envMap`,d),i.envMap=d}let n=e.shininess/100;return i.roughness=.5-n<0?0:.5-n,i}}}}class Mx extends ev{constructor(e,t=Ep.defaultObjectTree,i){super("PaperCutItem"),this.type="PaperCutItem",this.name=e.name,this.path=e.path,this.modelPath=this.path,this.faceCamera=e.faceCamera||!1,this.index=e.index?e.index:void 0,this.transform=e.transform?e.transform:this.transform,this.parent=e.parent;let n=t&&t.getGroup&&t.getGroup()?t.getGroup():Ep.scene.models,a=new sr;a.type="PaperCutGroup",this.getGroup=()=>a,this.addPaperCutItem=()=>{Ep.instance.customTextureStore.loadTexture({url:this.path,name:this.path,onLoad:r=>{let s;Ep.globalTextureMap.has(r.textureSource)?s=Ep.globalTextureMap.get(r.textureSource):(s=new vs(r.textureSource),s.center=new ye(.5,.5),s.repeat=new ye(-1,1),s.rotation=Math.PI,Ep.globalTextureMap.set(r.textureSource,s));let o=new vr({map:s});const l=new px(o,e);a.add(l),a.name=this.name,a.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),this.transform.scale&&a.scale.set(Number(this.transform.scale.x)<=0?1:this.transform.scale.x,Number(this.transform.scale.y)<=0?1:this.transform.scale.y,Number(this.transform.scale.z)<=0?1:this.transform.scale.z),this.transform.rotation&&a.rotation.set(Number(this.transform.rotation._x)<=0?Number(this.transform.rotation._x):0,Number(this.transform.rotation._y)<=0?Number(this.transform.rotation._y):0,Number(this.transform.rotation._z)<=0?Number(this.transform.rotation._z):0),!t||"GroupItem"!==t.type&&"PaintItem"!=t.type&&"PackedItem"!=t.type||t.childrenAdd(this),n.add(a),l.updateFace(),i&&i(1,this)}})},this.update=(e,t)=>{this.name=e.name||this.name,this.path=e.path||this.path,this.modelPath=this.path,this.faceCamera=e.faceCamera,this.transform.position=a.position,this.transform.rotation=a.rotation,this.transform.scale=a.scale,Ep.instance.customTextureStore.loadTexture({url:e.path,name:e.path,onLoad:i=>{let n;Ep.globalTextureMap.has(i.textureSource)?n=Ep.globalTextureMap.get(i.textureSource):(n=new vs(i.textureSource),n.center=new ye(.5,.5),n.repeat=new ye(-1,1),n.rotation=Math.PI,Ep.globalTextureMap.set(i.textureSource,n));let r=new vr({map:n});a.clear();const s=new px(r,e);a.name=this.name,a.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),this.transform.scale&&a.scale.set(Number(this.transform.scale.x)<=0?1:this.transform.scale.x,Number(this.transform.scale.y)<=0?1:this.transform.scale.y,Number(this.transform.scale.z)<=0?1:this.transform.scale.z),this.transform.rotation&&a.rotation.set(Number(this.transform.rotation._x)<=0?Number(this.transform.rotation._x):0,Number(this.transform.rotation._y)<=0?Number(this.transform.rotation._y):0,Number(this.transform.rotation._z)<=0?Number(this.transform.rotation._z):0),a.add(s),s.updateFace(),t&&t(1,this)}})},this.getSettings=()=>(a&&(this.transform.position=a.position,this.transform.rotation=a.rotation,this.transform.scale=a.scale),{name:this.name,id:this.getGroup().uuid,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,transform:this.transform,parent:t?t instanceof Sx?"objectTree":t.name:"",faceCamera:this.faceCamera,path:this.path,modelPath:this.path}),this.dispose=()=>{},this.addPaperCutItem()}}class Tx extends ev{constructor({items:e,assetObj:t={}},i,n,a=Ep.defaultObjectTree){super("PackedItem"),this.children=[],this.type="PackedItem",this.index=t.index?t.index:void 0,this.name=t.name?t.name:this.getLastName(a),this.parent=t.parent?t.parent:"objectTree",this.transform=t.transform?t.transform:this.transform;let r=i||new sr;if(r.type="PackedGroup",r.name=this.name,r.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),r.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),r.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),this.parent&&"objectTree"!=this.parent||(a.addItem(this),a.getGroup()&&a.getGroup().add(r)),this.getGroup=()=>r,this.add=e=>{r.add(e)},this.childrenAdd=e=>{this.children.push(e)},e instanceof Array&&e.length){for(let t=0;t<e.length;t++){const i=e[t];i&&(i.getGroup().parent&&i.getGroup().parent.remove(i.getGroup()),this.add(i.getGroup()),this.childrenAdd(i))}n&&n(1)}this.unpack=()=>{if(this.parent||(this.parent="objectTree"),"objectTree"===this.parent){let e=r.matrix.clone();for(let t=this.children.length-1;t>=0;t--){const i=this.children[t];i&&(i.parent="objectTree",i.getGroup&&i.getGroup().applyMatrix4(e),i.index=void 0,Ep.defaultObjectTree.addItem(i),Ep.defaultObjectTree.getGroup().add(i.getGroup()),this.remove(i.name))}Ep.defaultObjectTree.remove(this.name)}},this.getItemByName=e=>this.children.find((t=>t.name===e)),this.getSettings=()=>(r&&(this.transform.position=r.position,this.transform.rotation=r.rotation,this.transform.scale=r.scale),{id:this.id,name:this.name,children:this.children,transform:this.transform,type:this.getType(),isVisible:this._getVisible(),isLock:this._getLock(),index:this.index,parent:this.parent})}getLastIndex(e){let t=e.lastIndex,i=e.children.sort(((e,t)=>t.index-e.index));return 0==t?t:i[0].index>t?i[0].index+1:t}getLastName(e){let t=1;for(;e.getItemByName(`组${t}`);)t++;return`组${t}`}}class Ax extends ev{constructor({name:e="untitled",parent:t,children:i,isVisible:n,isLock:a,transform:r,loadModel:s,parentUUID:o},l,c,h){if(super("BuildingRoomItem"),-1!=e.indexOf("/"))return void logger.warn('房间的名称中不能使用"/"');let u=l;var d=s||new sr;if(d.name=e,this.name=e,this.type="BuildingRoomItem",this.parent=t,this.parentUUID=o,this.children=[],this.transform=r||this.transform,d.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),d.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),d.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),s||l.add(d),this.getGroup=()=>d,this.getParentGroup=()=>u,this.addItem=e=>{this.children.push(e)},this.addNoneRoom=(e,t,i)=>{if(this.getItemByName(e.name)&&!e.loadModel)return void logger.warn(`当前位置已经存在名称为“${e.name}”的对象。`);e.index=this.children.length,e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isNoExcursion||(e=_y.changeTransformFromBuilding(e,u.parent,u,d));let n=[];switch(e.type){case"ModelItem":new $_(e,((e,i,n)=>{this.addItem(n),t&&t(e,i,n)}),(t=>{i&&i({name:e.name,parent:this.name,loaded:t.loaded})}),d);break;case"PaintItem":let a=[],r=new ex(e);r.parent=this.name,n=[],e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,r)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":a.push(new Promise((t=>{new $_(e,((i,a,s)=>{_y.setArticulation(e,s),s.materialStore&&n.push({caller:s.materialStore,signatrue:"applySettings",args:[e.materials,r.name]}),t(1)}),(e=>{}),r)})));break;case"PaperCutItem":new Mx(e,r)._setLock(e.isLock)}}));let s=e.iconInstanced;for(let e=0;e<s.length;e++)new bb(s[e].assetObj,r,((t,i)=>{for(let t=0;t<s[e].points.length;t++){let n=JSON.parse(JSON.stringify(s[e].assetObj));n.transform.position.x=s[e].points[t][0],n.transform.position.y=s[e].points[t][1],n.transform.position.z=s[e].points[t][2],s[e].scales&&s[e].scales.length>t?n.transform.scale=s[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=s[e].settings[t].name,n.isVisible=s[e].settings[t].isVisible,n.isLock=s[e].settings[t].isLock;let a=new _b(n,i,s[e].settings[t].key,s[e].settings[t].index);i.children[t].name=n.name,r.childrenAdd(a),n.isVisible||(a.getGroup().visible=n.isVisible)}}));const o=e;if(r.pathBrushLinePoints)for(const e of r.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let l=e.modelInstanced,c=e;for(let e=0;e<l.length;e++)a.push(new Promise((t=>{new X_(l[e],r,((i,a)=>{for(let t=0;t<l[e].points.length;t++){let i=JSON.parse(JSON.stringify(l[e]));i.transform={position:{x:l[e].points[t][0],y:l[e].points[t][1],z:l[e].points[t][2]}},i.name=l[e].settings[t].name,i.isVisible=l[e].settings[t].isVisible,i.isLock=l[e].settings[t].isLock;let n=new _b(i,a,l[e].settings[t].key,l[e].settings[t].index);r.childrenAdd(n);const s=o.children.find((i=>"movingObject"===i.type&&i.instanced===a.name&&i.key===l[e].settings[t].key));if(s){const e=r.pathBrushLinePoints[s.lineIndex];e&&(n.createMovingAnimation(),n.movingAnimation.euler.set(s.euler.x,s.euler.y,s.euler.z),n.movingAnimation.startLength=s.startLength,n.movingAnimation.maxLength=s.maxLength,n.movingAnimation.reverse=s.reverse,n.movingAnimation.speed=s.speed,n.movingAnimation.useTangent=s.useTangent,n.movingAnimation.perpendicular=s.perpendicular,n.movingAnimation.paintPoints=e.points,n.movingAnimation.paintTangents=e.tangents,n.movingAnimation.paintLengths=e.lengths,n.movingAnimation.lineIndex=s.lineIndex,n.movingAnimation.delay=s.delay,n.movingAnimation.reset());let t=new Ce;c.pathBrushProperties&&c.pathBrushProperties.options&&c.pathBrushProperties.options.offset&&(t.x=c.pathBrushProperties.options.offset.x,t.y=c.pathBrushProperties.options.offset.y,t.z=c.pathBrushProperties.options.offset.z,a.particleStoreArray&&a.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else r.pathBrushOptions&&r.pathBrushOptions.type&&("C"!==r.pathBrushOptions.type&&"D"!==r.pathBrushOptions.type||a.getHelper(n.key).rotation.set(0,0,0))}r.children.sort(((e,t)=>e.index-t.index)),a.materialStore&&n.push({caller:a.materialStore,signatrue:"applySettings",args:[l[e].materials,r.name,a.name]}),t(i)}),(e=>{}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});r.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}a.length?Promise.all(a).then((e=>{if(r.pathBrushLinePoints||r.pathBrushOptions&&r.pathBrushOptions.type&&("C"!==r.pathBrushOptions.type&&"D"!==r.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:r})),this.addItem(r),n.length>0)for(let e of n)e.caller[e.signatrue](...e.args);t&&t(1,r,r)})):(this.addItem(r),t&&t(1,r,r));break;case"IconAsset":let h=new yb(e,null,null,null);h._setLock(e.isLock),d.add(h.getGroup()),this.addItem(h),t(1);break;case"PaperCutItem":let u=new Mx(e,null,null,null);u._setLock(e.isLock),Ep.scene.models.remove(Ep.scene.models.getObjectByName(u.name)),d.add(u.getGroup()),this.addItem(u),t(1);break;case"PackedItem":let p=[],m=new Tx({assetObj:e});n=[],e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,m)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":p.push(new Promise((t=>{new $_(e,((i,a,r)=>{_y.setArticulation(e,r),r.materialStore&&n.push({caller:r.materialStore,signatrue:"applySettings",args:[e.materials,m.name]}),t(1)}),(e=>{}),m)})));break;case"PaperCutItem":new Mx(e,m)._setLock(e.isLock);break;case"PaintItem":p.push(new Promise((t=>{let i=[],a=new ex(e,null,m.getGroup(),m);e.children.map((t=>{switch(t.type){case"IconAsset":new yb(t,a)._setLock(t.isLock);break;case"ModelAsset":case"ModelItem":i.push(new Promise((i=>{new $_(t,((t,r,s)=>{_y.setArticulation(e,s),s.materialStore&&n.push({caller:s.materialStore,signatrue:"applySettings",args:[e.materials,a.name]}),i(1)}),(e=>{}),a)})));break;case"PaperCutItem":new Mx(t,a)._setLock(t.isLock)}}));let r=e.iconInstanced;for(let e=0;e<r.length;e++)new bb(r[e].assetObj,a,((t,i)=>{for(let t=0;t<r[e].points.length;t++){let n=JSON.parse(JSON.stringify(r[e].assetObj));n.transform.position.x=r[e].points[t][0],n.transform.position.y=r[e].points[t][1],n.transform.position.z=r[e].points[t][2],r[e].scales&&r[e].scales.length>t?n.transform.scale=r[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=r[e].settings[t].name,n.isVisible=r[e].settings[t].isVisible,n.isLock=r[e].settings[t].isLock;let s=new _b(n,i,r[e].settings[t].key,r[e].settings[t].index);i.children[t].name=n.name,a.childrenAdd(s),n.isVisible||(s.getGroup().visible=n.isVisible)}}));const s=e;if(a.pathBrushLinePoints)for(const e of a.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let o=e.modelInstanced,l=e;for(let e=0;e<o.length;e++)i.push(new Promise((t=>{new X_(o[e],a,((i,n)=>{for(let t=0;t<o[e].points.length;t++){let i=JSON.parse(JSON.stringify(o[e]));i.transform={position:{x:o[e].points[t][0],y:o[e].points[t][1],z:o[e].points[t][2]}},i.name=o[e].settings[t].name,i.isVisible=o[e].settings[t].isVisible,i.isLock=o[e].settings[t].isLock;let r=new _b(i,n,o[e].settings[t].key,o[e].settings[t].index);a.childrenAdd(r);const c=s.children.find((i=>"movingObject"===i.type&&i.instanced===n.name&&i.key===o[e].settings[t].key));if(c){const e=a.pathBrushLinePoints[c.lineIndex];e&&(r.createMovingAnimation(),r.movingAnimation.euler.set(c.euler.x,c.euler.y,c.euler.z),r.movingAnimation.startLength=c.startLength,r.movingAnimation.maxLength=c.maxLength,r.movingAnimation.reverse=c.reverse,r.movingAnimation.speed=c.speed,r.movingAnimation.useTangent=c.useTangent,r.movingAnimation.perpendicular=c.perpendicular,r.movingAnimation.paintPoints=e.points,r.movingAnimation.paintTangents=e.tangents,r.movingAnimation.paintLengths=e.lengths,r.movingAnimation.lineIndex=c.lineIndex,r.movingAnimation.delay=c.delay,r.movingAnimation.reset());let t=new Ce;l.pathBrushProperties&&l.pathBrushProperties.options&&l.pathBrushProperties.options.offset&&(t.x=l.pathBrushProperties.options.offset.x,t.y=l.pathBrushProperties.options.offset.y,t.z=l.pathBrushProperties.options.offset.z,n.particleStoreArray&&n.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||n.getHelper(r.key).rotation.set(0,0,0))}a.children.sort(((e,t)=>e.index-t.index)),n.materialStore.applySettings(o[e].materials,a.name,n.name),t(i)}),(e=>{}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});a.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}i.length?Promise.all(i).then((e=>{a.pathBrushLinePoints||a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:a})),t(1)})):t(1)})))}})),p.length?Promise.all(p).then((e=>{m.pathBrushLinePoints||m.pathBrushOptions&&m.pathBrushOptions.type&&("C"!==m.pathBrushOptions.type&&"D"!==m.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:m})),d.add(m.getGroup()),this.addItem(m),setTimeout((()=>{if(n.length>0)for(let e of n)e.caller[e.signatrue](...e.args)}),1e3),t&&t(1,m,m)})):(d.add(m.getGroup()),this.addItem(m),t&&t(1,m,m))}},this.getItemByName=e=>{let t=this.children.find((t=>t.name===e));if(t)return t},this.getSettings=()=>(d&&(this.transform.position=d.position,this.transform.rotation=d.rotation,this.transform.scale=d.scale),{name:this.name,children:this.children,transform:this.transform,type:this.type,isVisible:this._getVisible(),isLock:this._getLock(),parent:this.parent,index:this.index}),null!=i&&i.length>0){let e=this;if(null!=s&&s){let t=[];i.map((i=>{s.children.map((n=>{n.name===i.name&&(i.loadModel=n,i.isNoExcursion=!0,t.push(new Promise((t=>{e.addNoneRoom(i,(e=>{t(e)}),h)}))))}))})),Promise.all(t).then((e=>{c&&c(1)}))}else{let t=[];i.map((i=>{i.isNoExcursion=!0,t.push(new Promise((t=>{e.addNoneRoom(i,(e=>{t(e)}),h)})))})),Promise.all(t).then((e=>{c&&c(1)}))}}else c&&c(1);n?this.show():this.hide(),n?this.show():this.hide(),a?this.lock():this.unLock()}}class Ex extends ev{constructor({name:e="untitled",level:t,parent:i,children:n,isVisible:a,isLock:r,transform:s,loadModel:o,parentUUID:l},c,h,u){if(super("BuildingFloorItem"),-1!=e.indexOf("/"))return void logger.warn('创建文件夹中名称不能使用"/"');let d=c;var p=o||new sr;if(p.name=e,this.name=e,this.type="BuildingFloorItem",this.level=Number(t),this.parent=i,this.parentUUID=l,this.children=[],this.transform=s||this.transform,p.position.set(this.transform.position.x,this.transform.position.y,this.transform.position.z),p.scale.set(this.transform.scale.x,this.transform.scale.y,this.transform.scale.z),p.rotation.set(this.transform.rotation._x,this.transform.rotation._y,this.transform.rotation._z),o||c.add(p),this.getGroup=()=>p,this.getParentGroup=()=>d,this.addItem=e=>{this.children.push(e)},this.addRoom=(e,t,i)=>{!this.getItemByName(e.name)||e.loadModel?(e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isVisible=null==e.isVisible||e.isVisible,e.isLock=null!=e.isLock&&e.isLock,this.addItem(new Ax(e,p,t,i))):logger.warn(`当前位置已经存在名称为“${e.name}”的对象。`)},this.addNoneFloor=(e,t,i)=>{if(this.children.find((t=>t.name===e.name))&&!e.loadModel)return void logger.warn(`当前位置已经存在名称为“${e.name}”的模型。`);e.index=this.children.length,e.parent=this.name,e.parentUUID=this.getGroup().uuid,e.isNoExcursion||(e=_y.changeTransformFromBuilding(e,d,p));let n=[];switch(e.type){case"ModelItem":new $_(e,((e,i,n)=>{this.addItem(n),t&&t(e,i,n)}),(t=>{i&&i({name:e.name,parent:this.name,loaded:t.loaded})}),p);break;case"PaintItem":let a=[],r=new ex(e);r.parent=this.name,n=[],e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,r)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":a.push(new Promise((t=>{new $_(e,((i,a,s)=>{_y.setArticulation(e,s),s.materialStore&&n.push({caller:s.materialStore,signatrue:"applySettings",args:[e.materials,r.name]}),t(1)}),(e=>{}),r)})));break;case"PaperCutItem":new Mx(e,r)._setLock(e.isLock)}}));let s=e.iconInstanced;for(let e=0;e<s.length;e++)new bb(s[e].assetObj,r,((t,i)=>{for(let t=0;t<s[e].points.length;t++){let n=JSON.parse(JSON.stringify(s[e].assetObj));n.transform.position.x=s[e].points[t][0],n.transform.position.y=s[e].points[t][1],n.transform.position.z=s[e].points[t][2],s[e].scales&&s[e].scales.length>t?n.transform.scale=s[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=s[e].settings[t].name,n.isVisible=s[e].settings[t].isVisible,n.isLock=s[e].settings[t].isLock;let a=new _b(n,i,s[e].settings[t].key,s[e].settings[t].index);i.children[t].name=n.name,r.childrenAdd(a),n.isVisible||(a.getGroup().visible=n.isVisible)}}));const o=e;if(r.pathBrushLinePoints)for(const e of r.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let l=e.modelInstanced,c=e;for(let e=0;e<l.length;e++)a.push(new Promise((t=>{new X_(l[e],r,((i,a)=>{for(let t=0;t<l[e].points.length;t++){let i=JSON.parse(JSON.stringify(l[e]));i.transform={position:{x:l[e].points[t][0],y:l[e].points[t][1],z:l[e].points[t][2]}},i.name=l[e].settings[t].name,i.isVisible=l[e].settings[t].isVisible,i.isLock=l[e].settings[t].isLock;let n=new _b(i,a,l[e].settings[t].key,l[e].settings[t].index);r.childrenAdd(n);const s=o.children.find((i=>"movingObject"===i.type&&i.instanced===a.name&&i.key===l[e].settings[t].key));if(s){const e=r.pathBrushLinePoints[s.lineIndex];e&&(n.createMovingAnimation(),n.movingAnimation.euler.set(s.euler.x,s.euler.y,s.euler.z),n.movingAnimation.startLength=s.startLength,n.movingAnimation.maxLength=s.maxLength,n.movingAnimation.reverse=s.reverse,n.movingAnimation.speed=s.speed,n.movingAnimation.useTangent=s.useTangent,n.movingAnimation.perpendicular=s.perpendicular,n.movingAnimation.paintPoints=e.points,n.movingAnimation.paintTangents=e.tangents,n.movingAnimation.paintLengths=e.lengths,n.movingAnimation.lineIndex=s.lineIndex,n.movingAnimation.delay=s.delay,n.movingAnimation.reset());let t=new Ce;c.pathBrushProperties&&c.pathBrushProperties.options&&c.pathBrushProperties.options.offset&&(t.x=c.pathBrushProperties.options.offset.x,t.y=c.pathBrushProperties.options.offset.y,t.z=c.pathBrushProperties.options.offset.z,a.particleStoreArray&&a.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else r.pathBrushOptions&&r.pathBrushOptions.type&&("C"!==r.pathBrushOptions.type&&"D"!==r.pathBrushOptions.type||a.getHelper(n.key).rotation.set(0,0,0))}r.children.sort(((e,t)=>e.index-t.index)),a.materialStore&&n.push({caller:a.materialStore,signatrue:"applySettings",args:[l[e].materials,r.name,a.name]}),t(i)}),(e=>{}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});r.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}a.length?Promise.all(a).then((e=>{if(r.pathBrushLinePoints||r.pathBrushOptions&&r.pathBrushOptions.type&&("C"!==r.pathBrushOptions.type&&"D"!==r.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:r})),this.addItem(r),n.length>0)for(let e of n)e.caller[e.signatrue](...e.args);t&&t(1,r,r)})):(this.addItem(r),t&&t(1,r,r));break;case"IconAsset":let h=new yb(e,null,null,null);h._setLock(e.isLock),p.add(h.getGroup()),this.addItem(h),t(1);break;case"PaperCutItem":let u=new Mx(e,null,null,null);u._setLock(e.isLock),Ep.scene.models.remove(Ep.scene.models.getObjectByName(u.name)),p.add(u.getGroup()),this.addItem(u),t(1);break;case"PackedItem":let d=[],m=new Tx({assetObj:e});n=[],e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,m)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":d.push(new Promise((t=>{new $_(e,((i,a,r)=>{_y.setArticulation(e,r),r.materialStore&&n.push({caller:r.materialStore,signatrue:"applySettings",args:[e.materials,m.name]}),t(1)}),(e=>{}),m)})));break;case"PaperCutItem":new Mx(e,m)._setLock(e.isLock);break;case"PaintItem":d.push(new Promise((t=>{let i=[],a=new ex(e,null,m.getGroup(),m);e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,a)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":i.push(new Promise((t=>{new $_(e,((i,r,s)=>{_y.setArticulation(e,s),s.materialStore&&n.push({caller:s.materialStore,signatrue:"applySettings",args:[e.materials,a.name]}),t(1)}),(e=>{}),a)})));break;case"PaperCutItem":new Mx(e,a)._setLock(e.isLock)}}));let r=e.iconInstanced;for(let e=0;e<r.length;e++)new bb(r[e].assetObj,a,((t,i)=>{for(let t=0;t<r[e].points.length;t++){let n=JSON.parse(JSON.stringify(r[e].assetObj));n.transform.position.x=r[e].points[t][0],n.transform.position.y=r[e].points[t][1],n.transform.position.z=r[e].points[t][2],r[e].scales&&r[e].scales.length>t?n.transform.scale=r[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=r[e].settings[t].name,n.isVisible=r[e].settings[t].isVisible,n.isLock=r[e].settings[t].isLock;let s=new _b(n,i,r[e].settings[t].key,r[e].settings[t].index);i.children[t].name=n.name,a.childrenAdd(s),n.isVisible||(s.getGroup().visible=n.isVisible)}}));const s=e;if(a.pathBrushLinePoints)for(const e of a.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let o=e.modelInstanced,l=e;for(let e=0;e<o.length;e++)i.push(new Promise((t=>{new X_(o[e],a,((i,n)=>{for(let t=0;t<o[e].points.length;t++){let i=JSON.parse(JSON.stringify(o[e]));i.transform={position:{x:o[e].points[t][0],y:o[e].points[t][1],z:o[e].points[t][2]}},i.name=o[e].settings[t].name,i.isVisible=o[e].settings[t].isVisible,i.isLock=o[e].settings[t].isLock;let r=new _b(i,n,o[e].settings[t].key,o[e].settings[t].index);a.childrenAdd(r);const c=s.children.find((i=>"movingObject"===i.type&&i.instanced===n.name&&i.key===o[e].settings[t].key));if(c){const e=a.pathBrushLinePoints[c.lineIndex];e&&(r.createMovingAnimation(),r.movingAnimation.euler.set(c.euler.x,c.euler.y,c.euler.z),r.movingAnimation.startLength=c.startLength,r.movingAnimation.maxLength=c.maxLength,r.movingAnimation.reverse=c.reverse,r.movingAnimation.speed=c.speed,r.movingAnimation.useTangent=c.useTangent,r.movingAnimation.perpendicular=c.perpendicular,r.movingAnimation.paintPoints=e.points,r.movingAnimation.paintTangents=e.tangents,r.movingAnimation.paintLengths=e.lengths,r.movingAnimation.lineIndex=c.lineIndex,r.movingAnimation.delay=c.delay,r.movingAnimation.reset());let t=new Ce;l.pathBrushProperties&&l.pathBrushProperties.options&&l.pathBrushProperties.options.offset&&(t.x=l.pathBrushProperties.options.offset.x,t.y=l.pathBrushProperties.options.offset.y,t.z=l.pathBrushProperties.options.offset.z,n.particleStoreArray&&n.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||n.getHelper(r.key).rotation.set(0,0,0))}a.children.sort(((e,t)=>e.index-t.index)),n.materialStore.applySettings(o[e].materials,a.name,n.name),t(i)}),(e=>{}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});a.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}i.length?Promise.all(i).then((e=>{a.pathBrushLinePoints||a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:a})),t(1)})):t(1)})))}})),d.length?Promise.all(d).then((e=>{m.pathBrushLinePoints||m.pathBrushOptions&&m.pathBrushOptions.type&&("C"!==m.pathBrushOptions.type&&"D"!==m.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:m})),p.add(m.getGroup()),this.addItem(m),setTimeout((()=>{if(n.length>0)for(let e of n)e.caller[e.signatrue](...e.args)}),1e3),t&&t(1,m,m)})):(p.add(m.getGroup()),this.addItem(m),t&&t(1,m,m))}},this.getItemByName=e=>{let t=this.children.find((t=>t.name===e));if(t)return t},this.getSettings=()=>(p&&(this.transform.position=p.position,this.transform.rotation=p.rotation,this.transform.scale=p.scale),{name:this.name,children:this.children,transform:this.transform,type:this.type,isVisible:this._getVisible(),isLock:this._getLock(),level:this.level,parent:this.parent,index:this.index}),null!=n&&n.length>0){let e=this;if(null!=o&&o){let t=[];n.map((i=>{o.children.map((n=>{n.name===i.name&&(i.loadModel=n,["ModelItem","PaintItem","IconAsset","ModelAsset","IconItem","PaperCutItem","PackedItem"].includes(i.type)?(i.isNoExcursion=!0,t.push(new Promise((t=>{e.addNoneFloor(i,(e=>{t(e)}),u)})))):"BuildingRoomItem"===i.type&&t.push(new Promise((t=>{e.addRoom(i,(e=>{t(e)}),u)}))))}))})),Promise.all(t).then((e=>{h&&h(1)}))}else{let t=[];n.map((i=>{["ModelItem","PaintItem","IconAsset","ModelAsset","IconItem","PaperCutItem","PackedItem"].includes(i.type)?(i.isNoExcursion=!0,t.push(new Promise((t=>{e.addNoneFloor(i,(e=>{t(e)}),u)})))):"BuildingRoomItem"===i.type&&t.push(new Promise((t=>{e.addRoom(i,(e=>{t(e)}),u)})))})),Promise.all(t).then((e=>{h&&h(1)}))}}else h&&h(1);a?this.show():this.hide(),a?this.show():this.hide(),r?this.lock():this.unLock()}}Ex.prototype.isBuildingFloorItem=!0;class Cx extends ev{constructor(e,t){if(super("GisItem"),this.type="GisItem",Ep.gisStore.terrainState)return void(t&&t({result:0,message:"添加失败，场景中已存在一个地形地图！"}));this.gisParam=e;let i=Ep.instance.getDatumShiftModel();if(i||e.place){if(!e.place){let n=i.origin?i.origin[0]:i.lon,a=i.origin?i.origin[1]:i.lat;if(!n||!a)return void(t&&t({result:0,message:"添加失败，未设置坐标，请先在坐标编辑设置坐标！"}));e.place={longitude:n,latitude:a}}this.name=e.name,Ep.gisStore&&Ep.gisStore.initTerrain(e),this.getGroup=()=>Ep.scene.pgl,this.id=Ep.scene.pgl.uuid,Ep.instance.defaultObjectTree.addItem(this),t&&t({result:1,message:"添加成功！",objectItem:this}),this.dispose=(e=!1)=>{Ep.gisStore.disposeTerrain()},this.getSettings=()=>({id:this.id,name:this.name,type:this.getType(),index:this.index,imagery:this.gisParam.imagery,elevation:this.gisParam.elevation,isLock:this._getLock(),isVisible:this.isVisible,receiveShadow:this.gisParam.receiveShadow}),this.update=(e,t)=>{let i=this.getGroup().uuid;if(this.dispose(),Ep.gisStore.terrainState)return void(t&&t({result:0,message:"添加失败，场景中已存在一个地形地图！"}));this.gisParam=e;let n=Ep.instance.getDatumShiftModel();if(n||e.place){if(!e.place){let t=n.origin?n.origin[0]:n.lon,i=n.origin?n.origin[1]:n.lat;e.place={longitude:t,latitude:i}}this.name=e.name,Ep.gisStore&&Ep.gisStore.initTerrain(e),this.getGroup().uuid=i}else t&&t({result:0,message:"添加失败，未设置坐标，请先在坐标编辑设置坐标！"})},this.rename=e=>{this.name=e,this.getGroup().name=e}}else t&&t({result:0,message:"添加失败，未设置坐标，请先在坐标编辑设置坐标！"})}}class Ix extends ev{constructor({id:e=_y.guid(),name:t,modelPath:i,transform:n,isVisible:a}={},r,s){super("MarkerItem"),this.id=e,this.name=t||this.id,this.modelPath=i,this.type="MarkerItem",this.animations=[],this.scale=(e=1,t=1,i=1)=>{_modelNode&&_modelNode.scale.set(e,t,i)},this.translate=(e=0,t=0,i=0)=>{_modelNode&&_modelNode.position.set(e,t,i)},this.rotateX=e=>{_modelNode&&_modelNode.rotateX(_y.degreeToRadian(e))},this.rotateY=e=>{_modelNode&&_modelNode.rotateY(_y.degreeToRadian(e))},this.rotateZ=e=>{_modelNode&&_modelNode.rotateZ(_y.degreeToRadian(e))},this.load=(e={color:"#ffffff",position:[0,0,0],size:100,opacity:1},t,i)=>(logger.debug("TRACE: MarkerItem.load() - Entering.",e),e.color=e.color||"#ffffff",e.position=e.position||[0,0,0],e.size="number"==typeof e.size&&e.size>=0?e.size:100,e.opacity="number"==typeof e.opacity&&e.opacity>=0&&e.opacity<=1?e.opacity:1,logger.debug("TRACE: MarkerItem.load() - Leaving and return a Promise."),new Promise(((n,a)=>{Ep.loaders.gltfLoader||(t&&t(0,"No loader initiated."),a(new Error("No loader initiated."))),e.name||(e.name=_y.guid());var r=e.path;Ep.loaders.gltfLoader.load(r,(i=>{if(i.scene.traverse((t=>{if(t.isMesh){if(t.material.transparent=!0,t.userData.transparent=t.material.transparent,t.castShadow=!1,t.receiveShadow=!1,t.material.transparent&&t.material.map&&(t.material.opacity=e.opacity,t.material.alphaMap=t.material.map.clone(),t.material.emissiveMap=t.material.map.clone(),e.ignoreMap instanceof Array)){let i=!1;for(let n of e.ignoreMap)n===t.name&&(i=!0);i&&(t.material.map=null)}t.material.color=new Qt(e.color),t.material.emissive=new Qt(e.color),t.material.emissiveIntensity=.5,t.material.depthWrite=Ep.drawableDepthTest,t.material.depthTest=Ep.drawableDepthTest,t.material.userData.defaultEmissiveIntensity=t.material.emissiveIntensity,t.material.emissiveIntensity*=Ep.drawableEmissiveIntensity,t.material.onBeforeCompile=function(e){let t=on.lights_phong_pars_fragment;t=t.replace("vec3 irradiance = dotNL * directLight.color;","float colorIntensity = max(max(directLight.color.r,directLight.color.g),directLight.color.b);vec3 irradiance = dotNL * vec3(colorIntensity,colorIntensity,colorIntensity);"),e.fragmentShader=e.fragmentShader.replace("#include <lights_phong_pars_fragment>",t);let i=on.lights_pars_begin;i=i.replace("vec3 irradiance = ambientLightColor;","float colorIntensity = max(max(ambientLightColor.r,ambientLightColor.g),ambientLightColor.b);vec3 irradiance = vec3(colorIntensity,colorIntensity,colorIntensity);"),i=i.replace("vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );","vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );float colorIntensity = max(max(irradiance.r,irradiance.g),irradiance.b);irradiance = vec3(colorIntensity,colorIntensity,colorIntensity);"),e.fragmentShader=e.fragmentShader.replace("#include <lights_pars_begin>",i)},t.material.needsUpdate=!0}})),e.animations instanceof Array)for(let t of e.animations)switch(t.type){case"internal":let n,a;switch(t.nodeName&&(n=i.scene.getObjectByName(t.nodeName)),n||(n=i.scene),t.animation){case"rotateY":a=new Sv(n,!1,!0,!1,0,"number"==typeof t.speed?t.speed:.1,0),Ep.animationStore.add(a),this.animations.push(a);break;case"spread":t.startScale="number"==typeof t.startScale?t.startScale:.1,t.stopScale="number"==typeof t.stopScale?t.stopScale:1,t.fadeOutScale="number"==typeof t.fadeOutScale?t.fadeOutScale:.7,t.speed="number"==typeof t.speed?t.speed:.1,a=new Mv(n,t.startScale,t.stopScale,t.fadeOutScale,t.speed,!0),Ep.animationStore.add(a),this.animations.push(a);break;case"uvY":if(!n.material)break;t.speed="number"==typeof t.speed?t.speed:.2,a=new nv(n.material,!1,!0,0,t.speed),Ep.animationStore.add(a),this.animations.push(a);break;case"uvX":if(!n.material)break;t.speed="number"==typeof t.speed?t.speed:.2,a=new nv(n.material,!0,!1,t.speed,0),Ep.animationStore.add(a),this.animations.push(a)}break;case"imported":const r=new Fc(i.scene);if(r.name=e.name,!i.animations[e.index||0])break;r.clipAction(i.animations[e.index||0]).setDuration(1).setEffectiveTimeScale("number"==typeof e.timeScale?e.timeScale:1).play(),Ep.animationMixers.push(r)}i.scene.name=e.name,i.scene.scale.setScalar(e.size*Ep.worldScale*3.75),i.scene.path=e.path;let a=new sr;a.name=e.name,a.position.set(e.position[0],e.position[1],e.position[2]),a.add(i.scene),n(),t&&t(1,a)}),i,(e=>{t?t(0,e):logger.debug(e),a(e)}))}))),this.destroy=()=>{Ep.objectStore.remove(this.name),this.animations.forEach((e=>{Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(e.name,e.type))})),this.animations=[]}}}class Px{constructor({id:e=_y.guid(),name:t,url:i,animations:n,children:a=[],isVisible:r,index:s}){this.id=e,this.name=t||this.id,this.url=i,this.animations=n,this.children=a,this.isVisible=r,this.index=s}findNode(e=""){if(!this.children||""===e)return;return this._findNodeRecursively(e,this)}_findNodeRecursively(e,t){if(t.children&&t.children instanceof Array&&0!==t.children.length)for(let i of t.children){if(i.name===e)return i;if(i.children instanceof Array&&i.children.length>0){let t=this._findNodeRecursively(e,i);if(t)return t}}}}var Rx={type:"axisTypeChange"},Ox={type:"mouseDown"},Dx={type:"mouseUp",mode:null};class Lx extends pe{constructor(){super("ModelSelection");let e="centre",t=new Map,i=new Map,n=new Et,a=new Ce,r=new dt,s=new Ce,o=this;this.controlsState=!1;const l={x:new Ce(1,0,0),y:new Ce(0,1,0),z:new Ce(0,0,1)};this.onTranslate=[],this.onScale=[],this.onRotate=[];const c=()=>{if(1===i.size){const e=Array.from(i.values())[0];e.userObject.isIconModel&&Ep.instance.updateIconModelInterval(e.userObject)}for(const e of o.onTranslate){e({type:"model",objects:Array.from(i.values()).map((e=>e.threeObject))})}},h=()=>{if(1===i.size){const e=Array.from(i.values())[0];e.userObject.isIconModel&&Ep.instance.updateIconModelInterval(e.userObject)}for(const e of o.onScale){e({type:"model",objects:Array.from(i.values()).map((e=>e.threeObject))})}},u=()=>{if(1===i.size){const e=Array.from(i.values())[0];e.userObject.isIconModel&&Ep.instance.updateIconModelInterval(e.userObject)}for(const e of o.onRotate){e({type:"model",objects:Array.from(i.values()).map((e=>e.threeObject))})}};this.onModelTransform=e=>{let t;for(const n of i.values())n.threeObject===e&&(n.transform.position=e.position.clone(),n.transform.rotation=e.rotation.clone(),n.transform.scale=e.scale.clone(),t=!0);t&&this.controlsState&&this.enableTransformControl()};let d=e=>{let t=e.target.object.position.clone().sub(a);a=e.target.object.position.clone(),i.forEach((e=>{let i=t.clone();i.divide(e.threeObject.parent.getWorldScale(new Ce));let n=new it;n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Ee)).invert(),i.applyMatrix4(n);let a=e.transform.position.clone().add(i);e.threeObject.position.copy(a),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone(),e.transform.scale=e.threeObject.scale.clone(),e.threeObject instanceof Mb&&e.threeObject.setPosition(a),e.userObject.isIconModel&&Ep.instance.updateIconModelInterval(e.userObject)})),c()},p=t=>{let n=t.target.axis.toLocaleLowerCase();if("e"!==n&&0!==t.target.rotationAngleDelta){if("centre"===e){let e=t.target.object.position.clone();i.forEach((i=>{((e,t,i,n)=>{if(!e||!e.position)return;if(!t)return;if("x"!==i&&"y"!==i&&"z"!==i)return;const a=e.getWorldPosition(new Ce);a.sub(t);const r={x:new Ce(1,0,0),y:new Ce(0,1,0),z:new Ce(0,0,1)};a.applyAxisAngle(r[i],n),e.rotateOnWorldAxis(r[i],n);let s=e.parent.getWorldPosition(new Ce);a.add(t),a.sub(s),a.divide(e.parent.getWorldScale(new Ce));let o=new it;o.makeRotationFromQuaternion(e.parent.getWorldQuaternion(new Ee)).invert(),a.applyMatrix4(o),e.position.copy(a)})(i.threeObject,e,n,t.target.rotationAngleDelta),i.threeObject instanceof Mb&&i.threeObject.rotate(i.threeObject.position,i.threeObject.rotation),i.userObject.isIconModel&&Ep.instance.updateIconModelInterval(i.userObject)}))}else"oneself"===e&&i.forEach((e=>{e.threeObject[`rotate${n.toLocaleUpperCase()}`](t.target.rotationAngleDelta),e.threeObject instanceof Mb&&e.threeObject.rotateAxis(),e.userObject.isIconModel&&Ep.instance.updateIconModelInterval(e.userObject)}));u()}},m=e=>{let t=e.target.object.scale;i.forEach((e=>{let i=t.clone(),n=new it;if(n.makeRotationFromQuaternion(e.threeObject.parent.getWorldQuaternion(new Ee)).invert(),i.applyMatrix4(n),e.threeObject instanceof Mb)e.threeObject.setScale(i);else{let t=e.transform.scale;e.threeObject.scale.set(t.x*i.x,t.y*i.y,t.z*i.z)}e.userObject.isIconModel&&Ep.instance.updateIconModelInterval(e.userObject)})),h()};this.selectObjectInstanced=e=>{this.disableTransformControl(),this.selectObjectByUUID([]),this.instancedObjects=e,Ep.transformControls.removeEventListener("translate",c),Ep.transformControls.removeEventListener("rotate",u),Ep.transformControls.removeEventListener("scale",h),Ep.transformControls.removeEventListener("translate",d),Ep.transformControls.removeEventListener("rotate",p),Ep.transformControls.removeEventListener("scale",m),Ep.transformControls.addEventListener("translate",f),Ep.transformControls.addEventListener("rotate",y),Ep.transformControls.addEventListener("scale",g),this.controlsState=!0;const t=new Ce;if(1!==e.length){const i=new Re;for(const t of e){Ep.instance.setInstancedIconModelLandmarkShowBox({layer:t.layer,name:t.name,showBox:!0});const e=t.box.clone();e.applyMatrix4(t.matrix),i.expandByPoint(e.min),i.expandByPoint(e.max)}i.getCenter(t)}else Ep.instance.setInstancedIconModelLandmarkShowBox({layer:e[0].layer,name:e[0].name,showBox:!0}),t.copy(e[0].position);n.position.copy(t),n.rotation.set(0,0,0),n.scale.set(1,1,1),a.copy(n.position),r.copy(n.rotation),s.copy(n.scale),Ep.scene.add(n),Ep.transformControls.attach(n),Ep.transformControls.showE=!1};const f=e=>{const t=e.object.position.clone().sub(a);for(const e of this.instancedObjects){const i=e.position.clone().add(t);Ep.instance.setInstancedIconModelLandmarkTransform({position:i,layer:e.layer,name:e.name}),e.newPosition=i}for(const e of this.onTranslate){e({type:"instanced",objects:this.instancedObjects.map((e=>({name:e.id,position:e.newPosition})))})}},g=e=>{let t=e.object.scale.clone();for(const e of this.instancedObjects){const i=e.scale.clone();i.multiply(t),Ep.instance.setInstancedIconModelLandmarkTransform({scale:i,layer:e.layer,name:e.name}),e.newScale=i}for(const e of this.onScale){e({type:"instanced",objects:this.instancedObjects.map((e=>({name:e.id,scale:e.newScale})))})}},y=t=>{if(0===t.target.rotationAngleDelta)return;const i=t.target.axis.toLocaleLowerCase();if("e"===i)return;const n=l[i],a=t.target.rotationAngleDelta,r=t.object.position.clone();for(const t of this.instancedObjects){const i=t.rotation.clone();i.setFromAxisAngle(n,a),t.rotation.multiply(i);const s=(t.newPosition||t.position).clone();if("centre"===e){const e=s.clone().sub(r),i=e.clone().applyAxisAngle(n,a);s.add(i.sub(e)),t.newPosition=s}Ep.instance.setInstancedIconModelLandmarkTransform({position:s.clone(),rotation:t.rotation.clone(),layer:t.layer,name:t.name})}if("centre"===e)for(const e of this.onTranslate){e({type:"instanced",objects:this.instancedObjects.map((e=>({name:e.id,position:e.newPosition})))})}for(const e of this.onRotate){e({type:"instanced",objects:this.instancedObjects.map((e=>({name:e.id,rotation:(new dt).setFromQuaternion(e.rotation)})))})}};this.setPropertyTransform=(t="",a)=>{let r;if(""===t)return r={success:0,message:"修改失败"},r;let s=t.split(".");if(Ep.transformControls.dispatchEvent(Ox),"oneself"===e)i.forEach(((e,t)=>{let i=JSON.parse(JSON.stringify(Ep.instance.getModelTransformByUUID(t)));2===s.length?i[s[0]][s[1]]=a:1===s.length&&(i[s[0]]=a),Ep.instance.setModelTransformByUUID(t,i)})),this.enableTransformControl(),r={success:1,message:"修改成功"};else if("centre"===e){let e=["x","y","z"];if("rotation"===s[0])if(2==s.length){let e=n.rotation[s[1]];n[`rotate${s[1].toUpperCase()}`](ge.degToRad(a)-e);let t={target:{axis:s[1],object:n,rotationAngleDelta:ge.degToRad(a)-e}};p(t)}else 1==s.length&&e.forEach((e=>{let t=n.rotation[e];n[`rotate${e.toUpperCase()}`](ge.degToRad(a[e])-t);let i={target:{axis:e,object:n,rotationAngleDelta:ge.degToRad(a[e])-t}};p(i)}));else if("position"===s[0])if(2==s.length){n.position[`set${s[1].toUpperCase()}`](a),d({target:{object:n}})}else 1==s.length&&e.forEach((e=>{n.position[`set${e.toUpperCase()}`](a[e]),d({target:{object:n}})}));else if("scale"===s[0])if(2==s.length){n.scale[`set${s[1].toUpperCase()}`](a),m({target:{object:n}})}else 1==s.length&&e.forEach((e=>{n.scale[`set${e.toUpperCase()}`](a[e]),m({target:{object:n}})}))}Dx.mode=Ep.transformControls.mode,Ep.transformControls.dispatchEvent(Dx)},this.selectObjectByUUID=(e=[],n=!1)=>(i.clear(),t.forEach((e=>{e.forEach((e=>{if(e.parent&&"InstancedGroup"===e.parent.type){let t=e.parent.parent.uuid,i=Ep.defaultObjectTree.getItemByUUID(t);if(i){let t=i.getItemByName(e.name);t&&t.disableHighlight()}}else e.isInstancedItem?e.cancelHightLight():e.children[0].material&&e.children[0].material.uniforms?e.children[0].material.uniforms.outline.value=0:e.children[0]&&e.children[0].children[0]&&e.children[0].children[0].material&&e.children[0].children[0].material.uniforms&&(e.children[0].children[0].material.uniforms.outline.value=0)}))})),Ep.effectStore.highlightObject(null),e.forEach((e=>{let a={threeObject:null,userObject:null,transform:{}},r=Ep.instance.defaultObjectTree.getItemByUUID(e);if(!0===n&&(r=Ep.instance.defaultObjectTree.getItemByName(e)),r){a.userObject=r;let n=r.getGroup();if(a.threeObject=n,a.transform.position=n.position.clone(),a.transform.rotation=n.rotation.clone(),a.transform.scale=n.scale.clone(),i.set(e,a),"IconAsset"===r.type)r.isInstancedItem?r.highlightInstance(!0):n.children[0].material.uniforms.outline.value=1,t.set(e,[n]);else if("PaperCutItem"===r.type)n.children[0]&&n.children[0].children[0]&&n.children[0].children[0].material&&n.children[0].children[0].material.uniforms?(n.children[0].children[0].material.uniforms.outline.value=1,t.set(e,[n])):Ep.effectStore.highlightObject(a.threeObject,!0);else if("PaintItem"===r.type){let i=[];r.children.forEach((e=>{if("IconAsset"===e.type){let t=null;e.isInstancedItem?(t=e,e.highlightInstance(!0)):(t=e.getGroup(),e.getGroup().children[0].material.uniforms.outline.value=1),i.push(t)}})),i.length>0?t.set(e,i):Ep.effectStore.highlightObject(n,!0)}else{let i=[];n.traverse((e=>{"IconGroup"===e.type&&(e.isInstancedItem?e.highlightInstance(!0):e.children[0].material.uniforms.outline.value=1,i.push(e))})),i.length>0?(t.set(e,i),Ep.effectStore.highlightObject(a.threeObject,!0)):Ep.effectStore.highlightObject(a.threeObject,!0)}}else logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found.")})),this.controlsState&&this.enableTransformControl(),this.getSelectionList()),this.setSelectObjectByUUID=e=>{i.forEach(((e,t)=>{e.transform.scale=e.threeObject.scale.clone(),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone()}));let n={threeObject:null,userObject:null,transform:{}},a=Ep.instance.defaultObjectTree.getItemByUUID(e);if(a){n.userObject=a;let r=a.getGroup();if(n.threeObject=r,n.transform.position=r.position.clone(),n.transform.rotation=r.rotation.clone(),n.transform.scale=r.scale.clone(),i.set(e,n),"IconAsset"===a.type)a.isInstancedItem?a.highlightInstance(!0):r.children[0].material.uniforms.outline.value=1,t.set(e,[r]);else if("PaperCutItem"===a.type)r.children[0]&&r.children[0].children[0]&&r.children[0].children[0].material&&r.children[0].children[0].material.uniforms?(r.children[0].children[0].material.uniforms.outline.value=1,t.set(e,[r])):Ep.effectStore.highlightObject(n.threeObject,!0);else if("PaintItem"===a.type){let i=[];a.children.forEach((e=>{if("IconAsset"===e.type){let t=null;e.isInstancedItem?(t=e,e.highlightInstance(!0)):(t=e.getGroup(),e.getGroup().children[0].material.uniforms.outline.value=1),i.push(t)}})),i.length>0?t.set(e,i):Ep.effectStore.highlightObject(r,!0)}else{let i=[];r.traverse((e=>{"IconGroup"===e.type&&(e.isInstancedItem?e.highlightInstance(!0):e.children[0].material.uniforms&&(e.children[0].material.uniforms.outline.value=1),i.push(e))})),i.length>0?(t.set(e,i),Ep.effectStore.highlightObject(n.threeObject,!0)):Ep.effectStore.highlightObject(n.threeObject,!0)}this.controlsState&&this.enableTransformControl()}else logger.warn("ModeSelection.selectObjectByUUID(): Invalid input found.");return this.getSelectionList()},this.deleteSelectObjectByUUID=e=>{if(i.forEach(((e,t)=>{e.transform.scale=e.threeObject.scale.clone(),e.transform.position=e.threeObject.position.clone(),e.transform.rotation=e.threeObject.rotation.clone()})),!i.get(e))return logger.warn("ModeSelection.deleteSelectObjectByUUID(): Invalid input found."),this.getSelectionList();Ep.effectStore.cancleHighlightObject(i.get(e).threeObject);let n=t.get(e);return n&&n.forEach((e=>{if(e.parent&&"InstancedGroup"===e.parent.type){let t=e.parent.parent.uuid,i=Ep.defaultObjectTree.getItemByUUID(t);if(i){let t=i.getItemByName(e.name);t&&t.cancelHightLight()}}else e.isInstancedItem?e.cancelHightLight():e.children[0].material&&e.children[0].material.uniforms?e.children[0].material.uniforms.outline.value=0:e.children[0]&&e.children[0].children[0]&&e.children[0].children[0].material&&e.children[0].children[0].material.uniforms&&(e.children[0].children[0].material.uniforms.outline.value=0)})),t.delete(e),i.delete(e),this.controlsState&&this.enableTransformControl(),this.getSelectionList()},this.toggleSelectObjectByUUID=e=>(i.get(e)?this.deleteSelectObjectByUUID(e):this.setSelectObjectByUUID(e),this.getSelectionList()),this.getSelectionList=()=>{let e=[];return i.forEach(((t,i)=>{e.push(i)})),e},this.getProperty=e=>{},this.setProperty=(e,t,n)=>{let a={success:0,message:""};if("--"==n)return;let r=t.split(".");switch(e){case"transform":this.setPropertyTransform(t,n);break;case"iconAssetData":i.forEach(((e,t)=>{if("IconAsset"==e.userObject.type){let t=JSON.parse(JSON.stringify(e.userObject));r.length>1?t[r[0]][r[1]]=n:1==r.length&&(t[r[0]]=n),delete t.backgroundMap,delete t.map,e.userObject.update(t)}})),a={success:1,message:"修改成功"}}return a},this.getAllProperties=()=>{if(!i.size)return{};if(1===i.size){let e=this.getSelectionList()[0],t=i.get(e),n={};return n.position=JSON.parse(JSON.stringify(t.threeObject.position)),n.rotation=JSON.parse(JSON.stringify(t.threeObject.rotation)),n.rotation.x=n.rotation._x,n.rotation.y=n.rotation._y,n.rotation.z=n.rotation._z,n.scale=JSON.parse(JSON.stringify(t.threeObject.scale)),n.rotation.x=n.rotation._x=ge.radToDeg(n.rotation._x),n.rotation.y=n.rotation._y=ge.radToDeg(n.rotation._y),n.rotation.z=n.rotation._z=ge.radToDeg(n.rotation._z),{...t.userObject,transform:n}}let t={};return i.forEach((e=>{for(let i in e.userObject)switch(logger.info(`ModeSelection.getAllProperties(): deep clone userObject-propertyName: ${i}`),i){case"id":case"children":case"materialStore":case"level":case"floor":case"backgroundMap":case"map":case"_nodeSelection":case"getType":t[i]=void 0;break;case"name":t.hasOwnProperty(i)?t.label=_y.eq(t[i],e.userObject[i])?t[i]:"--":(t[i]=_y.clone(e.userObject[i]),t.label=_y.clone(e.userObject[i]))}})),"centre"==e?(t.transform={},t.transform.position=JSON.parse(JSON.stringify(n.position)),t.transform.rotation=JSON.parse(JSON.stringify(n.rotation)),t.transform.rotation.x=t.transform.rotation._x,t.transform.rotation.y=t.transform.rotation._y,t.transform.rotation.z=t.transform.rotation._z,t.transform.scale=JSON.parse(JSON.stringify(n.scale)),t.transform.rotation.x=t.transform.rotation._x=ge.radToDeg(t.transform.rotation._x),t.transform.rotation.y=t.transform.rotation._y=ge.radToDeg(t.transform.rotation._y),t.transform.rotation.z=t.transform.rotation._z=ge.radToDeg(t.transform.rotation._z)):"oneself"==e&&(t.transform={},i.forEach((e=>{let i={};for(var n in i.position=JSON.parse(JSON.stringify(e.threeObject.position)),i.rotation=JSON.parse(JSON.stringify(e.threeObject.rotation)),i.rotation.x=i.rotation._x,i.rotation.y=i.rotation._y,i.rotation.z=i.rotation._z,i.scale=JSON.parse(JSON.stringify(e.threeObject.scale)),i.rotation.x=i.rotation._x=ge.radToDeg(i.rotation._x),i.rotation.y=i.rotation._y=ge.radToDeg(i.rotation._y),i.rotation.z=i.rotation._z=ge.radToDeg(i.rotation._z),i)if(t.transform.hasOwnProperty(n))for(let e in i[n])t.transform[n]&&!t.transform[n].hasOwnProperty(e)?t.transform[n][e]=_y.clone(i[n][e]):t.transform[n][e]=_y.eq(t.transform[n][e],i[n][e])?t.transform[n][e]:"--";else t.transform[n]=_y.clone(i[n])}))),t},this.getCenterPosition=()=>{let e=[];if(i.forEach((t=>{let i=t.threeObject.getWorldPosition(new Ce),n=new Re;n.expandByObject(t.threeObject),Math.abs(n.min.x)===1/0?e.push(i):(e.push(n.min),e.push(n.max))})),!e.length)return new Ce;let t=e[0].clone(),n=e[0].clone();return e.forEach((e=>{t.min(e),n.max(e)})),new Re(t,n).getCenter(new Ce)},this.enableTransformControl=()=>{if(this.disableTransformControl(),1===i.size){let e=this.getSelectionList();return Ep.transformControls.attach(i.get(e[0]).threeObject),Ep.transformControls.addEventListener("translate",c),Ep.transformControls.addEventListener("rotate",u),void Ep.transformControls.addEventListener("scale",h)}if(Ep.transformControls.removeEventListener("translate",c),Ep.transformControls.removeEventListener("rotate",u),Ep.transformControls.removeEventListener("scale",h),i.size<1)return;this.controlsState=!0;let e=this.getCenterPosition();n.position.copy(e),n.rotation.set(0,0,0),n.scale.set(1,1,1),a.copy(e),r.copy(n.rotation),s.copy(n.scale),Ep.scene.add(n),Ep.transformControls.addEventListener("translate",d),Ep.transformControls.addEventListener("rotate",p),Ep.transformControls.addEventListener("scale",m),Ep.transformControls.removeEventListener("translate",c),Ep.transformControls.removeEventListener("rotate",u),Ep.transformControls.removeEventListener("scale",h),Ep.transformControls.attach(n),Ep.transformControls.showE=!1},this.disableTransformControl=()=>{Ep.transformControls.removeEventListener("translate",d),Ep.transformControls.removeEventListener("rotate",p),Ep.transformControls.removeEventListener("scale",m),Ep.transformControls.showE=!0,this.controlsState=!1,Ep.transformControls.detach()},this.getSelectedModelMap=()=>i,this.getAxisType=()=>e,this.setAxisType=t=>("centre"!=t&&"oneself"!=t||(e=t,this.dispatchEvent(Rx)),e)}}var kx=function(e,t,a=!0){var r,s,o,l,c,h;void 0===t&&logger.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),t===document&&logger.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.targetLimit={limitHeight:[-1/0,1/0],center:[0,0],radius:1/0},this.object=e,this.domElement=t,this.enabled=!0,this.target=new Ce,this.minDistance=3,this.maxDistance=this.object.far,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=a,this.zoomSpeed=1,this.enableRotate=a,this.rotateSpeed=1,this.enablePan=a,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:i.ROTATE,MIDDLE:i.DOLLY,RIGHT:i.PAN},this.touches={ONE:n.ROTATE,TWO:n.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.keyOperate=null,this.getPolarAngle=function(){return v.phi},this.getAzimuthalAngle=function(){return v.theta},this.listenToKeyEvents=function(e){e.addEventListener("keydown",ie),this._domElementKeyEvents=e},this.setDistanceToTarget=function(e){(new Date).getTime()/1e3-Ep.renderer.lastResize>1&&(u.target.sub(u.object.position),u.target.setLength(e),u.target.add(u.object.position))},this.saveState=function(){u.target0.copy(u.target),u.position0.copy(u.object.position),u.zoom0=u.object.zoom},this.reset=function(){u.target.copy(u.target0),u.object.position.copy(u.position0),u.object.zoom=u.zoom0,u.object.updateProjectionMatrix(),u.dispatchEvent(d),u.update(),g=f.NONE},this.update=(r=new Ce,s=(new Ee).setFromUnitVectors(e.up,new Ce(0,1,0)),o=s.clone().invert(),l=new Ce,c=new Ee,h=2*Math.PI,function(e){var t=u.object.position;r.copy(t).sub(u.target),r.applyQuaternion(s),v.setFromVector3(r),e>1&&logger.warn("orbitControls update delta > 1",e),u.autoRotate&&g===f.NONE&&D(function(e){return e?2*Math.PI/60/60*u.autoRotateSpeed*e/.0167:2*Math.PI/60/60*u.autoRotateSpeed}(e)),u.enableDamping&&(e<4||void 0===e)?(v.theta+=b.theta*u.dampingFactor,v.phi+=b.phi*u.dampingFactor):(v.theta+=b.theta,v.phi+=b.phi);var i=u.minAzimuthAngle,n=u.maxAzimuthAngle;return isFinite(i)&&isFinite(n)&&(i<-Math.PI?i+=h:i>Math.PI&&(i-=h),n<-Math.PI?n+=h:n>Math.PI&&(n-=h),v.theta=i<=n?Math.max(i,Math.min(n,v.theta)):v.theta>(i+n)/2?Math.max(i,v.theta):Math.min(n,v.theta)),v.phi=Math.max(u.minPolarAngle,Math.min(u.maxPolarAngle,v.phi)),v.makeSafe(),v.radius*=_,v.radius=Math.max(u.minDistance,Math.min(u.maxDistance,v.radius)),!0===u.enableDamping&&(e<4||void 0===e)?u.target.addScaledVector(x,u.dampingFactor):u.target.add(x),function(){if(u.targetLimit.radius!==1/0){const e=u.targetLimit.center,t=new Ce(e[0],0,e[1]),i=u.target,n=new Ce(i.x,0,i.z);Math.abs(t.distanceTo(n))>u.targetLimit.radius&&(n.sub(t).setLength(n.length()-u.targetLimit.radius),u.target.sub(n))}u.targetLimit.limitHeight[0]!==-1/0&&u.target.y<u.targetLimit.limitHeight[0]&&(u.target.y=u.targetLimit.limitHeight[0]),u.targetLimit.limitHeight[1]!==1/0&&u.target.y>u.targetLimit.limitHeight[1]&&(u.target.y=u.targetLimit.limitHeight[1])}(),r.setFromSpherical(v),r.applyQuaternion(o),t.copy(u.target).add(r),u.object.lookAt(u.target),!0===u.enableDamping&&(e<4||void 0===e)?(b.theta*=1-u.dampingFactor,b.phi*=1-u.dampingFactor,x.multiplyScalar(1-u.dampingFactor)):(b.set(0,0,0),x.set(0,0,0)),_=1,!!(w||l.distanceToSquared(u.object.position)>y||8*(1-c.dot(u.object.quaternion))>y)&&(u.dispatchEvent(d),l.copy(u.object.position),c.copy(u.object.quaternion),w=!1,!0)}),this.dispose=function(){u.domElement.removeEventListener("contextmenu",se),u.domElement.removeEventListener("pointerdown",J),u.domElement.removeEventListener("wheel",te),u.domElement.removeEventListener("touchstart",ne),u.domElement.removeEventListener("touchend",re),u.domElement.removeEventListener("touchmove",ae),u.domElement.ownerDocument.removeEventListener("pointermove",Q),u.domElement.ownerDocument.removeEventListener("pointerup",K),null!==u._domElementKeyEvents&&u._domElementKeyEvents.removeEventListener("keydown",ie)};var u=this,d={type:"change"},p={type:"start"},m={type:"end"},f={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},g=f.NONE,y=1e-6,v=new Xc,b=new Xc,_=1,x=new Ce,w=!1,S=new ye,M=new ye,T=new ye,A=new ye,E=new ye,C=new ye,I=new ye,P=new ye,R=new ye;function O(){return Math.pow(.95,u.zoomSpeed)}function D(e){b.theta-=e}function L(e){b.phi-=e}var k,N=(k=new Ce,function(e,t){k.setFromMatrixColumn(t,0),k.multiplyScalar(-e),x.add(k)}),B=function(){var e=new Ce;return function(t,i){!0===u.screenSpacePanning?e.setFromMatrixColumn(i,1):(e.setFromMatrixColumn(i,0),e.crossVectors(u.object.up,e)),e.multiplyScalar(t),x.add(e)}}(),z=function(){var e=new Ce;return function(t,i){var n=u.domElement;if(u.object.isPerspectiveCamera){var a=u.object.position;e.copy(a).sub(u.target);var r=e.length();r*=Math.tan(u.object.fov/2*Math.PI/180),N(2*t*r/n.clientHeight,u.object.matrix),B(2*i*r/n.clientHeight,u.object.matrix);let s=u.target.clone();if(s.add(x),u.defaultTargetPosition&&0!=u.viewLimitRadius&&u.viewLimitRadius){s.distanceTo(u.defaultTargetPosition)>u.viewLimitRadius&&x.set(0,0,0)}}else u.object.isOrthographicCamera?(N(t*(u.object.right-u.object.left)/u.object.zoom/n.clientWidth,u.object.matrix),B(i*(u.object.top-u.object.bottom)/u.object.zoom/n.clientHeight,u.object.matrix)):(logger.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),u.enablePan=!1);u.dispatchEvent({type:"pan"})}}();function U(e){if(u.object.isPerspectiveCamera)_/=e;else if(u.object.isOrthographicCamera){if("scene"===u.zoomCenter){let t=u.object.position.clone(),i=u.object.zoom;u.object.zoom=Math.max(u.minZoom,Math.min(u.maxZoom,u.object.zoom*e)),t.multiplyScalar(i/u.object.zoom);const n=u.zoomAxis||"y";"y"===n&&(u.object.position.set(t.x,u.object.position.y,t.z),u.target.set(t.x,0,t.z)),"z"===n&&(u.object.position.set(t.x,t.y,u.object.position.z),u.target.set(t.x,t.y,0)),u.update()}else u.object.zoom=Math.max(u.minZoom,Math.min(u.maxZoom,u.object.zoom*e));u.object.updateProjectionMatrix(),w=!0}else logger.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),u.enableZoom=!1}function F(e){if(u.object.isPerspectiveCamera)_*=e;else if(u.object.isOrthographicCamera){if("scene"===u.zoomCenter){let t=u.object.position.clone(),i=u.object.zoom;u.object.zoom=Math.max(u.minZoom,Math.min(u.maxZoom,u.object.zoom/e)),t.multiplyScalar(i/u.object.zoom);const n=u.zoomAxis||"y";"y"===n&&(u.object.position.set(t.x,u.object.position.y,t.z),u.target.set(t.x,0,t.z)),"z"===n&&(u.object.position.set(t.x,t.y,u.object.position.z),u.target.set(t.x,t.y,0)),u.update()}else u.object.zoom=Math.max(u.minZoom,Math.min(u.maxZoom,u.object.zoom/e));u.object.updateProjectionMatrix(),w=!0}else logger.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),u.enableZoom=!1}function j(e){S.set(e.clientX,e.clientY)}function H(e){I.set(e.clientX,e.clientY)}function G(e){A.set(e.clientX,e.clientY)}function V(e){if(1==e.touches.length)S.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),i=.5*(e.touches[0].pageY+e.touches[1].pageY);S.set(t,i)}}function W(e){if(1==e.touches.length)A.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),i=.5*(e.touches[0].pageY+e.touches[1].pageY);A.set(t,i)}}function Y(e){var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);I.set(0,n)}function X(e){if(1==e.touches.length)M.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),i=.5*(e.touches[0].pageY+e.touches[1].pageY);M.set(t,i)}T.subVectors(M,S).multiplyScalar(u.rotateSpeed);var n=u.domElement;D(2*Math.PI*T.x/n.clientHeight),L(2*Math.PI*T.y/n.clientHeight),S.copy(M)}function Z(e){if(1==e.touches.length)E.set(e.touches[0].pageX,e.touches[0].pageY);else{var t=.5*(e.touches[0].pageX+e.touches[1].pageX),i=.5*(e.touches[0].pageY+e.touches[1].pageY);E.set(t,i)}C.subVectors(E,A).multiplyScalar(u.panSpeed),z(C.x,C.y),A.copy(E)}function q(e){var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);P.set(0,n),R.set(0,Math.pow(P.y/I.y,u.zoomSpeed)),U(R.y),I.copy(P)}function J(e){if(!1!==u.enabled)switch(e.pointerType){case"mouse":case"pen":switch(u.keyOperate){case"translation":0===e.button&&$(e);break;case"rotate":0===e.button&&ee(e);break;case"zoom":0===e.button&&function(e){if(e.preventDefault(),u.domElement.focus?u.domElement.focus():window.focus(),!1===u.enableZoom)return;H(e),(g=f.DOLLY)!==f.NONE&&(u.domElement.ownerDocument.addEventListener("pointermove",Q),u.domElement.ownerDocument.addEventListener("pointerup",K),u.dispatchEvent(p))}(e);break;case"paint":2===e.button&&ee(e),1===e.button&&$(e);break;default:!function(e){var t;switch(e.preventDefault(),u.domElement.focus?u.domElement.focus():window.focus(),e.button){case 0:t=u.mouseButtons.LEFT;break;case 1:t=u.mouseButtons.MIDDLE;break;case 2:t=u.mouseButtons.RIGHT;break;default:t=-1}switch(t){case i.DOLLY:if(!1===u.enableZoom)return;H(e),g=f.DOLLY;break;case i.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===u.enablePan)return;G(e),g=f.PAN}else{if(!1===u.enableRotate)return;j(e),g=f.ROTATE}break;case i.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===u.enableRotate)return;j(e),g=f.ROTATE}else{if(!1===u.enablePan)return;G(e),g=f.PAN}break;default:g=f.NONE}g!==f.NONE&&(u.domElement.ownerDocument.addEventListener("pointermove",Q),u.domElement.ownerDocument.addEventListener("pointerup",K),u.dispatchEvent(p));"function"==typeof u.onPanStart&&u.onPanStart(e)}(e)}}}function Q(e){if(!1!==u.enabled)switch(e.pointerType){case"mouse":case"pen":!function(e){if(!1===u.enabled)return;switch(e.preventDefault(),g){case f.ROTATE:if(!1===u.enableRotate)return;!function(e){M.set(e.clientX,e.clientY),T.subVectors(M,S).multiplyScalar(u.rotateSpeed);var t=u.domElement;D(2*Math.PI*T.x/t.clientHeight),L(2*Math.PI*T.y/t.clientHeight),S.copy(M),u.update()}(e);break;case f.DOLLY:if(!1===u.enableZoom)return;!function(e){P.set(e.clientX,e.clientY),R.subVectors(P,I),R.y>0?U(O()):R.y<0&&F(O()),I.copy(P),u.update()}(e);break;case f.PAN:if(!1===u.enablePan)return;!function(e){E.set(e.clientX,e.clientY),C.subVectors(E,A).multiplyScalar(u.panSpeed),z(C.x,C.y),A.copy(E),u.update()}(e)}}(e)}}function K(e){switch(e.pointerType){case"mouse":case"pen":!function(e){if(u.domElement.ownerDocument.removeEventListener("pointermove",Q),u.domElement.ownerDocument.removeEventListener("pointerup",K),!1===u.enabled)return;u.dispatchEvent(m),g=f.NONE,"function"==typeof u.onPanEnd&&u.onPanEnd(e)}(e)}}function $(e){if(e.preventDefault(),u.domElement.focus?u.domElement.focus():window.focus(),e.ctrlKey||e.metaKey||e.shiftKey){if(!1===u.enableRotate)return;j(e),g=f.ROTATE}else{if(!1===u.enablePan)return;G(e),g=f.PAN}g!==f.NONE&&(u.domElement.ownerDocument.addEventListener("pointermove",Q),u.domElement.ownerDocument.addEventListener("pointerup",K),u.dispatchEvent(p))}function ee(e){if(e.preventDefault(),u.domElement.focus?u.domElement.focus():window.focus(),e.ctrlKey||e.metaKey||e.shiftKey){if(!1===u.enablePan)return;G(e),g=f.PAN}else{if(!1===u.enableRotate)return;j(e),g=f.ROTATE}g!==f.NONE&&(u.domElement.ownerDocument.addEventListener("pointermove",Q),u.domElement.ownerDocument.addEventListener("pointerup",K),u.dispatchEvent(p))}function te(e){!1===u.enabled||!1===u.enableZoom||g!==f.NONE&&g!==f.ROTATE||(e.preventDefault(),e.stopPropagation(),u.dispatchEvent(p),function(e){e.deltaY<0?F(O()):e.deltaY>0&&U(O()),u.update()}(e),u.dispatchEvent(m))}function ie(e){!1!==u.enabled&&!1!==u.enablePan&&function(e){var t=!1;switch(e.keyCode){case u.keys.UP:z(0,u.keyPanSpeed),t=!0;break;case u.keys.BOTTOM:z(0,-u.keyPanSpeed),t=!0;break;case u.keys.LEFT:z(u.keyPanSpeed,0),t=!0;break;case u.keys.RIGHT:z(-u.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),u.update())}(e)}function ne(e){if(!1!==u.enabled){switch(e.preventDefault(),e.touches.length){case 1:switch(u.touches.ONE){case n.ROTATE:if(!1===u.enableRotate)return;V(e),g=f.TOUCH_ROTATE;break;case n.PAN:if(!1===u.enablePan)return;W(e),g=f.TOUCH_PAN;break;default:g=f.NONE}break;case 2:switch(u.touches.TWO){case n.DOLLY_PAN:if(!1===u.enableZoom&&!1===u.enablePan)return;!function(e){u.enableZoom&&Y(e),u.enablePan&&W(e)}(e),g=f.TOUCH_DOLLY_PAN;break;case n.DOLLY_ROTATE:if(!1===u.enableZoom&&!1===u.enableRotate)return;!function(e){u.enableZoom&&Y(e),u.enableRotate&&V(e)}(e),g=f.TOUCH_DOLLY_ROTATE;break;default:g=f.NONE}break;default:g=f.NONE}g!==f.NONE&&u.dispatchEvent(p)}}function ae(e){if(!1!==u.enabled)switch(e.preventDefault(),e.stopPropagation(),g){case f.TOUCH_ROTATE:if(!1===u.enableRotate)return;X(e),u.update();break;case f.TOUCH_PAN:if(!1===u.enablePan)return;Z(e),u.update();break;case f.TOUCH_DOLLY_PAN:if(!1===u.enableZoom&&!1===u.enablePan)return;!function(e){u.enableZoom&&q(e),u.enablePan&&Z(e)}(e),u.update();break;case f.TOUCH_DOLLY_ROTATE:if(!1===u.enableZoom&&!1===u.enableRotate)return;!function(e){u.enableZoom&&q(e),u.enableRotate&&X(e)}(e),u.update();break;default:g=f.NONE}}function re(e){!1!==u.enabled&&(u.dispatchEvent(m),g=f.NONE)}function se(e){!1!==u.enabled&&e.preventDefault()}this.onPointerMove=Q,u.domElement.addEventListener("contextmenu",se),u.domElement.addEventListener("pointerdown",J),u.domElement.addEventListener("wheel",te),u.domElement.addEventListener("touchstart",ne),u.domElement.addEventListener("touchend",re),u.domElement.addEventListener("touchmove",ae)};(kx.prototype=Object.create(pe.prototype)).constructor=kx;var Nx=function(e,t){kx.call(this,e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=i.PAN,this.mouseButtons.RIGHT=i.ROTATE,this.touches.ONE=n.PAN,this.touches.TWO=n.DOLLY_ROTATE};(Nx.prototype=Object.create(pe.prototype)).constructor=Nx;class Bx{constructor(e,t,i,n){this.container=e,Ep.materialPreview={},Ep.materialPreview.renderer=new hr({antialias:!0,alpha:!0}),Ep.materialPreview.scene=new mr,Ep.materialPreview.scene.background=new Qt(3026737);const a=new Vl(16777215,1);Ep.materialPreview.scene.add(a);let r=new Gl(16777215,1),s=new Gl(16777215,.8),o=new Gl(16777215,.6);r.position.set(10,7,10),s.position.set(-10,2,10),o.position.set(0,0,-10),r.target.position.set(0,0,0),s.target.position.set(0,0,0),o.target.position.set(0,0,0),Ep.materialPreview.scene.add(r),Ep.materialPreview.scene.add(s),Ep.materialPreview.scene.add(o),Ep.materialPreview.camera=new Zi(50,e.getBoundingClientRect().width/e.getBoundingClientRect().height,.1,1e3),Ep.materialPreview.camera.position.set(0,0,3),Ep.materialPreview.renderer.setSize(e.getBoundingClientRect().width,e.getBoundingClientRect().height),Ep.materialPreview.orbitControls=new kx(Ep.materialPreview.camera,Ep.materialPreview.renderer.domElement),Ep.materialPreview.orbitControls.enablePan=!1,e.appendChild(Ep.materialPreview.renderer.domElement),this.scene=Ep.materialPreview.scene,this.path=t,this.showType=null,this.models=new sr,this.scene.add(this.models),Ep.instance.preloadResource(t,"avwa",(()=>{let e=Ep.cacheStore.find(t);if(e){let t=null,i=null,n=new Map;e.resource.traverse((e=>{if(e.material&&!t&&(t=e.material.clone()),e.material)for(let t in e.material)e.material[t]instanceof we&&e.material[t].image&&n.set(e.material[t].name||`${e.material.name}#${t}`,Tb._fromThreeObject(e.material[t]));e.userData&&e.userData.dhAsset&&!i&&(i=e.userData.dhAsset)}));let a=this.getMaterialInstance(t);this.materialInstance&&(this.materialInstance.type="metalness"),this.materialInstance=a,a.resourceBasePath=Ep.instance.resourceBasePath,this.createSphere(t),this.createCylinder(t),this.createBox(t),this.createPlane(t),_y.setMaterialParam(i.materials[t.name],a,n),Ep.materialPreview.hasRenderer=!0}i&&i()}),(e=>{n&&n(e)}))}update(e,t,i){Ep.materialPreview.hasRenderer=!1,Ep.instance.preloadResource(e,"avwa",(()=>{let i=Ep.cacheStore.find(e);if(i){let e=null,t=null,n=new Map;i.resource.traverse((i=>{if(i.material&&!e&&(e=i.material.clone()),i.material)for(let e in i.material)i.material[e]instanceof we&&i.material[e].image&&n.set(i.material[e].name||`${i.material.name}#${e}`,Tb._fromThreeObject(i.material[e]));i.userData&&i.userData.dhAsset&&!t&&(t=i.userData.dhAsset)}));let a=this.getMaterialInstance(e);this.materialInstance&&(this.materialInstance.type="metalness"),this.materialInstance=a,a.resourceBasePath=Ep.instance.resourceBasePath,this.materialInstance&&(this.materialInstance.type="metalness"),_y.setMaterialParam(t.materials[e.name],a,n),this.updateMaterial(e,"sphere"),this.updateMaterial(e,"cylinder"),this.updateMaterial(e,"box"),this.updateMaterial(e,"plane"),Ep.materialPreview.hasRenderer=!0}t&&t()}),(e=>{i&&i(e)}))}updateMaterial(e,t){this[t]?(this[t].material=e,this[t].material.needsUpdate=!0):this[`create${t.replace(t[0],t[0].toLowerCase())}`](e)}createSphere(e){let t=new Fi(new po(1,40,40),e);t.name="sphere",t.scale.y=-1,this.sphere=t,this.showType="sphere",this.models.add(t)}createCylinder(e){let t=new Fi(new xs(.8,.8,1.6,40,40),e);t.name="cylinder",t.scale.y=-1,this.cylinder=t,t.visible=!1,this.models.add(t)}createBox(e){let t=new Fi(new Hi(1.4,1.4,1.4,10,10,10),e);t.name="box",t.scale.y=-1,this.box=t,t.visible=!1,this.models.add(t)}createPlane(e){let t=new Fi(new sn(1.4,1.4,10,10),e);t.name="plane",t.scale.y=-1,this.plane=t,t.visible=!1,this.models.add(t)}showGeometry(e){this[this.showType].visible=!1,this[e].visible=!0,this.showType=e}dispose(){for(this.materialInstance&&(this.materialInstance.type="metalness"),_y.disposeMaterial(this.materialInstance.material()),this.materialInstance=null,Ep.materialPreview.hasRenderer=!1,_y.disposeThreeObject(this.models),this.models.remove(this.sphere),this.models.remove(this.cylinder),this.models.remove(this.plane),this.models.remove(this.box),Ep.materialPreview.scene.traverse((function(e){if(e.isMesh)if(_objectCount--,e.geometry.dispose(),e.material instanceof Array)for(let t of e.material)t.dispose();else e.material.dispose();e.isSprite&&e.material.dispose()}));Ep.materialPreview.scene.children.length;)Ep.materialPreview.scene.remove(Ep.materialPreview.scene.children[0]);Ep.materialPreview.renderer.domElement&&this.container.removeChild(Ep.materialPreview.renderer.domElement),Ep.materialPreview.scene=null,Ep.materialPreview.camera=null,Ep.materialPreview.renderer.dispose(),Ep.materialPreview.renderer.forceContextLoss(),Ep.materialPreview.renderer.content=null;let e=Ep.materialPreview.renderer.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext(),Ep.materialPreview.renderer=null,Ep.materialPreview.orbitControls=null,Ep.materialPreview=null}setResolution(e,t){"number"!=typeof e||e<0||e>Oy||"number"!=typeof t||t<0||t>Dy||Ep.materialPreview.hasRenderer&&(Ep.materialPreview.camera.aspect=1*e/t,Ep.materialPreview.camera.updateProjectionMatrix(),Ep.materialPreview.renderer.setSize(e,t,!0))}getMaterialInstance(e){return new Ab({materialOfThree:e,id:e.uuid,name:e.name,type:"metalness",mapType:"metalness",color:e.color,map:e.map,mapIntensit:e.mapIntensit,metalnessMap:e.metalnessMap,metalnessIntensity:e.metalness,roughnessMap:e.roughnessMap,roughnessIntensity:e.roughness,enableSpecularMap:!!e.envMap,specularMapType:e.envMap?"custom":"envmap",specularMap:e.envMap,specularMapIntensity:e.envMapIntensity/5,enableNormalMap:!!e.normalMap,normalMapType:"",normalMap:e.normalMap,normalMapFlipY:e.normalMapFlipY,normalMapIntensity:e.normalScale?e.normalScale.x:1,enableDisplacement:!!e.displacementMap,displacementMap:e.displacementMap,displacementIntensity:e.displacementScale,enableOpacity:e.transparent||!!e.alphaMap,opacityType:"blend",opacityMap:e.alphaMap,opacityIntensity:e.opacity,opacityInverted:!1,emissive:e.emissive,enableEmissive:!!e.emissiveMap||0!==e.emissive.r||0!==e.emissive.g||0!==e.emissive.b,emissiveMap:e.emissiveMap,emissiveIntensity:e.emissiveIntensity,enableLightMap:!!e.lightMap,lightMap:e.lightMap,lightMapIntensity:e.lightMapIntensity,enableSSR:e.enableSSR,envMapIntensity:e.envMapIntensity,side:e.side,depth:e.depthTest&&e.depthWrite?2:e.depthTest||e.depthWrite?1:0})}}var zx=function(e){for(var t,i,n,a=0,r=new Ce,s=new Ce,o=new Qt,l=[0,0,0,0,0,0,0,0,0],c=new Yl,h=c.coefficients,u=0;u<6;u++){var d=e.image[u],p=d.width,m=d.height,f=document.createElement("canvas");f.width=p,f.height=m;var g=f.getContext("2d");g.drawImage(d,0,0,p,m);for(var y=g.getImageData(0,0,p,m),v=y.data,b=y.width,_=2/b,x=0,w=v.length;x<w;x+=4){o.setRGB(v[x]/255,v[x+1]/255,v[x+2]/255),Fx(o,e.encoding);var S=x/4,M=(S%b+.5)*_-1,T=1-(Math.floor(S/b)+.5)*_;switch(u){case 0:r.set(-1,T,-M);break;case 1:r.set(1,T,M);break;case 2:r.set(-M,1,-T);break;case 3:r.set(-M,-1,T);break;case 4:r.set(-M,T,1);break;case 5:r.set(M,T,-1)}i=r.lengthSq(),a+=n=4/(Math.sqrt(i)*i),s.copy(r).normalize(),Yl.getBasisAt(s,l);for(var A=0;A<9;A++)h[A].x+=l[A]*o.r*n,h[A].y+=l[A]*o.g*n,h[A].z+=l[A]*o.b*n}}t=4*Math.PI/a;for(A=0;A<9;A++)h[A].x*=t,h[A].y*=t,h[A].z*=t;return new Xl(c)},Ux=function(e,t){for(var i,n,a,r=0,s=new Ce,o=new Ce,l=new Qt,c=[0,0,0,0,0,0,0,0,0],h=new Yl,u=h.coefficients,d=0;d<6;d++){var p=t.width,m=new Uint8Array(p*p*4);e.readRenderTargetPixels(t,0,0,p,p,m,d);for(var f=2/p,g=0,y=m.length;g<y;g+=4){l.setRGB(m[g]/255,m[g+1]/255,m[g+2]/255),Fx(l,t.texture.encoding);var v=g/4,b=(v%p+.5)*f-1,_=1-(Math.floor(v/p)+.5)*f;switch(d){case 0:s.set(1,_,-b);break;case 1:s.set(-1,_,b);break;case 2:s.set(b,1,-_);break;case 3:s.set(b,-1,_);break;case 4:s.set(b,_,1);break;case 5:s.set(-b,_,-1)}n=s.lengthSq(),r+=a=4/(Math.sqrt(n)*n),o.copy(s).normalize(),Yl.getBasisAt(o,c);for(var x=0;x<9;x++)u[x].x+=c[x]*l.r*a,u[x].y+=c[x]*l.g*a,u[x].z+=c[x]*l.b*a}}i=4*Math.PI/r;for(x=0;x<9;x++)u[x].x*=i,u[x].y*=i,u[x].z*=i;return new Xl(h)},Fx=function(e,t){switch(t){case te:e.convertSRGBToLinear();break;case ee:break;default:console.warn("WARNING: LightProbeGenerator convertColorToLinear() encountered an unsupported encoding.")}return e};class jx{constructor(e,t,i,n){this.container=e,Ep.particlePreview={},Ep.particlePreview.renderer=new hr({antialias:!0,alpha:!0}),Ep.particlePreview.scene=new mr,Ep.particlePreview.scene.background=new Qt(3026737);const a=new Vl(16777215,1);Ep.particlePreview.scene.add(a);let r=new Gl(16777215,1),s=new Gl(16777215,.8),o=new Gl(16777215,.6);r.position.set(10,7,10),s.position.set(-10,2,10),o.position.set(0,0,-10),r.target.position.set(0,0,0),s.target.position.set(0,0,0),o.target.position.set(0,0,0),Ep.particlePreview.scene.add(r),Ep.particlePreview.scene.add(s),Ep.particlePreview.scene.add(o),Ep.particlePreview.camera=new Zi(50,e.getBoundingClientRect().width/e.getBoundingClientRect().height,.1,1e3),Ep.particlePreview.camera.position.set(0,0,50),Ep.particlePreview.renderer.setSize(e.getBoundingClientRect().width,e.getBoundingClientRect().height),Ep.particlePreview.orbitControls=new kx(Ep.particlePreview.camera,Ep.particlePreview.renderer.domElement),e.appendChild(Ep.particlePreview.renderer.domElement),this.scene=Ep.particlePreview.scene,this.style=t,this.showType=null,this.models=new sr,this.scene.add(this.models);let l=new sr;this.models.add(l);let c={getGroup:()=>l};this.modelItem=c,this.addParticleStore(t)}addParticleStore(e){let t=new Y_(this.modelItem);t.name=e.name,t.isPreview=!0,this.particleStores=t,Ep.animationStore.add(t),t.applySetting(e.particleData),t.resize(this.container.getBoundingClientRect().height),Ep.instance.nextRender((()=>{let e=(new Re).setFromObject(t.particleModelGroup),i=new Ce;e.getSize(i),Ep.particlePreview.camera.position.set(-3.6704,7.764482,1.206923),Ep.particlePreview.camera.rotation.set(-1.09211962,-.364872,-.6023735),Ep.particlePreview.camera.distance=20,Ep.particlePreview.camera.azimuthAngle=45,Ep.particlePreview.camera.inclinationAngle=-45})),Ep.particlePreview.hasRenderer=!0}removeParticleStore(){Ep.animationStore.remove(this.particleStores)}update(e,t,i){Ep.particlePreview.hasRenderer=!1,this.removeParticleStore(),this.addParticleStore(e),Ep.particlePreview.camera=new Zi(50,this.container.getBoundingClientRect().width/this.container.getBoundingClientRect().height,.1,1e3),Ep.particlePreview.camera.position.set(0,0,50),Ep.particlePreview.orbitControls=new kx(Ep.particlePreview.camera,Ep.particlePreview.renderer.domElement),Ep.particlePreview.hasRenderer=!0}dispose(){for(Ep.particlePreview.hasRenderer=!1,this.removeParticleStore(),_y.disposeThreeObject(this.models),Ep.particlePreview.scene.traverse((function(e){if(e.isMesh)if(e.geometry.dispose(),e.particle instanceof Array)for(let t of e.particle)t.dispose();else e.particle.dispose();e.isSprite&&e.particle.dispose()}));Ep.particlePreview.scene.children.length;)Ep.particlePreview.scene.remove(Ep.particlePreview.scene.children[0]);Ep.particlePreview.renderer.domElement&&this.container.removeChild(Ep.particlePreview.renderer.domElement),Ep.particlePreview.scene=null,Ep.particlePreview.camera=null,Ep.particlePreview.renderer.dispose(),Ep.particlePreview.renderer.forceContextLoss(),Ep.particlePreview.renderer.content=null;let e=Ep.particlePreview.renderer.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext(),Ep.particlePreview.renderer=null,Ep.particlePreview.orbitControls=null,Ep.particlePreview=null}setResolution(e,t){"number"!=typeof e||e<0||e>Oy||"number"!=typeof t||t<0||t>Dy||Ep.particlePreview.hasRenderer&&(Ep.particlePreview.camera.aspect=1*e/t,Ep.particlePreview.camera.updateProjectionMatrix(),Ep.particlePreview.renderer.setSize(e,t,!0),this.particleStores.resize(t))}}class Hx{constructor(e){this.enabled=!1,this.type=e,this.name=name,this.paused=!1,this.visible=!0,this.tags=[]}createHelper(e,t,i="#ffff00"){if(this.mesh.getObjectByName("__helper"))this.updateHelper(e,t,i);else{const n=new Re;n.setFromCenterAndSize(e,t);const a=new vh(n,new Qt(i));a.name="__helper",a.visible=!1,this.mesh.add(a)}}showHelper(){if(!this.mesh)return;let e=this.mesh.getObjectByName("__helper");e&&(e.visible=!0)}hideHelper(){if(!this.mesh)return;let e=this.mesh.getObjectByName("__helper");e&&(e.visible=!1)}updateHelper(e,t,i){if(!this.mesh)return;let n=this.mesh.getObjectByName("__helper");n&&(n.box.setFromCenterAndSize(e,t),void 0!==i&&(n.material.color=i))}}class Gx extends Hx{constructor(e){super("Firefly"),this.option=e,this.name=e.name,this.mesh=null,this.visible=!0;var t=new sn(10,10),i=new Jl;i.index=t.index,i.attributes=t.attributes;for(var n=new Float32Array(3*this.option.density),a=0;a<this.option.density;a++){let e=Math.random()*this.option.radius*2-this.option.radius,t=Math.random()*this.option.radius*2-this.option.radius,i=Math.random()*(this.option.endHeight-this.option.beginHeight)+this.option.beginHeight;n[3*a]=e,n[3*a+1]=i,n[3*a+2]=t}i.setAttribute("translate",new Ql(n,3));var r=new wo({uniforms:{map:{value:(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/firefly.png"))},time:{value:0},speed:{value:this.option.speed/100},color:{value:new Qt(this.option.color)},brightness:{value:this.option.brightness},size:{value:this.option.size},radius:{value:(this.option.endHeight-this.option.beginHeight)/10}},vertexShader:ab.vertexShader,fragmentShader:ab.fragmentShader,blending:1,transparent:!0,alphaTest:.2});this.mesh=new Fi(i,r),this.mesh.position.set(Number(this.option.position.x)+Number(this.option.offset.x),Number(this.option.position.y)+Number(this.option.offset.y),Number(this.option.position.z)+Number(this.option.offset.z)),this.mesh.name=this.option.name,Ep.scene.spaceEffects.add(this.mesh);let s=Ep.animationStore.findLayerAnimation(this.option.name,dv.type);if(s&&Ep.animationStore.remove(s),s=new dv(r),s.name=this.option.name,Ep.animationStore.add(s),null!=this.option.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh)),null==e.visible?(this.visible=!0,this.mesh.activeVisible=!0,this.mesh.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible),"function"==typeof this.createHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.option.endHeight-this.option.beginHeight;this.createHelper(new Ce(0,e,0),new Ce(2*this.option.radius,t,2*this.option.radius))}}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");let t=new sn(10,10),i=new Jl;i.index=t.index,i.attributes=t.attributes;let n=new Float32Array(3*this.option.density);for(let e=0;e<this.option.density;e++){let t=Math.random()*this.option.radius*2-this.option.radius,i=Math.random()*this.option.radius*2-this.option.radius,a=Math.random()*(this.option.endHeight-this.option.beginHeight)+this.option.beginHeight;n[3*e]=t,n[3*e+1]=a,n[3*e+2]=i}i.setAttribute("translate",new Ql(n,3));let a=new wo({uniforms:{map:{value:(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/firefly.png"))},time:{value:0},speed:{value:this.option.speed/100},color:{value:new Qt(this.option.color)},brightness:{value:this.option.brightness},size:{value:this.option.size}},vertexShader:ab.vertexShader,fragmentShader:ab.fragmentShader,transparent:!0,alphaTest:.2}),r=Ep.animationStore.findLayerAnimation(e.name,dv.type);if(r&&Ep.animationStore.remove(r),r=new dv(a),r.name=e.name,Ep.animationStore.add(r),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh)),this.mesh.position.x=Number(this.option.position.x)+Number(this.option.offset.x),this.mesh.position.y=Number(this.option.position.y)+Number(this.option.offset.y),this.mesh.position.z=Number(this.option.position.z)+Number(this.option.offset.z),this.mesh.geometry.dispose&&this.mesh.geometry.dispose(),this.mesh.geometry=i,this.mesh.material=a,"function"==typeof this.updateHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.option.endHeight-this.option.beginHeight;this.updateHelper(new Ce(0,e,0),new Ce(2*this.option.radius,t,2*this.option.radius))}}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=Ep.animationStore.findLayerAnimation(this.option.name,dv.type),t=Ep.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&Ep.animationStore.remove(e),t&&Ep.animationStore.remove(t),Ep.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Vx extends Hx{constructor(e){super("Rainline"),this.option=e,this.name=e.name,this.mesh=null,this.visible=!0;var t=new sn(1,1),i=new Jl;i.index=t.index,i.attributes=t.attributes;for(var n=new Float32Array(3*this.option.density),a=0;a<this.option.density;a++){let e=Math.random()*this.option.radius*2-this.option.radius,t=Math.random()*this.option.radius*2-this.option.radius,i=.5*this.option.endHeight;n[3*a]=e,n[3*a+1]=i,n[3*a+2]=t}i.setAttribute("translate",new Ql(n,3));var r=new wo({uniforms:{map:{value:(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/rainline.png"))},time:{value:0},speed:{value:this.option.speed},color:{value:new Qt(this.option.color)},brightness:{value:this.option.brightness},opacity:{value:this.option.opacity},width:{value:this.option.lineWidth},height:{value:this.option.endHeight-this.option.beginHeight}},vertexShader:cb.vertexShader,fragmentShader:cb.fragmentShader,depthTest:!0,depthWrite:!0,transparent:!0,alphaTest:.2});this.mesh=new Fi(i,r),this.mesh.position.set(Number(this.option.position.x)+Number(this.option.offset.x),Number(this.option.position.y)+Number(this.option.offset.y),Number(this.option.position.z)+Number(this.option.offset.z)),this.mesh.name=this.option.name,this.mesh.renderOrder=101,Ep.scene.spaceEffects.add(this.mesh);let s=Ep.animationStore.findLayerAnimation(this.option.name,Ev.type);if(s&&Ep.animationStore.remove(s),s=new Ev(r),s.name=this.option.name,Ep.animationStore.add(s),null!=this.option.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible),"function"==typeof this.createHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.mesh.material.uniforms.height.value;this.createHelper(new Ce(0,e,0),new Ce(2*this.option.radius,t,2*this.option.radius))}}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");let t=new sn(1,1),i=new Jl;i.index=t.index,i.attributes=t.attributes;let n=new Float32Array(3*this.option.density);for(let e=0;e<this.option.density;e++){let t=Math.random()*this.option.radius*2-this.option.radius,i=Math.random()*this.option.radius*2-this.option.radius,a=.5*(this.option.endHeight-this.option.beginHeight+this.option.beginHeight);n[3*e]=t,n[3*e+1]=a,n[3*e+2]=i}i.setAttribute("translate",new Ql(n,3));let a=new wo({uniforms:{map:{value:(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/rainline.png"))},time:{value:0},speed:{value:this.option.speed},color:{value:new Qt(this.option.color)},brightness:{value:this.option.brightness},opacity:{value:this.option.opacity},width:{value:this.option.lineWidth},height:{value:this.option.endHeight-this.option.beginHeight}},vertexShader:cb.vertexShader,fragmentShader:cb.fragmentShader,blending:1,depthTest:!0,depthWrite:!0,transparent:!0,alphaTest:.2}),r=Ep.animationStore.findLayerAnimation(e.name,Ev.type);if(r&&Ep.animationStore.remove(r),r=new Ev(a),r.name=e.name,Ep.animationStore.add(r),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh)),this.mesh.position.x=Number(this.option.position.x)+Number(this.option.offset.x),this.mesh.position.y=Number(this.option.position.y)+Number(this.option.offset.y),this.mesh.position.z=Number(this.option.position.z)+Number(this.option.offset.z),this.mesh.geometry.dispose&&this.mesh.geometry.dispose(),this.mesh.geometry=i,this.mesh.material=a,"function"==typeof this.updateHelper){let e=(this.option.endHeight+this.option.beginHeight)/2,t=this.mesh.material.uniforms.height.value;this.updateHelper(new Ce(0,e,0),new Ce(2*this.option.radius,t,2*this.option.radius))}}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=Ep.animationStore.findLayerAnimation(this.option.name,Ev.type),t=Ep.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&Ep.animationStore.remove(e),t&&Ep.animationStore.remove(t),Ep.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Wx extends Hx{constructor(e){super("Fireworks"),this.mesh=new sr,this.mesh.position.set(e.centerPos.x,e.centerPos.y,e.centerPos.z),this.mesh.name=e.name,this.option=e,this.name=e.name,this.visible=!0,this.mapTex=(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/firefly.png")),this.addFireworks(e,e.radius),Ep.scene.spaceEffects.add(this.mesh);let t=Ep.animationStore.findLayerAnimation(e.name,pv.type);if(t&&Ep.animationStore.remove(t),t=new pv(this.mesh,e),t.name=e.name,Ep.animationStore.add(t),null!=e.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=e.enableAutoHidebyDistance,this.mesh.minDistance=e.minDistance,this.mesh.maxDistance=e.maxDistance,Ep.animationStore.addDistance(e.name,yy,Ep.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible),"function"==typeof this.createHelper){let e=this.option.topHeight+this.option.bottomHeight,t=this.option.topHeight-this.option.bottomHeight+this.option.centerPos.y+this.option.offset.y;this.createHelper(new Ce(0,e,0),new Ce(2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight),2*t,2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight)))}}addFireworks(e,t){for(let i=0;i<t;i++){let t=new sr;t.pos={};let i=e.centerPos.x+Number(e.offset.x)+2*e.range*Math.random()-e.range,n=Number(e.offset.y)+e.bottomHeight+(e.topHeight-e.bottomHeight)*Math.random(),a=e.centerPos.z+Number(e.offset.z)+2*e.range*Math.random()-e.range;t.pos.x=i,t.pos.y=n,t.pos.z=a,t.position.x=i,t.position.y=n,t.position.z=a,t.speed=e.speed+e.speedR*Math.random(),t.lifetime=e.lifetime+e.lifetimeR*Math.random(),t.leaveTime=0,t.currentTime=0;let r=new vr({opacity:0,color:new Qt(e.color),transparent:!0,map:this.mapTex});r.blending=1;for(let i=0;i<100;i++){let i=new Or(r);i.scale.set(e.size,e.size,e.size),i.position.set(t.pos.x,t.pos.y,t.pos.z),i.dir=new Ce(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).normalize(),t.add(i)}this.mesh.add(t)}}update(e){this.mesh.position.set(e.centerPos.x,e.centerPos.y,e.centerPos.z),this.mesh.name=e.name;for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");if(this.mesh.children.length>this.option.radius)for(var t=this.mesh.children.length-1;this.mesh.children.length>this.option.radius+1;t--)"Box3Helper"!==this.mesh.children[t].type&&this.mesh.children.splice(t,1);else if(this.mesh.children.length<this.option.radius+1){let e=this.option.radius-this.mesh.children.length+1;this.addFireworks(this.option,e)}for(t=0;t<this.mesh.children.length;t++){if("Box3Helper"===this.mesh.children[t].type)continue;this.mesh.children[t].pos={};let n=this.option.centerPos.x+Number(this.option.offset.x)+2*this.option.range*Math.random()-this.option.range,a=Number(e.offset.y)+this.option.bottomHeight+(this.option.topHeight-this.option.bottomHeight)*Math.random(),r=this.option.centerPos.z+Number(this.option.offset.z)+2*this.option.range*Math.random()-this.option.range;this.mesh.children[t].pos.x=n,this.mesh.children[t].pos.y=a,this.mesh.children[t].pos.z=r,this.mesh.children[t].position.x=n,this.mesh.children[t].position.y=a,this.mesh.children[t].position.z=r,this.mesh.children[t].speed=this.option.speed+this.option.speedR*Math.random(),this.mesh.children[t].lifetime=this.option.lifetime+this.option.lifetimeR*Math.random(),this.mesh.children[t].color=this.option.color;let s=_y.colorToRGBAObject(this.option.color);for(var i=0;i<this.mesh.children[t].children.length;i++)this.mesh.children[t].children[i].material.color.r=s.r,this.mesh.children[t].children[i].material.color.g=s.g,this.mesh.children[t].children[i].material.color.b=s.b,this.mesh.children[t].children[i].scale.set(this.option.size,this.option.size,this.option.size)}let n=Ep.animationStore.findLayerAnimation(this.option.name,pv.type);if(n&&Ep.animationStore.remove(n),n=new pv(this.mesh,this.option),n.name=this.option.name,Ep.animationStore.add(n),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh)),"function"==typeof this.createHelper){let e=this.option.topHeight+this.option.bottomHeight,t=this.option.topHeight-this.option.bottomHeight+this.option.centerPos.y+this.option.offset.y;this.updateHelper(new Ce(0,e,0),new Ce(2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight),2*t,2*(this.option.range+this.option.size+this.option.radius+this.option.topHeight+this.option.bottomHeight)))}}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=Ep.animationStore.findLayerAnimation(this.mesh.name,pv.type),t=Ep.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&Ep.animationStore.remove(e),t&&Ep.animationStore.remove(t),Ep.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Yx extends Hx{constructor(e){super("Rain"),this.name=e.name,this.mesh=new sr,this.mesh.name=e.name,this.mesh.renderOrder=102,this.visible=!0,this.option=e;var t=new wi,i=[],n=[],a=(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/rain.png"));const r=1+Ep.worldScale/100,s=2e3*r;for(var o=0;o<e.density;o++){var l=(Math.random()-.5)*s,c=(Math.random()-.5)*(s/2),h=(Math.random()-.5)*s;i.push(l,c,h)}t.setAttribute("position",new hi(i,3));var u=[[[1,.2,.5],a,e.size*r],[[1,.2,.2],a,e.size*r],[[.95,.1,.5],a,e.size*r]];for(o=0;o<u.length;o++){u[o][0];a=u[o][1];var d=u[o][2];n[o]=new cs({size:d,map:a,blending:1,depthWrite:!1,transparent:!0,color:new Qt("#ffffff")});var p=new ms(t,n[o]);p.visible=!0,p.rotation.x=6*Math.random(),p.rotation.y=6*Math.random(),p.rotation.z=6*Math.random(),p.position.y=500*Math.random()-250,this.mesh.add(p)}this.mesh.rotation.z=ge.degToRad(this.option.direction),this.mesh.position.x=e.offset.x,this.mesh.position.y=e.offset.y,this.mesh.position.z=e.offset.z,Ep.scene.spaceEffects.add(this.mesh);let m=Ep.animationStore.findLayerAnimation(e.name,Av.type);m&&Ep.animationStore.remove(m),m=new Av(this.mesh,e.followCamera,r),m.name=e.name,Ep.animationStore.add(m),null!=e.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=e.enableAutoHidebyDistance,this.mesh.minDistance=e.minDistance,this.mesh.maxDistance=e.maxDistance,Ep.animationStore.addDistance(e.name,yy,Ep.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible)}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");for(var t=new wi,i=[],n=(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/rain.png")),a=0;a<this.option.density;a++){var r=2e3*Math.random()-1e3,s=1e3*Math.random(),o=2e3*Math.random()-1e3;i.push(r,s,o)}t.setAttribute("position",new hi(i,3));n=(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/rain.png"));var l=this.option.size,c=new cs({size:l,map:n,blending:1,depthWrite:!1,transparent:!0,color:new Qt("#ffffff")});for(a=0;a<this.mesh.children.length;a++)this.mesh.children[a].geometry.dispose&&this.mesh.children[a].geometry.dispose(),this.mesh.children[a].geometry=t,this.mesh.children[a].material=c;this.mesh.rotation.z=ge.degToRad(this.option.direction),this.mesh.position.x=this.option.offset.x,this.mesh.position.y=this.option.offset.y,this.mesh.position.z=this.option.offset.z;let h=Ep.animationStore.findLayerAnimation(this.option.name,Av.type);h&&Ep.animationStore.remove(h);const u=1+Ep.worldScale/100;h=new Av(this.mesh,e.followCamera,u),h.name=this.option.name,Ep.animationStore.add(h),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh))}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=Ep.animationStore.findLayerAnimation(this.option.name,Av.type),t=Ep.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&Ep.animationStore.remove(e),t&&Ep.animationStore.remove(t),Ep.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Xx extends Hx{constructor(e){super("Snow"),this.name=e.name,this.mesh=new sr,this.mesh.name=e.name,this.mesh.renderOrder=103,this.visible=!0,this.option=e;var t=new wi,i=[],n=[],a=(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/snow.png"));const r=1+Ep.worldScale/100,s=2e3*r;for(var o=0;o<e.density;o++){var l=(Math.random()-.5)*s,c=(Math.random()-.5)*(s/2),h=(Math.random()-.5)*s;i.push(l,c,h)}t.setAttribute("position",new hi(i,3));var u=[[[1,.2,.5],a,e.size*r],[[1,.2,.2],a,e.size*r],[[.95,.1,.5],a,e.size*r]];for(o=0;o<u.length;o++){u[o][0];a=u[o][1];var d=u[o][2];n[o]=new cs({size:d,map:a,blending:1,depthWrite:!1,transparent:!0,color:new Qt("#ffffff")});var p=new ms(t,n[o]);p.visible=!0,p.rotation.x=6*Math.random(),p.rotation.y=6*Math.random(),p.rotation.z=6*Math.random(),p.position.y=500*Math.random()-250,this.mesh.add(p)}this.mesh.rotation.z=ge.degToRad(this.option.direction),this.mesh.position.x=e.offset.x,this.mesh.position.y=e.offset.y,this.mesh.position.z=e.offset.z,Ep.scene.spaceEffects.add(this.mesh);let m=Ep.animationStore.findLayerAnimation(e.name,Iv.type);m&&Ep.animationStore.remove(m),m=new Iv(this.mesh,e.followCamera,r),m.name=e.name,Ep.animationStore.add(m),null!=e.enableAutoHidebyDistance&&(this.mesh.activeVisible=!0,this.mesh.enableAutoHidebyDistance=e.enableAutoHidebyDistance,this.mesh.minDistance=e.minDistance,this.mesh.maxDistance=e.maxDistance,Ep.animationStore.addDistance(e.name,yy,Ep.camera,this.mesh)),null==e.visible?(this.visible=!0,this.option.visible=!0):(e.visible,this.visible=e.visible,this.mesh.activeVisible=e.visible,this.mesh.visible=e.visible,this.option.visible=e.visible)}update(e){for(let t in e)null!=this.option[t]?this.option[t]!==e[t]&&(this.option[t]=e[t]):logger.warn(t+"属性不存在");for(var t=new wi,i=[],n=0;n<this.option.density;n++){var a=2e3*Math.random()-1e3,r=1e3*Math.random(),s=2e3*Math.random()-1e3;i.push(a,r,s)}t.setAttribute("position",new hi(i,3));var o=(new al).load(_y.url(Ep.instance.resourceBasePath,"texture/effects/snow.png")),l=this.option.size,c=new cs({size:l,map:o,blending:1,depthWrite:!1,transparent:!0,color:new Qt("#ffffff")});for(n=0;n<this.mesh.children.length;n++)this.mesh.children[n].geometry.dispose&&this.mesh.children[n].geometry.dispose(),this.mesh.children[n].geometry=t,this.mesh.children[n].material=c;this.mesh.rotation.z=ge.degToRad(this.option.direction),this.mesh.position.x=this.option.offset.x,this.mesh.position.y=this.option.offset.y,this.mesh.position.z=this.option.offset.z;let h=Ep.animationStore.findLayerAnimation(this.option.name,Iv.type);h&&Ep.animationStore.remove(h);const u=1+Ep.worldScale/100;h=new Iv(this.mesh,e.followCamera,u),h.name=this.option.name,Ep.animationStore.add(h),null!=this.option.enableAutoHidebyDistance&&(this.mesh.enableAutoHidebyDistance=this.option.enableAutoHidebyDistance,this.mesh.minDistance=this.option.minDistance,this.mesh.maxDistance=this.option.maxDistance,Ep.animationStore.addDistance(this.option.name,yy,Ep.camera,this.mesh))}hide(){this.visible=!1,this.mesh.visible=!1,this.mesh.activeVisible=!1,this.option.visible=!1}show(){this.visible=!0,this.mesh.visible=!0,this.mesh.activeVisible=!0,this.option.visible=!0}remove(){let e=Ep.animationStore.findLayerAnimation(this.mesh.name,Iv.type),t=Ep.animationStore.findLayerAnimation(this.option.name,"DistanceController");e&&Ep.animationStore.remove(e),t&&Ep.animationStore.remove(t),Ep.scene.spaceEffects.remove(this.mesh),delete this.mesh}}class Zx{constructor(){this._enabled=void 0,this._effects=[],Ep.scene.spaceEffects=new sr("__spaceEffects"),Ep.scene.spaceEffects.name="__spaceEffects",Ep.scene.add(Ep.scene.spaceEffects)}get enabled(){return this._enabled}set enabled(e){_y.isBoolean(e)}addEffect(e){if(void 0!==this.findEffect(e.name)&&this.findEffect(e.name))logger.warn("name为"+e.name+"的特效已存在");else if("firefly"==e.type){let t=new Gx(e);this._effects.push(t)}else if("rainline"==e.type){let t=new Vx(e);this._effects.push(t)}else if("fireworks"==e.type){let t=new Wx(e);this._effects.push(t)}else if("rain"==e.type){let t=new Yx(e);this._effects.push(t)}else if("snow"==e.type){let t=new Xx(e);this._effects.push(t)}}findEffect(e){return this._effects.find((t=>e===t.name))}updateEffect(e,t){void 0!==this.findEffect(e)&&this.findEffect(e)?this.findEffect(e).update(t):logger.warn("name为"+e+"的特效不存在")}removeEffect(e){for(let t=0;t<this._effects.length;t++)if(e===this._effects[t].name){_y.disposeThreeObject(this._effects[t].mesh),this._effects[t].remove(),this._effects.splice(t,1);break}}renameEffect(e,t){if(void 0!==this.findEffect(t)&&this.findEffect(t))if(this.findEffect(e))logger.warn("name为"+e+"的特效已存在");else{let i=this.findEffect(t);i.name=e,i.mesh.name=e,i.option.name=e}else logger.warn("name为"+t+"的特效不存在")}hideEffect(e){void 0!==this.findEffect(e)&&this.findEffect(e)?this.findEffect(e).hide():logger.warn("name为"+e+"的特效不存在")}showEffect(e){void 0!==this.findEffect(e)&&this.findEffect(e)?this.findEffect(e).show():logger.warn("name为"+e+"的特效不存在")}hideHelpers(){for(let e=0;e<this._effects.length;e++)this._effects[e]&&"function"==typeof this._effects[e].hideHelper&&this._effects[e].hideHelper()}getSettings(){let e=[];for(let t=0;t<this._effects.length;t++)e.push(JSON.parse(JSON.stringify(this._effects[t])));return e.map((e=>{delete e.mesh})),e}applySettings(e){if(this._effects&&this._effects.length>0)for(let e=this._effects.length-1;e>=0;e--)this.removeEffect(this._effects[e].name);!e||!e.length>0||e.map((e=>{if("firefly"===e.option.type){let t=new Gx(e.option);this._effects.push(t)}else if("rainline"===e.option.type){let t=new Vx(e.option);this._effects.push(t)}else if("fireworks"===e.option.type){let t=new Wx(e.option);this._effects.push(t)}else if("rain"==e.option.type){let t=new Yx(e.option);this._effects.push(t)}else if("snow"==e.option.type){let t=new Xx(e.option);this._effects.push(t)}}))}}class qx{constructor(){let e=Date.now(),t=e,i=0,n=0;this.start=()=>{e=Date.now()},this.stop=()=>{i++;var e=Date.now();return e>=t+1e3&&(n=Math.round(1e3*i/(e-t)),t=e,i=0),e},this.update=()=>{e=this.stop()},this.getRendererInfo=e=>({fps:n,geometries:e.info.memory.geometries,textures:e.info.memory.textures,calls:e.info.render.calls,faces:Math.floor((e.info.render.triangles-18)/3)<0?0:Math.floor((e.info.render.triangles-18)/3),vertices:e.info.render.triangles-18<0?0:e.info.render.triangles-18})}}class Jx{constructor({id:e=_y.guid(),name:t=""}={},i){this._id=e,this._name=t,this._camera={positionX:0,positionY:0,positionZ:0,azimuth:0,inclination:0,inclinationMin:0,inclinationMax:90,fov:45,distance:1500,distanceMin:350,distanceMax:2e3,viewDistanceMin:350,viewDistanceMax:2e3,viewLimitRadius:0,autoRotate:!1,autoRotateSpeed:60,duration:1.5,autoRotateDirection:"CW"},this._boundary={enabled:!1},this._cameraPath={enabled:!1},this._context=i}get camera(){return this._camera}set camera(e){this._camera=e,this._context}getSettings(){return this._camera.positionX=this._context.orbitControl.object.position.x,this._camera.positionY=this._context.orbitControl.object.position.y,this._camera.positionZ=this._context.orbitControl.object.position.z,this._camera.azimuth=this._context.orbitControl.getAzimuthalAngle()/Math.PI*180,this._camera.inclination=this._context.orbitControl.getPolarAngle()/(Math.PI/2)*90-90,this._camera.inclinationMin=this._context.minInclination,this._camera.inclinationMax=this._context.maxInclination,this._camera.fov=this._context.orbitControl.object.fov,this._camera.distance=Math.abs(this._context.orbitControl.object.position.clone().sub(this._context.orbitControl.target).length()),this._camera.distanceMin=this._context.orbitControl.minDistance,this._camera.distanceMax=this._context.orbitControl.maxDistance,this._camera.viewDistanceMin=this._context.orbitControl.object.near,this._camera.viewDistanceMax=this._context.orbitControl.object.far,this._camera.targetX=this._context.orbitControl.target.x,this._camera.targetY=this._context.orbitControl.target.y,this._camera.targetZ=this._context.orbitControl.target.z,this._camera.inclinationAngleMin=this._context.orbitControl.minPolarAngle/Math.PI*180-90,this._camera.inclinationAngleMax=this._context.orbitControl.maxPolarAngle/Math.PI*180-90,this._camera.viewLimitRadius=this._camera.viewLimitRadius,this._camera.autoRotate=this._camera.autoRotate,this._camera.duration=this._camera.duration,this._camera.autoRotateSpeed=this._camera.autoRotateSpeed,this._camera.autoRotateDirection=this._camera.autoRotateDirection,{camera:this._camera}}applySettings(e,t,i){if(logger.debug(e),!e)return void logger.error("无效的视野设置。");this._camera={...this._camera,...e.camera};let n=this._context.orbitControl.object,a=this._camera.distanceMax,r=this._camera.distanceMin;n.fov=_y.numberOrDefault(this._camera.fov,n.fov),n.near=_y.numberOrDefault(this._camera.viewDistanceMin,n.near),n.far=_y.numberOrDefault(this._camera.viewDistanceMax,n.far),this._context.orbitControl.minDistance=0,this._context.orbitControl.maxDistance=1e6,null!=e.camera.inclinationAngleMin&&(this._context.orbitControl.minPolarAngle=(e.camera.inclinationAngleMin+90)/180*Math.PI),null!=e.camera.inclinationAngleMax&&(this._context.orbitControl.maxPolarAngle=(e.camera.inclinationAngleMax+90)/180*Math.PI),n.updateProjectionMatrix(),this._context.orbitControl.defaultTargetPosition=new Ce(this._camera.targetX,this._camera.targetY,this._camera.targetZ),this._context.orbitControl.viewLimitRadius=this._camera.viewLimitRadius,Ep.instance.cameraFlyTo(new Ce(this._camera.targetX,this._camera.targetY,this._camera.targetZ),this._camera.azimuth,this._camera.inclination,this._camera.distance,i?0:this._camera.duration||0,!0,(()=>{this._context.minInclination=_y.numberOrDefault(this._camera.inclinationMin,this._context.minInclination),this._context.maxInclination=_y.numberOrDefault(this._camera.inclinationMax,this._context.maxInclination),this._context.orbitControl.minDistance=_y.numberOrDefault(r,this._context.minDistance),this._context.orbitControl.maxDistance=_y.numberOrDefault(a,this._context.maxDistance),t&&t(1)}))}}Jx._fromThreeObject=function(e){if(!e)return new Jx;return new Jx};class Qx{constructor(){this.cachedPasses=-1,this._enabled=void 0,this._size=new ye(0,0),Ep.renderer.getSize(this._size),this._passes={},this._enableSSR=!1,this._ssrIntensity=1,this._ssrQuality=1,this._ssrOpacity=1,this._ssrThickness=1,this._ssrMaxDistance=10,this._enableSSAO=!1,this._ssaoRadius=5,this._ssaoIntensity=10,this._ssaoQuality=.5,this._ssaoKernelRadius=5,this._ssaoMinDistance=0,this._ssaoMaxDistance=10,this._enableGrain=!1,this._grainIntensity=.2,this._enableEdgeBlur=!1,this._edgeBlurRadius=.2,this._edgeBlurIntensity=1,this._enableDOF=!1,this._dofDistanceForground=10,this._dofDistanceBackground=100,this._dofQuality=.5,this._dofFocus="manual",this._dofFocusTarget=new Ce(0,0,0),this._dofFocusDistance=0,this._dofFocalDistance=.5,this._enableSharpen=!1,this._sharpenIntensity=.1,this._enableChromaticAberration=!1,this._chromaticAberrationIntensity=.2,this._enableBloom=!1,this._bloomThreshold=1,this._bloomBrightness=1,this._bloomRadius=1,this._enableToneMapping=!1,this._toneMappingExposure=1,this._toneMappingBrightness=0,this._toneMappingContrast=0,this._toneMappingHue=0,this._toneMappingSaturation=0,this._enableColorBalance=!1,this._colorBalanceHue=1,this._colorBalanceR=1,this._colorBalanceG=1,this._colorBalanceB=1,this._enableImageAdjustment=!1,this._imageAdjustmentExposure=0,this._imageAdjustmentSaturation=0,this._imageAdjustmentHue=0,this._imageAdjustmentHighlight=0,this._imageAdjustmentShadow=0,this._imageAdjustmentContrast=0,this._imageAdjustmentBrightness=0,this._imageAdjustmentNaturalSaturation=0,this._imageAdjustmentTemperature=0,this._imageAdjustmentTint=0,this._imageAdjustmentClarity=0,this._enableFog=!1,this._fogDistance=100,this._fogIntensity=1,this._fogDistanceNear=10,this._fogDistanceFar=200,this._fogColor=void 0,this._fogColor0=void 0,this._fogColorFromSkybox=void 0,this._fogAutoColor=!0,this._enableAntialias=!1,this._antialiasType="SMAA",this._antialiasSampleCount=8,this._antialiasColorDiff=!0,this._antialiasPixelReject=!0,this._enableLUT=!1,this._lutIntensity=1,this._lutSelected="Arabica 12",this._lutCustom="",this._lutCustomName="",this._enableWatermark=!0,this._watermark="";const e=new pb;let t=new Td(Ep.scene,Ep.camera,{edgeStrength:3,visibleEdgeColor:16772608,hiddenEdgeColor:16772608,blur:!0,edgeStrength:32,kernelSize:0});this._passes.outlinePass=new sd(Ep.camera,t),this._passes.outlinePass.name="OutlinePass",this._passes.outlinePass.outlineEffect=t;let i=new Td(Ep.scene,Ep.camera,{blendFunction:Qu.SCREEN,edgeStrength:32,pulseSpeed:0,height:1080,blur:!1,xRay:!0});i.blur=!0,i.blurPass.kernelSize=1,this._passes.articulationOutlinePass=new sd(Ep.camera,i),this._passes.articulationOutlinePass.name="ArticulationOutlineEffect",this._passes.articulationOutlinePass.articulationOutlineEffect=i,this._lutMap={"Arabica 12":null,"Chemical 168":null,"Clayton 33":null,"Django 25":null,"Faded 47":null,"Fusion 88":null,"Hyla 68":null,"Lenox 340":null,"Lucky 64":null,"Paladin 1875":null,"Pasadena 21":null,"Pitaya 15":null,"Sprocket 231":null,"Teigen 28":null,"Zeke 39":null},this._passes.normalPass=new cd(Ep.scene.models,Ep.camera),this._passes.normalPass.name="NormalPass",this._passes.depthDownsamplingPass=new Ju({normalBuffer:this._passes.normalPass.texture,resolutionScale:.5}),this._passes.depthDownsamplingPass.name="DepthDownsamplingPass";const n=Ep.renderer.capabilities.isWebGL2?this._passes.depthDownsamplingPass.texture:null;let a=new Pd(Ep.camera,this._passes.normalPass.texture,{blendFunction:Qu.MULTIPLY,distanceScaling:!1,depthAwareUpsampling:!0,normalDepthBuffer:n,samples:9,rings:7,distanceThreshold:100/(Ep.camera.far-Ep.camera.near),distanceFalloff:25/(Ep.camera.far-Ep.camera.near),rangeThreshold:1/(Ep.camera.far-Ep.camera.near),rangeFalloff:.3/(Ep.camera.far-Ep.camera.near),luminanceInfluence:.7,minRadiusScale:.33,radius:.1,intensity:1,bias:.025,fade:.01,color:new Qt(0),resolutionScale:.5});a.blendMode.opacity.value=0;const r=new Md({blendFunction:Qu.COLOR_DODGE});r.blendMode.opacity.value=0;const s=new fd(Ep.camera,{blendFunction:Qu.SKIP,focusDistance:0,focalLength:.048,bokehScale:2,height:720});s.blurPass.kernelSize=5,s.circleOfConfusionMaterial.uniforms.focusDistance.value=0,s.circleOfConfusionMaterial.uniforms.focalLength.value=.048;const o=new md({blendFunction:Qu.SKIP}),l=new Od({blendFunction:Qu.SKIP,texture:s.renderTargetCoC.texture});let c=new Yi(hb);c.uniforms.width.value=this._size.width,c.uniforms.height.value=this._size.height,c.uniforms.intensity.value=1,this._passes.sharpenPass=new hd(c,"tDiffuse"),this._passes.sharpenPass.name="SharpenPass",this._passes.sharpenPass.sharpenMaterial=c,this._passes.sharpenPass.enabled=!1;let h=new Yi(ob);h.shaderType="LensDistortionShader",h.defines.BAND_MODE=2,h.defines.CHROMA_SAMPLES=16,h.uniforms.baseIor.value=1,h.uniforms.bandOffset.value=0,h.uniforms.jitterIntensity.value=.5,this._passes.distortPass=new hd(h,"tDiffuse"),this._passes.distortPass.name="ChromaticAberrationPass",this._passes.distortPass.distortMaterial=h;let u=new dd({blendFunction:Qu.SCREEN,kernelSize:wu.MEDIUM,luminanceThreshold:.4,luminanceSmoothing:.1,height:480});u.blendMode.opacity.value=0,this._enableFog=!1,this._fogDistance=100,this._fogIntensity=1,this._fogDistanceNear=10,this._fogDistanceFar=200,this._fogColor=void 0,this._fogColor0=void 0,this._fogColorFromSkybox=void 0,this._fogAutoColor=!0;new Ld(Ep.defaultLoadingManager).load((([e,t])=>{const i=new Cd(e,t,Id.ULTRA,Eu.COLOR);i.edgeDetectionMaterial.setLocalContrastAdaptationFactor(2.5),i.edgeDetectionMaterial.setEdgeDetectionThreshold(.02),i.edgeDetectionMaterial.setPredicationMode(Cu),i.edgeDetectionMaterial.setPredicationThreshold(.02),i.edgeDetectionMaterial.setPredicationScale(1),i.blendMode.opacity.value=0,this._passes.smaaPass=new sd(Ep.camera,i),this._passes.smaaPass.name="SMAAPass",this._passes.smaaPass.smaaEffect=i,this._passes.smaaPass.renderToScreen=!0,this._passes.smaaPass.encodeOutput=!0,this.addPass(this._passes.smaaPass)}));let d=new pd({blendFunction:Qu.NORMAL}),p=new yd({blendFunction:Qu.NORMAL});d.uniforms.get("brightness").value=0,d.uniforms.get("contrast").value=0,p.setHue(0),p.uniforms.get("saturation").value=0,this._passes.colorGradingPass=new sd(Ep.camera,d,p),this._passes.colorGradingPass.name="ColorGradingPass",this._passes.colorGradingPass.brightnessContrastEffect=d,this._passes.colorGradingPass.hueSaturationEffect=p;const m=Math.sin(ge.degToRad(this._imageAdjustmentHue)),f=Math.cos(ge.degToRad(this._imageAdjustmentHue));let g=new sb({blendFunction:Qu.NORMAL,exposure:this._imageAdjustmentExposure,saturation:this._imageAdjustmentSaturation,hue:new Ce(2*f,-Math.sqrt(3)*m-f,Math.sqrt(3)*m-f).addScalar(1).divideScalar(3),highlight:this._imageAdjustmentHighlight,shadow:this._imageAdjustmentShadow,contrast:this._imageAdjustmentContrast,brightness:this._imageAdjustmentBrightness,naturalSaturation:this._imageAdjustmentNaturalSaturation,temperature:this._imageAdjustmentTemperature,tint:this._imageAdjustmentTint,clarity:this._imageAdjustmentClarity});g.name="ImageAdjustmentEffect",this._passes.imageAdjustmentPass=new sd(Ep.camera,g),this._passes.imageAdjustmentPass.name="ImageAdjustmentPass",this._passes.imageAdjustmentPass.imageAdjustmentEffect=g,Ep.composer.addPass(this._passes.imageAdjustmentPass),this._passes.ssaoPass=new sd(Ep.camera,a),this._passes.ssaoPass.name="SSAOPass",this._passes.ssaoPass.ssaoEffect=a,this._passes.bloomPass=new sd(Ep.camera,u),this._passes.bloomPass.name="BloomPass",this._passes.bloomPass.bloomEffect=u,this._passes.ssrDepthPass=new qu(Ep.scene.models,Ep.camera),this._passes.ssrDepthPass.name="SSRDepthPass";const y=new ub(Ep.camera,{depthBuffer:this._passes.ssrDepthPass.texture,normalBuffer:this._passes.normalPass.texture,width:window.innerWidth,height:window.innerHeight,scene:Ep.scene.models,opacity:1});this._passes.ssrPass=new sd(Ep.camera,y),this._passes.ssrPass.name="SSRPass",this._passes.ssrPass.ssrEffect=y,this._passes.ssrDepthPass.enabled=!1,this._passes.ssrPass.enabled=!1,this._passes.dofPass=new sd(Ep.camera,s,l,o),this._passes.dofPass.name="DOFPass",this._passes.dofPass.depthOfFieldEffect=s,this._passes.dofPass.cocTextureEffect=l,this._passes.dofPass.depthEffect=o,this._passes.watermarkPass=new sd(Ep.camera,e),this._passes.watermarkPass.name="WatermarkPass",this._passes.watermarkPass.watermarkEffect=e,this._passes.grainPass=new sd(Ep.camera,r),this._passes.grainPass.name="GrainPass",Ep.composer.addPass(this._passes.outlinePass),Ep.composer.addPass(this._passes.articulationOutlinePass),Ep.BlendFunction=Qu,this._passes.edgeBlurPass=new nb,this._passes.edgeBlurPass.name="EdgeBlurPass",this._passes.edgeBlurPass.enabled=!1,this.addPass=e=>{if(this.findActivePassPosition(e.name)>-1)return;let t=this.findPassPosition(e.name);if(t<1)return;let i=0;for(let e=t-1;e>0;e--){let t=this.findActivePassPosition(Qx.PASS_ORDER[e]);if(-1!==t){i=t;break}}Ep.composer.addPass(e,i+1),this.setRenderToScreen(),this.findActivePassPosition("CacheBufferPass")>-1?this.cachedPasses=this.findActivePassPosition("CacheBufferPass"):this.cachedPasses=-1},this.removePass=e=>{e&&(Ep.composer.removePass(e),this.setRenderToScreen(),this.findActivePassPosition("CacheBufferPass")>-1?this.cachedPasses=this.findActivePassPosition("CacheBufferPass"):this.cachedPasses=-1)},this.setRenderToScreen=()=>{for(let e of Ep.composer.passes)e.renderToScreen=!1;Ep.composer.passes[Ep.composer.passes.length-1].renderToScreen=!0},this.findPassPosition=e=>{if(!e)return-1;let t=-1;for(let i=0;i<Qx.PASS_ORDER.length;i++)Qx.PASS_ORDER[i]===e&&(t=i);return t},this.findActivePassPosition=e=>{if(!e)return-1;let t=-1;for(let i=0;i<Ep.composer.passes.length;i++)Ep.composer.passes[i].name===e&&(t=i);return t}}get enabled(){return this._enabled}set enabled(e){_y.isBoolean(e)&&(this.enableWatermark=this.enableSSR=this.enableSSAO=this.enableGrain=this.enableEdgeBlur=this.enableDOF=this.enableSharpen=this.enableChromaticAberration=this.enableBloom=this.enableToneMapping=this.enableColorBalance=this.enableFog=this.enableAntialias=this.enableLUT=this.enableImageAdjustment=this._enabled=e,Ep.sceneBufferCacheExpired=!0)}get enableWatermark(){return this._enableWatermark}set enableWatermark(e){if(!_y.isBoolean(e))return;let t=this._enableWatermark=e,i=this._passes.watermarkPass.watermarkEffect,n=t?Qu.NORMAL:Qu.SKIP;i.blendMode.setBlendFunction(n),Ep.sceneBufferCacheExpired=!0}get watermark(){return this._watermark}set watermark(e){Ep.loaders.textureLoader.load(e,(t=>{this._passes.watermarkPass.watermarkEffect.setMap(t),this._watermark=e})),Ep.sceneBufferCacheExpired=!0}get enableSSR(){return this._enableSSR}set enableSSR(e){_y.isBoolean(e)&&(this._enableSSR=e,this._passes.ssrDepthPass.enabled=this._enableSSR,this._passes.ssrPass.enabled=this._enableSSR,this._enableSSAO||this._enableSSR?this.addPass(this._passes.normalPass):this.removePass(this._passes.normalPass),this._enableSSR?(this.addPass(this._passes.ssrDepthPass),this.addPass(this._passes.ssrPass)):(this.removePass(this._passes.ssrDepthPass),this.removePass(this._passes.ssrPass)),Ep.sceneBufferCacheExpired=!0)}get ssrOpacity(){return this._ssrOpacity}set ssrOpacity(e){"number"!=typeof e||e<0||e>1||(this._ssrOpacity=e,this._passes.ssrPass.ssrEffect.uniforms.get("opacity").value=this._ssrOpacity,Ep.sceneBufferCacheExpired=!0)}get ssrThickness(){return this._ssrThickness}set ssrThickness(e){"number"!=typeof e||e<0||(this._ssrThickness=e,this._passes.ssrPass.ssrEffect.uniforms.get("thickness").value=this._ssrThickness,Ep.sceneBufferCacheExpired=!0)}get ssrMaxDistance(){return this._ssrMaxDistance}set ssrMaxDistance(e){"number"!=typeof e||e<0||(this._ssrMaxDistance=e,this._passes.ssrPass.ssrEffect.uniforms.get("maxDistance").value=this._ssrMaxDistance,Ep.sceneBufferCacheExpired=!0)}get ssrIntensity(){return this._ssrIntensity}set ssrIntensity(e){"number"!=typeof e||e<0||e>1||(this._ssrIntensity=e,this._passes.ssrPass.ssrEffect.uniforms.get("opacity").value=this._ssrIntensity,Ep.sceneBufferCacheExpired=!0)}get ssrQuality(){return this._ssrQuality}set ssrQuality(e){"number"!=typeof e||e<0||(this._ssrQuality=e,this._passes.ssrPass.ssrEffect.uniforms.get("maxDistance").value=this._ssrQuality,Ep.sceneBufferCacheExpired=!0)}get enableSSAO(){return this._enableSSAO}set enableSSAO(e){if(!_y.isBoolean(e))return;this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=e)?Qu.MULTIPLY:Qu.SKIP);let t=9;this._ssaoQuality<=.5&&this._ssaoQuality>=0?t=this._ssaoQuality/.5*8+1:this._ssaoQuality>.5&&this._ssaoQuality<=1&&(t=(this._ssaoQuality-.5)/.5*91+9),this._passes.ssaoPass.ssaoEffect.samples=t,this._passes.ssaoPass.ssaoEffect.blendMode.opacity.value=this._ssaoIntensity;let i=this._ssaoMaxDistance/(Ep.camera.far-Ep.camera.near),n=i/4;this._passes.ssaoPass.ssaoEffect.setDistanceCutoff(i,n),this._enableSSAO||this._enableSSR?this.addPass(this._passes.normalPass):this.removePass(this._passes.normalPass),this._enableSSAO?(Ep.renderer.capabilities.isWebGL2&&this.addPass(this._passes.depthDownsamplingPass),this.addPass(this._passes.ssaoPass)):(Ep.renderer.capabilities.isWebGL2&&this.removePass(this._passes.depthDownsamplingPass),this.removePass(this._passes.ssaoPass)),this._updateCameraProjection(Ep.camera),Ep.sceneBufferCacheExpired=!0}get ssaoKernelRadius(){return this._ssaoKernelRadius}set ssaoKernelRadius(e){if("number"!=typeof e)return;this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?Qu.MULTIPLY:Qu.SKIP),this._ssaoKernelRadius=Math.max(e,0);let t=this._ssaoKernelRadius/(Ep.camera.far-Ep.camera.near),i=t/3;this._passes.ssaoPass.ssaoEffect.setProximityCutoff(t,i),Ep.sceneBufferCacheExpired=!0}get ssaoMinDistance(){return this._ssaoMinDistance}set ssaoMinDistance(e){this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?Qu.MULTIPLY:Qu.SKIP),this._ssaoMinDistance=e,Ep.sceneBufferCacheExpired=!0}get ssaoMaxDistance(){return this._ssaoMaxDistance}set ssaoMaxDistance(e){if("number"!=typeof e)return;this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?Qu.MULTIPLY:Qu.SKIP),this._ssaoMaxDistance=Math.max(e,0);let t=this._ssaoMaxDistance/(Ep.camera.far-Ep.camera.near),i=t/4;this._passes.ssaoPass.ssaoEffect.setDistanceCutoff(t,i),Ep.sceneBufferCacheExpired=!0}get ssaoRadius(){return this._ssaoRadius}set ssaoRadius(e){this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?Qu.MULTIPLY:Qu.SKIP),this._ssaoRadius=e,Ep.sceneBufferCacheExpired=!0}get ssaoIntensity(){return this._ssaoIntensity}set ssaoIntensity(e){"number"==typeof e&&(this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?Qu.MULTIPLY:Qu.SKIP),this._ssaoIntensity=Math.min(Math.max(e,0),30),this._passes.ssaoPass.ssaoEffect.blendMode.opacity.value=this._ssaoIntensity,Ep.sceneBufferCacheExpired=!0)}get ssaoQuality(){return this._ssaoQuality}set ssaoQuality(e){this._passes.ssaoPass.ssaoEffect.blendMode.setBlendFunction((this._enableSSAO=this.enableSSAO)?Qu.MULTIPLY:Qu.SKIP),this._ssaoQuality=e;let t=9;this._ssaoQuality<=.5&&this._ssaoQuality>=0?t=this._ssaoQuality/.5*8+1:this._ssaoQuality>.5&&this._ssaoQuality<=1&&(t=(this._ssaoQuality-.5)/.5*91+9),this._passes.ssaoPass.ssaoEffect.samples=t,Ep.sceneBufferCacheExpired=!0}get enableGrain(){return this._enableGrain}set enableGrain(e){_y.isBoolean(e)&&(this._passes.grainPass.enabled=this._enableGrain=e,this.grainIntensity=this._grainIntensity,this._passes.grainPass.enabled?this.addPass(this._passes.grainPass):this.removePass(this._passes.grainPass),Ep.sceneBufferCacheExpired=!0)}get grainIntensity(){return this._grainIntensity}set grainIntensity(e){this._passes.grainPass.enabled=this._enableGrain;let t=_y.numberOrDefault(e,this._grainIntensity);this._grainIntensity=t,this._passes.grainPass.effects[0].blendMode.opacity.value=this._grainIntensity/2,Ep.sceneBufferCacheExpired=!0}get enableEdgeBlur(){return this._enableEdgeBlur}set enableEdgeBlur(e){_y.isBoolean(e)&&(this._enableEdgeBlur=e,this._passes.edgeBlurPass.enabled=e,this._enableEdgeBlur?this.addPass(this._passes.edgeBlurPass):this.removePass(this._passes.edgeBlurPass),Ep.sceneBufferCacheExpired=!0)}get edgeBlurRadius(){return this._edgeBlurRadius}set edgeBlurRadius(e){"number"==typeof e&&(e<0&&(e=0),e>1&&(e=1),this._edgeBlurRadius=e,this._passes.edgeBlurPass&&(this._passes.edgeBlurPass.radius=1-e),Ep.sceneBufferCacheExpired=!0)}get edgeBlurIntensity(){return this._edgeBlurIntensity}set edgeBlurIntensity(e){"number"==typeof e&&(e<0&&(e=0),e>1&&(e=1),this._edgeBlurIntensity=e,this._passes.edgeBlurPass&&(this._passes.edgeBlurPass.scale=e),Ep.sceneBufferCacheExpired=!0)}get enableDOF(){return this._enableDOF}set enableDOF(e){_y.isBoolean(e)&&(this._passes.dofPass.depthOfFieldEffect.blendMode.setBlendFunction((this._enableDOF=e)?Qu.NORMAL:Qu.SKIP),this._enableDOF?this.addPass(this._passes.dofPass):this.removePass(this._passes.dofPass),Ep.sceneBufferCacheExpired=!0)}get dofQuality(){return this._dofQuality}set dofQuality(e){"number"==typeof e&&(e<0&&(e=0),e>1&&(e=1),this._dofQuality=e,this._passes.dofPass&&this._passes.dofPass.depthOfFieldEffect&&(this._passes.dofPass.depthOfFieldEffect.bokehScale=5*this._dofQuality),Ep.sceneBufferCacheExpired=!0)}get dofFocus(){return this._dofFocus}set dofFocus(e){"string"==typeof e&&"auto"===e&&"manual"===e&&(this._dofFocus=e,Ep.sceneBufferCacheExpired=!0)}get dofFocusTarget(){return this._dofFocusTarget}set dofFocusTarget(e){}get dofFocusDistance(){return this._dofFocusDistance}set dofFocusDistance(e){"number"==typeof e&&(this._dofFocusDistance=e,this._passes.dofPass.depthOfFieldEffect.circleOfConfusionMaterial.uniforms.focusDistance.value=e,Ep.sceneBufferCacheExpired=!0)}get dofFocalDistance(){return this._dofFocalDistance}set dofFocalDistance(e){"number"==typeof e&&(this._dofFocalDistance=e,this._passes.dofPass&&this._passes.dofPass.depthOfFieldEffect&&(this._passes.dofPass.depthOfFieldEffect.circleOfConfusionMaterial.uniforms.focalLength.value=Math.pow(Math.E,10*this._dofFocalDistance)/(Ep.camera.far-Ep.camera.near),Ep.sceneBufferCacheExpired=!0))}get enableSharpen(){return this._enableSharpen}set enableSharpen(e){_y.isBoolean(e)&&(this._passes.sharpenPass.enabled=this._enableSharpen=e,this._enableSharpen?this.addPass(this._passes.sharpenPass):this.removePass(this._passes.sharpenPass),Ep.sceneBufferCacheExpired=!0)}get sharpenIntensity(){return this._sharpenIntensity}set sharpenIntensity(e){let t=_y.numberOrDefault(e,this._sharpenIntensity);this._sharpenIntensity=t,this._passes.sharpenPass.sharpenMaterial.uniforms.intensity.value=this._sharpenIntensity,Ep.sceneBufferCacheExpired=!0}get enableChromaticAberration(){return this._enableChromaticAberration}set enableChromaticAberration(e){_y.isBoolean(e)&&(this._passes.distortPass.distortMaterial.uniforms.bandOffset.value=(this._enableChromaticAberration=e)?.005*this._chromaticAberrationIntensity:0,this._passes.distortPass.enabled=this._enableChromaticAberration,this._enableChromaticAberration?this.addPass(this._passes.distortPass):this.removePass(this._passes.distortPass),Ep.sceneBufferCacheExpired=!0)}get chromaticAberrationIntensity(){return this._chromaticAberrationIntensity}set chromaticAberrationIntensity(e){!_y.isNumber(e)||e<0||(this._chromaticAberrationIntensity=e,this._enableChromaticAberration&&(this._passes.distortPass.distortMaterial.uniforms.bandOffset.value=.005*this._chromaticAberrationIntensity),Ep.sceneBufferCacheExpired=!0)}get enableBloom(){return this._enableBloom}set enableBloom(e){_y.isBoolean(e)&&(this._passes.bloomPass.effects[0].blendMode.opacity.value=(this._enableBloom=e)?1:0,this._enableBloom?this.addPass(this._passes.bloomPass):this.removePass(this._passes.bloomPass),Ep.sceneBufferCacheExpired=!0)}get bloomThreshold(){return this._bloomThreshold}set bloomThreshold(e){this._bloomThreshold=e,this._passes.bloomPass.effects[0].luminanceMaterial.uniforms.threshold.value=this._bloomThreshold=e,Ep.sceneBufferCacheExpired=!0}get bloomBrightness(){return this._bloomBrightness}set bloomBrightness(e){this._passes.bloomPass&&(this._passes.bloomPass.effects[0].intensity=this._bloomBrightness=e,Ep.sceneBufferCacheExpired=!0)}get bloomRadius(){return this._bloomRadius}set bloomRadius(e){this._passes.bloomPass.effects[0].kernelSize=Math.round(5*(this._bloomRadius=e)),Ep.sceneBufferCacheExpired=!0}get enableToneMapping(){return this._enableToneMapping}set enableToneMapping(e){_y.isBoolean(e)&&this._passes.colorGradingPass&&this._passes.colorGradingPass.brightnessContrastEffect&&this._passes.colorGradingPass.hueSaturationEffect&&(this._enableToneMapping=e,this._enableToneMapping?this.addPass(this._passes.colorGradingPass):this.removePass(this._passes.colorGradingPass),Ep.sceneBufferCacheExpired=!0)}get toneMappingExposure(){return this._toneMappingExposure}set toneMappingExposure(e){this.enableToneMapping=this._enableToneMapping,this._toneMappingExposure=e,Ep.sceneBufferCacheExpired=!0}get toneMappingBrightness(){return this._toneMappingBrightness}set toneMappingBrightness(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.brightnessContrastEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.colorGradingPass.brightnessContrastEffect.uniforms.get("brightness").value=this._toneMappingBrightness=e,Ep.sceneBufferCacheExpired=!0))}get toneMappingContrast(){return this._toneMappingContrast}set toneMappingContrast(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.brightnessContrastEffect&&("number"!=typeof e||e<-1||e>1||(e>.99&&(e=.99),this._passes.colorGradingPass.brightnessContrastEffect.uniforms.get("contrast").value=this._toneMappingContrast=e,Ep.sceneBufferCacheExpired=!0))}get toneMappingHue(){return this._toneMappingHue}set toneMappingHue(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.hueSaturationEffect&&("number"!=typeof e||e<-180||e>180||(this._passes.colorGradingPass.hueSaturationEffect.setHue(ge.degToRad(this._toneMappingHue=e)),Ep.sceneBufferCacheExpired=!0))}get toneMappingSaturation(){return this._toneMappingSaturation}set toneMappingSaturation(e){this.enableToneMapping=this._enableToneMapping,this._passes.colorGradingPass&&this._passes.colorGradingPass.hueSaturationEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.colorGradingPass.hueSaturationEffect.uniforms.get("saturation").value=this._toneMappingSaturation=e,Ep.sceneBufferCacheExpired=!0))}get enableImageAdjustment(){return this._enableImageAdjustment}set enableImageAdjustment(e){_y.isBoolean(e)&&this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&(this._enableImageAdjustment=e,this._enableImageAdjustment?this.addPass(this._passes.imageAdjustmentPass):this.removePass(this._passes.imageAdjustmentPass),Ep.sceneBufferCacheExpired=!0)}get imageAdjustmentExposure(){return this._imageAdjustmentExposure}set imageAdjustmentExposure(e){this.enableImageAdjustment=this._enableImageAdjustment,this._imageAdjustmentExposure=e,this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("exposure").value=this._imageAdjustmentExposure=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentSaturation(){return this._imageAdjustmentSaturation}set imageAdjustmentSaturation(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("saturation").value=this._imageAdjustmentSaturation=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentHue(){return this._imageAdjustmentHue}set imageAdjustmentHue(e){if(this.enableImageAdjustment=this._enableImageAdjustment,!this._passes.imageAdjustmentPass)return;if(!this._passes.imageAdjustmentPass.imageAdjustmentEffect)return;if("number"!=typeof e||e<-180||e>180)return;this._imageAdjustmentHue=e;const t=Math.sin(ge.degToRad(this._imageAdjustmentHue)),i=Math.cos(ge.degToRad(this._imageAdjustmentHue));this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("hue").value.set(2*i,-Math.sqrt(3)*t-i,Math.sqrt(3)*t-i).addScalar(1).divideScalar(3),Ep.sceneBufferCacheExpired=!0}get imageAdjustmentHighlight(){return this._imageAdjustmentHighlight}set imageAdjustmentHighlight(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("highlight").value=this._imageAdjustmentHighlight=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentShadow(){return this._imageAdjustmentShadow}set imageAdjustmentShadow(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("shadow").value=this._imageAdjustmentShadow=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentContrast(){return this._imageAdjustmentContrast}set imageAdjustmentContrast(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("contrast").value=this._imageAdjustmentContrast=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentBrightness(){return this._imageAdjustmentBrightness}set imageAdjustmentBrightness(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("brightness").value=this._imageAdjustmentBrightness=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentNaturalSaturation(){return this._imageAdjustmentNaturalSaturation}set imageAdjustmentNaturalSaturation(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("naturalSaturation").value=this._imageAdjustmentNaturalSaturation=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentTemperature(){return this._imageAdjustmentTemperature}set imageAdjustmentTemperature(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("temperature").value=this._imageAdjustmentTemperature=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentTint(){return this._imageAdjustmentTint}set imageAdjustmentTint(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("tint").value=this._imageAdjustmentTint=e,Ep.sceneBufferCacheExpired=!0))}get imageAdjustmentClarity(){return this._imageAdjustmentClarity}set imageAdjustmentClarity(e){this.enableImageAdjustment=this._enableImageAdjustment,this._passes.imageAdjustmentPass&&this._passes.imageAdjustmentPass.imageAdjustmentEffect&&("number"!=typeof e||e<-1||e>1||(this._passes.imageAdjustmentPass.imageAdjustmentEffect.uniforms.get("clarity").value=this._imageAdjustmentClarity=e,Ep.sceneBufferCacheExpired=!0))}get enableFog(){return this._enableFog}set enableFog(e){_y.isBoolean(e)&&(this._enableFog=e,this._setFog())}get fogDistanceNear(){return this._fogDistanceNear}set fogDistanceNear(e){"number"!=typeof e||e<0||(this._fogDistanceNear=e,this._setFog())}get fogDistanceFar(){return this._fogDistanceFar}set fogDistanceFar(e){"number"!=typeof e||e<0||(this._fogDistanceFar=e,this._setFog())}get fogAutoColor(){return this._fogAutoColor}set fogAutoColor(e){_y.isBoolean(e)&&(this._fogAutoColor=e,this._setFog())}get fogColor(){return this._fogColor}set fogColor(e){_y.isCSSColor(e)&&(this._fogColor=e,this._setFog())}_setFog(){switch(Ep.scene.fog=null,_y.isCSSColor(this._fogColor)||_y.isCSSColor(this._fogColor0)||(this._fogColor="#cccccc"),this._enableFog?this._fogAutoColor?Ep.scene.fog=new pr(this._fogColorFromSkybox,this._fogDistanceNear,this._fogDistanceFar):Ep.scene.fog=new pr(this._fogColor,this._fogDistanceNear,this._fogDistanceFar):this._fogAutoColor?Ep.scene.fog=new pr(this._fogColorFromSkybox,5e8,500000001):Ep.scene.fog=new pr(this._fogColor,5e8,500000001),Ep.renderer.outputEncoding){case te:Ep.scene.fog.color.convertSRGBToLinear();break;case ie:Ep.scene.fog.color.convertGammaToLinear()}Ep.sceneBufferCacheExpired=!0}get enableAntialias(){return this._enableAntialias}set enableAntialias(e){this._passes.smaaPass&&_y.isBoolean(e)&&(this._passes.smaaPass.effects[0].blendMode.opacity.value=(this._enableAntialias=e)?1:0,Ep.sceneBufferCacheExpired=!0)}get antialiasType(){return this._antialiasType}set antialiasType(e){this._antialiasType=e}get antialiasSampleCount(){return this._antialiasSampleCount}set antialiasSampleCount(e){this._antialiasSampleCount=e,this._setAntialias()}get antialiasColorDiff(){return this._antialiasColorDiff}set antialiasColorDiff(e){this._antialiasColorDiff=e,this._setAntialias()}get antialiasPixelReject(){return this._antialiasPixelReject}set antialiasPixelReject(e){this._antialiasPixelReject=e,this._setAntialias()}_setAntialias(){}get enableLUT(){return this._enableLUT}set enableLUT(e){let t=this._enableLUT;this._enableLUT=e,this._passes.lutPass&&(t!=e&&(Ep.instance.crossfadeFreeze(),Ep.instance.crossfade(1e3)),this._passes.lutPass.enabled=this._enableLUT,Ep.sceneBufferCacheExpired=!0)}get availableLUTs(){let e=[];for(let t in this._lutMap)e.push(t);return e}get lutIntensity(){return this._lutIntensity}set lutIntensity(e){if(!_y.isNumber(e))return;e<0&&(e=0),e>1&&(e=1);let t=this._lutIntensity;this._lutIntensity=e,this._passes.lutPass&&(t!=e&&Ep.instance.crossfadeFreeze(),this._passes.lutPass.effects[0].blendMode.opacity.value=this._lutIntensity,t!=e&&Ep.instance.crossfade(1e3)),Ep.sceneBufferCacheExpired=!0}get lutSelected(){return this._lutSelected}set lutSelected(e){if("CUSTOM"===e){if(!this._lutCustom)return;this._addLUTCube(this._lutCustom,"CUSTOM")}else e.indexOf(".CUBE")>0&&(e=e.replace(".CUBE","")),this._lutMap.hasOwnProperty(e)||(e="Arabica 12"),this._addLUTCube(_y.url(Ep.instance.resourceBasePath,`texture/luts/${e}.CUBE`),e);Ep.sceneBufferCacheExpired=!0}get lutCustom(){return this._lutCustom}set lutCustom(e){if(this._lutCustom=e,""!==e)try{this._addLUTCube(e,"CUSTOM")}catch(t){e=""}"CUSTOM"===this._lutSelected&&""===e&&(this._passes.lutPass&&(this._passes.lutPass.enabled=!1,this._passes.lutPass=null),delete this._lutMap.CUSTOM),Ep.sceneBufferCacheExpired=!0}get lutCustomName(){return this.lutCustomName}set lutCustomName(e){this._lutCustomName=e}nextLUT(){if(!this._enableLUT)return;if("Zeke 39"===this.lutSelected)return this.lutSelected="Arabica 12","Arabica 12";let e="";for(let t in this._lutMap){if(""!==e){this.lutSelected=t;break}this._lutMap[t]===this._passes.lutPass.effects[0].getLUT()&&(e=t)}return Ep.sceneBufferCacheExpired=!0,this.lutSelected}_addLUTCube(e,t){if(this._lutSelected=t,this._lutMap[t]&&this._lutMap[t].image&&"string"!=typeof this._lutMap[t].image&&this._passes.lutPass)this._passes.lutPass.effects[0].setLUT(this._lutMap[t]);else if(this._passes.lutPass){this._passes.lutPass.enabled=!1;try{new Dd(Ep.defaultLoadingManager).load(e,(e=>{if(Ep.instance.crossfadeFreeze(),!this._passes.lutPass)return;const i=wd.from(e);this._passes.lutPass.effects[0].setLUT(i),this._passes.lutPass.enabled=this._enableLUT,this._lutMap[t]=i,Ep.instance.crossfade(1e3)}))}catch(e){logger.warn("无效的 3D LUT 文件。"),this._passes.lutPass.enabled=this._enableLUT,Ep.instance.crossfade(1e3)}}else new Dd(Ep.defaultLoadingManager).load(e,(e=>{Ep.instance.crossfadeFreeze();try{const i=wd.from(e);let n=Ep.renderer.capabilities.isWebGL2?new Sd(i):new Sd(i.convertToUint8().toDataTexture());this._passes.lutPass?this._lutSelected===t&&this._passes.lutPass.effects[0].setLUT(this._lutMap[t]):this._lutSelected===t&&(this._passes.lutPass=new sd(Ep.camera,n),this._passes.lutPass.name="LUTPass",this._passes.lutPass.enabled=this._enableLUT,this._passes.lutPass.effects[0].blendMode.opacity.value=this._lutIntensity,this.addPass(this._passes.lutPass),this._lutMap[t]=i),Ep.instance.crossfade(1e3)}catch(e){logger.warn("无效的 3D LUT 文件。",e),Ep.instance.crossfade(1e3)}}),(e=>{}),(e=>{logger.warn("无效的 3D LUT 文件。",e),Ep.instance.crossfade(1e3)}))}_updateDOFCameraProjection(e){this._updateCameraProjection(e)}_updateCameraProjection(e){e&&"number"==typeof e.far&&"number"==typeof e.near&&(this._passes.dofPass&&this._passes.dofPass.depthOfFieldEffect&&(this._passes.dofPass.depthOfFieldEffect.circleOfConfusionMaterial.adoptCameraSettings(e),this.dofFocalDistance=this._dofFocalDistance),this._passes.ssaoPass&&this._passes.ssaoPass.ssaoEffect&&(this._passes.ssaoPass.ssaoEffect.ssaoMaterial.adoptCameraSettings(e),this.ssaoKernelRadius=this._ssaoKernelRadius,this.ssaoMaxDistance=this._ssaoMaxDistance),Ep.sceneBufferCacheExpired=!0)}getSettings(){let e={};for(let t in this)"_composer"!==t&&"_context"!==t&&"_scene"!==t&&"_renderer"!==t&&"_camera"!==t&&"_cameraControl"!==t&&"_context"!==t&&"_enabled"!==t&&"_size"!==t&&"_passes"!==t&&"function"!=typeof this[t]&&(e[t.replace("_","")]=this[t]);return e}applySettings(e){if(e){if(Ep.publishQuality&&Ep.publishQuality.effect)switch(Ep.publishQuality.effect.toLowerCase()){case"medium":case"low":case"none":return void(this.enabled=!1)}for(let t in e)if(this[t]=e[t],"lutMap"===t)for(let i in e[t])for(let n in this._lutMap)n===i&&(this._lutMap[n]||(this._lutMap[n]=e[t][i]))}else logger.error("无效的场景特效设置。")}}Qx.PASS_ORDER=["RenderPass","NormalPass","DepthDownsamplingPass","SSAOPass","BloomPass","SSRDepthPass","SSRPass","DOFPass","WatermarkPass","LUTPass","ChromaticAberrationPass","SharpenPass","ImageAdjustmentPass","ColorGradingPass","OutlinePass","ArticulationOutlineEffect","EdgeBlurPass","CacheBufferPass","GrainPass","SMAAPass"];const Kx=new Ce,$x=new Xc,ew=new Ce;class tw{constructor(e,t){void 0===t&&(console.warn('THREE.FirstPersonControls: The second parameter "domElement" is now mandatory.'),t=document);const i=this;this.object=e,this.domElement=t,this.enabled=!0,this.movementSpeed=1,this.lookSpeed=.005,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.mouseDragOn=!1,this.moveHorizontal=!1,this.y0=0,this.autoSpeedFactor=0,this.mouseX=0,this.mouseY=0,this.mouseX0=0,this.mouseY0=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.viewHalfX=0,this.viewHalfY=0;let n=0,a=0;this.getTarget=()=>ew.clone(),this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){this.domElement!==document&&this.domElement.focus(),e.touches&&(e.pageX=e.touches[0].pageX,e.pageY=e.touches[0].pageY),e.preventDefault(),this.mouseDragOn=!0,this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY),this.mouseX0=this.mouseX,this.mouseY0=this.mouseY},this.onMouseUp=function(e){e.preventDefault(),this.mouseDragOn=!1,this.mouseX=0,this.mouseY=0,this.mouseX0=0,this.mouseY0=0},this.onMouseMove=function(e){e.touches&&(e.pageX=e.touches[0].pageX,e.pageY=e.touches[0].pageY),this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)},this.onKeyDown=function(e){switch(e.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyQ":this.moveDown=!0;break;case"KeyE":this.moveUp=!0}},this.onKeyUp=function(e){switch(e.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyQ":this.moveDown=!1;break;case"KeyE":this.moveUp=!1}},this.lookAt=function(e,t,i){return e.isVector3?ew.copy(e):ew.set(e,t,i),this.object.lookAt(ew),h(this),this},this.reset=()=>{this.y0=0,this.mouseX=0,this.mouseY=0,this.mouseX0=0,this.mouseY0=0},this.update=function(){const e=new Ce;return i.targetPosition=e,function(t){if(!1===this.enabled)return;if(this.heightSpeed){const e=ge.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=t*(e*this.heightCoef)}else this.autoSpeedFactor=0;const i=t*this.movementSpeed;if(this.y0=this.object.position.y,(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(i+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(i),this.moveLeft&&this.object.translateX(-i),this.moveRight&&this.object.translateX(i),this.moveHorizontal?this.object.position.y=this.y0:(this.moveUp&&(this.object.position.y+=i),this.moveDown&&(this.object.position.y-=i)),this.mouseDragOn){let i=t*this.lookSpeed;this.activeLook||(i=0);let r=1;this.constrainVertical&&(r=Math.PI/(this.verticalMax-this.verticalMin));const s=50*(this.mouseX-this.mouseX0),o=50*(this.mouseY-this.mouseY0);a-=s*i,this.lookVertical&&(n-=o*i*r),this.mouseX0=this.mouseX,this.mouseY0=this.mouseY,n=Math.max(-85,Math.min(85,n));let l=ge.degToRad(90-n);const c=ge.degToRad(a);this.constrainVertical&&(l=ge.mapLinear(l,0,Math.PI,this.verticalMin,this.verticalMax));const h=this.object.position;e.setFromSphericalCoords(1,l,c).add(h),this.object.lookAt(e)}(this.moveForward||this.autoForward&&!this.moveBackward||this.moveBackward||this.moveLeft||this.moveRight||this.mouseDragOn||this.moveUp||this.moveDown)&&"function"==typeof this.onStart&&(this.onStart(),this.onStart=void 0)}}(),this.dispose=function(){this.domElement.removeEventListener("contextmenu",iw),this.domElement.removeEventListener("mousedown",s),this.domElement.removeEventListener("mousemove",r),this.domElement.removeEventListener("mouseup",o),this.domElement.removeEventListener("touchmove",r),this.domElement.removeEventListener("touchstart",s),this.domElement.removeEventListener("touchend",o),window.removeEventListener("keydown",l),window.removeEventListener("keyup",c)};const r=this.onMouseMove.bind(this),s=this.onMouseDown.bind(this),o=this.onMouseUp.bind(this),l=this.onKeyDown.bind(this),c=this.onKeyUp.bind(this);function h(e){const t=e.object.quaternion;Kx.set(0,0,-1).applyQuaternion(t),$x.setFromVector3(Kx),n=90-ge.radToDeg($x.phi),a=ge.radToDeg($x.theta)}this.domElement.addEventListener("contextmenu",iw),this.domElement.addEventListener("mousemove",r),this.domElement.addEventListener("mousedown",s),this.domElement.addEventListener("mouseup",o),this.domElement.addEventListener("touchmove",r),this.domElement.addEventListener("touchstart",s),this.domElement.addEventListener("touchend",o),window.addEventListener("keydown",l),window.addEventListener("keyup",c),this.updateOrientation=h.bind(void 0,this),this.handleResize(),h(this)}}function iw(e){e.preventDefault()}class nw{constructor(e){let t,i,n="",a=e=>{"both"===n&&e&&"rotate"===e.target.mode&&e.target.dragging&&(1!==e.target.rotationAxis.x&&1!==e.target.rotationAxis.y&&1!==e.target.rotationAxis.z||t.rotateOnWorldAxis(e.target.rotationAxis,e.target.rotationAngleDelta)),"function"==typeof this.callback&&this.callback(this.getCalibrateDatum())},r=!1,s=.5,o=e=>{e.preventDefault(),e.stopPropagation();let i=1;switch(e.deltaY<0?i=1/.95:e.deltaY>0&&(i=.95),n){case"ref":t.scale.multiplyScalar(i);break;case"model":Ep.scene.models.scale.multiplyScalar(i);break;case"both":Ep.scene.models.scale.multiplyScalar(i),t.scale.multiplyScalar(i)}Ep.sceneBufferCacheExpired=!0,a()};this.getOpacity=()=>s,this.setOpacity=e=>{s=Math.min(Math.max(e,0),1),t&&t.material&&(t.material.opacity=e)},this.enable=(e,n)=>{e=e&&"ecef"===e.type?e:Ep.datumShiftModel,this.callback=n;let o=Ep.instance.switchCameraMode(1,"-z",{fitX:!0,boundingSphere:!0});if(o/=2,t||(t=(()=>{const e=new Kt({map:Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/planets/earth_atmos_4096.jpg")),transparent:!0,opacity:s,depthTest:!1}),i=6378.137,n=new po(i,512,256);return n.scale(1,6356.752/i,1),t=new Fi(n,e),t.name="Planet",t.castShadow=!0,t.receiveShadow=!0,t})(),Ep.scene.sysObjects.add(t)),i={position:Ep.scene.models.position.clone(),rotation:Ep.scene.models.rotation.clone(),scale:Ep.scene.models.scale.clone()},e&&"ecef"===e.type){t.position.set(0,0,0),Ep.scene.models.position.set(-e.offset.x,-e.offset.y,-e.offset.z),t.scale.set(1e3*e.scaleX,1e3*e.scaleY,1e3*e.scaleZ),Ep.scene.models.scale.set(1,1,1),t.rotation.set(0,0,0);const i=new it;i.makeRotationFromEuler(new dt(ge.degToRad(e.rotation.x),ge.degToRad(e.rotation.y),ge.degToRad(e.rotation.z))),i.invert(),Ep.scene.models.rotation.setFromRotationMatrix(i)}else t.scale.set(o/6378.137,o/6378.137,o/6378.137),Ep.scene.models.scale.set(1,1,1);this.globeModelScale0||(this.globeModelScale0=t.scale.x),t.visible=!0,Ep.transformControls.scaleEqualProportion0=Ep.transformControls.scaleEqualProportion,Ep.transformControls.scaleEqualProportion=!0,Ep.transformControls.space0=Ep.transformControls.space,Ep.transformControls.space="local",Ep.transformControls.addEventListener("objectChange",a),Ep.instance.switchCameraMode(1,"-z",{fitX:!0,boundingSphere:!0}),Ep.orthoCameraControls.zoomAxis="z",Ep.orthoCameraControls.enablePan0=Ep.orthoCameraControls.enablePan,Ep.orthoCameraControls.enableScale0=Ep.orthoCameraControls.enableScale,Ep.orthoCameraControls.enableZoom0=Ep.orthoCameraControls.enableZoom,this.changeMode("both"),r=!0,a()},this.disable=()=>{Ep.renderer.domElement.removeEventListener("wheel",o),this.callback=void 0,Ep.instance.disableTransform(),t.visible=!1,Ep.transformControls.scaleEqualProportion=Ep.transformControls.scaleEqualProportion0||!1,Ep.transformControls.space=Ep.transformControls.space0||"world",Ep.instance.switchCameraMode(0),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!0,Ep.orthoCameraControls.enablePan=Ep.orthoCameraControls.enablePan0,Ep.orthoCameraControls.enableScale=Ep.orthoCameraControls.enableScale0,Ep.orthoCameraControls.enableZoom=Ep.orthoCameraControls.enableZoom0,i.position&&i.rotation&&i.scale&&(Ep.scene.models.position.copy(i.position),Ep.scene.models.rotation.copy(i.rotation),Ep.scene.models.scale.copy(i.scale),i={}),r=!1},this.getCalibrateDatum=()=>{const e=t.scale.x,i=t.matrix.clone(),n=Ep.scene.models.position.clone(),a=Ep.scene.models.scale.x,r=Ep.scene.models.matrix.clone();i.invert(),r.premultiply(i);const s=new dt,o=new it;o.extractRotation(r),o.invert(),s.setFromRotationMatrix(o);const l=n.clone();return l.divideScalar(-a),l.applyMatrix4(o),{type:"ecef",scaleX:e/(1e3*a),scaleY:e/(1e3*a),scaleZ:e/(1e3*a),offset:l.clone(),rotation:{x:ge.radToDeg(s.x),y:ge.radToDeg(s.y),z:ge.radToDeg(s.z)}}},this.setCalibrateDatum=e=>{if(!r||!e||"ecef"!==e.type)return;t.position.set(0,0,0),Ep.scene.models.position.set(-e.offset.x,-e.offset.y,-e.offset.z),t.scale.set(1,1,1),Ep.scene.models.scale.set(.001/e.scaleX,.001/e.scaleY,.001/e.scaleZ),t.rotation.set(0,0,0);const i=new it;i.makeRotationFromEuler(new dt(ge.degToRad(e.rotation.x),ge.degToRad(e.rotation.y),ge.degToRad(e.rotation.z))),i.invert(),Ep.scene.models.rotation.setFromRotationMatrix(i)},this.changeMode=(e="both")=>{switch(e.toLowerCase()){case"ref":Ep.instance.enableTransformByUUID(t.uuid),Ep.instance.snapOff(),this.changeTransform("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1,Ep.transformControls.showE=!1,Ep.orthoCameraControls.enablePan=!1,Ep.orthoCameraControls.enableRotate=!1,Ep.orthoCameraControls.enableZoom=!1,Ep.transformControls.space="world",Ep.renderer.domElement.removeEventListener("wheel",o),Ep.renderer.domElement.addEventListener("wheel",o),n="ref";break;case"model":Ep.instance.enableTransformByUUID(Ep.scene.models.uuid),Ep.instance.snapOff(),this.changeTransform("rotate"),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1,Ep.transformControls.showE=!1,Ep.orthoCameraControls.enablePan=!1,Ep.orthoCameraControls.enableRotate=!1,Ep.orthoCameraControls.enableZoom=!1,Ep.transformControls.space="local",Ep.renderer.domElement.removeEventListener("wheel",o),Ep.renderer.domElement.addEventListener("wheel",o),n="model";break;case"both":default:Ep.instance.enableTransformByUUID(Ep.scene.models.uuid),Ep.instance.snapOff(),this.changeTransform("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1,Ep.transformControls.showE=!1,Ep.orthoCameraControls.enablePan=!1,Ep.orthoCameraControls.enableRotate=!1,Ep.orthoCameraControls.enableZoom=!0,Ep.transformControls.space="world",Ep.renderer.domElement.removeEventListener("wheel",o),n="both"}},this.changeTransform=(e="scale")=>{switch(e.toLowerCase()){case"translate":if("model"!==n)return;Ep.instance.setTransformMode("translate"),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!0,Ep.transformControls.scaleEqualProportion=!0;break;case"scale":Ep.instance.setTransformMode("scale"),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!0,Ep.transformControls.scaleEqualProportion=!0;break;case"rotate":Ep.instance.setTransformMode("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1,Ep.transformControls.showE=!1,Ep.transformControls.scaleEqualProportion=!1}},this.changeGlobeStyle=e=>{},this.reset=()=>{if(!t)return;if(!Ep.scene.models)return;let e=new it;e.copyPosition(t.matrix),e.extractRotation(t.matrix),Ep.scene.models.scale.x,e.invert(),t.applyMatrix4(e),Ep.scene.models.applyMatrix4(e),Ep.instance.switchCameraMode(1,"-z",{fitX:!0,boundingSphere:!0}),Ep.scene.models.rotateOnWorldAxis(new Ce(0,1,0),ge.degToRad(-18.9236)),t.rotateOnWorldAxis(new Ce(0,1,0),ge.degToRad(-18.9236))}}}class aw{constructor(){let e,t,i,n,a,r,s=!1,o=!1,l=0,c="roam",h=!1,u=!1;const d=[];let p=null,m=!1,f=!1,g=null,y=null,v=null;this.size=1;let b,_=!1,x=1,w=-1,S=[],M=[],T=0,A=null,E=!0,C=!1;const I=new po(.5,8,6);I.scale(2,2,2);const P=new Kt({color:16711935,depthTest:!1,transparent:!0}),R=new El;R.moveTo(.15,.5),R.lineTo(.15,.15),R.lineTo(.5,.15),R.lineTo(.5,-.15),R.lineTo(.15,-.15),R.lineTo(.15,-.5),R.lineTo(-.15,-.5),R.lineTo(-.15,-.15),R.lineTo(-.5,-.15),R.lineTo(-.5,.15),R.lineTo(-.15,.15),R.lineTo(-.15,.5);const O=new uo(R);O.rotateX(Math.PI/-2),O.scale(2,2,2);const D=new Kt({color:16738047,depthTest:!1,transparent:!0});let L={interval:10,intervalCoef:0,padding:5,repeat:1,mirror:!1,useTangent:!0,curveClosed:!1,isVertical:!1,motion:"loop",speed:10,delay:1,reverse:!1,useTangent:!0,curveClosed:!1,perpendicular:!1,repeat:1,padding:10,interval:10,intervalCoef:0,speed:10,speedCoef:1,mirror:!0,reverse:!1,useTangent:!0,curveClosed:!1,perpendicular:!1,style:"arrow01",repeat:1,padding:20,width:10,stretchCoef:1,speed:10,speedCoef:1,mirror:!0,reverse:!1,curveClosed:!1,color:"#ff0000"},k="",N=null,B=!0;const z=function(e){const t=new Ce(0,-1,0);for(let i=0;i<e.tangents.length;i++){const n=e.tangents[i];e.binormals[i].copy(n.clone().cross(t))}},U=()=>Ep.transformControls.object&&Ep.transformControls.object.userData&&"number"==typeof Ep.transformControls.object.userData.handlerIndex&&Ep.transformControls.object.userData.handlerIndex>=0,F=(e,t,i,n,a,r,s,o)=>{if("number"!=typeof e||e<=0||e>100)return;const l=(Math.random()-.5)*e*.01;let c=l+t;c<0&&(c=0),c>i.length&&(c=i.length);const h=c/i.length;n.getPointAt(h,a),c>t&&t<r.tangents.length-1?(s.x+=(r.tangents[t+1].x-s.x)*l,s.y+=(r.tangents[t+1].y-s.y)*l,s.z+=(r.tangents[t+1].z-s.z)*l,o.x+=(r.paddings[t+1].x-o.x)*l,o.y+=(r.paddings[t+1].y-o.y)*l,o.z+=(r.paddings[t+1].z-o.z)*l):c<t&&t>0&&(s.x+=(r.tangents[t-1].x-s.x)*l,s.y+=(r.tangents[t-1].y-s.y)*l,s.z+=(r.tangents[t-1].z-s.z)*l,o.x+=(r.paddings[t-1].x-o.x)*l,o.y+=(r.paddings[t-1].y-o.y)*l,o.z+=(r.paddings[t-1].z-o.z)*l)};this.setSize=e=>{"number"==typeof e&&e>0&&(this.size=e,i.scale.set(e,.1*e,e))},this.handleKeys=e=>{219===e.keyCode&&this.setSize(this.size/1.1),221===e.keyCode&&this.setSize(1.1*this.size)},this.init=()=>{const a=new xs(1,1,1,32);n=new Co({color:16711935,opacity:.5,transparent:!0}),i=new Fi(a,n),i.scale.set(5,.5,5),i.visible=!1,Ep.scene.sysObjects.add(i),t=new Vc,e=new ye,document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerdown",this.onPointerDown),document.addEventListener("pointerup",this.onPointerUp),document.addEventListener("keydown",this.onDocumentKeyDown),document.addEventListener("keyup",this.onDocumentKeyUp)},this.destroy=()=>{document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerdown",this.onPointerDown),document.removeEventListener("pointerup",this.onPointerUp),document.removeEventListener("keydown",this.onDocumentKeyDown),document.removeEventListener("keyup",this.onDocumentKeyUp),document.removeEventListener("keydown",this.handleKeys),d.forEach((e=>{_y.disposeThreeObject(e)})),d.length=0},this.getRand=function(e){return this.obj=e,this.init()},this.getRand.prototype.sum=function(e){var t=this.obj,i=0;return t.forEach&&t.forEach((t=>{i+=t[e]})),i},this.getRand.prototype.init=function(){var e=null,t=this.obj,i=this.sum("intensity");for(var n in t){if(parseFloat(Math.random()*i)<=t[n].intensity){e=t[n];break}i-=t[n].intensity}return e},this._paint=({x:e,y:t,z:i},n,r,o)=>{if(!s&&!o||!(this.assets instanceof Array&&this.assets.length>0))return;let h={};if(h="pathbrush"===c&&"C"===L.type?this.assets[0]:new this.getRand(this.assets),"paint"===c||"brush"===c||"pathbrush"===c){let a=Math.random()*Math.PI*2,s=Math.random()*this.size,o=new Ce(Math.cos(a)*s,0,Math.sin(a)*s);if(n&&o.applyQuaternion(n),e+=o.x,t+=o.y,i+=o.z,r){r instanceof Qr&&(r=r.parent);let t=(new Re).setFromObject(r);t&&t.min&&t.max&&"__pgl"!==r.name&&(e=t.min.x>e?t.min.x:e,e=t.max.x<e?t.max.x:e,i=t.min.z>i?t.min.z:i,i=t.max.z<i?t.max.z:i)}}if(h.transform?0==h.transform.scale.x&&(h.transform.scale={x:1,y:1,z:1}):h.transform={position:{x:0,y:0,z:0},rotation:{_x:0,_y:0,_z:0,_order:"XYZ"},scale:{x:1,y:1,z:1}},"number"==typeof h.intensity&&h.intensity<0&&(h.intensity=0),0===h.intensity)return;if(l*h.probability<2)return;l=0;let u=[[e,t,i]],d=JSON.parse(JSON.stringify(h));switch(d.isVisible=!0,d.transform.position.x=u[0][0],d.transform.position.y=u[0][1],d.transform.position.z=u[0][2],d.path=d.param.path,d.index=v.children.length+1,h.type){case"ModelAsset":if("clone"==a){d.name=v.getIndexName(d.name),d.modelPath=d.param.path;let e=h.randomValues,t=1;e&&e.scaleMax&&e.scaleMin&&e.scaleFlag&&(t=Math.random()*(e.scaleMax-e.scaleMin)+e.scaleMin),d.transform.scale={x:d.transform.scale.x*t,y:d.transform.scale.y*t,z:d.transform.scale.z*t};let i=0;e&&(i=ge.degToRad(Math.random()*(e.rotateMax-e.rotateMin)+e.rotateMin));let n=new dt(d.transform.rotation._x,d.transform.rotation._y+i,d.transform.rotation._z);d.transform.rotation=n;let a=new $_(d,null,null,v),r=v.getGroup(),s=a.getGroup();r.updateMatrixWorld();let o=r.matrixWorld.clone().invert();s.applyMatrix4(o),s.updateMatrix(),setTimeout((()=>{_y.setArticulation(d,a),a.materialStore&&a.materialStore.applySettings(d.materials,v.name),d.particleStores&&a.applyParticleSettings(d.particleStores),_y.setNode(d,a,new $y(Ep.scene))}),500),"plot"===c&&g&&g({name:v?v.name:null})}else{let e=null;if(d.points=u,e="GroupItem"==v.type?v.getItemByName(h.name):v.getInstanced("ModelAsset",h.name),e){if(h.drawRequested=void 0,e.setRand(d.randomValues),e.addInstance(u,v),"GroupItem"!=v.type){let t=JSON.parse(JSON.stringify(d));t.name=v.getIndexName(d.name),v.childrenAdd(new _b(t,e,e.getCount()-1,v.children.length+1)),"plot"===c&&g&&g({name:v?v.name:null})}}else{if(1==h.drawRequested)break;h.drawRequested=!0,new X_(d,v,((e,t)=>{if("GroupItem"==v.type);else{let e=JSON.parse(JSON.stringify(d));e.name=v.getIndexName(d.name),v.childrenAdd(new _b(e,t,t.getCount()-1,v.children.length+1))}t.materialStore.applySettings(d.materials,v.name,t.name),h.drawRequested=void 0,"plot"===c&&g&&g({name:v?v.name:null})}))}}break;case"IconAsset":if("instanced"==a){let e=v.getInstanced("IconAsset",h.name);if(e){e.addInstance(u,v);let t=JSON.parse(JSON.stringify(d));t.name=e.getIndexName(),v.childrenAdd(new _b(t,e,t.name,v.children.length+1))}else d.points=u,d.transform.scale?d.scales=[JSON.parse(JSON.stringify(d.transform.scale))]:d.scales=[{x:1,y:1,z:1}],new bb(d,v,((e,t)=>{let i=JSON.parse(JSON.stringify(d));i.name=t.getIndexName(),v.childrenAdd(new _b(i,t,i.name,v.children.length+1))}));"plot"===c&&g&&g({name:v?v.name:null})}else d.name=v.getIndexName(d.name),new yb(d,v),"plot"===c&&g&&g({name:v?v.name:null});break;case"PaperCutItem":d.name=v.getIndexName(d.name),new Mx(d,v),"plot"===c.toLowerCase()&&g&&g({name:v?v.name:null})}return h},this._clickItem=e=>{let t=e.object.parent,i=t.name;if("PaintItem"===v.type){if("PaintGroup"===t.type){i=e.object.name;let t=i.indexOf("#");i=i.substr(0,t);let n=v.getInstanced("ModelAsset",i).settings.find((t=>t.key==e.instanceId));i=n.name}let a=v.children.find((e=>e.name===i));if(!a){var n=_y.getLayerFromItem(e.object);n&&(t=n.getGroup(),a=n)}g&&g({name:v.name,object:t,objectItem:a},a?a.type:"")}else if("GroupItem"===v.type){let n="";if("PaintGroup"===t.type){i=e.object.name;let t=i.indexOf("#");i=i.substr(0,t),n="ModelAsset"}else n="IconAsset";let a=v.children.find((e=>e.name===i));"PaintGroup"===t.type&&(t=a.getHelper(e.instanceId)),g&&g({name:v.name,object:t,objectItem:{type:"ModelAsset",name:e.object.name,transform:{position:e.object.position,rotation:e.object.rotation,scale:e.object.scale}}},n)}},this._castLayer=()=>{let e=[];return v&&(assetObject.getGroup().children.map((t=>{"IconGroup"===t.type?t.children.map((t=>{e.push(t)})):"InstancedGroup"===t.type?t.children.map((t=>{t.children.map((t=>{e.push(t)}))})):e.push(t)})),assetObject.children.map((t=>{"ModelItem"===t.type&&t.getGroup().children.map((t=>{e.push(t)}))}))),t.intersectObjects(e)},this._erase=()=>{let e=t.intersectObjects(d);if(e.length>0){let t,i=[];if(e=e.filter((e=>{let t=e.object.parent;if("PaintGroup"!==t.type){if(!i.includes(t.name))return i.push(e.object.parent.name),!0}else if(!i.includes(e.instanceId))return i.push(e.instanceId),!0})),S=S.concat(e),x>1){if(-1==w&&(w=Math.round(Math.random()*x+.1)-1),!(S.length>=x))return;t=S[w],S=[],w=-1}else t=e[0];let n=t.object.parent,a=n.name;if("PaintItem"===v.type){if("PaintGroup"===n.type){a=t.object.name;let e=a.indexOf("#");a=a.substr(0,e),a=v.getInstanced("ModelAsset",a).settings.find((e=>e.key==t.instanceId)).name}if("PaperCut"===n.type){let e=_y.getLayerFromItem(n);e&&(a=e.name)}v.removeItem(a).then((e=>{this.updateWorld(),g&&g(e,"删除成功")}))}else if("GroupItem"===v.type)if("PaintGroup"===n.type){a=t.object.name;let e=a.indexOf("#");a=a.substr(0,e),v.removeItem(a,t.instanceId).then((e=>{this.updateWorld(),e&&g&&g(e,"删除成功")}))}else v.removeItem(a).then((e=>{this.updateWorld(),e&&g&&g(e,"删除成功")}))}},this.setLayerPointClick=e=>{N=e},this.onPointerMove=n=>{if(!s||n.target!==Ep.renderer.domElement)return;if(r&&(r=clearInterval(r),r=void 0),f)return;h=!0,l++,e.set(n.offsetX/Ep.renderer.domElement.clientWidth*2-1,-n.offsetY/Ep.renderer.domElement.clientHeight*2+1),t.setFromCamera(e,Ep.camera),u&&m&&this._erase();const a=t.intersectObjects(d);if(Ep.scene.getObjectByName("__pgl")&&Ep.pgl.terrain){let e=Ep.pgl.terrain.pickTerrain({x:n.offsetX,y:n.offsetY});if(e&&e.hit){for(let t=0;t<a.length;t++)if(a[t].distance>e.distance){a.splice(t,0,e);break}(0===a.length||e.distance>a[a.length-1].distance)&&a.push(e)}}if(a.length>0){const e=a[0];let t=new Ce;e.face&&(t=e.face.normal.clone());let n=new Ee;e.object.matrixWorld.decompose({x:0,y:0,z:0},n,{x:0,y:0,z:0}),t.applyQuaternion(n),t.normalize(),i.position.copy(e.point).add(t.clone().multiplyScalar(i.scale.y/2));let r=_y.calcQuaternionFromNormal(t);if(i.setRotationFromQuaternion(r),u)switch(c){case"paint":case"brush":if(0===this.assets.length)return;this._createDrawGroup(),this._paint(e.point,r,e.object)}else switch(c){case"pathbrush":v&&"number"==typeof v.pathIndex&&-1!==v.pathIndex&&this._updatePath({type:"curve",pathIndex:T,state:"preview",newPoint:e.point,data:[]})}}},this.onPointerUp=i=>{if(u=!1,i.target===Ep.renderer.domElement){if(p&&"pathbrush"===c.toLowerCase()&&v&&v.pathIndex>-1&&this._showPath(),2===i.button&&!h&&"pathbrush"===c.toLowerCase()){if(T>=M.length||-1==T)return;if(M[T].points.length<=2)return;return this._updatePath({type:"curve",pathIndex:T,state:"finish"}),void(g&&g({name:v?v.name:null,keep:!0}))}if(s&&i.target===Ep.renderer.domElement&&0===i.button&&Ep.pointerDisabled){if(h&&!U()&&v&&g&&g({name:v.name,keep:!0}),h=!1,r&&(r=clearInterval(r),r=void 0),e.set(i.offsetX/Ep.renderer.domElement.clientWidth*2-1,-i.offsetY/Ep.renderer.domElement.clientHeight*2+1),t.setFromCamera(e,Ep.camera),o);else if(m)this._erase();else if(u)y&&y({type:"progress",total:1,loaded:1});else if("plot"===c||"pathbrush"===c){if(0===this.assets.length&&("pathbrush"!==c||"E"!==L.type))return;const e=t.intersectObjects(d);if(Ep.scene.getObjectByName("__pgl")&&Ep.pgl.terrain){let t=Ep.pgl.terrain.pickTerrain({x:i.offsetX,y:i.offsetY});if(t&&t.hit){for(let i=0;i<e.length;i++)if(e[i].distance>t.distance){e.splice(i,0,t);break}(0===e.length||t.distance>e[e.length-1].distance)&&e.push(t)}}if(e.length>0&&("plot"===c&&(this._createDrawGroup(),this._paint(e[0].point,null,e[0].object)),"pathbrush"===c))if(b&&b.visible&&(!v||v&&v.pathBrushOptions)){b.updateWorldMatrix(!0,!0);const i=t.intersectObjects([...b.children[0].children,...b.children[1].children]);let n=-1,a=-1;this.pathHandlerSelected=-1;for(let e=0;e<i.length;e++){if("__avw_path_brush_handler"===i[e].object.name&&i[e].object.visible){n=e;break}if("__avw_path_brush_np_handler"===i[e].object.name&&i[e].object.visible){a=e;break}}if(n>=0||a>=0){if(n>=0){const e=i[n].object,t=e.userData.handlerIndex;U()||this.setLayerName(e.userData.layerName,!0);const a=b.children[0].children.find((t=>"__avw_path_brush_handler"===t.name&&t.userData.handlerIndex===e.userData.handlerIndex));a&&(Ep.instance.disableTransform(),C=!1,Ep.instance.enableTransformByUUID(a.uuid,(e=>{C=!0,this._updatePath({type:"curve",pathIndex:T,state:"change",pointIndex:t,pointEvent:e})})),this.pathHandlerSelected=t)}if(a>=0){const e=i[a].object,t=e.userData.handlerIndex;U()||this.setLayerName(e.userData.layerName,!0),this.insertPathPoint(e.position,t);const n=b.children[0].children.find((e=>"__avw_path_brush_handler"===e.name&&e.userData.handlerIndex===t));n&&(Ep.instance.disableTransform(),C=!1,Ep.instance.enableTransformByUUID(n.uuid,(e=>{C=!0,this._updatePath({type:"curve",pathIndex:T,state:"change",pointIndex:t,pointEvent:e})})),this.pathHandlerSelected=t)}this.pathHandlerSelected>-1&&N&&N({name:v?v.name:null,pathIndex:v.pathIndex,pointIndex:this.pathHandlerSelected,mode:c,type:v.pathBrushOptions.type})}else this.pathHandlerSelected=-1,C||(this._updatePath({type:"curve",pathIndex:T,state:"add",newPoint:e[0].point,data:[]}),g&&g({name:v?v.name:null}))}else this.pathHandlerSelected=-1,this._updatePath({type:"curve",pathIndex:T,state:"add",newPoint:e[0].point,data:[]}),g&&g({name:v?v.name:null,keep:!0})}else if("click"===c){const e=t.intersectObjects(d);e.length>0&&this._clickItem(e[0])}}else if(v&&v.pathIndex>-1&&this._showPath(),e.set(i.offsetX/Ep.renderer.domElement.clientWidth*2-1,-i.offsetY/Ep.renderer.domElement.clientHeight*2+1),t.setFromCamera(e,Ep.camera),b&&b.visible&&(!v||v&&v.pathBrushOptions)){b.updateWorldMatrix(!0,!0);const e=t.intersectObjects([...b.children[0].children,...b.children[1].children]);let i=-1,n=-1;this.pathHandlerSelected=-1;for(let t=0;t<e.length;t++){if("__avw_path_brush_handler"===e[t].object.name&&e[t].object.visible){i=t;break}if("__avw_path_brush_np_handler"===e[t].object.name&&e[t].object.visible){n=t;break}}if(i>=0){const t=e[i].object,n=t.userData.handlerIndex;this.setLayerName(t.userData.layerName,!0);const a=b.children[0].children.find((e=>"__avw_path_brush_handler"===e.name&&e.userData.handlerIndex===t.userData.handlerIndex));a&&(Ep.instance.disableTransform(),C=!1,Ep.instance.enableTransformByUUID(a.uuid,(e=>{C=!0,this._updatePath({type:"curve",pathIndex:T,state:"change",pointIndex:n,pointEvent:e})})),this.pathHandlerSelected=n)}else if(n>=0){const t=e[n].object,i=t.userData.handlerIndex;this.setLayerName(t.userData.layerName,!0),this.insertPathPoint(t.position,i);const a=b.children[0].children.find((e=>"__avw_path_brush_handler"===e.name&&e.userData.handlerIndex===i));a&&(Ep.instance.disableTransform(),C=!1,Ep.instance.enableTransformByUUID(a.uuid,(e=>{C=!0,this._updatePath({type:"curve",pathIndex:T,state:"change",pointIndex:i,pointEvent:e})})),this.pathHandlerSelected=i)}this.pathHandlerSelected>-1&&N?N({name:v?v.name:null,pathIndex:v.pathIndex,pointIndex:this.pathHandlerSelected,mode:c,type:v.pathBrushOptions.type}):U()&&v&&g&&g({name:v.name},"refresh")}}},this.onPointerDown=e=>{if(e.target===Ep.renderer.domElement&&2===e.button&&"pathbrush"===c&&(h=!1),!s||e.target!==Ep.renderer.domElement||0!==e.button)return;if(u=!0,h=!1,"paint"!==c&&"brush"!==c&&"pathbrush"!==c)return;const i=t.intersectObjects(d);i.length>0&&("paint"!==c&&"brush"!==c||r||(r=setInterval((()=>{this._paint(i[0].point,null,i[0].object)}),500)))},this.onDocumentKeyDown=e=>{switch(e.keyCode){case 16:o=!0}},this.onDocumentKeyUp=e=>{switch(e.keyCode){case 16:o=!1}},this._getCurrentLayer=e=>(p=e,Ep.defaultObjectTree.getItemByName(p)),this._createDrawGroup=()=>{if(!v){let e=_y.getCopyName("Layer",null,Ep.defaultObjectTree);v=new ex({name:e,index:void 0,isVisible:!0})}},this.setLayerName=async(e,t,i,n)=>{e&&""!==e?e&&"pathbrush"===c&&v&&v.name==e&&this._showPath():(Ep.instance.disableTransform(),C=!1,t=!1),B=t;let r=!1;if(e&&v&&v.name!==e&&("number"==typeof v.pathIndex&&-1!==v.pathIndex?("preview"!==k&&"add"!==k||this._updatePath({pathIndex:v.pathIndex,state:"finish"}),Ep.transformControls.object=null):(T=-1,this._destroyPath(),r=c&&"roam"!=c)),p=e,v=Ep.defaultObjectTree.getItemByName(p),!v)return k="",T=M.length,void this._destroyPath();if(r&&this.updateWorld(),"number"==typeof v.pathIndex&&-1!==v.pathIndex){if(this._showPath(),T=v.pathIndex,v.pathBrushOptions){const e=v.pathBrushOptions;if(L.type="string"==typeof e.type?e.type:L.type,L.interval="number"==typeof e.interval&&e.interval>0?e.interval:L.interval,L.intervalCoef="number"==typeof e.intervalCoef&&e.intervalCoef>=0?e.intervalCoef:L.intervalCoef,L.padding="number"==typeof e.padding&&e.padding>=0?e.padding:L.padding,L.repeat="number"==typeof e.repeat&&e.repeat>0?e.repeat:L.repeat,L.mirror="boolean"==typeof e.mirror?e.mirror:L.mirror,L.useTangent="boolean"==typeof e.useTangent?e.useTangent:L.useTangent,L.curveClosed="boolean"==typeof e.curveClosed?e.curveClosed:L.curveClosed,L.isVertical="boolean"==typeof e.isVertical?e.isVertical:L.isVertical,"B"===L.type&&this.assets&&this.assets.length){let e=await this.getAssetSize(JSON.parse(JSON.stringify(this.assets[0])));L.intervalB=e.z,L.intervalBCoef=0,v&&v.pathBrushOptions&&"B"===v.pathBrushOptions.type&&(v.pathBrushOptions.intervalB=L.intervalB,v.pathBrushOptions.intervalBCoef=L.intervalBCoef)}if("C"===e.type){const t=L,i=e;void 0!==i.type&&(t.type=i.type),void 0!==i.motion&&(t.motion=i.motion),void 0!==i.curveClosed&&(t.curveClosed=i.curveClosed),i.speed>=0&&(t.speed=i.speed),i.delay>=0&&(t.delay=i.delay),void 0!==i.reverse&&(t.reverse=i.reverse),void 0!==i.useTangent&&(t.useTangent=i.useTangent),void 0!==i.perpendicular&&(t.perpendicular=i.perpendicular),c="pathbrush",a="instanced"}if("D"===e.type){const t=L,i=e;void 0!==i.type&&(t.type=i.type),i.repeat>=1&&(t.repeat=i.repeat),i.padding>=0&&(t.padding=i.padding),i.interval>=0&&(t.interval=i.interval),void 0!==i.curveClosed&&(t.curveClosed=i.curveClosed),i.speed>=0&&(t.speed=i.speed),void 0!==i.mirror&&(t.mirror=i.mirror),void 0!==i.reverse&&(t.reverse=i.reverse),void 0!==i.useTangent&&(t.useTangent=i.useTangent),void 0!==i.perpendicular&&(t.perpendicular=i.perpendicular),void 0!==i.intervalCoef&&(t.intervalCoef=i.intervalCoef),void 0!==i.speedCoef&&(t.speedCoef=i.speedCoef),i.intervalCoef>100&&(i.intervalCoef=100),i.intervalCoef<0&&(i.intervalCoef=0),i.speedCoef>100&&(i.speedCoef=100),i.speedCoef<0&&(i.speedCoef=0),c="pathbrush",a="instanced"}if("E"===e.type){const t=L,i=e;void 0!==i.type&&(t.type=i.type),void 0!==i.style&&(t.style=i.style),i.repeat>=1&&(t.repeat=i.repeat),i.padding>=0&&(t.padding=i.padding),i.width>0&&(t.width=i.width),i.stretchCoef>0&&(t.stretchCoef=i.stretchCoef),i.speed>=0&&(t.speed=i.speed),i.speedCoef>=0&&(t.speedCoef=i.speedCoef),void 0!==i.mirror&&(t.mirror=i.mirror),void 0!==i.reverse&&(t.reverse=i.reverse),void 0!==i.curveClosed&&(t.curveClosed=i.curveClosed),void 0!==i.color&&(t.color=i.color),i.speedCoef>100&&(i.speedCoef=100),i.speedCoef<0&&(i.speedCoef=0),i.stretchCoef>100&&(i.stretchCoef=100),i.stretchCoef<0&&(i.stretchCoef=0)}}if(!v&&e&&(v=this._getCurrentLayer(e),T=v.pathIndex),v.pathBrushAssets){let e=[];for(let t of v.pathBrushAssets){if(!t.param||!t.param.path)continue;let i="";switch(t.type.toLowerCase()){case"iconasset":case"iconitem":i="imagebitmap";break;case"modelasset":default:i="glb"}e.push(new Promise((e=>{Ep.instance.preloadResource(t.param.path,i,(t=>{e(t),logger.debug("finish")}),n)})))}if(Promise.all(e).then((e=>{if("function"==typeof i&&v){const e={name:v.name,id:v.getGroup().uuid,assets:v.pathBrushAssets,...v.pathBrushOptions,mode:v.pathBrushMode,category:v.pathBrushCategory};i(e)}})),v.pathBrushAssets.length>0){v.pathBrushAssets.forEach((e=>{if(this.assets){this.assets.find((t=>t.name===e.name))||this.assets.push(e)}else this.assets=[],this.assets.push(e)}));for(let e=0;e<this.assets.length;e++){if(this.assets[e].gltfIsAdd=!1,v.pathBrushAssets.find((t=>this.assets[e].name===t.name)))for(let e=0;e<v.pathBrushAssets.length;e++)v.pathBrushAssets[e].name===this.assets[e].name&&(this.assets[e].randomValues=v.pathBrushAssets[e].randomValues,this.assets[e].intensity=v.pathBrushAssets[e].intensity,this.assets[e].param=v.pathBrushAssets[e].param,this.assets[e].probability=v.pathBrushAssets[e].probability,this.assets[e].type=v.pathBrushAssets[e].type,v.pathBrushAssets[e].textParam&&(this.assets[e].textParam=v.pathBrushAssets[e].textParam));else this.assets.splice(e,1),e--}}else this.assets=[]}v.pathBrushFrozen&&(v.pathBrushOptions&&(L=Object.assign(L,v.pathBrushOptions)),U()||this._updatePath({pathIndex:v.pathIndex,state:"refresh"}),Ep.pointerDisabled&&(Ep.pointerDisabled=!1)),T=v.pathIndex,b.onBeforeRender=function(){v&&(this.position.copy(v.getGroup().position),this.rotation.copy(v.getGroup().rotation),this.scale.copy(v.getGroup().scale))},U()||(this._visualizePath({path:M[T],mesh:b}),b.children.length&&(b.children[0].clear(),b.children[1].clear()),this._refreshPathHandler({path:M[T],mesh:b}))}v||"pathbrush"!==c?-1!=v.pathIndex&&null!=v.pathIndex||(T=-1,this._destroyPath()):(T=M.length,this.switchPath(T))},this.getAssetSize=e=>new Promise((t=>{Ep.cacheStore.load({path:e.modelPath||e.param.path,type:e.modelType||"glb",onLoad:e=>{let i=new Re;i.setFromObject(e),t({x:i.max.x-i.min.x,z:i.max.z-i.min.z})}})})),this.loadPaintPath=(e,t)=>{v=null;let i=e.map((e=>e.clone()));this._updatePath({type:"curve",pathIndex:M.length,state:"add",newPoint:e[0],data:i,name:t});let{x:n,y:a,z:r}=Ep.defaultObjectTree.getItemByName(t).transform.position,s=new Ce(n,a,r),o=M[v.pathIndex];for(let e of o.points)e.add(s);this._updatePath({pathIndex:v.pathIndex,state:"finish",fromLoadPaintPath:!0}),g&&g({name:v?v.name:null})},this.removePaintPath=e=>{T==e&&(T=-1),M.length>e&&M.splice(e,1)},this.setMode=async(e="roam",t="clone",r,o,l,h,u,d,b,w)=>{p&&"pathbrush"===e.toLowerCase()&&this._showPath(),"roam"===c&&"preview"===k&&p&&v&&"number"==typeof v.pathIndex&&-1!==v.pathIndex&&(this._updatePath({pathIndex:v.pathIndex,state:"finish"}),g&&g({name:v?v.name:null,keep:!0}),T=M.length,this.switchPath(T)),this.pathHandlerSelected=-1,v=null,_=h,x=1/l;let S=c.toLowerCase(),A=JSON.parse(JSON.stringify(L));v=Ep.defaultObjectTree.getItemByName(p),w&&w.type&&v&&v.pathBrushOptions&&v.pathBrushOptions.type===w.type&&(w=w||{},"B"===v.pathBrushOptions.type&&"B"===w.type&&("number"==typeof v.pathBrushOptions.intervalB&&(w.interval=v.pathBrushOptions.intervalB),"number"==typeof v.pathBrushOptions.intervalBCoef&&(w.intervalCoef=v.pathBrushOptions.intervalBCoef)),w=Object.assign(v.pathBrushOptions,w),L=JSON.parse(JSON.stringify(w)));let E=[];for(let e of o){if(!e.param||!e.param.path)continue;let t="";switch(e.type.toLowerCase()){case"iconasset":case"iconitem":case"papercutitem":t="imagebitmap";break;case"modelasset":default:t="glb"}E.push(new Promise((i=>{Ep.instance.preloadResource(e.param.path,t,(e=>{i(e),logger.debug("finish")}),d)})))}if(Promise.all(E).then((e=>{b&&b(e)})),o.length>0){o.forEach((e=>{if(this.assets){this.assets.find((t=>t.name===e.name))||this.assets.push(e)}else this.assets=[],this.assets.push(e)}));for(let e=0;e<this.assets.length;e++){if(this.assets[e].gltfIsAdd=!1,o.find((t=>this.assets[e].name===t.name)))for(let e=0;e<o.length;e++)o[e].name===this.assets[e].name&&(this.assets[e].randomValues=o[e].randomValues,this.assets[e].intensity=o[e].intensity,this.assets[e].param=o[e].param,this.assets[e].probability=o[e].probability,this.assets[e].type=o[e].type,o[e].textParam&&(this.assets[e].textParam=o[e].textParam));else this.assets.splice(e,1),e--}}else this.assets=[];if(this.setSize(r),c=e.toLowerCase(),a=t,"pathbrush"===c&&w){if(L.type="string"==typeof w.type?w.type:L.type,L.interval="number"==typeof w.interval&&w.interval>0?w.interval:L.interval,L.intervalCoef="number"==typeof w.intervalCoef&&w.intervalCoef>=0?w.intervalCoef:L.intervalCoef,L.padding="number"==typeof w.padding&&w.padding>=0?w.padding:L.padding,L.repeat="number"==typeof w.repeat&&w.repeat>0?w.repeat:L.repeat,L.mirror="boolean"==typeof w.mirror?w.mirror:L.mirror,L.useTangent="boolean"==typeof w.useTangent?w.useTangent:L.useTangent,L.curveClosed="boolean"==typeof w.curveClosed?w.curveClosed:L.curveClosed,L.isVertical="boolean"==typeof w.isVertical?w.isVertical:L.isVertical,"B"===L.type&&this.assets.length){let e=await this.getAssetSize(JSON.parse(JSON.stringify(this.assets[0])));L.interval=e.z,L.intervalCoef=0,v&&v.pathBrushOptions&&"B"===v.pathBrushOptions.type&&(v.pathBrushOptions.intervalB=L.intervalB,v.pathBrushOptions.intervalBCoef=L.intervalBCoef)}if("C"===L.type){const e=L,t=w;void 0!==t.motion&&(e.motion=t.motion),void 0!==t.curveClosed&&(e.curveClosed=t.curveClosed),t.speed>=0&&(e.speed=t.speed),t.delay>=0&&(e.delay=t.delay),void 0!==t.reverse&&(e.reverse=t.reverse),void 0!==t.useTangent&&(e.useTangent=t.useTangent),void 0!==t.perpendicular&&(e.perpendicular=t.perpendicular)}if("D"===L.type){const e=L,t=w;t.repeat>=1&&(e.repeat=t.repeat),t.padding>=0&&(e.padding=t.padding),t.interval>=0&&(e.interval=t.interval),void 0!==t.curveClosed&&(e.curveClosed=t.curveClosed),t.speed>=0&&(e.speed=t.speed),void 0!==t.mirror&&(e.mirror=t.mirror),void 0!==t.reverse&&(e.reverse=t.reverse),void 0!==t.useTangent&&(e.useTangent=t.useTangent),void 0!==t.perpendicular&&(e.perpendicular=t.perpendicular),void 0!==t.intervalCoef&&(e.intervalCoef=t.intervalCoef),void 0!==t.speedCoef&&(e.speedCoef=t.speedCoef),t.intervalCoef>100&&(t.intervalCoef=100),t.intervalCoef<0&&(t.intervalCoef=0),t.speedCoef>100&&(t.speedCoef=100),t.speedCoef<0&&(t.speedCoef=0)}if("E"===L.type){const e=L,t=w;void 0!==t.style&&(e.style=t.style),t.repeat>=1&&(e.repeat=t.repeat),t.padding>=0&&(e.padding=t.padding),t.width>0&&(e.width=t.width),t.stretchCoef>0&&(e.stretchCoef=t.stretchCoef),t.speed>=0&&(e.speed=t.speed),t.speedCoef>=0&&(e.speedCoef=t.speedCoef),void 0!==t.mirror&&(e.mirror=t.mirror),void 0!==t.reverse&&(e.reverse=t.reverse),void 0!==t.curveClosed&&(e.curveClosed=t.curveClosed),void 0!==t.color&&(e.color=t.color),t.speedCoef>100&&(t.speedCoef=100),t.speedCoef<0&&(t.speedCoef=0)}}if(S===c&&"roam"!==c)return this.updateWorld(),void("pathbrush"===c&&(s||(s=!0),"B"!=A.type&&(delete A.intervalB,delete A.intervalBCoef),"B"!=L.type&&(delete L.intervalB,delete L.intervalBCoef),_y.eq(A,L)?this._updatePath({pathIndex:T,state:"refresh"}):this._updatePath({pathIndex:T,state:"redraw"})));switch(c){case"roam":s=!1,m=!1,f=!1,i.visible=!1,"editor"===Ep.pointerMode?Ep.orbitControls.keyOperate="paint":Ep.orbitControls.keyOperate=null,Ep.pointerDisabled=!1,document.removeEventListener("keydown",this.handleKeys);break;case"plot":case"paint":s=!0,m=!1,f=!1,i.visible=!0,Ep.orbitControls.keyOperate="paint",n.color=new Qt("#ffb300"),Ep.pointerDisabled=!0,document.addEventListener("keydown",this.handleKeys);break;case"remove":s=!0,m=!0,f=!1,i.visible=!1,Ep.orbitControls.keyOperate="paint",Ep.pointerDisabled=!0,document.removeEventListener("keydown",this.handleKeys);break;case"click":s=!0,m=!1,f=!0,i.visible=!1,Ep.orbitControls.keyOperate="paint",Ep.pointerDisabled=!0,document.removeEventListener("keydown",this.handleKeys);break;case"pathbrush":s=!0,m=!1,f=!1,i.visible=!1,Ep.orbitControls.keyOperate="paint",Ep.pointerDisabled=!0,document.removeEventListener("keydown",this.handleKeys),v&&v.pathBrushFrozen&&(Ep.pointerDisabled=!1,"B"!=A.type&&(delete A.intervalB,delete A.intervalBCoef),"B"!=L.type&&(delete L.intervalB,delete L.intervalBCoef),_y.eq(A,L)||this._updatePath({pathIndex:T,state:"redraw"}));break;default:c=S}this.updateWorld(),u&&(g=u),d&&(y=d)},this.updateWorld=()=>{"click"!==c&&"remove"!==c||!p?(d.length=0,Ep.scene.children.map(((e,t)=>{"__tilesGroup"===e.name&&e.children[0]?d.push(e.children[0]):"__models"===e.name&&e.traverseVisible((function(e){if(_)d.push(e);else if(e.isMesh&&"PaintGroup"!==e.type&&"PaintGroup"!==e.parent.type){let t=e;for(;t.parent&&"PaintGroup"!==t.parent.type;)t=t.parent;if(t.parent&&"PaintGroup"===t.parent.type)return;d.push(e)}}))}))):(d.length=0,v&&(v.getGroup().children.map((e=>{"IconGroup"===e.type?e.children.map((e=>{d.push(e)})):"InstancedGroup"===e.type?e.children.map((e=>{e.children.map((e=>{d.push(e)}))})):"InstancedHelper"!==e.type&&d.push(e)})),v.children.map((e=>{"ModelItem"===e.type?e.getGroup().children.map((e=>{d.push(e)})):"PaperCutItem"===e.type&&e.getGroup().traverse((e=>{e.geometry&&d.push(e)}))}))))},this.setData=e=>{for(let t of this.assets){let i=Ep.instancedObjectStore.findInstancedObject(t.name);i?i.addInstance(points):Ep.instancedObjectStore.add(new X_({name:t.name,modelPath:t.modelPath,transform:t.transform,points:e}))}},this._visualizePath=({path:e,mesh:t,segments:i=12,curveClosed:n})=>{if(e){if(!t){const e=M[T].getPoints(2),i=(new wi).setFromPoints(e);i.computeBoundingSphere();const n=new Kr({color:16711680,depthTest:!1,depthWrite:!1,transparent:!0});b=new as(i,n);const a=new sr;a.name="__avw_path_brush_handler_group";const r=new sr;r.name="__avw_path_brush_np_handler_group",b.add(a),b.add(r),t=b,b.renderOrder=1/0,Ep.scene.sysObjects.add(b),b.frustumCulled=!1}if(t.isLine){let n=e;if("B"===L.type){const t=[];for(let i of e.points)t.push(i.clone()),t.push(i.clone());n=new pl(t)}return n.updateArcLengths(),t.geometry.setFromPoints(n.getPoints(i*e.points.length)),t.geometry.computeBoundingSphere(),void(t.visible=!!B)}t.isMesh}},this._refreshPathHandler=({path:e,mesh:t,curveClosed:i}={})=>{if(e&&t&&t.children.length){t.children[1].clear();for(let n=0;n<e.points.length;n++){if(t.children[0].children[n]){let i=!1;for(let e of t.children[0].children)if(e.userData.handlerIndex===n){i=!0;break}if(!i){const i=this._createPathHandler(e.points[n],n);t.children[0].add(i)}}else{const i=this._createPathHandler(e.points[n],n);t.children[0].add(i)}if(n>=1&&!e.points[n].equals(e.points[n-1])){const a=this._createPathNPHandler(e.points[n],e.points[n-1],n,M[T],i);t.children[1].add(a)}}}},this._destroyPath=()=>{if(b){if(b.isLine){if(!E)return;return E=!1,void(A=setTimeout((()=>{b.geometry.setFromPoints([]),b.geometry.computeBoundingSphere(),b.visible=!1}),100))}b.isMesh&&(b.visible=!1)}},this._showPath=()=>{A&&(clearTimeout(A),A=null),!E&&b&&(b.visible=!0,E=!0),s||(s=!0)},this._createPathHandler=(e,t)=>{const i=new Fi(I,P);return i.name="__avw_path_brush_handler",i.position.copy(e),i.renderOrder=1/0,i.userData.handlerIndex=t,i.userData.layerName=v.name,i},this._createPathNPHandler=(e,t,i,n,a)=>{const r=new Fi(O,D);r.name="__avw_path_brush_np_handler";let s=n;if("B"===L.type){const e=[];for(let t of n.points)e.push(t.clone()),e.push(t.clone());s=new pl(e),i*=2}s.updateArcLengths();let o=0,l=0,c=0,h=0;for(let e=0;e<s.points.length-1;e++)e===i-1&&(l=o),e===i&&(c=o),o+=s.points[e+1].distanceTo(s.points[e]);if(l>0&&0===c&&(c=o),h=(c+l)/2,2===s.points.length&&(h=o/2),0!==o)return r.position.copy(s.getPointAt(h/o)),r.renderOrder=1/0,"B"===L.type?r.userData.handlerIndex=i/2:r.userData.handlerIndex=i,r.userData.layerName=v.name,r},this.getPaths=()=>M.filter((e=>e&&e.userData&&e.userData.layer)).map((e=>{let t=Ep.defaultObjectTree.getItemByName(e.userData.layer)||{},i=e.points.map((e=>e.clone()));return{layer:t.name,points:i,layerIndex:t.index}})).filter((e=>e.layer)).sort(((e,t)=>e.layerIndex-t.layerIndex)),this.renamePathLayer=(e,t)=>{let i=M.find((t=>t.userData&&t.userData.layer==e));i&&(i.userData.layer=t)},this.getPathsByPoints=()=>M.map((e=>e.points)),this.restorePaths=e=>{e instanceof Array&&(M=[...e])},this.restorePathsByPoints=e=>{if(e instanceof Array){M.length=0;for(let t of e)M.push(new pl(t))}},this.switchPath=e=>{"number"!=typeof e||e<0||e>M.length||(this._updatePath({type:"curve",pathIndex:T,state:"finish"}),T=e,e<M.length?(v.pathPoints&&(M[T].points=[...v.pathPoints]),newPoint=M[T].points[M[T].points.length-1].clone()):this._createDrawGroup())},this._updatePath=({type:e="curve",pathIndex:t=0,state:i,newPoint:n,pointIndex:r,pointEvent:s,data:o=[],name:l,fromLoadPaintPath:h=!1}={})=>{if(t<0||t>M.length||"add"!==i&&t==M.length)return;if(v&&v.pathBrushFrozen&&(k="halt"),"add"===i){if("halt"===k&&!o.length)return;if(!n&&!o.length)return;if(t===M.length){if(!v&&(this._createDrawGroup(),v.pathIndex=T,void 0!==l)){const e=Ep.defaultObjectTree.getItemByName(l),t=v.getGroup(),i=e.getGroup();t.position.copy(i.position),t.rotation.copy(i.rotation),t.scale.copy(i.scale)}let e=null;if(e=o.length?new pl(o):new pl([n.clone(),n.clone()]),e.userData={layer:v.name},M.push(e),b)b.children.length&&(b.children[0].clear(),b.children[1].clear());else{const e=M[t],i=e.getPoints(2),a=(new wi).setFromPoints(i);a.computeBoundingSphere();const r=new Kr({color:16711680,depthTest:!1,depthWrite:!1,transparent:!0});b=new as(a,r);const s=new sr;s.name="__avw_path_brush_handler_group";const o=new sr;o.name="__avw_path_brush_np_handler_group",b.add(s),b.add(o),b.renderOrder=1/0,Ep.scene.sysObjects.add(b),b.frustumCulled=!1;const l=e.points.length-2,c=this._createPathHandler(n,l);b.children[0].add(c)}}else{const e=M[t],i=e.points[e.points.length-1];e.points.push(n.clone()),L.type;const a=e.points.length-2,r=this._createPathHandler(n,a);b.children[0].add(r);const s=this._createPathNPHandler(n,i,a,e);b.children[1].add(s)}return void(k=i)}const u=L.curveClosed;if("preview"===i){if("halt"===k)return;if(!n||t>M.length-1)return;const e=M[t];return e.points[e.points.length-1].copy(n),e&&(e.closed=u),this._visualizePath({path:e,mesh:b,curveClosed:u}),this._updatePathDrawing({path:e,options:L,updateRange:"last2Points"}),void(k=i)}if("change"===i){if(t>M.length-1)return;const e=M[t];if(e&&(e.closed=u),"number"!=typeof r||r<0||r>=e.points.length||!s)return;return e.points[r].copy(s.target.object.position),L.type,this._visualizePath({path:e,mesh:b,curveClosed:u}),this._refreshPathHandler({path:e,mesh:b,curveClosed:u}),this._updatePathDrawing({path:e,options:L}),void(k="halt")}if("delete"!==i){if("refresh"===i){const e=M[t];return e&&(e.closed=u),this._visualizePath({path:e,mesh:b,curveClosed:u}),void this._updatePathDrawing({path:e,options:L,updateRange:"none"})}if("redraw"===i){const e=M[t];return e&&(e.closed=u),this._visualizePath({path:e,mesh:b,curveClosed:u}),this._updatePathDrawing({path:e,options:L}),void("function"==typeof g&&g({name:v.name},"refresh"))}if("halt"===i){if(k===i)return;const e=M[t];return e.points[e.points.length-1].copy(e.points[e.points.length-2]),e&&(e.closed=u),this._visualizePath({path:e,mesh:b,curveClosed:u}),this._updatePathDrawing({path:e,options:L}),void(k=i)}if("finish"===i){if(t>M.length-1||!v)return;const e=M[t];if(e.finished=e.finished||h,"halt"===k||e.finished||(e.points.splice(e.points.length-1,1),e.finished=!0),e.points.length<2)return b.children.length&&(b.children[0].clear(),b.children[1].clear()),void(b.visible=!1);let i;if(this._visualizePath({path:e,mesh:b}),this._updatePathDrawing({path:e,options:L}),b.children.length&&(b.children[0].clear(),b.children[1].clear()),b.visible=!1,!v.pathBrushFrozen&&e.points[0]){let t=v.getGroup(),n=new Ce,a={x:0,y:0,z:0,count:0};for(let t of e.points)a.x+=t.x,a.y+=t.y,a.z+=t.z,a.count++;a.count>=1&&(n.x=a.x/a.count,n.y=a.y/a.count,n.z=a.z/a.count),v.transform.position&&(v.transform.position.x=n.x,v.transform.position.y=n.y,v.transform.position.z=n.z),t.position.copy(n),n.multiplyScalar(-1),i=n.clone();for(let t of e.points)t.add(n);for(let e of t.children)e.isInstancedMesh||e.position.add(n);for(let e of v.children){const t=v.modelInstanced.find((t=>t.name===e.parent));if(t){let i=t.getTransform(e.key).position;i.x+=n.x,i.y+=n.y,i.z+=n.z;const a=t.getHelper(e.key);a&&a.lazyUpdate(i)}}}v.pathPoints=[...e.points],v.pathIndex=t;let n=L.type;return v.pathBrushOptions&&(n=v.pathBrushOptions.type),v.pathBrushOptions=_y.clone(L),v.pathBrushOptions.type=n,v.pathBrushAssets=_y.clone(this.assets),v.pathBrushCategory=a,v.pathBrushOptions.offset=i,v.pathBrushMode||(v.pathBrushMode=c,v.pathBrushOptions.mode=c),v.modelInstanced.forEach((e=>{e.particleStoreArray.map((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=i.clone()}))}))})),v.pathBrushFrozen=!0,Ep.pointerDisabled=!1,void(k="")}}else k=i},this._updatePathDrawing=({path:e,options:t,updateRange:i})=>{if(!v)return;if("C"===t.type||"D"===t.type||"E"===t.type)return void this._updatePathDrawing2({path:e,options:t});let n=t.interval||10,a=t.intervalCoef||0;const r="number"==typeof t.padding&&t.padding>=0?t.padding:5,s=t.repeat||1,o=t.mirror&&!0,c=o?2:1,h=t.useTangent&&!0,u=t.curveClosed;t.isVertical;let d=e;if("B"===L.type){const t=[];for(let i of e.points)t.push(i.clone()),t.push(i.clone());d=new pl(t)}d.updateArcLengths();let p=1;if("lastPoint"===i&&d.points.length>=3){let e=0;for(let t=0;t<d.points.length-1;t++)e+=d.points[t+1].distanceTo(d.points[t]);let t=d.points[d.points.length-1].distanceTo(d.points[d.points.length-2]);"B"===L.type&&(t+=d.points[d.points.length-2].distanceTo(d.points[d.points.length-3])),p=t/e}"none"===i&&(p=0);const m=d.getLength(),f=Math.floor(m/n)+1,g=d.getSpacedPoints(f),y=((e,t,i)=>{const n=new Ce,a=[],r=[],s=[],o=[],l=new Ce,c=new it;for(let i=0;i<=t;i++){const n=i/t;a[i]=e.getTangentAt(n,new Ce),a[i].normalize()}r[0]=new Ce,s[0]=new Ce,o[0]=new Ce;let h=Number.MAX_VALUE;const u=Math.abs(a[0].x),d=Math.abs(a[0].y),p=Math.abs(a[0].z);u<=h&&(h=u,n.set(1,0,0)),d<=h&&(h=d,n.set(0,1,0)),p<=h&&n.set(0,0,1),n.set(0,1,0),l.crossVectors(a[0],n).normalize(),r[0].crossVectors(a[0],l),s[0].crossVectors(a[0],r[0]);const m=new Ce(a[0].x,0,a[0].z);m.normalize(),o[0].crossVectors(m,new Ce(0,-1,0));for(let e=1;e<=t;e++){if(r[e]=r[e-1].clone(),s[e]=s[e-1].clone(),l.crossVectors(a[e-1],a[e]),l.length()>Number.EPSILON){l.normalize();const t=Math.acos(ge.clamp(a[e-1].dot(a[e]),-1,1));r[e].applyMatrix4(c.makeRotationAxis(l,t))}s[e].crossVectors(a[e],r[e]);const t=new Ce(a[e].x,0,a[e].z);t.normalize(),o[e]=new Ce,o[e].crossVectors(t,new Ce(0,-1,0))}if(!0===i){let e=Math.acos(ge.clamp(r[0].dot(r[t]),-1,1));e/=t,a[0].dot(l.crossVectors(r[0],r[t]))>0&&(e=-e);for(let i=1;i<=t;i++)r[i].applyMatrix4(c.makeRotationAxis(a[i],e*i)),s[i].crossVectors(a[i],r[i])}return{tangents:a,normals:r,binormals:s,paddings:o}})(d,f,u);"B"===L.type&&(y.tangents instanceof Array&&y.tangents.length>3&&(y.tangents[0].copy(y.tangents[1]),y.tangents[y.tangents.length-1].copy(y.tangents[y.tangents.length-2])),y.normals instanceof Array&&y.normals.length>3&&(y.normals[0].copy(y.normals[1]),y.normals[y.normals.length-1].copy(y.normals[y.normals.length-2])),y.binormals instanceof Array&&y.binormals.length>1&&(y.binormals[0].copy(y.binormals[1]),y.binormals[y.binormals.length-1].copy(y.binormals[y.binormals.length-2])));const b=v.children.length,_=g.length*(s*c),x=Math.min(b,_);for(let e=0;e<x;e++){if(p<1&&e/b<1-p)continue;const t=Math.floor(e/(s*c));let i=y.tangents[t],l=y.paddings[t];const u=g[t].clone();if("B"===L.type&&(n=L.intervalB,a=L.intervalBCoef),F(a,t,g,d,u,y,i,l),s*c%2!=1||2*e+1!=s*c){const t=e%(s*c)-(s*c-1)/2;u.x+=l.x*r*t,u.z+=l.z*r*t}let m=0;if(h&&(m=Math.atan2(i.x,i.z)),o&&e%(s*c)>=s*c/2&&(m+=Math.PI),this.assets instanceof Array){const t=this.assets.find((t=>t.name===v.children[e].parent));if(t&&t.randomValues&&t.randomValues.rotateFlag){const e=t.randomValues.rotateMin,i=t.randomValues.rotateMax,n=Math.random();m+=ge.degToRad(e+(i-e)*n)}}const f=new dt(v.children[e].transform.rotation?v.children[e].transform.rotation._x:0,m,v.children[e].transform.rotation?v.children[e].transform.rotation._z:0),_=v.modelInstanced.find((t=>t.name===v.children[e].parent));if(_){const t=_.getHelper(v.children[e].key);t&&t.lazyUpdate(u,f)}}if(b<_)for(let e=b;e<_;e++){if(0===p)continue;const t=Math.floor(e/(s*c));let i=y.tangents[t],u=y.paddings[t];const m=g[t].clone();if("B"===L.type&&(n=L.intervalB,a=L.intervalBCoef),F(a,t,g,d,m,y,i,u),s*c%2!=1||2*e+1!=s*c){const t=e%(s*c)-(s*c-1)/2;m.x+=u.x*r*t,m.z+=u.z*r*t}l=100;const f=this._paint(m,void 0,void 0,!0);let b=0;if(h&&(b=Math.atan2(i.x,i.z)),o&&e%(s*c)>=s*c/2&&(b+=Math.PI),f&&f.randomValues&&f.randomValues.rotateFlag){const e=f.randomValues.rotateMin,t=f.randomValues.rotateMax,i=Math.random();b+=ge.degToRad(e+(t-e)*i)}const _=new dt(0,b,0),x=v.modelInstanced.find((e=>e.name===f.name));if(x){const t=x.getHelper(v.children[e].key);t&&t.lazyUpdate(m,_)}}if(b>_)for(let e=b-1;e>=_;e--)v.children[e]?v.children[e].isInstancedItem?v.removeItem(v.children[e].name,v.children[e].key,"preview"):v.removeItem(v.children[e].name):console.warn(`${e} not found.`)},this._updatePathDrawing2=({path:e,options:t,drawGroup:i})=>{let n;i&&(n={_drawGroup:v,_mode:c,_category:a,assets:this.assets},v=i,c="pathbrush",a="instanced",e=M[v.pathIndex],t=v.pathBrushOptions,e.finished=!0,v.pathBrushAssets&&v.pathBrushAssets.length>0&&(this.assets=[...v.pathBrushAssets]));if("C"===t.type){v.children.length||(l=100,this._paint(e.points[0],void 0,void 0,!0));const i=t.speed*Ep.worldScale,n=e.getLength(),a=12*(Math.floor(n/i)+1),r=e.getSpacedPoints(a),s=e.computeFrenetFrames(a),o=[0];let c=0;for(let e=0;e<r.length-1;e++){const t=r[e].distanceTo(r[e+1]);o.push(t),c+=t}v.children[0].movingAnimation||v.children[0].createMovingAnimation();const h=v.children[0].movingAnimation;h.lineIndex=0,h.paintPoints=r,h.paintTangents=s.tangents,h.paintLengths=o,h.maxLength=c,h.motion=t.motion,h.speed=i,h.delay=t.delay,h.reverse=t.reverse,h.useTangent=t.useTangent,h.perpendicular=t.perpendicular,h.reset(),v.pathBrushLinePoints=[{points:r,tangents:s.tangents,lengths:o}]}if("D"===t.type){if(this.assets.length<=0)return;const i=t.repeat,n=t.padding*Ep.worldScale,a=t.mirror?2:1,r=t.interval*Ep.worldScale,s=.01*t.intervalCoef,o=t.speed*Ep.worldScale,c=.01*t.speedCoef,h=!!t.reverse,u=!!t.useTangent,d=e.getLength(),p=12*(Math.floor(d/o)+1),m=e.getSpacedPoints(p),f=e.computeFrenetFrames(p);z(f);const g=[],y=i*a;for(let e=0;e<=p;e++){const t=m[e].clone(),i=f.binormals[e].clone(),r=f.tangents[e].clone();i.multiplyScalar(n);for(let n=0;n<y;n++){g[n]||(g[n]={position:n-(y-1)/2,reverse:h,maxLength:0,points:[],tangents:[],lengths:[0],speed:o},g[n].speed+=(Math.random()-.5)*c*g[n].speed,2===a&&g[n].position>0&&(g[n].reverse=!g[n].reverse));const s=g[n],l=i.clone().multiplyScalar(s.position);if(s.points.push(t.clone().add(l)),s.tangents.push(r.clone()),s.points.length>1){const t=s.points[e].distanceTo(s.points[e-1]);s.lengths.push(t),s.maxLength+=t}}}let b=v.children.length,_=0;for(let e=0;e<g.length;e++){const i=g[e];let n=0;for(;;){_+1>b&&(l=100,this._paint(i.points[0],void 0,void 0,!0));const a=v.children[_];if(!a)continue;if(!(a instanceof _b)){v.removeItem(a.name),b--;continue}a.movingAnimation||a.createMovingAnimation();const o=a.movingAnimation;if(o.lineIndex=e,o.startLength=n,o.paintPoints=i.points,o.paintTangents=i.tangents,o.paintLengths=i.lengths,o.maxLength=i.maxLength,o.reverse=i.reverse,o.speed=i.speed,o.useTangent=u,o.perpendicular=t.perpendicular,o.reset(),_++,n+=r,n+=(Math.random()-.5)*s*r,i.maxLength-n<r)break}}if(v.pathBrushLinePoints=g.map((e=>({points:e.points,tangents:e.tangents,lengths:e.lengths}))),b>_)for(let e=b-1;e>=_;e--){const t=v.children[e];t&&v.removeItem(t.name)}}if("E"===t.type){const i=t.style,n=t.repeat,a=t.padding*Ep.worldScale,r=t.width,s=t.stretchCoef,o=t.speed*Ep.worldScale,l=.01*t.speedCoef,c=t.mirror?2:1,h=!!t.reverse,u=t.color||"#ff0000",d=12*e.points.length,p=e.getPoints(d),m=e.computeFrenetFrames(d);z(m);const f=[],g=n*c;for(let e=0;e<=d;e++){const t=p[e].clone(),i=m.binormals[e].clone();i.multiplyScalar(a);for(let e=0;e<g;e++){f[e]||(f[e]={position:e-(g-1)/2,reverse:h,maxLength:0,points:[],speed:o},f[e].speed+=(Math.random()-.5)*l*f[e].speed,2===c&&f[e].position>0&&(f[e].reverse=!f[e].reverse));const n=f[e],a=i.clone().multiplyScalar(n.position);n.points.push(t.clone().add(a))}}const y=v.effectPathItems.length;let b=0;for(const t of f){b+1>y&&v.addEffectPath(new tv({name:`${v.name}:${b+1}`})),t.reverse&&t.points.reverse();v.effectPathItems[b].loadPath(t.points,i,r,s,t.speed,e.finished,u),b++}if(y>b)for(let e=y-1;e>=b;e--)v.removeEffectPath(v.effectPathItems[e])}n&&(v=n._drawGroup,c=n._mode,a=n._category,this.assets=n.assets)},this.insertPathPoint=(e,t)=>{if(T>=M.length)return;const i=M[T];i.points.splice(t,0,e.clone());for(let e=t;e<b.children[0].children.length;e++)"__avw_path_brush_handler"===b.children[0].children[e].name&&(b.children[0].children[e].userData.handlerIndex+=1);this._visualizePath({path:i,mesh:b}),this._refreshPathHandler({path:i,mesh:b}),this._updatePathDrawing({path:i,options:L})},this.deletePathPoint=(e,t)=>{if(e>=M.length)return;const i=M[e];t>=i.points.length||i.points.length<3||(i.points.splice(t,1),this._visualizePath({path:i,mesh:b}),this._updatePathDrawing({path:i,options:L}),v.pathPoints=i.points,g&&g({name:v?v.name:null},"删除路径点成功"))},this.addBrushPath=(e,t,i)=>{e&&M instanceof Array&&"number"==typeof t&&!(t<0)&&(M.length,M[t]=new pl(i),M[t].userData={layer:e},M[t].finished=!0)},this.clearBrushPath=()=>{M.length=0,T=0},this.leavePaintMode=e=>{if("pathbrush"===c&&v&&!(T>=M.length||-1==T)&&(console.warn("Painting interrputed by user."),this._updatePath({type:"curve",pathIndex:T,state:"finish"}),"function"==typeof e)){e(v?v.name:"",(!v||!v.pathBrushFrozen)&&(M[T]&&M[T].points.length<=2))}}}}var rw=function(e){this.orbitControl=e,this.enabled=!0,this.target=new Ce,this.targetObject=void 0,this.viewDistance=100,this.minDistance=1,this.maxDistance=1e4,this.inclination=-45,this.maxInclination=90,this.minInclination=-90,this.azimuth=0,this.autoRotateEnable=!1,this.autoRotateSpeed=.1,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:i.ROTATE,MIDDLE:i.PAN,RIGHT:i.DOLLY},this.touches={ONE:n.ROTATE,TWO:n.DOLLY_PAN},this.startPos=new Ce(0,0,0),this.startInclination=0,this.startAzimuth=0,this.targetPos=new Ce(0,0,0),this.targetInclination=0,this.targetAzimuth=0,this.currentTime=0,this.durationTime=0,this.startDistance=0,this.targetDistance=0,this.target0=this.target.clone(),this.position0=this.orbitControl.object.position.clone(),this.zoom0=this.orbitControl.object.zoom,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.callback=void 0;var t=!1,a=this;Object.defineProperty(a,"isZoomTo",{get:function(){return t}});function r(e,t,i,n){var a=t-e;return e+(a/=i)*n}this.zoomTo=function(e,i,n,r,s,o,l,c){i=(i+180)%360-180;let h=a.orbitControl.getAzimuthalAngle()/Math.PI*180;i-h>180&&(i-=360),i-h<-180&&(i+=360),a.targetPos=e,a.targetAzimuth=i,a.targetInclination=n,a.durationTime=s,a.enablePan=o,a.targetDistance=r;var u=a.orbitControl.object.position.clone().divideScalar(-1),d=a.orbitControl.target.clone().add(u).length(),p=180*a.orbitControl.getAzimuthalAngle()/Math.PI,m=180*a.orbitControl.getPolarAngle()/Math.PI;if(a.startDistance=d,a.currentTime=0,a.startPos=a.orbitControl.target.clone(),a.startInclination=m-90,a.startAzimuth=p,t=!0,this.callback){const e=this.callback;this.callback=l,void 0===c&&(c=!0),e({isInterrupt:c})}else this.callback=l},this.update=function(e){if(t){if(a.durationTime-a.currentTime>1e-6){var i=r(a.startPos.x,a.targetPos.x,a.durationTime,a.currentTime),n=r(a.startPos.y,a.targetPos.y,a.durationTime,a.currentTime),s=r(a.startPos.z,a.targetPos.z,a.durationTime,a.currentTime);a.target=new Ce(i,n,s),a.inclination=r(a.startInclination,a.targetInclination,a.durationTime,a.currentTime),a.azimuth=r(a.startAzimuth,a.targetAzimuth,a.durationTime,a.currentTime),a.viewDistance=r(a.startDistance,a.targetDistance,a.durationTime,a.currentTime),a.currentTime+=e,o()}else if(t=!1,a.target=a.targetPos,a.inclination=a.targetInclination,a.azimuth=a.targetAzimuth,a.viewDistance=a.targetDistance,o(),this.callback){_y.markObjectsNeedsUpdate();const e=this.callback;this.callback=void 0,e()}function o(){var t=new Ce(0,0,a.viewDistance),i=new it;i.identity(),i.makeRotationX(a.inclination*Math.PI/180);var n=new it;n.identity(),n.makeRotationY(a.azimuth*Math.PI/180);var r=new it;r.identity(),r.makeRotationZ(0),n.multiply(i),n.multiply(r),t.applyMatrix4(n);var s=t.add(a.target);a.orbitControl.object.position.set(s.x,s.y,s.z),a.orbitControl.target.set(a.target.x,a.target.y,a.target.z),a.orbitControl.update(e)}}a.autoRotateEnable&&(a.azimuth+=a.autoRotateSpeed*e)},this.dispose=function(){},this.update()};(rw.prototype=Object.create(pe.prototype)).constructor=rw;var sw=function(e,t){void 0===t&&(logger.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),Et.call(this),this.visible=!1,this.domElement=t,this.scaleEqualProportion=!1;var i=new ow;this.add(i);var n=new lw;this.add(n);var a=this;G("camera",e),G("object",void 0),G("enabled",!0),G("axis",null),G("mode","translate"),G("translationSnap",null),G("rotationSnap",null),G("scaleSnap",null),G("space","world"),G("size",1),G("dragging",!1),G("showX",!0),G("showY",!0),G("showZ",!0),G("showE",!0);var r={type:"change"},s={type:"mouseDown"},o={type:"mouseUp",mode:a.mode},l={type:"objectChange"},c={type:"translate"},h={type:"rotate"},u={type:"scale"},d=new Vc;function p(e,t,i){for(var n=t.intersectObject(e,!0),a=0;a<n.length;a++)if(n[a].object.visible||i)return n[a];return!1}var m=new Ce,f=new Ce,g=new Ee,y={X:new Ce(1,0,0),Y:new Ce(0,1,0),Z:new Ce(0,0,1)},v=new Ce,b=new Ce,_=new Ce,x=new Ce,w=new Ce,S=new Ce,M=0,T=new Ce,A=new Ee,E=new Ce,C=new Ce,I=new Ee,P=new Ee,R=new Ce,O=new Ce,D=new Ee,L=new Ce,k=new Ce,N=new Ee,B=new Ee,z=new Ce,U=new Ce,F=new Ce,j=new Ee,H=new Ce;function G(e,t){var s=t;Object.defineProperty(a,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,n[e]=t,i[e]=t,a.dispatchEvent({type:e+"-changed",value:t}),a.dispatchEvent(r))}}),a[e]=t,n[e]=t,i[e]=t}function V(e){if(a.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};var i=e.changedTouches?e.changedTouches[0]:e,n=t.getBoundingClientRect();return{x:(i.clientX-n.left)/n.width*2-1,y:-(i.clientY-n.top)/n.height*2+1,button:e.button}}function W(e){if(a.enabled)switch(e.pointerType){case"mouse":case"pen":a.pointerHover(V(e))}}function Y(e){a.enabled&&(a.domElement.style.touchAction="none",a.domElement.ownerDocument.addEventListener("pointermove",X),a.pointerHover(V(e)),a.pointerDown(V(e)))}function X(e){a.enabled&&a.pointerMove(V(e))}function Z(e){a.enabled&&(a.domElement.style.touchAction="",a.domElement.ownerDocument.removeEventListener("pointermove",X),a.pointerUp(V(e)))}G("worldPosition",k),G("worldPositionStart",O),G("worldQuaternion",N),G("worldQuaternionStart",D),G("cameraPosition",T),G("cameraQuaternion",A),G("pointStart",v),G("pointEnd",b),G("rotationAxis",x),G("rotationAngle",M),G("eye",U),t.addEventListener("pointerdown",Y),t.addEventListener("pointermove",W),a.domElement.ownerDocument.addEventListener("pointerup",Z),this.dispose=function(){t.removeEventListener("pointerdown",Y),t.removeEventListener("pointermove",W),a.domElement.ownerDocument.removeEventListener("pointermove",X),a.domElement.ownerDocument.removeEventListener("pointerup",Z),this.traverse((function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}))},this.attach=function(e){return this.object=e,this.visible=!0,this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,this},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?logger.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(C,I,R),this.object.matrixWorld.decompose(k,N,z),P.copy(I).invert(),B.copy(N).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(T,A,E),U.copy(T).sub(k).normalize(),Et.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging){d.setFromCamera(e,this.camera);var t=p(i.picker[this.mode],d);this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&0===e.button&&null!==this.axis){d.setFromCamera(e,this.camera);var t=p(n,d,!0);if(t){var i=this.space;if("scale"===this.mode?i="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(i="world"),"local"===i&&"rotate"===this.mode){var a=this.rotationSnap;"X"===this.axis&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),"Y"===this.axis&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),"Z"===this.axis&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld();let e=this.object.position,n=this.object.quaternion,r=this.object.scale;if(this.object.matrixWorld.decompose(O,D,L),F.copy(e),j.copy(n),H.copy(r),this.object instanceof Mb){let{key:e}=this.object.userData,t=this.object.instanced.getTransform(e),i=new Ee;i.setFromEuler(t.rotation),F.copy(t.position),j.copy(i),H.copy(t.scale),O=t.position.clone(),D=i.clone(),L=t.scale.clone()}v.copy(t.point).sub(O)}this.dragging=!0,this.rotationAngle=0,s.mode=this.mode,this.dispatchEvent(s)}},this.pointerMove=function(e){var t=this.axis,i=this.mode,s=this.object,o=this.space;if("scale"===i?o="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(o="world"),void 0!==s&&null!==t&&!1!==this.dragging&&-1===e.button){d.setFromCamera(e,this.camera);var T=p(n,d,!0);if(T){if(b.copy(T.point).sub(O),"translate"===i){if(_.copy(b).sub(v),"local"===o&&"XYZ"!==t&&_.applyQuaternion(B),-1===t.indexOf("X")&&(_.x=0),-1===t.indexOf("Y")&&(_.y=0),-1===t.indexOf("Z")&&(_.z=0),"local"===o&&"XYZ"!==t?_.applyQuaternion(j).divide(R):_.applyQuaternion(P).divide(R),s.position.copy(_).add(F),"PaintGroup"===s.type){let e=Ep.defaultObjectTree.getItemByName(s.name);e&&"PaintItem"===e.type&&(e.transform.position=s.position.clone())}if(this.translationSnap&&("local"===o&&(s.position.applyQuaternion(g.copy(j).invert()),-1!==t.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(j)),"world"===o&&(s.parent&&s.position.add(m.setFromMatrixPosition(s.parent.matrixWorld)),-1!==t.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(m.setFromMatrixPosition(s.parent.matrixWorld)))),s instanceof Mb)s.setPosition(s.position);else if("IconGroup"===s.type&&s.parent&&"InstancedGroup"===s.parent.type){let e=Ep.defaultObjectTree.getItemByUUID(s.uuid);if(e&&"IconAsset"===e.type&&e.isInstancedItem){let t=JSON.parse(JSON.stringify(e.transform));t.position=JSON.parse(JSON.stringify(s.position)),e.setTransform(t)}}(s.name.includes("/iconmodellandmark")||s.name.includes("/iconmodeltrail"))&&Ep.instance.updateIconModelInterval(s.name),c.object=s,a.dispatchEvent(c)}else if("scale"===i){if(-1!==t.search("XYZ")||this.scaleEqualProportion){var A=b.length()/v.length();b.dot(v)<0&&(A*=-1),f.set(A,A,A)}else m.copy(v),f.copy(b),m.applyQuaternion(B),f.applyQuaternion(B),f.divide(m),-1===t.search("X")&&(f.x=1),-1===t.search("Y")&&(f.y=1),-1===t.search("Z")&&(f.z=1);let e=H.clone().multiply(f);if(this.scaleSnap&&(-1!==t.search("X")&&(e.x=Math.round(e.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(e.y=Math.round(e.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(e.z=Math.round(e.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap)),s instanceof Mb)s.setScale(e);else if("IconGroup"===s.type&&s.parent&&"InstancedGroup"===s.parent.type){let e=Ep.defaultObjectTree.getItemByUUID(s.uuid);if(e&&"IconAsset"===e.type&&e.isInstancedItem){let t=JSON.parse(JSON.stringify(e.transform));t.position=JSON.parse(JSON.stringify(s.position)),e.setTransform(t)}}else s.scale.copy(e);(s.name.includes("/iconmodellandmark")||s.name.includes("/iconmodeltrail"))&&Ep.instance.updateIconModelInterval(s.name),u.object=s,a.dispatchEvent(u)}else if("rotate"===i){_.copy(b).sub(v);var E=20/k.distanceTo(m.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(x.copy(U),M=b.angleTo(v),w.copy(v).normalize(),S.copy(b).normalize(),M*=S.cross(w).dot(U)<0?1:-1):"XYZE"===t?(x.copy(_).cross(U).normalize(),M=_.dot(m.copy(x).cross(this.eye))*E):"X"!==t&&"Y"!==t&&"Z"!==t||(x.copy(y[t]),m.copy(y[t]),"local"===o&&m.applyQuaternion(N),M=_.dot(m.cross(U).normalize())*E),this.rotationSnap&&(M=Math.round(M/this.rotationSnap)*this.rotationSnap),this.rotationAngleDelta=M-this.rotationAngle,this.rotationAngle=M;let e=new Ee;"local"===o&&"E"!==t&&"XYZE"!==t?e.copy(j).multiply(g.setFromAxisAngle(x,M)).normalize():(x.applyQuaternion(P),e.copy(g.setFromAxisAngle(x,M)).multiply(j).normalize()),s instanceof Mb?s.setQuaternion(e):s.quaternion.copy(e),h.object=s,a.dispatchEvent(h)}this.dispatchEvent(r),this.dispatchEvent(l)}}},this.pointerUp=function(e){0===e.button&&(this.dragging&&null!==this.axis&&(o.mode=this.mode,this.dispatchEvent(o)),this.dragging=!1,this.axis=null)},this.getMode=function(){return a.mode},this.setMode=function(e){a.mode=e},this.setTranslationSnap=function(e){a.translationSnap=e},this.setRotationSnap=function(e){a.rotationSnap=e},this.setScaleSnap=function(e){a.scaleSnap=e},this.setSize=function(e){a.size=e},this.setSpace=function(e){a.space=e},this.update=function(){logger.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};sw.prototype=Object.assign(Object.create(Et.prototype),{constructor:sw,isTransformControls:!0});var ow=function(){Et.call(this),this.type="TransformControlsGizmo";var e=new Kt({depthTest:!1,depthWrite:!1,transparent:!0,side:2,fog:!1,toneMapped:!1}),t=new Kr({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;var n=e.clone();n.opacity=.33;var a=e.clone();a.color.set(16711680);var r=e.clone();r.color.set(65280);var s=e.clone();s.color.set(255);var o=e.clone();o.opacity=.25;var l=o.clone();l.color.set(16776960);var c=o.clone();c.color.set(65535);var h=o.clone();h.color.set(16711935),e.clone().color.set(16776960);var u=t.clone();u.color.set(16711680);var d=t.clone();d.color.set(65280);var p=t.clone();p.color.set(255);var m=t.clone();m.color.set(65535);var f=t.clone();f.color.set(16711935);var g=t.clone();g.color.set(16776960);var y=t.clone();y.color.set(7895160);var v=g.clone();v.opacity=.25;var b=new xs(0,.05,.2,12,1,!1),_=new Hi(.125,.125,.125),x=new wi;x.setAttribute("position",new hi([0,0,0,1,0,0],3));var w=function(e,t){for(var i=new wi,n=[],a=0;a<=64*t;++a)n.push(0,Math.cos(a/32*Math.PI)*e,Math.sin(a/32*Math.PI)*e);return i.setAttribute("position",new hi(n,3)),i},S={X:[[new Fi(b,a),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Fi(b,a),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new as(x,u)]],Y:[[new Fi(b,r),[0,1,0],null,null,"fwd"],[new Fi(b,r),[0,1,0],[Math.PI,0,0],null,"bwd"],[new as(x,d),null,[0,0,Math.PI/2]]],Z:[[new Fi(b,s),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Fi(b,s),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new as(x,p),null,[0,-Math.PI/2,0]]],XYZ:[[new Fi(new lo(.1,0),o.clone()),[0,0,0],[0,0,0]]],XY:[[new Fi(new sn(.295,.295),l.clone()),[.15,.15,0]],[new as(x,g),[.18,.3,0],null,[.125,1,1]],[new as(x,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Fi(new sn(.295,.295),c.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new as(x,m),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new as(x,m),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Fi(new sn(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new as(x,f),[.18,0,.3],null,[.125,1,1]],[new as(x,f),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},M={X:[[new Fi(new xs(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Fi(new xs(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new Fi(new xs(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Fi(new lo(.2,0),i)]],XY:[[new Fi(new sn(.4,.4),i),[.2,.2,0]]],YZ:[[new Fi(new sn(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Fi(new sn(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},T={START:[[new Fi(new lo(.01,2),n),null,null,null,"helper"]],END:[[new Fi(new lo(.01,2),n),null,null,null,"helper"]],DELTA:[[new as(function(){var e=new wi;return e.setAttribute("position",new hi([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new as(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new as(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new as(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},A={X:[[new as(w(1,.5),u)],[new Fi(new lo(.04,0),a),[0,0,.99],null,[1,3,1]]],Y:[[new as(w(1,.5),d),null,[0,0,-Math.PI/2]],[new Fi(new lo(.04,0),r),[0,0,.99],null,[3,1,1]]],Z:[[new as(w(1,.5),p),null,[0,Math.PI/2,0]],[new Fi(new lo(.04,0),s),[.99,0,0],null,[1,3,1]]],E:[[new as(w(1.25,1),v),null,[0,Math.PI/2,0]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new as(w(1,1),y),null,[0,Math.PI/2,0]]]},E={AXIS:[[new as(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},C={X:[[new Fi(new go(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Fi(new go(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Fi(new go(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Fi(new go(1.25,.1,2,24),i)]],XYZE:[[new Fi(new po(.7,10,8),i)]]},I={X:[[new Fi(_,a),[.8,0,0],[0,0,-Math.PI/2]],[new as(x,u),null,null,[.8,1,1]]],Y:[[new Fi(_,r),[0,.8,0]],[new as(x,d),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Fi(_,s),[0,0,.8],[Math.PI/2,0,0]],[new as(x,p),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Fi(_,l),[.85,.85,0],null,[2,2,.2]],[new as(x,g),[.855,.98,0],null,[.125,1,1]],[new as(x,g),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Fi(_,c),[0,.85,.85],null,[.2,2,2]],[new as(x,m),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new as(x,m),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Fi(_,h),[.85,0,.85],null,[2,.2,2]],[new as(x,f),[.855,0,.98],null,[.125,1,1]],[new as(x,f),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Fi(new Hi(.125,.125,.125),o.clone()),[1.1,0,0]]],XYZY:[[new Fi(new Hi(.125,.125,.125),o.clone()),[0,1.1,0]]],XYZZ:[[new Fi(new Hi(.125,.125,.125),o.clone()),[0,0,1.1]]]},P={X:[[new Fi(new xs(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Fi(new xs(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new Fi(new xs(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Fi(_,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Fi(_,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Fi(_,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Fi(new Hi(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new Fi(new Hi(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new Fi(new Hi(.2,.2,.2),i),[0,0,1.1]]]},R={X:[[new as(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new as(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new as(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},O=function(e){var t=new Et;for(var i in e)for(var n=e[i].length;n--;){var a=e[i][n][0].clone(),r=e[i][n][1],s=e[i][n][2],o=e[i][n][3],l=e[i][n][4];a.name=i,a.tag=l,r&&a.position.set(r[0],r[1],r[2]),s&&a.rotation.set(s[0],s[1],s[2]),o&&a.scale.set(o[0],o[1],o[2]),a.updateMatrix();var c=a.geometry.clone();c.applyMatrix4(a.matrix),a.geometry=c,a.renderOrder=1/0,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),t.add(a)}return t},D=new Ce(0,0,0),L=new dt,k=new Ce(0,1,0),N=new Ce(0,0,0),B=new it,z=new Ee,U=new Ee,F=new Ee,j=new Ce(1,0,0),H=new Ce(0,1,0),G=new Ce(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=O(S)),this.add(this.gizmo.rotate=O(A)),this.add(this.gizmo.scale=O(I)),this.add(this.picker.translate=O(M)),this.add(this.picker.rotate=O(C)),this.add(this.picker.scale=O(P)),this.add(this.helper.translate=O(T)),this.add(this.helper.rotate=O(E)),this.add(this.helper.scale=O(R)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){this.space;var e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:F;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var t=[];t=(t=(t=t.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var i=0;i<t.length;i++){var n,a=t[i];if(a.visible=!0,a.rotation.set(0,0,0),a.position.copy(this.worldPosition),n=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),a.scale.set(1,1,1).multiplyScalar(n*this.size/7),"helper"!==a.tag){if(a.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){var r=.99;"X"!==a.name&&"XYZX"!==a.name||Math.abs(k.copy(j).applyQuaternion(e).dot(this.eye))>r&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"Y"!==a.name&&"XYZY"!==a.name||Math.abs(k.copy(H).applyQuaternion(e).dot(this.eye))>r&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"Z"!==a.name&&"XYZZ"!==a.name||Math.abs(k.copy(G).applyQuaternion(e).dot(this.eye))>r&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"XY"===a.name&&Math.abs(k.copy(G).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"YZ"===a.name&&Math.abs(k.copy(j).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"XZ"===a.name&&Math.abs(k.copy(H).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),-1!==a.name.search("X")&&(k.copy(j).applyQuaternion(e).dot(this.eye)<0?"fwd"===a.tag?a.visible=!1:a.scale.x*=-1:"bwd"===a.tag&&(a.visible=!1)),-1!==a.name.search("Y")&&(k.copy(H).applyQuaternion(e).dot(this.eye)<0?"fwd"===a.tag?a.visible=!1:a.scale.y*=-1:"bwd"===a.tag&&(a.visible=!1)),-1!==a.name.search("Z")&&(k.copy(G).applyQuaternion(e).dot(this.eye)<0?"fwd"===a.tag?a.visible=!1:a.scale.z*=-1:"bwd"===a.tag&&(a.visible=!1))}else"rotate"===this.mode&&(U.copy(e),k.copy(this.eye).applyQuaternion(z.copy(e).invert()),-1!==a.name.search("E")&&a.quaternion.setFromRotationMatrix(B.lookAt(this.eye,N,H)),"X"===a.name&&(z.setFromAxisAngle(j,Math.atan2(-k.y,k.z)),z.multiplyQuaternions(U,z),a.quaternion.copy(z)),"Y"===a.name&&(z.setFromAxisAngle(H,Math.atan2(k.x,k.z)),z.multiplyQuaternions(U,z),a.quaternion.copy(z)),"Z"===a.name&&(z.setFromAxisAngle(G,Math.atan2(k.y,k.x)),z.multiplyQuaternions(U,z),a.quaternion.copy(z)));a.visible=a.visible&&(-1===a.name.indexOf("X")||this.showX),a.visible=a.visible&&(-1===a.name.indexOf("Y")||this.showY),a.visible=a.visible&&(-1===a.name.indexOf("Z")||this.showZ),a.visible=a.visible&&(-1===a.name.indexOf("E")||this.showE),a.material.color&&(a.material._opacity=a.material._opacity||a.material.opacity,a.material._color=a.material._color||a.material.color.clone(),a.material.color.copy(a.material._color),a.material.opacity=a.material._opacity,this.enabled?this.axis&&(a.name===this.axis||this.axis.split("").some((function(e){return a.name===e}))?(a.material.opacity=1,a.material.color.lerp(new Qt(1,1,1),.5)):(a.material.opacity*=.25,a.material.color.lerp(new Qt(1,1,1),.5))):(a.material.opacity*=.5,a.material.color.lerp(new Qt(1,1,1),.5)))}else a.visible=!1,"AXIS"===a.name?(a.position.copy(this.worldPositionStart),a.visible=!!this.axis,"X"===this.axis&&(z.setFromEuler(L.set(0,0,0)),a.quaternion.copy(e).multiply(z),Math.abs(k.copy(j).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"Y"===this.axis&&(z.setFromEuler(L.set(0,0,Math.PI/2)),a.quaternion.copy(e).multiply(z),Math.abs(k.copy(H).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"Z"===this.axis&&(z.setFromEuler(L.set(0,Math.PI/2,0)),a.quaternion.copy(e).multiply(z),Math.abs(k.copy(G).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"XYZE"===this.axis&&(z.setFromEuler(L.set(0,Math.PI/2,0)),k.copy(this.rotationAxis),a.quaternion.setFromRotationMatrix(B.lookAt(N,k,H)),a.quaternion.multiply(z),a.visible=this.dragging),"E"===this.axis&&(a.visible=!1)):"START"===a.name?(a.position.copy(this.worldPositionStart),a.visible=this.dragging):"END"===a.name?(a.position.copy(this.worldPosition),a.visible=this.dragging):"DELTA"===a.name?(a.position.copy(this.worldPositionStart),a.quaternion.copy(this.worldQuaternionStart),D.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),D.applyQuaternion(this.worldQuaternionStart.clone().invert()),a.scale.copy(D),a.visible=this.dragging):(a.quaternion.copy(e),this.dragging?a.position.copy(this.worldPositionStart):a.position.copy(this.worldPosition),this.axis&&(a.visible=-1!==this.axis.search(a.name)))}Et.prototype.updateMatrixWorld.call(this)}};ow.prototype=Object.assign(Object.create(Et.prototype),{constructor:ow,isTransformControlsGizmo:!0});var lw=function(){Fi.call(this,new sn(1e5,1e5,2,2),new Kt({visible:!1,wireframe:!0,side:2,transparent:!0,opacity:.1,toneMapped:!1})),this.type="TransformControlsPlane";var e=new Ce(1,0,0),t=new Ce(0,1,0),i=new Ce(0,0,1),n=new Ce,a=new Ce,r=new Ce,s=new it,o=new Ee;this.updateMatrixWorld=function(){var l=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(l="local"),e.set(1,0,0).applyQuaternion("local"===l?this.worldQuaternion:o),t.set(0,1,0).applyQuaternion("local"===l?this.worldQuaternion:o),i.set(0,0,1).applyQuaternion("local"===l?this.worldQuaternion:o),r.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":r.copy(this.eye).cross(e),a.copy(e).cross(r);break;case"Y":r.copy(this.eye).cross(t),a.copy(t).cross(r);break;case"Z":r.copy(this.eye).cross(i),a.copy(i).cross(r);break;case"XY":a.copy(i);break;case"YZ":a.copy(e);break;case"XZ":r.copy(i),a.copy(t);break;case"XYZ":case"E":a.set(0,0,0)}break;case"rotate":default:a.set(0,0,0)}0===a.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(n.set(0,0,0),a,r),this.quaternion.setFromRotationMatrix(s)),Et.prototype.updateMatrixWorld.call(this)}};lw.prototype=Object.assign(Object.create(Fi.prototype),{constructor:lw,isTransformControlsPlane:!0});var cw=function(e,t){void 0===t&&(logger.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),Et.call(this),this.visible=!1,this.domElement=t,this.scaleEqualProportion=!1;var i=new hw;this.add(i);var n=new uw;this.add(n);var a=this;G("camera",e),G("object",void 0),G("enabled",!0),G("axis",null),G("mode","translate"),G("translationSnap",null),G("rotationSnap",null),G("scaleSnap",null),G("space","world"),G("size",1),G("dragging",!1),G("showX",!0),G("showY",!0),G("showZ",!0),G("showE",!0);var r={type:"change"},s={type:"mouseDown"},o={type:"mouseUp",mode:a.mode},l={type:"objectChange"},c={type:"translate"},h={type:"rotate"},u={type:"scale"},d=new Vc;function p(e,t,i){for(var n=t.intersectObject(e,!0),a=0;a<n.length;a++)if(n[a].object.visible||i)return n[a];return!1}var m=new Ce,f=new Ce,g=new Ee,y={X:new Ce(1,0,0),Y:new Ce(0,1,0),Z:new Ce(0,0,1)},v=new Ce,b=new Ce,_=new Ce,x=new Ce,w=new Ce,S=new Ce,M=0,T=new Ce,A=new Ee,E=new Ce,C=new Ce,I=new Ee,P=new Ee,R=new Ce,O=new Ce,D=new Ee,L=new Ce,k=new Ce,N=new Ee,B=new Ee,z=new Ce,U=new Ce,F=new Ce,j=new Ee,H=new Ce;function G(e,t){var s=t;Object.defineProperty(a,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,n[e]=t,i[e]=t,a.dispatchEvent({type:e+"-changed",value:t}),a.dispatchEvent(r))}}),a[e]=t,n[e]=t,i[e]=t}function V(e){if(a.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};var i=e.changedTouches?e.changedTouches[0]:e,n=t.getBoundingClientRect();return{x:(i.clientX-n.left)/n.width*2-1,y:-(i.clientY-n.top)/n.height*2+1,button:e.button}}function W(e){if(a.enabled)switch(e.pointerType){case"mouse":case"pen":a.pointerHover(V(e))}}function Y(e){a.enabled&&(a.domElement.style.touchAction="none",a.domElement.ownerDocument.addEventListener("pointermove",X),a.pointerHover(V(e)),a.pointerDown(V(e)))}function X(e){a.enabled&&a.pointerMove(V(e))}function Z(e){a.enabled&&(a.domElement.style.touchAction="",a.domElement.ownerDocument.removeEventListener("pointermove",X),a.pointerUp(V(e)))}G("worldPosition",k),G("worldPositionStart",O),G("worldQuaternion",N),G("worldQuaternionStart",D),G("cameraPosition",T),G("cameraQuaternion",A),G("pointStart",v),G("pointEnd",b),G("rotationAxis",x),G("rotationAngle",M),G("eye",U),t.addEventListener("pointerdown",Y),t.addEventListener("pointermove",W),a.domElement.ownerDocument.addEventListener("pointerup",Z),this.dispose=function(){t.removeEventListener("pointerdown",Y),t.removeEventListener("pointermove",W),a.domElement.ownerDocument.removeEventListener("pointermove",X),a.domElement.ownerDocument.removeEventListener("pointerup",Z),this.traverse((function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}))},this.attach=function(e){this.object=e,this.visible=!0;let t=Ep.instance.getItemByName(this.object.name);if(t){let e={position:{}};for(let i of t.children)i.axesTransform0&&i.axesTransform0.position&&i.axesTransform0.rotation&&i.axesTransform0.scale?(e.position.x=0===i.axesTransform0.position.x?0:-i.axesTransform0.position.x,e.position.y=0===i.axesTransform0.position.y?0:-i.axesTransform0.position.y,e.position.z=0===i.axesTransform0.position.z?0:-i.axesTransform0.position.z):(i.axesTransform0={position:new Ce,rotation:new dt,scale:new Ce},e.position.x=0,e.position.y=0,e.position.z=0);r.axesTransform=e,this.dispatchEvent(r)}return this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,this},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?logger.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(C,I,R),this.object.matrixWorld.decompose(k,N,z),P.copy(I).invert(),B.copy(N).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(T,A,E),U.copy(T).sub(k).normalize(),Et.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging){d.setFromCamera(e,this.camera);var t=p(i.picker[this.mode],d);this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&0===e.button&&null!==this.axis){this.dummy||(this.dummy=new sr,this.dummy.name="axesTransformDummy"),this.dummy.position.copy(this.object.position),this.dummy.rotation.copy(this.object.rotation),this.dummy.scale.copy(this.object.scale),this.dummy.parent&&this.dummy.parent.remove(this.dummy),this.object.parent&&this.object.parent.add(this.dummy),this.object0=this.object,this.object=this.dummy,d.setFromCamera(e,this.camera);var t=p(n,d,!0);if(t){var i=this.space;if("scale"===this.mode?i="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(i="world"),"local"===i&&"rotate"===this.mode){var a=this.rotationSnap;"X"===this.axis&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),"Y"===this.axis&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),"Z"===this.axis&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld();let e=this.object.position,n=this.object.quaternion,r=this.object.scale;if(this.object.matrixWorld.decompose(O,D,L),F.copy(e),j.copy(n),H.copy(r),this.object instanceof Mb){let{key:e}=this.object.userData,t=this.object.instanced.getTransform(e),i=new Ee;i.setFromEuler(t.rotation),F.copy(t.position),j.copy(i),H.copy(t.scale),O=t.position.clone(),D=i.clone(),L=t.scale.clone()}v.copy(t.point).sub(O)}this.dragging=!0,this.rotationAngle=0,s.mode=this.mode,this.dispatchEvent(s)}},this.pointerMove=function(e){var t=this.axis,i=this.mode,s=this.object,o=this.space;if("scale"===i?o="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(o="world"),void 0!==s&&null!==t&&!1!==this.dragging&&-1===e.button){d.setFromCamera(e,this.camera);var T=p(n,d,!0);if(T){if(b.copy(T.point).sub(O),"translate"===i){if(_.copy(b).sub(v),"local"===o&&"XYZ"!==t&&_.applyQuaternion(B),-1===t.indexOf("X")&&(_.x=0),-1===t.indexOf("Y")&&(_.y=0),-1===t.indexOf("Z")&&(_.z=0),"local"===o&&"XYZ"!==t?_.applyQuaternion(j).divide(R):_.applyQuaternion(P).divide(R),s.position.copy(_).add(F),"PaintGroup"===s.type){let e=Ep.defaultObjectTree.getItemByName(s.name);e&&"PaintItem"===e.type&&(e.transform.position=s.position.clone())}if(this.translationSnap&&("local"===o&&(s.position.applyQuaternion(g.copy(j).invert()),-1!==t.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(j)),"world"===o&&(s.parent&&s.position.add(m.setFromMatrixPosition(s.parent.matrixWorld)),-1!==t.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(m.setFromMatrixPosition(s.parent.matrixWorld)))),s instanceof Mb)s.setPosition(s.position);else if("IconGroup"===s.type&&s.parent&&"InstancedGroup"===s.parent.type){let e=Ep.defaultObjectTree.getItemByUUID(s.uuid);if(e&&"IconAsset"===e.type&&e.isInstancedItem){let t=JSON.parse(JSON.stringify(e.transform));t.position=JSON.parse(JSON.stringify(s.position)),e.setTransform(t)}}c.object=s,a.dispatchEvent(c)}else if("scale"===i){if(-1!==t.search("XYZ")||this.scaleEqualProportion){var A=b.length()/v.length();b.dot(v)<0&&(A*=-1),f.set(A,A,A)}else m.copy(v),f.copy(b),m.applyQuaternion(B),f.applyQuaternion(B),f.divide(m),-1===t.search("X")&&(f.x=1),-1===t.search("Y")&&(f.y=1),-1===t.search("Z")&&(f.z=1);let e=H.clone().multiply(f);if(this.scaleSnap&&(-1!==t.search("X")&&(e.x=Math.round(e.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(e.y=Math.round(e.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(e.z=Math.round(e.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap)),s instanceof Mb)s.setScale(e);else if("IconGroup"===s.type&&s.parent&&"InstancedGroup"===s.parent.type){let e=Ep.defaultObjectTree.getItemByUUID(s.uuid);if(e&&"IconAsset"===e.type&&e.isInstancedItem){let t=JSON.parse(JSON.stringify(e.transform));t.position=JSON.parse(JSON.stringify(s.position)),e.setTransform(t)}}else s.scale.copy(e);u.object=s,a.dispatchEvent(u)}else if("rotate"===i){_.copy(b).sub(v);var E=20/k.distanceTo(m.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(x.copy(U),M=b.angleTo(v),w.copy(v).normalize(),S.copy(b).normalize(),M*=S.cross(w).dot(U)<0?1:-1):"XYZE"===t?(x.copy(_).cross(U).normalize(),M=_.dot(m.copy(x).cross(this.eye))*E):"X"!==t&&"Y"!==t&&"Z"!==t||(x.copy(y[t]),m.copy(y[t]),"local"===o&&m.applyQuaternion(N),M=_.dot(m.cross(U).normalize())*E),this.rotationSnap&&(M=Math.round(M/this.rotationSnap)*this.rotationSnap),this.rotationAngleDelta=M-this.rotationAngle,this.rotationAngle=M;let e=new Ee;"local"===o&&"E"!==t&&"XYZE"!==t?e.copy(j).multiply(g.setFromAxisAngle(x,M)).normalize():(x.applyQuaternion(P),e.copy(g.setFromAxisAngle(x,M)).multiply(j).normalize()),s instanceof Mb?s.setQuaternion(e):s.quaternion.copy(e),h.object=s,a.dispatchEvent(h)}if(this.dummy){let e=Ep.instance.getItemByName(this.object0.name),t={position:this.dummy.position.clone()};if(e)for(let i of e.children)if(i.axesTransform0){t.position.x-=this.object0.position.x+i.axesTransform0.position.x,t.position.y-=this.object0.position.y+i.axesTransform0.position.y,t.position.z-=this.object0.position.z+i.axesTransform0.position.z;break}r.axesTransform=t}this.dispatchEvent(r),this.dispatchEvent(l)}}},this.pointerUp=function(e){if(0===e.button){if(this.dragging&&null!==this.axis){if(this.dummy&&this.object0){const e=this.dummy.position.clone().sub(this.object0.position).multiplyScalar(-1);this.object0.position.copy(this.dummy.position),this.object0.rotation.copy(this.dummy.rotation),this.object0.scale.copy(this.dummy.scale);const t=new it;t.makeRotationFromEuler(this.object0.rotation);const i=new it;i.makeScale(this.object0.scale.x,this.object0.scale.y,this.object0.scale.z),t.multiply(i).invert(),e.applyMatrix4(t);let n=Ep.instance.getItemByName(this.object0.name);if(n)for(let t of n.children)"function"==typeof t.getNodeMesh&&(t.getNodeMesh().position.add(e),t.transformNode&&(t.transformNode.position.x+=e.x,t.transformNode.position.y+=e.y,t.transformNode.position.z+=e.z),t.axesTransform0&&(t.axesTransform0.position.x+=e.x,t.axesTransform0.position.y+=e.y,t.axesTransform0.position.z+=e.z));this.object=this.object0,delete this.dummy,delete this.object0}o.mode=this.mode,this.dispatchEvent(o)}this.dragging=!1,this.axis=null}},this.setXYZ=function({x:e=0,y:t=0,z:i=0}={}){if(this.object){if(this.dummy&&this.object0){const n=new Ce(e,t,i).sub(this.object0.position).multiplyScalar(-1);this.object0.position.set(e,t,i);const a=new it;a.makeRotationFromEuler(this.object0.rotation);const s=new it;s.makeScale(this.object0.scale.x,this.object0.scale.y,this.object0.scale.z),a.multiply(s).invert(),n.applyMatrix4(a);let o=Ep.instance.getItemByName(this.object0.name);if(o)for(let e of o.children)"function"==typeof e.getNodeMesh&&(e.getNodeMesh().position.add(n),e.transformNode&&(e.transformNode.position.x+=n.x,e.transformNode.position.y+=n.y,e.transformNode.position.z+=n.z),e.axesTransform0&&(e.axesTransform0.position.x+=n.x,e.axesTransform0.position.y+=n.y,e.axesTransform0.position.z+=n.z));this.object=this.object0,delete this.dummy,delete this.object0,this.dummy||(this.dummy=new sr,this.dummy.name="axesTransformDummy"),this.dummy.position.copy(this.object.position),this.dummy.rotation.copy(this.object.rotation),this.dummy.scale.copy(this.object.scale),this.dummy.parent&&this.dummy.parent.remove(this.dummy),this.object.parent&&this.object.parent.add(this.dummy),this.object0=this.object,this.object=this.dummy,r.axesTransform={position:this.dummy.position.clone(),rotation:this.dummy.rotation.clone(),scale:this.dummy.scale.clone()},this.dispatchEvent(r)}else{let n=Ep.instance.getItemByName(this.object.name),a=new Ce;if(n)for(let e of n.children)"function"==typeof e.getNodeMesh&&e.axesTransform0&&e.axesTransform0.position&&e.axesTransform0.rotation&&e.axesTransform0.scale&&(a.set(e.axesTransform0.position.x,e.axesTransform0.position.y,e.axesTransform0.position.z),e.getNodeMesh().position.sub(a),e.transformNode&&(e.transformNode.position.x-=a.x,e.transformNode.position.y-=a.y,e.transformNode.position.z-=a.z),e.axesTransform0.position.x=0,e.axesTransform0.position.y=0,e.axesTransform0.position.z=0);this.object.position.add(a),a=new Ce(e,t,i),this.object.position.add(a);const s=new it;s.makeRotationFromEuler(this.object.rotation);const o=new it;o.makeScale(this.object.scale.x,this.object.scale.y,this.object.scale.z),s.multiply(o).invert(),a.applyMatrix4(s);let l={position:{}};if(n){for(let r of n.children)"function"==typeof r.getNodeMesh&&(r.transformNode&&(r.transformNode.position.x-=e,r.transformNode.position.y-=t,r.transformNode.position.z-=i),r.axesTransform0&&(r.axesTransform0.position.x=-e,r.axesTransform0.position.y=-t,r.axesTransform0.position.z=-i,l.position.x=e,l.position.y=t,l.position.z=i),r.getNodeMesh().position.sub(a));r.axesTransform=l,this.dispatchEvent(r)}}o.mode=this.mode,this.dispatchEvent(o),this.dragging=!1,this.axis=null}},this.setCenter=()=>{this.align("center")},this.setBottom=()=>{this.align("bottom")},this.align=e=>{if("string"!=typeof e)return;if("top"!==e.toLowerCase()&&"center"!==e.toLowerCase()&&"bottom"!==e.toLowerCase())return;let t=new Re;t.setFromObject(this.object);let i=new Ce;t.getCenter(i),"top"===e.toLowerCase()&&(i.y=t.max.y),"bottom"===e.toLowerCase()&&(i.y=t.min.y);const n=i.clone().sub(this.object.position).multiplyScalar(-1);this.object.position.copy(i);const a=new it;a.makeRotationFromEuler(this.object.rotation);const s=new it;s.makeScale(this.object.scale.x,this.object.scale.y,this.object.scale.z),a.multiply(s).invert(),n.applyMatrix4(a);let o=Ep.instance.getItemByName(this.object.name),l={position:{}};if(o){for(let e of o.children)"function"==typeof e.getNodeMesh&&(e.getNodeMesh().position.add(n),e.transformNode&&(e.transformNode.position.x+=n.x,e.transformNode.position.y+=n.y,e.transformNode.position.z+=n.z),e.axesTransform0&&(e.axesTransform0.position.x+=n.x,e.axesTransform0.position.y+=n.y,e.axesTransform0.position.z+=n.z,l.position.x=0===e.axesTransform0.position.x?0:-e.axesTransform0.position.x,l.position.y=0===e.axesTransform0.position.y?0:-e.axesTransform0.position.y,l.position.z=0===e.axesTransform0.position.z?0:-e.axesTransform0.position.z));r.axesTransform=l,this.dispatchEvent(r)}},this.reset=()=>{let e=Ep.instance.getItemByName(this.object.name);if(e){let t={position:{}};const i=new Ce,n=new Ce;for(let a of e.children)if("function"==typeof a.getNodeMesh&&a.axesTransform0&&a.axesTransform0.position&&a.axesTransform0.rotation&&a.axesTransform0.scale){i.set(a.axesTransform0.position.x,a.axesTransform0.position.y,a.axesTransform0.position.z),n.copy(i);let r=e.getGroup();if(r){let e=new it,t=new it;e.makeRotationFromEuler(r.rotation),t.makeScale(r.scale.x,r.scale.y,r.scale.z),n.applyMatrix4(t).applyMatrix4(e)}a.getNodeMesh().position.sub(i),a.transformNode&&(a.transformNode.position.x-=i.x,a.transformNode.position.y-=i.y,a.transformNode.position.z-=i.z),a.axesTransform0.position.x=0,a.axesTransform0.position.y=0,a.axesTransform0.position.z=0,t.position.x=0,t.position.y=0,t.position.z=0}this.object.position.add(n),r.axesTransform=t,this.dispatchEvent(r)}},this.getMode=function(){return a.mode},this.setMode=function(e){a.mode=e},this.setTranslationSnap=function(e){a.translationSnap=e},this.setRotationSnap=function(e){a.rotationSnap=e},this.setScaleSnap=function(e){a.scaleSnap=e},this.setSize=function(e){a.size=e},this.setSpace=function(e){a.space=e},this.update=function(){logger.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};cw.prototype=Object.assign(Object.create(Et.prototype),{constructor:cw,isTransformControls:!0});var hw=function(){Et.call(this),this.type="TransformControlsGizmo";var e=new Kt({depthTest:!1,depthWrite:!1,transparent:!0,side:2,fog:!1,toneMapped:!1}),t=new Kr({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;var n=e.clone();n.opacity=.33;var a=e.clone();a.color.set(16711680);var r=e.clone();r.color.set(65280);var s=e.clone();s.color.set(255);var o=e.clone();o.opacity=.25;var l=o.clone();l.color.set(16776960);var c=o.clone();c.color.set(65535);var h=o.clone();h.color.set(16711935),e.clone().color.set(16776960);var u=t.clone();u.color.set(16711680);var d=t.clone();d.color.set(65280);var p=t.clone();p.color.set(255);var m=t.clone();m.color.set(65535);var f=t.clone();f.color.set(16711935);var g=t.clone();g.color.set(16776960);var y=t.clone();y.color.set(7895160);var v=g.clone();v.opacity=.25;var b=new xs(0,.05,.2,12,1,!1),_=new Hi(.125,.125,.125),x=new wi;x.setAttribute("position",new hi([0,0,0,1,0,0],3));const w=1.35,S=1.1,M=.35,T=0,A=.15,E=.07,C=[w,0,0,S,A,A,S,A,-A,w,0,0,S,-A,-A,S,-A,A,w,0,0,S,A,A,S,-A,A,w,0,0,S,A,-A,S,-A,-A,w,0,0,T,0,0,M,E,E,M,E,-E,T,0,0,M,-E,-E,M,-E,E,T,0,0,M,E,E,M,-E,E,T,0,0,M,E,-E,M,-E,-E,S,-E,-E,S,E,-E,S,E,E,S,-E,E,S,-E,-E,M,-E,-E,M,-E,E,S,-E,E,S,E,E,M,E,E,M,E,-E,S,E,-E];var I=new wi;I.setAttribute("position",new hi(C,3)),I=xb.mergeBufferGeometries([x,I]);var P=function(e,t){for(var i=new wi,n=[],a=0;a<=64*t;++a)n.push(0,Math.cos(a/32*Math.PI)*e,Math.sin(a/32*Math.PI)*e);return i.setAttribute("position",new hi(n,3)),i},R={X:[[new Fi(b,a),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Fi(b,a),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new as(I,u)]],Y:[[new Fi(b,r),[0,1,0],null,null,"fwd"],[new Fi(b,r),[0,1,0],[Math.PI,0,0],null,"bwd"],[new as(I,d),null,[0,0,Math.PI/2]]],Z:[[new Fi(b,s),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Fi(b,s),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new as(I,p),null,[0,-Math.PI/2,0]]],XYZ:[[new Fi(new lo(.1,0),o.clone()),[0,0,0],[0,0,0]]],XY:[[new Fi(new sn(.295,.295),l.clone()),[.15,.15,0]],[new as(x,g),[.18,.3,0],null,[.125,1,1]],[new as(x,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Fi(new sn(.295,.295),c.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new as(x,m),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new as(x,m),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Fi(new sn(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new as(x,f),[.18,0,.3],null,[.125,1,1]],[new as(x,f),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},O={X:[[new Fi(new xs(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Fi(new xs(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new Fi(new xs(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Fi(new lo(.2,0),i)]],XY:[[new Fi(new sn(.4,.4),i),[.2,.2,0]]],YZ:[[new Fi(new sn(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Fi(new sn(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},D={START:[[new Fi(new lo(.01,2),n),null,null,null,"helper"]],END:[[new Fi(new lo(.01,2),n),null,null,null,"helper"]],DELTA:[[new as(function(){var e=new wi;return e.setAttribute("position",new hi([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new as(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new as(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new as(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},L={X:[[new as(P(1,.5),u)],[new Fi(new lo(.04,0),a),[0,0,.99],null,[1,3,1]]],Y:[[new as(P(1,.5),d),null,[0,0,-Math.PI/2]],[new Fi(new lo(.04,0),r),[0,0,.99],null,[3,1,1]]],Z:[[new as(P(1,.5),p),null,[0,Math.PI/2,0]],[new Fi(new lo(.04,0),s),[.99,0,0],null,[1,3,1]]],E:[[new as(P(1.25,1),v),null,[0,Math.PI/2,0]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Fi(new xs(.03,0,.15,4,1,!1),v),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new as(P(1,1),y),null,[0,Math.PI/2,0]]]},k={AXIS:[[new as(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},N={X:[[new Fi(new go(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Fi(new go(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Fi(new go(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Fi(new go(1.25,.1,2,24),i)]],XYZE:[[new Fi(new po(.7,10,8),i)]]},B={X:[[new Fi(_,a),[.8,0,0],[0,0,-Math.PI/2]],[new as(x,u),null,null,[.8,1,1]]],Y:[[new Fi(_,r),[0,.8,0]],[new as(x,d),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Fi(_,s),[0,0,.8],[Math.PI/2,0,0]],[new as(x,p),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Fi(_,l),[.85,.85,0],null,[2,2,.2]],[new as(x,g),[.855,.98,0],null,[.125,1,1]],[new as(x,g),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Fi(_,c),[0,.85,.85],null,[.2,2,2]],[new as(x,m),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new as(x,m),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Fi(_,h),[.85,0,.85],null,[2,.2,2]],[new as(x,f),[.855,0,.98],null,[.125,1,1]],[new as(x,f),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Fi(new Hi(.125,.125,.125),o.clone()),[1.1,0,0]]],XYZY:[[new Fi(new Hi(.125,.125,.125),o.clone()),[0,1.1,0]]],XYZZ:[[new Fi(new Hi(.125,.125,.125),o.clone()),[0,0,1.1]]]},z={X:[[new Fi(new xs(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Fi(new xs(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new Fi(new xs(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Fi(_,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Fi(_,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Fi(_,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Fi(new Hi(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new Fi(new Hi(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new Fi(new Hi(.2,.2,.2),i),[0,0,1.1]]]},U={X:[[new as(x,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new as(x,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new as(x,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},F=function(e){var t=new Et;for(var i in e)for(var n=e[i].length;n--;){var a=e[i][n][0].clone(),r=e[i][n][1],s=e[i][n][2],o=e[i][n][3],l=e[i][n][4];a.name=i,a.tag=l,r&&a.position.set(r[0],r[1],r[2]),s&&a.rotation.set(s[0],s[1],s[2]),o&&a.scale.set(o[0],o[1],o[2]),a.updateMatrix();var c=a.geometry.clone();c.applyMatrix4(a.matrix),a.geometry=c,a.renderOrder=1/0,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),t.add(a)}return t},j=new Ce(0,0,0),H=new dt,G=new Ce(0,1,0),V=new Ce(0,0,0),W=new it,Y=new Ee,X=new Ee,Z=new Ee,q=new Ce(1,0,0),J=new Ce(0,1,0),Q=new Ce(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=F(R)),this.add(this.gizmo.rotate=F(L)),this.add(this.gizmo.scale=F(B)),this.add(this.picker.translate=F(O)),this.add(this.picker.rotate=F(N)),this.add(this.picker.scale=F(z)),this.add(this.helper.translate=F(D)),this.add(this.helper.rotate=F(k)),this.add(this.helper.scale=F(U)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){this.space;var e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:Z;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var t=[];t=(t=(t=t.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var i=0;i<t.length;i++){var n,a=t[i];if(a.visible=!0,a.rotation.set(0,0,0),a.position.copy(this.worldPosition),n=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),a.scale.set(1,1,1).multiplyScalar(n*this.size/7),"helper"!==a.tag){if(a.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){var r=.99;"X"!==a.name&&"XYZX"!==a.name||Math.abs(G.copy(q).applyQuaternion(e).dot(this.eye))>r&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"Y"!==a.name&&"XYZY"!==a.name||Math.abs(G.copy(J).applyQuaternion(e).dot(this.eye))>r&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"Z"!==a.name&&"XYZZ"!==a.name||Math.abs(G.copy(Q).applyQuaternion(e).dot(this.eye))>r&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"XY"===a.name&&Math.abs(G.copy(Q).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"YZ"===a.name&&Math.abs(G.copy(q).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"XZ"===a.name&&Math.abs(G.copy(J).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),-1!==a.name.search("X")&&(G.copy(q).applyQuaternion(e).dot(this.eye)<0?"fwd"===a.tag?a.visible=!1:a.scale.x*=-1:"bwd"===a.tag&&(a.visible=!1)),-1!==a.name.search("Y")&&(G.copy(J).applyQuaternion(e).dot(this.eye)<0?"fwd"===a.tag?a.visible=!1:a.scale.y*=-1:"bwd"===a.tag&&(a.visible=!1)),-1!==a.name.search("Z")&&(G.copy(Q).applyQuaternion(e).dot(this.eye)<0?"fwd"===a.tag?a.visible=!1:a.scale.z*=-1:"bwd"===a.tag&&(a.visible=!1))}else"rotate"===this.mode&&(X.copy(e),G.copy(this.eye).applyQuaternion(Y.copy(e).invert()),-1!==a.name.search("E")&&a.quaternion.setFromRotationMatrix(W.lookAt(this.eye,V,J)),"X"===a.name&&(Y.setFromAxisAngle(q,Math.atan2(-G.y,G.z)),Y.multiplyQuaternions(X,Y),a.quaternion.copy(Y)),"Y"===a.name&&(Y.setFromAxisAngle(J,Math.atan2(G.x,G.z)),Y.multiplyQuaternions(X,Y),a.quaternion.copy(Y)),"Z"===a.name&&(Y.setFromAxisAngle(Q,Math.atan2(G.y,G.x)),Y.multiplyQuaternions(X,Y),a.quaternion.copy(Y)));a.visible=a.visible&&(-1===a.name.indexOf("X")||this.showX),a.visible=a.visible&&(-1===a.name.indexOf("Y")||this.showY),a.visible=a.visible&&(-1===a.name.indexOf("Z")||this.showZ),a.visible=a.visible&&(-1===a.name.indexOf("E")||this.showE),a.material.color&&(a.material._opacity=a.material._opacity||a.material.opacity,a.material._color=a.material._color||a.material.color.clone(),a.material.color.copy(a.material._color),a.material.opacity=a.material._opacity,this.enabled?this.axis&&(a.name===this.axis||this.axis.split("").some((function(e){return a.name===e}))?(a.material.opacity=1,a.material.color.lerp(new Qt(1,1,1),.5)):(a.material.opacity*=.25,a.material.color.lerp(new Qt(1,1,1),.5))):(a.material.opacity*=.5,a.material.color.lerp(new Qt(1,1,1),.5)))}else a.visible=!1,"AXIS"===a.name?(a.position.copy(this.worldPositionStart),a.visible=!!this.axis,"X"===this.axis&&(Y.setFromEuler(H.set(0,0,0)),a.quaternion.copy(e).multiply(Y),Math.abs(G.copy(q).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"Y"===this.axis&&(Y.setFromEuler(H.set(0,0,Math.PI/2)),a.quaternion.copy(e).multiply(Y),Math.abs(G.copy(J).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"Z"===this.axis&&(Y.setFromEuler(H.set(0,Math.PI/2,0)),a.quaternion.copy(e).multiply(Y),Math.abs(G.copy(Q).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"XYZE"===this.axis&&(Y.setFromEuler(H.set(0,Math.PI/2,0)),G.copy(this.rotationAxis),a.quaternion.setFromRotationMatrix(W.lookAt(V,G,J)),a.quaternion.multiply(Y),a.visible=this.dragging),"E"===this.axis&&(a.visible=!1)):"START"===a.name?(a.position.copy(this.worldPositionStart),a.visible=this.dragging):"END"===a.name?(a.position.copy(this.worldPosition),a.visible=this.dragging):"DELTA"===a.name?(a.position.copy(this.worldPositionStart),a.quaternion.copy(this.worldQuaternionStart),j.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),j.applyQuaternion(this.worldQuaternionStart.clone().invert()),a.scale.copy(j),a.visible=this.dragging):(a.quaternion.copy(e),this.dragging?a.position.copy(this.worldPositionStart):a.position.copy(this.worldPosition),this.axis&&(a.visible=-1!==this.axis.search(a.name)))}Et.prototype.updateMatrixWorld.call(this)}};hw.prototype=Object.assign(Object.create(Et.prototype),{constructor:hw,isTransformControlsGizmo:!0});var uw=function(){Fi.call(this,new sn(1e5,1e5,2,2),new Kt({visible:!1,wireframe:!0,side:2,transparent:!0,opacity:.1,toneMapped:!1})),this.type="TransformControlsPlane";var e=new Ce(1,0,0),t=new Ce(0,1,0),i=new Ce(0,0,1),n=new Ce,a=new Ce,r=new Ce,s=new it,o=new Ee;this.updateMatrixWorld=function(){var l=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(l="local"),e.set(1,0,0).applyQuaternion("local"===l?this.worldQuaternion:o),t.set(0,1,0).applyQuaternion("local"===l?this.worldQuaternion:o),i.set(0,0,1).applyQuaternion("local"===l?this.worldQuaternion:o),r.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":r.copy(this.eye).cross(e),a.copy(e).cross(r);break;case"Y":r.copy(this.eye).cross(t),a.copy(t).cross(r);break;case"Z":r.copy(this.eye).cross(i),a.copy(i).cross(r);break;case"XY":a.copy(i);break;case"YZ":a.copy(e);break;case"XZ":r.copy(i),a.copy(t);break;case"XYZ":case"E":a.set(0,0,0)}break;case"rotate":default:a.set(0,0,0)}0===a.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(n.set(0,0,0),a,r),this.quaternion.setFromRotationMatrix(s)),Et.prototype.updateMatrixWorld.call(this)}};function dw(){const{instance:e,orbitControls:t,renderer:i,objectStore:n,scene:a,defaultObjectTree:r}=Ep,s=new Ht,o=new Ht,l=new Re,c="__SELECT_DIV_ID__",h={callback:void 0},u=new nn,d={},p=new ye;function m(e){t.enabled=!1,h.callback=e,i.domElement.addEventListener("pointerdown",f),i.domElement.addEventListener("pointerup",g)}function f(e){i.domElement===e.target&&(e.preventDefault&&e.preventDefault(),0===e.button&&(p.x=e.offsetX,p.y=e.offsetY,i.domElement.addEventListener("pointermove",y)))}function g(t){if(i.domElement!==t.target)return;t.preventDefault&&t.preventDefault(),i.domElement.removeEventListener("pointermove",y);const n=document.getElementById(c);if(!n)return;i.domElement.parentNode.removeChild(n);const a=p.x>t.offsetX?t.offsetX:p.x,r=p.x<t.offsetX?t.offsetX:p.x,s=p.y>t.offsetY?t.offsetY:p.y,o=p.y<t.offsetY?t.offsetY:p.y,l=new Ce,m=e.convertScreenToWorld({x:a,y:s},l);d.p1Near=l,d.p1Far=m;const f=new Ce,g=e.convertScreenToWorld({x:a,y:o},f);d.p2Near=f,d.p2Far=g;const b=new Ce,_=e.convertScreenToWorld({x:r,y:o},b);d.p3Near=b,d.p3Far=_;const x=new Ce,w=e.convertScreenToWorld({x:r,y:s},x);d.p4Near=x,d.p4Far=w;const S=(new Rt).setFromCoplanarPoints(l,x,f),M=(new Rt).setFromCoplanarPoints(m,_,w),T=(new Rt).setFromCoplanarPoints(l,g,m),A=(new Rt).setFromCoplanarPoints(x,w,_),E=(new Rt).setFromCoplanarPoints(w,l,m),C=(new Rt).setFromCoplanarPoints(b,g,f);u.set(S,M,T,A,E,C),h.callback&&h.callback(v)}function y(e){if(i.domElement!==e.target)return;e.preventDefault&&e.preventDefault();let t=document.getElementById(c);t||(t=document.createElement("div"),t.setAttribute("id",c),t.style.position="absolute",t.style.backgroundColor="rgba(0,0,0,0)",t.style.border="2px red solid",t.style.pointerEvents="none",i.domElement.parentNode.appendChild(t)),t.style.width=`${Math.abs(e.offsetX-p.x)}px`,t.style.height=`${Math.abs(e.offsetY-p.y)}px`,t.style.left=`${e.offsetX>p.x?p.x:e.offsetX}px`,t.style.top=`${e.offsetY>p.y?p.y:e.offsetY}px`}function v(e){if(!e.geometry)return!1;if(!e.geometry.isBufferGeometry)return!1;if(!u.intersectsObject(e))return!1;const t=e.geometry.attributes.position.array;let i=[];if(e.geometry.index)i=e.geometry.index.array;else for(let e=0,n=t.length/3;e<n;e++)i.push(e);for(let n=0,a=i.length;n<a;n+=3){const a=i[n],r=new Ce(t[a],t[a+1],t[a+2]);if(r.applyMatrix4(e.matrixWorld),u.containsPoint(r))return!0;const o=i[n+1],l=new Ce(t[o],t[o+1],t[o+2]);if(l.applyMatrix4(e.matrixWorld),u.containsPoint(l))return!0;const c=i[n+2],h=new Ce(t[c],t[c+1],t[c+2]);if(h.applyMatrix4(e.matrixWorld),u.containsPoint(h))return!0;if(s.set(r,l,h),s.containsPoint(d.p1Near))return!0;if(s.containsPoint(d.p1Far))return!0;if(s.containsPoint(d.p2Near))return!0;if(s.containsPoint(d.p2Far))return!0;if(s.containsPoint(d.p3Near))return!0;if(s.containsPoint(d.p3Far))return!0;if(s.containsPoint(d.p4Near))return!0;if(s.containsPoint(d.p4Far))return!0}return!1}const b="__SELECT_CIRCLE_ID__",_={callback:void 0},x=new Ce;let w,S,M;function T(e){t.enabled=!1,_.callback=e,i.domElement.addEventListener("pointerdown",A),i.domElement.addEventListener("pointerup",E)}function A(t){if(i.domElement!==t.target)return;if(t.preventDefault&&t.preventDefault(),0!==t.button)return;let n=e.pickScreenToWorld({x:t.offsetX,y:t.offsetY});if(!1===n.flag)return;n=e.convertWorldToSceneLocal(n),x.set(n.x,n.y,n.z);const a=[];for(let e=0;e<=360;e++){const t=Math.PI/180*e,i=1*Math.cos(t),n=1*Math.sin(t);a.push(x.x+i),a.push(-(x.z-n))}e.addArea(b,{point:a,depth:500,areaType:"gradient01",color:"#ff0000",fillColor:"#ff0000",alpha:1,fillArea:"segment01",fillType:"none",enableAutoHidebyDistance:!1,offset:!0,lonOffset:0,latOffset:0,altOffset:0,alt:x.y,isShow:!0},void 0,(function(e){M=e})),i.domElement.addEventListener("pointermove",C)}function E(e){if(i.domElement!==e.target)return;e.preventDefault&&e.preventDefault(),i.domElement.removeEventListener("pointermove",C);if(!n.find(b))return;n.remove(b),O.length=0;const t=new Ce(x.x,0,x.z),a=new Ce(t.x+S,0,t.z);for(let e=1;e<=360;e++){const i=Math.PI/180*e;let n=S*Math.cos(i),r=S*Math.sin(i);n=t.x+n,r=t.z+r,O.push(a.clone()),O.push(t.clone()),O.push(a.set(n,0,r).clone())}R.setFromPoints(O),R.min.y=-1/0,R.max.y=1/0,_.callback&&_.callback(N)}function C(t){i.domElement===t.target&&(void 0!==w&&clearTimeout(w),w=setTimeout((function(){t.preventDefault&&t.preventDefault();let i=e.pickScreenToWorld({x:t.offsetX,y:t.offsetY});if(!1===i.flag)return;i=e.convertWorldToSceneLocal(i);const n=x.clone();n.y=0;const a=x.clone();if(a.set(i.x,0,i.z),S=n.distanceTo(a),void 0===M)return;M.scale.set(S,1,S),w=void 0}),10))}const I="__SELECT_POLYGON_ID__",P={callback:void 0},R=new Re,O=[],D=[];function L(e){t.enabled=!1,P.callback=e,i.domElement.addEventListener("pointerdown",k)}function k(t){if(i.domElement!==t.target)return;if(t.preventDefault&&t.preventDefault(),2==t.button){if(!n.find(I))return;n.remove(I);const e=[];for(const t of D)t.y=0,e.push(t);D.length=0,O.length=0;const t=_y.getIndices(e);for(const i of t)O.push(e[i]);return R.setFromPoints(O),R.min.y=-1/0,R.max.y=1/0,void(P.callback&&P.callback(N))}if(0!==t.button)return;let a=e.pickScreenToWorld({x:t.offsetX,y:t.offsetY});!1!==a.flag&&(a=e.convertWorldToSceneLocal(a),D.push(new Ce(a.x,a.y,a.z)),e.addPath(I,{points:D,color:"#ff0000",colorPass:"#ff0000",pass:0,passRange:0,pathType:"segment06",width:2,alpha:1,isShow:!0}))}function N(e){if(!e.geometry)return!1;if(!e.geometry.isBufferGeometry)return!1;if(null===e.geometry.boundingBox&&e.geometry.computeBoundingBox(),l.copy(e.geometry.boundingBox).applyMatrix4(e.matrixWorld),!R.intersectsBox(l))return!1;const t=e.geometry.attributes.position.array;let i=[];if(e.geometry.index)i=e.geometry.index.array;else for(let e=0,n=t.length/3;e<n;e++)i.push(e);for(let n=0,a=O.length;n<a;n+=3){const a=O[n],r=O[n+1],l=O[n+2];s.set(a,r,l);for(let n=0,c=i.length;n<c;n+=3){const c=i[n],h=new Ce(t[c],t[c+1],t[c+2]);if(h.applyMatrix4(e.matrixWorld),h.y=0,s.containsPoint(h))return!0;const u=i[n+1],d=new Ce(t[u],t[u+1],t[u+2]);if(d.applyMatrix4(e.matrixWorld),d.y=0,s.containsPoint(d))return!0;const p=i[n+2],m=new Ce(t[p],t[p+1],t[p+2]);if(m.applyMatrix4(e.matrixWorld),m.y=0,s.containsPoint(m))return!0;if(o.set(h,d,m),o.containsPoint(a))return!0;if(o.containsPoint(r))return!0;if(o.containsPoint(l))return!0}}}function B(){i.domElement.removeEventListener("pointerdown",f),i.domElement.removeEventListener("pointermove",y),i.domElement.removeEventListener("pointerup",g),h.callback=void 0;const e=document.getElementById(c);e&&i.domElement.parentNode.removeChild(e),i.domElement.removeEventListener("pointerdown",A),i.domElement.removeEventListener("pointermove",C),i.domElement.removeEventListener("pointerup",E),_.callback=void 0;n.find(b)&&n.remove(b),i.domElement.removeEventListener("pointerdown",k),P.callback=void 0,O.length=0,D.length=0;n.find(I)&&n.remove(I),t.enabled=!0}this.startSelect=function(e){B();const{type:t}=e;function i(t){const{modelType:i,events:n}=e;let s;"model"===i&&(s="ModelItem"),"building"===i&&(s="BuildingItem"),"iconmodel"===i.toLowerCase()&&(s="iconModel");const o=[];for(const e of a.models.children){const i=r.findItemByObject3D(e);if(!i)continue;if(0==i.visible)continue;if("iconModel"===s&&!0!==i.isIconModel)continue;if("iconModel"!==s&&(!i.getType||i.getType()!==s))continue;let n=!1;e.traverse((function(e){n||e.isMesh&&(n=t(e))})),n&&o.push(i)}const l={type:i,data:[]};Ep.effectStore.highlightObject();for(const e of o)if(e.isIconModelIcon){const t=e.name.substr(0,e.name.indexOf("-IconAssect")),i=Ep.defaultObjectTree.getItemByName(t);Ep.effectStore.highlightObject(i.getGroup(),!0),l.data.push({id:i.name})}else Ep.effectStore.highlightObject(e.getGroup(),!0),l.data.push({id:e.name});n&&n(l)}"rect"===t&&m(i),"circle"===t&&T(i),"polygon"===t&&L(i)},this.endSelect=function(){Ep.effectStore.highlightObject(),B()},this.startSelectDrawable=function(e,t){B();const{type:i}=e;function a(e){const i=[];n.forEach((function(t){let n=!1;if(t.traverse((function(e){n||(n=e.userData.inView)})),!1===n)return;let a=!1;t.traverse((function(t){if(!a){if(t.isInstancedMesh){const n=new Fi;n.copy(t);const r=new it,s=t.instanceMatrix.array;for(let o=0,l=t.instanceMatrix.count;o<l;o++)r.fromArray(s,o*t.instanceMatrix.itemSize),n.matrixWorld=r,a=e(n),a&&(i.push({isInstancedMesh:!0,name:t.name,index:o}),a=!1)}(t.isMesh||t.isSprite)&&(a=e(t))}})),a&&i.push(t)})),t&&t(i)}"rect"===i&&m(a),"circle"===i&&T(a),"polygon"===i&&L(a)},this.endSelectDrawable=B}uw.prototype=Object.assign(Object.create(Fi.prototype),{constructor:uw,isTransformControlsPlane:!0});let pw={type:"modelSelect"},mw={type:"nodeSelect"};class fw extends pe{constructor(){super("SelectionControls");let e={},t={},i="selection_div",n=["ModelItem","ModelAsset","IconItem","PaperCutItem","BuildingItem","BuildingFloorItem","IconAsset","GroupItem","PaintItem","BuildingFloorHome","PackedItem"];this.fromBuildingSelection=null,this.fromModelSelection=null,this._clearSelectDiv=()=>{let e=document.getElementById(i);e&&Ep.renderer.domElement.parentNode.removeChild(e)},this._createSelectDiv=()=>{this._clearSelectDiv();let n=document.createElement("div");n.setAttribute("id",i),n.style=`position: absolute;\n                width: ${Math.abs(t.x-e.x)}px; \n                height:${Math.abs(t.y-e.y)}px; \n                left: ${t.x>e.x?e.x:t.x}px; \n                top: ${t.y>e.y?e.y:t.y}px;\n                background-color: rgba(0,0,0,0);\n                border: 2px red solid;\n                pointer-events: none`,Ep.renderer.domElement.parentNode.appendChild(n)},this._onMouseMove=i=>{window.navigator.platform.toLocaleLowerCase().indexOf("mac")>-1&&!i.metaKey||(-1!==window.navigator.platform.toLocaleLowerCase().indexOf("mac")||i.ctrlKey)&&i.target===Ep.renderer.domElement&&(Math.abs(e.x-i.offsetX)>3||Math.abs(e.y-i.offsetY)>3)&&(i.preventDefault(),t.x=i.offsetX,t.y=i.offsetY,this._createSelectDiv())},this._onMouseDown=t=>{0===t.button&&(window.navigator.platform.toLocaleLowerCase().indexOf("mac")>-1&&!t.metaKey||(-1!==window.navigator.platform.toLocaleLowerCase().indexOf("mac")||t.ctrlKey)&&Ep.renderer&&t.target===Ep.renderer.domElement&&(Ep.transformControls.enabled=!1,Ep.transformControls.pointerUp({button:0}),t.preventDefault(),document.addEventListener("pointermove",this._onMouseMove),e.x=t.offsetX,e.y=t.offsetY))},this._onMouseUp=i=>{0===i.button&&(Ep.transformControls.enabled=!0,document.removeEventListener("pointermove",this._onMouseMove),this._clearSelectDiv(),window.navigator.platform.toLocaleLowerCase().indexOf("mac")>-1&&!i.metaKey||(-1!==window.navigator.platform.toLocaleLowerCase().indexOf("mac")||i.ctrlKey)&&Ep.renderer&&i.target===Ep.renderer.domElement&&(e.x===i.offsetX&&e.y===i.offsetY||void 0===e.x&&void 0===e.y||(i.preventDefault(),t.x=i.offsetX,t.y=i.offsetY,this._getSelectionObject(i),e={},t={})))},this._convertWorldToScreen=e=>{var t=new Ce(e.x,e.y,e.z).project(Ep.camera),i=Ep.renderer.domElement.parentNode.clientWidth/2,n=Ep.renderer.domElement.parentNode.clientHeight/2;return{x:Math.round(t.x*i+i),y:Math.round(-t.y*n+n)}},this._inPolygon=(e,t)=>{let i,n=0,a=t[0],r=t.length;for(let s=1;s<=r;s++){if(i=t[s%r],e.y>(a.y>i.y?i.y:a.y)&&e.y<=(a.y<i.y?i.y:a.y)&&e.x<=(a.x>i.x?a.x:i.x)&&a.y!=i.y){let t=(e.y-a.y)*(i.x-a.x)/(i.y-a.y)+a.x;(a.x==i.x||e.x<=t)&&n++}a=i}return n%2!=0},this.getIsSelectionObject=i=>{let a=Ep.defaultObjectTree.getItemByUUID(i.uuid);if(a&&a.getType&&n.indexOf(a.getType())>-1&&!0===i.visible&&!a.isLock){i.updateWorldMatrix();let n=(new Re).setFromObject(i),a=n.min.clone(),r=n.max.clone(),s=this._convertWorldToScreen(a),o=this._convertWorldToScreen(r),l=s.x>o.x?o.x:s.x,c=s.x<o.x?o.x:s.x,h=s.y>o.y?o.y:s.y,u=s.y<o.y?o.y:s.y,d=[{x:l,y:u},{x:l,y:h},{x:c,y:h},{x:c,y:u}],p=e.x>t.x?t.x:e.x,m=e.x<t.x?t.x:e.x,f=e.y>t.y?t.y:e.y,g=e.y<t.y?t.y:e.y,y=[{x:p,y:g},{x:p,y:f},{x:m,y:f},{x:m,y:g}],v=new qc(new ye(e.x,e.y),new ye(t.x,t.y)),b=new qc(new ye(s.x,s.y),new ye(o.x,o.y)),_=v.getCenter(new ye),x=b.getCenter(new ye);if(this._inPolygon(d[0],y)||this._inPolygon(d[1],y)||this._inPolygon(d[2],y)||this._inPolygon(d[3],y)||this._inPolygon(x,y)||this._inPolygon(y[0],d)||this._inPolygon(y[1],d)||this._inPolygon(y[2],d)||this._inPolygon(y[3],d)||this._inPolygon(_,d))return i}return null},this.getIsSelectionNode=i=>{let n=Ep.defaultObjectTree.getItemByUUID(i.uuid)||{};if(n&&!n.isLock){i.updateWorldMatrix();let n=(new Re).setFromObject(i),a=n.min.clone(),r=n.max.clone(),s=this._convertWorldToScreen(a),o=this._convertWorldToScreen(r),l=s.x>o.x?o.x:s.x,c=s.x<o.x?o.x:s.x,h=s.y>o.y?o.y:s.y,u=s.y<o.y?o.y:s.y,d=[{x:l,y:u},{x:l,y:h},{x:c,y:h},{x:c,y:u}],p=e.x>t.x?t.x:e.x,m=e.x<t.x?t.x:e.x,f=e.y>t.y?t.y:e.y,g=e.y<t.y?t.y:e.y,y=[{x:p,y:g},{x:p,y:f},{x:m,y:f},{x:m,y:g}],v=new qc(new ye(e.x,e.y),new ye(t.x,t.y)),b=new qc(new ye(s.x,s.y),new ye(o.x,o.y)),_=v.getCenter(new ye),x=b.getCenter(new ye);if(this._inPolygon(d[0],y)||this._inPolygon(d[1],y)||this._inPolygon(d[2],y)||this._inPolygon(d[3],y)||this._inPolygon(x,y)||this._inPolygon(y[0],d)||this._inPolygon(y[1],d)||this._inPolygon(y[2],d)||this._inPolygon(y[3],d)||this._inPolygon(_,d))return i}return null},this._getSelectionObject=e=>{let t=[],i=[];this.fromBuildingSelection?this.fromBuildingSelection.traverseVisible&&this.fromBuildingSelection.traverseVisible((e=>{let i=this.getIsSelectionObject(e);i&&t.push(i)})):Ep.scene.models.children.forEach((e=>{let i=this.getIsSelectionObject(e);i&&t.push(i)})),this.fromModelSelection&&this.fromModelSelection.traverseVisible&&this.fromModelSelection.traverseVisible((e=>{let t=this.getIsSelectionNode(e);t&&i.push(t)}));let n=t.map((e=>e.uuid)),a=i.map((e=>e.uuid));pw.selectionList=n,this.dispatchEvent(pw),mw.selectionList=a,this.dispatchEvent(mw)},this.switchSelection=e=>{document.removeEventListener("pointerdown",this._onMouseDown),document.removeEventListener("pointerup",this._onMouseUp),e&&(document.addEventListener("pointerdown",this._onMouseDown),document.addEventListener("pointerup",this._onMouseUp))},this.setFromModelSelection=e=>{this.fromModelSelection=Ep.scene.getObjectByProperty("uuid",e)},this.setFromBuildingSelection=e=>{this.fromBuildingSelection=Ep.scene.getObjectByProperty("uuid",e)}}}class gw extends Fi{constructor(){super(new Hi(1,1,1),null),this.name="ClippingControls",this.material1=new Kt({transparent:!0,color:new Qt("#ff0000"),opacity:1,depthTest:!1,depthWrite:!1}),this.material2=new Kt({transparent:!0,color:new Qt("#ff0000"),opacity:.3,depthTest:!1,depthWrite:!1}),this.material=this.material1,this.enable=!1,this.visible=!1,this.object=void 0,this.box=new Nv;const e=new Fi(new xs(0,3,8,32,1,!1),new Kt({transparent:!0,color:new Qt("#ff3333"),opacity:1,depthTest:!1,depthWrite:!1})),t=[{position:{x:0,y:0,z:0},rotation:{_x:Math.PI/2,_y:0,_z:0,_order:"XYZ"}}];for(const i of t){const t=e.clone();t.position.copy(i.position),t.rotation.copy(i.rotation),this.add(t)}}setColor(e){this.material1.color.set(e),this.material2.color.set(e)}attach(e){this.object=e,this.box.setFromObject(this.object),this.box.getCenter(this.position),this.box.getSize(this.scale);for(const e of this.children)e.scale.set(1/this.scale.x,1/this.scale.y,1/this.scale.z);return this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this}updateMatrixWorld(){super.updateMatrixWorld()}dispose(){}}var yw=Ug((function(e,t){e.exports=function e(t,i,n){function a(s,o){if(!i[s]){if(!t[s]){if(!o&&Fg)return Fg(s);if(r)return r(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var c=i[s]={exports:{}};t[s][0].call(c.exports,(function(e){var i=t[s][1][e];return a(i||e)}),c,c.exports,e,t,i,n)}return i[s].exports}for(var r=Fg,s=0;s<n.length;s++)a(n[s]);return a}({1:[function(e,t,i){(function(t){(function(){let n=e("./interlace"),a=[function(){},function(e,t,i,n){if(n===t.length)throw new Error("Ran out of data");let a=t[n];e[i]=a,e[i+1]=a,e[i+2]=a,e[i+3]=255},function(e,t,i,n){if(n+1>=t.length)throw new Error("Ran out of data");let a=t[n];e[i]=a,e[i+1]=a,e[i+2]=a,e[i+3]=t[n+1]},function(e,t,i,n){if(n+2>=t.length)throw new Error("Ran out of data");e[i]=t[n],e[i+1]=t[n+1],e[i+2]=t[n+2],e[i+3]=255},function(e,t,i,n){if(n+3>=t.length)throw new Error("Ran out of data");e[i]=t[n],e[i+1]=t[n+1],e[i+2]=t[n+2],e[i+3]=t[n+3]}],r=[function(){},function(e,t,i,n){let a=t[0];e[i]=a,e[i+1]=a,e[i+2]=a,e[i+3]=n},function(e,t,i){let n=t[0];e[i]=n,e[i+1]=n,e[i+2]=n,e[i+3]=t[1]},function(e,t,i,n){e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=n},function(e,t,i){e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=t[3]}];function s(e,t){let i=[],n=0;function a(){if(n===e.length)throw new Error("Ran out of data");let a,r,s,o,l,c,h,u,d=e[n];switch(n++,t){default:throw new Error("unrecognised depth");case 16:h=e[n],n++,i.push((d<<8)+h);break;case 4:h=15&d,u=d>>4,i.push(u,h);break;case 2:l=3&d,c=d>>2&3,h=d>>4&3,u=d>>6&3,i.push(u,h,c,l);break;case 1:a=1&d,r=d>>1&1,s=d>>2&1,o=d>>3&1,l=d>>4&1,c=d>>5&1,h=d>>6&1,u=d>>7&1,i.push(u,h,c,l,o,s,r,a)}}return{get:function(e){for(;i.length<e;)a();let t=i.slice(0,e);return i=i.slice(e),t},resetAfterLine:function(){i.length=0},end:function(){if(n!==e.length)throw new Error("extra data found")}}}function o(e,t,i,n,r,s){let o=e.width,l=e.height,c=e.index;for(let e=0;e<l;e++)for(let l=0;l<o;l++){let o=i(l,e,c);a[n](t,r,o,s),s+=n}return s}function l(e,t,i,n,a,s){let o=e.width,l=e.height,c=e.index;for(let e=0;e<l;e++){for(let l=0;l<o;l++){let o=a.get(n),h=i(l,e,c);r[n](t,o,h,s)}a.resetAfterLine()}}i.dataToBitMap=function(e,i){let a,r,c=i.width,h=i.height,u=i.depth,d=i.bpp,p=i.interlace;8!==u&&(a=s(e,u)),r=u<=8?t.alloc(c*h*4):new Uint16Array(c*h*4);let m,f,g=Math.pow(2,u)-1,y=0;if(p)m=n.getImagePasses(c,h),f=n.getInterlaceIterator(c,h);else{let e=0;f=function(){let t=e;return e+=4,t},m=[{width:c,height:h}]}for(let t=0;t<m.length;t++)8===u?y=o(m[t],r,f,d,e,y):l(m[t],r,f,d,a,g);if(8===u){if(y!==e.length)throw new Error("extra data found")}else a.end();return r}}).call(this)}).call(this,e("buffer").Buffer)},{"./interlace":11,buffer:33}],2:[function(e,t,i){(function(i){(function(){let n=e("./constants");t.exports=function(e,t,a,r){let s=-1!==[n.COLORTYPE_COLOR_ALPHA,n.COLORTYPE_ALPHA].indexOf(r.colorType);if(r.colorType===r.inputColorType){let t=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256!==new Int16Array(e)[0]}();if(8===r.bitDepth||16===r.bitDepth&&t)return e}let o=16!==r.bitDepth?e:new Uint16Array(e.buffer),l=255,c=n.COLORTYPE_TO_BPP_MAP[r.inputColorType];4!==c||r.inputHasAlpha||(c=3);let h=n.COLORTYPE_TO_BPP_MAP[r.colorType];16===r.bitDepth&&(l=65535,h*=2);let u=i.alloc(t*a*h),d=0,p=0,m=r.bgColor||{};function f(){let e,t,i,a=l;switch(r.inputColorType){case n.COLORTYPE_COLOR_ALPHA:a=o[d+3],e=o[d],t=o[d+1],i=o[d+2];break;case n.COLORTYPE_COLOR:e=o[d],t=o[d+1],i=o[d+2];break;case n.COLORTYPE_ALPHA:a=o[d+1],e=o[d],t=e,i=e;break;case n.COLORTYPE_GRAYSCALE:e=o[d],t=e,i=e;break;default:throw new Error("input color type:"+r.inputColorType+" is not supported at present")}return r.inputHasAlpha&&(s||(a/=l,e=Math.min(Math.max(Math.round((1-a)*m.red+a*e),0),l),t=Math.min(Math.max(Math.round((1-a)*m.green+a*t),0),l),i=Math.min(Math.max(Math.round((1-a)*m.blue+a*i),0),l))),{red:e,green:t,blue:i,alpha:a}}void 0===m.red&&(m.red=l),void 0===m.green&&(m.green=l),void 0===m.blue&&(m.blue=l);for(let e=0;e<a;e++)for(let e=0;e<t;e++){let e=f();switch(r.colorType){case n.COLORTYPE_COLOR_ALPHA:case n.COLORTYPE_COLOR:8===r.bitDepth?(u[p]=e.red,u[p+1]=e.green,u[p+2]=e.blue,s&&(u[p+3]=e.alpha)):(u.writeUInt16BE(e.red,p),u.writeUInt16BE(e.green,p+2),u.writeUInt16BE(e.blue,p+4),s&&u.writeUInt16BE(e.alpha,p+6));break;case n.COLORTYPE_ALPHA:case n.COLORTYPE_GRAYSCALE:{let t=(e.red+e.green+e.blue)/3;8===r.bitDepth?(u[p]=t,s&&(u[p+1]=e.alpha)):(u.writeUInt16BE(t,p),s&&u.writeUInt16BE(e.alpha,p+2));break}default:throw new Error("unrecognised color Type "+r.colorType)}d+=c,p+=h}return u}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,buffer:33}],3:[function(e,t,i){(function(i,n){(function(){let a=e("util"),r=e("stream"),s=t.exports=function(){r.call(this),this._buffers=[],this._buffered=0,this._reads=[],this._paused=!1,this._encoding="utf8",this.writable=!0};a.inherits(s,r),s.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t}),i.nextTick(function(){this._process(),this._paused&&this._reads&&this._reads.length>0&&(this._paused=!1,this.emit("drain"))}.bind(this))},s.prototype.write=function(e,t){if(!this.writable)return this.emit("error",new Error("Stream not writable")),!1;let i;return i=n.isBuffer(e)?e:n.from(e,t||this._encoding),this._buffers.push(i),this._buffered+=i.length,this._process(),this._reads&&0===this._reads.length&&(this._paused=!0),this.writable&&!this._paused},s.prototype.end=function(e,t){e&&this.write(e,t),this.writable=!1,this._buffers&&(0===this._buffers.length?this._end():(this._buffers.push(null),this._process()))},s.prototype.destroySoon=s.prototype.end,s.prototype._end=function(){this._reads.length>0&&this.emit("error",new Error("Unexpected end of input")),this.destroy()},s.prototype.destroy=function(){this._buffers&&(this.writable=!1,this._reads=null,this._buffers=null,this.emit("close"))},s.prototype._processReadAllowingLess=function(e){this._reads.shift();let t=this._buffers[0];t.length>e.length?(this._buffered-=e.length,this._buffers[0]=t.slice(e.length),e.func.call(this,t.slice(0,e.length))):(this._buffered-=t.length,this._buffers.shift(),e.func.call(this,t))},s.prototype._processRead=function(e){this._reads.shift();let t=0,i=0,a=n.alloc(e.length);for(;t<e.length;){let n=this._buffers[i++],r=Math.min(n.length,e.length-t);n.copy(a,t,0,r),t+=r,r!==n.length&&(this._buffers[--i]=n.slice(r))}i>0&&this._buffers.splice(0,i),this._buffered-=e.length,e.func.call(this,a)},s.prototype._process=function(){try{for(;this._buffered>0&&this._reads&&this._reads.length>0;){let e=this._reads[0];if(e.allowLess)this._processReadAllowingLess(e);else{if(!(this._buffered>=e.length))break;this._processRead(e)}}this._buffers&&!this.writable&&this._end()}catch(e){this.emit("error",e)}}}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:60,buffer:33,stream:61,util:81}],4:[function(e,t,i){t.exports={PNG_SIGNATURE:[137,80,78,71,13,10,26,10],TYPE_IHDR:1229472850,TYPE_IEND:1229278788,TYPE_IDAT:1229209940,TYPE_PLTE:1347179589,TYPE_tRNS:1951551059,TYPE_gAMA:1732332865,COLORTYPE_GRAYSCALE:0,COLORTYPE_PALETTE:1,COLORTYPE_COLOR:2,COLORTYPE_ALPHA:4,COLORTYPE_PALETTE_COLOR:3,COLORTYPE_COLOR_ALPHA:6,COLORTYPE_TO_BPP_MAP:{0:1,2:3,3:1,4:2,6:4},GAMMA_DIVISION:1e5}},{}],5:[function(e,t,i){let n=[];!function(){for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)1&t?t=3988292384^t>>>1:t>>>=1;n[e]=t}}();let a=t.exports=function(){this._crc=-1};a.prototype.write=function(e){for(let t=0;t<e.length;t++)this._crc=n[255&(this._crc^e[t])]^this._crc>>>8;return!0},a.prototype.crc32=function(){return-1^this._crc},a.crc32=function(e){let t=-1;for(let i=0;i<e.length;i++)t=n[255&(t^e[i])]^t>>>8;return-1^t}},{}],6:[function(e,t,i){(function(i){(function(){let n=e("./paeth-predictor");function a(e,t,i,n,a){for(let r=0;r<i;r++)n[a+r]=e[t+r]}function r(e,t,i){let n=0,a=t+i;for(let i=t;i<a;i++)n+=Math.abs(e[i]);return n}function s(e,t,i,n,a,r){for(let s=0;s<i;s++){let i=s>=r?e[t+s-r]:0,o=e[t+s]-i;n[a+s]=o}}function o(e,t,i,n){let a=0;for(let r=0;r<i;r++){let i=r>=n?e[t+r-n]:0,s=e[t+r]-i;a+=Math.abs(s)}return a}function l(e,t,i,n,a){for(let r=0;r<i;r++){let s=t>0?e[t+r-i]:0,o=e[t+r]-s;n[a+r]=o}}function c(e,t,i){let n=0,a=t+i;for(let r=t;r<a;r++){let a=t>0?e[r-i]:0,s=e[r]-a;n+=Math.abs(s)}return n}function h(e,t,i,n,a,r){for(let s=0;s<i;s++){let o=s>=r?e[t+s-r]:0,l=t>0?e[t+s-i]:0,c=e[t+s]-(o+l>>1);n[a+s]=c}}function u(e,t,i,n){let a=0;for(let r=0;r<i;r++){let s=r>=n?e[t+r-n]:0,o=t>0?e[t+r-i]:0,l=e[t+r]-(s+o>>1);a+=Math.abs(l)}return a}function d(e,t,i,a,r,s){for(let o=0;o<i;o++){let l=o>=s?e[t+o-s]:0,c=t>0?e[t+o-i]:0,h=t>0&&o>=s?e[t+o-(i+s)]:0,u=e[t+o]-n(l,c,h);a[r+o]=u}}function p(e,t,i,a){let r=0;for(let s=0;s<i;s++){let o=s>=a?e[t+s-a]:0,l=t>0?e[t+s-i]:0,c=t>0&&s>=a?e[t+s-(i+a)]:0,h=e[t+s]-n(o,l,c);r+=Math.abs(h)}return r}let m={0:a,1:s,2:l,3:h,4:d},f={0:r,1:o,2:c,3:u,4:p};t.exports=function(e,t,n,a,r){let s;if("filterType"in a&&-1!==a.filterType){if("number"!=typeof a.filterType)throw new Error("unrecognised filter types");s=[a.filterType]}else s=[0,1,2,3,4];16===a.bitDepth&&(r*=2);let o=t*r,l=0,c=0,h=i.alloc((o+1)*n),u=s[0];for(let t=0;t<n;t++){if(s.length>1){let t=1/0;for(let i=0;i<s.length;i++){let n=f[s[i]](e,c,o,r);n<t&&(u=s[i],t=n)}}h[l]=u,l++,m[u](e,c,o,h,l,r),l+=o,c+=o}return h}}).call(this)}).call(this,e("buffer").Buffer)},{"./paeth-predictor":15,buffer:33}],7:[function(e,t,i){(function(i){(function(){let n=e("util"),a=e("./chunkstream"),r=e("./filter-parse"),s=t.exports=function(e){a.call(this);let t=[],n=this;this._filter=new r(e,{read:this.read.bind(this),write:function(e){t.push(e)},complete:function(){n.emit("complete",i.concat(t))}}),this._filter.start()};n.inherits(s,a)}).call(this)}).call(this,e("buffer").Buffer)},{"./chunkstream":3,"./filter-parse":9,buffer:33,util:81}],8:[function(e,t,i){(function(t){(function(){let n=e("./sync-reader"),a=e("./filter-parse");i.process=function(e,i){let r=[],s=new n(e);return new a(i,{read:s.read.bind(s),write:function(e){r.push(e)},complete:function(){}}).start(),s.process(),t.concat(r)}}).call(this)}).call(this,e("buffer").Buffer)},{"./filter-parse":9,"./sync-reader":22,buffer:33}],9:[function(e,t,i){(function(i){(function(){let n=e("./interlace"),a=e("./paeth-predictor");function r(e,t,i){let n=e*t;return 8!==i&&(n=Math.ceil(n/(8/i))),n}let s=t.exports=function(e,t){let i=e.width,a=e.height,s=e.interlace,o=e.bpp,l=e.depth;if(this.read=t.read,this.write=t.write,this.complete=t.complete,this._imageIndex=0,this._images=[],s){let e=n.getImagePasses(i,a);for(let t=0;t<e.length;t++)this._images.push({byteWidth:r(e[t].width,o,l),height:e[t].height,lineIndex:0})}else this._images.push({byteWidth:r(i,o,l),height:a,lineIndex:0});this._xComparison=8===l?o:16===l?2*o:1};s.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))},s.prototype._unFilterType1=function(e,t,i){let n=this._xComparison,a=n-1;for(let r=0;r<i;r++){let i=e[1+r],s=r>a?t[r-n]:0;t[r]=i+s}},s.prototype._unFilterType2=function(e,t,i){let n=this._lastLine;for(let a=0;a<i;a++){let i=e[1+a],r=n?n[a]:0;t[a]=i+r}},s.prototype._unFilterType3=function(e,t,i){let n=this._xComparison,a=n-1,r=this._lastLine;for(let s=0;s<i;s++){let i=e[1+s],o=r?r[s]:0,l=s>a?t[s-n]:0,c=Math.floor((l+o)/2);t[s]=i+c}},s.prototype._unFilterType4=function(e,t,i){let n=this._xComparison,r=n-1,s=this._lastLine;for(let o=0;o<i;o++){let i=e[1+o],l=s?s[o]:0,c=o>r?t[o-n]:0,h=o>r&&s?s[o-n]:0,u=a(c,l,h);t[o]=i+u}},s.prototype._reverseFilterLine=function(e){let t,n=e[0],a=this._images[this._imageIndex],r=a.byteWidth;if(0===n)t=e.slice(1,r+1);else switch(t=i.alloc(r),n){case 1:this._unFilterType1(e,t,r);break;case 2:this._unFilterType2(e,t,r);break;case 3:this._unFilterType3(e,t,r);break;case 4:this._unFilterType4(e,t,r);break;default:throw new Error("Unrecognised filter type - "+n)}this.write(t),a.lineIndex++,a.lineIndex>=a.height?(this._lastLine=null,this._imageIndex++,a=this._images[this._imageIndex]):this._lastLine=t,a?this.read(a.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())}}).call(this)}).call(this,e("buffer").Buffer)},{"./interlace":11,"./paeth-predictor":15,buffer:33}],10:[function(e,t,i){(function(e){(function(){function i(e,t,i,n,a){let r=0;for(let s=0;s<n;s++)for(let n=0;n<i;n++){let i=a[e[r]];if(!i)throw new Error("index "+e[r]+" not in palette");for(let e=0;e<4;e++)t[r+e]=i[e];r+=4}}function n(e,t,i,n,a){let r=0;for(let s=0;s<n;s++)for(let n=0;n<i;n++){let i=!1;if(1===a.length?a[0]===e[r]&&(i=!0):a[0]===e[r]&&a[1]===e[r+1]&&a[2]===e[r+2]&&(i=!0),i)for(let e=0;e<4;e++)t[r+e]=0;r+=4}}function a(e,t,i,n,a){let r=255,s=Math.pow(2,a)-1,o=0;for(let a=0;a<n;a++)for(let n=0;n<i;n++){for(let i=0;i<4;i++)t[o+i]=Math.floor(e[o+i]*r/s+.5);o+=4}}t.exports=function(t,r,s=!1){let o=r.depth,l=r.width,c=r.height,h=r.colorType,u=r.transColor,d=r.palette,p=t;return 3===h?i(t,p,l,c,d):(u&&n(t,p,l,c,u),8===o||s||(16===o&&(p=e.alloc(l*c*4)),a(t,p,l,c,o))),p}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:33}],11:[function(e,t,i){let n=[{x:[0],y:[0]},{x:[4],y:[0]},{x:[0,4],y:[4]},{x:[2,6],y:[0,4]},{x:[0,2,4,6],y:[2,6]},{x:[1,3,5,7],y:[0,2,4,6]},{x:[0,1,2,3,4,5,6,7],y:[1,3,5,7]}];i.getImagePasses=function(e,t){let i=[],a=e%8,r=t%8,s=(e-a)/8,o=(t-r)/8;for(let e=0;e<n.length;e++){let t=n[e],l=s*t.x.length,c=o*t.y.length;for(let e=0;e<t.x.length&&t.x[e]<a;e++)l++;for(let e=0;e<t.y.length&&t.y[e]<r;e++)c++;l>0&&c>0&&i.push({width:l,height:c,index:e})}return i},i.getInterlaceIterator=function(e){return function(t,i,a){let r=t%n[a].x.length,s=(t-r)/n[a].x.length*8+n[a].x[r],o=i%n[a].y.length;return 4*s+((i-o)/n[a].y.length*8+n[a].y[o])*e*4}}},{}],12:[function(e,t,i){(function(i){(function(){let n=e("util"),a=e("stream"),r=e("./constants"),s=e("./packer"),o=t.exports=function(e){a.call(this);let t=e||{};this._packer=new s(t),this._deflate=this._packer.createDeflate(),this.readable=!0};n.inherits(o,a),o.prototype.pack=function(e,t,n,a){this.emit("data",i.from(r.PNG_SIGNATURE)),this.emit("data",this._packer.packIHDR(t,n)),a&&this.emit("data",this._packer.packGAMA(a));let s=this._packer.filterData(e,t,n);this._deflate.on("error",this.emit.bind(this,"error")),this._deflate.on("data",function(e){this.emit("data",this._packer.packIDAT(e))}.bind(this)),this._deflate.on("end",function(){this.emit("data",this._packer.packIEND()),this.emit("end")}.bind(this)),this._deflate.end(s)}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,"./packer":14,buffer:33,stream:61,util:81}],13:[function(e,t,i){(function(i){(function(){let n=!0,a=e("zlib");a.deflateSync||(n=!1);let r=e("./constants"),s=e("./packer");t.exports=function(e,t){if(!n)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let o=new s(t||{}),l=[];l.push(i.from(r.PNG_SIGNATURE)),l.push(o.packIHDR(e.width,e.height)),e.gamma&&l.push(o.packGAMA(e.gamma));let c=o.filterData(e.data,e.width,e.height),h=a.deflateSync(c,o.getDeflateOptions());if(c=null,!h||!h.length)throw new Error("bad png - invalid compressed data response");return l.push(o.packIDAT(h)),l.push(o.packIEND()),i.concat(l)}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,"./packer":14,buffer:33,zlib:32}],14:[function(e,t,i){(function(i){(function(){let n=e("./constants"),a=e("./crc"),r=e("./bitpacker"),s=e("./filter-pack"),o=e("zlib"),l=t.exports=function(e){if(this._options=e,e.deflateChunkSize=e.deflateChunkSize||32768,e.deflateLevel=null!=e.deflateLevel?e.deflateLevel:9,e.deflateStrategy=null!=e.deflateStrategy?e.deflateStrategy:3,e.inputHasAlpha=null==e.inputHasAlpha||e.inputHasAlpha,e.deflateFactory=e.deflateFactory||o.createDeflate,e.bitDepth=e.bitDepth||8,e.colorType="number"==typeof e.colorType?e.colorType:n.COLORTYPE_COLOR_ALPHA,e.inputColorType="number"==typeof e.inputColorType?e.inputColorType:n.COLORTYPE_COLOR_ALPHA,-1===[n.COLORTYPE_GRAYSCALE,n.COLORTYPE_COLOR,n.COLORTYPE_COLOR_ALPHA,n.COLORTYPE_ALPHA].indexOf(e.colorType))throw new Error("option color type:"+e.colorType+" is not supported at present");if(-1===[n.COLORTYPE_GRAYSCALE,n.COLORTYPE_COLOR,n.COLORTYPE_COLOR_ALPHA,n.COLORTYPE_ALPHA].indexOf(e.inputColorType))throw new Error("option input color type:"+e.inputColorType+" is not supported at present");if(8!==e.bitDepth&&16!==e.bitDepth)throw new Error("option bit depth:"+e.bitDepth+" is not supported at present")};l.prototype.getDeflateOptions=function(){return{chunkSize:this._options.deflateChunkSize,level:this._options.deflateLevel,strategy:this._options.deflateStrategy}},l.prototype.createDeflate=function(){return this._options.deflateFactory(this.getDeflateOptions())},l.prototype.filterData=function(e,t,i){let a=r(e,t,i,this._options),o=n.COLORTYPE_TO_BPP_MAP[this._options.colorType];return s(a,t,i,this._options,o)},l.prototype._packChunk=function(e,t){let n=t?t.length:0,r=i.alloc(n+12);return r.writeUInt32BE(n,0),r.writeUInt32BE(e,4),t&&t.copy(r,8),r.writeInt32BE(a.crc32(r.slice(4,r.length-4)),r.length-4),r},l.prototype.packGAMA=function(e){let t=i.alloc(4);return t.writeUInt32BE(Math.floor(e*n.GAMMA_DIVISION),0),this._packChunk(n.TYPE_gAMA,t)},l.prototype.packIHDR=function(e,t){let a=i.alloc(13);return a.writeUInt32BE(e,0),a.writeUInt32BE(t,4),a[8]=this._options.bitDepth,a[9]=this._options.colorType,a[10]=0,a[11]=0,a[12]=0,this._packChunk(n.TYPE_IHDR,a)},l.prototype.packIDAT=function(e){return this._packChunk(n.TYPE_IDAT,e)},l.prototype.packIEND=function(){return this._packChunk(n.TYPE_IEND,null)}}).call(this)}).call(this,e("buffer").Buffer)},{"./bitpacker":2,"./constants":4,"./crc":5,"./filter-pack":6,buffer:33,zlib:32}],15:[function(e,t,i){t.exports=function(e,t,i){let n=e+t-i,a=Math.abs(n-e),r=Math.abs(n-t),s=Math.abs(n-i);return a<=r&&a<=s?e:r<=s?t:i}},{}],16:[function(e,t,i){let n=e("util"),a=e("zlib"),r=e("./chunkstream"),s=e("./filter-parse-async"),o=e("./parser"),l=e("./bitmapper"),c=e("./format-normaliser"),h=t.exports=function(e){r.call(this),this._parser=new o(e,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=e,this.writable=!0,this._parser.start()};n.inherits(h,r),h.prototype._handleError=function(e){this.emit("error",e),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",(function(){}))),this.errord=!0},h.prototype._inflateData=function(e){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=a.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{let e=(1+(this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3))*this._bitmapInfo.height,t=Math.max(e,a.Z_MIN_CHUNK);this._inflate=a.createInflate({chunkSize:t});let i=e,n=this.emit.bind(this,"error");this._inflate.on("error",(function(e){i&&n(e)})),this._filter.on("complete",this._complete.bind(this));let r=this._filter.write.bind(this._filter);this._inflate.on("data",(function(e){i&&(e.length>i&&(e=e.slice(0,i)),i-=e.length,r(e))})),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(e)},h.prototype._handleMetaData=function(e){this._metaData=e,this._bitmapInfo=Object.create(e),this._filter=new s(this._bitmapInfo)},h.prototype._handleTransColor=function(e){this._bitmapInfo.transColor=e},h.prototype._handlePalette=function(e){this._bitmapInfo.palette=e},h.prototype._simpleTransparency=function(){this._metaData.alpha=!0},h.prototype._headersFinished=function(){this.emit("metadata",this._metaData)},h.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"))},h.prototype._complete=function(e){if(this.errord)return;let t;try{let i=l.dataToBitMap(e,this._bitmapInfo);t=c(i,this._bitmapInfo,this._options.skipRescale),i=null}catch(e){return void this._handleError(e)}this.emit("parsed",t)}},{"./bitmapper":1,"./chunkstream":3,"./filter-parse-async":7,"./format-normaliser":10,"./parser":18,util:81,zlib:32}],17:[function(e,t,i){(function(i){(function(){let n=!0,a=e("zlib"),r=e("./sync-inflate");a.deflateSync||(n=!1);let s=e("./sync-reader"),o=e("./filter-parse-sync"),l=e("./parser"),c=e("./bitmapper"),h=e("./format-normaliser");t.exports=function(e,t){if(!n)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let u,d,p;function m(e){u=e}function f(e){d=e}function g(e){d.transColor=e}function y(e){d.palette=e}function v(){d.alpha=!0}function b(e){p=e}let _=[];function x(e){_.push(e)}let w=new s(e);if(new l(t,{read:w.read.bind(w),error:m,metadata:f,gamma:b,palette:y,transColor:g,inflateData:x,simpleTransparency:v}).start(),w.process(),u)throw u;let S,M=i.concat(_);if(_.length=0,d.interlace)S=a.inflateSync(M);else{let e=(1+(d.width*d.bpp*d.depth+7>>3))*d.height;S=r(M,{chunkSize:e,maxLength:e})}if(M=null,!S||!S.length)throw new Error("bad png - invalid inflate data response");let T=o.process(S,d);M=null;let A=c.dataToBitMap(T,d);T=null;let E=h(A,d,t.skipRescale);return d.data=E,d.gamma=p||0,d}}).call(this)}).call(this,e("buffer").Buffer)},{"./bitmapper":1,"./filter-parse-sync":8,"./format-normaliser":10,"./parser":18,"./sync-inflate":21,"./sync-reader":22,buffer:33,zlib:32}],18:[function(e,t,i){(function(i){(function(){let n=e("./constants"),a=e("./crc"),r=t.exports=function(e,t){this._options=e,e.checkCRC=!1!==e.checkCRC,this._hasIHDR=!1,this._hasIEND=!1,this._emittedHeadersFinished=!1,this._palette=[],this._colorType=0,this._chunks={},this._chunks[n.TYPE_IHDR]=this._handleIHDR.bind(this),this._chunks[n.TYPE_IEND]=this._handleIEND.bind(this),this._chunks[n.TYPE_IDAT]=this._handleIDAT.bind(this),this._chunks[n.TYPE_PLTE]=this._handlePLTE.bind(this),this._chunks[n.TYPE_tRNS]=this._handleTRNS.bind(this),this._chunks[n.TYPE_gAMA]=this._handleGAMA.bind(this),this.read=t.read,this.error=t.error,this.metadata=t.metadata,this.gamma=t.gamma,this.transColor=t.transColor,this.palette=t.palette,this.parsed=t.parsed,this.inflateData=t.inflateData,this.finished=t.finished,this.simpleTransparency=t.simpleTransparency,this.headersFinished=t.headersFinished||function(){}};r.prototype.start=function(){this.read(n.PNG_SIGNATURE.length,this._parseSignature.bind(this))},r.prototype._parseSignature=function(e){let t=n.PNG_SIGNATURE;for(let i=0;i<t.length;i++)if(e[i]!==t[i])return void this.error(new Error("Invalid file signature"));this.read(8,this._parseChunkBegin.bind(this))},r.prototype._parseChunkBegin=function(e){let t=e.readUInt32BE(0),r=e.readUInt32BE(4),s="";for(let t=4;t<8;t++)s+=String.fromCharCode(e[t]);let o=Boolean(32&e[4]);if(this._hasIHDR||r===n.TYPE_IHDR){if(this._crc=new a,this._crc.write(i.from(s)),this._chunks[r])return this._chunks[r](t);o?this.read(t+4,this._skipChunk.bind(this)):this.error(new Error("Unsupported critical chunk type "+s))}else this.error(new Error("Expected IHDR on beggining"))},r.prototype._skipChunk=function(){this.read(8,this._parseChunkBegin.bind(this))},r.prototype._handleChunkEnd=function(){this.read(4,this._parseChunkEnd.bind(this))},r.prototype._parseChunkEnd=function(e){let t=e.readInt32BE(0),i=this._crc.crc32();this._options.checkCRC&&i!==t?this.error(new Error("Crc error - "+t+" - "+i)):this._hasIEND||this.read(8,this._parseChunkBegin.bind(this))},r.prototype._handleIHDR=function(e){this.read(e,this._parseIHDR.bind(this))},r.prototype._parseIHDR=function(e){this._crc.write(e);let t=e.readUInt32BE(0),i=e.readUInt32BE(4),a=e[8],r=e[9],s=e[10],o=e[11],l=e[12];if(8!==a&&4!==a&&2!==a&&1!==a&&16!==a)return void this.error(new Error("Unsupported bit depth "+a));if(!(r in n.COLORTYPE_TO_BPP_MAP))return void this.error(new Error("Unsupported color type"));if(0!==s)return void this.error(new Error("Unsupported compression method"));if(0!==o)return void this.error(new Error("Unsupported filter method"));if(0!==l&&1!==l)return void this.error(new Error("Unsupported interlace method"));this._colorType=r;let c=n.COLORTYPE_TO_BPP_MAP[this._colorType];this._hasIHDR=!0,this.metadata({width:t,height:i,depth:a,interlace:Boolean(l),palette:Boolean(r&n.COLORTYPE_PALETTE),color:Boolean(r&n.COLORTYPE_COLOR),alpha:Boolean(r&n.COLORTYPE_ALPHA),bpp:c,colorType:r}),this._handleChunkEnd()},r.prototype._handlePLTE=function(e){this.read(e,this._parsePLTE.bind(this))},r.prototype._parsePLTE=function(e){this._crc.write(e);let t=Math.floor(e.length/3);for(let i=0;i<t;i++)this._palette.push([e[3*i],e[3*i+1],e[3*i+2],255]);this.palette(this._palette),this._handleChunkEnd()},r.prototype._handleTRNS=function(e){this.simpleTransparency(),this.read(e,this._parseTRNS.bind(this))},r.prototype._parseTRNS=function(e){if(this._crc.write(e),this._colorType===n.COLORTYPE_PALETTE_COLOR){if(0===this._palette.length)return void this.error(new Error("Transparency chunk must be after palette"));if(e.length>this._palette.length)return void this.error(new Error("More transparent colors than palette size"));for(let t=0;t<e.length;t++)this._palette[t][3]=e[t];this.palette(this._palette)}this._colorType===n.COLORTYPE_GRAYSCALE&&this.transColor([e.readUInt16BE(0)]),this._colorType===n.COLORTYPE_COLOR&&this.transColor([e.readUInt16BE(0),e.readUInt16BE(2),e.readUInt16BE(4)]),this._handleChunkEnd()},r.prototype._handleGAMA=function(e){this.read(e,this._parseGAMA.bind(this))},r.prototype._parseGAMA=function(e){this._crc.write(e),this.gamma(e.readUInt32BE(0)/n.GAMMA_DIVISION),this._handleChunkEnd()},r.prototype._handleIDAT=function(e){this._emittedHeadersFinished||(this._emittedHeadersFinished=!0,this.headersFinished()),this.read(-e,this._parseIDAT.bind(this,e))},r.prototype._parseIDAT=function(e,t){if(this._crc.write(t),this._colorType===n.COLORTYPE_PALETTE_COLOR&&0===this._palette.length)throw new Error("Expected palette not found");this.inflateData(t);let i=e-t.length;i>0?this._handleIDAT(i):this._handleChunkEnd()},r.prototype._handleIEND=function(e){this.read(e,this._parseIEND.bind(this))},r.prototype._parseIEND=function(e){this._crc.write(e),this._hasIEND=!0,this._handleChunkEnd(),this.finished&&this.finished()}}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":4,"./crc":5,buffer:33}],19:[function(e,t,i){let n=e("./parser-sync"),a=e("./packer-sync");i.read=function(e,t){return n(e,t||{})},i.write=function(e,t){return a(e,t)}},{"./packer-sync":13,"./parser-sync":17}],20:[function(e,t,i){(function(t,n){(function(){let a=e("util"),r=e("stream"),s=e("./parser-async"),o=e("./packer-async"),l=e("./png-sync"),c=i.PNG=function(e){r.call(this),e=e||{},this.width=0|e.width,this.height=0|e.height,this.data=this.width>0&&this.height>0?n.alloc(4*this.width*this.height):null,e.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new s(e),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(e){this.data=e,this.emit("parsed",e)}.bind(this)),this._packer=new o(e),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};a.inherits(c,r),c.sync=l,c.prototype.pack=function(){return this.data&&this.data.length?(t.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this):(this.emit("error","No data provided"),this)},c.prototype.parse=function(e,t){if(t){let e,i;e=function(e){this.removeListener("error",i),this.data=e,t(null,this)}.bind(this),i=function(i){this.removeListener("parsed",e),t(i,null)}.bind(this),this.once("parsed",e),this.once("error",i)}return this.end(e),this},c.prototype.write=function(e){return this._parser.write(e),!0},c.prototype.end=function(e){this._parser.end(e)},c.prototype._metadata=function(e){this.width=e.width,this.height=e.height,this.emit("metadata",e)},c.prototype._gamma=function(e){this.gamma=e},c.prototype._handleClose=function(){this._parser.writable||this._packer.readable||this.emit("close")},c.bitblt=function(e,t,i,n,a,r,s,o){if(n|=0,a|=0,r|=0,s|=0,o|=0,(i|=0)>e.width||n>e.height||i+a>e.width||n+r>e.height)throw new Error("bitblt reading outside image");if(s>t.width||o>t.height||s+a>t.width||o+r>t.height)throw new Error("bitblt writing outside image");for(let l=0;l<r;l++)e.data.copy(t.data,(o+l)*t.width+s<<2,(n+l)*e.width+i<<2,(n+l)*e.width+i+a<<2)},c.prototype.bitblt=function(e,t,i,n,a,r,s){return c.bitblt(this,e,t,i,n,a,r,s),this},c.adjustGamma=function(e){if(e.gamma){for(let t=0;t<e.height;t++)for(let i=0;i<e.width;i++){let n=e.width*t+i<<2;for(let t=0;t<3;t++){let i=e.data[n+t]/255;i=Math.pow(i,1/2.2/e.gamma),e.data[n+t]=Math.round(255*i)}}e.gamma=0}},c.prototype.adjustGamma=function(){c.adjustGamma(this)}}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{"./packer-async":12,"./parser-async":16,"./png-sync":19,_process:60,buffer:33,stream:61,util:81}],21:[function(e,t,i){(function(n,a){(function(){let r=e("assert").ok,s=e("zlib"),o=e("util"),l=e("buffer").kMaxLength;function c(e){if(!(this instanceof c))return new c(e);e&&e.chunkSize<s.Z_MIN_CHUNK&&(e.chunkSize=s.Z_MIN_CHUNK),s.Inflate.call(this,e),this._offset=void 0===this._offset?this._outOffset:this._offset,this._buffer=this._buffer||this._outBuffer,e&&null!=e.maxLength&&(this._maxLength=e.maxLength)}function h(e){return new c(e)}function u(e,t){t&&n.nextTick(t),e._handle&&(e._handle.close(),e._handle=null)}function d(e,t){if("string"==typeof t&&(t=a.from(t)),!(t instanceof a))throw new TypeError("Not a string or buffer");let i=e._finishFlushFlag;return null==i&&(i=s.Z_FINISH),e._processChunk(t,i)}function p(e,t){return d(new c(t),e)}c.prototype._processChunk=function(e,t,i){if("function"==typeof i)return s.Inflate._processChunk.call(this,e,t,i);let n,o,c=this,h=e&&e.length,d=this._chunkSize-this._offset,p=this._maxLength,m=0,f=[],g=0;function y(e,t){if(c._hadError)return;let i=d-t;if(r(i>=0,"have should not go down"),i>0){let e=c._buffer.slice(c._offset,c._offset+i);if(c._offset+=i,e.length>p&&(e=e.slice(0,p)),f.push(e),g+=e.length,p-=e.length,0===p)return!1}return(0===t||c._offset>=c._chunkSize)&&(d=c._chunkSize,c._offset=0,c._buffer=a.allocUnsafe(c._chunkSize)),0===t&&(m+=h-e,h=e,!0)}this.on("error",(function(e){n=e})),r(this._handle,"zlib binding closed");do{o=this._handle.writeSync(t,e,m,h,this._buffer,this._offset,d),o=o||this._writeState}while(!this._hadError&&y(o[0],o[1]));if(this._hadError)throw n;if(g>=l)throw u(this),new RangeError("Cannot create final Buffer. It would be larger than 0x"+l.toString(16)+" bytes");let v=a.concat(f,g);return u(this),v},o.inherits(c,s.Inflate),t.exports=i=p,i.Inflate=c,i.createInflate=h,i.inflateSync=p}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:60,assert:23,buffer:33,util:81,zlib:32}],22:[function(e,t,i){let n=t.exports=function(e){this._buffer=e,this._reads=[]};n.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t})},n.prototype.process=function(){for(;this._reads.length>0&&this._buffer.length;){let e=this._reads[0];if(!this._buffer.length||!(this._buffer.length>=e.length||e.allowLess))break;{this._reads.shift();let t=this._buffer;this._buffer=t.slice(e.length),e.func.call(this,t.slice(0,e.length))}}if(this._reads.length>0)throw new Error("There are some read requests waitng on finished stream");if(this._buffer.length>0)throw new Error("unrecognised content at end of stream")}},{}],23:[function(e,t,i){(function(i){(function(){
/*!
   * The buffer module from node.js, for the browser.
   *
   * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
   * @license  MIT
   */
function n(e,t){if(e===t)return 0;for(var i=e.length,n=t.length,a=0,r=Math.min(i,n);a<r;++a)if(e[a]!==t[a]){i=e[a],n=t[a];break}return i<n?-1:n<i?1:0}function a(e){return i.Buffer&&"function"==typeof i.Buffer.isBuffer?i.Buffer.isBuffer(e):!(null==e||!e._isBuffer)}var r=e("util/"),s=Object.prototype.hasOwnProperty,o=Array.prototype.slice,l="foo"===function(){}.name;function c(e){return Object.prototype.toString.call(e)}function h(e){return!a(e)&&"function"==typeof i.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer)))}var u=t.exports=v,d=/\s*function\s+([^\(\s]*)\s*/;function p(e){if(r.isFunction(e)){if(l)return e.name;var t=e.toString().match(d);return t&&t[1]}}function m(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function f(e){if(l||!r.isFunction(e))return r.inspect(e);var t=p(e);return"[Function"+(t?": "+t:"")+"]"}function g(e){return m(f(e.actual),128)+" "+e.operator+" "+m(f(e.expected),128)}function y(e,t,i,n,a){throw new u.AssertionError({message:i,actual:e,expected:t,operator:n,stackStartFunction:a})}function v(e,t){e||y(e,!0,t,"==",u.ok)}function b(e,t,i,s){if(e===t)return!0;if(a(e)&&a(t))return 0===n(e,t);if(r.isDate(e)&&r.isDate(t))return e.getTime()===t.getTime();if(r.isRegExp(e)&&r.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(h(e)&&h(t)&&c(e)===c(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===n(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(a(e)!==a(t))return!1;var o=(s=s||{actual:[],expected:[]}).actual.indexOf(e);return-1!==o&&o===s.expected.indexOf(t)||(s.actual.push(e),s.expected.push(t),x(e,t,i,s))}return i?e===t:e==t}function _(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function x(e,t,i,n){if(null==e||null==t)return!1;if(r.isPrimitive(e)||r.isPrimitive(t))return e===t;if(i&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var a=_(e),s=_(t);if(a&&!s||!a&&s)return!1;if(a)return b(e=o.call(e),t=o.call(t),i);var l,c,h=A(e),u=A(t);if(h.length!==u.length)return!1;for(h.sort(),u.sort(),c=h.length-1;c>=0;c--)if(h[c]!==u[c])return!1;for(c=h.length-1;c>=0;c--)if(!b(e[l=h[c]],t[l],i,n))return!1;return!0}function w(e,t,i){b(e,t,!0)&&y(e,t,i,"notDeepStrictEqual",w)}function S(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function M(e){var t;try{e()}catch(e){t=e}return t}function T(e,t,i,n){var a;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof i&&(n=i,i=null),a=M(t),n=(i&&i.name?" ("+i.name+").":".")+(n?" "+n:"."),e&&!a&&y(a,i,"Missing expected exception"+n);var s="string"==typeof n,o=!e&&a&&!i;if((!e&&r.isError(a)&&s&&S(a,i)||o)&&y(a,i,"Got unwanted exception"+n),e&&a&&i&&!S(a,i)||!e&&a)throw a}u.AssertionError=function(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=g(this),this.generatedMessage=!0);var t=e.stackStartFunction||y;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var i=new Error;if(i.stack){var n=i.stack,a=p(t),r=n.indexOf("\n"+a);if(r>=0){var s=n.indexOf("\n",r+1);n=n.substring(s+1)}this.stack=n}}},r.inherits(u.AssertionError,Error),u.fail=y,u.ok=v,u.equal=function(e,t,i){e!=t&&y(e,t,i,"==",u.equal)},u.notEqual=function(e,t,i){e==t&&y(e,t,i,"!=",u.notEqual)},u.deepEqual=function(e,t,i){b(e,t,!1)||y(e,t,i,"deepEqual",u.deepEqual)},u.deepStrictEqual=function(e,t,i){b(e,t,!0)||y(e,t,i,"deepStrictEqual",u.deepStrictEqual)},u.notDeepEqual=function(e,t,i){b(e,t,!1)&&y(e,t,i,"notDeepEqual",u.notDeepEqual)},u.notDeepStrictEqual=w,u.strictEqual=function(e,t,i){e!==t&&y(e,t,i,"===",u.strictEqual)},u.notStrictEqual=function(e,t,i){e===t&&y(e,t,i,"!==",u.notStrictEqual)},u.throws=function(e,t,i){T(!0,e,t,i)},u.doesNotThrow=function(e,t,i){T(!1,e,t,i)},u.ifError=function(e){if(e)throw e};var A=Object.keys||function(e){var t=[];for(var i in e)s.call(e,i)&&t.push(i);return t}}).call(this)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"util/":26}],24:[function(e,t,i){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}},{}],25:[function(e,t,i){t.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},{}],26:[function(e,t,i){(function(t,n){(function(){var a=/%[sdj%]/g;i.format=function(e){if(!w(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(o(arguments[i]));return t.join(" ")}i=1;for(var n=arguments,r=n.length,s=String(e).replace(a,(function(e){if("%%"===e)return"%";if(i>=r)return e;switch(e){case"%s":return String(n[i++]);case"%d":return Number(n[i++]);case"%j":try{return JSON.stringify(n[i++])}catch(e){return"[Circular]"}default:return e}})),l=n[i];i<r;l=n[++i])b(l)||!A(l)?s+=" "+l:s+=" "+o(l);return s},i.deprecate=function(e,a){if(M(n.process))return function(){return i.deprecate(e,a).apply(this,arguments)};if(!0===t.noDeprecation)return e;var r=!1;function s(){if(!r){if(t.throwDeprecation)throw new Error(a);t.traceDeprecation?console.trace(a):console.error(a),r=!0}return e.apply(this,arguments)}return s};var r,s={};function o(e,t){var n={seen:[],stylize:c};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),v(t)?n.showHidden=t:t&&i._extend(n,t),M(n.showHidden)&&(n.showHidden=!1),M(n.depth)&&(n.depth=2),M(n.colors)&&(n.colors=!1),M(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=l),u(n,e,n.depth)}function l(e,t){var i=o.styles[t];return i?"["+o.colors[i][0]+"m"+e+"["+o.colors[i][1]+"m":e}function c(e,t){return e}function h(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}function u(e,t,n){if(e.customInspect&&t&&I(t.inspect)&&t.inspect!==i.inspect&&(!t.constructor||t.constructor.prototype!==t)){var a=t.inspect(n,e);return w(a)||(a=u(e,a,n)),a}var r=d(e,t);if(r)return r;var s=Object.keys(t),o=h(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(t)),C(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return p(t);if(0===s.length){if(I(t)){var l=t.name?": "+t.name:"";return e.stylize("[Function"+l+"]","special")}if(T(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(E(t))return e.stylize(Date.prototype.toString.call(t),"date");if(C(t))return p(t)}var c,v="",b=!1,_=["{","}"];return y(t)&&(b=!0,_=["[","]"]),I(t)&&(v=" [Function"+(t.name?": "+t.name:"")+"]"),T(t)&&(v=" "+RegExp.prototype.toString.call(t)),E(t)&&(v=" "+Date.prototype.toUTCString.call(t)),C(t)&&(v=" "+p(t)),0!==s.length||b&&0!=t.length?n<0?T(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),c=b?m(e,t,n,o,s):s.map((function(i){return f(e,t,n,o,i,b)})),e.seen.pop(),g(c,v,_)):_[0]+v+_[1]}function d(e,t){if(M(t))return e.stylize("undefined","undefined");if(w(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return x(t)?e.stylize(""+t,"number"):v(t)?e.stylize(""+t,"boolean"):b(t)?e.stylize("null","null"):void 0}function p(e){return"["+Error.prototype.toString.call(e)+"]"}function m(e,t,i,n,a){for(var r=[],s=0,o=t.length;s<o;++s)k(t,String(s))?r.push(f(e,t,i,n,String(s),!0)):r.push("");return a.forEach((function(a){a.match(/^\d+$/)||r.push(f(e,t,i,n,a,!0))})),r}function f(e,t,i,n,a,r){var s,o,l;if((l=Object.getOwnPropertyDescriptor(t,a)||{value:t[a]}).get?o=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(o=e.stylize("[Setter]","special")),k(n,a)||(s="["+a+"]"),o||(e.seen.indexOf(l.value)<0?(o=b(i)?u(e,l.value,null):u(e,l.value,i-1)).indexOf("\n")>-1&&(o=r?o.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+o.split("\n").map((function(e){return"   "+e})).join("\n")):o=e.stylize("[Circular]","special")),M(s)){if(r&&a.match(/^\d+$/))return o;(s=JSON.stringify(""+a)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+o}function g(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]}function y(e){return Array.isArray(e)}function v(e){return"boolean"==typeof e}function b(e){return null===e}function _(e){return null==e}function x(e){return"number"==typeof e}function w(e){return"string"==typeof e}function S(e){return"symbol"==typeof e}function M(e){return void 0===e}function T(e){return A(e)&&"[object RegExp]"===R(e)}function A(e){return"object"==typeof e&&null!==e}function E(e){return A(e)&&"[object Date]"===R(e)}function C(e){return A(e)&&("[object Error]"===R(e)||e instanceof Error)}function I(e){return"function"==typeof e}function P(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function R(e){return Object.prototype.toString.call(e)}function O(e){return e<10?"0"+e.toString(10):e.toString(10)}i.debuglog=function(e){if(M(r)&&(r=t.env.NODE_DEBUG||""),e=e.toUpperCase(),!s[e])if(new RegExp("\\b"+e+"\\b","i").test(r)){var n=t.pid;s[e]=function(){var t=i.format.apply(i,arguments);console.error("%s %d: %s",e,n,t)}}else s[e]=function(){};return s[e]},i.inspect=o,o.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},o.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},i.isArray=y,i.isBoolean=v,i.isNull=b,i.isNullOrUndefined=_,i.isNumber=x,i.isString=w,i.isSymbol=S,i.isUndefined=M,i.isRegExp=T,i.isObject=A,i.isDate=E,i.isError=C,i.isFunction=I,i.isPrimitive=P,i.isBuffer=e("./support/isBuffer");var D=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function L(){var e=new Date,t=[O(e.getHours()),O(e.getMinutes()),O(e.getSeconds())].join(":");return[e.getDate(),D[e.getMonth()],t].join(" ")}function k(e,t){return Object.prototype.hasOwnProperty.call(e,t)}i.log=function(){console.log("%s - %s",L(),i.format.apply(i,arguments))},i.inherits=e("inherits"),i._extend=function(e,t){if(!t||!A(t))return e;for(var i=Object.keys(t),n=i.length;n--;)e[i[n]]=t[i[n]];return e}}).call(this)}).call(this,e("_process"),void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":25,_process:60,inherits:24}],27:[function(e,t,i){(function(i){(function(){var n=e("array-filter");t.exports=function(){return n(["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],(function(e){return"function"==typeof i[e]}))}}).call(this)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"array-filter":28}],28:[function(e,t,i){t.exports=function(e,t,i){if(e.filter)return e.filter(t,i);if(null==e)throw new TypeError;if("function"!=typeof t)throw new TypeError;for(var a=[],r=0;r<e.length;r++)if(n.call(e,r)){var s=e[r];t.call(i,s,r,e)&&a.push(s)}return a};var n=Object.prototype.hasOwnProperty},{}],29:[function(e,t,i){i.byteLength=h,i.toByteArray=d,i.fromByteArray=f;for(var n=[],a=[],r="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,l=s.length;o<l;++o)n[o]=s[o],a[s.charCodeAt(o)]=o;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function h(e){var t=c(e),i=t[0],n=t[1];return 3*(i+n)/4-n}function u(e,t,i){return 3*(t+i)/4-i}function d(e){var t,i,n=c(e),s=n[0],o=n[1],l=new r(u(e,s,o)),h=0,d=o>0?s-4:s;for(i=0;i<d;i+=4)t=a[e.charCodeAt(i)]<<18|a[e.charCodeAt(i+1)]<<12|a[e.charCodeAt(i+2)]<<6|a[e.charCodeAt(i+3)],l[h++]=t>>16&255,l[h++]=t>>8&255,l[h++]=255&t;return 2===o&&(t=a[e.charCodeAt(i)]<<2|a[e.charCodeAt(i+1)]>>4,l[h++]=255&t),1===o&&(t=a[e.charCodeAt(i)]<<10|a[e.charCodeAt(i+1)]<<4|a[e.charCodeAt(i+2)]>>2,l[h++]=t>>8&255,l[h++]=255&t),l}function p(e){return n[e>>18&63]+n[e>>12&63]+n[e>>6&63]+n[63&e]}function m(e,t,i){for(var n,a=[],r=t;r<i;r+=3)n=(e[r]<<16&16711680)+(e[r+1]<<8&65280)+(255&e[r+2]),a.push(p(n));return a.join("")}function f(e){for(var t,i=e.length,a=i%3,r=[],s=16383,o=0,l=i-a;o<l;o+=s)r.push(m(e,o,o+s>l?l:o+s));return 1===a?(t=e[i-1],r.push(n[t>>2]+n[t<<4&63]+"==")):2===a&&(t=(e[i-2]<<8)+e[i-1],r.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),r.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63},{}],30:[function(e,t,i){},{}],31:[function(e,t,i){(function(t,n){(function(){var a=e("assert"),r=e("pako/lib/zlib/zstream"),s=e("pako/lib/zlib/deflate.js"),o=e("pako/lib/zlib/inflate.js"),l=e("pako/lib/zlib/constants");for(var c in l)i[c]=l[c];i.NONE=0,i.DEFLATE=1,i.INFLATE=2,i.GZIP=3,i.GUNZIP=4,i.DEFLATERAW=5,i.INFLATERAW=6,i.UNZIP=7;var h=31,u=139;function d(e){if("number"!=typeof e||e<i.DEFLATE||e>i.UNZIP)throw new TypeError("Bad argument");this.dictionary=null,this.err=0,this.flush=0,this.init_done=!1,this.level=0,this.memLevel=0,this.mode=e,this.strategy=0,this.windowBits=0,this.write_in_progress=!1,this.pending_close=!1,this.gzip_id_bytes_read=0}d.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,a(this.init_done,"close before init"),a(this.mode<=i.UNZIP),this.mode===i.DEFLATE||this.mode===i.GZIP||this.mode===i.DEFLATERAW?s.deflateEnd(this.strm):this.mode!==i.INFLATE&&this.mode!==i.GUNZIP&&this.mode!==i.INFLATERAW&&this.mode!==i.UNZIP||o.inflateEnd(this.strm),this.mode=i.NONE,this.dictionary=null)},d.prototype.write=function(e,t,i,n,a,r,s){return this._write(!0,e,t,i,n,a,r,s)},d.prototype.writeSync=function(e,t,i,n,a,r,s){return this._write(!1,e,t,i,n,a,r,s)},d.prototype._write=function(e,r,s,o,l,c,h,u){if(a.equal(arguments.length,8),a(this.init_done,"write before init"),a(this.mode!==i.NONE,"already finalized"),a.equal(!1,this.write_in_progress,"write already in progress"),a.equal(!1,this.pending_close,"close is pending"),this.write_in_progress=!0,a.equal(!1,void 0===r,"must provide flush value"),this.write_in_progress=!0,r!==i.Z_NO_FLUSH&&r!==i.Z_PARTIAL_FLUSH&&r!==i.Z_SYNC_FLUSH&&r!==i.Z_FULL_FLUSH&&r!==i.Z_FINISH&&r!==i.Z_BLOCK)throw new Error("Invalid flush value");if(null==s&&(s=n.alloc(0),l=0,o=0),this.strm.avail_in=l,this.strm.input=s,this.strm.next_in=o,this.strm.avail_out=u,this.strm.output=c,this.strm.next_out=h,this.flush=r,!e)return this._process(),this._checkError()?this._afterSync():void 0;var d=this;return t.nextTick((function(){d._process(),d._after()})),this},d.prototype._afterSync=function(){var e=this.strm.avail_out,t=this.strm.avail_in;return this.write_in_progress=!1,[t,e]},d.prototype._process=function(){var e=null;switch(this.mode){case i.DEFLATE:case i.GZIP:case i.DEFLATERAW:this.err=s.deflate(this.strm,this.flush);break;case i.UNZIP:switch(this.strm.avail_in>0&&(e=this.strm.next_in),this.gzip_id_bytes_read){case 0:if(null===e)break;if(this.strm.input[e]!==h){this.mode=i.INFLATE;break}if(this.gzip_id_bytes_read=1,e++,1===this.strm.avail_in)break;case 1:if(null===e)break;this.strm.input[e]===u?(this.gzip_id_bytes_read=2,this.mode=i.GUNZIP):this.mode=i.INFLATE;break;default:throw new Error("invalid number of gzip magic number bytes read")}case i.INFLATE:case i.GUNZIP:case i.INFLATERAW:for(this.err=o.inflate(this.strm,this.flush),this.err===i.Z_NEED_DICT&&this.dictionary&&(this.err=o.inflateSetDictionary(this.strm,this.dictionary),this.err===i.Z_OK?this.err=o.inflate(this.strm,this.flush):this.err===i.Z_DATA_ERROR&&(this.err=i.Z_NEED_DICT));this.strm.avail_in>0&&this.mode===i.GUNZIP&&this.err===i.Z_STREAM_END&&0!==this.strm.next_in[0];)this.reset(),this.err=o.inflate(this.strm,this.flush);break;default:throw new Error("Unknown mode "+this.mode)}},d.prototype._checkError=function(){switch(this.err){case i.Z_OK:case i.Z_BUF_ERROR:if(0!==this.strm.avail_out&&this.flush===i.Z_FINISH)return this._error("unexpected end of file"),!1;break;case i.Z_STREAM_END:break;case i.Z_NEED_DICT:return null==this.dictionary?this._error("Missing dictionary"):this._error("Bad dictionary"),!1;default:return this._error("Zlib error"),!1}return!0},d.prototype._after=function(){if(this._checkError()){var e=this.strm.avail_out,t=this.strm.avail_in;this.write_in_progress=!1,this.callback(t,e),this.pending_close&&this.close()}},d.prototype._error=function(e){this.strm.msg&&(e=this.strm.msg),this.onerror(e,this.err),this.write_in_progress=!1,this.pending_close&&this.close()},d.prototype.init=function(e,t,n,r,s){a(4===arguments.length||5===arguments.length,"init(windowBits, level, memLevel, strategy, [dictionary])"),a(e>=8&&e<=15,"invalid windowBits"),a(t>=-1&&t<=9,"invalid compression level"),a(n>=1&&n<=9,"invalid memlevel"),a(r===i.Z_FILTERED||r===i.Z_HUFFMAN_ONLY||r===i.Z_RLE||r===i.Z_FIXED||r===i.Z_DEFAULT_STRATEGY,"invalid strategy"),this._init(t,e,n,r,s),this._setDictionary()},d.prototype.params=function(){throw new Error("deflateParams Not supported")},d.prototype.reset=function(){this._reset(),this._setDictionary()},d.prototype._init=function(e,t,n,a,l){switch(this.level=e,this.windowBits=t,this.memLevel=n,this.strategy=a,this.flush=i.Z_NO_FLUSH,this.err=i.Z_OK,this.mode!==i.GZIP&&this.mode!==i.GUNZIP||(this.windowBits+=16),this.mode===i.UNZIP&&(this.windowBits+=32),this.mode!==i.DEFLATERAW&&this.mode!==i.INFLATERAW||(this.windowBits=-1*this.windowBits),this.strm=new r,this.mode){case i.DEFLATE:case i.GZIP:case i.DEFLATERAW:this.err=s.deflateInit2(this.strm,this.level,i.Z_DEFLATED,this.windowBits,this.memLevel,this.strategy);break;case i.INFLATE:case i.GUNZIP:case i.INFLATERAW:case i.UNZIP:this.err=o.inflateInit2(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}this.err!==i.Z_OK&&this._error("Init error"),this.dictionary=l,this.write_in_progress=!1,this.init_done=!0},d.prototype._setDictionary=function(){if(null!=this.dictionary){switch(this.err=i.Z_OK,this.mode){case i.DEFLATE:case i.DEFLATERAW:this.err=s.deflateSetDictionary(this.strm,this.dictionary)}this.err!==i.Z_OK&&this._error("Failed to set dictionary")}},d.prototype._reset=function(){switch(this.err=i.Z_OK,this.mode){case i.DEFLATE:case i.DEFLATERAW:case i.GZIP:this.err=s.deflateReset(this.strm);break;case i.INFLATE:case i.INFLATERAW:case i.GUNZIP:this.err=o.inflateReset(this.strm)}this.err!==i.Z_OK&&this._error("Failed to reset stream")},i.Zlib=d}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:60,assert:23,buffer:33,"pako/lib/zlib/constants":51,"pako/lib/zlib/deflate.js":53,"pako/lib/zlib/inflate.js":55,"pako/lib/zlib/zstream":59}],32:[function(e,t,i){(function(t){(function(){var n=e("buffer").Buffer,a=e("stream").Transform,r=e("./binding"),s=e("util"),o=e("assert").ok,l=e("buffer").kMaxLength,c="Cannot create final Buffer. It would be larger than 0x"+l.toString(16)+" bytes";r.Z_MIN_WINDOWBITS=8,r.Z_MAX_WINDOWBITS=15,r.Z_DEFAULT_WINDOWBITS=15,r.Z_MIN_CHUNK=64,r.Z_MAX_CHUNK=1/0,r.Z_DEFAULT_CHUNK=16384,r.Z_MIN_MEMLEVEL=1,r.Z_MAX_MEMLEVEL=9,r.Z_DEFAULT_MEMLEVEL=8,r.Z_MIN_LEVEL=-1,r.Z_MAX_LEVEL=9,r.Z_DEFAULT_LEVEL=r.Z_DEFAULT_COMPRESSION;for(var h=Object.keys(r),u=0;u<h.length;u++){var d=h[u];d.match(/^Z/)&&Object.defineProperty(i,d,{enumerable:!0,value:r[d],writable:!1})}for(var p={Z_OK:r.Z_OK,Z_STREAM_END:r.Z_STREAM_END,Z_NEED_DICT:r.Z_NEED_DICT,Z_ERRNO:r.Z_ERRNO,Z_STREAM_ERROR:r.Z_STREAM_ERROR,Z_DATA_ERROR:r.Z_DATA_ERROR,Z_MEM_ERROR:r.Z_MEM_ERROR,Z_BUF_ERROR:r.Z_BUF_ERROR,Z_VERSION_ERROR:r.Z_VERSION_ERROR},m=Object.keys(p),f=0;f<m.length;f++){var g=m[f];p[p[g]]=g}function y(e,t,i){var a=[],r=0;function s(){for(var t;null!==(t=e.read());)a.push(t),r+=t.length;e.once("readable",s)}function o(t){e.removeListener("end",h),e.removeListener("readable",s),i(t)}function h(){var t,s=null;r>=l?s=new RangeError(c):t=n.concat(a,r),a=[],e.close(),i(s,t)}e.on("error",o),e.on("end",h),e.end(t),s()}function v(e,t){if("string"==typeof t&&(t=n.from(t)),!n.isBuffer(t))throw new TypeError("Not a string or buffer");var i=e._finishFlushFlag;return e._processChunk(t,i)}function b(e){if(!(this instanceof b))return new b(e);E.call(this,e,r.DEFLATE)}function _(e){if(!(this instanceof _))return new _(e);E.call(this,e,r.INFLATE)}function x(e){if(!(this instanceof x))return new x(e);E.call(this,e,r.GZIP)}function w(e){if(!(this instanceof w))return new w(e);E.call(this,e,r.GUNZIP)}function S(e){if(!(this instanceof S))return new S(e);E.call(this,e,r.DEFLATERAW)}function M(e){if(!(this instanceof M))return new M(e);E.call(this,e,r.INFLATERAW)}function T(e){if(!(this instanceof T))return new T(e);E.call(this,e,r.UNZIP)}function A(e){return e===r.Z_NO_FLUSH||e===r.Z_PARTIAL_FLUSH||e===r.Z_SYNC_FLUSH||e===r.Z_FULL_FLUSH||e===r.Z_FINISH||e===r.Z_BLOCK}function E(e,t){var s=this;if(this._opts=e=e||{},this._chunkSize=e.chunkSize||i.Z_DEFAULT_CHUNK,a.call(this,e),e.flush&&!A(e.flush))throw new Error("Invalid flush flag: "+e.flush);if(e.finishFlush&&!A(e.finishFlush))throw new Error("Invalid flush flag: "+e.finishFlush);if(this._flushFlag=e.flush||r.Z_NO_FLUSH,this._finishFlushFlag=void 0!==e.finishFlush?e.finishFlush:r.Z_FINISH,e.chunkSize&&(e.chunkSize<i.Z_MIN_CHUNK||e.chunkSize>i.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<i.Z_MIN_WINDOWBITS||e.windowBits>i.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<i.Z_MIN_LEVEL||e.level>i.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<i.Z_MIN_MEMLEVEL||e.memLevel>i.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=i.Z_FILTERED&&e.strategy!=i.Z_HUFFMAN_ONLY&&e.strategy!=i.Z_RLE&&e.strategy!=i.Z_FIXED&&e.strategy!=i.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!n.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._handle=new r.Zlib(t);var o=this;this._hadError=!1,this._handle.onerror=function(e,t){C(o),o._hadError=!0;var n=new Error(e);n.errno=t,n.code=i.codes[t],o.emit("error",n)};var l=i.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(l=e.level);var c=i.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(c=e.strategy),this._handle.init(e.windowBits||i.Z_DEFAULT_WINDOWBITS,l,e.memLevel||i.Z_DEFAULT_MEMLEVEL,c,e.dictionary),this._buffer=n.allocUnsafe(this._chunkSize),this._offset=0,this._level=l,this._strategy=c,this.once("end",this.close),Object.defineProperty(this,"_closed",{get:function(){return!s._handle},configurable:!0,enumerable:!0})}function C(e,i){i&&t.nextTick(i),e._handle&&(e._handle.close(),e._handle=null)}function I(e){e.emit("close")}Object.defineProperty(i,"codes",{enumerable:!0,value:Object.freeze(p),writable:!1}),i.Deflate=b,i.Inflate=_,i.Gzip=x,i.Gunzip=w,i.DeflateRaw=S,i.InflateRaw=M,i.Unzip=T,i.createDeflate=function(e){return new b(e)},i.createInflate=function(e){return new _(e)},i.createDeflateRaw=function(e){return new S(e)},i.createInflateRaw=function(e){return new M(e)},i.createGzip=function(e){return new x(e)},i.createGunzip=function(e){return new w(e)},i.createUnzip=function(e){return new T(e)},i.deflate=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new b(t),e,i)},i.deflateSync=function(e,t){return v(new b(t),e)},i.gzip=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new x(t),e,i)},i.gzipSync=function(e,t){return v(new x(t),e)},i.deflateRaw=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new S(t),e,i)},i.deflateRawSync=function(e,t){return v(new S(t),e)},i.unzip=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new T(t),e,i)},i.unzipSync=function(e,t){return v(new T(t),e)},i.inflate=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new _(t),e,i)},i.inflateSync=function(e,t){return v(new _(t),e)},i.gunzip=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new w(t),e,i)},i.gunzipSync=function(e,t){return v(new w(t),e)},i.inflateRaw=function(e,t,i){return"function"==typeof t&&(i=t,t={}),y(new M(t),e,i)},i.inflateRawSync=function(e,t){return v(new M(t),e)},s.inherits(E,a),E.prototype.params=function(e,n,a){if(e<i.Z_MIN_LEVEL||e>i.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(n!=i.Z_FILTERED&&n!=i.Z_HUFFMAN_ONLY&&n!=i.Z_RLE&&n!=i.Z_FIXED&&n!=i.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+n);if(this._level!==e||this._strategy!==n){var s=this;this.flush(r.Z_SYNC_FLUSH,(function(){o(s._handle,"zlib binding closed"),s._handle.params(e,n),s._hadError||(s._level=e,s._strategy=n,a&&a())}))}else t.nextTick(a)},E.prototype.reset=function(){return o(this._handle,"zlib binding closed"),this._handle.reset()},E.prototype._flush=function(e){this._transform(n.alloc(0),"",e)},E.prototype.flush=function(e,i){var a=this,s=this._writableState;("function"==typeof e||void 0===e&&!i)&&(i=e,e=r.Z_FULL_FLUSH),s.ended?i&&t.nextTick(i):s.ending?i&&this.once("end",i):s.needDrain?i&&this.once("drain",(function(){return a.flush(e,i)})):(this._flushFlag=e,this.write(n.alloc(0),"",i))},E.prototype.close=function(e){C(this,e),t.nextTick(I,this)},E.prototype._transform=function(e,t,i){var a,s=this._writableState,o=(s.ending||s.ended)&&(!e||s.length===e.length);return null===e||n.isBuffer(e)?this._handle?(o?a=this._finishFlushFlag:(a=this._flushFlag,e.length>=s.length&&(this._flushFlag=this._opts.flush||r.Z_NO_FLUSH)),void this._processChunk(e,a,i)):i(new Error("zlib binding closed")):i(new Error("invalid input"))},E.prototype._processChunk=function(e,t,i){var a=e&&e.length,r=this._chunkSize-this._offset,s=0,h=this,u="function"==typeof i;if(!u){var d,p=[],m=0;this.on("error",(function(e){d=e})),o(this._handle,"zlib binding closed");do{var f=this._handle.writeSync(t,e,s,a,this._buffer,this._offset,r)}while(!this._hadError&&v(f[0],f[1]));if(this._hadError)throw d;if(m>=l)throw C(this),new RangeError(c);var g=n.concat(p,m);return C(this),g}o(this._handle,"zlib binding closed");var y=this._handle.write(t,e,s,a,this._buffer,this._offset,r);function v(l,c){if(this&&(this.buffer=null,this.callback=null),!h._hadError){var d=r-c;if(o(d>=0,"have should not go down"),d>0){var f=h._buffer.slice(h._offset,h._offset+d);h._offset+=d,u?h.push(f):(p.push(f),m+=f.length)}if((0===c||h._offset>=h._chunkSize)&&(r=h._chunkSize,h._offset=0,h._buffer=n.allocUnsafe(h._chunkSize)),0===c){if(s+=a-l,a=l,!u)return!0;var g=h._handle.write(t,e,s,a,h._buffer,h._offset,h._chunkSize);return g.callback=v,void(g.buffer=e)}if(!u)return!1;i()}}y.buffer=e,y.callback=v},s.inherits(b,E),s.inherits(_,E),s.inherits(x,E),s.inherits(w,E),s.inherits(S,E),s.inherits(M,E),s.inherits(T,E)}).call(this)}).call(this,e("_process"))},{"./binding":31,_process:60,assert:23,buffer:33,stream:61,util:81}],33:[function(e,t,i){(function(t){(function(){var t=e("base64-js"),n=e("ieee754");i.Buffer=o,i.SlowBuffer=y,i.INSPECT_MAX_BYTES=50;var a=2147483647;function r(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}function s(e){if(e>a)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=o.prototype,t}function o(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return l(e,t,i)}function l(e,t,i){if("string"==typeof e)return d(e,t);if(ArrayBuffer.isView(e))return p(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(J(e,ArrayBuffer)||e&&J(e.buffer,ArrayBuffer))return m(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return o.from(n,t,i);var a=f(e);if(a)return a;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e,t,i){return c(e),e<=0?s(e):void 0!==t?"string"==typeof i?s(e).fill(t,i):s(e).fill(t):s(e)}function u(e){return c(e),s(e<0?0:0|g(e))}function d(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!o.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var i=0|v(e,t),n=s(i),a=n.write(e,t);return a!==i&&(n=n.slice(0,a)),n}function p(e){for(var t=e.length<0?0:0|g(e.length),i=s(t),n=0;n<t;n+=1)i[n]=255&e[n];return i}function m(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');var n;return(n=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i)).__proto__=o.prototype,n}function f(e){if(o.isBuffer(e)){var t=0|g(e.length),i=s(t);return 0===i.length||e.copy(i,0,0,t),i}return void 0!==e.length?"number"!=typeof e.length||Q(e.length)?s(0):p(e):"Buffer"===e.type&&Array.isArray(e.data)?p(e.data):void 0}function g(e){if(e>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return 0|e}function y(e){return+e!=e&&(e=0),o.alloc(+e)}function v(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||J(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var i=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===i)return 0;for(var a=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return Z(e).length;default:if(a)return n?-1:W(e).length;t=(""+t).toLowerCase(),a=!0}}function b(e,t,i){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return k(this,t,i);case"utf8":case"utf-8":return P(this,t,i);case"ascii":return D(this,t,i);case"latin1":case"binary":return L(this,t,i);case"base64":return I(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,t,i);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function _(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function x(e,t,i,n,a){if(0===e.length)return-1;if("string"==typeof i?(n=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Q(i=+i)&&(i=a?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(a)return-1;i=e.length-1}else if(i<0){if(!a)return-1;i=0}if("string"==typeof t&&(t=o.from(t,n)),o.isBuffer(t))return 0===t.length?-1:w(e,t,i,n,a);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?a?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):w(e,[t],i,n,a);throw new TypeError("val must be string, number or Buffer")}function w(e,t,i,n,a){var r,s=1,o=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,o/=2,l/=2,i/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(a){var h=-1;for(r=i;r<o;r++)if(c(e,r)===c(t,-1===h?0:r-h)){if(-1===h&&(h=r),r-h+1===l)return h*s}else-1!==h&&(r-=r-h),h=-1}else for(i+l>o&&(i=o-l),r=i;r>=0;r--){for(var u=!0,d=0;d<l;d++)if(c(e,r+d)!==c(t,d)){u=!1;break}if(u)return r}return-1}function S(e,t,i,n){i=Number(i)||0;var a=e.length-i;n?(n=Number(n))>a&&(n=a):n=a;var r=t.length;n>r/2&&(n=r/2);for(var s=0;s<n;++s){var o=parseInt(t.substr(2*s,2),16);if(Q(o))return s;e[i+s]=o}return s}function M(e,t,i,n){return q(W(t,e.length-i),e,i,n)}function T(e,t,i,n){return q(Y(t),e,i,n)}function A(e,t,i,n){return T(e,t,i,n)}function E(e,t,i,n){return q(Z(t),e,i,n)}function C(e,t,i,n){return q(X(t,e.length-i),e,i,n)}function I(e,i,n){return 0===i&&n===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(i,n))}function P(e,t,i){i=Math.min(e.length,i);for(var n=[],a=t;a<i;){var r,s,o,l,c=e[a],h=null,u=c>239?4:c>223?3:c>191?2:1;if(a+u<=i)switch(u){case 1:c<128&&(h=c);break;case 2:128==(192&(r=e[a+1]))&&(l=(31&c)<<6|63&r)>127&&(h=l);break;case 3:r=e[a+1],s=e[a+2],128==(192&r)&&128==(192&s)&&(l=(15&c)<<12|(63&r)<<6|63&s)>2047&&(l<55296||l>57343)&&(h=l);break;case 4:r=e[a+1],s=e[a+2],o=e[a+3],128==(192&r)&&128==(192&s)&&128==(192&o)&&(l=(15&c)<<18|(63&r)<<12|(63&s)<<6|63&o)>65535&&l<1114112&&(h=l)}null===h?(h=65533,u=1):h>65535&&(h-=65536,n.push(h>>>10&1023|55296),h=56320|1023&h),n.push(h),a+=u}return O(n)}i.kMaxLength=a,o.TYPED_ARRAY_SUPPORT=r(),o.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),o.poolSize=8192,o.from=function(e,t,i){return l(e,t,i)},o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,o.alloc=function(e,t,i){return h(e,t,i)},o.allocUnsafe=function(e){return u(e)},o.allocUnsafeSlow=function(e){return u(e)},o.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},o.compare=function(e,t){if(J(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),J(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var i=e.length,n=t.length,a=0,r=Math.min(i,n);a<r;++a)if(e[a]!==t[a]){i=e[a],n=t[a];break}return i<n?-1:n<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var n=o.allocUnsafe(t),a=0;for(i=0;i<e.length;++i){var r=e[i];if(J(r,Uint8Array)&&(r=o.from(r)),!o.isBuffer(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(n,a),a+=r.length}return n},o.byteLength=v,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)_(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},o.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?P(this,0,e):b.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",t=i.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},o.prototype.compare=function(e,t,i,n,a){if(J(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===n&&(n=0),void 0===a&&(a=this.length),t<0||i>e.length||n<0||a>this.length)throw new RangeError("out of range index");if(n>=a&&t>=i)return 0;if(n>=a)return-1;if(t>=i)return 1;if(this===e)return 0;for(var r=(a>>>=0)-(n>>>=0),s=(i>>>=0)-(t>>>=0),l=Math.min(r,s),c=this.slice(n,a),h=e.slice(t,i),u=0;u<l;++u)if(c[u]!==h[u]){r=c[u],s=h[u];break}return r<s?-1:s<r?1:0},o.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},o.prototype.indexOf=function(e,t,i){return x(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return x(this,e,t,i,!1)},o.prototype.write=function(e,t,i,n){if(void 0===t)n="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)n=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}var a=this.length-t;if((void 0===i||i>a)&&(i=a),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var r=!1;;)switch(n){case"hex":return S(this,e,t,i);case"utf8":case"utf-8":return M(this,e,t,i);case"ascii":return T(this,e,t,i);case"latin1":case"binary":return A(this,e,t,i);case"base64":return E(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,t,i);default:if(r)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),r=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var R=4096;function O(e){var t=e.length;if(t<=R)return String.fromCharCode.apply(String,e);for(var i="",n=0;n<t;)i+=String.fromCharCode.apply(String,e.slice(n,n+=R));return i}function D(e,t,i){var n="";i=Math.min(e.length,i);for(var a=t;a<i;++a)n+=String.fromCharCode(127&e[a]);return n}function L(e,t,i){var n="";i=Math.min(e.length,i);for(var a=t;a<i;++a)n+=String.fromCharCode(e[a]);return n}function k(e,t,i){var n=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>n)&&(i=n);for(var a="",r=t;r<i;++r)a+=V(e[r]);return a}function N(e,t,i){for(var n=e.slice(t,i),a="",r=0;r<n.length;r+=2)a+=String.fromCharCode(n[r]+256*n[r+1]);return a}function B(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function z(e,t,i,n,a,r){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>a||t<r)throw new RangeError('"value" argument is out of bounds');if(i+n>e.length)throw new RangeError("Index out of range")}function U(e,t,i,n,a,r){if(i+n>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function F(e,t,i,a,r){return t=+t,i>>>=0,r||U(e,t,i,4),n.write(e,t,i,a,23,4),i+4}function j(e,t,i,a,r){return t=+t,i>>>=0,r||U(e,t,i,8),n.write(e,t,i,a,52,8),i+8}o.prototype.slice=function(e,t){var i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);var n=this.subarray(e,t);return n.__proto__=o.prototype,n},o.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||B(e,t,this.length);for(var n=this[e],a=1,r=0;++r<t&&(a*=256);)n+=this[e+r]*a;return n},o.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||B(e,t,this.length);for(var n=this[e+--t],a=1;t>0&&(a*=256);)n+=this[e+--t]*a;return n},o.prototype.readUInt8=function(e,t){return e>>>=0,t||B(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return e>>>=0,t||B(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return e>>>=0,t||B(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return e>>>=0,t||B(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return e>>>=0,t||B(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||B(e,t,this.length);for(var n=this[e],a=1,r=0;++r<t&&(a*=256);)n+=this[e+r]*a;return n>=(a*=128)&&(n-=Math.pow(2,8*t)),n},o.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||B(e,t,this.length);for(var n=t,a=1,r=this[e+--n];n>0&&(a*=256);)r+=this[e+--n]*a;return r>=(a*=128)&&(r-=Math.pow(2,8*t)),r},o.prototype.readInt8=function(e,t){return e>>>=0,t||B(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){e>>>=0,t||B(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(e,t){e>>>=0,t||B(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(e,t){return e>>>=0,t||B(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return e>>>=0,t||B(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return e>>>=0,t||B(e,4,this.length),n.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return e>>>=0,t||B(e,4,this.length),n.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return e>>>=0,t||B(e,8,this.length),n.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return e>>>=0,t||B(e,8,this.length),n.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,i,n){e=+e,t>>>=0,i>>>=0,n||z(this,e,t,i,Math.pow(2,8*i)-1,0);var a=1,r=0;for(this[t]=255&e;++r<i&&(a*=256);)this[t+r]=e/a&255;return t+i},o.prototype.writeUIntBE=function(e,t,i,n){e=+e,t>>>=0,i>>>=0,n||z(this,e,t,i,Math.pow(2,8*i)-1,0);var a=i-1,r=1;for(this[t+a]=255&e;--a>=0&&(r*=256);)this[t+a]=e/r&255;return t+i},o.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,1,255,0),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeIntLE=function(e,t,i,n){if(e=+e,t>>>=0,!n){var a=Math.pow(2,8*i-1);z(this,e,t,i,a-1,-a)}var r=0,s=1,o=0;for(this[t]=255&e;++r<i&&(s*=256);)e<0&&0===o&&0!==this[t+r-1]&&(o=1),this[t+r]=(e/s>>0)-o&255;return t+i},o.prototype.writeIntBE=function(e,t,i,n){if(e=+e,t>>>=0,!n){var a=Math.pow(2,8*i-1);z(this,e,t,i,a-1,-a)}var r=i-1,s=1,o=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===o&&0!==this[t+r+1]&&(o=1),this[t+r]=(e/s>>0)-o&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||z(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeFloatLE=function(e,t,i){return F(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return F(this,e,t,!1,i)},o.prototype.writeDoubleLE=function(e,t,i){return j(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return j(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,n){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<i&&(n=i),n===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-i&&(n=e.length-t+i);var a=n-i;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,i,n);else if(this===e&&i<t&&t<n)for(var r=a-1;r>=0;--r)e[r+t]=this[r+i];else Uint8Array.prototype.set.call(e,this.subarray(i,n),t);return a},o.prototype.fill=function(e,t,i,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!o.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){var a=e.charCodeAt(0);("utf8"===n&&a<128||"latin1"===n)&&(e=a)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var r;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(r=t;r<i;++r)this[r]=e;else{var s=o.isBuffer(e)?e:o.from(e,n),l=s.length;if(0===l)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(r=0;r<i-t;++r)this[r+t]=s[r%l]}return this};var H=/[^+/0-9A-Za-z-_]/g;function G(e){if((e=(e=e.split("=")[0]).trim().replace(H,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}function V(e){return e<16?"0"+e.toString(16):e.toString(16)}function W(e,t){var i;t=t||1/0;for(var n=e.length,a=null,r=[],s=0;s<n;++s){if((i=e.charCodeAt(s))>55295&&i<57344){if(!a){if(i>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&r.push(239,191,189);continue}a=i;continue}if(i<56320){(t-=3)>-1&&r.push(239,191,189),a=i;continue}i=65536+(a-55296<<10|i-56320)}else a&&(t-=3)>-1&&r.push(239,191,189);if(a=null,i<128){if((t-=1)<0)break;r.push(i)}else if(i<2048){if((t-=2)<0)break;r.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;r.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return r}function Y(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}function X(e,t){for(var i,n,a,r=[],s=0;s<e.length&&!((t-=2)<0);++s)n=(i=e.charCodeAt(s))>>8,a=i%256,r.push(a),r.push(n);return r}function Z(e){return t.toByteArray(G(e))}function q(e,t,i,n){for(var a=0;a<n&&!(a+i>=t.length||a>=e.length);++a)t[a+i]=e[a];return a}function J(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Q(e){return e!=e}}).call(this)}).call(this,e("buffer").Buffer)},{"base64-js":29,buffer:33,ieee754:44}],34:[function(e,t,i){var n,a=TypeError,r=Object.getOwnPropertyDescriptor;if(r)try{r({},"")}catch(e){r=null}var s=function(){throw new a},o=r?function(){try{return s}catch(e){try{return r(arguments,"callee").get}catch(e){return s}}}():s,l=e("has-symbols")(),c=Object.getPrototypeOf||function(e){return e.__proto__},h=n,u=n,d=n,p="undefined"==typeof Uint8Array?n:c(Uint8Array),m={"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer,"%ArrayBufferPrototype%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer.prototype,"%ArrayIteratorPrototype%":l?c([][Symbol.iterator]()):n,"%ArrayPrototype%":Array.prototype,"%ArrayProto_entries%":Array.prototype.entries,"%ArrayProto_forEach%":Array.prototype.forEach,"%ArrayProto_keys%":Array.prototype.keys,"%ArrayProto_values%":Array.prototype.values,"%AsyncFromSyncIteratorPrototype%":n,"%AsyncFunction%":u,"%AsyncFunctionPrototype%":n,"%AsyncGenerator%":n,"%AsyncGeneratorFunction%":d,"%AsyncGeneratorPrototype%":n,"%AsyncIteratorPrototype%":n,"%Atomics%":"undefined"==typeof Atomics?n:Atomics,"%Boolean%":Boolean,"%BooleanPrototype%":Boolean.prototype,"%DataView%":"undefined"==typeof DataView?n:DataView,"%DataViewPrototype%":"undefined"==typeof DataView?n:DataView.prototype,"%Date%":Date,"%DatePrototype%":Date.prototype,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%ErrorPrototype%":Error.prototype,"%eval%":eval,"%EvalError%":EvalError,"%EvalErrorPrototype%":EvalError.prototype,"%Float32Array%":"undefined"==typeof Float32Array?n:Float32Array,"%Float32ArrayPrototype%":"undefined"==typeof Float32Array?n:Float32Array.prototype,"%Float64Array%":"undefined"==typeof Float64Array?n:Float64Array,"%Float64ArrayPrototype%":"undefined"==typeof Float64Array?n:Float64Array.prototype,"%Function%":Function,"%FunctionPrototype%":Function.prototype,"%Generator%":n,"%GeneratorFunction%":h,"%GeneratorPrototype%":n,"%Int8Array%":"undefined"==typeof Int8Array?n:Int8Array,"%Int8ArrayPrototype%":"undefined"==typeof Int8Array?n:Int8Array.prototype,"%Int16Array%":"undefined"==typeof Int16Array?n:Int16Array,"%Int16ArrayPrototype%":"undefined"==typeof Int16Array?n:Int8Array.prototype,"%Int32Array%":"undefined"==typeof Int32Array?n:Int32Array,"%Int32ArrayPrototype%":"undefined"==typeof Int32Array?n:Int32Array.prototype,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":l?c(c([][Symbol.iterator]())):n,"%JSON%":"object"==typeof JSON?JSON:n,"%JSONParse%":"object"==typeof JSON?JSON.parse:n,"%Map%":"undefined"==typeof Map?n:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&l?c((new Map)[Symbol.iterator]()):n,"%MapPrototype%":"undefined"==typeof Map?n:Map.prototype,"%Math%":Math,"%Number%":Number,"%NumberPrototype%":Number.prototype,"%Object%":Object,"%ObjectPrototype%":Object.prototype,"%ObjProto_toString%":Object.prototype.toString,"%ObjProto_valueOf%":Object.prototype.valueOf,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?n:Promise,"%PromisePrototype%":"undefined"==typeof Promise?n:Promise.prototype,"%PromiseProto_then%":"undefined"==typeof Promise?n:Promise.prototype.then,"%Promise_all%":"undefined"==typeof Promise?n:Promise.all,"%Promise_reject%":"undefined"==typeof Promise?n:Promise.reject,"%Promise_resolve%":"undefined"==typeof Promise?n:Promise.resolve,"%Proxy%":"undefined"==typeof Proxy?n:Proxy,"%RangeError%":RangeError,"%RangeErrorPrototype%":RangeError.prototype,"%ReferenceError%":ReferenceError,"%ReferenceErrorPrototype%":ReferenceError.prototype,"%Reflect%":"undefined"==typeof Reflect?n:Reflect,"%RegExp%":RegExp,"%RegExpPrototype%":RegExp.prototype,"%Set%":"undefined"==typeof Set?n:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&l?c((new Set)[Symbol.iterator]()):n,"%SetPrototype%":"undefined"==typeof Set?n:Set.prototype,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer,"%SharedArrayBufferPrototype%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer.prototype,"%String%":String,"%StringIteratorPrototype%":l?c(""[Symbol.iterator]()):n,"%StringPrototype%":String.prototype,"%Symbol%":l?Symbol:n,"%SymbolPrototype%":l?Symbol.prototype:n,"%SyntaxError%":SyntaxError,"%SyntaxErrorPrototype%":SyntaxError.prototype,"%ThrowTypeError%":o,"%TypedArray%":p,"%TypedArrayPrototype%":p?p.prototype:n,"%TypeError%":a,"%TypeErrorPrototype%":a.prototype,"%Uint8Array%":"undefined"==typeof Uint8Array?n:Uint8Array,"%Uint8ArrayPrototype%":"undefined"==typeof Uint8Array?n:Uint8Array.prototype,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray,"%Uint8ClampedArrayPrototype%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray.prototype,"%Uint16Array%":"undefined"==typeof Uint16Array?n:Uint16Array,"%Uint16ArrayPrototype%":"undefined"==typeof Uint16Array?n:Uint16Array.prototype,"%Uint32Array%":"undefined"==typeof Uint32Array?n:Uint32Array,"%Uint32ArrayPrototype%":"undefined"==typeof Uint32Array?n:Uint32Array.prototype,"%URIError%":URIError,"%URIErrorPrototype%":URIError.prototype,"%WeakMap%":"undefined"==typeof WeakMap?n:WeakMap,"%WeakMapPrototype%":"undefined"==typeof WeakMap?n:WeakMap.prototype,"%WeakSet%":"undefined"==typeof WeakSet?n:WeakSet,"%WeakSetPrototype%":"undefined"==typeof WeakSet?n:WeakSet.prototype},f=e("function-bind").call(Function.call,String.prototype.replace),g=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,y=/\\(\\)?/g,v=function(e){var t=[];return f(e,g,(function(e,i,n,a){t[t.length]=n?f(a,y,"$1"):i||e})),t},b=function(e,t){if(!(e in m))throw new SyntaxError("intrinsic "+e+" does not exist!");if(void 0===m[e]&&!t)throw new a("intrinsic "+e+" exists, but is not available. Please file an issue!");return m[e]};t.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new TypeError("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new TypeError('"allowMissing" argument must be a boolean');for(var i=v(e),n=b("%"+(i.length>0?i[0]:"")+"%",t),s=1;s<i.length;s+=1)if(null!=n)if(r&&s+1>=i.length){var o=r(n,i[s]);if(!t&&!(i[s]in n))throw new a("base intrinsic for "+e+" exists, but the property is not available.");n=o?o.get||o.value:n[i[s]]}else n=n[i[s]];return n}},{"function-bind":41,"has-symbols":42}],35:[function(e,t,i){var n=e("function-bind"),a=e("../GetIntrinsic")("%Function%"),r=a.apply,s=a.call;t.exports=function(){return n.apply(s,arguments)},t.exports.apply=function(){return n.apply(r,arguments)}},{"../GetIntrinsic":34,"function-bind":41}],36:[function(e,t,i){var n=e("../GetIntrinsic"),a=e("./callBind"),r=a(n("String.prototype.indexOf"));t.exports=function(e,t){var i=n(e,!!t);return"function"==typeof i&&r(e,".prototype.")?a(i):i}},{"../GetIntrinsic":34,"./callBind":35}],37:[function(e,t,i){var n=e("../GetIntrinsic")("%Object.getOwnPropertyDescriptor%");if(n)try{n([],"length")}catch(e){n=null}t.exports=n},{"../GetIntrinsic":34}],38:[function(e,t,i){var n,a="object"==typeof Reflect?Reflect:null,r=a&&"function"==typeof a.apply?a.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};function s(e){console&&console.warn&&console.warn(e)}n=a&&"function"==typeof a.ownKeys?a.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function l(){l.init.call(this)}t.exports=l,t.exports.once=_,l.EventEmitter=l,l.prototype._events=void 0,l.prototype._eventsCount=0,l.prototype._maxListeners=void 0;var c=10;function h(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?l.defaultMaxListeners:e._maxListeners}function d(e,t,i,n){var a,r,o;if(h(i),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),r=e._events),o=r[t]),void 0===o)o=r[t]=i,++e._eventsCount;else if("function"==typeof o?o=r[t]=n?[i,o]:[o,i]:n?o.unshift(i):o.push(i),(a=u(e))>0&&o.length>a&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,s(l)}return e}function p(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},a=p.bind(n);return a.listener=i,n.wrapFn=a,a}function f(e,t,i){var n=e._events;if(void 0===n)return[];var a=n[t];return void 0===a?[]:"function"==typeof a?i?[a.listener||a]:[a]:i?b(a):y(a,a.length)}function g(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function y(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}function v(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function b(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}function _(e,t){return new Promise((function(i,n){function a(){void 0!==r&&e.removeListener("error",r),i([].slice.call(arguments))}var r;"error"!==t&&(r=function(i){e.removeListener(t,a),n(i)},e.once("error",r)),e.once(t,a)}))}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),l.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},l.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},l.prototype.getMaxListeners=function(){return u(this)},l.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,a=this._events;if(void 0!==a)n=n&&void 0===a.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var o=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw o.context=s,o}var l=a[e];if(void 0===l)return!1;if("function"==typeof l)r(l,this,t);else{var c=l.length,h=y(l,c);for(i=0;i<c;++i)r(h[i],this,t)}return!0},l.prototype.addListener=function(e,t){return d(this,e,t,!1)},l.prototype.on=l.prototype.addListener,l.prototype.prependListener=function(e,t){return d(this,e,t,!0)},l.prototype.once=function(e,t){return h(t),this.on(e,m(this,e,t)),this},l.prototype.prependOnceListener=function(e,t){return h(t),this.prependListener(e,m(this,e,t)),this},l.prototype.removeListener=function(e,t){var i,n,a,r,s;if(h(t),void 0===(n=this._events))return this;if(void 0===(i=n[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(a=-1,r=i.length-1;r>=0;r--)if(i[r]===t||i[r].listener===t){s=i[r].listener,a=r;break}if(a<0)return this;0===a?i.shift():v(i,a),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},l.prototype.off=l.prototype.removeListener,l.prototype.removeAllListeners=function(e){var t,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var a,r=Object.keys(i);for(n=0;n<r.length;++n)"removeListener"!==(a=r[n])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},l.prototype.listeners=function(e){return f(this,e,!0)},l.prototype.rawListeners=function(e){return f(this,e,!1)},l.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},l.prototype.listenerCount=g,l.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},{}],39:[function(e,t,i){var n=Object.prototype.hasOwnProperty,a=Object.prototype.toString;t.exports=function(e,t,i){if("[object Function]"!==a.call(t))throw new TypeError("iterator must be a function");var r=e.length;if(r===+r)for(var s=0;s<r;s++)t.call(i,e[s],s,e);else for(var o in e)n.call(e,o)&&t.call(i,e[o],o,e)}},{}],40:[function(e,t,i){var n="Function.prototype.bind called on incompatible ",a=Array.prototype.slice,r=Object.prototype.toString,s="[object Function]";t.exports=function(e){var t=this;if("function"!=typeof t||r.call(t)!==s)throw new TypeError(n+t);for(var i,o=a.call(arguments,1),l=function(){if(this instanceof i){var n=t.apply(this,o.concat(a.call(arguments)));return Object(n)===n?n:this}return t.apply(e,o.concat(a.call(arguments)))},c=Math.max(0,t.length-o.length),h=[],u=0;u<c;u++)h.push("$"+u);if(i=Function("binder","return function ("+h.join(",")+"){ return binder.apply(this,arguments); }")(l),t.prototype){var d=function(){};d.prototype=t.prototype,i.prototype=new d,d.prototype=null}return i}},{}],41:[function(e,t,i){var n=e("./implementation");t.exports=Function.prototype.bind||n},{"./implementation":40}],42:[function(e,t,i){(function(i){(function(){var n=i.Symbol,a=e("./shams");t.exports=function(){return"function"==typeof n&&"function"==typeof Symbol&&"symbol"==typeof n("foo")&&"symbol"==typeof Symbol("bar")&&a()}}).call(this)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./shams":43}],43:[function(e,t,i){t.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;var n=42;for(t in e[t]=n,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var a=Object.getOwnPropertySymbols(e);if(1!==a.length||a[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var r=Object.getOwnPropertyDescriptor(e,t);if(r.value!==n||!0!==r.enumerable)return!1}return!0}},{}],44:[function(e,t,i){i.read=function(e,t,i,n,a){var r,s,o=8*a-n-1,l=(1<<o)-1,c=l>>1,h=-7,u=i?a-1:0,d=i?-1:1,p=e[t+u];for(u+=d,r=p&(1<<-h)-1,p>>=-h,h+=o;h>0;r=256*r+e[t+u],u+=d,h-=8);for(s=r&(1<<-h)-1,r>>=-h,h+=n;h>0;s=256*s+e[t+u],u+=d,h-=8);if(0===r)r=1-c;else{if(r===l)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),r-=c}return(p?-1:1)*s*Math.pow(2,r-n)},i.write=function(e,t,i,n,a,r){var s,o,l,c=8*r-a-1,h=(1<<c)-1,u=h>>1,d=23===a?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:r-1,m=n?1:-1,f=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,s=h):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),(t+=s+u>=1?d/l:d*Math.pow(2,1-u))*l>=2&&(s++,l/=2),s+u>=h?(o=0,s=h):s+u>=1?(o=(t*l-1)*Math.pow(2,a),s+=u):(o=t*Math.pow(2,u-1)*Math.pow(2,a),s=0));a>=8;e[i+p]=255&o,p+=m,o/=256,a-=8);for(s=s<<a|o,c+=a;c>0;e[i+p]=255&s,p+=m,s/=256,c-=8);e[i+p-m]|=128*f}},{}],45:[function(e,t,i){"function"==typeof Object.create?t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},{}],46:[function(e,t,i){var n="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,a=Object.prototype.toString,r=function(e){return!(n&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===a.call(e)},s=function(e){return!!r(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==a.call(e)&&"[object Function]"===a.call(e.callee)},o=function(){return r(arguments)}();r.isLegacyArguments=s,t.exports=o?r:s},{}],47:[function(e,t,i){var n=Object.prototype.toString,a=Function.prototype.toString,r=/^\s*(?:function)?\*/,s="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,o=Object.getPrototypeOf,l=function(){if(!s)return!1;try{return Function("return function*() {}")()}catch(e){}}(),c=l?o(l):{};t.exports=function(e){return"function"==typeof e&&(!!r.test(a.call(e))||(s?o(e)===c:"[object GeneratorFunction]"===n.call(e)))}},{}],48:[function(e,t,i){(function(i){(function(){var n=e("foreach"),a=e("available-typed-arrays"),r=e("es-abstract/helpers/callBound"),s=r("Object.prototype.toString"),o=e("has-symbols")()&&"symbol"==typeof Symbol.toStringTag,l=a(),c=r("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},h=r("String.prototype.slice"),u={},d=e("es-abstract/helpers/getOwnPropertyDescriptor"),p=Object.getPrototypeOf;o&&d&&p&&n(l,(function(e){var t=new i[e];if(!(Symbol.toStringTag in t))throw new EvalError("this engine has support for Symbol.toStringTag, but "+e+" does not have the property! Please report this.");var n=p(t),a=d(n,Symbol.toStringTag);if(!a){var r=p(n);a=d(r,Symbol.toStringTag)}u[e]=a.get}));var m=function(e){var t=!1;return n(u,(function(i,n){if(!t)try{t=i.call(e)===n}catch(e){}})),t};t.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!o){var t=h(s(e),8,-1);return c(l,t)>-1}return!!d&&m(e)}}).call(this)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"available-typed-arrays":27,"es-abstract/helpers/callBound":36,"es-abstract/helpers/getOwnPropertyDescriptor":37,foreach:39,"has-symbols":42}],49:[function(e,t,i){var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function a(e,t){return Object.prototype.hasOwnProperty.call(e,t)}i.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var n in i)a(i,n)&&(e[n]=i[n])}}return e},i.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var r={arraySet:function(e,t,i,n,a){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+n),a);else for(var r=0;r<n;r++)e[a+r]=t[i+r]},flattenChunks:function(e){var t,i,n,a,r,s;for(n=0,t=0,i=e.length;t<i;t++)n+=e[t].length;for(s=new Uint8Array(n),a=0,t=0,i=e.length;t<i;t++)r=e[t],s.set(r,a),a+=r.length;return s}},s={arraySet:function(e,t,i,n,a){for(var r=0;r<n;r++)e[a+r]=t[i+r]},flattenChunks:function(e){return[].concat.apply([],e)}};i.setTyped=function(e){e?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,r)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,s))},i.setTyped(n)},{}],50:[function(e,t,i){function n(e,t,i,n){for(var a=65535&e|0,r=e>>>16&65535|0,s=0;0!==i;){i-=s=i>2e3?2e3:i;do{r=r+(a=a+t[n++]|0)|0}while(--s);a%=65521,r%=65521}return a|r<<16|0}t.exports=n},{}],51:[function(e,t,i){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],52:[function(e,t,i){function n(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}var a=n();function r(e,t,i,n){var r=a,s=n+i;e^=-1;for(var o=n;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e}t.exports=r},{}],53:[function(e,t,i){var n,a=e("../utils/common"),r=e("./trees"),s=e("./adler32"),o=e("./crc32"),l=e("./messages"),c=0,h=1,u=3,d=4,p=5,m=0,f=1,g=-2,y=-3,v=-5,b=-1,_=1,x=2,w=3,S=4,M=0,T=2,A=8,E=9,C=15,I=8,P=286,R=30,O=19,D=2*P+1,L=15,k=3,N=258,B=N+k+1,z=32,U=42,F=69,j=73,H=91,G=103,V=113,W=666,Y=1,X=2,Z=3,q=4,J=3;function Q(e,t){return e.msg=l[t],t}function K(e){return(e<<1)-(e>4?9:0)}function $(e){for(var t=e.length;--t>=0;)e[t]=0}function ee(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(a.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function te(e,t){r._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,ee(e.strm)}function ie(e,t){e.pending_buf[e.pending++]=t}function ne(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function ae(e,t,i,n){var r=e.avail_in;return r>n&&(r=n),0===r?0:(e.avail_in-=r,a.arraySet(t,e.input,e.next_in,r,i),1===e.state.wrap?e.adler=s(e.adler,t,r,i):2===e.state.wrap&&(e.adler=o(e.adler,t,r,i)),e.next_in+=r,e.total_in+=r,r)}function re(e,t){var i,n,a=e.max_chain_length,r=e.strstart,s=e.prev_length,o=e.nice_match,l=e.strstart>e.w_size-B?e.strstart-(e.w_size-B):0,c=e.window,h=e.w_mask,u=e.prev,d=e.strstart+N,p=c[r+s-1],m=c[r+s];e.prev_length>=e.good_match&&(a>>=2),o>e.lookahead&&(o=e.lookahead);do{if(c[(i=t)+s]===m&&c[i+s-1]===p&&c[i]===c[r]&&c[++i]===c[r+1]){r+=2,i++;do{}while(c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&r<d);if(n=N-(d-r),r=d-N,n>s){if(e.match_start=t,s=n,n>=o)break;p=c[r+s-1],m=c[r+s]}}}while((t=u[t&h])>l&&0!=--a);return s<=e.lookahead?s:e.lookahead}function se(e){var t,i,n,r,s,o=e.w_size;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=o+(o-B)){a.arraySet(e.window,e.window,o,o,0),e.match_start-=o,e.strstart-=o,e.block_start-=o,t=i=e.hash_size;do{n=e.head[--t],e.head[t]=n>=o?n-o:0}while(--i);t=i=o;do{n=e.prev[--t],e.prev[t]=n>=o?n-o:0}while(--i);r+=o}if(0===e.strm.avail_in)break;if(i=ae(e.strm,e.window,e.strstart+e.lookahead,r),e.lookahead+=i,e.lookahead+e.insert>=k)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+k-1])&e.hash_mask,e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<k)););}while(e.lookahead<B&&0!==e.strm.avail_in)}function oe(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(se(e),0===e.lookahead&&t===c)return Y;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+i;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,te(e,!1),0===e.strm.avail_out))return Y;if(e.strstart-e.block_start>=e.w_size-B&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?Z:q):(e.strstart>e.block_start&&(te(e,!1),e.strm.avail_out),Y)}function le(e,t){for(var i,n;;){if(e.lookahead<B){if(se(e),e.lookahead<B&&t===c)return Y;if(0===e.lookahead)break}if(i=0,e.lookahead>=k&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-B&&(e.match_length=re(e,i)),e.match_length>=k)if(n=r._tr_tally(e,e.strstart-e.match_start,e.match_length-k),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=k){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=e.strstart<k-1?e.strstart:k-1,t===d?(te(e,!0),0===e.strm.avail_out?Z:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function ce(e,t){for(var i,n,a;;){if(e.lookahead<B){if(se(e),e.lookahead<B&&t===c)return Y;if(0===e.lookahead)break}if(i=0,e.lookahead>=k&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=k-1,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-B&&(e.match_length=re(e,i),e.match_length<=5&&(e.strategy===_||e.match_length===k&&e.strstart-e.match_start>4096)&&(e.match_length=k-1)),e.prev_length>=k&&e.match_length<=e.prev_length){a=e.strstart+e.lookahead-k,n=r._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-k),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=a&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+k-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=k-1,e.strstart++,n&&(te(e,!1),0===e.strm.avail_out))return Y}else if(e.match_available){if((n=r._tr_tally(e,0,e.window[e.strstart-1]))&&te(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return Y}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=r._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<k-1?e.strstart:k-1,t===d?(te(e,!0),0===e.strm.avail_out?Z:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function he(e,t){for(var i,n,a,s,o=e.window;;){if(e.lookahead<=N){if(se(e),e.lookahead<=N&&t===c)return Y;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=k&&e.strstart>0&&(n=o[a=e.strstart-1])===o[++a]&&n===o[++a]&&n===o[++a]){s=e.strstart+N;do{}while(n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&n===o[++a]&&a<s);e.match_length=N-(s-a),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=k?(i=r._tr_tally(e,1,e.match_length-k),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?Z:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function ue(e,t){for(var i;;){if(0===e.lookahead&&(se(e),0===e.lookahead)){if(t===c)return Y;break}if(e.match_length=0,i=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(te(e,!1),0===e.strm.avail_out))return Y}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?Z:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?Y:X}function de(e,t,i,n,a){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=a}function pe(e){e.window_size=2*e.w_size,$(e.head),e.max_lazy_match=n[e.level].max_lazy,e.good_match=n[e.level].good_length,e.nice_match=n[e.level].nice_length,e.max_chain_length=n[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=k-1,e.match_available=0,e.ins_h=0}function me(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=A,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*D),this.dyn_dtree=new a.Buf16(2*(2*R+1)),this.bl_tree=new a.Buf16(2*(2*O+1)),$(this.dyn_ltree),$(this.dyn_dtree),$(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(L+1),this.heap=new a.Buf16(2*P+1),$(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*P+1),$(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function fe(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=T,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?U:V,e.adler=2===t.wrap?0:1,t.last_flush=c,r._tr_init(t),m):Q(e,g)}function ge(e){var t=fe(e);return t===m&&pe(e.state),t}function ye(e,t){return e&&e.state?2!==e.state.wrap?g:(e.state.gzhead=t,m):g}function ve(e,t,i,n,r,s){if(!e)return g;var o=1;if(t===b&&(t=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),r<1||r>E||i!==A||n<8||n>15||t<0||t>9||s<0||s>S)return Q(e,g);8===n&&(n=9);var l=new me;return e.state=l,l.strm=e,l.wrap=o,l.gzhead=null,l.w_bits=n,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=r+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+k-1)/k),l.window=new a.Buf8(2*l.w_size),l.head=new a.Buf16(l.hash_size),l.prev=new a.Buf16(l.w_size),l.lit_bufsize=1<<r+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new a.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=s,l.method=i,ge(e)}function be(e,t){return ve(e,t,A,C,I,M)}function _e(e,t){var i,a,s,l;if(!e||!e.state||t>p||t<0)return e?Q(e,g):g;if(a=e.state,!e.output||!e.input&&0!==e.avail_in||a.status===W&&t!==d)return Q(e,0===e.avail_out?v:g);if(a.strm=e,i=a.last_flush,a.last_flush=t,a.status===U)if(2===a.wrap)e.adler=0,ie(a,31),ie(a,139),ie(a,8),a.gzhead?(ie(a,(a.gzhead.text?1:0)+(a.gzhead.hcrc?2:0)+(a.gzhead.extra?4:0)+(a.gzhead.name?8:0)+(a.gzhead.comment?16:0)),ie(a,255&a.gzhead.time),ie(a,a.gzhead.time>>8&255),ie(a,a.gzhead.time>>16&255),ie(a,a.gzhead.time>>24&255),ie(a,9===a.level?2:a.strategy>=x||a.level<2?4:0),ie(a,255&a.gzhead.os),a.gzhead.extra&&a.gzhead.extra.length&&(ie(a,255&a.gzhead.extra.length),ie(a,a.gzhead.extra.length>>8&255)),a.gzhead.hcrc&&(e.adler=o(e.adler,a.pending_buf,a.pending,0)),a.gzindex=0,a.status=F):(ie(a,0),ie(a,0),ie(a,0),ie(a,0),ie(a,0),ie(a,9===a.level?2:a.strategy>=x||a.level<2?4:0),ie(a,J),a.status=V);else{var y=A+(a.w_bits-8<<4)<<8;y|=(a.strategy>=x||a.level<2?0:a.level<6?1:6===a.level?2:3)<<6,0!==a.strstart&&(y|=z),y+=31-y%31,a.status=V,ne(a,y),0!==a.strstart&&(ne(a,e.adler>>>16),ne(a,65535&e.adler)),e.adler=1}if(a.status===F)if(a.gzhead.extra){for(s=a.pending;a.gzindex<(65535&a.gzhead.extra.length)&&(a.pending!==a.pending_buf_size||(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),ee(e),s=a.pending,a.pending!==a.pending_buf_size));)ie(a,255&a.gzhead.extra[a.gzindex]),a.gzindex++;a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),a.gzindex===a.gzhead.extra.length&&(a.gzindex=0,a.status=j)}else a.status=j;if(a.status===j)if(a.gzhead.name){s=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),ee(e),s=a.pending,a.pending===a.pending_buf_size)){l=1;break}l=a.gzindex<a.gzhead.name.length?255&a.gzhead.name.charCodeAt(a.gzindex++):0,ie(a,l)}while(0!==l);a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),0===l&&(a.gzindex=0,a.status=H)}else a.status=H;if(a.status===H)if(a.gzhead.comment){s=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),ee(e),s=a.pending,a.pending===a.pending_buf_size)){l=1;break}l=a.gzindex<a.gzhead.comment.length?255&a.gzhead.comment.charCodeAt(a.gzindex++):0,ie(a,l)}while(0!==l);a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),0===l&&(a.status=G)}else a.status=G;if(a.status===G&&(a.gzhead.hcrc?(a.pending+2>a.pending_buf_size&&ee(e),a.pending+2<=a.pending_buf_size&&(ie(a,255&e.adler),ie(a,e.adler>>8&255),e.adler=0,a.status=V)):a.status=V),0!==a.pending){if(ee(e),0===e.avail_out)return a.last_flush=-1,m}else if(0===e.avail_in&&K(t)<=K(i)&&t!==d)return Q(e,v);if(a.status===W&&0!==e.avail_in)return Q(e,v);if(0!==e.avail_in||0!==a.lookahead||t!==c&&a.status!==W){var b=a.strategy===x?ue(a,t):a.strategy===w?he(a,t):n[a.level].func(a,t);if(b!==Z&&b!==q||(a.status=W),b===Y||b===Z)return 0===e.avail_out&&(a.last_flush=-1),m;if(b===X&&(t===h?r._tr_align(a):t!==p&&(r._tr_stored_block(a,0,0,!1),t===u&&($(a.head),0===a.lookahead&&(a.strstart=0,a.block_start=0,a.insert=0))),ee(e),0===e.avail_out))return a.last_flush=-1,m}return t!==d?m:a.wrap<=0?f:(2===a.wrap?(ie(a,255&e.adler),ie(a,e.adler>>8&255),ie(a,e.adler>>16&255),ie(a,e.adler>>24&255),ie(a,255&e.total_in),ie(a,e.total_in>>8&255),ie(a,e.total_in>>16&255),ie(a,e.total_in>>24&255)):(ne(a,e.adler>>>16),ne(a,65535&e.adler)),ee(e),a.wrap>0&&(a.wrap=-a.wrap),0!==a.pending?m:f)}function xe(e){var t;return e&&e.state?(t=e.state.status)!==U&&t!==F&&t!==j&&t!==H&&t!==G&&t!==V&&t!==W?Q(e,g):(e.state=null,t===V?Q(e,y):m):g}function we(e,t){var i,n,r,o,l,c,h,u,d=t.length;if(!e||!e.state)return g;if(2===(o=(i=e.state).wrap)||1===o&&i.status!==U||i.lookahead)return g;for(1===o&&(e.adler=s(e.adler,t,d,0)),i.wrap=0,d>=i.w_size&&(0===o&&($(i.head),i.strstart=0,i.block_start=0,i.insert=0),u=new a.Buf8(i.w_size),a.arraySet(u,t,d-i.w_size,i.w_size,0),t=u,d=i.w_size),l=e.avail_in,c=e.next_in,h=e.input,e.avail_in=d,e.next_in=0,e.input=t,se(i);i.lookahead>=k;){n=i.strstart,r=i.lookahead-(k-1);do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[n+k-1])&i.hash_mask,i.prev[n&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=n,n++}while(--r);i.strstart=n,i.lookahead=k-1,se(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=k-1,i.match_available=0,e.next_in=c,e.input=h,e.avail_in=l,i.wrap=o,m}n=[new de(0,0,0,0,oe),new de(4,4,8,4,le),new de(4,5,16,8,le),new de(4,6,32,32,le),new de(4,4,16,16,ce),new de(8,16,32,32,ce),new de(8,16,128,128,ce),new de(8,32,128,256,ce),new de(32,128,258,1024,ce),new de(32,258,258,4096,ce)],i.deflateInit=be,i.deflateInit2=ve,i.deflateReset=ge,i.deflateResetKeep=fe,i.deflateSetHeader=ye,i.deflate=_e,i.deflateEnd=xe,i.deflateSetDictionary=we,i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":49,"./adler32":50,"./crc32":52,"./messages":57,"./trees":58}],54:[function(e,t,i){var n=30,a=12;t.exports=function(e,t){var i,r,s,o,l,c,h,u,d,p,m,f,g,y,v,b,_,x,w,S,M,T,A,E,C;i=e.state,r=e.next_in,E=e.input,s=r+(e.avail_in-5),o=e.next_out,C=e.output,l=o-(t-e.avail_out),c=o+(e.avail_out-257),h=i.dmax,u=i.wsize,d=i.whave,p=i.wnext,m=i.window,f=i.hold,g=i.bits,y=i.lencode,v=i.distcode,b=(1<<i.lenbits)-1,_=(1<<i.distbits)-1;e:do{g<15&&(f+=E[r++]<<g,g+=8,f+=E[r++]<<g,g+=8),x=y[f&b];t:for(;;){if(f>>>=w=x>>>24,g-=w,0==(w=x>>>16&255))C[o++]=65535&x;else{if(!(16&w)){if(0==(64&w)){x=y[(65535&x)+(f&(1<<w)-1)];continue t}if(32&w){i.mode=a;break e}e.msg="invalid literal/length code",i.mode=n;break e}S=65535&x,(w&=15)&&(g<w&&(f+=E[r++]<<g,g+=8),S+=f&(1<<w)-1,f>>>=w,g-=w),g<15&&(f+=E[r++]<<g,g+=8,f+=E[r++]<<g,g+=8),x=v[f&_];i:for(;;){if(f>>>=w=x>>>24,g-=w,!(16&(w=x>>>16&255))){if(0==(64&w)){x=v[(65535&x)+(f&(1<<w)-1)];continue i}e.msg="invalid distance code",i.mode=n;break e}if(M=65535&x,g<(w&=15)&&(f+=E[r++]<<g,(g+=8)<w&&(f+=E[r++]<<g,g+=8)),(M+=f&(1<<w)-1)>h){e.msg="invalid distance too far back",i.mode=n;break e}if(f>>>=w,g-=w,M>(w=o-l)){if((w=M-w)>d&&i.sane){e.msg="invalid distance too far back",i.mode=n;break e}if(T=0,A=m,0===p){if(T+=u-w,w<S){S-=w;do{C[o++]=m[T++]}while(--w);T=o-M,A=C}}else if(p<w){if(T+=u+p-w,(w-=p)<S){S-=w;do{C[o++]=m[T++]}while(--w);if(T=0,p<S){S-=w=p;do{C[o++]=m[T++]}while(--w);T=o-M,A=C}}}else if(T+=p-w,w<S){S-=w;do{C[o++]=m[T++]}while(--w);T=o-M,A=C}for(;S>2;)C[o++]=A[T++],C[o++]=A[T++],C[o++]=A[T++],S-=3;S&&(C[o++]=A[T++],S>1&&(C[o++]=A[T++]))}else{T=o-M;do{C[o++]=C[T++],C[o++]=C[T++],C[o++]=C[T++],S-=3}while(S>2);S&&(C[o++]=C[T++],S>1&&(C[o++]=C[T++]))}break}}break}}while(r<s&&o<c);r-=S=g>>3,f&=(1<<(g-=S<<3))-1,e.next_in=r,e.next_out=o,e.avail_in=r<s?s-r+5:5-(r-s),e.avail_out=o<c?c-o+257:257-(o-c),i.hold=f,i.bits=g}},{}],55:[function(e,t,i){var n=e("../utils/common"),a=e("./adler32"),r=e("./crc32"),s=e("./inffast"),o=e("./inftrees"),l=0,c=1,h=2,u=4,d=5,p=6,m=0,f=1,g=2,y=-2,v=-3,b=-4,_=-5,x=8,w=1,S=2,M=3,T=4,A=5,E=6,C=7,I=8,P=9,R=10,O=11,D=12,L=13,k=14,N=15,B=16,z=17,U=18,F=19,j=20,H=21,G=22,V=23,W=24,Y=25,X=26,Z=27,q=28,J=29,Q=30,K=31,$=32,ee=852,te=592,ie=15;function ne(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function ae(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function re(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=w,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new n.Buf32(ee),t.distcode=t.distdyn=new n.Buf32(te),t.sane=1,t.back=-1,m):y}function se(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,re(e)):y}function oe(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?y:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,se(e))):y}function le(e,t){var i,n;return e?(n=new ae,e.state=n,n.window=null,(i=oe(e,t))!==m&&(e.state=null),i):y}function ce(e){return le(e,ie)}var he,ue,de=!0;function pe(e){if(de){var t;for(he=new n.Buf32(512),ue=new n.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(c,e.lens,0,288,he,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(h,e.lens,0,32,ue,0,e.work,{bits:5}),de=!1}e.lencode=he,e.lenbits=9,e.distcode=ue,e.distbits=5}function me(e,t,i,a){var r,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new n.Buf8(s.wsize)),a>=s.wsize?(n.arraySet(s.window,t,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((r=s.wsize-s.wnext)>a&&(r=a),n.arraySet(s.window,t,i-a,r,s.wnext),(a-=r)?(n.arraySet(s.window,t,i-a,a,0),s.wnext=a,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}function fe(e,t){var i,ee,te,ie,ae,re,se,oe,le,ce,he,ue,de,fe,ge,ye,ve,be,_e,xe,we,Se,Me,Te,Ae=0,Ee=new n.Buf8(4),Ce=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return y;(i=e.state).mode===D&&(i.mode=L),ae=e.next_out,te=e.output,se=e.avail_out,ie=e.next_in,ee=e.input,re=e.avail_in,oe=i.hold,le=i.bits,ce=re,he=se,Se=m;e:for(;;)switch(i.mode){case w:if(0===i.wrap){i.mode=L;break}for(;le<16;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(2&i.wrap&&35615===oe){i.check=0,Ee[0]=255&oe,Ee[1]=oe>>>8&255,i.check=r(i.check,Ee,2,0),oe=0,le=0,i.mode=S;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&oe)<<8)+(oe>>8))%31){e.msg="incorrect header check",i.mode=Q;break}if((15&oe)!==x){e.msg="unknown compression method",i.mode=Q;break}if(le-=4,we=8+(15&(oe>>>=4)),0===i.wbits)i.wbits=we;else if(we>i.wbits){e.msg="invalid window size",i.mode=Q;break}i.dmax=1<<we,e.adler=i.check=1,i.mode=512&oe?R:D,oe=0,le=0;break;case S:for(;le<16;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(i.flags=oe,(255&i.flags)!==x){e.msg="unknown compression method",i.mode=Q;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=Q;break}i.head&&(i.head.text=oe>>8&1),512&i.flags&&(Ee[0]=255&oe,Ee[1]=oe>>>8&255,i.check=r(i.check,Ee,2,0)),oe=0,le=0,i.mode=M;case M:for(;le<32;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}i.head&&(i.head.time=oe),512&i.flags&&(Ee[0]=255&oe,Ee[1]=oe>>>8&255,Ee[2]=oe>>>16&255,Ee[3]=oe>>>24&255,i.check=r(i.check,Ee,4,0)),oe=0,le=0,i.mode=T;case T:for(;le<16;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}i.head&&(i.head.xflags=255&oe,i.head.os=oe>>8),512&i.flags&&(Ee[0]=255&oe,Ee[1]=oe>>>8&255,i.check=r(i.check,Ee,2,0)),oe=0,le=0,i.mode=A;case A:if(1024&i.flags){for(;le<16;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}i.length=oe,i.head&&(i.head.extra_len=oe),512&i.flags&&(Ee[0]=255&oe,Ee[1]=oe>>>8&255,i.check=r(i.check,Ee,2,0)),oe=0,le=0}else i.head&&(i.head.extra=null);i.mode=E;case E:if(1024&i.flags&&((ue=i.length)>re&&(ue=re),ue&&(i.head&&(we=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),n.arraySet(i.head.extra,ee,ie,ue,we)),512&i.flags&&(i.check=r(i.check,ee,ue,ie)),re-=ue,ie+=ue,i.length-=ue),i.length))break e;i.length=0,i.mode=C;case C:if(2048&i.flags){if(0===re)break e;ue=0;do{we=ee[ie+ue++],i.head&&we&&i.length<65536&&(i.head.name+=String.fromCharCode(we))}while(we&&ue<re);if(512&i.flags&&(i.check=r(i.check,ee,ue,ie)),re-=ue,ie+=ue,we)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=I;case I:if(4096&i.flags){if(0===re)break e;ue=0;do{we=ee[ie+ue++],i.head&&we&&i.length<65536&&(i.head.comment+=String.fromCharCode(we))}while(we&&ue<re);if(512&i.flags&&(i.check=r(i.check,ee,ue,ie)),re-=ue,ie+=ue,we)break e}else i.head&&(i.head.comment=null);i.mode=P;case P:if(512&i.flags){for(;le<16;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(oe!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Q;break}oe=0,le=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=D;break;case R:for(;le<32;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}e.adler=i.check=ne(oe),oe=0,le=0,i.mode=O;case O:if(0===i.havedict)return e.next_out=ae,e.avail_out=se,e.next_in=ie,e.avail_in=re,i.hold=oe,i.bits=le,g;e.adler=i.check=1,i.mode=D;case D:if(t===d||t===p)break e;case L:if(i.last){oe>>>=7&le,le-=7&le,i.mode=Z;break}for(;le<3;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}switch(i.last=1&oe,le-=1,3&(oe>>>=1)){case 0:i.mode=k;break;case 1:if(pe(i),i.mode=j,t===p){oe>>>=2,le-=2;break e}break;case 2:i.mode=z;break;case 3:e.msg="invalid block type",i.mode=Q}oe>>>=2,le-=2;break;case k:for(oe>>>=7&le,le-=7&le;le<32;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if((65535&oe)!=(oe>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Q;break}if(i.length=65535&oe,oe=0,le=0,i.mode=N,t===p)break e;case N:i.mode=B;case B:if(ue=i.length){if(ue>re&&(ue=re),ue>se&&(ue=se),0===ue)break e;n.arraySet(te,ee,ie,ue,ae),re-=ue,ie+=ue,se-=ue,ae+=ue,i.length-=ue;break}i.mode=D;break;case z:for(;le<14;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(i.nlen=257+(31&oe),oe>>>=5,le-=5,i.ndist=1+(31&oe),oe>>>=5,le-=5,i.ncode=4+(15&oe),oe>>>=4,le-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Q;break}i.have=0,i.mode=U;case U:for(;i.have<i.ncode;){for(;le<3;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}i.lens[Ce[i.have++]]=7&oe,oe>>>=3,le-=3}for(;i.have<19;)i.lens[Ce[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,Me={bits:i.lenbits},Se=o(l,i.lens,0,19,i.lencode,0,i.work,Me),i.lenbits=Me.bits,Se){e.msg="invalid code lengths set",i.mode=Q;break}i.have=0,i.mode=F;case F:for(;i.have<i.nlen+i.ndist;){for(;ye=(Ae=i.lencode[oe&(1<<i.lenbits)-1])>>>16&255,ve=65535&Ae,!((ge=Ae>>>24)<=le);){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(ve<16)oe>>>=ge,le-=ge,i.lens[i.have++]=ve;else{if(16===ve){for(Te=ge+2;le<Te;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(oe>>>=ge,le-=ge,0===i.have){e.msg="invalid bit length repeat",i.mode=Q;break}we=i.lens[i.have-1],ue=3+(3&oe),oe>>>=2,le-=2}else if(17===ve){for(Te=ge+3;le<Te;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}le-=ge,we=0,ue=3+(7&(oe>>>=ge)),oe>>>=3,le-=3}else{for(Te=ge+7;le<Te;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}le-=ge,we=0,ue=11+(127&(oe>>>=ge)),oe>>>=7,le-=7}if(i.have+ue>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Q;break}for(;ue--;)i.lens[i.have++]=we}}if(i.mode===Q)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Q;break}if(i.lenbits=9,Me={bits:i.lenbits},Se=o(c,i.lens,0,i.nlen,i.lencode,0,i.work,Me),i.lenbits=Me.bits,Se){e.msg="invalid literal/lengths set",i.mode=Q;break}if(i.distbits=6,i.distcode=i.distdyn,Me={bits:i.distbits},Se=o(h,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,Me),i.distbits=Me.bits,Se){e.msg="invalid distances set",i.mode=Q;break}if(i.mode=j,t===p)break e;case j:i.mode=H;case H:if(re>=6&&se>=258){e.next_out=ae,e.avail_out=se,e.next_in=ie,e.avail_in=re,i.hold=oe,i.bits=le,s(e,he),ae=e.next_out,te=e.output,se=e.avail_out,ie=e.next_in,ee=e.input,re=e.avail_in,oe=i.hold,le=i.bits,i.mode===D&&(i.back=-1);break}for(i.back=0;ye=(Ae=i.lencode[oe&(1<<i.lenbits)-1])>>>16&255,ve=65535&Ae,!((ge=Ae>>>24)<=le);){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(ye&&0==(240&ye)){for(be=ge,_e=ye,xe=ve;ye=(Ae=i.lencode[xe+((oe&(1<<be+_e)-1)>>be)])>>>16&255,ve=65535&Ae,!(be+(ge=Ae>>>24)<=le);){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}oe>>>=be,le-=be,i.back+=be}if(oe>>>=ge,le-=ge,i.back+=ge,i.length=ve,0===ye){i.mode=X;break}if(32&ye){i.back=-1,i.mode=D;break}if(64&ye){e.msg="invalid literal/length code",i.mode=Q;break}i.extra=15&ye,i.mode=G;case G:if(i.extra){for(Te=i.extra;le<Te;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}i.length+=oe&(1<<i.extra)-1,oe>>>=i.extra,le-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=V;case V:for(;ye=(Ae=i.distcode[oe&(1<<i.distbits)-1])>>>16&255,ve=65535&Ae,!((ge=Ae>>>24)<=le);){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(0==(240&ye)){for(be=ge,_e=ye,xe=ve;ye=(Ae=i.distcode[xe+((oe&(1<<be+_e)-1)>>be)])>>>16&255,ve=65535&Ae,!(be+(ge=Ae>>>24)<=le);){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}oe>>>=be,le-=be,i.back+=be}if(oe>>>=ge,le-=ge,i.back+=ge,64&ye){e.msg="invalid distance code",i.mode=Q;break}i.offset=ve,i.extra=15&ye,i.mode=W;case W:if(i.extra){for(Te=i.extra;le<Te;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}i.offset+=oe&(1<<i.extra)-1,oe>>>=i.extra,le-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Q;break}i.mode=Y;case Y:if(0===se)break e;if(ue=he-se,i.offset>ue){if((ue=i.offset-ue)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Q;break}ue>i.wnext?(ue-=i.wnext,de=i.wsize-ue):de=i.wnext-ue,ue>i.length&&(ue=i.length),fe=i.window}else fe=te,de=ae-i.offset,ue=i.length;ue>se&&(ue=se),se-=ue,i.length-=ue;do{te[ae++]=fe[de++]}while(--ue);0===i.length&&(i.mode=H);break;case X:if(0===se)break e;te[ae++]=i.length,se--,i.mode=H;break;case Z:if(i.wrap){for(;le<32;){if(0===re)break e;re--,oe|=ee[ie++]<<le,le+=8}if(he-=se,e.total_out+=he,i.total+=he,he&&(e.adler=i.check=i.flags?r(i.check,te,he,ae-he):a(i.check,te,he,ae-he)),he=se,(i.flags?oe:ne(oe))!==i.check){e.msg="incorrect data check",i.mode=Q;break}oe=0,le=0}i.mode=q;case q:if(i.wrap&&i.flags){for(;le<32;){if(0===re)break e;re--,oe+=ee[ie++]<<le,le+=8}if(oe!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Q;break}oe=0,le=0}i.mode=J;case J:Se=f;break e;case Q:Se=v;break e;case K:return b;case $:default:return y}return e.next_out=ae,e.avail_out=se,e.next_in=ie,e.avail_in=re,i.hold=oe,i.bits=le,(i.wsize||he!==e.avail_out&&i.mode<Q&&(i.mode<Z||t!==u))&&me(e,e.output,e.next_out,he-e.avail_out),ce-=e.avail_in,he-=e.avail_out,e.total_in+=ce,e.total_out+=he,i.total+=he,i.wrap&&he&&(e.adler=i.check=i.flags?r(i.check,te,he,e.next_out-he):a(i.check,te,he,e.next_out-he)),e.data_type=i.bits+(i.last?64:0)+(i.mode===D?128:0)+(i.mode===j||i.mode===N?256:0),(0===ce&&0===he||t===u)&&Se===m&&(Se=_),Se}function ge(e){if(!e||!e.state)return y;var t=e.state;return t.window&&(t.window=null),e.state=null,m}function ye(e,t){var i;return e&&e.state?0==(2&(i=e.state).wrap)?y:(i.head=t,t.done=!1,m):y}function ve(e,t){var i,n=t.length;return e&&e.state?0!==(i=e.state).wrap&&i.mode!==O?y:i.mode===O&&a(1,t,n,0)!==i.check?v:me(e,t,n,n)?(i.mode=K,b):(i.havedict=1,m):y}i.inflateReset=se,i.inflateReset2=oe,i.inflateResetKeep=re,i.inflateInit=ce,i.inflateInit2=le,i.inflate=fe,i.inflateEnd=ge,i.inflateGetHeader=ye,i.inflateSetDictionary=ve,i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":49,"./adler32":50,"./crc32":52,"./inffast":54,"./inftrees":56}],56:[function(e,t,i){var n=e("../utils/common"),a=15,r=852,s=592,o=0,l=1,c=2,h=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],u=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],d=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],p=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,i,m,f,g,y,v){var b,_,x,w,S,M,T,A,E,C=v.bits,I=0,P=0,R=0,O=0,D=0,L=0,k=0,N=0,B=0,z=0,U=null,F=0,j=new n.Buf16(a+1),H=new n.Buf16(a+1),G=null,V=0;for(I=0;I<=a;I++)j[I]=0;for(P=0;P<m;P++)j[t[i+P]]++;for(D=C,O=a;O>=1&&0===j[O];O--);if(D>O&&(D=O),0===O)return f[g++]=20971520,f[g++]=20971520,v.bits=1,0;for(R=1;R<O&&0===j[R];R++);for(D<R&&(D=R),N=1,I=1;I<=a;I++)if(N<<=1,(N-=j[I])<0)return-1;if(N>0&&(e===o||1!==O))return-1;for(H[1]=0,I=1;I<a;I++)H[I+1]=H[I]+j[I];for(P=0;P<m;P++)0!==t[i+P]&&(y[H[t[i+P]]++]=P);if(e===o?(U=G=y,M=19):e===l?(U=h,F-=257,G=u,V-=257,M=256):(U=d,G=p,M=-1),z=0,P=0,I=R,S=g,L=D,k=0,x=-1,w=(B=1<<D)-1,e===l&&B>r||e===c&&B>s)return 1;for(;;){T=I-k,y[P]<M?(A=0,E=y[P]):y[P]>M?(A=G[V+y[P]],E=U[F+y[P]]):(A=96,E=0),b=1<<I-k,R=_=1<<L;do{f[S+(z>>k)+(_-=b)]=T<<24|A<<16|E|0}while(0!==_);for(b=1<<I-1;z&b;)b>>=1;if(0!==b?(z&=b-1,z+=b):z=0,P++,0==--j[I]){if(I===O)break;I=t[i+y[P]]}if(I>D&&(z&w)!==x){for(0===k&&(k=D),S+=R,N=1<<(L=I-k);L+k<O&&!((N-=j[L+k])<=0);)L++,N<<=1;if(B+=1<<L,e===l&&B>r||e===c&&B>s)return 1;f[x=z&w]=D<<24|L<<16|S-g|0}}return 0!==z&&(f[S+z]=I-k<<24|64<<16|0),v.bits=D,0}},{"../utils/common":49}],57:[function(e,t,i){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],58:[function(e,t,i){var n=e("../utils/common"),a=4,r=0,s=1,o=2;function l(e){for(var t=e.length;--t>=0;)e[t]=0}var c=0,h=1,u=2,d=3,p=258,m=29,f=256,g=f+1+m,y=30,v=19,b=2*g+1,_=15,x=16,w=7,S=256,M=16,T=17,A=18,E=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],C=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],I=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],R=512,O=new Array(2*(g+2));l(O);var D=new Array(2*y);l(D);var L=new Array(R);l(L);var k=new Array(p-d+1);l(k);var N=new Array(m);l(N);var B,z,U,F=new Array(y);function j(e,t,i,n,a){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=a,this.has_stree=e&&e.length}function H(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function G(e){return e<256?L[e]:L[256+(e>>>7)]}function V(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function W(e,t,i){e.bi_valid>x-i?(e.bi_buf|=t<<e.bi_valid&65535,V(e,e.bi_buf),e.bi_buf=t>>x-e.bi_valid,e.bi_valid+=i-x):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function Y(e,t,i){W(e,i[2*t],i[2*t+1])}function X(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function Z(e){16===e.bi_valid?(V(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function q(e,t){var i,n,a,r,s,o,l=t.dyn_tree,c=t.max_code,h=t.stat_desc.static_tree,u=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,m=t.stat_desc.max_length,f=0;for(r=0;r<=_;r++)e.bl_count[r]=0;for(l[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<b;i++)(r=l[2*l[2*(n=e.heap[i])+1]+1]+1)>m&&(r=m,f++),l[2*n+1]=r,n>c||(e.bl_count[r]++,s=0,n>=p&&(s=d[n-p]),o=l[2*n],e.opt_len+=o*(r+s),u&&(e.static_len+=o*(h[2*n+1]+s)));if(0!==f){do{for(r=m-1;0===e.bl_count[r];)r--;e.bl_count[r]--,e.bl_count[r+1]+=2,e.bl_count[m]--,f-=2}while(f>0);for(r=m;0!==r;r--)for(n=e.bl_count[r];0!==n;)(a=e.heap[--i])>c||(l[2*a+1]!==r&&(e.opt_len+=(r-l[2*a+1])*l[2*a],l[2*a+1]=r),n--)}}function J(e,t,i){var n,a,r=new Array(_+1),s=0;for(n=1;n<=_;n++)r[n]=s=s+i[n-1]<<1;for(a=0;a<=t;a++){var o=e[2*a+1];0!==o&&(e[2*a]=X(r[o]++,o))}}function Q(){var e,t,i,n,a,r=new Array(_+1);for(i=0,n=0;n<m-1;n++)for(N[n]=i,e=0;e<1<<E[n];e++)k[i++]=n;for(k[i-1]=n,a=0,n=0;n<16;n++)for(F[n]=a,e=0;e<1<<C[n];e++)L[a++]=n;for(a>>=7;n<y;n++)for(F[n]=a<<7,e=0;e<1<<C[n]-7;e++)L[256+a++]=n;for(t=0;t<=_;t++)r[t]=0;for(e=0;e<=143;)O[2*e+1]=8,e++,r[8]++;for(;e<=255;)O[2*e+1]=9,e++,r[9]++;for(;e<=279;)O[2*e+1]=7,e++,r[7]++;for(;e<=287;)O[2*e+1]=8,e++,r[8]++;for(J(O,g+1,r),e=0;e<y;e++)D[2*e+1]=5,D[2*e]=X(e,5);B=new j(O,E,f+1,g,_),z=new j(D,C,0,y,_),U=new j(new Array(0),I,0,v,w)}function K(e){var t;for(t=0;t<g;t++)e.dyn_ltree[2*t]=0;for(t=0;t<y;t++)e.dyn_dtree[2*t]=0;for(t=0;t<v;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*S]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function $(e){e.bi_valid>8?V(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function ee(e,t,i,a){$(e),a&&(V(e,i),V(e,~i)),n.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}function te(e,t,i,n){var a=2*t,r=2*i;return e[a]<e[r]||e[a]===e[r]&&n[t]<=n[i]}function ie(e,t,i){for(var n=e.heap[i],a=i<<1;a<=e.heap_len&&(a<e.heap_len&&te(t,e.heap[a+1],e.heap[a],e.depth)&&a++,!te(t,n,e.heap[a],e.depth));)e.heap[i]=e.heap[a],i=a,a<<=1;e.heap[i]=n}function ne(e,t,i){var n,a,r,s,o=0;if(0!==e.last_lit)do{n=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],a=e.pending_buf[e.l_buf+o],o++,0===n?Y(e,a,t):(Y(e,(r=k[a])+f+1,t),0!==(s=E[r])&&W(e,a-=N[r],s),Y(e,r=G(--n),i),0!==(s=C[r])&&W(e,n-=F[r],s))}while(o<e.last_lit);Y(e,S,t)}function ae(e,t){var i,n,a,r=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=b,i=0;i<l;i++)0!==r[2*i]?(e.heap[++e.heap_len]=c=i,e.depth[i]=0):r[2*i+1]=0;for(;e.heap_len<2;)r[2*(a=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[a]=0,e.opt_len--,o&&(e.static_len-=s[2*a+1]);for(t.max_code=c,i=e.heap_len>>1;i>=1;i--)ie(e,r,i);a=l;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],ie(e,r,1),n=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=n,r[2*a]=r[2*i]+r[2*n],e.depth[a]=(e.depth[i]>=e.depth[n]?e.depth[i]:e.depth[n])+1,r[2*i+1]=r[2*n+1]=a,e.heap[1]=a++,ie(e,r,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],q(e,t),J(r,c,e.bl_count)}function re(e,t,i){var n,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)a=s,s=t[2*(n+1)+1],++o<l&&a===s||(o<c?e.bl_tree[2*a]+=o:0!==a?(a!==r&&e.bl_tree[2*a]++,e.bl_tree[2*M]++):o<=10?e.bl_tree[2*T]++:e.bl_tree[2*A]++,o=0,r=a,0===s?(l=138,c=3):a===s?(l=6,c=3):(l=7,c=4))}function se(e,t,i){var n,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),n=0;n<=i;n++)if(a=s,s=t[2*(n+1)+1],!(++o<l&&a===s)){if(o<c)do{Y(e,a,e.bl_tree)}while(0!=--o);else 0!==a?(a!==r&&(Y(e,a,e.bl_tree),o--),Y(e,M,e.bl_tree),W(e,o-3,2)):o<=10?(Y(e,T,e.bl_tree),W(e,o-3,3)):(Y(e,A,e.bl_tree),W(e,o-11,7));o=0,r=a,0===s?(l=138,c=3):a===s?(l=6,c=3):(l=7,c=4)}}function oe(e){var t;for(re(e,e.dyn_ltree,e.l_desc.max_code),re(e,e.dyn_dtree,e.d_desc.max_code),ae(e,e.bl_desc),t=v-1;t>=3&&0===e.bl_tree[2*P[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function le(e,t,i,n){var a;for(W(e,t-257,5),W(e,i-1,5),W(e,n-4,4),a=0;a<n;a++)W(e,e.bl_tree[2*P[a]+1],3);se(e,e.dyn_ltree,t-1),se(e,e.dyn_dtree,i-1)}function ce(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return r;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return s;for(t=32;t<f;t++)if(0!==e.dyn_ltree[2*t])return s;return r}l(F);var he=!1;function ue(e){he||(Q(),he=!0),e.l_desc=new H(e.dyn_ltree,B),e.d_desc=new H(e.dyn_dtree,z),e.bl_desc=new H(e.bl_tree,U),e.bi_buf=0,e.bi_valid=0,K(e)}function de(e,t,i,n){W(e,(c<<1)+(n?1:0),3),ee(e,t,i,!0)}function pe(e){W(e,h<<1,3),Y(e,S,O),Z(e)}function me(e,t,i,n){var r,s,l=0;e.level>0?(e.strm.data_type===o&&(e.strm.data_type=ce(e)),ae(e,e.l_desc),ae(e,e.d_desc),l=oe(e),r=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=r&&(r=s)):r=s=i+5,i+4<=r&&-1!==t?de(e,t,i,n):e.strategy===a||s===r?(W(e,(h<<1)+(n?1:0),3),ne(e,O,D)):(W(e,(u<<1)+(n?1:0),3),le(e,e.l_desc.max_code+1,e.d_desc.max_code+1,l+1),ne(e,e.dyn_ltree,e.dyn_dtree)),K(e),n&&$(e)}function fe(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(k[i]+f+1)]++,e.dyn_dtree[2*G(t)]++),e.last_lit===e.lit_bufsize-1}i._tr_init=ue,i._tr_stored_block=de,i._tr_flush_block=me,i._tr_tally=fe,i._tr_align=pe},{"../utils/common":49}],59:[function(e,t,i){function n(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}t.exports=n},{}],60:[function(e,t,i){var n,a,r=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function l(e){if(n===setTimeout)return setTimeout(e,0);if((n===s||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}function c(e){if(a===clearTimeout)return clearTimeout(e);if((a===o||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{return a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:s}catch(e){n=s}try{a="function"==typeof clearTimeout?clearTimeout:o}catch(e){a=o}}();var h,u=[],d=!1,p=-1;function m(){d&&h&&(d=!1,h.length?u=h.concat(u):p=-1,u.length&&f())}function f(){if(!d){var e=l(m);d=!0;for(var t=u.length;t;){for(h=u,u=[];++p<t;)h&&h[p].run();p=-1,t=u.length}h=null,d=!1,c(e)}}function g(e,t){this.fun=e,this.array=t}function y(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];u.push(new g(e,t)),1!==u.length||d||l(f)},g.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=y,r.addListener=y,r.once=y,r.off=y,r.removeListener=y,r.removeAllListeners=y,r.emit=y,r.prependListener=y,r.prependOnceListener=y,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},{}],61:[function(e,t,i){t.exports=a;var n=e("events").EventEmitter;function a(){n.call(this)}e("inherits")(a,n),a.Readable=e("readable-stream/lib/_stream_readable.js"),a.Writable=e("readable-stream/lib/_stream_writable.js"),a.Duplex=e("readable-stream/lib/_stream_duplex.js"),a.Transform=e("readable-stream/lib/_stream_transform.js"),a.PassThrough=e("readable-stream/lib/_stream_passthrough.js"),a.finished=e("readable-stream/lib/internal/streams/end-of-stream.js"),a.pipeline=e("readable-stream/lib/internal/streams/pipeline.js"),a.Stream=a,a.prototype.pipe=function(e,t){var i=this;function a(t){e.writable&&!1===e.write(t)&&i.pause&&i.pause()}function r(){i.readable&&i.resume&&i.resume()}i.on("data",a),e.on("drain",r),e._isStdio||t&&!1===t.end||(i.on("end",o),i.on("close",l));var s=!1;function o(){s||(s=!0,e.end())}function l(){s||(s=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(h(),0===n.listenerCount(this,"error"))throw e}function h(){i.removeListener("data",a),e.removeListener("drain",r),i.removeListener("end",o),i.removeListener("close",l),i.removeListener("error",c),e.removeListener("error",c),i.removeListener("end",h),i.removeListener("close",h),e.removeListener("close",h)}return i.on("error",c),e.on("error",c),i.on("end",h),i.on("close",h),e.on("close",h),e.emit("pipe",i),e}},{events:38,inherits:45,"readable-stream/lib/_stream_duplex.js":63,"readable-stream/lib/_stream_passthrough.js":64,"readable-stream/lib/_stream_readable.js":65,"readable-stream/lib/_stream_transform.js":66,"readable-stream/lib/_stream_writable.js":67,"readable-stream/lib/internal/streams/end-of-stream.js":71,"readable-stream/lib/internal/streams/pipeline.js":73}],62:[function(e,t,i){function n(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var a={};function r(e,t,i){function r(e,i,n){return"string"==typeof t?t:t(e,i,n)}i||(i=Error);var s=function(e){function t(t,i,n){return e.call(this,r(t,i,n))||this}return n(t,e),t}(i);s.prototype.name=i.name,s.prototype.code=e,a[e]=s}function s(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map((function(e){return String(e)})),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:2===i?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}function o(e,t,i){return e.substr(!i||i<0?0:+i,t.length)===t}function l(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t}function c(e,t,i){return"number"!=typeof i&&(i=0),!(i+t.length>e.length)&&-1!==e.indexOf(t,i)}r("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),r("ERR_INVALID_ARG_TYPE",(function(e,t,i){var n,a;if("string"==typeof t&&o(t,"not ")?(n="must not be",t=t.replace(/^not /,"")):n="must be",l(e," argument"))a="The ".concat(e," ").concat(n," ").concat(s(t,"type"));else{var r=c(e,".")?"property":"argument";a='The "'.concat(e,'" ').concat(r," ").concat(n," ").concat(s(t,"type"))}return a+=". Received type ".concat(typeof i)}),TypeError),r("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),r("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),r("ERR_STREAM_PREMATURE_CLOSE","Premature close"),r("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),r("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),r("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),r("ERR_STREAM_WRITE_AFTER_END","write after end"),r("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),r("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),r("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.codes=a},{}],63:[function(e,t,i){(function(i){(function(){var n=Object.keys||function(e){var t=[];for(var i in e)t.push(i);return t};t.exports=c;var a=e("./_stream_readable"),r=e("./_stream_writable");e("inherits")(c,a);for(var s=n(r.prototype),o=0;o<s.length;o++){var l=s[o];c.prototype[l]||(c.prototype[l]=r.prototype[l])}function c(e){if(!(this instanceof c))return new c(e);a.call(this,e),r.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",h)))}function h(){this._writableState.ended||i.nextTick(u,this)}function u(e){e.end()}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this)}).call(this,e("_process"))},{"./_stream_readable":65,"./_stream_writable":67,_process:60,inherits:45}],64:[function(e,t,i){t.exports=a;var n=e("./_stream_transform");function a(e){if(!(this instanceof a))return new a(e);n.call(this,e)}e("inherits")(a,n),a.prototype._transform=function(e,t,i){i(null,e)}},{"./_stream_transform":66,inherits:45}],65:[function(e,t,i){(function(i,n){(function(){var a;t.exports=C,C.ReadableState=E,e("events").EventEmitter;var r=function(e,t){return e.listeners(t).length},s=e("./internal/streams/stream"),o=e("buffer").Buffer,l=n.Uint8Array||function(){};function c(e){return o.from(e)}function h(e){return o.isBuffer(e)||e instanceof l}var u,d=e("util");u=d&&d.debuglog?d.debuglog("stream"):function(){};var p,m,f,g=e("./internal/streams/buffer_list"),y=e("./internal/streams/destroy"),v=e("./internal/streams/state").getHighWaterMark,b=e("../errors").codes,_=b.ERR_INVALID_ARG_TYPE,x=b.ERR_STREAM_PUSH_AFTER_EOF,w=b.ERR_METHOD_NOT_IMPLEMENTED,S=b.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;e("inherits")(C,s);var M=y.errorOrDestroy,T=["error","close","destroy","pause","resume"];function A(e,t,i){if("function"==typeof e.prependListener)return e.prependListener(t,i);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(i):e._events[t]=[i,e._events[t]]:e.on(t,i)}function E(t,i,n){a=a||e("./_stream_duplex"),t=t||{},"boolean"!=typeof n&&(n=i instanceof a),this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=v(this,t,"readableHighWaterMark",n),this.buffer=new g,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(p||(p=e("string_decoder/").StringDecoder),this.decoder=new p(t.encoding),this.encoding=t.encoding)}function C(t){if(a=a||e("./_stream_duplex"),!(this instanceof C))return new C(t);var i=this instanceof a;this._readableState=new E(t,this,i),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),s.call(this)}function I(e,t,i,n,a){u("readableAddChunk",t);var r,s=e._readableState;if(null===t)s.reading=!1,k(e,s);else if(a||(r=R(s,t)),r)M(e,r);else if(s.objectMode||t&&t.length>0)if("string"==typeof t||s.objectMode||Object.getPrototypeOf(t)===o.prototype||(t=c(t)),n)s.endEmitted?M(e,new S):P(e,s,t,!0);else if(s.ended)M(e,new x);else{if(s.destroyed)return!1;s.reading=!1,s.decoder&&!i?(t=s.decoder.write(t),s.objectMode||0!==t.length?P(e,s,t,!1):z(e,s)):P(e,s,t,!1)}else n||(s.reading=!1,z(e,s));return!s.ended&&(s.length<s.highWaterMark||0===s.length)}function P(e,t,i,n){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",i)):(t.length+=t.objectMode?1:i.length,n?t.buffer.unshift(i):t.buffer.push(i),t.needReadable&&N(e)),z(e,t)}function R(e,t){var i;return h(t)||"string"==typeof t||void 0===t||e.objectMode||(i=new _("chunk",["string","Buffer","Uint8Array"],t)),i}Object.defineProperty(C.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),C.prototype.destroy=y.destroy,C.prototype._undestroy=y.undestroy,C.prototype._destroy=function(e,t){t(e)},C.prototype.push=function(e,t){var i,n=this._readableState;return n.objectMode?i=!0:"string"==typeof e&&((t=t||n.defaultEncoding)!==n.encoding&&(e=o.from(e,t),t=""),i=!0),I(this,e,t,!1,i)},C.prototype.unshift=function(e){return I(this,e,null,!0,!1)},C.prototype.isPaused=function(){return!1===this._readableState.flowing},C.prototype.setEncoding=function(t){p||(p=e("string_decoder/").StringDecoder);var i=new p(t);this._readableState.decoder=i,this._readableState.encoding=this._readableState.decoder.encoding;for(var n=this._readableState.buffer.head,a="";null!==n;)a+=i.write(n.data),n=n.next;return this._readableState.buffer.clear(),""!==a&&this._readableState.buffer.push(a),this._readableState.length=a.length,this};var O=1073741824;function D(e){return e>=O?e=O:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}function L(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=D(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function k(e,t){if(u("onEofChunk"),!t.ended){if(t.decoder){var i=t.decoder.end();i&&i.length&&(t.buffer.push(i),t.length+=t.objectMode?1:i.length)}t.ended=!0,t.sync?N(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,B(e)))}}function N(e){var t=e._readableState;u("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(u("emitReadable",t.flowing),t.emittedReadable=!0,i.nextTick(B,e))}function B(e){var t=e._readableState;u("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,W(e)}function z(e,t){t.readingMore||(t.readingMore=!0,i.nextTick(U,e,t))}function U(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var i=t.length;if(u("maybeReadMore read 0"),e.read(0),i===t.length)break}t.readingMore=!1}function F(e){return function(){var t=e._readableState;u("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&r(e,"data")&&(t.flowing=!0,W(e))}}function j(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function H(e){u("readable nexttick read 0"),e.read(0)}function G(e,t){t.resumeScheduled||(t.resumeScheduled=!0,i.nextTick(V,e,t))}function V(e,t){u("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),W(e),t.flowing&&!t.reading&&e.read(0)}function W(e){var t=e._readableState;for(u("flow",t.flowing);t.flowing&&null!==e.read(););}function Y(e,t){return 0===t.length?null:(t.objectMode?i=t.buffer.shift():!e||e>=t.length?(i=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):i=t.buffer.consume(e,t.decoder),i);var i}function X(e){var t=e._readableState;u("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,i.nextTick(Z,t,e))}function Z(e,t){if(u("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var i=t._writableState;(!i||i.autoDestroy&&i.finished)&&t.destroy()}}function q(e,t){for(var i=0,n=e.length;i<n;i++)if(e[i]===t)return i;return-1}C.prototype.read=function(e){u("read",e),e=parseInt(e,10);var t=this._readableState,i=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return u("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?X(this):N(this),null;if(0===(e=L(e,t))&&t.ended)return 0===t.length&&X(this),null;var n,a=t.needReadable;return u("need readable",a),(0===t.length||t.length-e<t.highWaterMark)&&u("length less than watermark",a=!0),t.ended||t.reading?u("reading or ended",a=!1):a&&(u("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=L(i,t))),null===(n=e>0?Y(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),i!==e&&t.ended&&X(this)),null!==n&&this.emit("data",n),n},C.prototype._read=function(e){M(this,new w("_read()"))},C.prototype.pipe=function(e,t){var n=this,a=this._readableState;switch(a.pipesCount){case 0:a.pipes=e;break;case 1:a.pipes=[a.pipes,e];break;default:a.pipes.push(e)}a.pipesCount+=1,u("pipe count=%d opts=%j",a.pipesCount,t);var s=t&&!1===t.end||e===i.stdout||e===i.stderr?y:l;function o(e,t){u("onunpipe"),e===n&&t&&!1===t.hasUnpiped&&(t.hasUnpiped=!0,d())}function l(){u("onend"),e.end()}a.endEmitted?i.nextTick(s):n.once("end",s),e.on("unpipe",o);var c=F(n);e.on("drain",c);var h=!1;function d(){u("cleanup"),e.removeListener("close",f),e.removeListener("finish",g),e.removeListener("drain",c),e.removeListener("error",m),e.removeListener("unpipe",o),n.removeListener("end",l),n.removeListener("end",y),n.removeListener("data",p),h=!0,!a.awaitDrain||e._writableState&&!e._writableState.needDrain||c()}function p(t){u("ondata");var i=e.write(t);u("dest.write",i),!1===i&&((1===a.pipesCount&&a.pipes===e||a.pipesCount>1&&-1!==q(a.pipes,e))&&!h&&(u("false write response, pause",a.awaitDrain),a.awaitDrain++),n.pause())}function m(t){u("onerror",t),y(),e.removeListener("error",m),0===r(e,"error")&&M(e,t)}function f(){e.removeListener("finish",g),y()}function g(){u("onfinish"),e.removeListener("close",f),y()}function y(){u("unpipe"),n.unpipe(e)}return n.on("data",p),A(e,"error",m),e.once("close",f),e.once("finish",g),e.emit("pipe",n),a.flowing||(u("pipe resume"),n.resume()),e},C.prototype.unpipe=function(e){var t=this._readableState,i={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,i)),this;if(!e){var n=t.pipes,a=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var r=0;r<a;r++)n[r].emit("unpipe",this,{hasUnpiped:!1});return this}var s=q(t.pipes,e);return-1===s||(t.pipes.splice(s,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,i)),this},C.prototype.on=function(e,t){var n=s.prototype.on.call(this,e,t),a=this._readableState;return"data"===e?(a.readableListening=this.listenerCount("readable")>0,!1!==a.flowing&&this.resume()):"readable"===e&&(a.endEmitted||a.readableListening||(a.readableListening=a.needReadable=!0,a.flowing=!1,a.emittedReadable=!1,u("on readable",a.length,a.reading),a.length?N(this):a.reading||i.nextTick(H,this))),n},C.prototype.addListener=C.prototype.on,C.prototype.removeListener=function(e,t){var n=s.prototype.removeListener.call(this,e,t);return"readable"===e&&i.nextTick(j,this),n},C.prototype.removeAllListeners=function(e){var t=s.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||i.nextTick(j,this),t},C.prototype.resume=function(){var e=this._readableState;return e.flowing||(u("resume"),e.flowing=!e.readableListening,G(this,e)),e.paused=!1,this},C.prototype.pause=function(){return u("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(u("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},C.prototype.wrap=function(e){var t=this,i=this._readableState,n=!1;for(var a in e.on("end",(function(){if(u("wrapped end"),i.decoder&&!i.ended){var e=i.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(a){u("wrapped data"),i.decoder&&(a=i.decoder.write(a)),i.objectMode&&null==a||(i.objectMode||a&&a.length)&&(t.push(a)||(n=!0,e.pause()))})),e)void 0===this[a]&&"function"==typeof e[a]&&(this[a]=function(t){return function(){return e[t].apply(e,arguments)}}(a));for(var r=0;r<T.length;r++)e.on(T[r],this.emit.bind(this,T[r]));return this._read=function(t){u("wrapped _read",t),n&&(n=!1,e.resume())},this},"function"==typeof Symbol&&(C.prototype[Symbol.asyncIterator]=function(){return void 0===m&&(m=e("./internal/streams/async_iterator")),m(this)}),Object.defineProperty(C.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(C.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(C.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),C._fromList=Y,Object.defineProperty(C.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(C.from=function(t,i){return void 0===f&&(f=e("./internal/streams/from")),f(C,t,i)})}).call(this)}).call(this,e("_process"),void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":62,"./_stream_duplex":63,"./internal/streams/async_iterator":68,"./internal/streams/buffer_list":69,"./internal/streams/destroy":70,"./internal/streams/from":72,"./internal/streams/state":74,"./internal/streams/stream":75,_process:60,buffer:33,events:38,inherits:45,"string_decoder/":76,util:30}],66:[function(e,t,i){t.exports=h;var n=e("../errors").codes,a=n.ERR_METHOD_NOT_IMPLEMENTED,r=n.ERR_MULTIPLE_CALLBACK,s=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,o=n.ERR_TRANSFORM_WITH_LENGTH_0,l=e("./_stream_duplex");function c(e,t){var i=this._transformState;i.transforming=!1;var n=i.writecb;if(null===n)return this.emit("error",new r);i.writechunk=null,i.writecb=null,null!=t&&this.push(t),n(e);var a=this._readableState;a.reading=!1,(a.needReadable||a.length<a.highWaterMark)&&this._read(a.highWaterMark)}function h(e){if(!(this instanceof h))return new h(e);l.call(this,e),this._transformState={afterTransform:c.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",u)}function u(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?d(this,null,null):this._flush((function(t,i){d(e,t,i)}))}function d(e,t,i){if(t)return e.emit("error",t);if(null!=i&&e.push(i),e._writableState.length)throw new o;if(e._transformState.transforming)throw new s;return e.push(null)}e("inherits")(h,l),h.prototype.push=function(e,t){return this._transformState.needTransform=!1,l.prototype.push.call(this,e,t)},h.prototype._transform=function(e,t,i){i(new a("_transform()"))},h.prototype._write=function(e,t,i){var n=this._transformState;if(n.writecb=i,n.writechunk=e,n.writeencoding=t,!n.transforming){var a=this._readableState;(n.needTransform||a.needReadable||a.length<a.highWaterMark)&&this._read(a.highWaterMark)}},h.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},h.prototype._destroy=function(e,t){l.prototype._destroy.call(this,e,(function(e){t(e)}))}},{"../errors":62,"./_stream_duplex":63,inherits:45}],67:[function(e,t,i){(function(i,n){(function(){function a(e){var t=this;this.next=null,this.entry=null,this.finish=function(){V(t,e)}}var r;t.exports=E,E.WritableState=A;var s={deprecate:e("util-deprecate")},o=e("./internal/streams/stream"),l=e("buffer").Buffer,c=n.Uint8Array||function(){};function h(e){return l.from(e)}function u(e){return l.isBuffer(e)||e instanceof c}var d,p=e("./internal/streams/destroy"),m=e("./internal/streams/state").getHighWaterMark,f=e("../errors").codes,g=f.ERR_INVALID_ARG_TYPE,y=f.ERR_METHOD_NOT_IMPLEMENTED,v=f.ERR_MULTIPLE_CALLBACK,b=f.ERR_STREAM_CANNOT_PIPE,_=f.ERR_STREAM_DESTROYED,x=f.ERR_STREAM_NULL_VALUES,w=f.ERR_STREAM_WRITE_AFTER_END,S=f.ERR_UNKNOWN_ENCODING,M=p.errorOrDestroy;function T(){}function A(t,i,n){r=r||e("./_stream_duplex"),t=t||{},"boolean"!=typeof n&&(n=i instanceof r),this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=m(this,t,"writableHighWaterMark",n),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var s=!1===t.decodeStrings;this.decodeStrings=!s,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){k(i,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new a(this)}function E(t){var i=this instanceof(r=r||e("./_stream_duplex"));if(!i&&!d.call(E,this))return new E(t);this._writableState=new A(t,this,i),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),o.call(this)}function C(e,t){var n=new w;M(e,n),i.nextTick(t,n)}function I(e,t,n,a){var r;return null===n?r=new x:"string"==typeof n||t.objectMode||(r=new g("chunk",["string","Buffer"],n)),!r||(M(e,r),i.nextTick(a,r),!1)}function P(e,t,i){return e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=l.from(t,i)),t}function R(e,t,i,n,a,r){if(!i){var s=P(t,n,a);n!==s&&(i=!0,a="buffer",n=s)}var o=t.objectMode?1:n.length;t.length+=o;var l=t.length<t.highWaterMark;if(l||(t.needDrain=!0),t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:n,encoding:a,isBuf:i,callback:r,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else O(e,t,!1,o,n,a,r);return l}function O(e,t,i,n,a,r,s){t.writelen=n,t.writecb=s,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new _("write")):i?e._writev(a,t.onwrite):e._write(a,r,t.onwrite),t.sync=!1}function D(e,t,n,a,r){--t.pendingcb,n?(i.nextTick(r,a),i.nextTick(H,e,t),e._writableState.errorEmitted=!0,M(e,a)):(r(a),e._writableState.errorEmitted=!0,M(e,a),H(e,t))}function L(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function k(e,t){var n=e._writableState,a=n.sync,r=n.writecb;if("function"!=typeof r)throw new v;if(L(n),t)D(e,n,a,t,r);else{var s=U(n)||e.destroyed;s||n.corked||n.bufferProcessing||!n.bufferedRequest||z(e,n),a?i.nextTick(N,e,n,s,r):N(e,n,s,r)}}function N(e,t,i,n){i||B(e,t),t.pendingcb--,n(),H(e,t)}function B(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function z(e,t){t.bufferProcessing=!0;var i=t.bufferedRequest;if(e._writev&&i&&i.next){var n=t.bufferedRequestCount,r=new Array(n),s=t.corkedRequestsFree;s.entry=i;for(var o=0,l=!0;i;)r[o]=i,i.isBuf||(l=!1),i=i.next,o+=1;r.allBuffers=l,O(e,t,!0,t.length,r,"",s.finish),t.pendingcb++,t.lastBufferedRequest=null,s.next?(t.corkedRequestsFree=s.next,s.next=null):t.corkedRequestsFree=new a(t),t.bufferedRequestCount=0}else{for(;i;){var c=i.chunk,h=i.encoding,u=i.callback;if(O(e,t,!1,t.objectMode?1:c.length,c,h,u),i=i.next,t.bufferedRequestCount--,t.writing)break}null===i&&(t.lastBufferedRequest=null)}t.bufferedRequest=i,t.bufferProcessing=!1}function U(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function F(e,t){e._final((function(i){t.pendingcb--,i&&M(e,i),t.prefinished=!0,e.emit("prefinish"),H(e,t)}))}function j(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,i.nextTick(F,e,t)))}function H(e,t){var i=U(t);if(i&&(j(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var n=e._readableState;(!n||n.autoDestroy&&n.endEmitted)&&e.destroy()}return i}function G(e,t,n){t.ending=!0,H(e,t),n&&(t.finished?i.nextTick(n):e.once("finish",n)),t.ended=!0,e.writable=!1}function V(e,t,i){var n=e.entry;for(e.entry=null;n;){var a=n.callback;t.pendingcb--,a(i),n=n.next}t.corkedRequestsFree.next=e}e("inherits")(E,o),A.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(A.prototype,"buffer",{get:s.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(d=Function.prototype[Symbol.hasInstance],Object.defineProperty(E,Symbol.hasInstance,{value:function(e){return!!d.call(this,e)||this===E&&e&&e._writableState instanceof A}})):d=function(e){return e instanceof this},E.prototype.pipe=function(){M(this,new b)},E.prototype.write=function(e,t,i){var n=this._writableState,a=!1,r=!n.objectMode&&u(e);return r&&!l.isBuffer(e)&&(e=h(e)),"function"==typeof t&&(i=t,t=null),r?t="buffer":t||(t=n.defaultEncoding),"function"!=typeof i&&(i=T),n.ending?C(this,i):(r||I(this,n,e,i))&&(n.pendingcb++,a=R(this,n,r,e,t,i)),a},E.prototype.cork=function(){this._writableState.corked++},E.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||z(this,e))},E.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new S(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(E.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(E.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),E.prototype._write=function(e,t,i){i(new y("_write()"))},E.prototype._writev=null,E.prototype.end=function(e,t,i){var n=this._writableState;return"function"==typeof e?(i=e,e=null,t=null):"function"==typeof t&&(i=t,t=null),null!=e&&this.write(e,t),n.corked&&(n.corked=1,this.uncork()),n.ending||G(this,n,i),this},Object.defineProperty(E.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(E.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),E.prototype.destroy=p.destroy,E.prototype._undestroy=p.undestroy,E.prototype._destroy=function(e,t){t(e)}}).call(this)}).call(this,e("_process"),void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":62,"./_stream_duplex":63,"./internal/streams/destroy":70,"./internal/streams/state":74,"./internal/streams/stream":75,_process:60,buffer:33,inherits:45,"util-deprecate":78}],68:[function(e,t,i){(function(i){(function(){var n;function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var r=e("./end-of-stream"),s=Symbol("lastResolve"),o=Symbol("lastReject"),l=Symbol("error"),c=Symbol("ended"),h=Symbol("lastPromise"),u=Symbol("handlePromise"),d=Symbol("stream");function p(e,t){return{value:e,done:t}}function m(e){var t=e[s];if(null!==t){var i=e[d].read();null!==i&&(e[h]=null,e[s]=null,e[o]=null,t(p(i,!1)))}}function f(e){i.nextTick(m,e)}function g(e,t){return function(i,n){e.then((function(){t[c]?i(p(void 0,!0)):t[u](i,n)}),n)}}var y=Object.getPrototypeOf((function(){})),v=Object.setPrototypeOf((a(n={get stream(){return this[d]},next:function(){var e=this,t=this[l];if(null!==t)return Promise.reject(t);if(this[c])return Promise.resolve(p(void 0,!0));if(this[d].destroyed)return new Promise((function(t,n){i.nextTick((function(){e[l]?n(e[l]):t(p(void 0,!0))}))}));var n,a=this[h];if(a)n=new Promise(g(a,this));else{var r=this[d].read();if(null!==r)return Promise.resolve(p(r,!1));n=new Promise(this[u])}return this[h]=n,n}},Symbol.asyncIterator,(function(){return this})),a(n,"return",(function(){var e=this;return new Promise((function(t,i){e[d].destroy(null,(function(e){e?i(e):t(p(void 0,!0))}))}))})),n),y),b=function(e){var t,i=Object.create(v,(a(t={},d,{value:e,writable:!0}),a(t,s,{value:null,writable:!0}),a(t,o,{value:null,writable:!0}),a(t,l,{value:null,writable:!0}),a(t,c,{value:e._readableState.endEmitted,writable:!0}),a(t,u,{value:function(e,t){var n=i[d].read();n?(i[h]=null,i[s]=null,i[o]=null,e(p(n,!1))):(i[s]=e,i[o]=t)},writable:!0}),t));return i[h]=null,r(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=i[o];return null!==t&&(i[h]=null,i[s]=null,i[o]=null,t(e)),void(i[l]=e)}var n=i[s];null!==n&&(i[h]=null,i[s]=null,i[o]=null,n(p(void 0,!0))),i[c]=!0})),e.on("readable",f.bind(null,i)),i};t.exports=b}).call(this)}).call(this,e("_process"))},{"./end-of-stream":71,_process:60}],69:[function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),e}var c=e("buffer").Buffer,h=e("util").inspect,u=h&&h.custom||"inspect";function d(e,t,i){c.prototype.copy.call(e,t,i)}t.exports=function(){function e(){s(this,e),this.head=null,this.tail=null,this.length=0}return l(e,[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,i=""+t.data;t=t.next;)i+=e+t.data;return i}},{key:"concat",value:function(e){if(0===this.length)return c.alloc(0);for(var t=c.allocUnsafe(e>>>0),i=this.head,n=0;i;)d(i.data,t,n),n+=i.data.length,i=i.next;return t}},{key:"consume",value:function(e,t){var i;return e<this.head.data.length?(i=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):i=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),i}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,i=1,n=t.data;for(e-=n.length;t=t.next;){var a=t.data,r=e>a.length?a.length:e;if(r===a.length?n+=a:n+=a.slice(0,e),0==(e-=r)){r===a.length?(++i,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=a.slice(r));break}++i}return this.length-=i,n}},{key:"_getBuffer",value:function(e){var t=c.allocUnsafe(e),i=this.head,n=1;for(i.data.copy(t),e-=i.data.length;i=i.next;){var a=i.data,r=e>a.length?a.length:e;if(a.copy(t,t.length-e,0,r),0==(e-=r)){r===a.length?(++n,i.next?this.head=i.next:this.head=this.tail=null):(this.head=i,i.data=a.slice(r));break}++n}return this.length-=n,t}},{key:u,value:function(e,t){return h(this,a({},t,{depth:0,customInspect:!1}))}}]),e}()},{buffer:33,util:30}],70:[function(e,t,i){(function(e){(function(){function i(t,i){var r=this,o=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return o||l?(i?i(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,e.nextTick(s,this,t)):e.nextTick(s,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!i&&t?r._writableState?r._writableState.errorEmitted?e.nextTick(a,r):(r._writableState.errorEmitted=!0,e.nextTick(n,r,t)):e.nextTick(n,r,t):i?(e.nextTick(a,r),i(t)):e.nextTick(a,r)})),this)}function n(e,t){s(e,t),a(e)}function a(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function r(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function s(e,t){e.emit("error",t)}function o(e,t){var i=e._readableState,n=e._writableState;i&&i.autoDestroy||n&&n.autoDestroy?e.destroy(t):e.emit("error",t)}t.exports={destroy:i,undestroy:r,errorOrDestroy:o}}).call(this)}).call(this,e("_process"))},{_process:60}],71:[function(e,t,i){var n=e("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function a(e){var t=!1;return function(){if(!t){t=!0;for(var i=arguments.length,n=new Array(i),a=0;a<i;a++)n[a]=arguments[a];e.apply(this,n)}}}function r(){}function s(e){return e.setHeader&&"function"==typeof e.abort}function o(e,t,i){if("function"==typeof t)return o(e,null,t);t||(t={}),i=a(i||r);var l=t.readable||!1!==t.readable&&e.readable,c=t.writable||!1!==t.writable&&e.writable,h=function(){e.writable||d()},u=e._writableState&&e._writableState.finished,d=function(){c=!1,u=!0,l||i.call(e)},p=e._readableState&&e._readableState.endEmitted,m=function(){l=!1,p=!0,c||i.call(e)},f=function(t){i.call(e,t)},g=function(){var t;return l&&!p?(e._readableState&&e._readableState.ended||(t=new n),i.call(e,t)):c&&!u?(e._writableState&&e._writableState.ended||(t=new n),i.call(e,t)):void 0},y=function(){e.req.on("finish",d)};return s(e)?(e.on("complete",d),e.on("abort",g),e.req?y():e.on("request",y)):c&&!e._writableState&&(e.on("end",h),e.on("close",h)),e.on("end",m),e.on("finish",d),!1!==t.error&&e.on("error",f),e.on("close",g),function(){e.removeListener("complete",d),e.removeListener("abort",g),e.removeListener("request",y),e.req&&e.req.removeListener("finish",d),e.removeListener("end",h),e.removeListener("close",h),e.removeListener("finish",d),e.removeListener("end",m),e.removeListener("error",f),e.removeListener("close",g)}}t.exports=o},{"../../../errors":62}],72:[function(e,t,i){t.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],73:[function(e,t,i){var n;function a(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}var r=e("../../../errors").codes,s=r.ERR_MISSING_ARGS,o=r.ERR_STREAM_DESTROYED;function l(e){if(e)throw e}function c(e){return e.setHeader&&"function"==typeof e.abort}function h(t,i,r,s){s=a(s);var l=!1;t.on("close",(function(){l=!0})),void 0===n&&(n=e("./end-of-stream")),n(t,{readable:i,writable:r},(function(e){if(e)return s(e);l=!0,s()}));var h=!1;return function(e){if(!l&&!h)return h=!0,c(t)?t.abort():"function"==typeof t.destroy?t.destroy():void s(e||new o("pipe"))}}function u(e){e()}function d(e,t){return e.pipe(t)}function p(e){return e.length?"function"!=typeof e[e.length-1]?l:e.pop():l}function m(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n,a=p(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new s("streams");var r=t.map((function(e,i){var s=i<t.length-1;return h(e,s,i>0,(function(e){n||(n=e),e&&r.forEach(u),s||(r.forEach(u),a(n))}))}));return t.reduce(d)}t.exports=m},{"../../../errors":62,"./end-of-stream":71}],74:[function(e,t,i){var n=e("../../../errors").codes.ERR_INVALID_OPT_VALUE;function a(e,t,i){return null!=e.highWaterMark?e.highWaterMark:t?e[i]:null}function r(e,t,i,r){var s=a(t,r,i);if(null!=s){if(!isFinite(s)||Math.floor(s)!==s||s<0)throw new n(r?i:"highWaterMark",s);return Math.floor(s)}return e.objectMode?16:16384}t.exports={getHighWaterMark:r}},{"../../../errors":62}],75:[function(e,t,i){t.exports=e("events").EventEmitter},{events:38}],76:[function(e,t,i){var n=e("safe-buffer").Buffer,a=n.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function r(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}function s(e){var t=r(e);if("string"!=typeof t&&(n.isEncoding===a||!a(e)))throw new Error("Unknown encoding: "+e);return t||e}function o(e){var t;switch(this.encoding=s(e),this.encoding){case"utf16le":this.text=m,this.end=f,t=4;break;case"utf8":this.fillLast=u,t=4;break;case"base64":this.text=g,this.end=y,t=3;break;default:return this.write=v,void(this.end=b)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(t)}function l(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function c(e,t,i){var n=t.length-1;if(n<i)return 0;var a=l(t[n]);return a>=0?(a>0&&(e.lastNeed=a-1),a):--n<i||-2===a?0:(a=l(t[n]))>=0?(a>0&&(e.lastNeed=a-2),a):--n<i||-2===a?0:(a=l(t[n]))>=0?(a>0&&(2===a?a=0:e.lastNeed=a-3),a):0}function h(e,t,i){if(128!=(192&t[0]))return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"�"}}function u(e){var t=this.lastTotal-this.lastNeed,i=h(this,e);return void 0!==i?i:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function d(e,t){var i=c(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=i;var n=e.length-(i-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)}function p(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t}function m(e,t){if((e.length-t)%2==0){var i=e.toString("utf16le",t);if(i){var n=i.charCodeAt(i.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],i.slice(0,-1)}return i}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function f(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var i=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,i)}return t}function g(e,t){var i=(e.length-t)%3;return 0===i?e.toString("base64",t):(this.lastNeed=3-i,this.lastTotal=3,1===i?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-i))}function y(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function v(e){return e.toString(this.encoding)}function b(e){return e&&e.length?this.write(e):""}i.StringDecoder=o,o.prototype.write=function(e){if(0===e.length)return"";var t,i;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<e.length?t?t+this.text(e,i):this.text(e,i):t||""},o.prototype.end=p,o.prototype.text=d,o.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},{"safe-buffer":77}],77:[function(e,t,i){/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var n=e("buffer"),a=n.Buffer;function r(e,t){for(var i in e)t[i]=e[i]}function s(e,t,i){return a(e,t,i)}a.from&&a.alloc&&a.allocUnsafe&&a.allocUnsafeSlow?t.exports=n:(r(n,i),i.Buffer=s),s.prototype=Object.create(a.prototype),r(a,s),s.from=function(e,t,i){if("number"==typeof e)throw new TypeError("Argument must not be a number");return a(e,t,i)},s.alloc=function(e,t,i){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=a(e);return void 0!==t?"string"==typeof i?n.fill(t,i):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return a(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:33}],78:[function(e,t,i){(function(e){(function(){function i(e,t){if(n("noDeprecation"))return e;var i=!1;function a(){if(!i){if(n("throwDeprecation"))throw new Error(t);n("traceDeprecation")?console.trace(t):console.warn(t),i=!0}return e.apply(this,arguments)}return a}function n(t){try{if(!e.localStorage)return!1}catch(e){return!1}var i=e.localStorage[t];return null!=i&&"true"===String(i).toLowerCase()}t.exports=i}).call(this)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],79:[function(e,t,i){arguments[4][25][0].apply(i,arguments)},{dup:25}],80:[function(e,t,i){var n=e("is-arguments"),a=e("is-generator-function"),r=e("which-typed-array"),s=e("is-typed-array");function o(e){return e.call.bind(e)}var l="undefined"!=typeof BigInt,c="undefined"!=typeof Symbol,h=o(Object.prototype.toString),u=o(Number.prototype.valueOf),d=o(String.prototype.valueOf),p=o(Boolean.prototype.valueOf);if(l)var m=o(BigInt.prototype.valueOf);if(c)var f=o(Symbol.prototype.valueOf);function g(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function y(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch}function v(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):s(e)||j(e)}function b(e){return"Uint8Array"===r(e)}function _(e){return"Uint8ClampedArray"===r(e)}function x(e){return"Uint16Array"===r(e)}function w(e){return"Uint32Array"===r(e)}function S(e){return"Int8Array"===r(e)}function M(e){return"Int16Array"===r(e)}function T(e){return"Int32Array"===r(e)}function A(e){return"Float32Array"===r(e)}function E(e){return"Float64Array"===r(e)}function C(e){return"BigInt64Array"===r(e)}function I(e){return"BigUint64Array"===r(e)}function P(e){return"[object Map]"===h(e)}function R(e){return"undefined"!=typeof Map&&(P.working?P(e):e instanceof Map)}function O(e){return"[object Set]"===h(e)}function D(e){return"undefined"!=typeof Set&&(O.working?O(e):e instanceof Set)}function L(e){return"[object WeakMap]"===h(e)}function k(e){return"undefined"!=typeof WeakMap&&(L.working?L(e):e instanceof WeakMap)}function N(e){return"[object WeakSet]"===h(e)}function B(e){return N(e)}function z(e){return"[object ArrayBuffer]"===h(e)}function U(e){return"undefined"!=typeof ArrayBuffer&&(z.working?z(e):e instanceof ArrayBuffer)}function F(e){return"[object DataView]"===h(e)}function j(e){return"undefined"!=typeof DataView&&(F.working?F(e):e instanceof DataView)}function H(e){return"[object SharedArrayBuffer]"===h(e)}function G(e){return"undefined"!=typeof SharedArrayBuffer&&(H.working?H(e):e instanceof SharedArrayBuffer)}function V(e){return"[object AsyncFunction]"===h(e)}function W(e){return"[object Map Iterator]"===h(e)}function Y(e){return"[object Set Iterator]"===h(e)}function X(e){return"[object Generator]"===h(e)}function Z(e){return"[object WebAssembly.Module]"===h(e)}function q(e){return g(e,u)}function J(e){return g(e,d)}function Q(e){return g(e,p)}function K(e){return l&&g(e,m)}function $(e){return c&&g(e,f)}function ee(e){return q(e)||J(e)||Q(e)||K(e)||$(e)}function te(e){return"undefined"!=typeof Uint8Array&&(U(e)||G(e))}i.isArgumentsObject=n,i.isGeneratorFunction=a,i.isTypedArray=s,i.isPromise=y,i.isArrayBufferView=v,i.isUint8Array=b,i.isUint8ClampedArray=_,i.isUint16Array=x,i.isUint32Array=w,i.isInt8Array=S,i.isInt16Array=M,i.isInt32Array=T,i.isFloat32Array=A,i.isFloat64Array=E,i.isBigInt64Array=C,i.isBigUint64Array=I,P.working="undefined"!=typeof Map&&P(new Map),i.isMap=R,O.working="undefined"!=typeof Set&&O(new Set),i.isSet=D,L.working="undefined"!=typeof WeakMap&&L(new WeakMap),i.isWeakMap=k,N.working="undefined"!=typeof WeakSet&&N(new WeakSet),i.isWeakSet=B,z.working="undefined"!=typeof ArrayBuffer&&z(new ArrayBuffer),i.isArrayBuffer=U,F.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&F(new DataView(new ArrayBuffer(1),0,1)),i.isDataView=j,H.working="undefined"!=typeof SharedArrayBuffer&&H(new SharedArrayBuffer),i.isSharedArrayBuffer=G,i.isAsyncFunction=V,i.isMapIterator=W,i.isSetIterator=Y,i.isGeneratorObject=X,i.isWebAssemblyCompiledModule=Z,i.isNumberObject=q,i.isStringObject=J,i.isBooleanObject=Q,i.isBigIntObject=K,i.isSymbolObject=$,i.isBoxedPrimitive=ee,i.isAnyArrayBuffer=te,["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(i,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},{"is-arguments":46,"is-generator-function":47,"is-typed-array":48,"which-typed-array":82}],81:[function(e,t,i){(function(t){(function(){var n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},n=0;n<t.length;n++)i[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return i},a=/%[sdj%]/g;i.format=function(e){if(!S(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(l(arguments[i]));return t.join(" ")}i=1;for(var n=arguments,r=n.length,s=String(e).replace(a,(function(e){if("%%"===e)return"%";if(i>=r)return e;switch(e){case"%s":return String(n[i++]);case"%d":return Number(n[i++]);case"%j":try{return JSON.stringify(n[i++])}catch(e){return"[Circular]"}default:return e}})),o=n[i];i<r;o=n[++i])_(o)||!E(o)?s+=" "+o:s+=" "+l(o);return s},i.deprecate=function(e,n){if(void 0!==t&&!0===t.noDeprecation)return e;if(void 0===t)return function(){return i.deprecate(e,n).apply(this,arguments)};var a=!1;function r(){if(!a){if(t.throwDeprecation)throw new Error(n);t.traceDeprecation?console.trace(n):console.error(n),a=!0}return e.apply(this,arguments)}return r};var r={},s=/^$/;if(t.env.NODE_DEBUG){var o=t.env.NODE_DEBUG;o=o.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),s=new RegExp("^"+o+"$","i")}function l(e,t){var n={seen:[],stylize:h};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),b(t)?n.showHidden=t:t&&i._extend(n,t),T(n.showHidden)&&(n.showHidden=!1),T(n.depth)&&(n.depth=2),T(n.colors)&&(n.colors=!1),T(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=c),d(n,e,n.depth)}function c(e,t){var i=l.styles[t];return i?"["+l.colors[i][0]+"m"+e+"["+l.colors[i][1]+"m":e}function h(e,t){return e}function u(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}function d(e,t,n){if(e.customInspect&&t&&P(t.inspect)&&t.inspect!==i.inspect&&(!t.constructor||t.constructor.prototype!==t)){var a=t.inspect(n,e);return S(a)||(a=d(e,a,n)),a}var r=p(e,t);if(r)return r;var s=Object.keys(t),o=u(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(t)),I(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return m(t);if(0===s.length){if(P(t)){var l=t.name?": "+t.name:"";return e.stylize("[Function"+l+"]","special")}if(A(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(C(t))return e.stylize(Date.prototype.toString.call(t),"date");if(I(t))return m(t)}var c,h="",b=!1,_=["{","}"];return v(t)&&(b=!0,_=["[","]"]),P(t)&&(h=" [Function"+(t.name?": "+t.name:"")+"]"),A(t)&&(h=" "+RegExp.prototype.toString.call(t)),C(t)&&(h=" "+Date.prototype.toUTCString.call(t)),I(t)&&(h=" "+m(t)),0!==s.length||b&&0!=t.length?n<0?A(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),c=b?f(e,t,n,o,s):s.map((function(i){return g(e,t,n,o,i,b)})),e.seen.pop(),y(c,h,_)):_[0]+h+_[1]}function p(e,t){if(T(t))return e.stylize("undefined","undefined");if(S(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return w(t)?e.stylize(""+t,"number"):b(t)?e.stylize(""+t,"boolean"):_(t)?e.stylize("null","null"):void 0}function m(e){return"["+Error.prototype.toString.call(e)+"]"}function f(e,t,i,n,a){for(var r=[],s=0,o=t.length;s<o;++s)N(t,String(s))?r.push(g(e,t,i,n,String(s),!0)):r.push("");return a.forEach((function(a){a.match(/^\d+$/)||r.push(g(e,t,i,n,a,!0))})),r}function g(e,t,i,n,a,r){var s,o,l;if((l=Object.getOwnPropertyDescriptor(t,a)||{value:t[a]}).get?o=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(o=e.stylize("[Setter]","special")),N(n,a)||(s="["+a+"]"),o||(e.seen.indexOf(l.value)<0?(o=_(i)?d(e,l.value,null):d(e,l.value,i-1)).indexOf("\n")>-1&&(o=r?o.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+o.split("\n").map((function(e){return"   "+e})).join("\n")):o=e.stylize("[Circular]","special")),T(s)){if(r&&a.match(/^\d+$/))return o;(s=JSON.stringify(""+a)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+o}function y(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]}function v(e){return Array.isArray(e)}function b(e){return"boolean"==typeof e}function _(e){return null===e}function x(e){return null==e}function w(e){return"number"==typeof e}function S(e){return"string"==typeof e}function M(e){return"symbol"==typeof e}function T(e){return void 0===e}function A(e){return E(e)&&"[object RegExp]"===O(e)}function E(e){return"object"==typeof e&&null!==e}function C(e){return E(e)&&"[object Date]"===O(e)}function I(e){return E(e)&&("[object Error]"===O(e)||e instanceof Error)}function P(e){return"function"==typeof e}function R(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function O(e){return Object.prototype.toString.call(e)}function D(e){return e<10?"0"+e.toString(10):e.toString(10)}i.debuglog=function(e){if(e=e.toUpperCase(),!r[e])if(s.test(e)){var n=t.pid;r[e]=function(){var t=i.format.apply(i,arguments);console.error("%s %d: %s",e,n,t)}}else r[e]=function(){};return r[e]},i.inspect=l,l.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},l.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},i.types=e("./support/types"),i.isArray=v,i.isBoolean=b,i.isNull=_,i.isNullOrUndefined=x,i.isNumber=w,i.isString=S,i.isSymbol=M,i.isUndefined=T,i.isRegExp=A,i.types.isRegExp=A,i.isObject=E,i.isDate=C,i.types.isDate=C,i.isError=I,i.types.isNativeError=I,i.isFunction=P,i.isPrimitive=R,i.isBuffer=e("./support/isBuffer");var L=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function k(){var e=new Date,t=[D(e.getHours()),D(e.getMinutes()),D(e.getSeconds())].join(":");return[e.getDate(),L[e.getMonth()],t].join(" ")}function N(e,t){return Object.prototype.hasOwnProperty.call(e,t)}i.log=function(){console.log("%s - %s",k(),i.format.apply(i,arguments))},i.inherits=e("inherits"),i._extend=function(e,t){if(!t||!E(t))return e;for(var i=Object.keys(t),n=i.length;n--;)e[i[n]]=t[i[n]];return e};var B="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function z(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}function U(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function i(){for(var i=[],n=0;n<arguments.length;n++)i.push(arguments[n]);var a=i.pop();if("function"!=typeof a)throw new TypeError("The last argument must be of type Function");var r=this,s=function(){return a.apply(r,arguments)};e.apply(this,i).then((function(e){t.nextTick(s.bind(null,null,e))}),(function(e){t.nextTick(z.bind(null,e,s))}))}return Object.setPrototypeOf(i,Object.getPrototypeOf(e)),Object.defineProperties(i,n(e)),i}i.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(B&&e[B]){var t;if("function"!=typeof(t=e[B]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,B,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,n=new Promise((function(e,n){t=e,i=n})),a=[],r=0;r<arguments.length;r++)a.push(arguments[r]);a.push((function(e,n){e?i(e):t(n)}));try{e.apply(this,a)}catch(e){i(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),B&&Object.defineProperty(t,B,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},i.promisify.custom=B,i.callbackify=U}).call(this)}).call(this,e("_process"))},{"./support/isBuffer":79,"./support/types":80,_process:60,inherits:45}],82:[function(e,t,i){(function(i){(function(){var n=e("foreach"),a=e("available-typed-arrays"),r=e("es-abstract/helpers/callBound"),s=r("Object.prototype.toString"),o=e("has-symbols")()&&"symbol"==typeof Symbol.toStringTag,l=a(),c=r("String.prototype.slice"),h={},u=e("es-abstract/helpers/getOwnPropertyDescriptor"),d=Object.getPrototypeOf;o&&u&&d&&n(l,(function(e){if("function"==typeof i[e]){var t=new i[e];if(!(Symbol.toStringTag in t))throw new EvalError("this engine has support for Symbol.toStringTag, but "+e+" does not have the property! Please report this.");var n=d(t),a=u(n,Symbol.toStringTag);if(!a){var r=d(n);a=u(r,Symbol.toStringTag)}h[e]=a.get}}));var p=function(e){var t=!1;return n(h,(function(i,n){if(!t)try{var a=i.call(e);a===n&&(t=a)}catch(e){}})),t},m=e("is-typed-array");t.exports=function(e){return!!m(e)&&(o?p(e):c(s(e),8,-1))}}).call(this)}).call(this,void 0!==Bg?Bg:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"available-typed-arrays":27,"es-abstract/helpers/callBound":36,"es-abstract/helpers/getOwnPropertyDescriptor":37,foreach:39,"has-symbols":42,"is-typed-array":48}]},{},[20])(20)}));const vw=(e,t,i)=>{if(!e)return t;if(!t)return e;let n;if(e.image===t.image)n=new we(e.image);else{let a=((e,t)=>{const i=[e.width,e.height,t.width,t.height];let n=i[0];for(let e=0;e<i.length;e++)n=Math.max(n,i[e]);return n})(e.image,t.image);i&&a>i&&(a=i),a>16384&&(a=16384);const r=document.createElement("canvas");r.width=a,r.height=a;const s=r.getContext("2d");s.fillstyle="#ffffff",s.fillRect(0,0,a,a);const o=s.getImageData(0,0,a,a),l=void 0!==t?t.image:void 0,c=void 0!==e?e.image:void 0;if(t){s.drawImage(l,0,0,a,a,0,0,a,a);const e=s.getImageData(0,0,a,a).data;for(let t=1;t<e.length;t+=4)o.data[t]=e[t]}if(e){s.drawImage(c,0,0,a,a,0,0,a,a);const e=s.getImageData(0,0,a,a).data;for(let t=2;t<e.length;t+=4)o.data[t]=e[t]}s.putImageData(o,0,0),n=new we(r)}const a=t&&t.name,r=e&&e.name;return n.name=a===r?a:a+"#MetalnessAndRoughness#"+r,n};class bw{constructor(){this.pluginCallbacks=[],this.register((function(e){return new Xw(e)})),this.register((function(e){return new Zw(e)})),this.register((function(e){return new qw(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i){const n=new Yw,a=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)a.push(this.pluginCallbacks[e](n));n.setPlugins(a),n.write(e,t,i)}}const _w=0,xw=1,ww=2,Sw=3,Mw=4,Tw=5121,Aw=5123,Ew=5126,Cw=5125,Iw=34962,Pw=34963,Rw=9728,Ow=9729,Dw=9984,Lw=9985,kw=9986,Nw=9987,Bw=33071,zw=33648,Uw=10497,Fw={};Fw[1003]=Rw,Fw[1004]=Dw,Fw[1005]=kw,Fw[1006]=Ow,Fw[1007]=Lw,Fw[1008]=Nw,Fw[1001]=Bw,Fw[1e3]=Uw,Fw[1002]=zw;const jw={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};function Hw(e,t){return e.length===t.length&&e.every((function(e,i){return e===t[i]}))}function Gw(e){return 4*Math.ceil(e/4)}function Vw(e,t=0){const i=Gw(e.byteLength);if(i!==e.byteLength){const n=new Uint8Array(i);if(n.set(new Uint8Array(e)),0!==t)for(let a=e.byteLength;a<i;a++)n[a]=t;return n.buffer}return e}let Ww=null;class Yw{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}write(e,t,i){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,minTextureSize:1,textureSizeFactor:1,animations:[],includeCustomExtensions:!1},i),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);const n=this;Promise.all(this.pending).then((function(){const e=n.buffers,i=n.json,a=n.options,r=n.extensionsUsed,s=new Blob(e,{type:"application/octet-stream"}),o=Object.keys(r);if(o.length>0&&(i.extensionsUsed=o),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=s.size),!0===a.binary){const e=new window.FileReader;e.readAsArrayBuffer(s),e.onloadend=function(){const n=Vw(e.result),a=new DataView(new ArrayBuffer(8));a.setUint32(0,n.byteLength,!0),a.setUint32(4,5130562,!0);const r=Vw(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;const t=new Uint8Array(new ArrayBuffer(e.length));for(let i=0,n=e.length;i<n;i++){const n=e.charCodeAt(i);t[i]=n>255?32:n}return t.buffer}(JSON.stringify(i)),32),s=new DataView(new ArrayBuffer(8));s.setUint32(0,r.byteLength,!0),s.setUint32(4,1313821514,!0);const o=new ArrayBuffer(12),l=new DataView(o);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);const c=12+s.byteLength+r.byteLength+a.byteLength+n.byteLength;l.setUint32(8,c,!0);const h=new Blob([o,s,r,a,n],{type:"application/octet-stream"}),u=new window.FileReader;u.readAsArrayBuffer(h),u.onloadend=function(){t(u.result)}}}else if(i.buffers&&i.buffers.length>0){const e=new window.FileReader;e.readAsDataURL(s),e.onloadend=function(){const n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}))}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const i=this.options,n=this.extensionsUsed;try{const a=JSON.parse(JSON.stringify(e.userData));if(i.includeCustomExtensions&&a.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in a.gltfExtensions)t.extensions[e]=a.gltfExtensions[e],n[e]=!0;delete a.gltfExtensions}Object.keys(a).length>0&&(t.extras=a)}catch(t){logger.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new Ce;for(let i=0,n=e.count;i<n;i++)if(Math.abs(t.fromBufferAttribute(e,i).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const i=e.clone(),n=new Ce;for(let e=0,t=i.count;e<t;e++)n.fromBufferAttribute(i,e),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),i.setXYZ(e,n.x,n.y,n.z);return t.attributesNormalized.set(e,i),i}applyTextureTransform(e,t){let i=!1;const n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),i=!0),0!==t.rotation&&(n.rotation=t.rotation,i=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),i=!0),i&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}processBuffer(e){const t=this.json,i=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),i.push(e),0}processBufferView(e,t,i,n,a){const r=this.json;let s;r.bufferViews||(r.bufferViews=[]),s=t===Tw?1:t===Aw?2:4;const o=Gw(n*e.itemSize*s),l=new DataView(new ArrayBuffer(o));let c=0;for(let a=i;a<i+n;a++)for(let i=0;i<e.itemSize;i++){let n;e.itemSize>4?n=e.array[a*e.itemSize+i]:0===i?n=e.getX(a):1===i?n=e.getY(a):2===i?n=e.getZ(a):3===i&&(n=e.getW(a)),t===Ew?l.setFloat32(c,n,!0):t===Cw?l.setUint32(c,n,!0):t===Aw?l.setUint16(c,n,!0):t===Tw&&l.setUint8(c,n),c+=s}const h={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:o};void 0!==a&&(h.target=a),a===Iw&&(h.byteStride=e.itemSize*s),this.byteOffset+=o,r.bufferViews.push(h);return{id:r.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,i=t.json;return i.bufferViews||(i.bufferViews=[]),new Promise((function(n){const a=new window.FileReader;a.readAsArrayBuffer(e),a.onloadend=function(){const e=Vw(a.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(i.bufferViews.push(r)-1)}}))}processAccessor(e,t,i,n){const a=this.options,r=this.json;let s;if(e.array.constructor===Float32Array)s=Ew;else if(e.array.constructor===Uint32Array)s=Cw;else if(e.array.constructor===Uint16Array)s=Aw;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");s=Tw}if(void 0===i&&(i=0),void 0===n&&(n=e.count),a.truncateDrawRange&&void 0!==t&&null===t.index){const a=i+n,r=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;i=Math.max(i,t.drawRange.start),(n=Math.min(a,r)-i)<0&&(n=0)}if(0===n)return null;const o=function(e,t,i){const n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let a=t;a<t+i;a++)for(let t=0;t<e.itemSize;t++){let i;e.itemSize>4?i=e.array[a*e.itemSize+t]:0===t?i=e.getX(a):1===t?i=e.getY(a):2===t?i=e.getZ(a):3===t&&(i=e.getW(a)),n.min[t]=Math.min(n.min[t],i),n.max[t]=Math.max(n.max[t],i)}return n}(e,i,n);let l;void 0!==t&&(l=e===t.index?Pw:Iw);const c=this.processBufferView(e,s,i,n,l),h={bufferView:c.id,byteOffset:c.byteOffset,componentType:s,count:n,max:o.max,min:o.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(h.normalized=!0),r.accessors||(r.accessors=[]),r.accessors.push(h)-1}processImage(e,t,i){const n=this,a=n.cache,r=n.json,s=n.options,o=n.pending;a.images.has(e)||a.images.set(e,{});const l=a.images.get(e);let c=t===I?"image/png":"image/jpeg";const h=c+":flipY/"+i.toString();if(void 0!==l[h])return l[h];r.images||(r.images=[]);const u={mimeType:c};if(s.embedImages){const a=Ww=Ww||document.createElement("canvas");if(s.textureSizeFactor<1)for(a.width=e.width*s.textureSizeFactor,a.height=e.height*s.textureSizeFactor;a.width<s.minTextureSize||a.height<s.minTextureSize;)a.width*=2,a.height*=2;else a.width=Math.min(e.width,s.maxTextureSize),a.height=Math.min(e.height,s.maxTextureSize);const r=a.getContext("2d");if(!0===i&&(r.translate(0,a.height),r.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)r.drawImage(e,0,0,a.width,a.height);else{t!==I&&t!==C&&logger.error("GLTFExporter: Only RGB and RGBA formats are supported."),(e.width>s.maxTextureSize||e.height>s.maxTextureSize)&&logger.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let i=e.data;if(t===C){i=new Uint8ClampedArray(e.height*e.width*4);for(let t=0,n=0;t<i.length;t+=4,n+=3)i[t+0]=e.data[n+0],i[t+1]=e.data[n+1],i[t+2]=e.data[n+2],i[t+3]=255}r.putImageData(new ImageData(i,e.width,e.height),0,0)}if(!0===s.binary)if((!s.maxTextureSize||s.maxTextureSize===1/0)&&e instanceof ImageBitmap&&Zo&&Zo.get(e)&&1===s.textureSizeFactor)o.push(new Promise((function(t){let i=Zo.get(e);n.processBufferViewImage(i).then((function(e){u.bufferView=e,t()}))})));else{const t=function(e){let t=document.createElement("canvas").getContext("webgl2");t.activeTexture(t.TEXTURE0);let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);const n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.drawBuffers([t.COLOR_ATTACHMENT0]);let a=new Uint8Array(e.width*e.height*4);return t.readPixels(0,0,e.width,e.height,t.RGBA,t.UNSIGNED_BYTE,a),a}(e);let i=!1;for(let e=0;e<t.length;e+=4)t[e+3]<255&&(i=!0);i||(c="image/jpeg"),o.push(new Promise((i=>{a.toBlob((function(a){if("image/png"===a.type){let i=8,n=6,o=4,l=e.width,c=e.height,h=1;if(s.textureSizeFactor<1&&s.textureSizeFactor>0)for(h=1/s.textureSizeFactor,l=e.width*s.textureSizeFactor,c=e.height*s.textureSizeFactor;l<s.minTextureSize||c<s.minTextureSize;)l*=2,c*=2,h/=2;else l=Math.min(e.width,s.maxTextureSize),c=Math.min(e.height,s.maxTextureSize);let u={width:l,height:c,bitDepth:i,colorType:n,filterType:o},d=new yw.PNG(u);if(1===h)for(let e=0;e<d.data.length;e+=4)d.data[e+0]=t[e+0],d.data[e+1]=t[e+1],d.data[e+2]=t[e+2],d.data[e+3]=t[e+3];else!function(e,t,i,n,a){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||"number"!=typeof i||i<2)return void console.warn("Resampling failed because input is invalid.");if("number"!=typeof n||"number"!=typeof a)return void console.warn("Resampling failed because input is invalid.");if(0===e.length||0===t.length||e.length%4!=0||e.length%4!=0)return void console.warn("Resampling failed because input is invalid.");if(e.length!==n*a*4)return void console.warn("Resampling failed because buffer size doesn't match.");const r=i*i;if(e.length!==t.length*r)return void console.warn("Resampling failed because buffer size doesn't match.");const s=n/i,o=a/i;for(let n=0;n<o;n++)for(let a=0;a<s;a++){let o=0,l=0,c=0,h=0;for(let t=0;t<i;t++)for(let r=0;r<i;r++){const u=(n*i+t)*(s*i)+(a*i+r);o+=e[4*u],l+=e[4*u+1],c+=e[4*u+2],h+=e[4*u+3]}t[4*(n*s+a)]=Math.round(o/r),t[4*(n*s+a)+1]=Math.round(l/r),t[4*(n*s+a)+2]=Math.round(c/r),t[4*(n*s+a)+3]=Math.round(h/r)}}(t,d.data,h,e.width,e.height);d.pack();var r=yw.PNG.sync.write(d,u);a=new Blob([r],{type:a.type})}n.processBufferViewImage(a).then((function(e){u.bufferView=e,i()}))}),c,1)})))}else u.uri=a.toDataURL(c)}else u.uri=e.src;const d=r.images.push(u)-1;return l[h]=d,d}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const i={magFilter:Fw[e.magFilter],minFilter:Fw[e.minFilter],wrapS:Fw[e.wrapS],wrapT:Fw[e.wrapT]};return t.samplers.push(i)-1}processTexture(e){const t=this.cache,i=this.json;if(t.textures.has(e))return t.textures.get(e);i.textures||(i.textures=[]);const n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(n.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,n)}));const a=i.textures.push(n)-1;return t.textures.set(e,a),a}processMaterial(e){const t=this.cache,i=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return logger.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;i.materials||(i.materials=[]);const n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&logger.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const a=e.color.toArray().concat([e.opacity]);if(Hw(a,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=a),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const t=vw(e.metalnessMap,e.roughnessMap,this.options.maxTextureSize),i={index:this.processTexture(t)};this.applyTextureTransform(i,t),n.pbrMetallicRoughness.metallicRoughnessTexture=i}if(e.map){const t={index:this.processTexture(e.map)};this.applyTextureTransform(t,e.map),n.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(Hw(t,[0,0,0])||(n.emissiveFactor=t),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(t,e.emissiveMap),n.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap)};e.normalScale&&-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&logger.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),n.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),n.occlusionTexture=t}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),2===e.side&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,n)}));const r=i.materials.push(n)-1;return t.materials.set(e,r),r}processMesh(e){const t=this.cache,i=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,i=e.material.length;t<i;t++)n.push(e.material[t].uuid);else n.push(e.material.uuid);const a=n.join(":");if(t.meshes.has(a))return t.meshes.get(a);const r=e.geometry;let s;if(s=e.isLineSegments?xw:e.isLineLoop?ww:e.isLine?Sw:e.isPoints?_w:e.material.wireframe?xw:Mw,!0!==r.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");const o={},l={},c=[],h=[],u={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=r.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(logger.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),r.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let p=null;for(let e in r.attributes){if("morph"===e.substr(0,5))continue;const i=r.attributes[e];e=u[e]||e.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(i))){l[e]=t.attributes.get(this.getUID(i));continue}p=null;const n=i.array;"JOINTS_0"!==e||n instanceof Uint16Array||n instanceof Uint8Array||(logger.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),p=new ti(new Uint16Array(n),i.itemSize,i.normalized));const a=this.processAccessor(p||i,r);null!==a&&(l[e]=a,t.attributes.set(this.getUID(i),a))}if(void 0!==d&&r.setAttribute("normal",d),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const i=[],n=[],a={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)a[e.morphTargetDictionary[t]]=t;for(let s=0;s<e.morphTargetInfluences.length;++s){const o={};let l=!1;for(const e in r.morphAttributes){if("position"!==e&&"normal"!==e){l||(logger.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const i=r.morphAttributes[e][s],n=e.toUpperCase(),a=r.attributes[e];if(t.attributes.has(this.getUID(i))){o[n]=t.attributes.get(this.getUID(i));continue}const c=i.clone();if(!r.morphTargetsRelative)for(let e=0,t=i.count;e<t;e++)c.setXYZ(e,i.getX(e)-a.getX(e),i.getY(e)-a.getY(e),i.getZ(e)-a.getZ(e));o[n]=this.processAccessor(c,r),t.attributes.set(this.getUID(a),o[n])}h.push(o),i.push(e.morphTargetInfluences[s]),void 0!==e.morphTargetDictionary&&n.push(a[s])}o.weights=i,n.length>0&&(o.extras={},o.extras.targetNames=n)}const m=Array.isArray(e.material);if(m&&0===r.groups.length)return null;const f=m?e.material:[e.material],g=m?r.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,i=g.length;e<i;e++){const i={mode:s,attributes:l};if(this.serializeUserData(r,i),h.length>0&&(i.targets=h),null!==r.index){let n=this.getUID(r.index);void 0===g[e].start&&void 0===g[e].count||(n+=":"+g[e].start+":"+g[e].count),t.attributes.has(n)?i.indices=t.attributes.get(n):(i.indices=this.processAccessor(r.index,r,g[e].start,g[e].count),t.attributes.set(n,i.indices)),null===i.indices&&delete i.indices}const n=this.processMaterial(f[g[e].materialIndex]);null!==n&&(i.material=n),c.push(i)}o.primitives=c,i.meshes||(i.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,o)}));const y=i.meshes.push(o)-1;return t.meshes.set(a,y),y}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const i=e.isOrthographicCamera,n={type:i?"orthographic":"perspective"};return i?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:ge.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){const i=this.json,n=this.nodeMap;i.animations||(i.animations=[]);const a=(e=bw.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,r=[],s=[];for(let e=0;e<a.length;++e){const i=a[e],o=Bc.parseTrackName(i.name);let l=Bc.findNode(t,o.nodeName);const c=jw[o.propertyName];if("bones"===o.objectName&&(l=!0===l.isSkinnedMesh?l.skeleton.getBoneByName(o.objectIndex):void 0),!l||!c)return logger.warn('THREE.GLTFExporter: Could not export animation track "%s".',i.name),null;const h=1;let u,d=i.values.length/i.times.length;c===jw.morphTargetInfluences&&(d/=l.morphTargetInfluences.length),!0===i.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(u="CUBICSPLINE",d/=3):u=i.getInterpolation()===Y?"STEP":"LINEAR",s.push({input:this.processAccessor(new ti(i.times,h)),output:this.processAccessor(new ti(i.values,d)),interpolation:u}),r.push({sampler:s.length-1,target:{node:n.get(l),path:c}})}return i.animations.push({name:e.name||"clip_"+i.animations.length,samplers:s,channels:r}),i.animations.length-1}processSkin(e){const t=this.json,i=this.nodeMap,n=t.nodes[i.get(e)],a=e.skeleton;if(void 0===a)return null;const r=e.skeleton.bones[0];if(void 0===r)return null;const s=[],o=new Float32Array(16*a.bones.length),l=new it;for(let t=0;t<a.bones.length;++t)s.push(i.get(a.bones[t])),l.copy(a.boneInverses[t]),l.multiply(e.bindMatrix).toArray(o,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new ti(o,16)),joints:s,skeleton:i.get(r)});return n.skin=t.skins.length-1}processNode(e){const t=this.json,i=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const a={};if(i.trs){const t=e.quaternion.toArray(),i=e.position.toArray(),n=e.scale.toArray();Hw(t,[0,0,0,1])||(a.rotation=t),Hw(i,[0,0,0])||(a.translation=i),Hw(n,[1,1,1])||(a.scale=n)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===function(e){return Hw(e.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}(e.matrix)&&(a.matrix=e.matrix.elements);if(""!==e.name&&(a.name=String(e.name)),this.serializeUserData(e,a),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(a.mesh=t)}else e.isCamera&&(a.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let n=0,a=e.children.length;n<a;n++){const a=e.children[n];if(a.visible||!1===i.onlyVisible){const e=this.processNode(a);null!==e&&t.push(e)}}t.length>0&&(a.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,a)}));const r=t.nodes.push(a)-1;return n.set(e,r),r}processScene(e){const t=this.json,i=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);const a=[];for(let t=0,n=e.children.length;t<n;t++){const n=e.children[t];if(n.visible||!1===i.onlyVisible){const e=this.processNode(n);null!==e&&a.push(e)}}a.length>0&&(n.nodes=a),this.serializeUserData(e,n)}processObjects(e){const t=new mr;t.name="AuxScene";for(let i=0;i<e.length;i++)t.children.push(e[i]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const i=[];for(let t=0;t<e.length;t++)e[t]instanceof mr?this.processScene(e[t]):i.push(e[t]);i.length>0&&this.processObjects(i);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let i=0;i<t.animations.length;++i)this.processAnimation(t.animations[i],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,i=this.plugins.length;t<i;t++)e(this.plugins[t])}}class Xw{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void logger.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const i=this.writer,n=i.json,a=i.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&logger.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||logger.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),a[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},a[this.name]=!0);const s=n.extensions[this.name].lights;s.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class Zw{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const i=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},i[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class qw{constructor(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}writeMaterial(e,t){if(!e.isGLTFSpecularGlossinessMaterial)return;const i=this.writer,n=i.extensionsUsed,a={};t.pbrMetallicRoughness.baseColorFactor&&(a.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);const r=[1,1,1];if(e.specular.toArray(r,0),a.specularFactor=r,a.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(a.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){const t={index:i.processTexture(e.specularMap)};i.applyTextureTransform(t,e.specularMap),a.specularGlossinessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,n[this.name]=!0}}bw.Utils={insertKeyframe:function(e,t){const i=.001,n=e.getValueSize(),a=new e.TimeBufferType(e.times.length+1),r=new e.ValueBufferType(e.values.length+n),s=e.createInterpolant(new e.ValueBufferType(n));let o;if(0===e.times.length){a[0]=t;for(let e=0;e<n;e++)r[e]=0;o=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<i)return 0;a[0]=t,a.set(e.times,1),r.set(s.evaluate(t),0),r.set(e.values,n),o=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<i)return e.times.length-1;a[a.length-1]=t,a.set(e.times,0),r.set(e.values,0),r.set(s.evaluate(t),e.values.length),o=a.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<i)return l;if(e.times[l]<t&&e.times[l+1]>t){a.set(e.times.slice(0,l+1),0),a[l+1]=t,a.set(e.times.slice(l+1),l+2),r.set(e.values.slice(0,(l+1)*n),0),r.set(s.evaluate(t),(l+1)*n),r.set(e.values.slice((l+1)*n),(l+2)*n),o=l+1;break}}return e.times=a,e.values=r,o},mergeMorphTargetTracks:function(e,t){const i=[],n={},a=e.tracks;for(let e=0;e<a.length;++e){let r=a[e];const s=Bc.parseTrackName(r.name),o=Bc.findNode(t,s.nodeName);if("morphTargetInfluences"!==s.propertyName||void 0===s.propertyIndex){i.push(r);continue}if(r.createInterpolant!==r.InterpolantFactoryMethodDiscrete&&r.createInterpolant!==r.InterpolantFactoryMethodLinear){if(r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");logger.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),r=r.clone(),r.setInterpolation(X)}const l=o.morphTargetInfluences.length,c=o.morphTargetDictionary[s.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+s.propertyIndex);let h;if(void 0===n[o.uuid]){h=r.clone();const e=new h.ValueBufferType(l*h.times.length);for(let t=0;t<h.times.length;t++)e[t*l+c]=h.values[t];h.name=(s.nodeName||"")+".morphTargetInfluences",h.values=e,n[o.uuid]=h,i.push(h);continue}const u=r.createInterpolant(new r.ValueBufferType(1));h=n[o.uuid];for(let e=0;e<h.times.length;e++)h.values[e*l+c]=u.evaluate(h.times[e]);for(let e=0;e<r.times.length;e++){const t=this.insertKeyframe(h,r.times[e]);h.values[t*l+c]=r.values[e]}}return e.tracks=i,e}};let Jw=e=>new Blob([e],{type:"application/octet-stream"});class Qw{constructor(e,t){this._scene=e,this._context=t,this._gltfExporter=new bw}concat(...e){let t=0;for(let i of e)t+=i.length;let i=new Uint8Array(t),n=0;for(let t of e)i.set(t,n),n+=t.length;return i}exportBlob({type:e="glb",maxTextureSize:t,minTextureSize:i=1,textureSizeFactor:n=1,onFinish:a,onError:r}){logger.debug(Ep.sceneSettings);let s=new sr;s.userData.dhExtension=JSON.parse(JSON.stringify(Ep.sceneSettings)),s.userData.dhExtension.VERSION="20220602-NEW-AVWS";let o=Ep.cacheStore.getPublishSceneObject3D(Ep.sceneSettings);s.add(o),Ep.sceneSettings.cache.forEach(((e,t)=>{if(e.refCount>1){let t=Ep.cacheStore._cache.get(fy(e.resourcePath));t?(t.resource.userData={needExport:t.needExport,refCount:t.refCount,resourcePath:t.resourcePath,type:t.type},s.add(t.resource)):window.logger.warn(`${e.resourcePath}-资源丢失`)}}));let l=Ep.customTextureStore.getExportTextureGroup();switch(l&&s.add(l),e.toLowerCase()){case"glb":default:let e={trs:!0,onlyVisible:!1,truncateDrawRange:!0,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:t||1/0,minTextureSize:i,textureSizeFactor:n};this._gltfExporter.parse(s,(e=>{e instanceof ArrayBuffer&&a&&a(Jw(e))}),e)}}async exportPackBlob({type:e="glb",packSettings:t="",maxTextureSize:i,minTextureSize:n=1,textureSizeFactor:a=1,onFinish:r,onError:s}){logger.debug(Ep.sceneSettings);let o=new sr;o.userData.dhExtension={pack:t||await _y.getPackSettings(Ep.sceneSettings),VERSION:"20230317-PACK-AVWS"},Ep.sceneSettings||(console.log("setting diff"),Ep.sceneSettings=Ep.instance.getSettings());let l=Ep.cacheStore.getPublishSceneObject3D(Ep.sceneSettings);o.add(l),Ep.sceneSettings.cache.forEach(((e,t)=>{if(e.refCount>1){let t=Ep.cacheStore._cache.get(fy(e.resourcePath));t?(t.resource.userData={needExport:t.needExport,refCount:t.refCount,resourcePath:t.resourcePath,type:t.type},o.add(t.resource)):window.logger.warn(`${e.resourcePath}-资源丢失`)}}));let c=Ep.customTextureStore.getExportTextureGroup();switch(c&&o.add(c),e.toLowerCase()){case"glb":default:let e={trs:!0,onlyVisible:!1,truncateDrawRange:!0,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:i||1/0,minTextureSize:n,textureSizeFactor:a};this._gltfExporter.parse(o,(e=>{e instanceof ArrayBuffer&&r&&r(Jw(e))}),e)}}async relpaceBlob({type:e="glb",scene:t,onFinish:i,onError:n}){switch(e.toLowerCase()){case"glb":default:let e={trs:!0,onlyVisible:!1,truncateDrawRange:!0,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:maxTextureSize||1/0,minTextureSize:minTextureSize,textureSizeFactor:textureSizeFactor};this._gltfExporter.parse(t,(e=>{e instanceof ArrayBuffer&&i&&(i(Jw(e)),_y.disposeThreeObject(exportGroup))}),e)}}}let Kw,$w;const eS=new WeakMap,tS=new WeakMap,iS=new WeakMap,nS=new WeakMap,aS=new WeakMap;let rS={get(e,t,i){if(e instanceof IDBTransaction){if("done"===t)return tS.get(e);if("objectStoreNames"===t)return e.objectStoreNames||iS.get(e);if("store"===t)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return lS(e[t])},set:(e,t,i)=>(e[t]=i,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function sS(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?($w||($w=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(cS(this),t),lS(eS.get(this))}:function(...t){return lS(e.apply(cS(this),t))}:function(t,...i){const n=e.call(cS(this),t,...i);return iS.set(n,t.sort?t.sort():[t]),lS(n)}}function oS(e){return"function"==typeof e?sS(e):(e instanceof IDBTransaction&&function(e){if(tS.has(e))return;const t=new Promise(((t,i)=>{const n=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",r),e.removeEventListener("abort",r)},a=()=>{t(),n()},r=()=>{i(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",a),e.addEventListener("error",r),e.addEventListener("abort",r)}));tS.set(e,t)}(e),t=e,(Kw||(Kw=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e))?new Proxy(e,rS):e);var t}function lS(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,i)=>{const n=()=>{e.removeEventListener("success",a),e.removeEventListener("error",r)},a=()=>{t(lS(e.result)),n()},r=()=>{i(e.error),n()};e.addEventListener("success",a),e.addEventListener("error",r)}));return t.then((t=>{t instanceof IDBCursor&&eS.set(t,e)})).catch((()=>{})),aS.set(t,e),t}(e);if(nS.has(e))return nS.get(e);const t=oS(e);return t!==e&&(nS.set(e,t),aS.set(t,e)),t}const cS=e=>aS.get(e);function hS(e,t,{blocked:i,upgrade:n,blocking:a,terminated:r}={}){const s=indexedDB.open(e,t),o=lS(s);return n&&s.addEventListener("upgradeneeded",(e=>{n(lS(s.result),e.oldVersion,e.newVersion,lS(s.transaction))})),i&&s.addEventListener("blocked",(()=>i())),o.then((e=>{r&&e.addEventListener("close",(()=>r())),a&&e.addEventListener("versionchange",(()=>a()))})).catch((()=>{})),o}const uS=["get","getKey","getAll","getAllKeys","count"],dS=["put","add","delete","clear"],pS=new Map;function mS(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(pS.get(t))return pS.get(t);const i=t.replace(/FromIndex$/,""),n=t!==i,a=dS.includes(i);if(!(i in(n?IDBIndex:IDBObjectStore).prototype)||!a&&!uS.includes(i))return;const r=async function(e,...t){const r=this.transaction(e,a?"readwrite":"readonly");let s=r.store;return n&&(s=s.index(t.shift())),(await Promise.all([s[i](...t),a&&r.done]))[0]};return pS.set(t,r),r}!function(e){rS=e(rS)}((e=>({...e,get:(t,i,n)=>mS(t,i)||e.get(t,i,n),has:(t,i)=>!!mS(t,i)||e.has(t,i)})));var fS=function(){function e(e){Qo.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.dbPromise=hS(Ly,1,{upgrade(e,t,i,n){e.createObjectStore(ky)},blocked(){logger.warn("indexeddb request blocked.")},blocking(){logger.warn("indexeddb blocking another request.")},terminated(){logger.warn("indexeddb request terminated.")}}),this.register((function(e){return new r(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new s(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new c(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(Qo.prototype),{constructor:e,load:function(e,t,i,n,a){var r,s=this;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:ql.extractUrlBase(e),this.manager.itemStart(e);var o=function(t){n?n(t):logger.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new $o(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials);let c=[];for(let e in this.requestHeader)c.push({key:e,value:this.requestHeader[e]});let h=_y.fetchContentLastModified(e,c),u=fy(e);h.then((n=>{if("0"===n)return void l.load(e,(function(i){try{s.parse(i,r,(function(i){t(i),s.manager.itemEnd(e)}),o)}catch(e){o(e)}}),i,o);let c=fy(n);this.dbPromise.then((n=>{n.getAllKeys(ky).then((h=>{let d=!1;for(let a of h)if(0===a.indexOf(u)){a===`${u}:${c}`?(d=!0,n.get(ky,a).then((n=>{let a=n.byteLength;i&&i({type:"progress",total:a,loaded:a/2});try{s.parse(n,r,(function(n){i&&i({type:"progress",total:a,loaded:a}),t(n),s.manager.itemEnd(e)}),o)}catch(e){o(e)}}))):n.delete(ky,a).then((()=>{}));break}if(!d){let h=l.load(e,(function(i){try{s.parse(i,r,(function(i){t(i),s.manager.itemEnd(e)}),o),n.put(ky,i,`${u}:${c}`).then((()=>{logger.debug("db.put(CONST.INDEXED_DB_OBJECT_STORE, data, `${urlKey}:${lastModifiedKey}`)")}))}catch(e){o(e)}}),i,o);a&&a(h)}}))}))})).catch((()=>{let n=l.load(e,(function(i){try{s.parse(i,r,(function(i){t(i),s.manager.itemEnd(e)}),o)}catch(e){o(e)}}),i,o);a&&a(n)}))},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.DHLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,r){var s,o={},l={};if("string"==typeof e)s=e;else{let t=new Uint8Array(e,0,Ny.length);if(t[0]===Ny[0]&&t[Ny.length-1]===Ny[Ny.length-1]){e=e.slice(Ny.length,e.byteLength);let t=new Uint8Array(e),i=5;for(let e=0;e<t.length;e++)t[e]=t[e]<<3|t[e]>>i}if(ql.decodeText(new Uint8Array(e,0,4))===h){try{o[i.KHR_BINARY_GLTF]=new w(e)}catch(e){return void(r&&r(e))}s=o[i.KHR_BINARY_GLTF].content}else s=ql.decodeText(new Uint8Array(e))}var c=JSON.parse(s);if(void 0===c.asset||c.asset.version[0]<2){if(console.warn("THREE.DHLoader: Unsupported asset. glTF versions >=2.0 are supported."),n){const e=new sr;e.name="Resource not found.",n({scene:e,scenes:[e],animations:[],cameras:[],asset:[],parser:null,userData:{}})}}else{var u=new ee(c,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(var d=0;d<this.pluginCallbacks.length;d++){var p=this.pluginCallbacks[d](u);l[p.name]=p,o[p.name]=!0}if(c.extensionsUsed)for(d=0;d<c.extensionsUsed.length;++d){var m=c.extensionsUsed[d],f=c.extensionsRequired||[];switch(m){case i.KHR_MATERIALS_UNLIT:o[m]=new a;break;case i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[m]=new A;break;case i.KHR_DRACO_MESH_COMPRESSION:o[m]=new S(c,this.dracoLoader);break;case i.KHR_TEXTURE_TRANSFORM:o[m]=new M;break;case i.KHR_MESH_QUANTIZATION:o[m]=new E;break;default:f.indexOf(m)>=0&&void 0===l[m]&&logger.warn('THREE.DHLoader: Unknown extension "'+m+'".')}}u.setExtensions(o),u.setPlugins(l),u.parse(n,r)}}});var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=i.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function a(){this.name=i.KHR_MATERIALS_UNLIT}function r(e){this.parser=e,this.name=i.KHR_MATERIALS_CLEARCOAT}function s(e){this.parser=e,this.name=i.KHR_MATERIALS_TRANSMISSION}function o(e){this.parser=e,this.name=i.KHR_TEXTURE_BASISU}function l(e){this.parser=e,this.name=i.EXT_TEXTURE_WEBP,this.isSupported=null}function c(e){this.name=i.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],i=0,n=t.length;i<n;i++){var a=t[i];a.extensions&&a.extensions[this.name]&&void 0!==a.extensions[this.name].light&&e._addNodeRef(this.cache,a.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,i="light:"+e,n=t.cache.get(i);if(n)return n;var a,r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e],o=new Qt(16777215);void 0!==s.color&&o.fromArray(s.color);var l=void 0!==s.range?s.range:0;switch(s.type){case"directional":(a=new Gl(o)).target.position.set(0,0,-1),a.add(a.target);break;case"point":(a=new Fl(o)).distance=l;break;case"spot":(a=new kl(o)).distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.DHLoader: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),n=Promise.resolve(a),t.cache.add(i,n),n},n.prototype.createNodeAttachment=function(e){var t=this,i=this.parser,n=i.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return i._getNodeRef(t.cache,a,e)}))},a.prototype.getMaterialType=function(){return Kt},a.prototype.extendParams=function(e,t,i){var n=[];e.color=new Qt(1,1,1),e.opacity=1;var a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){var r=a.baseColorFactor;e.color.fromArray(r),e.opacity=r[3]}void 0!==a.baseColorTexture&&n.push(i.assignTexture(e,"map",a.baseColorTexture))}return Promise.all(n)},r.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},r.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&a.push(i.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&a.push(i.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(a.push(i.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){var s=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ye(s,-s)}return Promise.all(a)},s.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},s.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(i.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)},o.prototype.loadTexture=function(e){var t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var a=n.extensions[this.name],r=i.images[a.source],s=t.options.ktx2Loader;if(!s){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r,s)},l.prototype.loadTexture=function(e){var t=this.name,i=this.parser,n=i.json,a=n.textures[e];if(!a.extensions||!a.extensions[t])return null;var r=a.extensions[t],s=n.images[r.source],o=i.textureLoader;if(s.uri){var l=i.options.manager.getHandler(s.uri);null!==l&&(o=l)}return this.detectSupport().then((function(a){if(a)return i.loadTextureImage(e,s,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.DHLoader: WebP required by asset but unsupported.");return i.loadTexture(e)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},c.prototype.loadBufferView=function(e){var t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){var n=i.extensions[this.name],a=this.parser.getDependency("buffer",n.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([a,r.ready]).then((function(e){var t=n.byteOffset||0,i=n.byteLength||0,a=n.count,s=n.byteStride,o=new ArrayBuffer(a*s),l=new Uint8Array(e[0],t,i);return r.decodeGltfBuffer(new Uint8Array(o),a,s,l,n.mode,n.filter),o}))}return null};var h="glTF",u=1313821514,p=5130562;function w(e){this.name=i.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:ql.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.DHLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.DHLoader: Legacy binary file detected.");for(var n=this.header.length-12,a=new DataView(e,12),r=0;r<n;){var s=a.getUint32(r,!0);r+=4;var o=a.getUint32(r,!0);if(r+=4,o===u){var l=new Uint8Array(e,12+r,s);this.content=ql.decodeText(l)}else if(o===p){var c=12+r;this.body=e.slice(c,c+s)}r+=s}if(null===this.content)throw new Error("THREE.DHLoader: JSON content not found.")}function S(e,t){if(!t)throw new Error("THREE.DHLoader: No DRACOLoader instance provided.");this.name=i.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function M(){this.name=i.KHR_TEXTURE_TRANSFORM}function T(e){So.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),a=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),s={specular:{value:(new Qt).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=s,this.onBeforeCompile=function(e){for(var o in s)e.uniforms[o]=s[o];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",a).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return s.specular.value},set:function(e){s.specular.value=e}},specularMap:{get:function(){return s.specularMap.value},set:function(e){s.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return s.glossiness.value},set:function(e){s.glossiness.value=e}},glossinessMap:{get:function(){return s.glossinessMap.value},set:function(e){s.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function A(){return{name:i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return T},extendParams:function(e,t,i){var n=t.extensions[this.name];e.color=new Qt(1,1,1),e.opacity=1;var a=[];if(Array.isArray(n.diffuseFactor)){var r=n.diffuseFactor;e.color.fromArray(r),e.opacity=r[3]}if(void 0!==n.diffuseTexture&&a.push(i.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Qt(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Qt(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var s=n.specularGlossinessTexture;a.push(i.assignTexture(e,"glossinessMap",s)),a.push(i.assignTexture(e,"specularMap",s))}return Promise.all(a)},createMaterial:function(e){var t=new T(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=0,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function E(){this.name=i.KHR_MESH_QUANTIZATION}function I(e,t,i,n){Do.call(this,e,t,i,n)}S.prototype.decodePrimitive=function(e,t){var i=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,s={},o={},l={};for(var c in r){var h=j[c]||c.toLowerCase();s[h]=r[c]}for(c in e.attributes){h=j[c]||c.toLowerCase();if(void 0!==r[c]){var u=i.accessors[e.attributes[c]],d=B[u.componentType];l[h]=d,o[h]=!0===u.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var i in e.attributes){var n=e.attributes[i],a=o[i];void 0!==a&&(n.normalized=a)}t(e)}),s,l)}))}))},M.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&logger.warn('THREE.DHLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},T.prototype=Object.create(So.prototype),T.prototype.constructor=T,T.prototype.copy=function(e){return So.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},I.prototype=Object.create(Do.prototype),I.prototype.constructor=I,I.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,a=e*n*3+n,r=0;r!==n;r++)t[r]=i[a+r];return t},I.prototype.beforeStart_=I.prototype.copySampleValue_,I.prototype.afterEnd_=I.prototype.copySampleValue_,I.prototype.interpolate_=function(e,t,i,n){for(var a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,c=n-t,h=(i-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,y=1-f,v=g-u+h,b=0;b!==s;b++){var _=r[m+b+s],x=r[m+b+o]*c,w=r[p+b+s],S=r[p+b]*c;a[b]=y*_+v*x+f*w+g*S}return a};var P=0,R=1,O=2,D=3,L=4,k=5,N=6,B={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},z={9728:g,9729:b,9984:y,9985:_,9986:v,9987:x},U={33071:m,33648:f,10497:d},F={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},j={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},H={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},G={CUBICSPLINE:void 0,LINEAR:X,STEP:Y},V="OPAQUE",W="MASK",Z="BLEND";function q(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function J(e,t,i){for(var n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function Q(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):logger.warn("THREE.DHLoader: Ignoring primitive type .extras, "+t.extras))}function K(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(i=0,n=a.length;i<n;i++)e.morphTargetDictionary[a[i]]=i}else logger.warn("THREE.DHLoader: Invalid extras.targetNames length. Ignoring names.")}}function $(e){for(var t="",i=Object.keys(e).sort(),n=0,a=i.length;n<a;n++)t+=i[n]+":"+e[i[n]]+";";return t}function ee(e,i){this.json=e||{},this.extensions={},this.plugins={},this.options=i||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ic(this.options.manager):this.textureLoader=new al(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new $o(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function ie(e,t,i){var n=t.attributes,a=[];function r(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var s in n){var o=j[s]||s.toLowerCase();o in e.attributes||a.push(r(n[s],o))}if(void 0!==t.indices&&!e.index){var l=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return Q(e,t),function(e,t,i){var n=t.attributes,a=new Re;if(void 0!==n.POSITION){var r=(d=i.json.accessors[n.POSITION]).min,s=d.max;if(void 0!==r&&void 0!==s){a.set(new Ce(r[0],r[1],r[2]),new Ce(s[0],s[1],s[2]));var o=t.targets;if(void 0!==o){for(var l=new Ce,c=new Ce,h=0,u=o.length;h<u;h++){var d,p=o[h];if(void 0!==p.POSITION)r=(d=i.json.accessors[p.POSITION]).min,s=d.max,void 0!==r&&void 0!==s?(c.setX(Math.max(Math.abs(r[0]),Math.abs(s[0]))),c.setY(Math.max(Math.abs(r[1]),Math.abs(s[1]))),c.setZ(Math.max(Math.abs(r[2]),Math.abs(s[2]))),l.max(c)):logger.warn("THREE.DHLoader: Missing min/max properties for accessor POSITION.")}a.expandByVector(l)}e.boundingBox=a;var m=new Xe;a.getCenter(m.center),m.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=m}else logger.warn("THREE.DHLoader: Missing min/max properties for accessor POSITION.")}}(e,t,i),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,i){for(var n=!1,a=!1,r=0,s=t.length;r<s&&(void 0!==(c=t[r]).POSITION&&(n=!0),void 0!==c.NORMAL&&(a=!0),!n||!a);r++);if(!n&&!a)return Promise.resolve(e);var o=[],l=[];for(r=0,s=t.length;r<s;r++){var c=t[r];if(n){var h=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;o.push(h)}a&&(h=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(h))}return Promise.all([Promise.all(o),Promise.all(l)]).then((function(t){var i=t[0],r=t[1];return n&&(e.morphAttributes.position=i),a&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}function ne(e,t){var i=e.getIndex();if(null===i){var n=[],a=e.getAttribute("position");if(void 0===a)return logger.error("THREE.DHLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var r=0;r<a.count;r++)n.push(r);e.setIndex(n),i=e.getIndex()}var s=i.count-2,o=[];if(2===t)for(r=1;r<=s;r++)o.push(i.getX(0)),o.push(i.getX(r)),o.push(i.getX(r+1));else for(r=0;r<s;r++)r%2==0?(o.push(i.getX(r)),o.push(i.getX(r+1)),o.push(i.getX(r+2))):(o.push(i.getX(r+2)),o.push(i.getX(r+1)),o.push(i.getX(r)));o.length/3!==s&&logger.error("THREE.DHLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(o),l}return ee.prototype.setExtensions=function(e){this.extensions=e},ee.prototype.setPlugins=function(e){this.plugins=e},ee.prototype.parse=function(e,t){var i=this,n=this.json,a=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){var r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};J(a,r,n),Q(r,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){e(r)}))})).catch(t)},ee.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[],n=0,a=t.length;n<a;n++)for(var r=t[n].joints,s=0,o=r.length;s<o;s++)e[r[s]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var h=e[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(i[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},ee.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},ee.prototype._getNodeRef=function(e,t,i){if(e.refs[t]<=1)return i;var n=i.clone();return n.name+="_instance_"+e.uses[t]++,n},ee.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var i=0;i<t.length;i++){var n=e(t[i]);if(n)return n}},ee.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var i=[],n=0;n<t.length;n++){var a=e(t[n]);a&&i.push(a)}return i},ee.prototype.getDependency=function(e,t){var i=e+":"+t,n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n},ee.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t},ee.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.DHLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[i.KHR_BINARY_GLTF].body);var a=this.options;return new Promise((function(e,i){n.load(q(t.uri,a.path),e,void 0,(function(){i(new Error('THREE.DHLoader: Failed to load buffer "'+t.uri+'".'))}))}))},ee.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))},ee.prototype.loadAccessor=function(e){var t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var a=[];return void 0!==n.bufferView?a.push(this.getDependency("bufferView",n.bufferView)):a.push(null),void 0!==n.sparse&&(a.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(a).then((function(e){var a,r=e[0],s=F[n.type],o=B[n.componentType],l=o.BYTES_PER_ELEMENT,c=l*s,h=n.byteOffset||0,u=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(u&&u!==c){var p=Math.floor(h/u),m="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,f=t.cache.get(m);f||(f=new fr(new o(r,p*u,n.count*u/l),u/l),t.cache.add(m,f)),a=new yr(f,s,h%u/l,d)}else a=new ti(null===r?new o(n.count*s):new o(r,h,n.count*s),s,d);if(void 0!==n.sparse){var g=F.SCALAR,y=B[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,_=new y(e[1],v,n.sparse.count*g),x=new o(e[2],b,n.sparse.count*s);null!==r&&(a=new ti(a.array.slice(),a.itemSize,a.normalized));for(var w=0,S=_.length;w<S;w++){var M=_[w];if(a.setX(M,x[w*s]),s>=2&&a.setY(M,x[w*s+1]),s>=3&&a.setZ(M,x[w*s+2]),s>=4&&a.setW(M,x[w*s+3]),s>=5)throw new Error("THREE.DHLoader: Unsupported itemSize in sparse BufferAttribute.")}}return a}))},ee.prototype.loadTexture=function(e){var t=this.json,i=this.options,n=t.textures[e],a=t.images[n.source],r=this.textureLoader;if(a.uri){var s=i.manager.getHandler(a.uri);null!==s&&(r=s)}return this.loadTextureImage(e,a,r)},ee.prototype.loadTextureImage=function(e,t,i){var n=this,a=this.json,r=this.options,s=a.textures[e],o=self.URL||self.webkitURL,l=t.uri,c=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)l=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var i=new DataView(e,25,1).getUint8(0,!1);h=6===i||4===i||3===i}if(c=!0,Zo.has(t))return Zo.get(t);var n=new Blob([e],{type:t.mimeType});return l=o.createObjectURL(n),Zo.set(t,l),l}));else if(void 0===t.uri)throw new Error("THREE.DHLoader: Image "+e+" is missing URI and bufferView");return Promise.resolve(l).then((function(e){return new Promise((function(t,n){var a=t;!0===i.isImageBitmapLoader&&(a=function(e){t(new vs(e))}),i.load(q(e,r.path),a,void 0,n)}))})).then((function(t){!0===c&&o.revokeObjectURL(l),t.flipY=!1,s.name&&(t.name=s.name),h||(t.format=C);var i=(a.samplers||{})[s.sampler]||{};return t.magFilter=z[i.magFilter]||b,t.minFilter=z[i.minFilter]||x,t.wrapS=U[i.wrapS]||d,t.wrapT=U[i.wrapT]||d,n.associations.set(t,{type:"textures",index:e}),t}))},ee.prototype.assignTexture=function(e,t,n){var a=this;return this.getDependency("texture",n.index).then((function(r){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||logger.warn("THREE.DHLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),a.extensions[i.KHR_TEXTURE_TRANSFORM]){var s=void 0!==n.extensions?n.extensions[i.KHR_TEXTURE_TRANSFORM]:void 0;if(s){var o=a.associations.get(r);r=a.extensions[i.KHR_TEXTURE_TRANSFORM].extendTexture(r,s),a.associations.set(r,o)}}e[t]=r}))},ee.prototype.assignFinalMaterial=function(e){var t=e.geometry,i=e.material,n=void 0!==t.attributes.tangent,a=void 0!==t.attributes.color,r=void 0===t.attributes.normal,s=!0===e.isSkinnedMesh,o=Object.keys(t.morphAttributes).length>0,l=o&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+i.uuid,h=this.cache.get(c);h||(h=new cs,Vt.prototype.copy.call(h,i),h.color.copy(i.color),h.map=i.map,h.sizeAttenuation=!1,this.cache.add(c,h)),i=h}else if(e.isLine){c="LineBasicMaterial:"+i.uuid;var u=this.cache.get(c);u||(u=new Kr,Vt.prototype.copy.call(u,i),u.color.copy(i.color),this.cache.add(c,u)),i=u}if(n||a||r||s||o){c="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),s&&(c+="skinning:"),n&&(c+="vertex-tangents:"),a&&(c+="vertex-colors:"),r&&(c+="flat-shading:"),o&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=i.clone(),s&&(d.skinning=!0),a&&(d.vertexColors=!0),r&&(d.flatShading=!0),o&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(i))),i=d}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i},ee.prototype.getMaterialType=function(){return So},ee.prototype.loadMaterial=function(e){var t,n=this,a=this.json,r=this.extensions,s=a.materials[e],o={},l=s.extensions||{},c=[];if(l[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(o,s,n))}else if(l[i.KHR_MATERIALS_UNLIT]&&r[i.KHR_MATERIALS_UNLIT]){var u=r[i.KHR_MATERIALS_UNLIT];t=u.getMaterialType(),c.push(u.extendParams(o,s,n))}else{var d=s.pbrMetallicRoughness||{};if(o.color=new Qt(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;o.color.fromArray(p),o.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(o,"map",d.baseColorTexture)),o.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,o.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===s.doubleSided&&(o.side=2);var m=s.alphaMode||V;return m===Z?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,m===W&&(o.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==Kt&&(c.push(n.assignTexture(o,"normalMap",s.normalTexture)),o.normalScale=new ye(1,-1),void 0!==s.normalTexture.scale&&o.normalScale.set(s.normalTexture.scale,-s.normalTexture.scale)),void 0!==s.occlusionTexture&&t!==Kt&&(c.push(n.assignTexture(o,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(o.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==Kt&&(o.emissive=(new Qt).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&t!==Kt&&c.push(n.assignTexture(o,"emissiveMap",s.emissiveTexture)),Promise.all(c).then((function(){var a;return a=t===T?r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),s.name&&(a.name=s.name),a.map&&(a.map.encoding=te),a.emissiveMap&&(a.emissiveMap.encoding=te),Q(a,s),n.associations.set(a,{type:"materials",index:e}),s.extensions&&J(r,a,s),a}))},ee.prototype.createUniqueName=function(e){for(var t=Bc.sanitizeNodeName(e||""),i=t,n=1;this.nodeNamesUsed[i];++n)i=t+"_"+n;return this.nodeNamesUsed[i]=!0,i},ee.prototype.loadGeometries=function(e){var t=this,n=this.extensions,a=this.primitiveCache;function r(e){return n[i.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return ie(i,e,t)}))}for(var s,o,l=[],c=0,h=e.length;c<h;c++){var u,d=e[c],p=(o=void 0,(o=(s=d).extensions&&s.extensions[i.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+$(o.attributes):s.indices+":"+$(s.attributes)+":"+s.mode),m=a[p];if(m)l.push(m.promise);else u=d.extensions&&d.extensions[i.KHR_DRACO_MESH_COMPRESSION]?r(d):ie(new wi,d,t),a[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},ee.prototype.loadMesh=function(e){for(var t,i=this,n=this.json,a=this.extensions,r=n.meshes[e],s=r.primitives,o=[],l=0,c=s.length;l<c;l++){var h=void 0===s[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new So({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:0})),t.DefaultMaterial):this.getDependency("material",s[l].material);o.push(h)}return o.push(i.loadGeometries(s)),Promise.all(o).then((function(t){for(var n=t.slice(0,t.length-1),o=t[t.length-1],l=[],c=0,h=o.length;c<h;c++){var u,d=o[c],p=s[c],m=n[c];if(p.mode===L||p.mode===k||p.mode===N||void 0===p.mode)!0!==(u=!0===r.isSkinnedMesh?new Hr(d,m):new Fi(d,m)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===k?u.geometry=ne(u.geometry,1):p.mode===N&&(u.geometry=ne(u.geometry,2));else if(p.mode===R)u=new os(d,m);else if(p.mode===D)u=new as(d,m);else if(p.mode===O)u=new ls(d,m);else{if(p.mode!==P)throw new Error("THREE.DHLoader: Primitive mode unsupported: "+p.mode);u=new ms(d,m)}Object.keys(u.geometry.morphAttributes).length>0&&K(u,r),u.name=i.createUniqueName(r.name||"mesh_"+e),Q(u,r),p.extensions&&J(a,u,p),i.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var f=new sr;for(c=0,h=l.length;c<h;c++)f.add(l[c]);return f}))},ee.prototype.loadCamera=function(e){var t,i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new Zi(ge.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new jl(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Q(t,i),Promise.resolve(t);logger.warn("THREE.DHLoader: Missing camera parameters.")},ee.prototype.loadSkin=function(e){var t=this.json.skins[e],i={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return i.inverseBindMatrices=e,i}))},ee.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],i=[],n=[],a=[],r=[],s=[],o=0,l=t.channels.length;o<l;o++){var c=t.channels[o],h=t.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==t.parameters?t.parameters[h.input]:h.input,m=void 0!==t.parameters?t.parameters[h.output]:h.output;i.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),a.push(this.getDependency("accessor",m)),r.push(h),s.push(u)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(a),Promise.all(r),Promise.all(s)]).then((function(i){for(var n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=a[c],p=r[c],m=s[c],f=o[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,H[f.path]){case H.weights:g=Fo;break;case H.rotation:g=Ho;break;case H.position:case H.scale:default:g=Vo}var y=u.name?u.name:u.uuid,v=void 0!==m.interpolation?G[m.interpolation]:X,b=[];H[f.path]===H.weights?u.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&b.push(e.name?e.name:e.uuid)})):b.push(y);var _=p.array;if(p.normalized){var x;if(_.constructor===Int8Array)x=1/127;else if(_.constructor===Uint8Array)x=1/255;else if(_.constructor==Int16Array)x=1/32767;else{if(_.constructor!==Uint16Array)throw new Error("THREE.DHLoader: Unsupported output accessor component type.");x=1/65535}for(var w=new Float32Array(_.length),S=0,M=_.length;S<M;S++)w[S]=_[S]*x;_=w}for(S=0,M=b.length;S<M;S++){var T=new g(b[S]+"."+H[f.path],d.array,_,v);"CUBICSPLINE"===m.interpolation&&(T.createInterpolant=function(e){return new I(this.times,this.values,this.getValueSize()/3,e)},T.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(T)}}}var A=t.name?t.name:"animation_"+e;return new Wo(A,void 0,l)}))},ee.prototype.loadNode=function(e){var t,i=this.json,n=this.extensions,a=this,r=i.nodes[e],s=r.name?a.createUniqueName(r.name):"";return(t=[],void 0!==r.mesh&&t.push(a.getDependency("mesh",r.mesh).then((function(e){var t=a._getNodeRef(a.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,i=r.weights.length;t<i;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))),void 0!==r.camera&&t.push(a.getDependency("camera",r.camera).then((function(e){return a._getNodeRef(a.cameraCache,r.camera,e)}))),a._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var i;if((i=!0===r.isBone?new Gr:t.length>1?new sr:1===t.length?t[0]:new Et)!==t[0])for(var o=0,l=t.length;o<l;o++)i.add(t[o]);if(r.name&&(i.userData.name=r.name,i.name=s),Q(i,r),r.extensions&&J(n,i,r),void 0!==r.matrix){var c=new it;c.fromArray(r.matrix),i.applyMatrix4(c)}else void 0!==r.translation&&i.position.fromArray(r.translation),void 0!==r.rotation&&i.quaternion.fromArray(r.rotation),void 0!==r.scale&&i.scale.fromArray(r.scale);return a.associations.set(i,{type:"nodes",index:e}),i}))},ee.prototype.loadScene=function(){function e(t,i,n,a){var r=n.nodes[t];return a.getDependency("node",t).then((function(e){return void 0===r.skin?e:a.getDependency("skin",r.skin).then((function(e){for(var i=[],n=0,r=(t=e).joints.length;n<r;n++)i.push(a.getDependency("node",t.joints[n]));return Promise.all(i)})).then((function(i){return e.traverse((function(e){if(e.isMesh){for(var n=[],a=[],r=0,s=i.length;r<s;r++){var o=i[r];if(o){n.push(o);var l=new it;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*r),a.push(l)}else logger.warn('THREE.DHLoader: Joint "%s" could not be found.',t.joints[r])}e.bind(new Yr(n,a),e.matrixWorld)}})),e}));var t})).then((function(t){i.add(t);var s=[];if(r.children)for(var o=r.children,l=0,c=o.length;l<c;l++){var h=o[l];s.push(e(h,t,n,a))}return Promise.all(s)}))}return function(t){var i=this.json,n=this.extensions,a=this.json.scenes[t],r=new sr;a.name&&(r.name=this.createUniqueName(a.name)),Q(r,a),a.extensions&&J(n,r,a);for(var s=a.nodes||[],o=[],l=0,c=s.length;l<c;l++)o.push(e(s[l],r,i,this));return Promise.all(o).then((function(){return r}))}}(),e}(),gS=function(){function e(e){Qo.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.dbPromise=hS(Ly,1,{upgrade(e,t,i,n){e.createObjectStore(ky)},blocked(){logger.warn("indexeddb request blocked.")},blocking(){logger.warn("indexeddb blocking another request.")},terminated(){logger.warn("indexeddb request terminated.")}}),this.register((function(e){return new r(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new s(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new c(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(Qo.prototype),{constructor:e,load:function(e,t,i,n,a,r){var s,o=this;o.secretKey=r,s=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:ql.extractUrlBase(e),this.manager.itemStart(e);var l=function(t){n?n(t):logger.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},c=new $o(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials);let h=[];for(let e in this.requestHeader)h.push({key:e,value:this.requestHeader[e]});let u=_y.fetchContentLastModified(e,h),d=fy(e);u.then(((n,a)=>{if("0"===n)return void c.load(e,(function(i){try{o.parse(i,s,(function(i){t(i),o.manager.itemEnd(e)}),l)}catch(e){l(e)}}),i,l);o.secretKey=o.secretKey||a;let r=fy(n);this.dbPromise.then((n=>{n.getAllKeys(ky).then((a=>{let h=!1;for(let c of a)if(0===c.indexOf(d)){c===`${d}:${r}`?(h=!0,n.get(ky,c).then((n=>{let a=n.byteLength;i&&i({type:"progress",total:a,loaded:a/2});try{o.parse(n,s,(function(n){i&&i({type:"progress",total:a,loaded:a}),t(n),o.manager.itemEnd(e)}),l)}catch(e){l(e)}}))):n.delete(ky,c).then((()=>{}));break}h||c.load(e,(function(i){try{o.parse(i,s,(function(i){t(i),o.manager.itemEnd(e)}),l),n.put(ky,i,`${d}:${r}`).then((()=>{logger.debug("db.put(CONST.INDEXED_DB_OBJECT_STORE, data, `${urlKey}:${lastModifiedKey}`)")}))}catch(e){l(e)}}),i,l)}))}))})).catch((()=>{c.load(e,(function(i){try{o.parse(i,s,(function(i){t(i),o.manager.itemEnd(e)}),l)}catch(e){l(e)}}),i,l)}))},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.DHLoaderAVWS: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,r){var s,o={},l={};if("string"==typeof e)s=e;else{let t=new Uint8Array(e,0,Ny.length);if(t[0]===Ny[0]&&t[Ny.length-1]===Ny[Ny.length-1]){e=e.slice(Ny.length,e.byteLength);let t=new Uint8Array(e),i=5;for(let e=0;e<t.length;e++)t[e]=t[e]<<3|t[e]>>i}if(t[0]===By[0]&&t[By.length-1]===By[By.length-1]){if("string"!=typeof this.secretKey)return;if(this.secretKey.length<8||this.secretKey.length>128)return;const t=[];for(let e=0;e<this.secretKey.length;e++)t.push(this.secretKey.charCodeAt(e));e=e.slice(By.length,e.byteLength);let i,n,a=new Uint8Array(e);for(let e=0;e<a.length;e++)i=t[e%t.length]%8,n=8-i,a[e]=a[e]<<i|a[e]>>n;this.secretKey=""}if(ql.decodeText(new Uint8Array(e,0,4))===h){try{o[i.KHR_BINARY_GLTF]=new w(e)}catch(e){return void(r&&r(e))}s=o[i.KHR_BINARY_GLTF].content}else s=ql.decodeText(new Uint8Array(e))}var c=JSON.parse(s);if(void 0===c.asset||c.asset.version[0]<2)r&&r(new Error("THREE.DHLoaderAVWS: Unsupported asset. glTF versions >=2.0 are supported."));else{var u=new ee(c,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(var d=0;d<this.pluginCallbacks.length;d++){var p=this.pluginCallbacks[d](u);l[p.name]=p,o[p.name]=!0}if(c.extensionsUsed)for(d=0;d<c.extensionsUsed.length;++d){var m=c.extensionsUsed[d],f=c.extensionsRequired||[];switch(m){case i.KHR_MATERIALS_UNLIT:o[m]=new a;break;case i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[m]=new A;break;case i.KHR_DRACO_MESH_COMPRESSION:o[m]=new S(c,this.dracoLoader);break;case i.KHR_TEXTURE_TRANSFORM:o[m]=new M;break;case i.KHR_MESH_QUANTIZATION:o[m]=new E;break;default:f.indexOf(m)>=0&&void 0===l[m]&&logger.warn('THREE.DHLoaderAVWS: Unknown extension "'+m+'".')}}u.setExtensions(o),u.setPlugins(l),u.parse(n,r)}}});var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=i.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function a(){this.name=i.KHR_MATERIALS_UNLIT}function r(e){this.parser=e,this.name=i.KHR_MATERIALS_CLEARCOAT}function s(e){this.parser=e,this.name=i.KHR_MATERIALS_TRANSMISSION}function o(e){this.parser=e,this.name=i.KHR_TEXTURE_BASISU}function l(e){this.parser=e,this.name=i.EXT_TEXTURE_WEBP,this.isSupported=null}function c(e){this.name=i.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],i=0,n=t.length;i<n;i++){var a=t[i];a.extensions&&a.extensions[this.name]&&void 0!==a.extensions[this.name].light&&e._addNodeRef(this.cache,a.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,i="light:"+e,n=t.cache.get(i);if(n)return n;var a,r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e],o=new Qt(16777215);void 0!==s.color&&o.fromArray(s.color);var l=void 0!==s.range?s.range:0;switch(s.type){case"directional":(a=new Gl(o)).target.position.set(0,0,-1),a.add(a.target);break;case"point":(a=new Fl(o)).distance=l;break;case"spot":(a=new kl(o)).distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.DHLoaderAVWS: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),n=Promise.resolve(a),t.cache.add(i,n),n},n.prototype.createNodeAttachment=function(e){var t=this,i=this.parser,n=i.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return i._getNodeRef(t.cache,a,e)}))},a.prototype.getMaterialType=function(){return Kt},a.prototype.extendParams=function(e,t,i){var n=[];e.color=new Qt(1,1,1),e.opacity=1;var a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){var r=a.baseColorFactor;e.color.fromArray(r),e.opacity=r[3]}void 0!==a.baseColorTexture&&n.push(i.assignTexture(e,"map",a.baseColorTexture))}return Promise.all(n)},r.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},r.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&a.push(i.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&a.push(i.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(a.push(i.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){var s=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ye(s,-s)}return Promise.all(a)},s.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},s.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(i.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)},o.prototype.loadTexture=function(e){var t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var a=n.extensions[this.name],r=i.images[a.source],s=t.options.ktx2Loader;if(!s){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoaderAVWS: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r,s)},l.prototype.loadTexture=function(e){var t=this.name,i=this.parser,n=i.json,a=n.textures[e];if(!a.extensions||!a.extensions[t])return null;var r=a.extensions[t],s=n.images[r.source],o=i.textureLoader;if(s.uri){var l=i.options.manager.getHandler(s.uri);null!==l&&(o=l)}return this.detectSupport().then((function(a){if(a)return i.loadTextureImage(e,s,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.DHLoaderAVWS: WebP required by asset but unsupported.");return i.loadTexture(e)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},c.prototype.loadBufferView=function(e){var t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){var n=i.extensions[this.name],a=this.parser.getDependency("buffer",n.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoaderAVWS: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([a,r.ready]).then((function(e){var t=n.byteOffset||0,i=n.byteLength||0,a=n.count,s=n.byteStride,o=new ArrayBuffer(a*s),l=new Uint8Array(e[0],t,i);return r.decodeGltfBuffer(new Uint8Array(o),a,s,l,n.mode,n.filter),o}))}return null};var h="glTF",u=1313821514,p=5130562;function w(e){this.name=i.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:ql.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.DHLoaderAVWS: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.DHLoaderAVWS: Legacy binary file detected.");for(var n=this.header.length-12,a=new DataView(e,12),r=0;r<n;){var s=a.getUint32(r,!0);r+=4;var o=a.getUint32(r,!0);if(r+=4,o===u){var l=new Uint8Array(e,12+r,s);this.content=ql.decodeText(l)}else if(o===p){var c=12+r;this.body=e.slice(c,c+s)}r+=s}if(null===this.content)throw new Error("THREE.DHLoaderAVWS: JSON content not found.")}function S(e,t){if(!t)throw new Error("THREE.DHLoaderAVWS: No DRACOLoader instance provided.");this.name=i.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function M(){this.name=i.KHR_TEXTURE_TRANSFORM}function T(e){So.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),a=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),s={specular:{value:(new Qt).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=s,this.onBeforeCompile=function(e){for(var o in s)e.uniforms[o]=s[o];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",a).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return s.specular.value},set:function(e){s.specular.value=e}},specularMap:{get:function(){return s.specularMap.value},set:function(e){s.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return s.glossiness.value},set:function(e){s.glossiness.value=e}},glossinessMap:{get:function(){return s.glossinessMap.value},set:function(e){s.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function A(){return{name:i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return T},extendParams:function(e,t,i){var n=t.extensions[this.name];e.color=new Qt(1,1,1),e.opacity=1;var a=[];if(Array.isArray(n.diffuseFactor)){var r=n.diffuseFactor;e.color.fromArray(r),e.opacity=r[3]}if(void 0!==n.diffuseTexture&&a.push(i.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Qt(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Qt(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var s=n.specularGlossinessTexture;a.push(i.assignTexture(e,"glossinessMap",s)),a.push(i.assignTexture(e,"specularMap",s))}return Promise.all(a)},createMaterial:function(e){var t=new T(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=0,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function E(){this.name=i.KHR_MESH_QUANTIZATION}function I(e,t,i,n){Do.call(this,e,t,i,n)}S.prototype.decodePrimitive=function(e,t){var i=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,s={},o={},l={};for(var c in r){var h=j[c]||c.toLowerCase();s[h]=r[c]}for(c in e.attributes){h=j[c]||c.toLowerCase();if(void 0!==r[c]){var u=i.accessors[e.attributes[c]],d=B[u.componentType];l[h]=d,o[h]=!0===u.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var i in e.attributes){var n=e.attributes[i],a=o[i];void 0!==a&&(n.normalized=a)}t(e)}),s,l)}))}))},M.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&logger.warn('THREE.DHLoaderAVWS: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},T.prototype=Object.create(So.prototype),T.prototype.constructor=T,T.prototype.copy=function(e){return So.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},I.prototype=Object.create(Do.prototype),I.prototype.constructor=I,I.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,a=e*n*3+n,r=0;r!==n;r++)t[r]=i[a+r];return t},I.prototype.beforeStart_=I.prototype.copySampleValue_,I.prototype.afterEnd_=I.prototype.copySampleValue_,I.prototype.interpolate_=function(e,t,i,n){for(var a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,c=n-t,h=(i-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,y=1-f,v=g-u+h,b=0;b!==s;b++){var _=r[m+b+s],x=r[m+b+o]*c,w=r[p+b+s],S=r[p+b]*c;a[b]=y*_+v*x+f*w+g*S}return a};var P=0,R=1,O=2,D=3,L=4,k=5,N=6,B={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},z={9728:g,9729:b,9984:y,9985:_,9986:v,9987:x},U={33071:m,33648:f,10497:d},F={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},j={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},H={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},G={CUBICSPLINE:void 0,LINEAR:X,STEP:Y},V="OPAQUE",W="MASK",Z="BLEND";function q(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function J(e,t,i){for(var n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function Q(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):logger.warn("THREE.DHLoaderAVWS: Ignoring primitive type .extras, "+t.extras))}function K(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(i=0,n=a.length;i<n;i++)e.morphTargetDictionary[a[i]]=i}else logger.warn("THREE.DHLoaderAVWS: Invalid extras.targetNames length. Ignoring names.")}}function $(e){for(var t="",i=Object.keys(e).sort(),n=0,a=i.length;n<a;n++)t+=i[n]+":"+e[i[n]]+";";return t}function ee(e,i){this.json=e||{},this.extensions={},this.plugins={},this.options=i||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ic(this.options.manager):this.textureLoader=new al(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new $o(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function ie(e,t,i){var n=t.attributes,a=[];function r(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var s in n){var o=j[s]||s.toLowerCase();o in e.attributes||a.push(r(n[s],o))}if(void 0!==t.indices&&!e.index){var l=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return Q(e,t),function(e,t,i){var n=t.attributes,a=new Re;if(void 0!==n.POSITION){var r=(d=i.json.accessors[n.POSITION]).min,s=d.max;if(void 0!==r&&void 0!==s){a.set(new Ce(r[0],r[1],r[2]),new Ce(s[0],s[1],s[2]));var o=t.targets;if(void 0!==o){for(var l=new Ce,c=new Ce,h=0,u=o.length;h<u;h++){var d,p=o[h];if(void 0!==p.POSITION)r=(d=i.json.accessors[p.POSITION]).min,s=d.max,void 0!==r&&void 0!==s?(c.setX(Math.max(Math.abs(r[0]),Math.abs(s[0]))),c.setY(Math.max(Math.abs(r[1]),Math.abs(s[1]))),c.setZ(Math.max(Math.abs(r[2]),Math.abs(s[2]))),l.max(c)):logger.warn("THREE.DHLoaderAVWS: Missing min/max properties for accessor POSITION.")}a.expandByVector(l)}e.boundingBox=a;var m=new Xe;a.getCenter(m.center),m.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=m}else logger.warn("THREE.DHLoaderAVWS: Missing min/max properties for accessor POSITION.")}}(e,t,i),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,i){for(var n=!1,a=!1,r=0,s=t.length;r<s&&(void 0!==(c=t[r]).POSITION&&(n=!0),void 0!==c.NORMAL&&(a=!0),!n||!a);r++);if(!n&&!a)return Promise.resolve(e);var o=[],l=[];for(r=0,s=t.length;r<s;r++){var c=t[r];if(n){var h=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;o.push(h)}a&&(h=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(h))}return Promise.all([Promise.all(o),Promise.all(l)]).then((function(t){var i=t[0],r=t[1];return n&&(e.morphAttributes.position=i),a&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}function ne(e,t){var i=e.getIndex();if(null===i){var n=[],a=e.getAttribute("position");if(void 0===a)return logger.error("THREE.DHLoaderAVWS.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var r=0;r<a.count;r++)n.push(r);e.setIndex(n),i=e.getIndex()}var s=i.count-2,o=[];if(2===t)for(r=1;r<=s;r++)o.push(i.getX(0)),o.push(i.getX(r)),o.push(i.getX(r+1));else for(r=0;r<s;r++)r%2==0?(o.push(i.getX(r)),o.push(i.getX(r+1)),o.push(i.getX(r+2))):(o.push(i.getX(r+2)),o.push(i.getX(r+1)),o.push(i.getX(r)));o.length/3!==s&&logger.error("THREE.DHLoaderAVWS.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(o),l}return ee.prototype.setExtensions=function(e){this.extensions=e},ee.prototype.setPlugins=function(e){this.plugins=e},ee.prototype.parse=function(e,t){var i=this,n=this.json,a=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){var r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};J(a,r,n),Q(r,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){e(r)}))})).catch(t)},ee.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[],n=0,a=t.length;n<a;n++)for(var r=t[n].joints,s=0,o=r.length;s<o;s++)e[r[s]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var h=e[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(i[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},ee.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},ee.prototype._getNodeRef=function(e,t,i){if(e.refs[t]<=1)return i;var n=i.clone();return n.name+="_instance_"+e.uses[t]++,n},ee.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var i=0;i<t.length;i++){var n=e(t[i]);if(n)return n}},ee.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var i=[],n=0;n<t.length;n++){var a=e(t[n]);a&&i.push(a)}return i},ee.prototype.getDependency=function(e,t){var i=e+":"+t,n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n},ee.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t},ee.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.DHLoaderAVWS: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[i.KHR_BINARY_GLTF].body);var a=this.options;return new Promise((function(e,i){n.load(q(t.uri,a.path),e,void 0,(function(){i(new Error('THREE.DHLoaderAVWS: Failed to load buffer "'+t.uri+'".'))}))}))},ee.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))},ee.prototype.loadAccessor=function(e){var t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var a=[];return void 0!==n.bufferView?a.push(this.getDependency("bufferView",n.bufferView)):a.push(null),void 0!==n.sparse&&(a.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(a).then((function(e){var a,r=e[0],s=F[n.type],o=B[n.componentType],l=o.BYTES_PER_ELEMENT,c=l*s,h=n.byteOffset||0,u=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(u&&u!==c){var p=Math.floor(h/u),m="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,f=t.cache.get(m);f||(f=new fr(new o(r,p*u,n.count*u/l),u/l),t.cache.add(m,f)),a=new yr(f,s,h%u/l,d)}else a=new ti(null===r?new o(n.count*s):new o(r,h,n.count*s),s,d);if(void 0!==n.sparse){var g=F.SCALAR,y=B[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,_=new y(e[1],v,n.sparse.count*g),x=new o(e[2],b,n.sparse.count*s);null!==r&&(a=new ti(a.array.slice(),a.itemSize,a.normalized));for(var w=0,S=_.length;w<S;w++){var M=_[w];if(a.setX(M,x[w*s]),s>=2&&a.setY(M,x[w*s+1]),s>=3&&a.setZ(M,x[w*s+2]),s>=4&&a.setW(M,x[w*s+3]),s>=5)throw new Error("THREE.DHLoaderAVWS: Unsupported itemSize in sparse BufferAttribute.")}}return a}))},ee.prototype.loadTexture=function(e){var t=this.json,i=this.options,n=t.textures[e],a=t.images[n.source],r=this.textureLoader;if(a.uri){var s=i.manager.getHandler(a.uri);null!==s&&(r=s)}return this.loadTextureImage(e,a,r)},ee.prototype.loadTextureImage=function(e,t,i){var n=this,a=this.json,r=this.options,s=a.textures[e],o=self.URL||self.webkitURL,l=t.uri,c=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)l=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var i=new DataView(e,25,1).getUint8(0,!1);h=6===i||4===i||3===i}c=!0;var n=new Blob([e],{type:t.mimeType});return l=o.createObjectURL(n)}));else if(void 0===t.uri)throw new Error("THREE.DHLoaderAVWS: Image "+e+" is missing URI and bufferView");return Promise.resolve(l).then((function(e){return new Promise((function(t,n){var a=t;!0===i.isImageBitmapLoader&&(a=function(e){t(new vs(e))}),i.load(q(e,r.path),a,void 0,n)}))})).then((function(t){!0===c&&o.revokeObjectURL(l),t.flipY=!1,s.name&&(t.name=s.name),h||(t.format=C);var i=(a.samplers||{})[s.sampler]||{};return t.magFilter=z[i.magFilter]||b,t.minFilter=z[i.minFilter]||x,t.wrapS=U[i.wrapS]||d,t.wrapT=U[i.wrapT]||d,n.associations.set(t,{type:"textures",index:e}),t}))},ee.prototype.assignTexture=function(e,t,n){var a=this;return this.getDependency("texture",n.index).then((function(r){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||logger.warn("THREE.DHLoaderAVWS: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),a.extensions[i.KHR_TEXTURE_TRANSFORM]){var s=void 0!==n.extensions?n.extensions[i.KHR_TEXTURE_TRANSFORM]:void 0;if(s){var o=a.associations.get(r);r=a.extensions[i.KHR_TEXTURE_TRANSFORM].extendTexture(r,s),a.associations.set(r,o)}}e[t]=r}))},ee.prototype.assignFinalMaterial=function(e){var t=e.geometry,i=e.material,n=void 0!==t.attributes.tangent,a=void 0!==t.attributes.color,r=void 0===t.attributes.normal,s=!0===e.isSkinnedMesh,o=Object.keys(t.morphAttributes).length>0,l=o&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+i.uuid,h=this.cache.get(c);h||(h=new cs,Vt.prototype.copy.call(h,i),h.color.copy(i.color),h.map=i.map,h.sizeAttenuation=!1,this.cache.add(c,h)),i=h}else if(e.isLine){c="LineBasicMaterial:"+i.uuid;var u=this.cache.get(c);u||(u=new Kr,Vt.prototype.copy.call(u,i),u.color.copy(i.color),this.cache.add(c,u)),i=u}if(n||a||r||s||o){c="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),s&&(c+="skinning:"),n&&(c+="vertex-tangents:"),a&&(c+="vertex-colors:"),r&&(c+="flat-shading:"),o&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=i.clone(),s&&(d.skinning=!0),a&&(d.vertexColors=!0),r&&(d.flatShading=!0),o&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(i))),i=d}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i},ee.prototype.getMaterialType=function(){return So},ee.prototype.loadMaterial=function(e){var t,n=this,a=this.json,r=this.extensions,s=a.materials[e],o={},l=s.extensions||{},c=[];if(l[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(o,s,n))}else if(l[i.KHR_MATERIALS_UNLIT]){var u=r[i.KHR_MATERIALS_UNLIT];t=u.getMaterialType(),c.push(u.extendParams(o,s,n))}else{var d=s.pbrMetallicRoughness||{};if(o.color=new Qt(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;o.color.fromArray(p),o.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(o,"map",d.baseColorTexture)),o.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,o.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===s.doubleSided&&(o.side=2);var m=s.alphaMode||V;return m===Z?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,m===W&&(o.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==Kt&&(c.push(n.assignTexture(o,"normalMap",s.normalTexture)),o.normalScale=new ye(1,-1),void 0!==s.normalTexture.scale&&o.normalScale.set(s.normalTexture.scale,-s.normalTexture.scale)),void 0!==s.occlusionTexture&&t!==Kt&&(c.push(n.assignTexture(o,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(o.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==Kt&&(o.emissive=(new Qt).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&t!==Kt&&c.push(n.assignTexture(o,"emissiveMap",s.emissiveTexture)),Promise.all(c).then((function(){var a;return a=t===T?r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),s.name&&(a.name=s.name),a.map&&(a.map.encoding=te),a.emissiveMap&&(a.emissiveMap.encoding=te),Q(a,s),n.associations.set(a,{type:"materials",index:e}),s.extensions&&J(r,a,s),a}))},ee.prototype.createUniqueName=function(e){return e},ee.prototype.loadGeometries=function(e){var t=this,n=this.extensions,a=this.primitiveCache;function r(e){return n[i.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return ie(i,e,t)}))}for(var s,o,l=[],c=0,h=e.length;c<h;c++){var u,d=e[c],p=(o=void 0,(o=(s=d).extensions&&s.extensions[i.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+$(o.attributes):s.indices+":"+$(s.attributes)+":"+s.mode),m=a[p];if(m)l.push(m.promise);else u=d.extensions&&d.extensions[i.KHR_DRACO_MESH_COMPRESSION]?r(d):ie(new wi,d,t),a[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},ee.prototype.loadMesh=function(e){for(var t,i=this,n=this.json,a=this.extensions,r=n.meshes[e],s=r.primitives,o=[],l=0,c=s.length;l<c;l++){var h=void 0===s[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new So({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:0})),t.DefaultMaterial):this.getDependency("material",s[l].material);o.push(h)}return o.push(i.loadGeometries(s)),Promise.all(o).then((function(t){for(var n=t.slice(0,t.length-1),o=t[t.length-1],l=[],c=0,h=o.length;c<h;c++){var u,d=o[c],p=s[c],m=n[c];if(p.mode===L||p.mode===k||p.mode===N||void 0===p.mode)!0!==(u=!0===r.isSkinnedMesh?new Hr(d,m):new Fi(d,m)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===k?u.geometry=ne(u.geometry,1):p.mode===N&&(u.geometry=ne(u.geometry,2));else if(p.mode===R)u=new os(d,m);else if(p.mode===D)u=new as(d,m);else if(p.mode===O)u=new ls(d,m);else{if(p.mode!==P)throw new Error("THREE.DHLoaderAVWS: Primitive mode unsupported: "+p.mode);u=new ms(d,m)}Object.keys(u.geometry.morphAttributes).length>0&&K(u,r),u.name=i.createUniqueName(r.name||"mesh_"+e),Q(u,r),p.extensions&&J(a,u,p),i.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var f=new sr;for(c=0,h=l.length;c<h;c++)f.add(l[c]);return f}))},ee.prototype.loadCamera=function(e){var t,i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new Zi(ge.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new jl(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Q(t,i),Promise.resolve(t);logger.warn("THREE.DHLoaderAVWS: Missing camera parameters.")},ee.prototype.loadSkin=function(e){var t=this.json.skins[e],i={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return i.inverseBindMatrices=e,i}))},ee.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],i=[],n=[],a=[],r=[],s=[],o=0,l=t.channels.length;o<l;o++){var c=t.channels[o],h=t.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==t.parameters?t.parameters[h.input]:h.input,m=void 0!==t.parameters?t.parameters[h.output]:h.output;i.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),a.push(this.getDependency("accessor",m)),r.push(h),s.push(u)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(a),Promise.all(r),Promise.all(s)]).then((function(i){for(var n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=a[c],p=r[c],m=s[c],f=o[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,H[f.path]){case H.weights:g=Fo;break;case H.rotation:g=Ho;break;case H.position:case H.scale:default:g=Vo}var y=u.name?u.name:u.uuid,v=void 0!==m.interpolation?G[m.interpolation]:X,b=[];H[f.path]===H.weights?u.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&b.push(e.name?e.name:e.uuid)})):b.push(y);var _=p.array;if(p.normalized){var x;if(_.constructor===Int8Array)x=1/127;else if(_.constructor===Uint8Array)x=1/255;else if(_.constructor==Int16Array)x=1/32767;else{if(_.constructor!==Uint16Array)throw new Error("THREE.DHLoaderAVWS: Unsupported output accessor component type.");x=1/65535}for(var w=new Float32Array(_.length),S=0,M=_.length;S<M;S++)w[S]=_[S]*x;_=w}for(S=0,M=b.length;S<M;S++){var T=new g(b[S]+"."+H[f.path],d.array,_,v);"CUBICSPLINE"===m.interpolation&&(T.createInterpolant=function(e){return new I(this.times,this.values,this.getValueSize()/3,e)},T.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(T)}}}var A=t.name?t.name:"animation_"+e;return new Wo(A,void 0,l)}))},ee.prototype.loadNode=function(e){var t,i=this.json,n=this.extensions,a=this,r=i.nodes[e],s=r.name?a.createUniqueName(r.name):"";return(t=[],void 0!==r.mesh&&t.push(a.getDependency("mesh",r.mesh).then((function(e){var t=a._getNodeRef(a.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,i=r.weights.length;t<i;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))),void 0!==r.camera&&t.push(a.getDependency("camera",r.camera).then((function(e){return a._getNodeRef(a.cameraCache,r.camera,e)}))),a._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var i;if((i=!0===r.isBone?new Gr:t.length>1?new sr:1===t.length?t[0]:new Et)!==t[0])for(var o=0,l=t.length;o<l;o++)i.add(t[o]);if(r.name&&(i.userData.name=r.name,i.name=s),Q(i,r),r.extensions&&J(n,i,r),void 0!==r.matrix){var c=new it;c.fromArray(r.matrix),i.applyMatrix4(c)}else void 0!==r.translation&&i.position.fromArray(r.translation),void 0!==r.rotation&&i.quaternion.fromArray(r.rotation),void 0!==r.scale&&i.scale.fromArray(r.scale);return a.associations.set(i,{type:"nodes",index:e}),i}))},ee.prototype.loadScene=function(){function e(t,i,n,a){var r=n.nodes[t];return a.getDependency("node",t).then((function(e){return void 0===r.skin?e:a.getDependency("skin",r.skin).then((function(e){for(var i=[],n=0,r=(t=e).joints.length;n<r;n++)i.push(a.getDependency("node",t.joints[n]));return Promise.all(i)})).then((function(i){return e.traverse((function(e){if(e.isMesh){for(var n=[],a=[],r=0,s=i.length;r<s;r++){var o=i[r];if(o){n.push(o);var l=new it;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*r),a.push(l)}else logger.warn('THREE.DHLoaderAVWS: Joint "%s" could not be found.',t.joints[r])}e.bind(new Yr(n,a),e.matrixWorld)}})),e}));var t})).then((function(t){i.add(t);var s=[];if(r.children)for(var o=r.children,l=0,c=o.length;l<c;l++){var h=o[l];s.push(e(h,t,n,a))}return Promise.all(s)}))}return function(t){var i=this.json,n=this.extensions,a=this.json.scenes[t],r=new sr;a.name&&(r.name=this.createUniqueName(a.name)),Q(r,a),a.extensions&&J(n,r,a);for(var s=a.nodes||[],o=[],l=0,c=s.length;l<c;l++)o.push(e(s[l],r,i,this));return Promise.all(o).then((function(){return r}))}}(),e}(),yS={},vS=Uint8Array,bS=Uint16Array,_S=Uint32Array,xS=new vS([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),wS=new vS([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),SS=new vS([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),MS=function(e,t){for(var i=new bS(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var a=new _S(i[30]);for(n=1;n<30;++n)for(var r=i[n];r<i[n+1];++r)a[r]=r-i[n]<<5|n;return[i,a]},TS=MS(xS,2),AS=TS[0],ES=TS[1];AS[28]=258,ES[258]=28;for(var CS=MS(wS,0),IS=CS[0],PS=CS[1],RS=new bS(32768),OS=0;OS<32768;++OS){var DS=(43690&OS)>>>1|(21845&OS)<<1;DS=(61680&(DS=(52428&DS)>>>2|(13107&DS)<<2))>>>4|(3855&DS)<<4,RS[OS]=((65280&DS)>>>8|(255&DS)<<8)>>>1}var LS=function(e,t,i){for(var n=e.length,a=0,r=new bS(t);a<n;++a)++r[e[a]-1];var s,o=new bS(t);for(a=0;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(i){s=new bS(1<<t);var l=15-t;for(a=0;a<n;++a)if(e[a])for(var c=a<<4|e[a],h=t-e[a],u=o[e[a]-1]++<<h,d=u|(1<<h)-1;u<=d;++u)s[RS[u]>>>l]=c}else for(s=new bS(n),a=0;a<n;++a)e[a]&&(s[a]=RS[o[e[a]-1]++]>>>15-e[a]);return s},kS=new vS(288);for(OS=0;OS<144;++OS)kS[OS]=8;for(OS=144;OS<256;++OS)kS[OS]=9;for(OS=256;OS<280;++OS)kS[OS]=7;for(OS=280;OS<288;++OS)kS[OS]=8;var NS=new vS(32);for(OS=0;OS<32;++OS)NS[OS]=5;var BS=LS(kS,9,0),zS=LS(kS,9,1),US=LS(NS,5,0),FS=LS(NS,5,1),jS=function(e){for(var t=e[0],i=1;i<e.length;++i)e[i]>t&&(t=e[i]);return t},HS=function(e,t,i){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&i},GS=function(e,t){var i=t/8|0;return(e[i]|e[i+1]<<8|e[i+2]<<16)>>(7&t)},VS=function(e){return(e/8|0)+(7&e&&1)},WS=function(e,t,i){(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length);var n=new(e instanceof bS?bS:e instanceof _S?_S:vS)(i-t);return n.set(e.subarray(t,i)),n},YS=function(e,t,i){var n=e.length;if(!n||i&&!i.l&&n<5)return t||new vS(0);var a=!t||i,r=!i||i.i;i||(i={}),t||(t=new vS(3*n));var s=function(e){var i=t.length;if(e>i){var n=new vS(Math.max(2*i,e));n.set(t),t=n}},o=i.f||0,l=i.p||0,c=i.b||0,h=i.l,u=i.d,d=i.m,p=i.n,m=8*n;do{if(!h){i.f=o=HS(e,l,1);var f=HS(e,l+1,3);if(l+=3,!f){var g=e[(E=VS(l)+4)-4]|e[E-3]<<8,y=E+g;if(y>n){if(r)throw"unexpected EOF";break}a&&s(c+g),t.set(e.subarray(E,y),c),i.b=c+=g,i.p=l=8*y;continue}if(1==f)h=zS,u=FS,d=9,p=5;else{if(2!=f)throw"invalid block type";var v=HS(e,l,31)+257,b=HS(e,l+10,15)+4,_=v+HS(e,l+5,31)+1;l+=14;for(var x=new vS(_),w=new vS(19),S=0;S<b;++S)w[SS[S]]=HS(e,l+3*S,7);l+=3*b;var M=jS(w),T=(1<<M)-1;if(!r&&l+_*(M+7)>m)break;var A=LS(w,M,1);for(S=0;S<_;){var E,C=A[HS(e,l,T)];if(l+=15&C,(E=C>>>4)<16)x[S++]=E;else{var I=0,P=0;for(16==E?(P=3+HS(e,l,3),l+=2,I=x[S-1]):17==E?(P=3+HS(e,l,7),l+=3):18==E&&(P=11+HS(e,l,127),l+=7);P--;)x[S++]=I}}var R=x.subarray(0,v),O=x.subarray(v);d=jS(R),p=jS(O),h=LS(R,d,1),u=LS(O,p,1)}if(l>m)throw"unexpected EOF"}a&&s(c+131072);for(var D=(1<<d)-1,L=(1<<p)-1,k=d+p+18;r||l+k<m;){var N=(I=h[GS(e,l)&D])>>>4;if((l+=15&I)>m)throw"unexpected EOF";if(!I)throw"invalid length/literal";if(N<256)t[c++]=N;else{if(256==N){h=null;break}var B=N-254;if(N>264){var z=xS[S=N-257];B=HS(e,l,(1<<z)-1)+AS[S],l+=z}var U=u[GS(e,l)&L],F=U>>>4;if(!U)throw"invalid distance";l+=15&U;O=IS[F];if(F>3){z=wS[F];O+=GS(e,l)&(1<<z)-1,l+=z}if(l>m)throw"unexpected EOF";a&&s(c+131072);for(var j=c+B;c<j;c+=4)t[c]=t[c-O],t[c+1]=t[c+1-O],t[c+2]=t[c+2-O],t[c+3]=t[c+3-O];c=j}}i.l=h,i.p=l,i.b=c,h&&(o=1,i.m=d,i.d=u,i.n=p)}while(!o);return c==t.length?t:WS(t,0,c)},XS=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8},ZS=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8,e[n+2]|=i>>>16},qS=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var a=i.length,r=i.slice();if(!a)return[iM,0];if(1==a){var s=new vS(i[0].s+1);return s[i[0].s]=1,[s,1]}i.sort((function(e,t){return e.f-t.f})),i.push({s:-1,f:25001});var o=i[0],l=i[1],c=0,h=1,u=2;for(i[0]={s:-1,f:o.f+l.f,l:o,r:l};h!=a-1;)o=i[i[c].f<i[u].f?c++:u++],l=i[c!=h&&i[c].f<i[u].f?c++:u++],i[h++]={s:-1,f:o.f+l.f,l:o,r:l};var d=r[0].s;for(n=1;n<a;++n)r[n].s>d&&(d=r[n].s);var p=new bS(d+1),m=JS(i[h-1],p,0);if(m>t){n=0;var f=0,g=m-t,y=1<<g;for(r.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));n<a;++n){var v=r[n].s;if(!(p[v]>t))break;f+=y-(1<<m-p[v]),p[v]=t}for(f>>>=g;f>0;){var b=r[n].s;p[b]<t?f-=1<<t-p[b]++-1:++n}for(;n>=0&&f;--n){var _=r[n].s;p[_]==t&&(--p[_],++f)}m=t}return[new vS(p),m]},JS=function(e,t,i){return-1==e.s?Math.max(JS(e.l,t,i+1),JS(e.r,t,i+1)):t[e.s]=i},QS=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new bS(++t),n=0,a=e[0],r=1,s=function(e){i[n++]=e},o=1;o<=t;++o)if(e[o]==a&&o!=t)++r;else{if(!a&&r>2){for(;r>138;r-=138)s(32754);r>2&&(s(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(s(a),--r;r>6;r-=6)s(8304);r>2&&(s(r-3<<5|8208),r=0)}for(;r--;)s(a);r=1,a=e[o]}return[i.subarray(0,n),t]},KS=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},$S=function(e,t,i){var n=i.length,a=VS(t+2);e[a]=255&n,e[a+1]=n>>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var r=0;r<n;++r)e[a+r+4]=i[r];return 8*(a+4+n)},eM=function(e,t,i,n,a,r,s,o,l,c,h){XS(t,h++,i),++a[256];for(var u=qS(a,15),d=u[0],p=u[1],m=qS(r,15),f=m[0],g=m[1],y=QS(d),v=y[0],b=y[1],_=QS(f),x=_[0],w=_[1],S=new bS(19),M=0;M<v.length;++M)S[31&v[M]]++;for(M=0;M<x.length;++M)S[31&x[M]]++;for(var T=qS(S,7),A=T[0],E=T[1],C=19;C>4&&!A[SS[C-1]];--C);var I,P,R,O,D=c+5<<3,L=KS(a,kS)+KS(r,NS)+s,k=KS(a,d)+KS(r,f)+s+14+3*C+KS(S,A)+(2*S[16]+3*S[17]+7*S[18]);if(D<=L&&D<=k)return $S(t,h,e.subarray(l,l+c));if(XS(t,h,1+(k<L)),h+=2,k<L){I=LS(d,p,0),P=d,R=LS(f,g,0),O=f;var N=LS(A,E,0);XS(t,h,b-257),XS(t,h+5,w-1),XS(t,h+10,C-4),h+=14;for(M=0;M<C;++M)XS(t,h+3*M,A[SS[M]]);h+=3*C;for(var B=[v,x],z=0;z<2;++z){var U=B[z];for(M=0;M<U.length;++M){var F=31&U[M];XS(t,h,N[F]),h+=A[F],F>15&&(XS(t,h,U[M]>>>5&127),h+=U[M]>>>12)}}}else I=BS,P=kS,R=US,O=NS;for(M=0;M<o;++M)if(n[M]>255){F=n[M]>>>18&31;ZS(t,h,I[F+257]),h+=P[F+257],F>7&&(XS(t,h,n[M]>>>23&31),h+=xS[F]);var j=31&n[M];ZS(t,h,R[j]),h+=O[j],j>3&&(ZS(t,h,n[M]>>>5&8191),h+=wS[j])}else ZS(t,h,I[n[M]]),h+=P[n[M]];return ZS(t,h,I[256]),h+P[256]},tM=new _S([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),iM=new vS(0),nM=function(e,t,i,n,a,r){var s=e.length,o=new vS(n+s+5*(1+Math.ceil(s/7e3))+a),l=o.subarray(n,o.length-a),c=0;if(!t||s<8)for(var h=0;h<=s;h+=65535){var u=h+65535;u<s?c=$S(l,c,e.subarray(h,u)):(l[h]=r,c=$S(l,c,e.subarray(h,s)))}else{for(var d=tM[t-1],p=d>>>13,m=8191&d,f=(1<<i)-1,g=new bS(32768),y=new bS(f+1),v=Math.ceil(i/3),b=2*v,_=function(t){return(e[t]^e[t+1]<<v^e[t+2]<<b)&f},x=new _S(25e3),w=new bS(288),S=new bS(32),M=0,T=0,A=(h=0,0),E=0,C=0;h<s;++h){var I=_(h),P=32767&h,R=y[I];if(g[P]=R,y[I]=P,E<=h){var O=s-h;if((M>7e3||A>24576)&&O>423){c=eM(e,l,0,x,w,S,T,A,C,h-C,c),A=M=T=0,C=h;for(var D=0;D<286;++D)w[D]=0;for(D=0;D<30;++D)S[D]=0}var L=2,k=0,N=m,B=P-R&32767;if(O>2&&I==_(h-B))for(var z=Math.min(p,O)-1,U=Math.min(32767,h),F=Math.min(258,O);B<=U&&--N&&P!=R;){if(e[h+L]==e[h+L-B]){for(var j=0;j<F&&e[h+j]==e[h+j-B];++j);if(j>L){if(L=j,k=B,j>z)break;var H=Math.min(B,j-2),G=0;for(D=0;D<H;++D){var V=h-B+D+32768&32767,W=V-g[V]+32768&32767;W>G&&(G=W,R=V)}}}B+=(P=R)-(R=g[P])+32768&32767}if(k){x[A++]=268435456|ES[L]<<18|PS[k];var Y=31&ES[L],X=31&PS[k];T+=xS[Y]+wS[X],++w[257+Y],++S[X],E=h+L,++M}else x[A++]=e[h],++w[e[h]]}}c=eM(e,l,r,x,w,S,T,A,C,h-C,c),!r&&7&c&&(c=$S(l,c+1,iM))}return WS(o,0,n+VS(c)+a)},aM=function(){for(var e=new _S(256),t=0;t<256;++t){for(var i=t,n=9;--n;)i=(1&i&&3988292384)^i>>>1;e[t]=i}return e}(),rM=function(){var e=-1;return{p:function(t){for(var i=e,n=0;n<t.length;++n)i=aM[255&i^t[n]]^i>>>8;e=i},d:function(){return~e}}},sM=function(){var e=1,t=0;return{p:function(i){for(var n=e,a=t,r=i.length,s=0;s!=r;){for(var o=Math.min(s+2655,r);s<o;++s)a+=n+=i[s];n=(65535&n)+15*(n>>16),a=(65535&a)+15*(a>>16)}e=n,t=a},d:function(){return((e%=65521)>>>8<<16|(255&(t%=65521))<<8|t>>>8)+2*((255&e)<<23)}}},oM=function(e,t,i,n,a){return nM(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,i,n,!a)},lM=function(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i},cM=function(e,t,i){for(var n=e(),a=e.toString(),r=a.slice(a.indexOf("[")+1,a.lastIndexOf("]")).replace(/ /g,"").split(","),s=0;s<n.length;++s){var o=n[s],l=r[s];if("function"==typeof o){t+=";"+l+"=";var c=o.toString();if(o.prototype)if(-1!=c.indexOf("[native code]")){var h=c.indexOf(" ",8)+1;t+=c.slice(h,c.indexOf("(",h))}else for(var u in t+=c,o.prototype)t+=";"+l+".prototype."+u+"="+o.prototype[u].toString();else t+=c}else i[l]=o}return[t,i]},hM=[],uM=function(e,t,i,n){var a;if(!hM[i]){for(var r="",s={},o=e.length-1,l=0;l<o;++l)r=(a=cM(e[l],r,s))[0],s=a[1];hM[i]=cM(e[o],r,s)}var c=lM({},hM[i][1]);return function(e,t,i,n,a){var r=yS[t]||(yS[t]=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))),s=new Worker(r);return s.onerror=function(e){return a(e.error,null)},s.onmessage=function(e){return a(null,e.data)},s.postMessage(i,n),s}(hM[i][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+t.toString()+"}",i,c,function(e){var t=[];for(var i in e)(e[i]instanceof vS||e[i]instanceof bS||e[i]instanceof _S)&&t.push((e[i]=new e[i].constructor(e[i])).buffer);return t}(c),n)},dM=function(){return[vS,bS,_S,xS,wS,SS,AS,IS,zS,FS,RS,LS,jS,HS,GS,VS,WS,YS,jM,vM,bM]},pM=function(){return[vS,bS,_S,xS,wS,SS,ES,PS,BS,kS,US,NS,RS,tM,iM,LS,XS,ZS,qS,JS,QS,KS,$S,eM,VS,WS,nM,oM,BM,vM]},mM=function(){return[EM,PM,AM,rM,aM]},fM=function(){return[CM,IM]},gM=function(){return[RM,AM,sM]},yM=function(){return[OM]},vM=function(e){return postMessage(e,[e.buffer])},bM=function(e){return e&&e.size&&new vS(e.size)},_M=function(e,t,i,n,a,r){var s=uM(i,n,a,(function(e,t){s.terminate(),r(e,t)}));return s.postMessage([e,t],t.consume?[e.buffer]:[]),function(){s.terminate()}},xM=function(e){return e.ondata=function(e,t){return postMessage([e,t],[e.buffer])},function(t){return e.push(t.data[0],t.data[1])}},wM=function(e,t,i,n,a){var r,s=uM(e,n,a,(function(e,i){e?(s.terminate(),t.ondata.call(t,e)):(i[1]&&s.terminate(),t.ondata.call(t,e,i[0],i[1]))}));s.postMessage(i),t.push=function(e,i){if(r)throw"stream finished";if(!t.ondata)throw"no stream handler";s.postMessage([e,r=i],[e.buffer])},t.terminate=function(){s.terminate()}},SM=function(e,t){return e[t]|e[t+1]<<8},MM=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+2*(e[t+3]<<23)},TM=function(e,t){return MM(e,t)|4294967296*MM(e,t)},AM=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8},EM=function(e,t){var i=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&AM(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),i){e[3]=8;for(var n=0;n<=i.length;++n)e[n+10]=i.charCodeAt(n)}},CM=function(e){if(31!=e[0]||139!=e[1]||8!=e[2])throw"invalid gzip data";var t=e[3],i=10;4&t&&(i+=e[10]|2+(e[11]<<8));for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!e[i++]);return i+(2&t)},IM=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16)+2*(e[t-1]<<23)},PM=function(e){return 10+(e.filename&&e.filename.length+1||0)},RM=function(e,t){var i=t.level,n=0==i?0:i<6?1:9==i?3:2;e[0]=120,e[1]=n<<6|(n?32-2*n:1)},OM=function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function DM(e,t){return!t&&"function"==typeof e&&(t=e,e={}),this.ondata=t,e}var LM=function(){function e(e,t){!t&&"function"==typeof e&&(t=e,e={}),this.ondata=t,this.o=e||{}}return e.prototype.p=function(e,t){this.ondata(oM(e,this.o,0,0,!t),t)},e.prototype.push=function(e,t){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=t,this.p(e,t||!1)},e}(),kM=function(e,t){wM([pM,function(){return[xM,LM]}],this,DM.call(this,e,t),(function(e){var t=new LM(e.data);onmessage=xM(t)}),6)};function NM(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return _M(e,t,[pM],(function(e){return vM(BM(e.data[0],e.data[1]))}),0,i)}function BM(e,t){return oM(e,t||{},0,0)}var zM=function(){function e(e){this.s={},this.p=new vS(0),this.ondata=e}return e.prototype.e=function(e){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var t=this.p.length,i=new vS(t+e.length);i.set(this.p),i.set(e,t),this.p=i},e.prototype.c=function(e){this.d=this.s.i=e||!1;var t=this.s.b,i=YS(this.p,this.o,this.s);this.ondata(WS(i,t,this.s.b),this.d),this.o=WS(i,this.s.b-32768),this.s.b=this.o.length,this.p=WS(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}(),UM=function(e){this.ondata=e,wM([dM,function(){return[xM,zM]}],this,0,(function(){var e=new zM;onmessage=xM(e)}),7)};function FM(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return _M(e,t,[dM],(function(e){return vM(jM(e.data[0],bM(e.data[1])))}),1,i)}function jM(e,t){return YS(e,t)}var HM=function(){function e(e,t){this.c=rM(),this.l=0,this.v=1,LM.call(this,e,t)}return e.prototype.push=function(e,t){LM.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e),this.l+=e.length;var i=oM(e,this.o,this.v&&PM(this.o),t&&8,!t);this.v&&(EM(i,this.o),this.v=0),t&&(AM(i,i.length-8,this.c.d()),AM(i,i.length-4,this.l)),this.ondata(i,t)},e}(),GM=function(e,t){wM([pM,mM,function(){return[xM,LM,HM]}],this,DM.call(this,e,t),(function(e){var t=new HM(e.data);onmessage=xM(t)}),8)};function VM(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return _M(e,t,[pM,mM,function(){return[WM]}],(function(e){return vM(WM(e.data[0],e.data[1]))}),2,i)}function WM(e,t){t||(t={});var i=rM(),n=e.length;i.p(e);var a=oM(e,t,PM(t),8),r=a.length;return EM(a,t),AM(a,r-8,i.d()),AM(a,r-4,n),a}var YM=function(){function e(e){this.v=1,zM.call(this,e)}return e.prototype.push=function(e,t){if(zM.prototype.e.call(this,e),this.v){var i=this.p.length>3?CM(this.p):4;if(i>=this.p.length&&!t)return;this.p=this.p.subarray(i),this.v=0}if(t){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}zM.prototype.c.call(this,t)},e}(),XM=function(e){this.ondata=e,wM([dM,fM,function(){return[xM,zM,YM]}],this,0,(function(){var e=new YM;onmessage=xM(e)}),9)};function ZM(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return _M(e,t,[dM,fM,function(){return[qM]}],(function(e){return vM(qM(e.data[0]))}),3,i)}function qM(e,t){return YS(e.subarray(CM(e),-8),t||new vS(IM(e)))}var JM=function(){function e(e,t){this.c=sM(),this.v=1,LM.call(this,e,t)}return e.prototype.push=function(e,t){LM.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e);var i=oM(e,this.o,this.v&&2,t&&4,!t);this.v&&(RM(i,this.o),this.v=0),t&&AM(i,i.length-4,this.c.d()),this.ondata(i,t)},e}(),QM=function(e,t){wM([pM,gM,function(){return[xM,LM,JM]}],this,DM.call(this,e,t),(function(e){var t=new JM(e.data);onmessage=xM(t)}),10)};function KM(e,t){t||(t={});var i=sM();i.p(e);var n=oM(e,t,2,4);return RM(n,t),AM(n,n.length-4,i.d()),n}var $M=function(){function e(e){this.v=1,zM.call(this,e)}return e.prototype.push=function(e,t){if(zM.prototype.e.call(this,e),this.v){if(this.p.length<2&&!t)return;this.p=this.p.subarray(2),this.v=0}if(t){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}zM.prototype.c.call(this,t)},e}(),eT=function(e){this.ondata=e,wM([dM,yM,function(){return[xM,zM,$M]}],this,0,(function(){var e=new $M;onmessage=xM(e)}),11)};function tT(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return _M(e,t,[dM,yM,function(){return[iT]}],(function(e){return vM(iT(e.data[0],bM(e.data[1])))}),5,i)}function iT(e,t){return YS((OM(e),e.subarray(2,-4)),t)}var nT=function(){function e(e){this.G=YM,this.I=zM,this.Z=$M,this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(e,t);else{if(this.p&&this.p.length){var i=new vS(this.p.length+e.length);i.set(this.p),i.set(e,this.p.length)}else this.p=e;if(this.p.length>2){var n=this,a=function(){n.ondata.apply(n,arguments)};this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(a):8!=(15&this.p[0])||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(a):new this.Z(a),this.s.push(this.p,t),this.p=null}}},e}(),aT=function(){function e(e){this.G=XM,this.I=UM,this.Z=eT,this.ondata=e}return e.prototype.push=function(e,t){nT.prototype.push.call(this,e,t)},e}();var rT=function(e,t,i,n){for(var a in e){var r=e[a],s=t+a;r instanceof vS?i[s]=[r,n]:Array.isArray(r)?i[s]=[r[0],lM(n,r[1])]:rT(r,s+"/",i,n)}},sT="undefined"!=typeof TextEncoder&&new TextEncoder,oT="undefined"!=typeof TextDecoder&&new TextDecoder,lT=0;try{oT.decode(iM,{stream:!0}),lT=1}catch(e){}var cT=function(e){for(var t="",i=0;;){var n=e[i++],a=(n>127)+(n>223)+(n>239);if(i+a>e.length)return[t,WS(e,i-1)];a?3==a?(n=((15&n)<<18|(63&e[i++])<<12|(63&e[i++])<<6|63&e[i++])-65536,t+=String.fromCharCode(55296|n>>10,56320|1023&n)):t+=1&a?String.fromCharCode((31&n)<<6|63&e[i++]):String.fromCharCode((15&n)<<12|(63&e[i++])<<6|63&e[i++]):t+=String.fromCharCode(n)}},hT=function(){function e(e){this.ondata=e,lT?this.t=new TextDecoder:this.p=iM}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(t||(t=!1),this.t)return this.ondata(this.t.decode(e,{stream:!t}),t);var i=new vS(this.p.length+e.length);i.set(this.p),i.set(e,this.p.length);var n=cT(i),a=n[0],r=n[1];if(t&&r.length)throw"invalid utf-8 data";this.p=r,this.ondata(a,t)},e}(),uT=function(){function e(e){this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";this.ondata(dT(e),t||!1)},e}();function dT(e,t){if(t){for(var i=new vS(e.length),n=0;n<e.length;++n)i[n]=e.charCodeAt(n);return i}if(sT)return sT.encode(e);var a=e.length,r=new vS(e.length+(e.length>>1)),s=0,o=function(e){r[s++]=e};for(n=0;n<a;++n){if(s+5>r.length){var l=new vS(s+8+(a-n<<1));l.set(r),r=l}var c=e.charCodeAt(n);c<128||t?o(c):c<2048?(o(192|c>>>6),o(128|63&c)):c>55295&&c<57344?(o(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++n))>>>18),o(128|c>>>12&63),o(128|c>>>6&63),o(128|63&c)):(o(224|c>>>12),o(128|c>>>6&63),o(128|63&c))}return WS(r,0,s)}function pT(e,t){if(t){for(var i="",n=0;n<e.length;n+=16384)i+=String.fromCharCode.apply(null,e.subarray(n,n+16384));return i}if(oT)return oT.decode(e);var a=cT(e),r=a[0];if(a[1].length)throw"invalid utf-8 data";return r}var mT=function(e){return 1==e?3:e<6?2:9==e?1:0},fT=function(e,t){return t+30+SM(e,t+26)+SM(e,t+28)},gT=function(e,t,i){var n=SM(e,t+28),a=pT(e.subarray(t+46,t+46+n),!(2048&SM(e,t+8))),r=t+46+n,s=MM(e,t+20),o=i&&4294967295==s?yT(e,r):[s,MM(e,t+24),MM(e,t+42)],l=o[0],c=o[1],h=o[2];return[SM(e,t+10),l,c,a,r+SM(e,t+30)+SM(e,t+32),h]},yT=function(e,t){for(;1!=SM(e,t);t+=4+SM(e,t+2));return[TM(e,t+12),TM(e,t+4),TM(e,t+20)]},vT=function(e){var t=0;if(e)for(var i in e){var n=e[i].length;if(n>65535)throw"extra field too long";t+=n+4}return t},bT=function(e,t,i,n,a,r,s,o){var l=n.length,c=i.extra,h=o&&o.length,u=vT(c);AM(e,t,null!=s?33639248:67324752),t+=4,null!=s&&(e[t++]=20,e[t++]=i.os),e[t]=20,t+=2,e[t++]=i.flag<<1|(null==r&&8),e[t++]=a&&8,e[t++]=255&i.compression,e[t++]=i.compression>>8;var d=new Date(null==i.mtime?Date.now():i.mtime),p=d.getFullYear()-1980;if(p<0||p>119)throw"date not in range 1980-2099";if(AM(e,t,2*(p<<24)|d.getMonth()+1<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|d.getSeconds()>>>1),t+=4,null!=r&&(AM(e,t,i.crc),AM(e,t+4,r),AM(e,t+8,i.size)),AM(e,t+12,l),AM(e,t+14,u),t+=16,null!=s&&(AM(e,t,h),AM(e,t+6,i.attrs),AM(e,t+10,s),t+=14),e.set(n,t),t+=l,u)for(var m in c){var f=c[m],g=f.length;AM(e,t,+m),AM(e,t+2,g),e.set(f,t+4),t+=4+g}return h&&(e.set(o,t),t+=h),t},_T=function(e,t,i,n,a){AM(e,t,101010256),AM(e,t+8,i),AM(e,t+10,i),AM(e,t+12,n),AM(e,t+16,a)},xT=function(){function e(e){this.filename=e,this.c=rM(),this.size=0,this.compression=0}return e.prototype.process=function(e,t){this.ondata(null,e,t)},e.prototype.push=function(e,t){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(e),this.size+=e.length,t&&(this.crc=this.c.d()),this.process(e,t||!1)},e}(),wT=function(){function e(e,t){var i=this;t||(t={}),xT.call(this,e),this.d=new LM(t,(function(e,t){i.ondata(null,e,t)})),this.compression=8,this.flag=mT(t.level)}return e.prototype.process=function(e,t){try{this.d.push(e,t)}catch(e){this.ondata(e,null,t)}},e.prototype.push=function(e,t){xT.prototype.push.call(this,e,t)},e}(),ST=function(){function e(e,t){var i=this;t||(t={}),xT.call(this,e),this.d=new kM(t,(function(e,t,n){i.ondata(e,t,n)})),this.compression=8,this.flag=mT(t.level),this.terminate=this.d.terminate}return e.prototype.process=function(e,t){this.d.push(e,t)},e.prototype.push=function(e,t){xT.prototype.push.call(this,e,t)},e}(),MT=function(){function e(e){this.ondata=e,this.u=[],this.d=1}return e.prototype.add=function(e){var t=this;if(2&this.d)throw"stream finished";var i=dT(e.filename),n=i.length,a=e.comment,r=a&&dT(a),s=n!=e.filename.length||r&&a.length!=r.length,o=n+vT(e.extra)+30;if(n>65535)throw"filename too long";var l=new vS(o);bT(l,0,e,i,s);var c=[l],h=function(){for(var e=0,i=c;e<i.length;e++){var n=i[e];t.ondata(null,n,!1)}c=[]},u=this.d;this.d=0;var d=this.u.length,p=lM(e,{f:i,u:s,o:r,t:function(){e.terminate&&e.terminate()},r:function(){if(h(),u){var e=t.u[d+1];e?e.r():t.d=1}u=1}}),m=0;e.ondata=function(i,n,a){if(i)t.ondata(i,n,a),t.terminate();else if(m+=n.length,c.push(n),a){var r=new vS(16);AM(r,0,134695760),AM(r,4,e.crc),AM(r,8,m),AM(r,12,e.size),c.push(r),p.c=m,p.b=o+m+16,p.crc=e.crc,p.size=e.size,u&&p.r(),u=1}else u&&h()},this.u.push(p)},e.prototype.end=function(){var e=this;if(2&this.d)throw 1&this.d?"stream finishing":"stream finished";this.d?this.e():this.u.push({r:function(){1&e.d&&(e.u.splice(-1,1),e.e())},t:function(){}}),this.d=3},e.prototype.e=function(){for(var e=0,t=0,i=0,n=0,a=this.u;n<a.length;n++){i+=46+(l=a[n]).f.length+vT(l.extra)+(l.o?l.o.length:0)}for(var r=new vS(i+22),s=0,o=this.u;s<o.length;s++){var l=o[s];bT(r,e,l,l.f,l.u,l.c,t,l.o),e+=46+l.f.length+vT(l.extra)+(l.o?l.o.length:0),t+=l.b}_T(r,e,this.u.length,i,t),this.ondata(null,r,!0),this.d=2},e.prototype.terminate=function(){for(var e=0,t=this.u;e<t.length;e++){t[e].t()}this.d=2},e}();var TT=function(){function e(){}return e.prototype.push=function(e,t){this.ondata(null,e,t)},e.compression=0,e}(),AT=function(){function e(){var e=this;this.i=new zM((function(t,i){e.ondata(null,t,i)}))}return e.prototype.push=function(e,t){try{this.i.push(e,t)}catch(i){this.ondata(i,e,t)}},e.compression=8,e}(),ET=function(){function e(e,t){var i=this;t<32e4?this.i=new zM((function(e,t){i.ondata(null,e,t)})):(this.i=new UM((function(e,t,n){i.ondata(e,t,n)})),this.terminate=this.i.terminate)}return e.prototype.push=function(e,t){this.i.terminate&&(e=WS(e,0)),this.i.push(e,t)},e.compression=8,e}(),CT=function(){function e(e){this.onfile=e,this.k=[],this.o={0:TT},this.p=iM}return e.prototype.push=function(e,t){var i=this;if(!this.onfile)throw"no callback";if(this.c>0){var n=Math.min(this.c,e.length),a=e.subarray(0,n);if(this.c-=n,this.d?this.d.push(a,!this.c):this.k[0].push(a),(e=e.subarray(n)).length)return this.push(e,t)}else{var r=0,s=0,o=void 0,l=void 0;this.p.length?e.length?((l=new vS(this.p.length+e.length)).set(this.p),l.set(e,this.p.length)):l=this.p:l=e;for(var c=l.length,h=this.c,u=h&&this.d,d=function(){var e,t=MM(l,s);if(67324752==t){r=1,o=s,p.d=null,p.c=0;var n=SM(l,s+6),a=SM(l,s+8),u=2048&n,d=8&n,m=SM(l,s+26),f=SM(l,s+28);if(c>s+30+m+f){var g=[];p.k.unshift(g),r=2;var y=MM(l,s+18),v=MM(l,s+22),b=pT(l.subarray(s+30,s+=30+m),!u);4294967295==y?(e=d?[-2]:yT(l,s),y=e[0],v=e[1]):d&&(y=-1),s+=f,p.c=y;var _={name:b,compression:a,start:function(){if(!_.ondata)throw"no callback";if(y){var e=i.o[a];if(!e)throw"unknown compression type "+a;var t=y<0?new e(b):new e(b,y,v);t.ondata=function(e,t,i){_.ondata(e,t,i)};for(var n=0,r=g;n<r.length;n++){var s=r[n];t.push(s,!1)}i.k[0]==g?i.d=t:t.push(iM,!0)}else _.ondata(null,iM,!0)},terminate:function(){i.k[0]==g&&i.d.terminate&&i.d.terminate()}};y>=0&&(_.size=y,_.originalSize=v),p.onfile(_)}return"break"}if(h){if(134695760==t)return o=s+=12+(-2==h&&8),r=2,p.c=0,"break";if(33639248==t)return o=s-=4,r=2,p.c=0,"break"}},p=this;s<c-4;++s){if("break"===d())break}if(this.p=iM,h<0){var m=r?l.subarray(0,o-12-(-2==h&&8)-(134695760==MM(l,o-16)&&4)):l.subarray(0,s);u?u.push(m,!!r):this.k[+(2==r)].push(m)}if(2&r)return this.push(l.subarray(s),t);this.p=l.subarray(s)}if(t&&this.c)throw"invalid zip file"},e.prototype.register=function(e){this.o[e.compression]=e},e}();var IT=Object.freeze({__proto__:null,AsyncCompress:GM,AsyncDecompress:aT,AsyncDeflate:kM,AsyncGunzip:XM,AsyncGzip:GM,AsyncInflate:UM,AsyncUnzipInflate:ET,AsyncUnzlib:eT,AsyncZipDeflate:ST,AsyncZlib:QM,Compress:HM,DecodeUTF8:hT,Decompress:nT,Deflate:LM,EncodeUTF8:uT,Gunzip:YM,Gzip:HM,Inflate:zM,Unzip:CT,UnzipInflate:AT,UnzipPassThrough:TT,Unzlib:$M,Zip:MT,ZipDeflate:wT,ZipPassThrough:xT,Zlib:JM,compress:VM,compressSync:WM,decompress:function(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return 31==e[0]&&139==e[1]&&8==e[2]?ZM(e,t,i):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?FM(e,t,i):tT(e,t,i)},decompressSync:function(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?qM(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?jM(e,t):iT(e,t)},deflate:NM,deflateSync:BM,gunzip:ZM,gunzipSync:qM,gzip:VM,gzipSync:WM,inflate:FM,inflateSync:jM,strFromU8:pT,strToU8:dT,unzip:function(e,t){if("function"!=typeof t)throw"no callback";for(var i=[],n=function(){for(var e=0;e<i.length;++e)i[e]()},a={},r=e.length-22;101010256!=MM(e,r);--r)if(!r||e.length-r>65558)return void t("invalid zip file",null);var s=SM(e,r+8);s||t(null,{});var o=s,l=MM(e,r+16),c=4294967295==l;if(c){if(r=MM(e,r-12),101075792!=MM(e,r))return void t("invalid zip file",null);o=s=MM(e,r+32),l=MM(e,r+48)}for(var h=function(r){var o=gT(e,l,c),h=o[0],u=o[1],d=o[2],p=o[3],m=o[4],f=o[5],g=fT(e,f);l=m;var y=function(e,i){e?(n(),t(e,null)):(a[p]=i,--s||t(null,a))};if(h)if(8==h){var v=e.subarray(g,g+u);if(u<32e4)try{y(null,jM(v,new vS(d)))}catch(e){y(e,null)}else i.push(FM(v,{size:d},y))}else y("unknown compression type "+h,null);else y(null,WS(e,g,g+u))},u=0;u<o;++u)h();return n},unzipSync:function(e){for(var t={},i=e.length-22;101010256!=MM(e,i);--i)if(!i||e.length-i>65558)throw"invalid zip file";var n=SM(e,i+8);if(!n)return{};var a=MM(e,i+16),r=4294967295==a;if(r){if(i=MM(e,i-12),101075792!=MM(e,i))throw"invalid zip file";n=MM(e,i+32),a=MM(e,i+48)}for(var s=0;s<n;++s){var o=gT(e,a,r),l=o[0],c=o[1],h=o[2],u=o[3],d=o[4],p=o[5],m=fT(e,p);if(a=d,l){if(8!=l)throw"unknown compression type "+l;t[u]=jM(e.subarray(m,m+c),new vS(h))}else t[u]=WS(e,m,m+c)}return t},unzlib:tT,unzlibSync:iT,zip:function(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";var n={};rT(e,"",n,t);var a=Object.keys(n),r=a.length,s=0,o=0,l=r,c=new Array(r),h=[],u=function(){for(var e=0;e<h.length;++e)h[e]()},d=function(){var e=new vS(o+22),t=s,n=o-s;o=0;for(var a=0;a<l;++a){var r=c[a];try{var h=r.c.length;bT(e,o,r,r.f,r.u,h);var u=30+r.f.length+vT(r.extra),d=o+u;e.set(r.c,d),bT(e,s,r,r.f,r.u,h,o,r.m),s+=16+u+(r.m?r.m.length:0),o=d+h}catch(e){return i(e,null)}}_T(e,s,c.length,n,t),i(null,e)};r||d();for(var p=function(e){var t=a[e],l=n[t],p=l[0],m=l[1],f=rM(),g=p.length;f.p(p);var y=dT(t),v=y.length,b=m.comment,_=b&&dT(b),x=_&&_.length,w=vT(m.extra),S=0==m.level?0:8,M=function(n,a){if(n)u(),i(n,null);else{var l=a.length;c[e]=lM(m,{size:g,crc:f.d(),c:a,f:y,m:_,u:v!=t.length||_&&b.length!=x,compression:S}),s+=30+v+w+l,o+=76+2*(v+w)+(x||0)+l,--r||d()}};if(v>65535&&M("filename too long",null),S)if(g<16e4)try{M(null,BM(p,m))}catch(e){M(e,null)}else h.push(NM(p,m,M));else M(null,p)},m=0;m<l;++m)p(m);return u},zipSync:function(e,t){t||(t={});var i={},n=[];rT(e,"",i,t);var a=0,r=0;for(var s in i){var o=i[s],l=o[0],c=o[1],h=0==c.level?0:8,u=(S=dT(s)).length,d=c.comment,p=d&&dT(d),m=p&&p.length,f=vT(c.extra);if(u>65535)throw"filename too long";var g=h?BM(l,c):l,y=g.length,v=rM();v.p(l),n.push(lM(c,{size:l.length,crc:v.d(),c:g,f:S,m:p,u:u!=s.length||p&&d.length!=m,o:a,compression:h})),a+=30+u+f+y,r+=76+2*(u+f)+(m||0)+y}for(var b=new vS(r+22),_=a,x=r-a,w=0;w<n.length;++w){var S=n[w];bT(b,S.o,S,S.f,S.u,S.c.length);var M=30+S.f.length+vT(S.extra);b.set(S.c,S.o+M),bT(b,a,S,S.f,S.u,S.c.length,S.o,S.m),a+=16+M+(S.m?S.m.length:0)}return _T(b,a,n.length,x,_),b},zlib:function(e,t,i){if(i||(i=t,t={}),"function"!=typeof i)throw"no callback";return _M(e,t,[pM,gM,function(){return[KM]}],(function(e){return vM(KM(e.data[0],e.data[1]))}),4,i)},zlibSync:KM,default:null});const PT={findSpan:function(e,t,i){var n=i.length-e-1;if(t>=i[n])return n-1;if(t<=i[e])return e;for(var a=e,r=n,s=Math.floor((a+r)/2);t<i[s]||t>=i[s+1];)t<i[s]?r=s:a=s,s=Math.floor((a+r)/2);return s},calcBasisFunctions:function(e,t,i,n){var a=[],r=[],s=[];a[0]=1;for(var o=1;o<=i;++o){r[o]=t-n[e+1-o],s[o]=n[e+o]-t;for(var l=0,c=0;c<o;++c){var h=s[c+1],u=r[o-c],d=a[c]/(h+u);a[c]=l+h*d,l=u*d}a[o]=l}return a},calcBSplinePoint:function(e,t,i,n){for(var a=this.findSpan(e,n,t),r=this.calcBasisFunctions(a,n,e,t),s=new Me(0,0,0,0),o=0;o<=e;++o){var l=i[a-e+o],c=r[o],h=l.w*c;s.x+=l.x*h,s.y+=l.y*h,s.z+=l.z*h,s.w+=l.w*c}return s},calcBasisFunctionDerivatives:function(e,t,i,n,a){for(var r=[],s=0;s<=i;++s)r[s]=0;var o=[];for(s=0;s<=n;++s)o[s]=r.slice(0);var l=[];for(s=0;s<=i;++s)l[s]=r.slice(0);l[0][0]=1;for(var c=r.slice(0),h=r.slice(0),u=1;u<=i;++u){c[u]=t-a[e+1-u],h[u]=a[e+u]-t;for(var d=0,p=0;p<u;++p){var m=h[p+1],f=c[u-p];l[u][p]=m+f;var g=l[p][u-1]/l[u][p];l[p][u]=d+m*g,d=f*g}l[u][u]=d}for(u=0;u<=i;++u)o[0][u]=l[u][i];for(p=0;p<=i;++p){var y=0,v=1,b=[];for(s=0;s<=i;++s)b[s]=r.slice(0);b[0][0]=1;for(var _=1;_<=n;++_){var x=0,w=p-_,S=i-_;p>=_&&(b[v][0]=b[y][0]/l[S+1][w],x=b[v][0]*l[w][S]);var M=p-1<=S?_-1:i-p;for(u=w>=-1?1:-w;u<=M;++u)b[v][u]=(b[y][u]-b[y][u-1])/l[S+1][w+u],x+=b[v][u]*l[w+u][S];p<=S&&(b[v][_]=-b[y][_-1]/l[S+1][p],x+=b[v][_]*l[p][S]),o[_][p]=x;u=y;y=v,v=u}}for(p=i,_=1;_<=n;++_){for(u=0;u<=i;++u)o[_][u]*=p;p*=i-_}return o},calcBSplineDerivatives:function(e,t,i,n,a){for(var r=a<e?a:e,s=[],o=this.findSpan(e,n,t),l=this.calcBasisFunctionDerivatives(o,n,e,r,t),c=[],h=0;h<i.length;++h){var u=(p=i[h].clone()).w;p.x*=u,p.y*=u,p.z*=u,c[h]=p}for(var d=0;d<=r;++d){for(var p=c[o-e].clone().multiplyScalar(l[d][0]),m=1;m<=e;++m)p.add(c[o-e+m].clone().multiplyScalar(l[d][m]));s[d]=p}for(d=r+1;d<=a+1;++d)s[d]=new Me(0,0,0);return s},calcKoverI:function(e,t){for(var i=1,n=2;n<=e;++n)i*=n;var a=1;for(n=2;n<=t;++n)a*=n;for(n=2;n<=e-t;++n)a*=n;return i/a},calcRationalCurveDerivatives:function(e){for(var t=e.length,i=[],n=[],a=0;a<t;++a){var r=e[a];i[a]=new Ce(r.x,r.y,r.z),n[a]=r.w}for(var s=[],o=0;o<t;++o){var l=i[o].clone();for(a=1;a<=o;++a)l.sub(s[o-a].clone().multiplyScalar(this.calcKoverI(o,a)*n[a]));s[o]=l.divideScalar(n[0])}return s},calcNURBSDerivatives:function(e,t,i,n,a){var r=this.calcBSplineDerivatives(e,t,i,n,a);return this.calcRationalCurveDerivatives(r)},calcSurfacePoint:function(e,t,i,n,a,r,s,o){for(var l=this.findSpan(e,r,i),c=this.findSpan(t,s,n),h=this.calcBasisFunctions(l,r,e,i),u=this.calcBasisFunctions(c,s,t,n),d=[],p=0;p<=t;++p){d[p]=new Me(0,0,0,0);for(var m=0;m<=e;++m){var f=a[l-e+m][c-t+p].clone(),g=f.w;f.x*=g,f.y*=g,f.z*=g,d[p].add(f.multiplyScalar(h[m]))}}var y=new Me(0,0,0,0);for(p=0;p<=t;++p)y.add(d[p].multiplyScalar(u[p]));y.divideScalar(y.w),o.set(y.x,y.y,y.z)}},RT=function(e,t,i,n,a){rl.call(this),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=a||this.knots.length-1;for(var r=0;r<i.length;++r){var s=i[r];this.controlPoints[r]=new Me(s.x,s.y,s.z,s.w)}};(RT.prototype=Object.create(rl.prototype)).constructor=RT,RT.prototype.getPoint=function(e,t){var i=t||new Ce,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),a=PT.calcBSplinePoint(this.degree,this.knots,this.controlPoints,n);return 1!=a.w&&a.divideScalar(a.w),i.set(a.x,a.y,a.z)},RT.prototype.getTangent=function(e,t){var i=t||new Ce,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),a=PT.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,n,1);return i.copy(a[1]).normalize(),i};var OT=function(){var e,t,i;function n(e){Qo.call(this,e),this.dbPromise=hS(Ly,1,{upgrade(e,t,i,n){e.createObjectStore(ky)},blocked(){logger.warn("indexeddb request blocked.")},blocking(){logger.warn("indexeddb blocking another request.")},terminated(){logger.warn("indexeddb request terminated.")}})}function a(e){window._textureMap[e.name]=e}function r(e,t){this.textureLoader=e,this.manager=t}function s(){}function o(){}function c(){}function h(){}function u(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function p(){}function f(e){var t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("THREE.DHFBXLoader: Cannot find the version number for the file given.")}function g(e){return e/46186158e3}n.prototype=Object.assign(Object.create(Qo.prototype),{constructor:n,load:function(e,t,i,n){var a=this,r=""===a.path?ql.extractUrlBase(e):a.path,s=function(t){n?n(t):logger.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},o=new $o(this.manager);o.setPath(a.path),o.setResponseType("arraybuffer"),o.setRequestHeader(a.requestHeader),o.setWithCredentials(a.withCredentials);let l=[];for(let e in this.requestHeader)l.push({key:e,value:this.requestHeader[e]});let c=_y.fetchContentLastModified(e,l),h=fy(e);c.then((l=>{"0"===l&&o.load(e,(function(i){try{t(a.parse(i,r))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n);let c=fy(l);this.dbPromise.then((n=>{n.getAllKeys(ky).then((l=>{let u=!1;for(let o of l)if(0===o.indexOf(h)){o===`${h}:${c}`?(u=!0,n.get(ky,o).then((n=>{let o=n.byteLength;i&&i({type:"progress",total:o,loaded:o/2});try{t(a.parse(n,r)),i&&i({type:"progress",total:o,loaded:o}),a.manager.itemEnd(e)}catch(e){s(e)}}))):n.delete(ky,o).then((()=>{}));break}u||o.load(e,(function(i){try{t(a.parse(i,r)),a.manager.itemEnd(e),n.put(ky,i,`${h}:${c}`).then((()=>{logger.debug("db.put(CONST.INDEXED_DB_OBJECT_STORE, data, `${urlKey}:${lastModifiedKey}`)")}))}catch(e){s(e)}}),i,s)}))}))})).catch((s=>{o.load(e,(function(i){try{t(a.parse(i,r))}catch(t){n?n(t):console.error(t),a.manager.itemError(e)}}),i,n)}))},parse:function(t,i){if(s="Kaydara FBX Binary  \0",(a=t).byteLength>=s.length&&s===M(a,0,s.length))e=(new h).parse(t);else{var n=M(t);if(!function(e){var t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],i=0;function n(t){var n=e[t-1];return e=e.slice(i+t),i++,n}for(var a=0;a<t.length;++a){if(n(1)===t[a])return!1}return!0}(n))throw new Error("THREE.DHFBXLoader: Unknown format.");if(f(n)<7e3)throw new Error("THREE.DHFBXLoader: FBX version not supported, FileVersion: "+f(n));e=(new c).parse(n)}var a,s;return new r(new al(this.manager).setPath(this.resourcePath||i).setCrossOrigin(this.crossOrigin),this.manager).parse(e)}}),r.prototype={constructor:r,parse:function(){t=this.parseConnections();var e=this.parseImages(),n=this.parseTextures(e),a=this.parseMaterials(n),r=this.parseDeformers(),o=(new s).parse(r);return this.parseScene(r,o,a),i},parseConnections:function(){var t=new Map;"Connections"in e&&e.Connections.connections.forEach((function(e){var i=e[0],n=e[1],a=e[2];t.has(i)||t.set(i,{parents:[],children:[]});var r={ID:n,relationship:a};t.get(i).parents.push(r),t.has(n)||t.set(n,{parents:[],children:[]});var s={ID:i,relationship:a};t.get(n).children.push(s)}));return t},parseImages:function(){var t={},i={};if("Video"in e.Objects){var n=e.Objects.Video;for(var a in n){var r=n[a];if(t[c=parseInt(a)]=r.RelativeFilename||r.Filename,"Content"in r){var s=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,o="string"==typeof r.Content&&""!==r.Content;if(s||o){var l=this.parseImage(n[a]);i[r.RelativeFilename||r.Filename]=l}}}}for(var c in t){var h=t[c];void 0!==i[h]?t[c]=i[h]:t[c]=t[c].split("\\").pop()}return t},parseImage:function(e){var t,i=e.Content,n=e.RelativeFilename||e.Filename,a=n.slice(n.lastIndexOf(".")+1).toLowerCase();switch(a){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("DHFBXLoader: TGA loader not found, skipping ",n),t="image/tga";break;default:return void console.warn('DHFBXLoader: Image type "'+a+'" is not supported.')}if("string"==typeof i)return"data:"+t+";base64,"+i;var r=new Uint8Array(i);return window.URL.createObjectURL(new Blob([r],{type:t}))},parseTextures:function(t){var i=new Map;if("Texture"in e.Objects){var n=e.Objects.Texture;for(var a in n){var r=this.parseTexture(n[a],t);i.set(parseInt(a),r)}}return i},parseTexture:function(e,t){var i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;var n=e.WrapModeU,a=e.WrapModeV,r=void 0!==n?n.value:0,s=void 0!==a?a.value:0;if(i.wrapS=0===r?d:m,i.wrapT=0===s?d:m,"Scaling"in e){var o=e.Scaling.value;i.repeat.x=o[0],i.repeat.y=o[1]}return i},loadTexture:function(e,i){var n,r,s=this.textureLoader.path,o=t.get(e.id).children;void 0!==o&&o.length>0&&void 0!==i[o[0].ID]&&(0!==(n=i[o[0].ID]).indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));var l=e.FileName.slice(-3).toLowerCase();if("tga"===l){var c=this.manager.getHandler(".tga");null===c?(console.warn("DHFBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),r=new we):r=c.load(n)}else"psd"===l?(console.warn("DHFBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),r=new we):r=this.textureLoader.load(n,a);return this.textureLoader.setPath(s),r},parseMaterials:function(t){var i=new Map;if("Material"in e.Objects){var n=e.Objects.Material;for(var a in n){var r=this.parseMaterial(n[a],t);null!==r&&i.set(parseInt(a),r)}}return i},parseMaterial:function(e,i){var n=e.id,a=e.attrName,r=e.ShadingModel;if("object"==typeof r&&(r=r.value),!t.has(n))return null;var s,o=this.parseParameters(e,i,n);switch(r.toLowerCase()){case"phong":s=new To;break;case"lambert":s=new Co;break;default:console.warn('THREE.DHFBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),s=new To}return s.setValues(o),s.name=a,s},parseParameters:function(e,i,n){var a={};e.BumpFactor&&(a.bumpScale=e.BumpFactor.value),e.Diffuse?a.color=(new Qt).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(a.color=(new Qt).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(a.displacementScale=e.DisplacementFactor.value),e.Emissive?a.emissive=(new Qt).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(a.emissive=(new Qt).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(a.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(a.opacity=parseFloat(e.Opacity.value)),a.opacity<1&&(a.transparent=!0),e.ReflectionFactor&&(a.reflectivity=e.ReflectionFactor.value),e.Shininess&&(a.shininess=e.Shininess.value),e.Specular?a.specular=(new Qt).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(a.specular=(new Qt).fromArray(e.SpecularColor.value));var r=this;return t.get(n).children.forEach((function(e){var t=e.relationship;switch(t){case"Bump":a.bumpMap=r.getTexture(i,e.ID);break;case"Maya|TEX_ao_map":a.aoMap=r.getTexture(i,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":a.map=r.getTexture(i,e.ID),a.map.encoding=te;break;case"DisplacementColor":a.displacementMap=r.getTexture(i,e.ID);break;case"EmissiveColor":a.emissiveMap=r.getTexture(i,e.ID),a.emissiveMap.encoding=te;break;case"NormalMap":case"Maya|TEX_normal_map":a.normalMap=r.getTexture(i,e.ID);break;case"ReflectionColor":a.envMap=r.getTexture(i,e.ID),a.envMap.mapping=l,a.envMap.encoding=te;break;case"SpecularColor":a.specularMap=r.getTexture(i,e.ID),a.specularMap.encoding=te;break;case"TransparentColor":case"TransparencyFactor":a.alphaMap=r.getTexture(i,e.ID),a.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.DHFBXLoader: %s map is not supported in three.js, skipping texture.",t)}})),a},getTexture:function(i,n){return"LayeredTexture"in e.Objects&&n in e.Objects.LayeredTexture&&(console.warn("THREE.DHFBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),n=t.get(n).children[0].ID),i.get(n)},parseDeformers:function(){var i={},n={};if("Deformer"in e.Objects){var a=e.Objects.Deformer;for(var r in a){var s=a[r],o=t.get(parseInt(r));if("Skin"===s.attrType){var l=this.parseSkeleton(o,a);l.ID=r,o.parents.length>1&&console.warn("THREE.DHFBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=o.parents[0].ID,i[r]=l}else if("BlendShape"===s.attrType){var c={id:r};c.rawTargets=this.parseMorphTargets(o,a),c.id=r,o.parents.length>1&&console.warn("THREE.DHFBXLoader: morph target attached to more than one geometry is not supported."),n[r]=c}}}return{skeletons:i,morphTargets:n}},parseSkeleton:function(e,t){var i=[];return e.children.forEach((function(e){var n=t[e.ID];if("Cluster"===n.attrType){var a={ID:e.ID,indices:[],weights:[],transformLink:(new it).fromArray(n.TransformLink.a)};"Indexes"in n&&(a.indices=n.Indexes.a,a.weights=n.Weights.a),i.push(a)}})),{rawBones:i,bones:[]}},parseMorphTargets:function(e,i){for(var n=[],a=0;a<e.children.length;a++){var r=e.children[a],s=i[r.ID],o={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;o.geoID=t.get(parseInt(r.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(o)}return n},parseScene:function(n,a,r){i=new sr;var s=this.parseModels(n.skeletons,a,r),l=e.Objects.Model,c=this;s.forEach((function(e){var n=l[e.ID];c.setLookAtProperties(e,n),t.get(e.ID).parents.forEach((function(t){var i=s.get(t.ID);void 0!==i&&i.add(e)})),null===e.parent&&i.add(e)})),this.bindSkeleton(n.skeletons,a,s),this.createAmbientLight(),this.setupMorphMaterials(),i.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);var t=x(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));var h=(new o).parse();1===i.children.length&&i.children[0].isGroup&&(i.children[0].animations=h,i=i.children[0]),i.animations=h},parseModels:function(i,n,a){var r=new Map,s=e.Objects.Model;for(var o in s){var l=parseInt(o),c=s[o],h=t.get(l),u=this.buildSkeleton(h,i,l,c.attrName);if(!u){switch(c.attrType){case"Camera":u=this.createCamera(h);break;case"Light":u=this.createLight(h);break;case"Mesh":u=this.createMesh(h,n,a);break;case"NurbsCurve":u=this.createCurve(h,n);break;case"LimbNode":case"Root":u=new Gr;break;case"Null":default:u=new sr}u.name=c.attrName?Bc.sanitizeNodeName(c.attrName):"",u.ID=l}this.getTransformData(u,c),r.set(l,u)}return r},buildSkeleton:function(e,t,i,n){var a=null;return e.parents.forEach((function(e){for(var r in t){var s=t[r];s.rawBones.forEach((function(t,r){if(t.ID===e.ID){var o=a;(a=new Gr).matrixWorld.copy(t.transformLink),a.name=n?Bc.sanitizeNodeName(n):"",a.ID=i,s.bones[r]=a,null!==o&&a.add(o)}}))}})),a},createCamera:function(t){var i,n;if(t.children.forEach((function(t){var i=e.Objects.NodeAttribute[t.ID];void 0!==i&&(n=i)})),void 0===n)i=new Et;else{var a=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(a=1);var r=1;void 0!==n.NearPlane&&(r=n.NearPlane.value/1e3);var s=1e3;void 0!==n.FarPlane&&(s=n.FarPlane.value/1e3);var o=window.innerWidth,l=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(o=n.AspectWidth.value,l=n.AspectHeight.value);var c=o/l,h=45;void 0!==n.FieldOfView&&(h=n.FieldOfView.value);var u=n.FocalLength?n.FocalLength.value:null;switch(a){case 0:i=new Zi(h,c,r,s),null!==u&&i.setFocalLength(u);break;case 1:i=new jl(-o/2,o/2,l/2,-l/2,r,s);break;default:console.warn("THREE.DHFBXLoader: Unknown camera type "+a+"."),i=new Et}}return i},createLight:function(t){var i,n;if(t.children.forEach((function(t){var i=e.Objects.NodeAttribute[t.ID];void 0!==i&&(n=i)})),void 0===n)i=new Et;else{var a;a=void 0===n.LightType?0:n.LightType.value;var r=16777215;void 0!==n.Color&&(r=(new Qt).fromArray(n.Color.value));var s=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(s=0);var o=0;void 0!==n.FarAttenuationEnd&&(o=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);switch(a){case 0:i=new Fl(r,s,o,1);break;case 1:i=new Gl(r,s);break;case 2:var l=Math.PI/3;void 0!==n.InnerAngle&&(l=ge.degToRad(n.InnerAngle.value));var c=0;void 0!==n.OuterAngle&&(c=ge.degToRad(n.OuterAngle.value),c=Math.max(c,1)),i=new kl(r,s,o,l,c,1);break;default:console.warn("THREE.DHFBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),i=new Fl(r,s)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(i.castShadow=!0)}return i},createMesh:function(e,t,i){var n,a=null,r=null,s=[];return e.children.forEach((function(e){t.has(e.ID)&&(a=t.get(e.ID)),i.has(e.ID)&&s.push(i.get(e.ID))})),s.length>1?r=s:s.length>0?r=s[0]:(r=new To({color:13421772}),s.push(r)),"color"in a.attributes&&s.forEach((function(e){e.vertexColors=!0})),a.FBX_Deformer?(s.forEach((function(e){e.skinning=!0})),(n=new Hr(a,r)).normalizeSkinWeights()):n=new Fi(a,r),n},createCurve:function(e,t){return new as(e.children.reduce((function(e,i){return t.has(i.ID)&&(e=t.get(i.ID)),e}),null),new Kr({color:3342591,linewidth:1}))},getTransformData:function(e,t){var i={};"InheritType"in t&&(i.inheritType=parseInt(t.InheritType.value)),i.eulerOrder="RotationOrder"in t?w(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(i.translation=t.Lcl_Translation.value),"PreRotation"in t&&(i.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(i.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(i.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(i.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(i.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(i.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(i.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(i.rotationPivot=t.RotationPivot.value),e.userData.transformData=i},setLookAtProperties:function(n,a){"LookAtProperty"in a&&t.get(n.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){var a=e.Objects.Model[t.ID];if("Lcl_Translation"in a){var r=a.Lcl_Translation.value;void 0!==n.target?(n.target.position.fromArray(r),i.add(n.target)):n.lookAt((new Ce).fromArray(r))}}}))},bindSkeleton:function(e,i,n){var a=this.parsePoseNodes();for(var r in e){var s=e[r];t.get(parseInt(s.ID)).parents.forEach((function(e){if(i.has(e.ID)){var r=e.ID;t.get(r).parents.forEach((function(e){n.has(e.ID)&&n.get(e.ID).bind(new Yr(s.bones),a[e.ID])}))}}))}},parsePoseNodes:function(){var t={};if("Pose"in e.Objects){var i=e.Objects.Pose;for(var n in i)if("BindPose"===i[n].attrType){var a=i[n].PoseNode;Array.isArray(a)?a.forEach((function(e){t[e.Node]=(new it).fromArray(e.Matrix.a)})):t[a.Node]=(new it).fromArray(a.Matrix.a)}}return t},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var t=e.GlobalSettings.AmbientColor.value,n=t[0],a=t[1],r=t[2];if(0!==n||0!==a||0!==r){var s=new Qt(n,a,r);i.add(new Vl(s,1))}}},setupMorphMaterials:function(){var e=this;i.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(i,n){e.setupMorphMaterial(t,i,n)})):e.setupMorphMaterial(t,t.material))}))},setupMorphMaterial:function(e,t,n){var a=e.uuid,r=t.uuid,s=!1;if(i.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===r&&e.uuid!==a&&(s=!0)})):e.material.uuid===r&&e.uuid!==a&&(s=!0))})),!0===s){var o=t.clone();o.morphTargets=!0,void 0===n?e.material=o:e.material[n]=o}else t.morphTargets=!0}},s.prototype={constructor:s,parse:function(i){var n=new Map;if("Geometry"in e.Objects){var a=e.Objects.Geometry;for(var r in a){var s=t.get(parseInt(r)),o=this.parseGeometry(s,a[r],i);n.set(parseInt(r),o)}}return n},parseGeometry:function(e,t,i){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,i);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(t,i,n){var a=n.skeletons,r=[],s=t.parents.map((function(t){return e.Objects.Model[t.ID]}));if(0!==s.length){var o=t.children.reduce((function(e,t){return void 0!==a[t.ID]&&(e=a[t.ID]),e}),null);t.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&r.push(n.morphTargets[e.ID])}));var l=s[0],c={};"RotationOrder"in l&&(c.eulerOrder=w(l.RotationOrder.value)),"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(c.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(c.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(c.scale=l.GeometricScaling.value);var h=x(c);return this.genGeometry(i,o,r,h)}},genGeometry:function(e,t,i,n){var a=new wi;e.attrName&&(a.name=e.attrName);var r=this.parseGeoNode(e,t),s=this.genBuffers(r),o=new hi(s.vertex,3);if(o.applyMatrix4(n),a.setAttribute("position",o),s.colors.length>0&&a.setAttribute("color",new hi(s.colors,3)),t&&(a.setAttribute("skinIndex",new si(s.weightsIndices,4)),a.setAttribute("skinWeight",new hi(s.vertexWeights,4)),a.FBX_Deformer=t),s.normal.length>0){var l=(new ve).getNormalMatrix(n),c=new hi(s.normal,3);c.applyNormalMatrix(l),a.setAttribute("normal",c)}if(s.uvs.forEach((function(e,t){var i="uv"+(t+1).toString();0===t&&(i="uv"),a.setAttribute(i,new hi(s.uvs[t],2))})),r.material&&"AllSame"!==r.material.mappingType){var h=s.materialIndex[0],u=0;if(s.materialIndex.forEach((function(e,t){e!==h&&(a.addGroup(u,t-u,h),h=e,u=t)})),a.groups.length>0){var d=a.groups[a.groups.length-1],p=d.start+d.count;p!==s.materialIndex.length&&a.addGroup(p,s.materialIndex.length-p,h)}0===a.groups.length&&a.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return this.addMorphTargets(a,e,i,n),a},parseGeoNode:function(e,t){var i={};if(i.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],i.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(i.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(i.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(i.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){i.uv=[];for(var n=0;e.LayerElementUV[n];)e.LayerElementUV[n].UV&&i.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return i.weightTable={},null!==t&&(i.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(n,a){void 0===i.weightTable[n]&&(i.weightTable[n]=[]),i.weightTable[n].push({id:t,weight:e.weights[a]})}))}))),i},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},i=0,n=0,a=!1,r=[],s=[],o=[],l=[],c=[],h=[],u=this;return e.vertexIndices.forEach((function(d,p){var m=!1;d<0&&(d^=-1,m=!0);var f=[],g=[];if(r.push(3*d,3*d+1,3*d+2),e.color){var y=v(p,i,d,e.color);o.push(y[0],y[1],y[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){g.push(e.weight),f.push(e.id)})),g.length>4){a||(console.warn("THREE.DHFBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);var b=[0,0,0,0],_=[0,0,0,0];g.forEach((function(e,t){var i=e,n=f[t];_.forEach((function(e,t,a){if(i>e){a[t]=i,i=e;var r=b[t];b[t]=n,n=r}}))})),f=b,g=_}for(;g.length<4;)g.push(0),f.push(0);for(var x=0;x<4;++x)c.push(g[x]),h.push(f[x])}if(e.normal){y=v(p,i,d,e.normal);s.push(y[0],y[1],y[2])}if(e.material&&"AllSame"!==e.material.mappingType)var w=v(p,i,d,e.material)[0];e.uv&&e.uv.forEach((function(e,t){var n=v(p,i,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(n[0]),l[t].push(n[1])})),n++,m&&(u.genFace(t,e,r,w,s,o,l,c,h,n),i++,n=0,r=[],s=[],o=[],l=[],c=[],h=[])})),t},genFace:function(e,t,i,n,a,r,s,o,l,c){for(var h=2;h<c;h++)e.vertex.push(t.vertexPositions[i[0]]),e.vertex.push(t.vertexPositions[i[1]]),e.vertex.push(t.vertexPositions[i[2]]),e.vertex.push(t.vertexPositions[i[3*(h-1)]]),e.vertex.push(t.vertexPositions[i[3*(h-1)+1]]),e.vertex.push(t.vertexPositions[i[3*(h-1)+2]]),e.vertex.push(t.vertexPositions[i[3*h]]),e.vertex.push(t.vertexPositions[i[3*h+1]]),e.vertex.push(t.vertexPositions[i[3*h+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[4*(h-1)]),e.vertexWeights.push(o[4*(h-1)+1]),e.vertexWeights.push(o[4*(h-1)+2]),e.vertexWeights.push(o[4*(h-1)+3]),e.vertexWeights.push(o[4*h]),e.vertexWeights.push(o[4*h+1]),e.vertexWeights.push(o[4*h+2]),e.vertexWeights.push(o[4*h+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(h-1)]),e.weightsIndices.push(l[4*(h-1)+1]),e.weightsIndices.push(l[4*(h-1)+2]),e.weightsIndices.push(l[4*(h-1)+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3])),t.color&&(e.colors.push(r[0]),e.colors.push(r[1]),e.colors.push(r[2]),e.colors.push(r[3*(h-1)]),e.colors.push(r[3*(h-1)+1]),e.colors.push(r[3*(h-1)+2]),e.colors.push(r[3*h]),e.colors.push(r[3*h+1]),e.colors.push(r[3*h+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(a[0]),e.normal.push(a[1]),e.normal.push(a[2]),e.normal.push(a[3*(h-1)]),e.normal.push(a[3*(h-1)+1]),e.normal.push(a[3*(h-1)+2]),e.normal.push(a[3*h]),e.normal.push(a[3*h+1]),e.normal.push(a[3*h+2])),t.uv&&t.uv.forEach((function(t,i){void 0===e.uvs[i]&&(e.uvs[i]=[]),e.uvs[i].push(s[i][0]),e.uvs[i].push(s[i][1]),e.uvs[i].push(s[i][2*(h-1)]),e.uvs[i].push(s[i][2*(h-1)+1]),e.uvs[i].push(s[i][2*h]),e.uvs[i].push(s[i][2*h+1])}))},addMorphTargets:function(t,i,n,a){if(0!==n.length){t.morphTargetsRelative=!0,t.morphAttributes.position=[];var r=this;n.forEach((function(n){n.rawTargets.forEach((function(n){var s=e.Objects.Geometry[n.geoID];void 0!==s&&r.genMorphGeometry(t,i,s,a,n.name)}))}))}},genMorphGeometry:function(e,t,i,n,a){for(var r=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],s=void 0!==i.Vertices?i.Vertices.a:[],o=void 0!==i.Indexes?i.Indexes.a:[],l=3*e.attributes.position.count,c=new Float32Array(l),h=0;h<o.length;h++){var u=3*o[h];c[u]=s[3*h],c[u+1]=s[3*h+1],c[u+2]=s[3*h+2]}var d={vertexIndices:r,vertexPositions:c},p=new hi(this.genBuffers(d).vertex,3);p.name=a||i.attrName,p.applyMatrix4(n),e.morphAttributes.position.push(p)},parseNormals:function(e){var t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Normals.a,a=[];return"IndexToDirect"===i&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:a,mappingType:t,referenceType:i}},parseUVs:function(e){var t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.UV.a,a=[];return"IndexToDirect"===i&&(a=e.UVIndex.a),{dataSize:2,buffer:n,indices:a,mappingType:t,referenceType:i}},parseVertexColors:function(e){var t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Colors.a,a=[];return"IndexToDirect"===i&&(a=e.ColorIndex.a),{dataSize:4,buffer:n,indices:a,mappingType:t,referenceType:i}},parseMaterialIndices:function(e){var t=e.MappingInformationType,i=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};for(var n=e.Materials.a,a=[],r=0;r<n.length;++r)a.push(r);return{dataSize:1,buffer:n,indices:a,mappingType:t,referenceType:i}},parseNurbsGeometry:function(e){if(void 0===RT)return console.error("THREE.DHFBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new wi;var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.DHFBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new wi;for(var i,n,a=t-1,r=e.KnotVector.a,s=[],o=e.Points.a,l=0,c=o.length;l<c;l+=4)s.push((new Me).fromArray(o,l));if("Closed"===e.Form)s.push(s[0]);else if("Periodic"===e.Form){i=a,n=r.length-1-i;for(l=0;l<a;++l)s.push(s[l])}var h=new RT(a,r,s,i,n).getPoints(7*s.length),u=new Float32Array(3*h.length);h.forEach((function(e,t){e.toArray(u,3*t)}));var d=new wi;return d.setAttribute("position",new ti(u,3)),d}},o.prototype={constructor:o,parse:function(){var e=[],t=this.parseClips();if(void 0!==t)for(var i in t){var n=t[i],a=this.addClip(n);e.push(a)}return e},parseClips:function(){if(void 0!==e.Objects.AnimationCurve){var t=this.parseAnimationCurveNodes();this.parseAnimationCurves(t);var i=this.parseAnimationLayers(t);return this.parseAnimStacks(i)}},parseAnimationCurveNodes:function(){var t=e.Objects.AnimationCurveNode,i=new Map;for(var n in t){var a=t[n];if(null!==a.attrName.match(/S|R|T|DeformPercent/)){var r={id:a.id,attr:a.attrName,curves:{}};i.set(r.id,r)}}return i},parseAnimationCurves:function(i){var n=e.Objects.AnimationCurve;for(var a in n){var r={id:n[a].id,times:n[a].KeyTime.a.map(g),values:n[a].KeyValueFloat.a},s=t.get(r.id);if(void 0!==s){var o=s.parents[0].ID,l=s.parents[0].relationship;l.match(/X/)?i.get(o).curves.x=r:l.match(/Y/)?i.get(o).curves.y=r:l.match(/Z/)?i.get(o).curves.z=r:l.match(/d|DeformPercent/)&&i.has(o)&&(i.get(o).curves.morph=r)}}},parseAnimationLayers:function(n){var a=e.Objects.AnimationLayer,r=new Map;for(var s in a){var o=[],l=t.get(parseInt(s));if(void 0!==l)l.children.forEach((function(a,r){if(n.has(a.ID)){var s=n.get(a.ID);if(void 0!==s.curves.x||void 0!==s.curves.y||void 0!==s.curves.z){if(void 0===o[r])if(void 0!==(p=t.get(a.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID)){if(void 0===(c=e.Objects.Model[p.toString()]))return void console.warn("THREE.DHFBXLoader: Encountered a unused curve.",a);var l={modelName:c.attrName?Bc.sanitizeNodeName(c.attrName):"",ID:c.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};i.traverse((function(e){e.ID===c.id&&(l.transform=e.matrix,e.userData.transformData&&(l.eulerOrder=e.userData.transformData.eulerOrder))})),l.transform||(l.transform=new it),"PreRotation"in c&&(l.preRotation=c.PreRotation.value),"PostRotation"in c&&(l.postRotation=c.PostRotation.value),o[r]=l}o[r]&&(o[r][s.attr]=s)}else if(void 0!==s.curves.morph){if(void 0===o[r]){var c,h=t.get(a.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,u=t.get(h).parents[0].ID,d=t.get(u).parents[0].ID,p=t.get(d).parents[0].ID;l={modelName:(c=e.Objects.Model[p]).attrName?Bc.sanitizeNodeName(c.attrName):"",morphName:e.Objects.Deformer[h].attrName};o[r]=l}o[r][s.attr]=s}}})),r.set(parseInt(s),o)}return r},parseAnimStacks:function(i){var n=e.Objects.AnimationStack,a={};for(var r in n){var s=t.get(parseInt(r)).children;s.length>1&&console.warn("THREE.DHFBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var o=i.get(s[0].ID);a[r]={name:n[r].attrName,layer:o}}return a},addClip:function(e){var t=[],i=this;return e.layer.forEach((function(e){t=t.concat(i.generateTracks(e))})),new Wo(e.name,-1,t)},generateTracks:function(e){var t=[],i=new Ce,n=new Ee,a=new Ce;if(e.transform&&e.transform.decompose(i,n,a),i=i.toArray(),n=(new dt).setFromQuaternion(n,e.eulerOrder).toArray(),a=a.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){var r=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");void 0!==r&&t.push(r)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){var s=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);void 0!==s&&t.push(s)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){var o=this.generateVectorTrack(e.modelName,e.S.curves,a,"scale");void 0!==o&&t.push(o)}if(void 0!==e.DeformPercent){var l=this.generateMorphTrack(e);void 0!==l&&t.push(l)}return t},generateVectorTrack:function(e,t,i,n){var a=this.getTimesForAllAxes(t),r=this.getKeyframeTrackValues(a,t,i);return new Vo(e+"."+n,a,r)},generateRotationTrack:function(e,t,i,n,a,r){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(ge.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(ge.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(ge.degToRad));var s=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(s,t,i);void 0!==n&&((n=n.map(ge.degToRad)).push(r),n=(new dt).fromArray(n),n=(new Ee).setFromEuler(n)),void 0!==a&&((a=a.map(ge.degToRad)).push(r),a=(new dt).fromArray(a),a=(new Ee).setFromEuler(a).invert());for(var l=new Ee,c=new dt,h=[],u=0;u<o.length;u+=3)c.set(o[u],o[u+1],o[u+2],r),l.setFromEuler(c),void 0!==n&&l.premultiply(n),void 0!==a&&l.multiply(a),l.toArray(h,u/3*4);return new Ho(e+".quaternion",s,h)},generateMorphTrack:function(e){var t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),a=i.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Fo(e.modelName+".morphTargetInfluences["+a+"]",t.times,n)},getTimesForAllAxes:function(e){var t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),(t=t.sort((function(e,t){return e-t}))).length>1){for(var i=1,n=t[0],a=1;a<t.length;a++){var r=t[a];r!==n&&(t[i]=r,n=r,i++)}t=t.slice(0,i)}return t},getKeyframeTrackValues:function(e,t,i){var n=i,a=[],r=-1,s=-1,o=-1;return e.forEach((function(e){if(t.x&&(r=t.x.times.indexOf(e)),t.y&&(s=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==r){var i=t.x.values[r];a.push(i),n[0]=i}else a.push(n[0]);if(-1!==s){var l=t.y.values[s];a.push(l),n[1]=l}else a.push(n[1]);if(-1!==o){var c=t.z.values[o];a.push(c),n[2]=c}else a.push(n[2])})),a},interpolateRotations:function(e){for(var t=1;t<e.values.length;t++){var i=e.values[t-1],n=e.values[t]-i,a=Math.abs(n);if(a>=180){for(var r=a/180,s=n/r,o=i+s,l=e.times[t-1],c=(e.times[t]-l)/r,h=l+c,u=[],d=[];h<e.times[t];)u.push(h),h+=c,d.push(o),o+=s;e.times=T(e.times,t,u),e.values=T(e.values,t,d)}}}},c.prototype={constructor:c,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new p,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=this,i=e.split(/[\r\n]+/);return i.forEach((function(e,n){var a=e.match(/^[\s\t]*;/),r=e.match(/^[\s\t]*$/);if(!a&&!r){var s=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");s?t.parseNodeBegin(e,s):o?t.parseNodeProperty(e,o,i[++n]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}})),this.allNodes},parseNodeBegin:function(e,t){var i=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),a={name:i},r=this.parseNodeAttr(n),s=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(i,a):i in s?("PoseNode"===i?s.PoseNode.push(a):void 0!==s[i].id&&(s[i]={},s[i][s[i].id]=s[i]),""!==r.id&&(s[i][r.id]=a)):"number"==typeof r.id?(s[i]={},s[i][r.id]=a):"Properties70"!==i&&(s[i]="PoseNode"===i?[a]:a),"number"==typeof r.id&&(a.id=r.id),""!==r.name&&(a.attrName=r.name),""!==r.type&&(a.attrType=r.type),this.pushStack(a)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var i="",n="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:i,type:n}},parseNodeProperty:function(e,t,i){var n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===n&&","===a&&(a=i.replace(/"/g,"").replace(/,$/,"").trim());var r=this.getCurrentNode();if("Properties70"!==r.name){if("C"===n){var s=a.split(",").slice(1),o=parseInt(s[0]),l=parseInt(s[1]),c=a.split(",").slice(3);n="connections",function(e,t){for(var i=0,n=e.length,a=t.length;i<a;i++,n++)e[n]=t[i]}(a=[o,l],c=c.map((function(e){return e.trim().replace(/^"/,"")}))),void 0===r[n]&&(r[n]=[])}"Node"===n&&(r.id=a),n in r&&Array.isArray(r[n])?r[n].push(a):"a"!==n?r[n]=a:r.a=a,this.setCurrentProp(r,n),"a"===n&&","!==a.slice(-1)&&(r.a=S(a))}else this.parseNodeSpecialProperty(e,n,a)},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=S(t.a))},parseNodeSpecialProperty:function(e,t,i){var n=i.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),a=n[0],r=n[1],s=n[2],o=n[3],l=n[4];switch(r){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=S(l)}this.getPrevNode()[a]={type:r,type2:s,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),a)}},h.prototype={constructor:h,parse:function(e){var t=new u(e);t.skip(23);var i=t.getUint32();if(i<6400)throw new Error("THREE.DHFBXLoader: FBX version not supported, FileVersion: "+i);for(var n=new p;!this.endOfContent(t);){var a=this.parseNode(t,i);null!==a&&n.add(a.name,a)}return n},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var i={},n=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();var r=e.getUint8(),s=e.getString(r);if(0===n)return null;for(var o=[],l=0;l<a;l++)o.push(this.parseProperty(e));var c=o.length>0?o[0]:"",h=o.length>1?o[1]:"",u=o.length>2?o[2]:"";for(i.singleProperty=1===a&&e.getOffset()===n;n>e.getOffset();){var d=this.parseNode(e,t);null!==d&&this.parseSubNode(s,i,d)}return i.propertyList=o,"number"==typeof c&&(i.id=c),""!==h&&(i.attrName=h),""!==u&&(i.attrType=u),""!==s&&(i.name=s),i},parseSubNode:function(e,t,i){if(!0===i.singleProperty){var n=i.propertyList[0];Array.isArray(n)?(t[i.name]=i,i.a=n):t[i.name]=n}else if("Connections"===e&&"C"===i.name){var a=[];i.propertyList.forEach((function(e,t){0!==t&&a.push(e)})),void 0===t.connections&&(t.connections=[]),t.connections.push(a)}else if("Properties70"===i.name){Object.keys(i).forEach((function(e){t[e]=i[e]}))}else if("Properties70"===e&&"P"===i.name){var r,s=i.propertyList[0],o=i.propertyList[1],l=i.propertyList[2],c=i.propertyList[3];0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),0===o.indexOf("Lcl ")&&(o=o.replace("Lcl ","Lcl_")),r="Color"===o||"ColorRGB"===o||"Vector"===o||"Vector3D"===o||0===o.indexOf("Lcl_")?[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:i.propertyList[4],t[s]={type:o,type2:l,flag:c,value:r}}else void 0===t[i.name]?"number"==typeof i.id?(t[i.name]={},t[i.name][i.id]=i):t[i.name]=i:"PoseNode"===i.name?(Array.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i)):void 0===t[i.name][i.id]&&(t[i.name][i.id]=i)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var i=e.getUint32();return e.getArrayBuffer(i);case"S":i=e.getUint32();return e.getString(i);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),a=e.getUint32(),r=e.getUint32();if(0===a)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}void 0===IT&&console.error("THREE.DHFBXLoader: External library fflate.min.js required.");var s=new u(iT(new Uint8Array(e.getArrayBuffer(r))).buffer);switch(t){case"b":case"c":return s.getBooleanArray(n);case"d":return s.getFloat64Array(n);case"f":return s.getFloat32Array(n);case"i":return s.getInt32Array(n);case"l":return s.getInt64Array(n)}default:throw new Error("THREE.DHFBXLoader: Unknown property type "+t)}}},u.prototype={constructor:u,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var t=[],i=0;i<e;i++)t[i]=this.getUint8();var n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),ql.decodeText(new Uint8Array(t))}},p.prototype={constructor:p,add:function(e,t){this[e]=t}};var y=[];function v(e,t,i,n){var a;switch(n.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=i;break;case"AllSame":a=n.indices[0];break;default:console.warn("THREE.DHFBXLoader: unknown attribute mapping type "+n.mappingType)}"IndexToDirect"===n.referenceType&&(a=n.indices[a]);var r=a*n.dataSize,s=r+n.dataSize;return function(e,t,i,n){for(var a=i,r=0;a<n;a++,r++)e[r]=t[a];return e}(y,n.buffer,r,s)}var b=new dt,_=new Ce;function x(e){var t,i=new it,n=new it,a=new it,r=new it,s=new it,o=new it,l=new it,c=new it,h=new it,u=new it,d=new it,p=new it,m=e.inheritType?e.inheritType:0;(e.translation&&i.setPosition(_.fromArray(e.translation)),e.preRotation)&&((t=e.preRotation.map(ge.degToRad)).push(e.eulerOrder),n.makeRotationFromEuler(b.fromArray(t)));e.rotation&&((t=e.rotation.map(ge.degToRad)).push(e.eulerOrder),a.makeRotationFromEuler(b.fromArray(t)));e.postRotation&&((t=e.postRotation.map(ge.degToRad)).push(e.eulerOrder),r.makeRotationFromEuler(b.fromArray(t)),r.invert());e.scale&&s.scale(_.fromArray(e.scale)),e.scalingOffset&&l.setPosition(_.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(_.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(_.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(_.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));var f=(new it).copy(n).multiply(a).multiply(r),g=new it;g.extractRotation(u);var y=new it;y.copyPosition(u);var v=new it,x=(new it).copy(y).invert().multiply(u);v.copy(g).invert().multiply(x);var w=s,S=new it;if(0===m)S.copy(g).multiply(f).multiply(v).multiply(w);else if(1===m)S.copy(g).multiply(v).multiply(f).multiply(w);else{var M=(new it).scale((new Ce).setFromMatrixScale(d)),T=(new it).copy(M).invert(),A=(new it).copy(v).multiply(T);S.copy(g).multiply(f).multiply(A).multiply(w)}var E=new it;E.copy(h).invert();var C=new it;C.copy(o).invert();var I=new it;I.copy(i).multiply(c).multiply(h).multiply(n).multiply(a).multiply(r).multiply(E).multiply(l).multiply(o).multiply(s).multiply(C);var P=(new it).copyPosition(I),R=(new it).copy(u).multiply(P);return p.copyPosition(R),(I=(new it).copy(p).multiply(S)).premultiply(u.invert()),I}function w(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.DHFBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function S(e){return e.split(",").map((function(e){return parseFloat(e)}))}function M(e,t,i){return void 0===t&&(t=0),void 0===i&&(i=e.byteLength),ql.decodeText(new Uint8Array(e,t,i))}function T(e,t,i){return e.slice(0,t).concat(i).concat(e.slice(t))}return n}(),DT=function(){function e(e){Qo.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.dbPromise=hS(Ly,1,{upgrade(e,t,i,n){e.createObjectStore(ky)},blocked(){logger.warn("indexeddb request blocked.")},blocking(){logger.warn("indexeddb blocking another request.")},terminated(){logger.warn("indexeddb request terminated.")}}),this.register((function(e){return new r(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new s(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new c(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(Qo.prototype),{constructor:e,load:function(e,t,i,n,a,r){var s,o=this;o.secretKey=r,s=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:ql.extractUrlBase(e),this.manager.itemStart(e);var l=function(t){n?n(t):logger.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},c=new $o(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials);let h=[];for(let e in this.requestHeader)h.push({key:e,value:this.requestHeader[e]});let u=fy(e);o.secretKey=o.secretKey,this.dbPromise.then((n=>{n.getAllKeys(ky).then((a=>{c.load(e,(function(i){try{o.parse(i,s,(function(i){t(i),o.manager.itemEnd(e)}),l),n.put(ky,i,`${u}:tgpw`).then((()=>{logger.debug("db.put(CONST.INDEXED_DB_OBJECT_STORE, data, `${urlKey}:tgpw`)")}))}catch(e){l(e)}}),i,l)}))}))},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.DHLoaderTGPW: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,r){var s,o={},l={};let c,u;if("string"==typeof e)s=e;else{const t=e,n=new DataView(e),a=Number(n.getBigInt64(0,!0)),l=Number(n.getBigInt64(8,!0)),d=t.slice(a,l);let p="";const m=new Uint8Array(d),f=m.length;for(let e=0;e<f;e++)p+=String.fromCharCode(m[e]);p.length>0&&(c="data:;base64,"+window.btoa(p));const g=t.slice(l,t.byteLength);u=String.fromCharCode.apply(null,new Uint16Array(g)),u=JSON.parse(u),e=t.slice(16,a);let y=new Uint8Array(e,0,Ny.length);if(y[0]===Ny[0]&&y[Ny.length-1]===Ny[Ny.length-1]){e=e.slice(Ny.length,e.byteLength);let t=new Uint8Array(e),i=5;for(let e=0;e<t.length;e++)t[e]=t[e]<<3|t[e]>>i}if(y[0]===By[0]&&y[By.length-1]===By[By.length-1]){if("string"!=typeof this.secretKey)return;if(this.secretKey.length<8||this.secretKey.length>128)return;const t=[];for(let e=0;e<this.secretKey.length;e++)t.push(this.secretKey.charCodeAt(e));e=e.slice(By.length,e.byteLength);let i,n,a=new Uint8Array(e);for(let e=0;e<a.length;e++)i=t[e%t.length]%8,n=8-i,a[e]=a[e]<<i|a[e]>>n;this.secretKey=""}if(ql.decodeText(new Uint8Array(e,0,4))===h){try{o[i.KHR_BINARY_GLTF]=new w(e)}catch(e){return void(r&&r(e))}s=o[i.KHR_BINARY_GLTF].content}else s=ql.decodeText(new Uint8Array(e))}var d=JSON.parse(s);if(void 0===d.asset||d.asset.version[0]<2)r&&r(new Error("THREE.DHLoaderTGPW: Unsupported asset. glTF versions >=2.0 are supported."));else{var p=new ee(d,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});p.fileLoader.setRequestHeader(this.requestHeader);for(var m=0;m<this.pluginCallbacks.length;m++){var f=this.pluginCallbacks[m](p);l[f.name]=f,o[f.name]=!0}if(d.extensionsUsed)for(m=0;m<d.extensionsUsed.length;++m){var g=d.extensionsUsed[m],y=d.extensionsRequired||[];switch(g){case i.KHR_MATERIALS_UNLIT:o[g]=new a;break;case i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[g]=new A;break;case i.KHR_DRACO_MESH_COMPRESSION:o[g]=new S(d,this.dracoLoader);break;case i.KHR_TEXTURE_TRANSFORM:o[g]=new M;break;case i.KHR_MESH_QUANTIZATION:o[g]=new E;break;default:y.indexOf(g)>=0&&void 0===l[g]&&logger.warn('THREE.DHLoaderTGPW: Unknown extension "'+g+'".')}}p.setExtensions(o),p.setPlugins(l),p.parse((e=>{e.icon=c,e.setting=u,n&&n(e)}),r)}}});var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=i.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function a(){this.name=i.KHR_MATERIALS_UNLIT}function r(e){this.parser=e,this.name=i.KHR_MATERIALS_CLEARCOAT}function s(e){this.parser=e,this.name=i.KHR_MATERIALS_TRANSMISSION}function o(e){this.parser=e,this.name=i.KHR_TEXTURE_BASISU}function l(e){this.parser=e,this.name=i.EXT_TEXTURE_WEBP,this.isSupported=null}function c(e){this.name=i.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],i=0,n=t.length;i<n;i++){var a=t[i];a.extensions&&a.extensions[this.name]&&void 0!==a.extensions[this.name].light&&e._addNodeRef(this.cache,a.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,i="light:"+e,n=t.cache.get(i);if(n)return n;var a,r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e],o=new Qt(16777215);void 0!==s.color&&o.fromArray(s.color);var l=void 0!==s.range?s.range:0;switch(s.type){case"directional":(a=new Gl(o)).target.position.set(0,0,-1),a.add(a.target);break;case"point":(a=new Fl(o)).distance=l;break;case"spot":(a=new kl(o)).distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.DHLoaderTGPW: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),n=Promise.resolve(a),t.cache.add(i,n),n},n.prototype.createNodeAttachment=function(e){var t=this,i=this.parser,n=i.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return i._getNodeRef(t.cache,a,e)}))},a.prototype.getMaterialType=function(){return Kt},a.prototype.extendParams=function(e,t,i){var n=[];e.color=new Qt(1,1,1),e.opacity=1;var a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){var r=a.baseColorFactor;e.color.fromArray(r),e.opacity=r[3]}void 0!==a.baseColorTexture&&n.push(i.assignTexture(e,"map",a.baseColorTexture))}return Promise.all(n)},r.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},r.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&a.push(i.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&a.push(i.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(a.push(i.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){var s=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ye(s,-s)}return Promise.all(a)},s.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Mo:null},s.prototype.extendMaterialParams=function(e,t){var i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var a=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&a.push(i.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(a)},o.prototype.loadTexture=function(e){var t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;var a=n.extensions[this.name],r=i.images[a.source],s=t.options.ktx2Loader;if(!s){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoaderTGPW: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r,s)},l.prototype.loadTexture=function(e){var t=this.name,i=this.parser,n=i.json,a=n.textures[e];if(!a.extensions||!a.extensions[t])return null;var r=a.extensions[t],s=n.images[r.source],o=i.textureLoader;if(s.uri){var l=i.options.manager.getHandler(s.uri);null!==l&&(o=l)}return this.detectSupport().then((function(a){if(a)return i.loadTextureImage(e,s,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.DHLoaderTGPW: WebP required by asset but unsupported.");return i.loadTexture(e)}))},l.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},c.prototype.loadBufferView=function(e){var t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){var n=i.extensions[this.name],a=this.parser.getDependency("buffer",n.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.DHLoaderTGPW: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([a,r.ready]).then((function(e){var t=n.byteOffset||0,i=n.byteLength||0,a=n.count,s=n.byteStride,o=new ArrayBuffer(a*s),l=new Uint8Array(e[0],t,i);return r.decodeGltfBuffer(new Uint8Array(o),a,s,l,n.mode,n.filter),o}))}return null};var h="glTF",u=1313821514,p=5130562;function w(e){this.name=i.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:ql.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.DHLoaderTGPW: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.DHLoaderTGPW: Legacy binary file detected.");for(var n=this.header.length-12,a=new DataView(e,12),r=0;r<n;){var s=a.getUint32(r,!0);r+=4;var o=a.getUint32(r,!0);if(r+=4,o===u){var l=new Uint8Array(e,12+r,s);this.content=ql.decodeText(l)}else if(o===p){var c=12+r;this.body=e.slice(c,c+s)}r+=s}if(null===this.content)throw new Error("THREE.DHLoaderTGPW: JSON content not found.")}function S(e,t){if(!t)throw new Error("THREE.DHLoaderTGPW: No DRACOLoader instance provided.");this.name=i.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function M(){this.name=i.KHR_TEXTURE_TRANSFORM}function T(e){So.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),a=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),s={specular:{value:(new Qt).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=s,this.onBeforeCompile=function(e){for(var o in s)e.uniforms[o]=s[o];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",a).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return s.specular.value},set:function(e){s.specular.value=e}},specularMap:{get:function(){return s.specularMap.value},set:function(e){s.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return s.glossiness.value},set:function(e){s.glossiness.value=e}},glossinessMap:{get:function(){return s.glossinessMap.value},set:function(e){s.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function A(){return{name:i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return T},extendParams:function(e,t,i){var n=t.extensions[this.name];e.color=new Qt(1,1,1),e.opacity=1;var a=[];if(Array.isArray(n.diffuseFactor)){var r=n.diffuseFactor;e.color.fromArray(r),e.opacity=r[3]}if(void 0!==n.diffuseTexture&&a.push(i.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Qt(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Qt(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var s=n.specularGlossinessTexture;a.push(i.assignTexture(e,"glossinessMap",s)),a.push(i.assignTexture(e,"specularMap",s))}return Promise.all(a)},createMaterial:function(e){var t=new T(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=0,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function E(){this.name=i.KHR_MESH_QUANTIZATION}function I(e,t,i,n){Do.call(this,e,t,i,n)}S.prototype.decodePrimitive=function(e,t){var i=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,s={},o={},l={};for(var c in r){var h=j[c]||c.toLowerCase();s[h]=r[c]}for(c in e.attributes){h=j[c]||c.toLowerCase();if(void 0!==r[c]){var u=i.accessors[e.attributes[c]],d=B[u.componentType];l[h]=d,o[h]=!0===u.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var i in e.attributes){var n=e.attributes[i],a=o[i];void 0!==a&&(n.normalized=a)}t(e)}),s,l)}))}))},M.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&logger.warn('THREE.DHLoaderTGPW: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},T.prototype=Object.create(So.prototype),T.prototype.constructor=T,T.prototype.copy=function(e){return So.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},I.prototype=Object.create(Do.prototype),I.prototype.constructor=I,I.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,a=e*n*3+n,r=0;r!==n;r++)t[r]=i[a+r];return t},I.prototype.beforeStart_=I.prototype.copySampleValue_,I.prototype.afterEnd_=I.prototype.copySampleValue_,I.prototype.interpolate_=function(e,t,i,n){for(var a=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,c=n-t,h=(i-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,y=1-f,v=g-u+h,b=0;b!==s;b++){var _=r[m+b+s],x=r[m+b+o]*c,w=r[p+b+s],S=r[p+b]*c;a[b]=y*_+v*x+f*w+g*S}return a};var P=0,R=1,O=2,D=3,L=4,k=5,N=6,B={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},z={9728:g,9729:b,9984:y,9985:_,9986:v,9987:x},U={33071:m,33648:f,10497:d},F={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},j={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},H={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},G={CUBICSPLINE:void 0,LINEAR:X,STEP:Y},V="OPAQUE",W="MASK",Z="BLEND";function q(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function J(e,t,i){for(var n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function Q(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):logger.warn("THREE.DHLoaderTGPW: Ignoring primitive type .extras, "+t.extras))}function K(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(i=0,n=a.length;i<n;i++)e.morphTargetDictionary[a[i]]=i}else logger.warn("THREE.DHLoaderTGPW: Invalid extras.targetNames length. Ignoring names.")}}function $(e){for(var t="",i=Object.keys(e).sort(),n=0,a=i.length;n<a;n++)t+=i[n]+":"+e[i[n]]+";";return t}function ee(e,i){this.json=e||{},this.extensions={},this.plugins={},this.options=i||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ic(this.options.manager):this.textureLoader=new al(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new $o(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function ie(e,t,i){var n=t.attributes,a=[];function r(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(var s in n){var o=j[s]||s.toLowerCase();o in e.attributes||a.push(r(n[s],o))}if(void 0!==t.indices&&!e.index){var l=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return Q(e,t),function(e,t,i){var n=t.attributes,a=new Re;if(void 0!==n.POSITION){var r=(d=i.json.accessors[n.POSITION]).min,s=d.max;if(void 0!==r&&void 0!==s){a.set(new Ce(r[0],r[1],r[2]),new Ce(s[0],s[1],s[2]));var o=t.targets;if(void 0!==o){for(var l=new Ce,c=new Ce,h=0,u=o.length;h<u;h++){var d,p=o[h];if(void 0!==p.POSITION)r=(d=i.json.accessors[p.POSITION]).min,s=d.max,void 0!==r&&void 0!==s?(c.setX(Math.max(Math.abs(r[0]),Math.abs(s[0]))),c.setY(Math.max(Math.abs(r[1]),Math.abs(s[1]))),c.setZ(Math.max(Math.abs(r[2]),Math.abs(s[2]))),l.max(c)):logger.warn("THREE.DHLoaderTGPW: Missing min/max properties for accessor POSITION.")}a.expandByVector(l)}e.boundingBox=a;var m=new Xe;a.getCenter(m.center),m.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=m}else logger.warn("THREE.DHLoaderTGPW: Missing min/max properties for accessor POSITION.")}}(e,t,i),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,i){for(var n=!1,a=!1,r=0,s=t.length;r<s&&(void 0!==(c=t[r]).POSITION&&(n=!0),void 0!==c.NORMAL&&(a=!0),!n||!a);r++);if(!n&&!a)return Promise.resolve(e);var o=[],l=[];for(r=0,s=t.length;r<s;r++){var c=t[r];if(n){var h=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;o.push(h)}a&&(h=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(h))}return Promise.all([Promise.all(o),Promise.all(l)]).then((function(t){var i=t[0],r=t[1];return n&&(e.morphAttributes.position=i),a&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}function ne(e,t){var i=e.getIndex();if(null===i){var n=[],a=e.getAttribute("position");if(void 0===a)return logger.error("THREE.DHLoaderTGPW.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var r=0;r<a.count;r++)n.push(r);e.setIndex(n),i=e.getIndex()}var s=i.count-2,o=[];if(2===t)for(r=1;r<=s;r++)o.push(i.getX(0)),o.push(i.getX(r)),o.push(i.getX(r+1));else for(r=0;r<s;r++)r%2==0?(o.push(i.getX(r)),o.push(i.getX(r+1)),o.push(i.getX(r+2))):(o.push(i.getX(r+2)),o.push(i.getX(r+1)),o.push(i.getX(r)));o.length/3!==s&&logger.error("THREE.DHLoaderTGPW.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(o),l}return ee.prototype.setExtensions=function(e){this.extensions=e},ee.prototype.setPlugins=function(e){this.plugins=e},ee.prototype.parse=function(e,t){var i=this,n=this.json,a=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){var r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};J(a,r,n),Q(r,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){e(r)}))})).catch(t)},ee.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[],n=0,a=t.length;n<a;n++)for(var r=t[n].joints,s=0,o=r.length;s<o;s++)e[r[s]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var h=e[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(i[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},ee.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},ee.prototype._getNodeRef=function(e,t,i){if(e.refs[t]<=1)return i;var n=i.clone();return n.name+="_instance_"+e.uses[t]++,n},ee.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var i=0;i<t.length;i++){var n=e(t[i]);if(n)return n}},ee.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var i=[],n=0;n<t.length;n++){var a=e(t[n]);a&&i.push(a)}return i},ee.prototype.getDependency=function(e,t){var i=e+":"+t,n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n},ee.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t},ee.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.DHLoaderTGPW: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[i.KHR_BINARY_GLTF].body);var a=this.options;return new Promise((function(e,i){n.load(q(t.uri,a.path),e,void 0,(function(){i(new Error('THREE.DHLoaderTGPW: Failed to load buffer "'+t.uri+'".'))}))}))},ee.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))},ee.prototype.loadAccessor=function(e){var t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var a=[];return void 0!==n.bufferView?a.push(this.getDependency("bufferView",n.bufferView)):a.push(null),void 0!==n.sparse&&(a.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(a).then((function(e){var a,r=e[0],s=F[n.type],o=B[n.componentType],l=o.BYTES_PER_ELEMENT,c=l*s,h=n.byteOffset||0,u=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(u&&u!==c){var p=Math.floor(h/u),m="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count,f=t.cache.get(m);f||(f=new fr(new o(r,p*u,n.count*u/l),u/l),t.cache.add(m,f)),a=new yr(f,s,h%u/l,d)}else a=new ti(null===r?new o(n.count*s):new o(r,h,n.count*s),s,d);if(void 0!==n.sparse){var g=F.SCALAR,y=B[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,_=new y(e[1],v,n.sparse.count*g),x=new o(e[2],b,n.sparse.count*s);null!==r&&(a=new ti(a.array.slice(),a.itemSize,a.normalized));for(var w=0,S=_.length;w<S;w++){var M=_[w];if(a.setX(M,x[w*s]),s>=2&&a.setY(M,x[w*s+1]),s>=3&&a.setZ(M,x[w*s+2]),s>=4&&a.setW(M,x[w*s+3]),s>=5)throw new Error("THREE.DHLoaderTGPW: Unsupported itemSize in sparse BufferAttribute.")}}return a}))},ee.prototype.loadTexture=function(e){var t=this.json,i=this.options,n=t.textures[e],a=t.images[n.source],r=this.textureLoader;if(a.uri){var s=i.manager.getHandler(a.uri);null!==s&&(r=s)}return this.loadTextureImage(e,a,r)},ee.prototype.loadTextureImage=function(e,t,i){var n=this,a=this.json,r=this.options,s=a.textures[e],o=self.URL||self.webkitURL,l=t.uri,c=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)l=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var i=new DataView(e,25,1).getUint8(0,!1);h=6===i||4===i||3===i}c=!0;var n=new Blob([e],{type:t.mimeType});return l=o.createObjectURL(n)}));else if(void 0===t.uri)throw new Error("THREE.DHLoaderTGPW: Image "+e+" is missing URI and bufferView");return Promise.resolve(l).then((function(e){return new Promise((function(t,n){var a=t;!0===i.isImageBitmapLoader&&(a=function(e){t(new vs(e))}),i.load(q(e,r.path),a,void 0,n)}))})).then((function(t){!0===c&&o.revokeObjectURL(l),t.flipY=!1,s.name&&(t.name=s.name),h||(t.format=C);var i=(a.samplers||{})[s.sampler]||{};return t.magFilter=z[i.magFilter]||b,t.minFilter=z[i.minFilter]||x,t.wrapS=U[i.wrapS]||d,t.wrapT=U[i.wrapT]||d,n.associations.set(t,{type:"textures",index:e}),t}))},ee.prototype.assignTexture=function(e,t,n){var a=this;return this.getDependency("texture",n.index).then((function(r){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||logger.warn("THREE.DHLoaderTGPW: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),a.extensions[i.KHR_TEXTURE_TRANSFORM]){var s=void 0!==n.extensions?n.extensions[i.KHR_TEXTURE_TRANSFORM]:void 0;if(s){var o=a.associations.get(r);r=a.extensions[i.KHR_TEXTURE_TRANSFORM].extendTexture(r,s),a.associations.set(r,o)}}e[t]=r}))},ee.prototype.assignFinalMaterial=function(e){var t=e.geometry,i=e.material,n=void 0!==t.attributes.tangent,a=void 0!==t.attributes.color,r=void 0===t.attributes.normal,s=!0===e.isSkinnedMesh,o=Object.keys(t.morphAttributes).length>0,l=o&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+i.uuid,h=this.cache.get(c);h||(h=new cs,Vt.prototype.copy.call(h,i),h.color.copy(i.color),h.map=i.map,h.sizeAttenuation=!1,this.cache.add(c,h)),i=h}else if(e.isLine){c="LineBasicMaterial:"+i.uuid;var u=this.cache.get(c);u||(u=new Kr,Vt.prototype.copy.call(u,i),u.color.copy(i.color),this.cache.add(c,u)),i=u}if(n||a||r||s||o){c="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),s&&(c+="skinning:"),n&&(c+="vertex-tangents:"),a&&(c+="vertex-colors:"),r&&(c+="flat-shading:"),o&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=i.clone(),s&&(d.skinning=!0),a&&(d.vertexColors=!0),r&&(d.flatShading=!0),o&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(i))),i=d}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i},ee.prototype.getMaterialType=function(){return So},ee.prototype.loadMaterial=function(e){var t,n=this,a=this.json,r=this.extensions,s=a.materials[e],o={},l=s.extensions||{},c=[];if(l[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),c.push(h.extendParams(o,s,n))}else if(l[i.KHR_MATERIALS_UNLIT]){var u=r[i.KHR_MATERIALS_UNLIT];t=u.getMaterialType(),c.push(u.extendParams(o,s,n))}else{var d=s.pbrMetallicRoughness||{};if(o.color=new Qt(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;o.color.fromArray(p),o.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(o,"map",d.baseColorTexture)),o.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,o.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===s.doubleSided&&(o.side=2);var m=s.alphaMode||V;return m===Z?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,m===W&&(o.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==Kt&&(c.push(n.assignTexture(o,"normalMap",s.normalTexture)),o.normalScale=new ye(1,-1),void 0!==s.normalTexture.scale&&o.normalScale.set(s.normalTexture.scale,-s.normalTexture.scale)),void 0!==s.occlusionTexture&&t!==Kt&&(c.push(n.assignTexture(o,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(o.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==Kt&&(o.emissive=(new Qt).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&t!==Kt&&c.push(n.assignTexture(o,"emissiveMap",s.emissiveTexture)),Promise.all(c).then((function(){var a;return a=t===T?r[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),s.name&&(a.name=s.name),a.map&&(a.map.encoding=te),a.emissiveMap&&(a.emissiveMap.encoding=te),Q(a,s),n.associations.set(a,{type:"materials",index:e}),s.extensions&&J(r,a,s),a}))},ee.prototype.createUniqueName=function(e){return e},ee.prototype.loadGeometries=function(e){var t=this,n=this.extensions,a=this.primitiveCache;function r(e){return n[i.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return ie(i,e,t)}))}for(var s,o,l=[],c=0,h=e.length;c<h;c++){var u,d=e[c],p=(o=void 0,(o=(s=d).extensions&&s.extensions[i.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+$(o.attributes):s.indices+":"+$(s.attributes)+":"+s.mode),m=a[p];if(m)l.push(m.promise);else u=d.extensions&&d.extensions[i.KHR_DRACO_MESH_COMPRESSION]?r(d):ie(new wi,d,t),a[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},ee.prototype.loadMesh=function(e){for(var t,i=this,n=this.json,a=this.extensions,r=n.meshes[e],s=r.primitives,o=[],l=0,c=s.length;l<c;l++){var h=void 0===s[l].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new So({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:0})),t.DefaultMaterial):this.getDependency("material",s[l].material);o.push(h)}return o.push(i.loadGeometries(s)),Promise.all(o).then((function(t){for(var n=t.slice(0,t.length-1),o=t[t.length-1],l=[],c=0,h=o.length;c<h;c++){var u,d=o[c],p=s[c],m=n[c];if(p.mode===L||p.mode===k||p.mode===N||void 0===p.mode)!0!==(u=!0===r.isSkinnedMesh?new Hr(d,m):new Fi(d,m)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===k?u.geometry=ne(u.geometry,1):p.mode===N&&(u.geometry=ne(u.geometry,2));else if(p.mode===R)u=new os(d,m);else if(p.mode===D)u=new as(d,m);else if(p.mode===O)u=new ls(d,m);else{if(p.mode!==P)throw new Error("THREE.DHLoaderTGPW: Primitive mode unsupported: "+p.mode);u=new ms(d,m)}Object.keys(u.geometry.morphAttributes).length>0&&K(u,r),u.name=i.createUniqueName(r.name||"mesh_"+e),Q(u,r),p.extensions&&J(a,u,p),i.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var f=new sr;for(c=0,h=l.length;c<h;c++)f.add(l[c]);return f}))},ee.prototype.loadCamera=function(e){var t,i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new Zi(ge.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new jl(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Q(t,i),Promise.resolve(t);logger.warn("THREE.DHLoaderTGPW: Missing camera parameters.")},ee.prototype.loadSkin=function(e){var t=this.json.skins[e],i={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return i.inverseBindMatrices=e,i}))},ee.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],i=[],n=[],a=[],r=[],s=[],o=0,l=t.channels.length;o<l;o++){var c=t.channels[o],h=t.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==t.parameters?t.parameters[h.input]:h.input,m=void 0!==t.parameters?t.parameters[h.output]:h.output;i.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),a.push(this.getDependency("accessor",m)),r.push(h),s.push(u)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(a),Promise.all(r),Promise.all(s)]).then((function(i){for(var n=i[0],a=i[1],r=i[2],s=i[3],o=i[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=a[c],p=r[c],m=s[c],f=o[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,H[f.path]){case H.weights:g=Fo;break;case H.rotation:g=Ho;break;case H.position:case H.scale:default:g=Vo}var y=u.name?u.name:u.uuid,v=void 0!==m.interpolation?G[m.interpolation]:X,b=[];H[f.path]===H.weights?u.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&b.push(e.name?e.name:e.uuid)})):b.push(y);var _=p.array;if(p.normalized){var x;if(_.constructor===Int8Array)x=1/127;else if(_.constructor===Uint8Array)x=1/255;else if(_.constructor==Int16Array)x=1/32767;else{if(_.constructor!==Uint16Array)throw new Error("THREE.DHLoaderTGPW: Unsupported output accessor component type.");x=1/65535}for(var w=new Float32Array(_.length),S=0,M=_.length;S<M;S++)w[S]=_[S]*x;_=w}for(S=0,M=b.length;S<M;S++){var T=new g(b[S]+"."+H[f.path],d.array,_,v);"CUBICSPLINE"===m.interpolation&&(T.createInterpolant=function(e){return new I(this.times,this.values,this.getValueSize()/3,e)},T.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(T)}}}var A=t.name?t.name:"animation_"+e;return new Wo(A,void 0,l)}))},ee.prototype.loadNode=function(e){var t,i=this.json,n=this.extensions,a=this,r=i.nodes[e],s=r.name?a.createUniqueName(r.name):"";return(t=[],void 0!==r.mesh&&t.push(a.getDependency("mesh",r.mesh).then((function(e){var t=a._getNodeRef(a.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,i=r.weights.length;t<i;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))),void 0!==r.camera&&t.push(a.getDependency("camera",r.camera).then((function(e){return a._getNodeRef(a.cameraCache,r.camera,e)}))),a._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var i;if((i=!0===r.isBone?new Gr:t.length>1?new sr:1===t.length?t[0]:new Et)!==t[0])for(var o=0,l=t.length;o<l;o++)i.add(t[o]);if(r.name&&(i.userData.name=r.name,i.name=s),Q(i,r),r.extensions&&J(n,i,r),void 0!==r.matrix){var c=new it;c.fromArray(r.matrix),i.applyMatrix4(c)}else void 0!==r.translation&&i.position.fromArray(r.translation),void 0!==r.rotation&&i.quaternion.fromArray(r.rotation),void 0!==r.scale&&i.scale.fromArray(r.scale);return a.associations.set(i,{type:"nodes",index:e}),i}))},ee.prototype.loadScene=function(){function e(t,i,n,a){var r=n.nodes[t];return a.getDependency("node",t).then((function(e){return void 0===r.skin?e:a.getDependency("skin",r.skin).then((function(e){for(var i=[],n=0,r=(t=e).joints.length;n<r;n++)i.push(a.getDependency("node",t.joints[n]));return Promise.all(i)})).then((function(i){return e.traverse((function(e){if(e.isMesh){for(var n=[],a=[],r=0,s=i.length;r<s;r++){var o=i[r];if(o){n.push(o);var l=new it;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*r),a.push(l)}else logger.warn('THREE.DHLoaderTGPW: Joint "%s" could not be found.',t.joints[r])}e.bind(new Yr(n,a),e.matrixWorld)}})),e}));var t})).then((function(t){i.add(t);var s=[];if(r.children)for(var o=r.children,l=0,c=o.length;l<c;l++){var h=o[l];s.push(e(h,t,n,a))}return Promise.all(s)}))}return function(t){var i=this.json,n=this.extensions,a=this.json.scenes[t],r=new sr;a.name&&(r.name=this.createUniqueName(a.name)),Q(r,a),a.extensions&&J(n,r,a);for(var s=a.nodes||[],o=[],l=0,c=s.length;l<c;l++)o.push(e(s[l],r,i,this));return Promise.all(o).then((function(){return r}))}}(),e}(),LT=Ug((function(e){var t,i;t=Bg,i=function(){var e,t={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},i=function(){var e=function(e){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=e.xField||e.defaultXField,this._yField=e.yField||e.defaultYField,this._valueField=e.valueField||e.defaultValueField,e.radius&&(this._cfgRadius=e.radius)},i=t.defaultRadius;return e.prototype={_organiseData:function(e,t){var n=e[this._xField],a=e[this._yField],r=this._radi,s=this._data,o=this._max,l=this._min,c=e[this._valueField]||1,h=e.radius||this._cfgRadius||i;s[n]||(s[n]=[],r[n]=[]),s[n][a]?s[n][a]+=c:(s[n][a]=c,r[n][a]=h);var u=s[n][a];return u>o?(t?this.setDataMax(u):this._max=u,!1):u<l?(t?this.setDataMin(u):this._min=u,!1):{x:n,y:a,value:c,radius:h,min:l,max:o}},_unOrganizeData:function(){var e=[],t=this._data,i=this._radi;for(var n in t)for(var a in t[n])e.push({x:n,y:a,radius:i[n][a],value:t[n][a]});return{min:this._min,max:this._max,data:e}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var e=arguments[0],t=e.length;t--;)this.addData.call(this,e[t]);else{var i=this._organiseData(arguments[0],!0);i&&(0===this._data.length&&(this._min=this._max=i.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[i]}))}return this},setData:function(e){var t=e.data,i=t.length;this._data=[],this._radi=[];for(var n=0;n<i;n++)this._organiseData(t[n],!1);return this._max=e.max,this._min=e.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(e){return this._max=e,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(e){return this._min=e,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(e){this._coordinator=e},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},e}(),n=function(){var e=function(e){var t=e.gradient||e.defaultGradient,i=document.createElement("canvas"),n=i.getContext("2d");i.width=256,i.height=1;var a=n.createLinearGradient(0,0,256,1);for(var r in t)a.addColorStop(r,t[r]);return n.fillStyle=a,n.fillRect(0,0,256,1),n.getImageData(0,0,256,1).data},t=function(e,t){var i=document.createElement("canvas"),n=i.getContext("2d"),a=e,r=e;if(i.width=i.height=2*e,1==t)n.beginPath(),n.arc(a,r,e,0,2*Math.PI,!1),n.fillStyle="rgba(0,0,0,1)",n.fill();else{var s=n.createRadialGradient(a,r,e*t,a,r,e);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=s,n.fillRect(0,0,2*e,2*e)}return i};function i(t){var i=t.container,n=this.shadowCanvas=document.createElement("canvas"),a=this.canvas=t.canvas||document.createElement("canvas");this._renderBoundaries=[1e4,1e4,0,0];var r=getComputedStyle(t.container)||{};a.className="heatmap-canvas",this._width=a.width=n.width=t.width||+r.width.replace(/px/,""),this._height=a.height=n.height=t.height||+r.height.replace(/px/,""),this.shadowCtx=n.getContext("2d"),this.ctx=a.getContext("2d"),a.style.cssText=n.style.cssText="position:absolute;left:0;top:0;",i.style.position="relative",i.appendChild(a),this._palette=e(t),this._templates={},this._setStyles(t)}return i.prototype={renderPartial:function(e){e.data.length>0&&(this._drawAlpha(e),this._colorize())},renderAll:function(e){this._clear(),Object.keys(e.data).length>0&&(this._drawAlpha(function(e){for(var t=[],i=e.min,n=e.max,a=e.radi,r=(e=e.data,Object.keys(e)),s=r.length;s--;)for(var o=r[s],l=Object.keys(e[o]),c=l.length;c--;){var h=l[c],u=e[o][h],d=a[o][h];t.push({x:o,y:h,value:u,radius:d})}return{min:i,max:n,data:t}}(e)),this._colorize())},_updateGradient:function(t){this._palette=e(t)},updateConfig:function(e){e.gradient&&this._updateGradient(e),this._setStyles(e)},setDimensions:function(e,t){this._width=e,this._height=t,this.canvas.width=this.shadowCanvas.width=e,this.canvas.height=this.shadowCanvas.height=t},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(e){this._blur=0==e.blur?0:e.blur||e.defaultBlur,e.backgroundColor&&(this.canvas.style.backgroundColor=e.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=e.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=e.height||this._height,this._opacity=255*(e.opacity||0),this._maxOpacity=255*(e.maxOpacity||e.defaultMaxOpacity),this._minOpacity=255*(e.minOpacity||e.defaultMinOpacity),this._useGradientOpacity=!!e.useGradientOpacity},_drawAlpha:function(e){for(var i=this._min=e.min,n=this._max=e.max,a=(e=e.data||[]).length,r=1-this._blur;a--;){var s,o=e[a],l=o.x,c=o.y,h=o.radius,u=Math.min(o.value,n),d=l-h,p=c-h,m=this.shadowCtx;this._templates[h]?s=this._templates[h]:this._templates[h]=s=t(h,r);var f=(u-i)/(n-i);m.globalAlpha=f<.01?.01:f,m.drawImage(s,d,p),d<this._renderBoundaries[0]&&(this._renderBoundaries[0]=d),p<this._renderBoundaries[1]&&(this._renderBoundaries[1]=p),d+2*h>this._renderBoundaries[2]&&(this._renderBoundaries[2]=d+2*h),p+2*h>this._renderBoundaries[3]&&(this._renderBoundaries[3]=p+2*h)}},_colorize:function(){var e=this._renderBoundaries[0],t=this._renderBoundaries[1],i=this._renderBoundaries[2]-e,n=this._renderBoundaries[3]-t,a=this._width,r=this._height,s=this._opacity,o=this._maxOpacity,l=this._minOpacity,c=this._useGradientOpacity;e<0&&(e=0),t<0&&(t=0),e+i>a&&(i=a-e),t+n>r&&(n=r-t);for(var h=this.shadowCtx.getImageData(e,t,i,n),u=h.data,d=u.length,p=this._palette,m=3;m<d;m+=4){var f,g=u[m],y=4*g;y&&(f=s>0?s:g<o?g<l?l:g:o,u[m-3]=p[y],u[m-2]=p[y+1],u[m-1]=p[y+2],u[m]=c?p[y+3]:f)}this.ctx.putImageData(h,e,t),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(e){var t=this.shadowCtx.getImageData(e.x,e.y,1,1).data[3],i=this._max,n=this._min;return Math.abs(i-n)*(t/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},i}(),a=(e=!1,"canvas2d"===t.defaultRenderer&&(e=n),e),r=function(){for(var e={},t=arguments.length,i=0;i<t;i++){var n=arguments[i];for(var a in n)e[a]=n[a]}return e},s=function(){var e=function(){function e(){this.cStore={}}return e.prototype={on:function(e,t,i){var n=this.cStore;n[e]||(n[e]=[]),n[e].push((function(e){return t.call(i,e)}))},emit:function(e,t){var i=this.cStore;if(i[e])for(var n=i[e].length,a=0;a<n;a++)(0,i[e][a])(t)}},e}(),n=function(e){var t=e._renderer,i=e._coordinator,n=e._store;i.on("renderpartial",t.renderPartial,t),i.on("renderall",t.renderAll,t),i.on("extremachange",(function(t){e._config.onExtremaChange&&e._config.onExtremaChange({min:t.min,max:t.max,gradient:e._config.gradient||e._config.defaultGradient})})),n.setCoordinator(i)};function s(){var s=this._config=r(t,arguments[0]||{});if(this._coordinator=new e,s.plugin){var o=s.plugin;if(!t.plugins[o])throw new Error("Plugin '"+o+"' not found. Maybe it was not registered.");var l=t.plugins[o];this._renderer=new l.renderer(s),this._store=new l.store(s)}else this._renderer=new a(s),this._store=new i(s);n(this)}return s.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(e){return this._config=r(this._config,e),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(e){return this._store.getValueAt?this._store.getValueAt(e):this._renderer.getValueAt?this._renderer.getValueAt(e):null}},s}();return{create:function(e){return new s(e)},register:function(e,i){t.plugins[e]=i}}},e.exports?e.exports=i():t.h337=i()}));class kT{constructor(){var e=[],t=!1;this.add=t=>{e.push(t)},this.findMaterialAnimation=(t,i)=>{let n=e.find((e=>e.material?e.material===t:e._material===t));if(n&&n.type===i)return n},this.findNodeAnimation=(t,i)=>{for(let n=0;n<e.length;n++){if(e[n].animationObject===t&&e[n]&&e[n].type===i)return e[n];const a=e[n];if(a.object&&a.object.name===t&&a.type===i)return a}},this.findInstancedAnimation=(t,i,n)=>{for(let a=0;a<e.length;a++)if(e[a].instancedMesh===t&&e[a]&&e[a].type===n&&e[a]&&e[a].instanceId===i)return e[a]},this.findDrawableAnimation=(t,i)=>{const n=e.filter((e=>e.object===t));for(const e of n)if(e.type===i)return e},this.findLayerAnimation=(t,i)=>{let n=e.find((e=>e.name===t&&e._type===i));if(n)return n},this.findAnimation=(t,i)=>{let n=e.find((e=>i?e.name===t&&e._type===i:e.name===t));if(n)return n},this.findAnimationByPathId=(t,i)=>e.filter((e=>t&&e.pathId===t&&e._type===i)),this.pause=()=>{t=!0},this.remove=t=>{for(let i=e.length-1;i>=0;i--)e[i]===t&&(e[i].dispose(),e[i]=null,e.splice(i,1))},this.resume=()=>{t=!1},this.update=i=>{if(t)return;const n=[],a=[];let r;for(const t of e)if(t.needsRemove)this.remove(t);else{if(t.isCameraFollowingController){r=t;continue}if(t.isDistanceController){n.push(t);continue}a.push(t)}for(const e of n)e.update(i);for(const e of a)e.update(i);r&&r.update(i)},this.addDistance=(e,t,i,n,a)=>{let r=this.findLayerAnimation(e,t.type);r&&(this.remove(r),r=null),r=new t(i,n,e,a),this.add(r)},this.getAnimations=()=>e,this.dispose=()=>{e.forEach((e=>{e.dispose&&e.dispose()})),e=[]}}}class NT{constructor(){this._cache||(this._cache=new Map),this._loadQueue||(this._loadQueue=new Map),this.helper=new BT,this.preloadResourceStore=!0}load({path:e,type:t,secretKey:i,onLoad:n,onProgress:a,onError:r,needExport:s=!1,newImport:o=!1}={}){if(!e||""===e)return;let l,c=e;if(e instanceof Array){let t="";for(let i of e)t+=i;l=fy(t)}else l=fy(e);if(-1!=e.indexOf("[[origin]]")&&(e=e.replace("[[origin]]",Ep.origin)),!this._cache)return;let h=this._cache?this._cache.get(l):null;if(h){if(h.loadState)return h.onLoadList.push(n),void h.onErrorList.push(r);if(o&&(s&&(h.needExport=s,h.refCount+=1),this._cache&&this._cache.set(l,h)),"function"==typeof n){let e=null;e=this.helper.cloneNode(h.resource),n(e),Ep.sceneBufferCacheExpired=!0}else switch(t.toLowerCase()){case"texture":case"cubetexture":return this.helper.cloneNode(h.resource)}}else switch(this._cache&&this._cache.set(l,{loadState:!0,onLoadList:[n],onErrorList:[r]}),t.toLowerCase()){case"avws":Ep.loaders.gltfLoaderAVWS.load(e,(e=>{if("20220602-NEW-AVWS"===e.scene.children[0].userData.dhExtension.VERSION||"20230317-PACK-AVWS"===e.scene.children[0].userData.dhExtension.VERSION){if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let i=this._cache?this._cache.get(l):null,a=i.onLoadList,r=i.size;if(0===e.animations.length){let i=this.helper.autoMerge(e.scene),n=[],a=null,o=null;e.scene.traverse((e=>{if(e.userData&&e.userData.isModelSource&&(o=e),e.userData&&e.userData.needExport){let{type:t,resourcePath:i,needExport:a,refCount:r}=e.userData;this._cache&&this._cache.set(fy(e.userData.resourcePath),{type:t,resourcePath:i,needExport:a,refCount:r,resource:e}),n.push({parent:e.parent,child:e})}e.userData&&e.userData.customTexture&&(a=e)})),n.forEach((e=>{e.parent.remove(e.child)}));let h=[];o&&o.traverse((e=>{e.userData&&e.userData.modelPath&&(this._cache&&this._cache.set(fy(e.userData.modelPath),{type:"glb",resourcePath:e.userData.modelPath,needExport:!1,refCount:1,resource:e}),h.push({parent:e.parent,child:e}))})),h.forEach((e=>{e.parent.remove(e.child)})),a&&(a.traverse((e=>{e.material&&e.material.map&&(Ep.textureStore.add(e.material.map.name||`${e.material.name}#map`,e.material.map),this._cache&&this._cache.set(fy(e.material.map.name),{resource:e.material.map}))})),a.parent.remove(a)),this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:i,size:r})}else{let i=[],n=null,a=null;e.scene.traverse((e=>{if(e.userData&&e.userData.isModelSource&&(a=e),e.userData&&e.userData.needExport){let{type:t,resourcePath:n,needExport:a,refCount:r}=e.userData;this._cache&&this._cache.set(fy(e.userData.resourcePath),{type:t,resourcePath:n,needExport:a,refCount:r,resource:e}),i.push({parent:e.parent,child:e})}e.userData&&e.userData.customTexture&&(n=e)})),i.forEach((e=>{e.parent.remove(e.child)}));let o=[];a&&a.traverse((e=>{e.userData&&e.userData.modelPath&&(this._cache&&this._cache.set(fy(e.userData.modelPath),{type:"glb",resourcePath:e.userData.modelPath,needExport:!1,refCount:1,resource:e}),o.push({parent:e.parent,child:e}))})),o.forEach((e=>{e.parent.remove(e.child)})),n&&(n.traverse((e=>{e.material&&e.material.map&&(Ep.textureStore.add(e.material.map.name||`${e.material.name}#map`,e.material.map),this._cache&&this._cache.set(fy(e.material.map.name),{resource:e.material.map}))})),n.parent.remove(n)),this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:e.scene,size:r})}a instanceof Array?a.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0)}else{if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let i=this._cache?this._cache.get(l):null,a=i.onLoadList,r=i.size;if(0===e.animations.length){let i=[],n=null;e.scene.traverse((e=>{if(e.userData&&e.userData.needExport){let{type:t,resourcePath:n,needExport:a,refCount:r}=e.userData;this._cache&&this._cache.set(fy(e.userData.resourcePath),{type:t,resourcePath:n,needExport:a,refCount:r,resource:e}),i.push({parent:e.parent,child:e})}e.userData&&e.userData.customTexture&&(n=e)})),i.forEach((e=>{e.parent.remove(e.child)})),n&&(n.traverse((e=>{e.material&&e.material.map&&(Ep.textureStore.add(e.material.map.name||`${e.material.name}#map`,e.material.map),this._cache&&this._cache.set(fy(e.material.map.name),{resource:e.material.map}))})),n.parent.remove(n));let a=this.helper.autoMerge(e.scene);this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:a,size:r})}else this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:e.scene,size:r});a instanceof Array?a.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0)}}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(l):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(l,t))}a&&a(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}),i);break;case"glb":case"gltf":Ep.loaders.gltfLoader.load(e,(e=>{if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let i=this._cache?this._cache.get(l):null,a=i.onLoadList,r=i.size;if(0===e.animations.length){let i=this.helper.autoMerge(e.scene);i.needExport=s,this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:i,size:r})}else e.scene.needExport=s,this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:e.scene,size:r});a instanceof Array?a.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0)}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(l):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(l,t))}a&&a(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}));break;case"avwa":Ep.loaders.gltfLoader.load(e,(e=>{if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let i=this._cache?this._cache.get(l):null,a=i.onLoadList,r=i.size,o=null;e.scene.traverse((e=>{if(e.userData&&e.userData.dhAsset&&!o){for(var t in e.userData.dhAsset.materials)"specular"!==e.userData.dhAsset.materials[t].type&&(e.userData.dhAsset.materials[t].side=2);o=e.userData.dhAsset}})),e.scene.needExport=s,this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:2,resource:e.scene,size:r}),a instanceof Array?a.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0)}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(l):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(l,t))}a&&a(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}));break;case"fbx":Ep.loaders.fbxLoader.load(e,(e=>{if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let i=this._cache?this._cache.get(l):null,a=i.onLoadList,r=i.size;if(0===e.animations.length){let i=this.helper.autoMerge(e);i.needExport=s,this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:i,size:r})}else e.scene.needExport=s,this._cache&&this._cache.set(l,{type:t,resourcePath:c,needExport:s,refCount:1,resource:e.scene,size:r});a instanceof Array?a.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this.helper.cloneNode(this._cache?this._cache.get(l).resource:null)),Ep.sceneBufferCacheExpired=!0)}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(l):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(l,t))}a&&a(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}));break;case"texture":return Ep.loaders.textureLoader.load(e,(e=>{if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let t=this._cache?this._cache.get(l):null,i=t.onLoadList,a=t.size;this._cache&&this._cache.set(l,{resource:e,size:a}),i instanceof Array?i.forEach((e=>{e(this._cache?this._cache.get(l).resource:null),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this._cache?this._cache.get(l).resource:null),Ep.sceneBufferCacheExpired=!0)}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(l):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(l,t))}a&&a(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}));case"cubetexture":return Ep.loaders.cubeTextureLoader.load(e,(e=>{if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let t=this._cache?this._cache.get(l):null,i=t.onLoadList,a=t.size;this._cache&&this._cache.set(l,{resource:e,size:a}),i instanceof Array?i.forEach((e=>{e(this._cache?this._cache.get(l).resource:null),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this._cache?this._cache.get(l).resource:null),Ep.sceneBufferCacheExpired=!0)}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(l):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(l,t))}a&&a(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}));case"imagebitmap":return Ep.loaders.imageBitmapLoader.load(e,(e=>{let t=new vs(e);if(this._loadQueue&&this._loadQueue.delete(l),!this._cache)return;let i=(this._cache?this._cache.get(l):null).onLoadList,a=Zo.get(e).size;this._cache&&this._cache.set(l,{resource:t,size:a}),i instanceof Array?i.forEach((e=>{e(this._cache?this._cache.get(l).resource:null),Ep.sceneBufferCacheExpired=!0})):"function"==typeof n&&(n(this._cache?this._cache.get(l).resource:null),Ep.sceneBufferCacheExpired=!0)}),void 0,(e=>{this._loadQueue&&this._loadQueue.delete(l);let t=(this._cache?this._cache.get(l):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):r&&r(e),this._cache&&this._cache.delete(l)}),(e=>{this._loadQueue?this._loadQueue.set(l,e):e.abort()}))}}loadTGPW({path:e,onProgress:t,onLoad:i,onError:n}){const a=fy(e);if(-1!=e.indexOf("[[origin]]")&&(e=e.replace("[[origin]]",Ep.origin)),!this._cache)return;let r=this._cache?this._cache.get(a):null;if(r){if(r.loadState)return r.onLoadList.push(i),void r.onErrorList.push(n);if("function"==typeof i){let e=null;e=this.helper.cloneNode(r.resource),i(e),Ep.sceneBufferCacheExpired=!0}else switch(type.toLowerCase()){case"texture":case"cubetexture":return this.helper.cloneNode(r.resource)}}else this._cache&&this._cache.set(a,{loadState:!0,onLoadList:[i],onErrorList:[n]}),Ep.loaders.gltfLoaderTGPW.load(e,(t=>{if("20220602-NEW-AVWS"===t.scene.children[0].userData.dhExtension.VERSION||"20230317-PACK-AVWS"===t.scene.children[0].userData.dhExtension.VERSION){if(this._loadQueue&&this._loadQueue.delete(a),!this._cache)return;let n=this._cache?this._cache.get(a):null,r=n.onLoadList,s=n.size;if(0===t.animations.length){let i=this.helper.autoMerge(t.scene),n=[],r=null,o=null;t.scene.traverse((e=>{if(e.userData&&e.userData.isModelSource&&(o=e),e.userData&&e.userData.needExport){let{type:t,resourcePath:i,needExport:a,refCount:r}=e.userData;this._cache&&this._cache.set(fy(e.userData.resourcePath),{type:t,resourcePath:i,needExport:a,refCount:r,resource:e}),n.push({parent:e.parent,child:e})}e.userData&&e.userData.customTexture&&(r=e)})),n.forEach((e=>{e.parent.remove(e.child)}));let l=[];o&&o.traverse((e=>{e.userData&&e.userData.modelPath&&(this._cache&&this._cache.set(fy(e.userData.modelPath),{type:"glb",resourcePath:e.userData.modelPath,needExport:!1,refCount:1,resource:e}),l.push({parent:e.parent,child:e}))})),l.forEach((e=>{e.parent.remove(e.child)})),r&&(r.traverse((e=>{e.material&&e.material.map&&(Ep.textureStore.add(e.material.map.name||`${e.material.name}#map`,e.material.map),this._cache&&this._cache.set(fy(e.material.map.name),{resource:e.material.map}))})),r.parent.remove(r)),i.userData.icon=t.icon,i.userData.setting=t.setting,this._cache&&this._cache.set(a,{type:"tgaw",resourcePath:e,needExport:!1,refCount:1,resource:i,size:s})}else{let e=[],i=null,n=null;t.scene.traverse((t=>{if(t.userData&&t.userData.isModelSource&&(n=t),t.userData&&t.userData.needExport){let{type:i,resourcePath:n,needExport:a,refCount:r}=t.userData;this._cache&&this._cache.set(fy(t.userData.resourcePath),{type:i,resourcePath:n,needExport:a,refCount:r,resource:t}),e.push({parent:t.parent,child:t})}t.userData&&t.userData.customTexture&&(i=t)})),e.forEach((e=>{e.parent.remove(e.child)}));let r=[];n&&n.traverse((e=>{e.userData&&e.userData.modelPath&&(this._cache&&this._cache.set(fy(e.userData.modelPath),{type:"glb",resourcePath:e.userData.modelPath,needExport:!1,refCount:1,resource:e}),r.push({parent:e.parent,child:e}))})),r.forEach((e=>{e.parent.remove(e.child)})),i&&(i.traverse((e=>{e.material&&e.material.map&&(Ep.textureStore.add(e.material.map.name||`${e.material.name}#map`,e.material.map),this._cache&&this._cache.set(fy(e.material.map.name),{resource:e.material.map}))})),i.parent.remove(i)),this._cache&&this._cache.set(a,{type:type,resourcePath:resourcePath,needExport:needExport,refCount:1,resource:t.scene,size:s})}r instanceof Array?r.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(a).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof i&&(i(this.helper.cloneNode(this._cache?this._cache.get(a).resource:null)),Ep.sceneBufferCacheExpired=!0)}else{if(this._loadQueue&&this._loadQueue.delete(a),!this._cache)return;let e=this._cache?this._cache.get(a):null,n=e.onLoadList,r=e.size;if(0===t.animations.length){let e=[],i=null;t.scene.traverse((t=>{if(t.userData&&t.userData.needExport){let{type:i,resourcePath:n,needExport:a,refCount:r}=t.userData;this._cache&&this._cache.set(fy(t.userData.resourcePath),{type:i,resourcePath:n,needExport:a,refCount:r,resource:t}),e.push({parent:t.parent,child:t})}t.userData&&t.userData.customTexture&&(i=t)})),e.forEach((e=>{e.parent.remove(e.child)})),i&&(i.traverse((e=>{e.material&&e.material.map&&(Ep.textureStore.add(e.material.map.name||`${e.material.name}#map`,e.material.map),this._cache&&this._cache.set(fy(e.material.map.name),{resource:e.material.map}))})),i.parent.remove(i));let n=this.helper.autoMerge(t.scene);this._cache&&this._cache.set(a,{type:type,resourcePath:resourcePath,needExport:needExport,refCount:1,resource:n,size:r})}else this._cache&&this._cache.set(a,{type:type,resourcePath:resourcePath,needExport:needExport,refCount:1,resource:t.scene,size:r});n instanceof Array?n.forEach((e=>{e(this.helper.cloneNode(this._cache?this._cache.get(a).resource:null)),Ep.sceneBufferCacheExpired=!0})):"function"==typeof i&&(i(this.helper.cloneNode(this._cache?this._cache.get(a).resource:null)),Ep.sceneBufferCacheExpired=!0)}}),(e=>{if(1!==e.total&&0!==e.total){let t=this._cache?this._cache.get(a):null;t&&void 0===t.size&&(t.size=e.total,this._cache&&this._cache.set(a,t))}t&&t(e)}),(e=>{this._loadQueue&&this._loadQueue.delete(a);let t=(this._cache?this._cache.get(a):null).onErrorList;t instanceof Array?t.forEach((t=>{t&&t(e)})):n&&n(e),this._cache&&this._cache.delete(a)}),(e=>{this._loadQueue?this._loadQueue.set(a,e):e.abort()}))}clear(){this._scene}destroy(){this._loadQueue.forEach((e=>{e&&e.abort&&e.abort()})),this._loadQueue=null,this._cache.forEach((e=>{e&&_y.disposeThreeObject(e.resource)})),this._cache=null}destroyCache(e){const t=this._cache.get(e);this._cache.delete(e),_y.disposeThreeObject(t.resource)}find(e){if(e)return this._cache?this._cache.get(fy(e)):null}remove(e,t){this._scene}copy(e,t){}applySettings(e){return new Promise((t=>{if(!e||e.length<=0)return this.preloadResourceStore=!0,logger.debug("cacheStore.applySettings() loadMaterial end。"),void t();let i=[];e.forEach((e=>{e.refCount<=1||i.push(new Promise((t=>{Ep.instance.preloadResource(e.resourcePath,e.type,(()=>{let i=this._cache?this._cache.get(fy(e.resourcePath)):null;i&&e&&(i.refCount=e.refCount,this._cache&&this._cache.set(fy(e.resourcePath),i)),t()}),(()=>{}),{needExport:e.needExport})})))})),i.length>0?(this.preloadResourceStore=!1,Promise.all(i).then((()=>{this.preloadResourceStore=!0,logger.debug("cacheStore.applySettings() loadMaterial end。"),t()})).catch((()=>{this.preloadResourceStore=!1,logger.error("cacheStore.applySettings() loadMaterial end error。"),t()}))):(this.preloadResourceStore=!0,logger.debug("cacheStore.applySettings() loadMaterial end。"),t())}))}pushMaterialArticulationSetting(e,t,i,n){let a=i.articulations||[];for(let i=0;i<a.length;i++){let r=a[i].properties||[];for(let i=0;i<r.length;i++){let a=r[i].modifiers||[];for(let i=0;i<a.length;i++)"materialsReplace"===a[i].key&&a[i].values.forEach((i=>{i.path&&fy(i.path)===n&&!e.includes((e=>e.resourcePath===i.path))&&e.push({needExport:t.needExport,refCount:2,resourcePath:i.path,type:t.type})}))}}}pushChildrenMaterialSettings(e,t,i,n){let a=this,r=!1;return e.forEach((e=>{if(r)return!0;if("ModelItem"===e.type||"ModelAsset"===e.type||"LineItem"===e.type){if(e.materials){for(var s in e.materials)if(e.materials[s].replacePath&&fy(e.materials[s].replacePath)===n)return r=!0,r;a.pushMaterialArticulationSetting(t,i,e,n)}}else if("PaintItem"===e.type){if(r=a.pushChildrenMaterialSettings(e.children,t,i,n),r)return r;e.modelInstanced&&e.modelInstanced.forEach((r=>{if(("ModelAsset"===r.type||"ModelItem"===r.type)&&r.materials){for(var s in r.materials)if(r.materials[s].replacePath&&fy(r.materials[s].replacePath)===n)return!0;a.pushMaterialArticulationSetting(t,i,e,n)}}))}else if(["PackedItem","BuildingFloorItem","BuildingRoomItem"].includes(e.type)&&(r=a.pushChildrenMaterialSettings(e.children,t,i,n),r))return r})),r}getSettings(){let e=[],t=Ep.instance.defaultObjectTree.getSettings(),i=this;return this._cache.forEach(((n,a)=>{let r=!1;t.children.forEach((t=>{if(!r)if("ModelItem"===t.type||"ModelAsset"===t.typ||"LineItem"===t.type){if(t.materials){for(var s in t.materials)t.materials[s].replacePath&&fy(t.materials[s].replacePath)===a&&(r=!0);i.pushMaterialArticulationSetting(e,n,t,a)}}else"GroupItem"===t.type?t.children.forEach((s=>{if("ModelAsset"===s.type&&s.materials){for(var o in s.materials)s.materials[o].replacePath&&fy(s.materials[o].replacePath)===a&&(r=!0);i.pushMaterialArticulationSetting(e,n,t,a)}})):"PaintItem"===t.type?(t.children.forEach((t=>{if(("ModelAsset"===t.type||"ModelItem"===t.type)&&t.materials){for(var s in t.materials)t.materials[s].replacePath&&fy(t.materials[s].replacePath)===a&&(r=!0);i.pushMaterialArticulationSetting(e,n,t,a)}})),t.modelInstanced&&t.modelInstanced.forEach((t=>{if(("ModelAsset"===t.type||"ModelItem"===t.type)&&t.materials){for(var s in t.materials)t.materials[s].replacePath&&fy(t.materials[s].replacePath)===a&&(r=!0);i.pushMaterialArticulationSetting(e,n,t,a)}}))):["BuildingItem","PackedItem"].includes(t.type)&&(r=i.pushChildrenMaterialSettings(t.children,e,n,a))})),r&&n.resourcePath&&!e.includes((e=>e.resourcePath==n.resourcePath))&&e.push({needExport:n.needExport,refCount:2,resourcePath:n.resourcePath,type:n.type})})),e}publishBuildingModel(e,t){let i=this;e.forEach((e=>{"ModelItem"===e.type||"ModelAsset"===e.type?t.add(e.path||e.modelPath):"PaintItem"===e.type?(i.publishBuildingModel(e.children,t),e.modelInstanced&&e.modelInstanced.forEach((e=>{"ModelAsset"!==e.type&&"ModelItem"!==e.type||t.add(e.path||e.modelPath)}))):["PackedItem","BuildingFloorItem","BuildingRoomItem"].includes(e.type)&&i.publishBuildingModel(e.children,t)}))}getPublishSceneObject3D(e){let t=this,i=new Set;e.objectTree.children.forEach((e=>{"ModelItem"===e.type?i.add(e.modelPath):"GroupItem"===e.type?e.children.forEach((e=>{"ModelAsset"===e.type&&i.add(e.path)})):"PaintItem"===e.type?(t.publishBuildingModel(e.children,i),e.modelInstanced&&e.modelInstanced.forEach((e=>{"ModelAsset"!==e.type&&"ModelItem"!==e.type||i.add(e.path||e.modelPath)}))):["BuildingItem","PackedItem"].includes(e.type)&&t.publishBuildingModel(e.children,i)}));let n=new sr;return n.userData={isModelSource:!0},i.forEach((e=>{let t=fy(e),i=this._cache.get(t);i&&(i.resource.userData={modelPath:e},n.add(i.resource))})),n}}class BT{constructor(){this.cloneNode=e=>{let t=e.clone();return e instanceof we||e instanceof Qi||t.traverse((e=>{if(e.isMesh)if(e.material instanceof Array){let t=[];for(let i of e.material){let e=i.clone();for(let t in e)e[t]instanceof we&&(e[t]=e[t].clone());t.push(e)}e.material=t}else if(e.material instanceof Vt){e.material=e.material.clone();for(let t in e.material)e.material[t]instanceof we&&(e.material[t]=e.material[t].clone())}})),t},this.autoMerge=e=>{if(e.isGroup)return this.recurse(e),e},this.recurse=e=>{if(this.checkCapableToMerge(e))this.doMerge(e);else if(this.checkGroupCapableToMerge(e))this.doGroupMerge(e);else for(let t=e.children.length-1;t>=0;t--)this.recurse(e.children[t])},this.doMerge=e=>{let t=[],i=[],n=[];for(let a of e.children)if(isNaN(Number(a.name.replace(e.name+"_",""))))t.push(a);else if(a.isMesh){i.push(a.geometry);let e=a.material.clone();e.vertexColors=!1,n.push(e)}let a=0;if(i.forEach((e=>{e.attributes.uv2&&a++})),a>0&&a!=i.length&&i.forEach((e=>{e&&e.attributes&&e.attributes.uv&&!e.attributes.uv2&&e.setAttribute("uv2",new ti(e.attributes.uv.array,2))})),!i.length)return;let r=xb.mergeBufferGeometries(i),s=0,o=0;for(let e of i)r.addGroup(s,e.index.count,o),s+=e.index.count,o++;let l=new Fi(r,n);l.name=e.name,l.visible=e.visible,l.castShadow=!0,l.receiveShadow=!0,l.position.copy(e.position),l.rotation.copy(e.rotation),l.scale.copy(e.scale);for(let e of t)l.add(e);this.recurse(l),_y.disposeThreeObject(e),e.parent.add(l),e.parent.remove(e)},this.doGroupMerge=e=>{let t=[],i=[],n=[],a=[];for(let r of e.children)if(r.name.indexOf("_water_")<0)if(isNaN(Number(r.name.replace("mesh_",""))))t.push(r);else if(r.isMesh){n.push(r.geometry.index),i.push(r.geometry.toNonIndexed());let e=r.material.clone();e.vertexColors=!1,a.push(e)}if(!i.length)return;let r=xb.mergeBufferGeometries(i),s=0,o=0;for(let e of n)r.addGroup(s,e.count,o),s+=e.count,o++;let l=new Fi(r,a);l.name=e.name,l.visible=e.visible,l.castShadow=!0,l.receiveShadow=!0,l.position.copy(e.position),l.rotation.copy(e.rotation),l.scale.copy(e.scale);for(let e of t)l.add(e);this.recurse(l),_y.disposeThreeObject(e),e.parent.add(l),e.parent.remove(e)},this.checkCapableToMerge=e=>{if(!e.isGroup||""===e.name)return!1;if(!(e.children instanceof Array)||e.children.length<2)return!1;let t=0;for(let i of e.children)i.name.indexOf(e.name+"_")>-1&&(t+=1);return t>=2||void 0},this.checkGroupCapableToMerge=e=>{if(!e.isGroup||""===e.name)return!1;if(!(e.children instanceof Array)||e.children.length<2)return!1;e.children[0].name;let t=0;for(let i of e.children)i.name.indexOf("mesh_")>-1&&(t+=1);return t>=2||void 0}}}class zT{constructor(){var e=[];this.add=(t,i,n,a,r,s)=>{let o;this.findCutBulidingByUUID(t)&&this.remove(t),Ep.scene.models.traverse((e=>{e.uuid===t&&(o=e)})),o||(o=Ep.scene.getObjectByName(t));var l={uuid:t,clippingController:new uv({meshes:[o],clippingPlanes:[{nx:i,ny:n,nz:a,d:r}]})};e.push(l),s&&s(1,"成功")},this.remove=(t,i)=>{let n=this.findCutBulidingByUUID(t);if(n){n.clippingController.clear();for(let i=0;i<e.length;i++)e[i].uuid===t&&(delete e[i].clippingController,e.splice(i,1),i--);i&&i(1,"删除成功")}else i&&i(0,"不存在的裁剪建筑")},this.findCutBulidingByUUID=(t,i)=>{var n=e.find((e=>e.uuid===t));if(n)return i&&i(1,"成功"),n;i&&i(0,"不存在的裁剪建筑")},this.dispose=()=>{e.forEach((e=>{e.clippingController instanceof uv&&e.clippingController.dispose&&e.clippingController.dispose()})),e=[]}}}class UT extends Uu{constructor(e=!0){super("CacheBufferPass"),this.setFullscreenMaterial(new Yi({type:"CacheBufferMaterial",uniforms:{inputBuffer:new jc(null),opacity:new jc(1)},fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\n\n        uniform mediump sampler2D inputBuffer;\n    \n    #else\n    \n        uniform lowp sampler2D inputBuffer;\n    \n    #endif\n    \n    uniform float opacity;\n    \n    varying vec2 vUv;\n    \n    void main() {\n    \n        vec4 texel = texture2D(inputBuffer, vUv);\n        gl_FragColor = opacity * texel;\n    \n        #include <encodings_fragment>\n    \n    }",vertexShader:"varying vec2 vUv;\n\n        void main() {\n        \n            vUv = position.xy * 0.5 + 0.5;\n            gl_Position = vec4(position.xy, 1.0, 1.0);\n        \n        }",blending:0,depthWrite:!1,depthTest:!1})),this.needsSwap=!0,this.cacheBuffer=new Te(1,1,{minFilter:b,magFilter:b,stencilBuffer:!1,depthBuffer:!1}),this.cacheBuffer.texture.name="CacheBuffer.Target",this.cacheExpired=!0,this.resize=e}render(e,t,i,n,a){if(!this.cacheEnabled)return this.cacheExpired=!0,this.getFullscreenMaterial().uniforms.inputBuffer.value=t.texture,e.setRenderTarget(this.renderToScreen?null:i),void e.render(this.scene,this.camera);this.cacheExpired&&(this.getFullscreenMaterial().uniforms.inputBuffer.value=t.texture,e.setRenderTarget(this.renderToScreen?null:this.cacheBuffer),e.render(this.scene,this.camera),this.cacheExpired=!1),this.getFullscreenMaterial().uniforms.inputBuffer.value=this.cacheBuffer.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(this.scene,this.camera)}setSize(e,t){if(this.resize){const i=Math.max(e,1),n=Math.max(t,1);this.cacheBuffer.setSize(i,n)}}}let FT=["IconAsset","IconBackground","IconGroup","InstancedGroup","Sprite","Points"];class jT{constructor(){this._effects={},this._lutPassEnabled=!1,Ep.composer=new class{constructor(e=null,{depthBuffer:t=!0,stencilBuffer:i=!1,multisampling:n=0,frameBufferType:a}={}){this.renderer=e,this.inputBuffer=null,this.outputBuffer=null,null!==this.renderer&&(this.renderer.autoClear=!1,this.inputBuffer=this.createBuffer(t,i,a,n),this.outputBuffer=this.inputBuffer.clone()),this.copyPass=new hd(new Su),this.depthTexture=null,this.passes=[],this.autoRenderToScreen=!0}get multisampling(){return this.inputBuffer instanceof Ae?this.inputBuffer.samples:0}set multisampling(e){const t=this.inputBuffer,i=this.multisampling;i>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e):i!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getRenderer(){return this.renderer}replaceRenderer(e,t=!0){const i=this.renderer;if(null!==i&&i!==e){const n=i.getSize(new ye),a=e.getSize(new ye),r=i.domElement.parentNode;this.renderer=e,this.renderer.autoClear=!1,n.equals(a)||this.setSize(),t&&null!==r&&(r.removeChild(i.domElement),r.appendChild(e.domElement))}return i}createDepthTexture(){const e=this.depthTexture=new bs;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=O,e.type=E):e.type=M,e}deleteDepthTexture(){if(null!==this.depthTexture){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const e of this.passes)e.setDepthTexture(null)}}createBuffer(e,t,i,n){const a=this.renderer.getDrawingBufferSize(new ye),r={format:this.renderer.getContext().getContextAttributes().alpha||i!==w?I:C,minFilter:b,magFilter:b,stencilBuffer:t,depthBuffer:e,type:i},s=n>0?new Ae(a.width,a.height,r):new Te(a.width,a.height,r);return n>0&&(s.samples=n),s.texture.name="EffectComposer.Buffer",s.texture.generateMipmaps=!1,s}addPass(e,t){const i=this.passes,n=this.renderer,a=n.getDrawingBufferSize(new ye),r=n.getContext().getContextAttributes().alpha,s=this.inputBuffer.texture.type;if(e.setSize(a.width,a.height),e.initialize(n,r,s),this.autoRenderToScreen&&(i.length>0&&(i[i.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),void 0!==t?i.splice(t,0,e):i.push(e),this.autoRenderToScreen&&(i[i.length-1].renderToScreen=!0),e.needsDepthTexture||null!==this.depthTexture)if(null===this.depthTexture){const t=this.createDepthTexture();for(e of i)e.setDepthTexture(t)}else e.setDepthTexture(this.depthTexture)}removePass(e){const t=this.passes,i=t.indexOf(e);if(-1!==i&&t.splice(i,1).length>0){if(null!==this.depthTexture){const i=(e,t)=>e||t.needsDepthTexture;t.reduce(i,!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&i===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}removeAllPasses(){const e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}render(e){const t=this.renderer,i=this.copyPass;let n,a,r,s=this.inputBuffer,o=this.outputBuffer,l=!1;for(const c of this.passes)c.enabled&&(c.render(t,s,o,e,l),c.needsSwap&&(l&&(i.renderToScreen=c.renderToScreen,n=t.getContext(),a=t.state.buffers.stencil,a.setFunc(n.NOTEQUAL,1,4294967295),i.render(t,s,o,e,l),a.setFunc(n.EQUAL,1,4294967295)),r=s,s=o,o=r),c instanceof ld?l=!0:c instanceof Gu&&(l=!1))}setSize(e,t,i){const n=this.renderer;if(void 0===e||void 0===t){const i=n.getSize(new ye);e=i.width,t=i.height}else n.setSize(e,t,i);const a=n.getDrawingBufferSize(new ye);this.inputBuffer.setSize(a.width,a.height),this.outputBuffer.setSize(a.width,a.height);for(const e of this.passes)e.setSize(a.width,a.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const e of this.passes)e.dispose();this.passes=[],null!==this.inputBuffer&&this.inputBuffer.dispose(),null!==this.outputBuffer&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose()}}(Ep.renderer,{frameBufferType:A}),Ep.composer.render=function(e,n){const a=this.renderer,r=this.copyPass;let s,o,l,c=this.inputBuffer,h=this.outputBuffer,u=!1;for(let d=0;d<this.passes.length;d++){const p=this.passes[d];p.enabled&&(n?d<i.cachedPasses?t.cacheExpired&&p.render(a,c,h,e,u):(p instanceof UT&&(p.cacheEnabled=!0),p.render(a,c,h,e,u)):(p.render(a,c,h,e,u),t.cacheExpired=!0,t.cacheEnabled=!1),p.needsSwap&&(u&&(r.renderToScreen=p.renderToScreen,s=a.getContext(),o=a.state.buffers.stencil,o.setFunc(s.NOTEQUAL,1,4294967295),r.render(a,c,h,e,u),o.setFunc(s.EQUAL,1,4294967295)),l=c,c=h,h=l),p instanceof ld?u=!0:p instanceof Gu&&(u=!1))}},Ep.composer.autoRenderToScreen=!0,void 0!==Ep.renderer.getContext().MAX_SAMPLES?Ep.composer.multisampling=Math.min(4,Ep.renderer.getContext().getParameter(Ep.renderer.getContext().MAX_SAMPLES)):Ep.composer.multisampling=0;let e=new Zu(Ep.scene,Ep.camera);e.name="RenderPass",Ep.composer.addPass(e);let t=new UT;t.name="CacheBufferPass",this.visualEffect=new Qx;const i=this.visualEffect;this.spaceEffect=new Zx,this.visualEffect.addPass(t),this.changeScene=t=>{e.scene=t,this.spaceEffect=new Zx;const i=this.visualEffect._passes.outlinePass.outlineEffect;i.scene=Ep.scene,i.depthPass.scene=Ep.scene,i.depthPass.renderPass.scene=Ep.scene,i.maskPass.scene=Ep.scene;const n=this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect;n.scene=Ep.scene,n.depthPass.scene=Ep.scene,n.depthPass.renderPass.scene=Ep.scene,n.maskPass.scene=Ep.scene;this.visualEffect._passes.normalPass.renderPass.scene=t.models}}setSize(e,t){Ep.composer.setSize(e,t)}setLut(e="disabled"){this.lutMap[e]?(this.lutPass.enabled=!0,this.lutPass.intensity=1,this.lutPass.lut=this.lutMap[e].texture3D):(this.lutPass.enabled=!1,this.lutPass.lut=null)}enableLut(){return this._lutPassEnabled=!0,this.lutPass&&(this.lutPass.enabled=!0),!!this.lutPass&&this.lutPass.enabled}disableLut(){return this._lutPassEnabled=!1,this.lutPass&&(this.lutPass.enabled=!1),!!this.lutPass&&this.lutPass.enabled}nextLut(){this.lutPass.enabled||this.enableLut(),this.lutSelected="";for(let e in this.lutMap){if(""!==this.lutSelected){this.lutSelected=e,this.lutPass.lut=this.lutMap[this.lutSelected].texture3D;break}if(this.lutMap[e].texture3D===this.lutPass.lut&&(this.lutSelected=e,"Zeke 39.CUBE"===this.lutSelected)){this.lutSelected="Arabica 12.CUBE",this.lutPass.lut=this.lutMap[this.lutSelected].texture3D;break}}return this.lutSelected}render(e){Ep.composer.render(e)}takeSnapshot2({targetWidth:e=256,targetHeight:t=160,targetEncoder:i=1}={}){return new Promise((n=>{let a=Ep.camera.fov,r=Ep.camera.aspect;e/t>Ep.camera.aspect?Ep.camera.aspect=e/t:(Ep.camera.aspect=e/t,Ep.camera.fov=Math.atan(r/Ep.camera.aspect*Math.tan(a/180*Math.PI/2))/Math.PI*180*2),Ep.camera.updateProjectionMatrix(),Ep.composer.render();let s=Ep.renderer.domElement.toDataURL("image/jpeg",i);Ep.camera.aspect=r,Ep.camera.fov=a,Ep.camera.updateProjectionMatrix();let o=document.createElement("canvas"),l=o.getContext("2d");o.width=e,o.height=t;let c=new Image;c.src=s,c.onload=()=>{l.drawImage(c,0,0,e,t),s=o.toDataURL("image/jpeg",i),n(s)}}))}takeSnapshot({targetWidth:e=256,targetHeight:t=160,targetEncoder:i=1}={}){let n=Ep.renderer.getSize(),a=Ep.camera.fov,r=Ep.camera.aspect,s=Ep.animationStore.getAnimations();for(let e=0,i=s.length;e<i;e++)s[e].isParticleStore&&(s[e].isPreview||s[e].resize(t));e/t>Ep.camera.aspect?Ep.camera.aspect=e/t:(Ep.camera.aspect=e/t,Ep.camera.fov=Math.atan(r/Ep.camera.aspect*Math.tan(a/180*Math.PI/2))/Math.PI*180*2),Ep.camera.updateProjectionMatrix(),Ep.composer.setSize(e,t),Ep.composer.render();let o=Ep.renderer.domElement.toDataURL("image/jpeg",i);Ep.camera.aspect=r,Ep.camera.fov=a,Ep.camera.updateProjectionMatrix();for(let e=0,t=s.length;e<t;e++)s[e].isParticleStore&&(s[e].isPreview||s[e].resize(n.height));return Ep.composer.setSize(n.width,n.height),o}highlightObject(e,t){if(!this.visualEffect._passes.outlinePass||!this.visualEffect._passes.outlinePass.outlineEffect)return;if(e&&t||this.cancelLayerHelper(Ep.defaultObjectTree),!e){if(this.visualEffect._passes.outlinePass.outlineEffect.selection.clear(),this.visualEffect._passes.outlinePass.outlineEffect.time=1e4,!Ep.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))){let e=Ep.composer.passes.findIndex((e=>"OutlinePass"==e.name)),t=Array.from(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection);this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),Ep.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1),t.forEach((e=>{this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)}))}return}var i=this;let n=Ep.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name));if(n&&Ep.effectStore.visualEffect.removePass(n),e instanceof Mb){let{key:t}=e.userData;e.visible=e.instanced.settings[t].isVisible}else e.children.length>0?(t||(this.visualEffect._passes.outlinePass.outlineEffect.selection.clear(),this.visualEffect._passes.outlinePass.outlineEffect.time=1e4),e.traverse((function(e){FT.includes(e.type)||i.visualEffect._passes.outlinePass.outlineEffect.selection.add(e)}))):t?(this.visualEffect._passes.outlinePass.outlineEffect.selection.add(e),FT.includes(e.type)||i.visualEffect._passes.outlinePass.outlineEffect.selection.add(e)):(this.visualEffect._passes.outlinePass.outlineEffect.selection.clear(),this.visualEffect._passes.outlinePass.outlineEffect.time=1e4,FT.includes(e.type)||i.visualEffect._passes.outlinePass.outlineEffect.selection.add(e))}cancleHighlightObject(e){if(!this.visualEffect._passes.outlinePass||!this.visualEffect._passes.outlinePass.outlineEffect)return;if(!Ep.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))){let e=Ep.composer.passes.findIndex((e=>"OutlinePass"==e.name));Ep.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1)}var t=this;if(e instanceof Mb)e.visible=!1;else if(e.children.length>0?e.traverse((function(e){t.visualEffect._passes.outlinePass.outlineEffect.selection.delete(e)})):this.visualEffect._passes.outlinePass.outlineEffect.selection.delete(e),this.visualEffect._passes.outlinePass.outlineEffect.selection.size<=0){if(!Ep.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))){let e=Ep.composer.passes.findIndex((e=>"OutlinePass"==e.name)),t=Array.from(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection);this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),Ep.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1),t.forEach((e=>{this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)}))}}}cancelLayerHelper(e){e.children.forEach((e=>{"GroupItem"===e.type||"PaintItem"===e.type?e.resetHelper():["BuildingItem","BuildingFloorItem","BuildingRoomItem"].includes(e.type)&&this.cancelLayerHelper(e)}))}initOutlinePass(e,t,i){if(!this.visualEffect._passes.articulationOutlinePass||!this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect)return;if(!e)return this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),void(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.time=1e4);if(!Ep.composer.passes.find((e=>"ArticulationOutlineEffect"==e.name))&&this.visualEffect._passes.outlinePass.outlineEffect.selection.size<=0){let e=Ep.composer.passes.findIndex((e=>"OutlinePass"==e.name));Ep.composer.addPass(this.visualEffect._passes.articulationOutlinePass,e+1)}this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.uniforms.get("hiddenEdgeColor").value=i.color,this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.uniforms.get("visibleEdgeColor").value=i.color,this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.blendMode.opacity.value=void 0===i.alpha?1:i.alpha,t||(this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.clear(),this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.time=1e4);var n=this;e.children.length>0?e.traverse((function(e){n.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)})):this.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect.selection.add(e)}applySettings(e){e?(this.visualEffect.applySettings(e.visualEffect),this.spaceEffect.applySettings(e.spaceEffect)):logger.error("无效的特效设置。")}}jT.TYPE={SSAO:Symbol("SSAO"),SMAA:Symbol("SMAA")};class HT{constructor(e,t,i){this._renderer=e,this._scene=t,this._camera=i,this._debounceTimer=0,this._debounceDelay=1e3,this._cameraStopTimeout=void 0,this._handlers={lodchange:{default:[]},cameramove:{default:[]},camerazoom:{default:[]},camerazoomstop:{default:[]},click:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]}},dblclick:{default:[],byType:{drawable:[],model:[],building:[],scene:[]}},mousedown:{default:[],byType:{sprite:[],billboard:[],model:[]}},mousehover:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]}},unmousehover:{default:[],byType:{sprite:[],billboard:[],landmark:[],bubble:[],bar:[],odLine:[],trail:[],area:[],drawable:[],model:[],building:[],scene:[]}},mouseup:{default:[],byType:{sprite:[],billboard:[],model:[]}},trailmove:{default:[]}},this._raycaster=new Vc,this._mouse=new ye,this._lastMouseHoverDrawable=null,this._lastMouseHoverModel=null,this._clickCount=0,this.deltaA=void 0}get handlers(){return this._handlers}set handlers(e){this._handlers=e}update(){void 0!==this.deltaA&&(this.deltaA+=Ep.deltaA,this.deltaA<.2||(this.deltaA=void 0,this._clickCount<2?this._clickCount=0:(this._clickCount=0,this._mouseClickArguments[0].dblClick=!0,this.onClick(...this._mouseClickArguments))))}cameraMove(e){this._handlers.cameramove.default.length>0&&this._handlers.cameramove.default.map((t=>{t.handler(e)}))}add(e,t,i,n){if(e&&i)if(""==(t=t||""))this._handlers[e].default.push({handler:i,options:n});else{for(const n of this._handlers[e].byType[t])if(n.handler===i)return;this._handlers[e].byType[t].push({handler:i,options:n})}}remove(e,t,i){t&&""!==t?(""!==i&&i||(this._handlers[e].byType[t]=[]),this._handlers[e].byType[t].map(((n,a)=>{n.handler===i&&this._handlers[e].byType[t].splice(a,1)}))):""!==i&&i?this._handlers[e].default.map(((t,n)=>{t.handler===i&&this._handlers[e].default.splice(n,1)})):this._handlers[e].default=[]}async onClick(e,t,i){this._mouseClickArguments=arguments,this._clickCount++,void 0===this.deltaA&&(this.deltaA=0),this._mouse.set(e.offsetX/this._renderer.domElement.clientWidth*2-1,-e.offsetY/this._renderer.domElement.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this._camera);var n=[];if(t._scene.children.map(((e,t)=>{"__models"===e.name&&e.traverse((function(e){e.isMesh?n.push(e):"IconGroup"===e.type&&e.children.map((e=>{n.push(e)}))}))})),t._sceneObjects.traverse((function(e){n.push(e)})),"function"==typeof this.pluginEvent){const e=Ep.instance.findPlugin("GISCity");if(e){const t=e.getClickArray();for(let e=0;e<t.length;e++)n.push(t[e])}}Ep.defaultObjectTree.children.forEach((e=>{"LineItem"===e.type&&n.push(e.getModelLine().mesh),"PaperCutItem"===e.type&&e.getGroup().traverse((e=>{e.geometry&&n.push(e)}))}));const a=Ep.scene.getObjectByName("__tilesGroup");a&&a.children[0]&&n.push(a.children[0]),Ep.scene.instancedIconModelLandmark.traverse((function(e){n.push(e)}));var r=this._raycaster.intersectObjects(n);if(n=null,Ep.scene.getObjectByName("__pgl")&&Ep.pgl.terrain){let t=Ep.pgl.terrain.pickTerrain({x:e.offsetX,y:e.offsetY});if(t&&t.hit){for(let e=0;e<r.length;e++)if(r[e].distance>t.distance){r.splice(e,0,t);break}(0===r.length||t.distance>r[r.length-1].distance)&&r.push(t)}}var s=null,o=[];const l=[];if(r.length>0){"function"==typeof this.pluginEvent&&this.pluginEvent(r);for(let t=0;t<r.length;t++){if(!1===(s=r[t]).object.visible||!1===_y.judegParentIsVisible(s.object))continue;let n=_y.findObjectToBuilding(s.object.uuid);if(n){let e=Ep.clippingStore.findCutBulidingByUUID(n.getGroup().uuid);if(e&&e.clippingController.pointClipTest(s.point))continue}if(_y.isDepthTestDisabled(s.object.material))l.push(this._xyzToLLA(e,s,i));else{if(s)o.push(this._xyzToLLA(e,s,i));else if(this._handlers.click.byType.scene.length>0){var c={type:"background"};this._handlers.click.byType.scene.map(((t,i)=>{t.handler(e,c,i)}))}if(this._handlers.click.default.length>0){let t=this._raycaster.intersectObjects(this._scene.children,!0);if(t.length>0)(s=t[0]).point&&(e.clickX=s.point.x,e.clickY=s.point.y,e.clickZ=s.point.z),s.object.position,this._handlers.background&&this._invoke(this._handlers.background.default,e),s.object&&s.object.material instanceof Array&&(e.materialIndex=s.face.materialIndex),this._invoke(this._handlers.click.default,e,s.object);else this._handlers.background&&this._invoke(this._handlers.background.default,e)}}}if(l.length>0){o=[l[0]];for(let e=1;e<l.length;e++)(s=l[e]).object.parent.renderOrder>o[0].object.parent.renderOrder&&(o=[s])}0===o.length?this._handlers.click.byType.model.length>0&&this._handlers.click.byType.model.map((e=>{e.handler(null)})):o.length=1;let t=[],n=[],a=[],h=[],u=[],d=[],p=[],m=[],f=[];if(o.forEach((e=>{"landmark"!==this._getType(e)&&"landmark图标"!==this._getType(e)&&"landmark底图"!==this._getType(e)&&"landmark文字"!==this._getType(e)||t.push(e),"bubble"!==this._getType(e)&&"instancedbubble"!==this._getType(e)||n.push(e),"bar"===this._getType(e)&&a.push(e),"odLine"===this._getType(e)&&h.push(e),"trail"===this._getType(e)&&u.push(e),"area"===this._getType(e)&&d.push(e),this._judegDrawable(e)&&p.push(e),this._judegDrawable(e)&&"IconAsset"!==e.type||m.push(e),f.push(e)})),e.dblClick){if(this._handlers.dblclick.byType.drawable.length>0&&this._handlers.dblclick.byType.drawable.map(((t,i)=>{if(p[0])if(this._coordinatePass(p[0],e),p[0].object.name.includes("/iconmodellandmark")||p[0].object.name.includes("/iconmodeltrail")){let n={id:p[0].object.name};void 0!==p[0].instanceId&&(n=Ep.instance.getInstancedIconModelLandmarkInfo({name:p[0].object.name,index:p[0].instanceId})),t.handler(e,{name:n.id},i)}else"number"==typeof p[0].instanceId&&(p[0].object.instanceId=p[0].instanceId),t.handler(e,p[0].object,i)})),this._handlers.dblclick.byType.model.length>0&&this._handlers.dblclick.byType.model.map(((t,i)=>{if(m.length>0){let a;this._coordinatePass(m[0],e);let r=Ep.defaultObjectTree.findItemByObject3D(m[0].object);if(!r)return;let s=Ep.defaultObjectTree.findItemByObject3D(r.getGroup());if("BuildingItem"===r.type||s&&"BuildingItem"===s.type){var n=_y.getNodelFromModelItem(m[0].object);a=_y.findObjectToBuilding(m[0].object.uuid)}else if("ModelItem"===r.type||"IconAsset"===r.type||"ModelAsset"===r.type||"GroupItem"===r.type||"PaintItem"===r.type||"PaperCutItem"===r.type||"LineItem"===r.type||"TileSetItem"===r.type||"GisItem"===r.type||"PackedItem"===r.type){n=r;a=r}let o=m[0].object||{};m[0].object&&m[0].object.material instanceof Array&&(e.materialIndex=m[0].face.materialIndex);let l="model",c=!1;"BuildingItem"===a.type&&(l="building");let h=a.name;a.isIconModelIcon&&(h=a.name.substr(0,a.name.indexOf("-IconAssect")),l="iconModel",c=!0),a.isIconModel&&(l="iconModel"),n&&t.handler(e,{name:o.name,type:l,isIcon:c,position:o.position?{x:o.position.x,y:o.position.y,z:o.position.z}:void 0,_name:h},i)}})),this._handlers.dblclick.byType.building.length>0&&m.length>0){this._coordinatePass(m[0],e);const t=Ep.defaultObjectTree.findItemByObject3D(m[0].object);if(t&&"BuildingItem"===t.type){const i=Ep.defaultObjectTree.getParentIds(m[0].object),n=_y.findObjectToFloor(i),a=_y.findObjectToRoom(i),r={selectedType:t.type,name:t.name,model:{name:t.name,uuid:t.getGroup().uuid},type:"building"};a?(r.selectedType=a.type,r.name=a.name,r.buildingName=t.name,r.floorName=n.name,r.model.name=a.name,r.model.uuid=a.getGroup().uuid):n&&(r.selectedType=n.type,r.name=n.name,r.buildingName=t.name,r.model.name=n.name,r.model.uuid=n.getGroup().uuid);const s=this._handlers.dblclick.byType.building.length;for(let t=0;t<s;t++){this._handlers.dblclick.byType.building[t].handler(e,r,t)}}}this._handlers.dblclick.byType.scene.length>0&&f[0]&&this._handlers.dblclick.byType.scene.map(((t,i)=>{f[0].object&&f[0].object.material instanceof Array&&(e.materialIndex=f[0].face.materialIndex),this._coordinatePass(f[0],e),t.handler(e,f[0].object,i)}))}else{if(this._handlers.click.byType.landmark.length>0&&this._handlers.click.byType.landmark.map(((i,n)=>{t[0]&&(this._coordinatePass(t[0],e),i.handler(e,t[0].object,n))})),this._handlers.click.byType.bubble.length>0&&this._handlers.click.byType.bubble.map(((t,i)=>{n[0]&&(this._coordinatePass(n[0],e),t.handler(e,n[0].object,i))})),this._handlers.click.byType.bar.length>0&&this._handlers.click.byType.bar.map(((t,i)=>{a[0]&&(this._coordinatePass(a[0],e),t.handler(e,a[0].object,i))})),this._handlers.click.byType.odLine.length>0&&this._handlers.click.byType.odLine.map(((t,i)=>{h[0]&&(this._coordinatePass(h[0],e),t.handler(e,h[0].object,i))})),this._handlers.click.byType.trail.length>0&&this._handlers.click.byType.trail.map(((t,i)=>{u[0]&&(this._coordinatePass(u[0],e),t.handler(e,u[0].object,i))})),this._handlers.click.byType.area.length>0&&this._handlers.click.byType.area.map(((t,i)=>{d[0]&&(this._coordinatePass(d[0],e),t.handler(e,d[0].object,i))})),this._handlers.click.byType.drawable.length>0&&this._handlers.click.byType.drawable.map(((t,i)=>{if(p[0])if(this._coordinatePass(p[0],e),p[0].object.name.includes("/iconmodellandmark")||p[0].object.name.includes("/iconmodeltrail")){let n={id:p[0].object.name};void 0!==p[0].instanceId&&(n=Ep.instance.getInstancedIconModelLandmarkInfo({name:p[0].object.name,index:p[0].instanceId})),t.handler(e,{name:n.id},i)}else"number"==typeof p[0].instanceId&&(p[0].object.instanceId=p[0].instanceId),t.handler(e,p[0].object,i)})),this._handlers.click.byType.model.length>0&&this._handlers.click.byType.model.map(((t,i)=>{if(m.length>0){let a;this._coordinatePass(m[0],e);let r=Ep.defaultObjectTree.findItemByObject3D(m[0].object);if(!r)return;let s,o=Ep.defaultObjectTree.findItemByObject3D(r.getGroup());if("BuildingItem"===r.type||o&&"BuildingItem"===o.type){var n=_y.getNodelFromModelItem(m[0].object);a=_y.findObjectToBuilding(m[0].object.uuid)}else if("PaintItem"===r.type){n=r;if(a=r,void 0!==m[0].instanceId)s=r.children.find((e=>e.key===m[0].instanceId)),s&&(s=s.name);else for(const e of r.children)if(e.getGroup().getObjectById(m[0].object.id)){s=e.name;break}}else if("ModelItem"===r.type||"IconAsset"===r.type||"ModelAsset"===r.type||"GroupItem"===r.type||"PaintItem"===r.type||"PaperCutItem"===r.type||"LineItem"===r.type||"TileSetItem"===r.type||"GisItem"===r.type||"PackedItem"===r.type){n=r;a=r}let l=m[0].object||{};m[0].object&&m[0].object.material instanceof Array&&(e.materialIndex=m[0].face.materialIndex);let c="model",h=!1;"BuildingItem"===a.type&&(c="building");let u=a.name;a.isIconModelIcon&&(u=a.name.substr(0,a.name.indexOf("-IconAssect")),c="iconModel",h=!0),a.isIconModel&&(c="iconModel"),s&&(c="layer"),n&&t.handler(e,{name:l.name,node:l,position:l.position?{x:l.position.x,y:l.position.y,z:l.position.z}:void 0,model:{name:null!=n.name?n.name:l.name,position:null!=n.name&&n.getSettings?n.getSettings().transform&&n.getSettings().transform.position?{x:n.getSettings().transform.position.x,y:n.getSettings().transform.position.y,z:n.getSettings().transform.position.z}:void 0:null,uuid:null!=n.getGroup?n.getGroup().uuid:n.id},parentModel:{name:null!=r.name?r.name:n.name,uuid:r.getGroup&&null!=r.getGroup().uuid?r.getGroup().uuid:n.uuid,position:null!=r.name?r.getSettings().transform&&r.getSettings().transform.position?{x:r.getSettings().transform.position.x,y:r.getSettings().transform.position.y,z:r.getSettings().transform.position.z}:void 0:null},_name:u,_model:{name:a.name,uuid:null!=a.getGroup?a.getGroup().uuid:n.id},type:c,isIcon:h,paintLayerItem:s},i)}})),this._handlers.click.byType.building.length>0&&m.length>0){this._coordinatePass(m[0],e);const t=Ep.defaultObjectTree.findItemByObject3D(m[0].object);if(t&&"BuildingItem"===t.type){const i=Ep.defaultObjectTree.getParentIds(m[0].object),n=_y.findObjectToFloor(i),a=_y.findObjectToRoom(i),r={selectedType:t.type,name:t.name,model:{name:t.name,uuid:t.getGroup().uuid}};a?(r.selectedType=a.type,r.name=a.name,r.buildingName=t.name,r.floorName=n.name,r.model.name=a.name,r.model.uuid=a.getGroup().uuid):n&&(r.selectedType=n.type,r.name=n.name,r.buildingName=t.name,r.model.name=n.name,r.model.uuid=n.getGroup().uuid);const s=this._handlers.click.byType.building.length;for(let t=0;t<s;t++){this._handlers.click.byType.building[t].handler(e,r,t)}}}this._handlers.click.byType.scene.length>0&&f[0]&&this._handlers.click.byType.scene.map(((t,i)=>{f[0].object&&f[0].object.material instanceof Array&&(e.materialIndex=f[0].face.materialIndex),this._coordinatePass(f[0],e),t.handler(e,f[0].object,i)}))}}else e.dblClick?(this._handlers.dblclick.byType.model.length>0&&this._handlers.dblclick.byType.model.map((e=>{e.handler(null)})),this._handlers.dblclick.default.length>0&&this._handlers.dblclick.default.map((e=>{e.handler(null)}))):(this._handlers.click.byType.model.length>0&&this._handlers.click.byType.model.map((e=>{e.handler(null)})),this._handlers.click.default.length>0&&this._handlers.click.default.map((e=>{e.handler(null)})))}mouseHoverTest(){let e=this._handlers.mousehover.default.length>0;if(!1===e&&(e=this._handlers.unmousehover.default.length>0),!1===e)for(const t in this._handlers.mousehover.byType)if(e=this._handlers.mousehover.byType[t].length>0,!0===e)break;if(!1===e)for(const t in this._handlers.unmousehover.byType)if(e=this._handlers.unmousehover.byType[t].length>0,!0===e)break;!1!==e&&(this._mouseHoverTimeout?this._mouseHoverArguments=arguments:this._mouseHoverTimeout=setTimeout((()=>{this._mouseHoverArguments&&this._mouseHoverTest(...this._mouseHoverArguments),this._mouseHoverTimeout=void 0}),25))}_mouseHoverTest(e,t,i){const n=(t,i)=>{const n=Ep.defaultObjectTree.findItemByObject3D(t);if("ModelItem"===n.type||"IconAsset"===n.type){const a={name:n.name,type:"model",isIcon:!1};n.isIconModel&&(a.type="iconModel"),n.isIconModelIcon&&(a.name=a.name.substr(0,a.name.indexOf("-IconAssect")),a.type="iconModel",a.isIcon=!0),void 0!==i&&(a.selfChange=!0);const r=this._handlers.mousehover.byType.model.length;for(let t=0;t<r;t++){this._handlers.mousehover.byType.model[t].handler(e,a,t)}this._lastMouseHoverModel=t}if("BuildingItem"===n.type||"BuildingFloorItem"===n.type||"BuildingRoomItem"===n.type){const i=Ep.defaultObjectTree.getParentIds(t),a=_y.findObjectToFloor(i),r=_y.findObjectToRoom(i),s={name:n.name,selectedType:n.type,position:n.position,positionLla:n.positionLla};r?(s.selectedType=r.type,s.name=r.name,s.buildingName=n.name,s.floorName=a.name):a&&(s.selectedType=a.type,s.name=a.name,s.buildingName=n.name);const o=this._handlers.mousehover.byType.building.length;for(let t=0;t<o;t++){this._handlers.mousehover.byType.building[t].handler(e,s,t)}this._lastMouseHoverModel=t}if("PaintItem"===n.type){const i={name:n.name,type:"layer"};if(void 0!==t.instanceId){const e=n.children.find((e=>e.key===t.instanceId));e&&(i.paintLayerItem=e.name)}else for(const e of n.children)if(e.getGroup().getObjectById(t.id)){i.paintLayerItem=e.name;break}const a=this._handlers.mousehover.byType.model.length;for(let t=0;t<a;t++){this._handlers.mousehover.byType.model[t].handler(e,i,t)}this._lastMouseHoverModel=t}},a=(t,i)=>{const n=Ep.defaultObjectTree.findItemByObject3D(t);if("ModelItem"===n.type||"IconAsset"===n.type){const t={name:n.name,type:"model",isIcon:!1};n.isIconModel&&(t.type="iconModel"),n.isIconModelIcon&&(t.name=t.name.substr(0,t.name.indexOf("-IconAssect")),t.type="iconModel",t.isIcon=!0),void 0!==i&&(t.selfChange=!0);const a=this._handlers.unmousehover.byType.model.length;for(let i=0;i<a;i++){this._handlers.unmousehover.byType.model[i].handler(e,t,i)}this._lastMouseHoverModel=void 0}if("BuildingItem"===n.type||"BuildingFloorItem"===n.type||"BuildingRoomItem"===n.type){const t=Ep.defaultObjectTree.getParentIds(this._lastMouseHoverModel),i=_y.findObjectToFloor(t),a=_y.findObjectToRoom(t),r={name:n.name,selectedType:n.type,position:n.position,positionLla:n.positionLla};a?(r.selectedType=a.type,r.name=a.name,r.buildingName=n.name,r.floorName=i.name):i&&(r.selectedType=i.type,r.name=i.name,r.buildingName=n.name);const s=this._handlers.unmousehover.byType.building.length;for(let t=0;t<s;t++){this._handlers.unmousehover.byType.building[t].handler(e,r,t)}this._lastMouseHoverModel=void 0}if("PaintItem"===n.type){const i={name:n.name,type:"layer"};if(void 0!==t.instanceId){const e=n.children.find((e=>e.key===t.instanceId));e&&(i.paintLayerItem=e.name)}else for(const e of n.children)if(e.getGroup().getObjectById(t.id)){i.paintLayerItem=e.name;break}const a=this._handlers.unmousehover.byType.model.length;for(let t=0;t<a;t++){this._handlers.unmousehover.byType.model[t].handler(e,i,t)}this._lastMouseHoverModel=void 0}};this.isTesting=!0,this._mouse.set(e.offsetX/this._renderer.domElement.clientWidth*2-1,-e.offsetY/this._renderer.domElement.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this._camera);var r=[];t._scene.children.map(((e,t)=>{"__models"===e.name&&e.traverse((function(e){e.isForParticle||(e.isMesh?r.push(e):"IconGroup"===e.type&&e.children.map((e=>{r.push(e)})))}))})),t._sceneObjects.traverse((function(e){r.push(e)})),Ep.defaultObjectTree.children.forEach((e=>{"LineItem"===e.type&&r.push(e.getModelLine().mesh)})),Ep.scene.instancedIconModelLandmark.traverse((function(e){r.push(e)}));var s=this._raycaster.intersectObjects(r);r=null;var o=null,l=[];const c=[];if(s.length>0){for(let t=0;t<s.length;t++){if(!1===(o=s[t]).object.visible||!1===_y.judegParentIsVisible(o.object))continue;let n=_y.findObjectToBuilding(o.object.uuid);if(n){let e=Ep.clippingStore.findCutBulidingByUUID(n.getGroup().uuid);if(e&&e.clippingController.pointClipTest(o.point))continue}if(_y.isDepthTestDisabled(o.object.material))c.push(this._xyzToLLA(e,o,i));else{if(o)l.push(this._xyzToLLA(e,o,i));else if(this._handlers.mousehover.byType.scene.length>0){var h={type:"background"};this._handlers.mousehover.byType.scene.map(((t,i)=>{t.handler(e,h,i)}))}if(this._handlers.mousehover.default.length>0){let t=this._raycaster.intersectObjects(this._scene.children,!0);if(t.length>0)(o=t[0]).point&&(e.clickX=o.point.x,e.clickY=o.point.y,e.clickZ=o.point.z),o.object.position,this._handlers.background&&this._invoke(this._handlers.background.default,e),this._invoke(this._handlers.mousehover.default,e,o.object);else this._handlers.background&&this._invoke(this._handlers.background.default,e)}}}if(c.length>0){l=[c[0]];for(let e=1;e<c.length;e++)(o=c[e]).object.parent.renderOrder>l[0].object.parent.renderOrder&&(l=[o])}let t,r,u=[],d=[],p=[],m=[],f=[],g=[],y=[],v=[],b=[];if(l.forEach((e=>{"landmark"!==this._getType(e)&&"landmark图标"!==this._getType(e)&&"landmark底图"!==this._getType(e)&&"landmark文字"!==this._getType(e)||u.push(e),"bubble"!==this._getType(e)&&"instancedbubble"!==this._getType(e)||d.push(e),"bar"===this._getType(e)&&p.push(e),"odLine"===this._getType(e)&&m.push(e),"trail"===this._getType(e)&&f.push(e),"area"===this._getType(e)&&g.push(e),this._judegDrawable(e)&&y.push(e),this._judegDrawable(e)&&"IconAsset"!==e.type||v.push(e),b.push(e)})),y[0]&&(t=y[0].object,t.instanceId=y[0].instanceId),!this._lastMouseHoverDrawable&&t){if(t.name.includes("/iconmodellandmark")||t.name.includes("/iconmodeltrail")){let i={id:t.name};void 0!==t.instanceId&&(i=Ep.instance.getInstancedIconModelLandmarkInfo({name:t.name,index:t.instanceId})),this._handlers.mousehover.byType.drawable.map(((t,n)=>{t.handler(e,{name:i.id},n)}))}else this._handlers.mousehover.byType.drawable.map(((i,n)=>{i.handler(e,t,n)}));this._lastMouseHoverDrawable=t}else if(this._lastMouseHoverDrawable&&!t){if(this._lastMouseHoverDrawable.name.includes("/iconmodellandmark")||this._lastMouseHoverDrawable.name.includes("/iconmodeltrail")){let t={id:this._lastMouseHoverDrawable.name};void 0!==this._lastMouseHoverDrawable.instanceId&&(t=Ep.instance.getInstancedIconModelLandmarkInfo({name:this._lastMouseHoverDrawable.name,index:this._lastMouseHoverDrawable.instanceId})),this._handlers.unmousehover.byType.drawable.map(((i,n)=>{i.handler(e,{name:t.id},n)}))}else this._handlers.unmousehover.byType.drawable.map(((t,i)=>{t.handler(e,this._lastMouseHoverDrawable,i)}));this._lastMouseHoverDrawable=t}else if(this._lastMouseHoverDrawable&&t){let i=this._lastMouseHoverDrawable;for(;i.parent&&"__objects"!=i.parent.name;)i=i.parent;let n=t;for(;n.parent&&"__objects"!=n.parent.name;)n=n.parent;if(i!==n){let i=this._lastMouseHoverDrawable;if(this._lastMouseHoverDrawable=t,i.name.includes("/iconmodellandmark")||i.name.includes("/iconmodeltrail")){let t={id:i.name};void 0!==i.instanceId&&(t=Ep.instance.getInstancedIconModelLandmarkInfo({name:i.name,index:i.instanceId})),this._handlers.unmousehover.byType.drawable.map(((i,n)=>{i.handler(e,{name:t.id},n)}))}else this._handlers.unmousehover.byType.drawable.map(((t,n)=>{t.handler(e,i,n)}));if(t.name.includes("/iconmodellandmark")||t.name.includes("/iconmodeltrail")){let i={id:t.name};void 0!==t.instanceId&&(i=Ep.instance.getInstancedIconModelLandmarkInfo({name:t.name,index:t.instanceId})),this._handlers.mousehover.byType.drawable.map(((t,n)=>{t.handler(e,{name:i.id},n)}))}else this._handlers.mousehover.byType.drawable.map(((i,n)=>{i.handler(e,t,n)}))}}v[0]&&(r=v[0].object,r.instanceId=v[0].instanceId);const _=Ep.defaultObjectTree.findItemByObject3D(this._lastMouseHoverModel),x=Ep.defaultObjectTree.findItemByObject3D(r);if(!_&&x)n(r);else if(_&&!x)a(this._lastMouseHoverModel);else if(_&&x)if(_.isIconModelIcon&&x.isIconModel&&x.name+"-IconAssect"===_.name)a(this._lastMouseHoverModel,"iconToModel"),n(r,"iconToModel");else if(x.isIconModelIcon&&_.isIconModel&&_.name+"-IconAssect"===x.name)a(this._lastMouseHoverModel,"modelToIcon"),n(r,"modelToIcon");else if(_!==x)a(this._lastMouseHoverModel),n(r);else if("BuildingItem"===x.type){const e=Ep.defaultObjectTree.getParentIds(this._lastMouseHoverModel),t=_y.findObjectToFloor(e),i=_y.findObjectToRoom(e),s=Ep.defaultObjectTree.getParentIds(r),o=_y.findObjectToFloor(s),l=_y.findObjectToRoom(s);t===o&&i===l||(a(this._lastMouseHoverModel),n(r))}this._handlers.mousehover.byType.landmark.length>0&&this._handlers.mousehover.byType.landmark.map(((t,i)=>{u[0]&&t.handler(e,u[0].object,i)})),this._handlers.mousehover.byType.bubble.length>0&&this._handlers.mousehover.byType.bubble.map(((t,i)=>{d[0]&&t.handler(e,d[0].object,i)})),this._handlers.mousehover.byType.bar.length>0&&this._handlers.mousehover.byType.bar.map(((t,i)=>{p[0]&&t.handler(e,p[0].object,i)})),this._handlers.mousehover.byType.odLine.length>0&&this._handlers.mousehover.byType.odLine.map(((t,i)=>{m[0]&&t.handler(e,m[0].object,i)})),this._handlers.mousehover.byType.trail.length>0&&this._handlers.mousehover.byType.trail.map(((t,i)=>{f[0]&&t.handler(e,f[0].object,i)})),this._handlers.mousehover.byType.area.length>0&&this._handlers.mousehover.byType.area.map(((t,i)=>{g[0]&&t.handler(e,g[0].object,i)})),this._handlers.mousehover.byType.scene.length>0&&this._handlers.mousehover.byType.scene.map(((t,i)=>{this._coordinatePass(b[0],e),t.handler(e,b[0].object,i)}))}else if(this._lastMouseHoverModel&&(a(this._lastMouseHoverModel),this._lastMouseHoverModel=null),this._handlers.mousehover.byType.model.length>0&&this._handlers.mousehover.byType.model.map((e=>{e.handler(null)})),this._lastMouseHoverModel&&this._handlers.unmousehover.byType.model.length>0&&this._handlers.unmousehover.byType.model.map(((t,i)=>{t.handler(e,this._lastMouseHoverModel,i)})),this._lastMouseHoverModel&&this._handlers.unmousehover.byType.building.length>0&&this._handlers.unmousehover.byType.building.map(((t,i)=>{t.handler(e,this._lastMouseHoverModel,i)})),this._lastMouseHoverDrawable){if(this._lastMouseHoverDrawable.name.includes("/iconmodellandmark")||this._lastMouseHoverDrawable.name.includes("/iconmodeltrail")){let t={id:this._lastMouseHoverDrawable.name};void 0!==this._lastMouseHoverDrawable.instanceId&&(t=Ep.instance.getInstancedIconModelLandmarkInfo({name:this._lastMouseHoverDrawable.name,index:this._lastMouseHoverDrawable.instanceId})),this._handlers.unmousehover.byType.drawable.map(((i,n)=>{i.handler(e,{name:t.id},n)}))}else this._handlers.unmousehover.byType.drawable.map(((t,i)=>{t.handler(e,this._lastMouseHoverDrawable,i)}));this._lastMouseHoverDrawable=void 0}this.isTesting=!1}onWheel(e){this._handlers.camerazoom.default.length>0&&this._invoke(this._handlers.camerazoom.default,e),this._handlers.camerazoomstop.default.length>0&&(this._cameraStopTimeout&&clearTimeout(this._cameraStopTimeout),this._cameraStopTimeout=setTimeout((()=>{this._invoke(this._handlers.camerazoomstop.default,e)}),this._debounceDelay)),this._handlers.cameramove.default.length>0&&this._handlers.cameramove.default.map((t=>{t.handler(e)}))}trailmove(e){this._handlers.trailmove.default.length>0&&this._handlers.trailmove.default.map(((t,i)=>{t.handler(e,i)}))}_invoke(e,t,i){if(e.length>0)for(let n of e)n.handler(t,i)}_xyzToLLA(e,t,i){if(t.point){let n=i.XYZToLLA({x:t.point.x,y:t.point.y,z:t.point.z},void 0);n&&(e.clickX=t.point.x,e.clickY=t.point.y,e.clickZ=t.point.z,e.longitude=n.x,e.latitude=n.y,e.altitude=n.z,t.point.longitude=n.x,t.point.latitude=n.y,t.point.altitude=n.z)}if(t.object.position){let e=i.XYZToLLA({x:t.object.position.x,y:t.object.position.y,z:t.object.position.z},void 0);e&&(t.object.positionLla={lon:e.x,lat:e.y,alt:e.z})}return t}_coordinatePass(e,t){t.clickX=e.point.x,t.clickY=e.point.y,t.clickZ=e.point.z,t.longitude=e.point.longitude,t.latitude=e.point.latitude,t.altitude=e.point.altitude}_getType(e){let t=e.object.name,i=t.lastIndexOf("/");if(-1==i){if(!(e.object.parent&&e.object.parent.parent&&e.object.parent.parent.name))return t;let n=e.object;for(;n.parent;){if("__objects"==n.parent.name){e.object=n;break}n=n.parent}if(t=e.object.name,i=t.lastIndexOf("/"),-1==i)return t}return t.split("/")[2]}_judegDrawable(e){return"landmark图标"===this._getType(e)||"landmark底图"===this._getType(e)||"landmark文字"===this._getType(e)||"landmark"===this._getType(e)||"bubble"===this._getType(e)||"instancedbubble"===this._getType(e)||"bar"===this._getType(e)||"odline"===this._getType(e)||"trail"===this._getType(e)||"area"===this._getType(e)||"path"===this._getType(e)||"heatmap"===this._getType(e)||"3dmarker"===this._getType(e)||"modellandmark"===this._getType(e)||"modeltrail"===this._getType(e)||"markerlandmark"===this._getType(e)||"starlight"===this._getType(e)||"iconmodellandmark"===this._getType(e)||"iconmodeltrail"===this._getType(e)||"connection"===this._getType(e)}dispose(){this._renderer&&(this._renderer.renderLists&&this._renderer.renderLists.dispose&&this._renderer.renderLists.dispose(),this._renderer.renderLists=null,this._renderer.dispose&&this._renderer.dispose()),this._renderer=null,this._scene=null,this._camera=null,this._raycaster=null,this._mouse=null,this._lastMouseHoverDrawable=null,this._lastMouseHoverModel=null}}var GT=Math.PI/180,VT=180/Math.PI;function WT(e){var t=YT(e[0]+1,e[2]);return[YT(e[0],e[2]),XT(e[1]+1,e[2]),t,XT(e[1],e[2])]}function YT(e,t){return e/Math.pow(2,t)*360-180}function XT(e,t){var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return VT*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))}function ZT(e,t,i){var n=eA(e,t,i);return n[0]=Math.floor(n[0]),n[1]=Math.floor(n[1]),n}function qT(e){return[[2*e[0],2*e[1],e[2]+1],[2*e[0]+1,2*e[1],e[2]+1],[2*e[0]+1,2*e[1]+1,e[2]+1],[2*e[0],2*e[1]+1,e[2]+1]]}function JT(e){return[e[0]>>1,e[1]>>1,e[2]-1]}function QT(e){return qT(JT(e))}function KT(e,t){for(var i=0;i<e.length;i++)if($T(e[i],t))return!0;return!1}function $T(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function eA(e,t,i){var n=Math.sin(t*GT),a=Math.pow(2,i),r=a*(e/360+.5);return(r%=a)<0&&(r+=a),[r,a*(.5-.25*Math.log((1+n)/(1-n))/Math.PI),i]}var tA={tileToGeoJSON:function(e){var t=WT(e);return{type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]}},tileToBBOX:WT,getChildren:qT,getParent:JT,getSiblings:QT,hasTile:KT,hasSiblings:function(e,t){for(var i=QT(e),n=0;n<i.length;n++)if(!KT(t,i[n]))return!1;return!0},tilesEqual:$T,tileToQuadkey:function(e){for(var t="",i=e[2];i>0;i--){var n=0,a=1<<i-1;0!=(e[0]&a)&&n++,0!=(e[1]&a)&&(n+=2),t+=n.toString()}return t},quadkeyToTile:function(e){for(var t=0,i=0,n=e.length,a=n;a>0;a--){var r=1<<a-1,s=+e[n-a];1===s&&(t|=r),2===s&&(i|=r),3===s&&(t|=r,i|=r)}return[t,i,n]},pointToTile:ZT,bboxToTile:function(e){var t=ZT(e[0],e[1],32),i=ZT(e[2],e[3],32),n=[t[0],t[1],i[0],i[1]],a=function(e){for(var t=28,i=0;i<t;i++){var n=1<<32-(i+1);if((e[0]&n)!=(e[2]&n)||(e[1]&n)!=(e[3]&n))return i}return t}(n);return 0===a?[0,0,0]:[n[0]>>>32-a,n[1]>>>32-a,a]},pointToTileFraction:eA};Gm.defs([["EPSG:3035","+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs"]]);class iA{constructor(){this.projection=null,this.location=null,this.globalOffset=new ye,this.sceneScale=1,this.center=new ye(0,0),this.center3035=new ye(0,0),this.projector=null}setCurrentPlace(e){this.location=[e.longitude,e.latitude],this.projection="EPSG:3857";const t=this.location[0],i=this.location[1];this.projector=Gm(this.projection),this.center=this.project([t,i],!0),this.projector3035=Gm("EPSG:3035");var n=this.projector3035.forward([t,i]);this.center3035={x:n[0],y:n[1]},this.sceneScale=this.calculateSceneScale(t,i),this.globalOffset=this.calculateGlobalOffset(t,i),Ep.pgl.heightUniforms&&Ep.pgl.heightUniforms.update({sceneScale:this.sceneScale,globalOffset:this.globalOffset})}positionToTileFraction(e,t){const i=e.clone();return i.x-=this.globalOffset.x,i.y+=this.globalOffset.y,i.divideScalar(this.sceneScale*Math.pow(2,15-t)),[i.x,i.y,t]}calculateGlobalOffset(e,t){const[i,n,a]=tA.pointToTileFraction(e,t,7),r=Math.pow(2,15-a)*this.calculateSceneScale(e,t);return new ye(-i,n).multiplyScalar(r)}calculateSceneScale(e,t){var i=tA.pointToTile(e,t,15),n=tA.tileToBBOX(i);return this.project([n[2],n[3]]).sub(this.project([n[0],n[1]])).x}project(e,t){if("number"!=typeof e[0])return e.map((e=>this.project(e,t)));var i=this.projector.forward(e);return t||(i[0]-=this.center.x,i[1]-=this.center.y),new Ce(i[0],i[1],e[2])}unproject(e,t){if(Array.isArray(e))return e.map((e=>this.unproject(e,t)));var i=[e.x,e.y];t||(i[0]+=this.center.x,i[1]+=this.center.y);var n=this.projector.inverse(i);return[n[0],n[1],e.z]}unproject3035(e,t){if(Array.isArray(e[0]))return e.map((e=>this.unproject3035(e,t)));var i=[e[0],e[1]];t||(i[0]+=this.center3035.x,i[1]+=this.center3035.y);var n=this.projector3035.inverse(i);return[n[0],n[1],e.z]}vectorize(e){if("number"!=typeof e[0]){for(var t=new Array(e.length),i=0,n=e.length;i<n;i++)t[i]=this.vectorize(e[i]);return t}return new Ce(e[0],e[1],e[2])}vectorizeFeature(e){return e.projected?this.vectorize(e.geometry.coordinates):this.project(e.geometry.coordinates)}}let nA=new URLSearchParams(window.location.search.slice(1)),aA=64,rA=256;nA.has("elevationPoolSize")&&(aA=Number.parseInt(nA.get("elevationPoolSize"))),nA.has("imageryPoolSize")&&(rA=Number.parseInt(nA.get("imageryPoolSize")));const sA=aA,oA=512,lA=rA,cA=nA.has("interpolateFloat"),hA="nasadem",uA="terrarium",dA="terrain-rgb",pA="greyscale-rgba";class mA{constructor(e){this.capacity=e,this.index=0,this.items=[]}next(){let e;return e=this.index>=this.capacity?this.items.splice(0,1)[0]:this.index++,this.items.push(e),e}tap(e){let t=this.items.indexOf(e);-1!==t&&(this.items.splice(t,1),this.items.push(e))}}class fA{constructor(e){this.size=e,this.data=new Float32Array(4*e*e)}set(e,t,i,n,a){this.data[4*e]=t,this.data[4*e+1]=i,this.data[4*e+2]=n,this.data[4*e+3]=a}fillRect(e,t,i,n,a,r,s){if(t<=0||i<=0)return;if(t===this.size||i===this.size)return void this.fill(n,a,r,s);this.set(e,n,a,r,s);for(let i=1;i<t;i*=2){let n=e+i,a=Math.min(i,t-i);this.data.set(this.data.subarray(4*e,4*(e+a)),4*n)}const o=this.data.subarray(4*e,4*(e+t));for(let t=1;t<i;t++){let i=e+this.size*t;this.data.set(o,4*i)}}fill(e,t,i,n){this.set(0,e,t,i,n);for(let e=1,t=this.size*this.size;e<t;e*=2)this.data.set(this.data.subarray(0,4*e),4*e)}}var gA=new("undefined"==typeof createImageBitmap?tl:ic);const yA=document.createElement("canvas"),vA=oA,bA=oA;yA.width=vA,yA.height=bA;const _A=yA.getContext("2d"),xA=262144,wA=(e,t,i)=>{const n=e.image.width/e.__blocks,a=e.image.height/e.__blocks,r=n*(Math.floor(t)%e.__blocks),s=a*Math.floor(Math.floor(t)/e.__blocks);if(e.useFloat){_A.drawImage(i,0,0);let t=_A.getImageData(0,0,vA,bA).data,n=new Float32Array(xA);if(e.pixelEncoding===hA){const e=-32768;let i=new DataView(t.buffer);for(let t=0;t<xA;++t){let a=i.getUint16(4*t,!1)+e;n[t]=a===e?0:a}}else{let i;e.pixelEncoding===uA?i=[256,1,1/256,-32768]:e.pixelEncoding===dA?i=[6553.6,25.6,.1,-1e4]:e.pixelEncoding===pA&&(i=[0,0,1e4/255*1,-1]);for(let e=0;e<xA;++e){let a=i[0]*t[4*e]+i[1]*t[4*e+1]+i[2]*t[4*e+2]+i[3];n[e]=a===i[3]?0:a}}Ep.renderer.copyTextureToTexture({x:r,y:s},{image:{data:n,width:vA,height:bA},isDataTexture:!0},e)}else Ep.renderer.copyTextureToTexture({x:r,y:s},{image:i},e)};let SA=!1;const MA=(e,t,i)=>{let n=CA(e),a=CA(t);if(!SA){for(let e=0;e<a.length;e++)a[e];SA=!0}let r=new yw.PNG({width:e.width,height:e.height,filterType:4});for(let e=0;e<r.data.length;e+=4)if(a[e+3]>0){const t=a[e+3]/255;r.data[e+0]=Math.round(n[e+0]*(1-t)+a[e+0]*t),r.data[e+1]=Math.round(n[e+1]*(1-t)+a[e+1]*t),r.data[e+2]=Math.round(n[e+2]*(1-t)+a[e+2]*t),r.data[e+3]=n[e+3]}else r.data[e+0]=n[e+0],r.data[e+1]=n[e+1],r.data[e+2]=n[e+2],r.data[e+3]=n[e+3];r.pack();var s=yw.PNG.sync.write(r,{colorType:6});const o=new Blob([s]);createImageBitmap(o).then(i)};let TA=document.createElement("canvas").getContext("webgl2");TA.activeTexture(TA.TEXTURE0);let AA=TA.createTexture();TA.bindTexture(TA.TEXTURE_2D,AA);const EA=TA.createFramebuffer();function CA(e){TA.framebufferTexture2D(TA.FRAMEBUFFER,TA.COLOR_ATTACHMENT0,TA.TEXTURE_2D,AA,0),TA.texImage2D(TA.TEXTURE_2D,0,TA.RGBA,TA.RGBA,TA.UNSIGNED_BYTE,e),TA.drawBuffers([TA.COLOR_ATTACHMENT0]);let t=new Uint8Array(e.width*e.height*4);return TA.readPixels(0,0,e.width,e.height,TA.RGBA,TA.UNSIGNED_BYTE,t),t}TA.bindFramebuffer(TA.FRAMEBUFFER,EA);class IA{constructor({apiKey:e,maxZoom:t,pixelEncoding:i,poolSize:n,textureSize:a,useFloat:s,urlFormat:o,disabled:l,flipY:c}){this.apiKey=e,this.maxZoom=t,this.urlFormat=o,this.pixelEncoding=i,this.useFloat=!!s,this.hasUpdates=!1,this.listeners=[],this.lookup={},this.fetching={},this.overlayFetching={},this.imgCache={},this.imgOverlayCache=[],this.indexPool=new mA(n),this.disabled=l,this.flipY=c;let h=Math.sqrt(n);h%1&&console.error("poolSize needs to be a power of 2");let u=a*h;const d=this.useFloat&&!cA?g:b;this.textureArray=new $i(null,u,u,this.useFloat?D:I,this.useFloat?T:w,r,m,m,d,d,Ep.renderer.capabilities.getMaxAnisotropy()),this.textureArray.__blocks=h;for(let e of["pixelEncoding","useFloat"])Object.defineProperty(this.textureArray,e,{get:()=>this[e]});if(this.useFloat){const e=1024;this.indirectionData=new fA(e),this.indirectionTexture=new $i(null,e,e,I,T,r,m,m,g,g,1)}}urlForTile(e,t,i){if(this.urlFormat instanceof Array){const n=[];for(let a of this.urlFormat)n.push(a.replace("{x}",e).replace("{y}",this.flipY?Math.pow(2,i)-1-t:t).replace("{z}",i).replace("{apiKey}",this.apiKey));return n}return this.urlFormat.replace("{x}",e).replace("{y}",this.flipY?Math.pow(2,i)-1-t:t).replace("{z}",i).replace("{apiKey}",this.apiKey)}fetchIfNeeded(e){if(void 0!==this.lookup[e]||void 0!==this.fetching[e])return;if(Object.values(this.fetching).length>32)return;let t=this.findNewIndex(e);if(this.fetching[e]=t,this.disabled)return void delete this.fetching[e];let i=this.urlForTile(...tA.quadkeyToTile(e));i instanceof Array?(Ep.gisStore.checkAddress(i[0]),gA.load(i.shift(),(n=>{this.imgCache[e]=n,wA(this.textureArray,t,n),delete this.fetching[e],this.lookup[e]=t,this.updateIndirectionTexture(),this.notifyUpdate();for(let n in i)gA.load(i[n],(i=>{this.imgOverlayCache[n]=this.imgOverlayCache[n]||{},this.imgOverlayCache[n][e]=i,MA(this.imgCache[e],this.imgOverlayCache[n][e],(i=>{this.imgCache[e]=i,wA(this.textureArray,t,this.imgCache[e]),this.notifyUpdate()}))}),(()=>{delete this.fetching[e]}))}),(()=>{}),(()=>{delete this.fetching[e]}))):(Ep.gisStore.checkAddress(i),gA.load(i,(i=>{this.imgCache[e]=i,wA(this.textureArray,t,i),delete this.fetching[e],this.lookup[e]=t,this.updateIndirectionTexture(),this.notifyUpdate()}),(()=>{}),(()=>{delete this.fetching[e]})))}findNewIndex(e){let t,i,n=Object.values(this.fetching),a=!0;for(let r=32;r>0;r--){t=this.indexPool.next();let r=-1===n.indexOf(t),s=Object.values(this.lookup).indexOf(t);i=Object.keys(this.lookup)[s];let o=void 0!==i&&e.slice(0,i.length-1)===i.slice(0,-1);if(r&&!o){a=!1;break}}return a&&(i=Object.keys(this.lookup).sort(((e,t)=>e.length-t.length))[0],t=this.lookup[i]),void 0!==i&&delete this.lookup[i],t}updateIndirectionTexture(){if(this.indirectionTexture){const e=this.indirectionData.size;let t,i=Object.keys(this.lookup);i.sort(((e,t)=>Math.sign(e.length-t.length)));let n={startX:e,endX:0,startY:e,endY:0};t=this.lastQuadkeys?[...i.filter((e=>!this.lastQuadkeys.includes(e))),...this.lastQuadkeys.filter((e=>!i.includes(e)))]:i,this.lastQuadkeys=[...i];for(let i of t){let[t,a,r]=tA.quadkeyToTile(i),s=Math.pow(2,this.maxZoom-r);t*=s,a*=s;let o=t%e,l=a%e,c=o+s,h=l+s;n.startX=Math.min(n.startX,o),n.endX=Math.max(n.endX,c),n.startY=Math.min(n.startY,l),n.endY=Math.max(n.endY,h)}for(let t of i){let[i,a,r]=tA.quadkeyToTile(t),s=this.lookup[t],o=Math.pow(2,this.maxZoom-r);i*=o,a*=o;let l=this.maxZoom-10,c=Math.pow(2,r-l),h=-c/e,u=i%e,d=a%e,p=u+o,m=d+o;u=Math.max(u,n.startX),d=Math.max(d,n.startY),p=Math.min(p,n.endX),m=Math.min(m,n.endY);let f=u+e*d,g=p-u,y=m-d;this.indirectionData.fillRect(f,g,y,s,c,i*h,a*h)}const a=n.endY-n.startY;let r=this.indirectionData.data.subarray(4*e*n.startY,4*e*n.endY);Ep.renderer.copyTextureToTexture({x:0,y:n.startY},{image:{data:r,width:e,height:a},isDataTexture:!0},this.indirectionTexture)}}findBestAvailableData(e,t){for(let t=0;t<20;t++){let i=this.lookup[e];if(void 0!==i)return{index:i,downsample:t,quadkey:e};if(0===(e=e.slice(0,-1)).length)break}return{index:null,downsample:20,quadkey:null}}dataAtPoint(e){let t;t=e.longitude?tA.pointToTileFraction(e.longitude,e.latitude,10):Ep.pgl.geoproject.positionToTileFraction(e,10);const i=tA.tileToQuadkey(t),{quadkey:n}=this.findBestAvailableData(i);if(!n)return null;const a=Math.pow(2,n.length-t[2]);t[0]*=a,t[1]*=a;const r=this.imgCache[n],s=document.createElement("canvas");s.width=1,s.height=1,t[0]=t[0]%1*r.width,t[1]=t[1]%1*r.height;const o=s.getContext("2d");return o.drawImage(r,t[0],t[1],1,1,0,0,1,1),o.getImageData(0,0,1,1).data}addListener(e){this.listeners.push(e)}removeListener(e){let t=this.listeners.indexOf(e);-1!==t&&this.listeners.splice(t,1)}notifyUpdate(){this.hasUpdates=!0}broadcastUpdate(){this.listeners.forEach((e=>e())),this.hasUpdates=!1}}
/**
   * @license
   * lodash 3.10.1 (Custom Build) <https://lodash.com/>
   * Build: `lodash modern -d -o ./index.js`
   * Copyright 2012-2015 The Dojo Foundation <http://dojofoundation.org/>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   * Available under MIT license <https://lodash.com/license>
   */var PA=Ug((function(e,t){(function(){var i,n,a,r=32,s=64,o=128,l=256,c=200,h="Expected a function",u="__lodash_placeholder__",d="[object Arguments]",p="[object Array]",m="[object Boolean]",f="[object Date]",g="[object Error]",y="[object Function]",v="[object Map]",b="[object Number]",_="[object Object]",x="[object RegExp]",w="[object Set]",S="[object String]",M="[object WeakMap]",T="[object ArrayBuffer]",A="[object Float32Array]",E="[object Float64Array]",C="[object Int8Array]",I="[object Int16Array]",P="[object Int32Array]",R="[object Uint8Array]",O="[object Uint8ClampedArray]",D="[object Uint16Array]",L="[object Uint32Array]",k=/\b__p \+= '';/g,N=/\b(__p \+=) '' \+/g,B=/(__e\(.*?\)|\b__t\)) \+\n'';/g,z=/&(?:amp|lt|gt|quot|#39|#96);/g,U=/[&<>"'`]/g,F=RegExp(z.source),j=RegExp(U.source),H=/<%-([\s\S]+?)%>/g,G=/<%([\s\S]+?)%>/g,V=/<%=([\s\S]+?)%>/g,W=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\n\\]|\\.)*?\1)\]/,Y=/^\w*$/,X=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\n\\]|\\.)*?)\2)\]/g,Z=/^[:!,]|[\\^$.*+?()[\]{}|\/]|(^[0-9a-fA-Fnrtuvx])|([\n\r\u2028\u2029])/g,q=RegExp(Z.source),J=/[\u0300-\u036f\ufe20-\ufe23]/g,Q=/\\(\\)?/g,K=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,$=/\w*$/,ee=/^0[xX]/,te=/^\[object .+?Constructor\]$/,ie=/^\d+$/,ne=/[\xc0-\xd6\xd8-\xde\xdf-\xf6\xf8-\xff]/g,ae=/($^)/,re=/['\n\r\u2028\u2029\\]/g,se=(n="[A-Z\\xc0-\\xd6\\xd8-\\xde]",a="[a-z\\xdf-\\xf6\\xf8-\\xff]+",RegExp(n+"+(?="+n+a+")|"+n+"?"+a+"|"+n+"+|[0-9]+","g")),oe=["Array","ArrayBuffer","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Math","Number","Object","RegExp","Set","String","_","clearTimeout","isFinite","parseFloat","parseInt","setTimeout","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap"],le=-1,ce={};ce[A]=ce[E]=ce[C]=ce[I]=ce[P]=ce[R]=ce[O]=ce[D]=ce[L]=!0,ce[d]=ce[p]=ce[T]=ce[m]=ce[f]=ce[g]=ce[y]=ce[v]=ce[b]=ce[_]=ce[x]=ce[w]=ce[S]=ce[M]=!1;var he={};he[d]=he[p]=he[T]=he[m]=he[f]=he[A]=he[E]=he[C]=he[I]=he[P]=he[b]=he[_]=he[x]=he[S]=he[R]=he[O]=he[D]=he[L]=!0,he[g]=he[y]=he[v]=he[w]=he[M]=!1;var ue={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss"},de={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},pe={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},me={function:!0,object:!0},fe={0:"x30",1:"x31",2:"x32",3:"x33",4:"x34",5:"x35",6:"x36",7:"x37",8:"x38",9:"x39",A:"x41",B:"x42",C:"x43",D:"x44",E:"x45",F:"x46",a:"x61",b:"x62",c:"x63",d:"x64",e:"x65",f:"x66",n:"x6e",r:"x72",t:"x74",u:"x75",v:"x76",x:"x78"},ge={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},ye=t&&!t.nodeType&&t,ve=e&&!e.nodeType&&e,be=ye&&ve&&"object"==typeof Bg&&Bg&&Bg.Object&&Bg,_e=me[typeof self]&&self&&self.Object&&self,xe=me[typeof window]&&window&&window.Object&&window,we=ve&&ve.exports===ye&&ye,Se=be||xe!==(this&&this.window)&&xe||_e||this;function Me(e,t){if(e!==t){var n=null===e,a=e===i,r=e==e,s=null===t,o=t===i,l=t==t;if(e>t&&!s||!r||n&&!o&&l||a&&l)return 1;if(e<t&&!n||!l||s&&!a&&r||o&&r)return-1}return 0}function Te(e,t,i){for(var n=e.length,a=i?n:-1;i?a--:++a<n;)if(t(e[a],a,e))return a;return-1}function Ae(e,t,i){if(t!=t)return Ne(e,i);for(var n=i-1,a=e.length;++n<a;)if(e[n]===t)return n;return-1}function Ee(e){return"function"==typeof e||!1}function Ce(e){return null==e?"":e+""}function Ie(e,t){for(var i=-1,n=e.length;++i<n&&t.indexOf(e.charAt(i))>-1;);return i}function Pe(e,t){for(var i=e.length;i--&&t.indexOf(e.charAt(i))>-1;);return i}function Re(e,t){return Me(e.criteria,t.criteria)||e.index-t.index}function Oe(e){return ue[e]}function De(e){return de[e]}function Le(e,t,i){return t?e=fe[e]:i&&(e=ge[e]),"\\"+e}function ke(e){return"\\"+ge[e]}function Ne(e,t,i){for(var n=e.length,a=t+(i?0:-1);i?a--:++a<n;){var r=e[a];if(r!=r)return a}return-1}function Be(e){return!!e&&"object"==typeof e}function ze(e){return e<=160&&e>=9&&e<=13||32==e||160==e||5760==e||6158==e||e>=8192&&(e<=8202||8232==e||8233==e||8239==e||8287==e||12288==e||65279==e)}function Ue(e,t){for(var i=-1,n=e.length,a=-1,r=[];++i<n;)e[i]===t&&(e[i]=u,r[++a]=i);return r}function Fe(e){for(var t=-1,i=e.length;++t<i&&ze(e.charCodeAt(t)););return t}function je(e){for(var t=e.length;t--&&ze(e.charCodeAt(t)););return t}function He(e){return pe[e]}var Ge=function e(t){var n=(t=t?Ge.defaults(Se.Object(),t,Ge.pick(Se,oe)):Se).Array,a=t.Date,v=t.Error,w=t.Function,M=t.Math,ue=t.Number,de=t.Object,pe=t.RegExp,me=t.String,fe=t.TypeError,ge=n.prototype,ye=de.prototype,ve=me.prototype,be=w.prototype.toString,_e=ye.hasOwnProperty,xe=0,we=ye.toString,ze=Se._,Ve=pe("^"+be.call(_e).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),We=t.ArrayBuffer,Ye=t.clearTimeout,Xe=t.parseFloat,Ze=M.pow,qe=ye.propertyIsEnumerable,Je=ln(t,"Set"),Qe=t.setTimeout,Ke=ge.splice,$e=t.Uint8Array,et=ln(t,"WeakMap"),tt=M.ceil,it=ln(de,"create"),nt=M.floor,at=ln(n,"isArray"),rt=t.isFinite,st=ln(de,"keys"),ot=M.max,lt=M.min,ct=ln(a,"now"),ht=t.parseInt,ut=M.random,dt=ue.NEGATIVE_INFINITY,pt=ue.POSITIVE_INFINITY,mt=4294967295,ft=9007199254740991,gt=et&&new et,yt={};function vt(e){if(Be(e)&&!Ba(e)&&!(e instanceof xt)){if(e instanceof _t)return e;if(_e.call(e,"__chain__")&&_e.call(e,"__wrapped__"))return En(e)}return new _t(e)}function bt(){}function _t(e,t,i){this.__wrapped__=e,this.__actions__=i||[],this.__chain__=!!t}function xt(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=pt,this.__views__=[]}function wt(){this.__data__={}}function St(e){var t=e?e.length:0;for(this.data={hash:it(null),set:new Je};t--;)this.push(e[t])}function Mt(e,t){var i=e.data;return("string"==typeof t||ja(t)?i.set.has(t):i.hash[t])?0:-1}function Tt(e,t){var i=-1,a=e.length;for(t||(t=n(a));++i<a;)t[i]=e[i];return t}function At(e,t){for(var i=-1,n=e.length;++i<n&&!1!==t(e[i],i,e););return e}function Et(e,t){for(var i=-1,n=e.length;++i<n;)if(!t(e[i],i,e))return!1;return!0}function Ct(e,t){for(var i=-1,n=e.length,a=-1,r=[];++i<n;){var s=e[i];t(s,i,e)&&(r[++a]=s)}return r}function It(e,t){for(var i=-1,a=e.length,r=n(a);++i<a;)r[i]=t(e[i],i,e);return r}function Pt(e,t){for(var i=-1,n=t.length,a=e.length;++i<n;)e[a+i]=t[i];return e}function Rt(e,t,i,n){var a=-1,r=e.length;for(n&&r&&(i=e[++a]);++a<r;)i=t(i,e[a],a,e);return i}function Ot(e,t){for(var i=-1,n=e.length;++i<n;)if(t(e[i],i,e))return!0;return!1}function Dt(e,t,n,a){return e!==i&&_e.call(a,n)?e:t}function Lt(e,t,n){for(var a=-1,r=lr(t),s=r.length;++a<s;){var o=r[a],l=e[o],c=n(l,t[o],o,e,t);((c==c?c!==l:l==l)||l===i&&!(o in e))&&(e[o]=c)}return e}function kt(e,t){return null==t?e:Bt(t,lr(t),e)}function Nt(e,t){for(var a=-1,r=null==e,s=!r&&hn(e),o=s?e.length:0,l=t.length,c=n(l);++a<l;){var h=t[a];c[a]=s?un(h,o)?e[h]:i:r?i:e[h]}return c}function Bt(e,t,i){i||(i={});for(var n=-1,a=t.length;++n<a;){var r=t[n];i[r]=e[r]}return i}function zt(e,t,n){var a=typeof e;return"function"==a?t===i?e:wi(e,t,n):null==e?Cr:"object"==a?ri(e):t===i?Lr(e):si(e,t)}function Ut(e,t,n,a,r,s,o){var l;if(n&&(l=r?n(e,a,r):n(e)),l!==i)return l;if(!ja(e))return e;var c=Ba(e);if(c){if(l=function(e){var t=e.length,i=new e.constructor(t);t&&"string"==typeof e[0]&&_e.call(e,"index")&&(i.index=e.index,i.input=e.input);return i}(e),!t)return Tt(e,l)}else{var h=we.call(e),u=h==y;if(h!=_&&h!=d&&(!u||r))return he[h]?function(e,t,i){var n=e.constructor;switch(t){case T:return Si(e);case m:case f:return new n(+e);case A:case E:case C:case I:case P:case R:case O:case D:case L:var a=e.buffer;return new n(i?Si(a):a,e.byteOffset,e.length);case b:case S:return new n(e);case x:var r=new n(e.source,$.exec(e));r.lastIndex=e.lastIndex}return r}(e,h,t):r?e:{};if(l=function(e){var t=e.constructor;"function"==typeof t&&t instanceof t||(t=de);return new t}(u?{}:e),!t)return kt(l,e)}s||(s=[]),o||(o=[]);for(var p=s.length;p--;)if(s[p]==e)return o[p];return s.push(e),o.push(l),(c?At:Kt)(e,(function(i,a){l[a]=Ut(i,t,n,a,e,s,o)})),l}vt.support={},vt.templateSettings={escape:H,evaluate:G,interpolate:V,variable:"",imports:{_:vt}};var Ft=function(){function e(){}return function(t){if(ja(t)){e.prototype=t;var n=new e;e.prototype=i}return n||{}}}();function jt(e,t,n){if("function"!=typeof e)throw new fe(h);return Qe((function(){e.apply(i,n)}),t)}function Ht(e,t){var i=e?e.length:0,n=[];if(!i)return n;var a=-1,r=rn(),s=r==Ae,o=s&&t.length>=c?Pi(t):null,l=t.length;o&&(r=Mt,s=!1,t=o);e:for(;++a<i;){var h=e[a];if(s&&h==h){for(var u=l;u--;)if(t[u]===h)continue e;n.push(h)}else r(t,h,0)<0&&n.push(h)}return n}var Gt=Ci(Kt),Vt=Ci($t,!0);function Wt(e,t){var i=!0;return Gt(e,(function(e,n,a){return i=!!t(e,n,a)})),i}function Yt(e,t){var i=[];return Gt(e,(function(e,n,a){t(e,n,a)&&i.push(e)})),i}function Xt(e,t,i,n){var a;return i(e,(function(e,i,r){if(t(e,i,r))return a=n?i:e,!1})),a}function Zt(e,t,i,n){n||(n=[]);for(var a=-1,r=e.length;++a<r;){var s=e[a];Be(s)&&hn(s)&&(i||Ba(s)||Na(s))?t?Zt(s,t,i,n):Pt(n,s):i||(n[n.length]=s)}return n}var qt=Ii(),Jt=Ii(!0);function Qt(e,t){return qt(e,t,cr)}function Kt(e,t){return qt(e,t,lr)}function $t(e,t){return Jt(e,t,lr)}function ei(e,t){for(var i=-1,n=t.length,a=-1,r=[];++i<n;){var s=t[i];Fa(e[s])&&(r[++a]=s)}return r}function ti(e,t,n){if(null!=e){n!==i&&n in Tn(e)&&(t=[n]);for(var a=0,r=t.length;null!=e&&a<r;)e=e[t[a++]];return a&&a==r?e:i}}function ii(e,t,i,n,a,r){return e===t||(null==e||null==t||!ja(e)&&!Be(t)?e!=e&&t!=t:function(e,t,i,n,a,r,s){var o=Ba(e),l=Ba(t),c=p,h=p;o||((c=we.call(e))==d?c=_:c!=_&&(o=Xa(e)));l||((h=we.call(t))==d?h=_:h!=_&&(l=Xa(t)));var u=c==_,y=h==_,v=c==h;if(v&&!o&&!u)return function(e,t,i){switch(i){case m:case f:return+e==+t;case g:return e.name==t.name&&e.message==t.message;case b:return e!=+e?t!=+t:e==+t;case x:case S:return e==t+""}return!1}(e,t,c);if(!a){var w=u&&_e.call(e,"__wrapped__"),M=y&&_e.call(t,"__wrapped__");if(w||M)return i(w?e.value():e,M?t.value():t,n,a,r,s)}if(!v)return!1;r||(r=[]),s||(s=[]);var T=r.length;for(;T--;)if(r[T]==e)return s[T]==t;r.push(e),s.push(t);var A=(o?$i:en)(e,t,i,n,a,r,s);return r.pop(),s.pop(),A}(e,t,ii,i,n,a,r))}function ni(e,t,n){var a=t.length,r=a,s=!n;if(null==e)return!r;for(e=Tn(e);a--;){var o=t[a];if(s&&o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++a<r;){var l=(o=t[a])[0],c=e[l],h=o[1];if(s&&o[2]){if(c===i&&!(l in e))return!1}else{var u=n?n(c,h,l):i;if(!(u===i?ii(h,c,n,!0):u))return!1}}return!0}function ai(e,t){var i=-1,a=hn(e)?n(e.length):[];return Gt(e,(function(e,n,r){a[++i]=t(e,n,r)})),a}function ri(e){var t=on(e);if(1==t.length&&t[0][2]){var n=t[0][0],a=t[0][1];return function(e){return null!=e&&(e[n]===a&&(a!==i||n in Tn(e)))}}return function(e){return ni(e,t)}}function si(e,t){var n=Ba(e),a=pn(e)&&gn(t),r=e+"";return e=An(e),function(s){if(null==s)return!1;var o=r;if(s=Tn(s),(n||!a)&&!(o in s)){if(null==(s=1==e.length?s:ti(s,di(e,0,-1))))return!1;o=Nn(e),s=Tn(s)}return s[o]===t?t!==i||o in s:ii(t,s[o],i,!0)}}function oi(e){return function(t){return null==t?i:t[e]}}function li(e,t){for(var i=e?t.length:0;i--;){var n=t[i];if(n!=a&&un(n)){var a=n;Ke.call(e,n,1)}}return e}function ci(e,t){return e+nt(ut()*(t-e+1))}function hi(e,t,i,n,a){return a(e,(function(e,a,r){i=n?(n=!1,e):t(i,e,a,r)})),i}var ui=gt?function(e,t){return gt.set(e,t),e}:Cr;function di(e,t,a){var r=-1,s=e.length;(t=null==t?0:+t||0)<0&&(t=-t>s?0:s+t),(a=a===i||a>s?s:+a||0)<0&&(a+=s),s=t>a?0:a-t>>>0,t>>>=0;for(var o=n(s);++r<s;)o[r]=e[r+t];return o}function pi(e,t){var i;return Gt(e,(function(e,n,a){return!(i=t(e,n,a))})),!!i}function mi(e,t){var i=e.length;for(e.sort(t);i--;)e[i]=e[i].value;return e}function fi(e,t,i){var n=tn(),a=-1;return t=It(t,(function(e){return n(e)})),mi(ai(e,(function(e){return{criteria:It(t,(function(t){return t(e)})),index:++a,value:e}})),(function(e,t){return function(e,t,i){for(var n=-1,a=e.criteria,r=t.criteria,s=a.length,o=i.length;++n<s;){var l=Me(a[n],r[n]);if(l){if(n>=o)return l;var c=i[n];return l*("asc"===c||!0===c?1:-1)}}return e.index-t.index}(e,t,i)}))}function gi(e,t){var i=-1,n=rn(),a=e.length,r=n==Ae,s=r&&a>=c,o=s?Pi():null,l=[];o?(n=Mt,r=!1):(s=!1,o=t?[]:l);e:for(;++i<a;){var h=e[i],u=t?t(h,i,e):h;if(r&&h==h){for(var d=o.length;d--;)if(o[d]===u)continue e;t&&o.push(u),l.push(h)}else n(o,u,0)<0&&((t||s)&&o.push(u),l.push(h))}return l}function yi(e,t){for(var i=-1,a=t.length,r=n(a);++i<a;)r[i]=e[t[i]];return r}function vi(e,t,i,n){for(var a=e.length,r=n?a:-1;(n?r--:++r<a)&&t(e[r],r,e););return i?di(e,n?0:r,n?r+1:a):di(e,n?r+1:0,n?a:r)}function bi(e,t){var i=e;i instanceof xt&&(i=i.value());for(var n=-1,a=t.length;++n<a;){var r=t[n];i=r.func.apply(r.thisArg,Pt([i],r.args))}return i}function _i(e,t,i){var n=0,a=e?e.length:n;if("number"==typeof t&&t==t&&a<=2147483647){for(;n<a;){var r=n+a>>>1,s=e[r];(i?s<=t:s<t)&&null!==s?n=r+1:a=r}return a}return xi(e,t,Cr,i)}function xi(e,t,n,a){t=n(t);for(var r=0,s=e?e.length:0,o=t!=t,l=null===t,c=t===i;r<s;){var h=nt((r+s)/2),u=n(e[h]),d=u!==i,p=u==u;if(o)var m=p||a;else m=l?p&&d&&(a||null!=u):c?p&&(a||d):null!=u&&(a?u<=t:u<t);m?r=h+1:s=h}return lt(s,4294967294)}function wi(e,t,n){if("function"!=typeof e)return Cr;if(t===i)return e;switch(n){case 1:return function(i){return e.call(t,i)};case 3:return function(i,n,a){return e.call(t,i,n,a)};case 4:return function(i,n,a,r){return e.call(t,i,n,a,r)};case 5:return function(i,n,a,r,s){return e.call(t,i,n,a,r,s)}}return function(){return e.apply(t,arguments)}}function Si(e){var t=new We(e.byteLength);return new $e(t).set(new $e(e)),t}function Mi(e,t,i){for(var a=i.length,r=-1,s=ot(e.length-a,0),o=-1,l=t.length,c=n(l+s);++o<l;)c[o]=t[o];for(;++r<a;)c[i[r]]=e[r];for(;s--;)c[o++]=e[r++];return c}function Ti(e,t,i){for(var a=-1,r=i.length,s=-1,o=ot(e.length-r,0),l=-1,c=t.length,h=n(o+c);++s<o;)h[s]=e[s];for(var u=s;++l<c;)h[u+l]=t[l];for(;++a<r;)h[u+i[a]]=e[s++];return h}function Ai(e,t){return function(i,n,a){var r=t?t():{};if(n=tn(n,a,3),Ba(i))for(var s=-1,o=i.length;++s<o;){var l=i[s];e(r,l,n(l,s,i),i)}else Gt(i,(function(t,i,a){e(r,t,n(t,i,a),a)}));return r}}function Ei(e){return La((function(t,n){var a=-1,r=null==t?0:n.length,s=r>2?n[r-2]:i,o=r>2?n[2]:i,l=r>1?n[r-1]:i;for("function"==typeof s?(s=wi(s,l,5),r-=2):r-=(s="function"==typeof l?l:i)?1:0,o&&dn(n[0],n[1],o)&&(s=r<3?i:s,r=1);++a<r;){var c=n[a];c&&e(t,c,s)}return t}))}function Ci(e,t){return function(i,n){var a=i?sn(i):0;if(!fn(a))return e(i,n);for(var r=t?a:-1,s=Tn(i);(t?r--:++r<a)&&!1!==n(s[r],r,s););return i}}function Ii(e){return function(t,i,n){for(var a=Tn(t),r=n(t),s=r.length,o=e?s:-1;e?o--:++o<s;){var l=r[o];if(!1===i(a[l],l,a))break}return t}}function Pi(e){return it&&Je?new St(e):null}function Ri(e){return function(t){for(var i=-1,n=Tr(yr(t)),a=n.length,r="";++i<a;)r=e(r,n[i],i);return r}}function Oi(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var i=Ft(e.prototype),n=e.apply(i,t);return ja(n)?n:i}}function Di(e){return function t(n,a,r){r&&dn(n,a,r)&&(a=i);var s=Ki(n,e,i,i,i,i,i,a);return s.placeholder=t.placeholder,s}}function Li(e,t){return La((function(n){var a=n[0];return null==a?a:(n.push(t),e.apply(i,n))}))}function ki(e,t){return function(n,a,r){if(r&&dn(n,a,r)&&(a=i),1==(a=tn(a,r,3)).length){var s=function(e,t,i,n){for(var a=-1,r=e.length,s=n,o=s;++a<r;){var l=e[a],c=+t(l);i(c,s)&&(s=c,o=l)}return o}(n=Ba(n)?n:Mn(n),a,e,t);if(!n.length||s!==t)return s}return function(e,t,i,n){var a=n,r=a;return Gt(e,(function(e,s,o){var l=+t(e,s,o);(i(l,a)||l===n&&l===r)&&(a=l,r=e)})),r}(n,a,e,t)}}function Ni(e,t){return function(n,a,r){if(a=tn(a,r,3),Ba(n)){var s=Te(n,a,t);return s>-1?n[s]:i}return Xt(n,a,e)}}function Bi(e){return function(t,i,n){return t&&t.length?Te(t,i=tn(i,n,3),e):-1}}function zi(e){return function(t,i,n){return Xt(t,i=tn(i,n,3),e,!0)}}function Ui(e){return function(){for(var t,a=arguments.length,r=e?a:-1,s=0,o=n(a);e?r--:++r<a;){var l=o[s++]=arguments[r];if("function"!=typeof l)throw new fe(h);!t&&_t.prototype.thru&&"wrapper"==an(l)&&(t=new _t([],!0))}for(r=t?-1:a;++r<a;){var u=an(l=o[r]),d="wrapper"==u?nn(l):i;t=d&&mn(d[0])&&424==d[1]&&!d[4].length&&1==d[9]?t[an(d[0])].apply(t,d[3]):1==l.length&&mn(l)?t[u]():t.thru(l)}return function(){var e=arguments,i=e[0];if(t&&1==e.length&&Ba(i)&&i.length>=c)return t.plant(i).value();for(var n=0,r=a?o[n].apply(this,e):i;++n<a;)r=o[n].call(this,r);return r}}}function Fi(e,t){return function(n,a,r){return"function"==typeof a&&r===i&&Ba(n)?e(n,a):t(n,wi(a,r,3))}}function ji(e){return function(t,n,a){return"function"==typeof n&&a===i||(n=wi(n,a,3)),e(t,n,cr)}}function Hi(e){return function(t,n,a){return"function"==typeof n&&a===i||(n=wi(n,a,3)),e(t,n)}}function Gi(e){return function(t,i,n){var a={};return i=tn(i,n,3),Kt(t,(function(t,n,r){var s=i(t,n,r);t=e?t:s,a[n=e?s:n]=t})),a}}function Vi(e){return function(t,i,n){return t=Ce(t),(e?t:"")+Zi(t,i,n)+(e?"":t)}}function Wi(e){var t=La((function(n,a){var r=Ue(a,t.placeholder);return Ki(n,e,i,a,r)}));return t}function Yi(e,t){return function(n,a,r,s){var o=arguments.length<3;return"function"==typeof a&&s===i&&Ba(n)?e(n,a,r,o):hi(n,tn(a,s,4),r,o,t)}}function Xi(e,t,a,l,c,h,u,d,p,m){var f=t&o,g=1&t,y=2&t,v=8&t,b=4&t,_=16&t,x=y?i:Oi(e);return function o(){for(var w=arguments.length,S=w,M=n(w);S--;)M[S]=arguments[S];if(l&&(M=Mi(M,l,c)),h&&(M=Ti(M,h,u)),v||_){var T=o.placeholder,A=Ue(M,T);if((w-=A.length)<m){var E=d?Tt(d):i,C=ot(m-w,0),I=v?A:i,P=v?i:A,R=v?M:i,O=v?i:M;t|=v?r:s,t&=~(v?s:r),b||(t&=-4);var D=[e,t,a,R,I,O,P,E,p,C],L=Xi.apply(i,D);return mn(e)&&wn(L,D),L.placeholder=T,L}}var k=g?a:this,N=y?k[e]:e;return d&&(M=bn(M,d)),f&&p<M.length&&(M.length=p),this&&this!==Se&&this instanceof o&&(N=x||Oi(e)),N.apply(k,M)}}function Zi(e,t,i){var n=e.length;if(n>=(t=+t)||!rt(t))return"";var a=t-n;return xr(i=null==i?" ":i+"",tt(a/i.length)).slice(0,a)}function qi(e,t,i,a){var r=1&t,s=Oi(e);return function t(){for(var o=-1,l=arguments.length,c=-1,h=a.length,u=n(h+l);++c<h;)u[c]=a[c];for(;l--;)u[c++]=arguments[++o];var d=this&&this!==Se&&this instanceof t?s:e;return d.apply(r?i:this,u)}}function Ji(e){var t=M[e];return function(e,n){return(n=n===i?0:+n||0)?(n=Ze(10,n),t(e*n)/n):t(e)}}function Qi(e){return function(t,i,n,a){var r=tn(n);return null==n&&r===zt?_i(t,i,e):xi(t,i,r(n,a,1),e)}}function Ki(e,t,n,a,c,d,p,m){var f=2&t;if(!f&&"function"!=typeof e)throw new fe(h);var g=a?a.length:0;if(g||(t&=-97,a=c=i),g-=c?c.length:0,t&s){var y=a,v=c;a=c=i}var b=f?i:nn(e),_=[e,t,n,a,c,y,v,d,p,m];if(b&&(!function(e,t){var i=e[1],n=t[1],a=i|n,r=a<o,s=n==o&&8==i||n==o&&i==l&&e[7].length<=t[8]||384==n&&8==i;if(!r&&!s)return e;1&n&&(e[2]=t[2],a|=1&i?0:4);var c=t[3];if(c){var h=e[3];e[3]=h?Mi(h,c,t[4]):Tt(c),e[4]=h?Ue(e[3],u):Tt(t[4])}(c=t[5])&&(h=e[5],e[5]=h?Ti(h,c,t[6]):Tt(c),e[6]=h?Ue(e[5],u):Tt(t[6]));(c=t[7])&&(e[7]=Tt(c));n&o&&(e[8]=null==e[8]?t[8]:lt(e[8],t[8]));null==e[9]&&(e[9]=t[9]);e[0]=t[0],e[1]=a}(_,b),t=_[1],m=_[9]),_[9]=null==m?f?0:e.length:ot(m-g,0)||0,1==t)var x=function(e,t){var i=Oi(e);return function n(){return(this&&this!==Se&&this instanceof n?i:e).apply(t,arguments)}}(_[0],_[2]);else x=t!=r&&33!=t||_[4].length?Xi.apply(i,_):qi.apply(i,_);return(b?ui:wn)(x,_)}function $i(e,t,n,a,r,s,o){var l=-1,c=e.length,h=t.length;if(c!=h&&!(r&&h>c))return!1;for(;++l<c;){var u=e[l],d=t[l],p=a?a(r?d:u,r?u:d,l):i;if(p!==i){if(p)continue;return!1}if(r){if(!Ot(t,(function(e){return u===e||n(u,e,a,r,s,o)})))return!1}else if(u!==d&&!n(u,d,a,r,s,o))return!1}return!0}function en(e,t,n,a,r,s,o){var l=lr(e),c=l.length;if(c!=lr(t).length&&!r)return!1;for(var h=c;h--;){var u=l[h];if(!(r?u in t:_e.call(t,u)))return!1}for(var d=r;++h<c;){var p=e[u=l[h]],m=t[u],f=a?a(r?m:p,r?p:m,u):i;if(!(f===i?n(p,m,a,r,s,o):f))return!1;d||(d="constructor"==u)}if(!d){var g=e.constructor,y=t.constructor;if(g!=y&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof y&&y instanceof y))return!1}return!0}function tn(e,t,i){var n=vt.callback||Er;return n=n===Er?zt:n,i?n(e,t,i):n}var nn=gt?function(e){return gt.get(e)}:Dr;function an(e){for(var t=e.name,i=yt[t],n=i?i.length:0;n--;){var a=i[n],r=a.func;if(null==r||r==e)return a.name}return t}function rn(e,t,i){var n=vt.indexOf||Ln;return n=n===Ln?Ae:n,e?n(e,t,i):n}var sn=oi("length");function on(e){for(var t=pr(e),i=t.length;i--;)t[i][2]=gn(t[i][1]);return t}function ln(e,t){var n=null==e?i:e[t];return Ha(n)?n:i}function cn(e,t,n){null==e||pn(t,e)||(e=1==(t=An(t)).length?e:ti(e,di(t,0,-1)),t=Nn(t));var a=null==e?e:e[t];return null==a?i:a.apply(e,n)}function hn(e){return null!=e&&fn(sn(e))}function un(e,t){return e="number"==typeof e||ie.test(e)?+e:-1,t=null==t?ft:t,e>-1&&e%1==0&&e<t}function dn(e,t,i){if(!ja(i))return!1;var n=typeof t;if("number"==n?hn(i)&&un(t,i.length):"string"==n&&t in i){var a=i[t];return e==e?e===a:a!=a}return!1}function pn(e,t){var i=typeof e;return!!("string"==i&&Y.test(e)||"number"==i)||!Ba(e)&&(!W.test(e)||null!=t&&e in Tn(t))}function mn(e){var t=an(e);if(!(t in xt.prototype))return!1;var i=vt[t];if(e===i)return!0;var n=nn(i);return!!n&&e===n[0]}function fn(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=ft}function gn(e){return e==e&&!ja(e)}function yn(e,t){e=Tn(e);for(var i=-1,n=t.length,a={};++i<n;){var r=t[i];r in e&&(a[r]=e[r])}return a}function vn(e,t){var i={};return Qt(e,(function(e,n,a){t(e,n,a)&&(i[n]=e)})),i}function bn(e,t){for(var n=e.length,a=lt(t.length,n),r=Tt(e);a--;){var s=t[a];e[a]=un(s,n)?r[s]:i}return e}var _n,xn,wn=(_n=0,xn=0,function(e,t){var i=ya(),n=16-(i-xn);if(xn=i,n>0){if(++_n>=150)return e}else _n=0;return ui(e,t)});function Sn(e){for(var t=cr(e),i=t.length,n=i&&e.length,a=!!n&&fn(n)&&(Ba(e)||Na(e)),r=-1,s=[];++r<i;){var o=t[r];(a&&un(o,n)||_e.call(e,o))&&s.push(o)}return s}function Mn(e){return null==e?[]:hn(e)?ja(e)?e:de(e):fr(e)}function Tn(e){return ja(e)?e:de(e)}function An(e){if(Ba(e))return e;var t=[];return Ce(e).replace(X,(function(e,i,n,a){t.push(n?a.replace(Q,"$1"):i||e)})),t}function En(e){return e instanceof xt?e.clone():new _t(e.__wrapped__,e.__chain__,Tt(e.__actions__))}var Cn=La((function(e,t){return Be(e)&&hn(e)?Ht(e,Zt(t,!1,!0)):[]}));function In(e,t,i){return(e?e.length:0)?((i?dn(e,t,i):null==t)&&(t=1),di(e,t<0?0:t)):[]}function Pn(e,t,i){var n=e?e.length:0;return n?((i?dn(e,t,i):null==t)&&(t=1),di(e,0,(t=n-(+t||0))<0?0:t)):[]}var Rn=Bi(),On=Bi(!0);function Dn(e){return e?e[0]:i}function Ln(e,t,i){var n=e?e.length:0;if(!n)return-1;if("number"==typeof i)i=i<0?ot(n+i,0):i;else if(i){var a=_i(e,t);return a<n&&(t==t?t===e[a]:e[a]!=e[a])?a:-1}return Ae(e,t,i||0)}var kn=La((function(e){for(var t=e.length,i=t,a=n(u),r=rn(),s=r==Ae,o=[];i--;){var l=e[i]=hn(l=e[i])?l:[];a[i]=s&&l.length>=120?Pi(i&&l):null}var c=e[0],h=-1,u=c?c.length:0,d=a[0];e:for(;++h<u;)if(l=c[h],(d?Mt(d,l):r(o,l,0))<0){for(i=t;--i;){var p=a[i];if((p?Mt(p,l):r(e[i],l,0))<0)continue e}d&&d.push(l),o.push(l)}return o}));function Nn(e){var t=e?e.length:0;return t?e[t-1]:i}var Bn=La((function(e,t){var i=Nt(e,t=Zt(t));return li(e,t.sort(Me)),i}));function zn(e){return In(e,1)}var Un=Qi(),Fn=Qi(!0),jn=La((function(e){return gi(Zt(e,!1,!0))}));function Hn(e,t,n,a){if(!(e?e.length:0))return[];null!=t&&"boolean"!=typeof t&&(n=dn(e,t,a=n)?i:t,t=!1);var r=tn();return null==n&&r===zt||(n=r(n,a,3)),t&&rn()==Ae?function(e,t){for(var i,n=-1,a=e.length,r=-1,s=[];++n<a;){var o=e[n],l=t?t(o,n,e):o;n&&i===l||(i=l,s[++r]=o)}return s}(e,n):gi(e,n)}function Gn(e){if(!e||!e.length)return[];var t=-1,i=0;e=Ct(e,(function(e){if(hn(e))return i=ot(e.length,i),!0}));for(var a=n(i);++t<i;)a[t]=It(e,oi(t));return a}function Vn(e,t,n){if(!(e?e.length:0))return[];var a=Gn(e);return null==t?a:(t=wi(t,n,4),It(a,(function(e){return Rt(e,t,i,!0)})))}var Wn=La((function(e,t){return hn(e)?Ht(e,t):[]})),Yn=La(Gn);function Xn(e,t){var i=-1,n=e?e.length:0,a={};for(!n||t||Ba(e[0])||(t=[]);++i<n;){var r=e[i];t?a[r]=t[i]:r&&(a[r[0]]=r[1])}return a}var Zn=La((function(e){var t=e.length,n=t>2?e[t-2]:i,a=t>1?e[t-1]:i;return t>2&&"function"==typeof n?t-=2:(n=t>1&&"function"==typeof a?(--t,a):i,a=i),e.length=t,Vn(e,n,a)}));function qn(e){var t=vt(e);return t.__chain__=!0,t}function Jn(e,t,i){return t.call(i,e)}var Qn=La((function(e){return e=Zt(e),this.thru((function(t){return function(e,t){for(var i=-1,a=e.length,r=-1,s=t.length,o=n(a+s);++i<a;)o[i]=e[i];for(;++r<s;)o[i++]=t[r];return o}(Ba(t)?t:[Tn(t)],e)}))})),Kn=La((function(e,t){return Nt(e,Zt(t))})),$n=Ai((function(e,t,i){_e.call(e,i)?++e[i]:e[i]=1}));function ea(e,t,n){var a=Ba(e)?Et:Wt;return n&&dn(e,t,n)&&(t=i),"function"==typeof t&&n===i||(t=tn(t,n,3)),a(e,t)}function ta(e,t,i){return(Ba(e)?Ct:Yt)(e,t=tn(t,i,3))}var ia=Ni(Gt),na=Ni(Vt,!0),aa=Fi(At,Gt),ra=Fi((function(e,t){for(var i=e.length;i--&&!1!==t(e[i],i,e););return e}),Vt),sa=Ai((function(e,t,i){_e.call(e,i)?e[i].push(t):e[i]=[t]}));function oa(e,t,i,n){var a=e?sn(e):0;return fn(a)||(a=(e=fr(e)).length),i="number"!=typeof i||n&&dn(t,i,n)?0:i<0?ot(a+i,0):i||0,"string"==typeof e||!Ba(e)&&Ya(e)?i<=a&&e.indexOf(t,i)>-1:!!a&&rn(e,t,i)>-1}var la=Ai((function(e,t,i){e[i]=t})),ca=La((function(e,t,a){var r=-1,s="function"==typeof t,o=pn(t),l=hn(e)?n(e.length):[];return Gt(e,(function(e){var n=s?t:o&&null!=e?e[t]:i;l[++r]=n?n.apply(e,a):cn(e,t,a)})),l}));function ha(e,t,i){return(Ba(e)?It:ai)(e,t=tn(t,i,3))}var ua=Ai((function(e,t,i){e[i?0:1].push(t)}),(function(){return[[],[]]})),da=Yi(Rt,Gt),pa=Yi((function(e,t,i,n){var a=e.length;for(n&&a&&(i=e[--a]);a--;)i=t(i,e[a],a,e);return i}),Vt);function ma(e,t,n){if(n?dn(e,t,n):null==t)return(a=(e=Mn(e)).length)>0?e[ci(0,a-1)]:i;var a,r=-1,s=qa(e),o=(a=s.length)-1;for(t=lt(t<0?0:+t||0,a);++r<t;){var l=ci(r,o),c=s[l];s[l]=s[r],s[r]=c}return s.length=t,s}function fa(e,t,n){var a=Ba(e)?Ot:pi;return n&&dn(e,t,n)&&(t=i),"function"==typeof t&&n===i||(t=tn(t,n,3)),a(e,t)}var ga=La((function(e,t){if(null==e)return[];var i=t[2];return i&&dn(t[0],t[1],i)&&(t.length=1),fi(e,Zt(t),[])})),ya=ct||function(){return(new a).getTime()};function va(e,t){var n;if("function"!=typeof t){if("function"!=typeof e)throw new fe(h);var a=e;e=t,t=a}return function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=i),n}}var ba=La((function(e,t,i){var n=1;if(i.length){var a=Ue(i,ba.placeholder);n|=r}return Ki(e,n,t,i,a)})),_a=La((function(e,t){for(var i=-1,n=(t=t.length?Zt(t):or(e)).length;++i<n;){var a=t[i];e[a]=Ki(e[a],1,e)}return e})),xa=La((function(e,t,i){var n=3;if(i.length){var a=Ue(i,xa.placeholder);n|=r}return Ki(t,n,e,i,a)})),wa=Di(8),Sa=Di(16);function Ma(e,t,n){var a,r,s,o,l,c,u,d=0,p=!1,m=!0;if("function"!=typeof e)throw new fe(h);if(t=t<0?0:+t||0,!0===n){var f=!0;m=!1}else ja(n)&&(f=!!n.leading,p="maxWait"in n&&ot(+n.maxWait||0,t),m="trailing"in n?!!n.trailing:m);function g(t,n){n&&Ye(n),r=c=u=i,t&&(d=ya(),s=e.apply(l,a),c||r||(a=l=i))}function y(){var e=t-(ya()-o);e<=0||e>t?g(u,r):c=Qe(y,e)}function v(){g(m,c)}function b(){if(a=arguments,o=ya(),l=this,u=m&&(c||!f),!1===p)var n=f&&!c;else{r||f||(d=o);var h=p-(o-d),g=h<=0||h>p;g?(r&&(r=Ye(r)),d=o,s=e.apply(l,a)):r||(r=Qe(v,h))}return g&&c?c=Ye(c):c||t===p||(c=Qe(y,t)),n&&(g=!0,s=e.apply(l,a)),!g||c||r||(a=l=i),s}return b.cancel=function(){c&&Ye(c),r&&Ye(r),d=0,r=c=u=i},b}var Ta=La((function(e,t){return jt(e,1,t)})),Aa=La((function(e,t,i){return jt(e,t,i)})),Ea=Ui(),Ca=Ui(!0);function Ia(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new fe(h);var i=function(){var n=arguments,a=t?t.apply(this,n):n[0],r=i.cache;if(r.has(a))return r.get(a);var s=e.apply(this,n);return i.cache=r.set(a,s),s};return i.cache=new Ia.Cache,i}var Pa=La((function(e,t){if(t=Zt(t),"function"!=typeof e||!Et(t,Ee))throw new fe(h);var i=t.length;return La((function(n){for(var a=lt(n.length,i);a--;)n[a]=t[a](n[a]);return e.apply(this,n)}))})),Ra=Wi(r),Oa=Wi(s),Da=La((function(e,t){return Ki(e,l,i,i,i,Zt(t))}));function La(e,t){if("function"!=typeof e)throw new fe(h);return t=ot(t===i?e.length-1:+t||0,0),function(){for(var i=arguments,a=-1,r=ot(i.length-t,0),s=n(r);++a<r;)s[a]=i[t+a];switch(t){case 0:return e.call(this,s);case 1:return e.call(this,i[0],s);case 2:return e.call(this,i[0],i[1],s)}var o=n(t+1);for(a=-1;++a<t;)o[a]=i[a];return o[t]=s,e.apply(this,o)}}function ka(e,t){return e>t}function Na(e){return Be(e)&&hn(e)&&_e.call(e,"callee")&&!qe.call(e,"callee")}var Ba=at||function(e){return Be(e)&&fn(e.length)&&we.call(e)==p};function za(e,t,n,a){var r=(n="function"==typeof n?wi(n,a,3):i)?n(e,t):i;return r===i?ii(e,t,n):!!r}function Ua(e){return Be(e)&&"string"==typeof e.message&&we.call(e)==g}function Fa(e){return ja(e)&&we.call(e)==y}function ja(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ha(e){return null!=e&&(Fa(e)?Ve.test(be.call(e)):Be(e)&&te.test(e))}function Ga(e){return"number"==typeof e||Be(e)&&we.call(e)==b}function Va(e){var t,n;return!(!Be(e)||we.call(e)!=_||Na(e)||!(_e.call(e,"constructor")||"function"!=typeof(t=e.constructor)||t instanceof t))&&(Qt(e,(function(e,t){n=t})),n===i||_e.call(e,n))}function Wa(e){return ja(e)&&we.call(e)==x}function Ya(e){return"string"==typeof e||Be(e)&&we.call(e)==S}function Xa(e){return Be(e)&&fn(e.length)&&!!ce[we.call(e)]}function Za(e,t){return e<t}function qa(e){var t=e?sn(e):0;return fn(t)?t?Tt(e):[]:fr(e)}function Ja(e){return Bt(e,cr(e))}var Qa=Ei((function e(t,n,a,r,s){if(!ja(t))return t;var o=hn(n)&&(Ba(n)||Xa(n)),l=o?i:lr(n);return At(l||n,(function(c,h){if(l&&(c=n[h=c]),Be(c))r||(r=[]),s||(s=[]),function(e,t,n,a,r,s,o){var l=s.length,c=t[n];for(;l--;)if(s[l]==c)return void(e[n]=o[l]);var h=e[n],u=r?r(h,c,n,e,t):i,d=u===i;d&&(u=c,hn(c)&&(Ba(c)||Xa(c))?u=Ba(h)?h:hn(h)?Tt(h):[]:Va(c)||Na(c)?u=Na(h)?Ja(h):Va(h)?h:{}:d=!1);s.push(c),o.push(u),d?e[n]=a(u,c,r,s,o):(u==u?u!==h:h==h)&&(e[n]=u)}(t,n,h,e,a,r,s);else{var u=t[h],d=a?a(u,c,h,t,n):i,p=d===i;p&&(d=c),d===i&&(!o||h in t)||!p&&(d==d?d===u:u!=u)||(t[h]=d)}})),t})),Ka=Ei((function(e,t,i){return i?Lt(e,t,i):kt(e,t)})),$a=Li(Ka,(function(e,t){return e===i?t:e})),er=Li(Qa,(function e(t,n){return t===i?n:Qa(t,n,e)})),tr=zi(Kt),ir=zi($t),nr=ji(qt),ar=ji(Jt),rr=Hi(Kt),sr=Hi($t);function or(e){return ei(e,cr(e))}var lr=st?function(e){var t=null==e?i:e.constructor;return"function"==typeof t&&t.prototype===e||"function"!=typeof e&&hn(e)?Sn(e):ja(e)?st(e):[]}:Sn;function cr(e){if(null==e)return[];ja(e)||(e=de(e));var t=e.length;t=t&&fn(t)&&(Ba(e)||Na(e))&&t||0;for(var i=e.constructor,a=-1,r="function"==typeof i&&i.prototype===e,s=n(t),o=t>0;++a<t;)s[a]=a+"";for(var l in e)o&&un(l,t)||"constructor"==l&&(r||!_e.call(e,l))||s.push(l);return s}var hr=Gi(!0),ur=Gi(),dr=La((function(e,t){if(null==e)return{};if("function"!=typeof t[0]){t=It(Zt(t),me);return yn(e,Ht(cr(e),t))}var i=wi(t[0],t[1],3);return vn(e,(function(e,t,n){return!i(e,t,n)}))}));function pr(e){e=Tn(e);for(var t=-1,i=lr(e),a=i.length,r=n(a);++t<a;){var s=i[t];r[t]=[s,e[s]]}return r}var mr=La((function(e,t){return null==e?{}:"function"==typeof t[0]?vn(e,wi(t[0],t[1],3)):yn(e,Zt(t))}));function fr(e){return yi(e,lr(e))}var gr=Ri((function(e,t,i){return t=t.toLowerCase(),e+(i?t.charAt(0).toUpperCase()+t.slice(1):t)}));function yr(e){return(e=Ce(e))&&e.replace(ne,Oe).replace(J,"")}var vr=Ri((function(e,t,i){return e+(i?"-":"")+t.toLowerCase()})),br=Vi(),_r=Vi(!0);function xr(e,t){var i="";if(e=Ce(e),(t=+t)<1||!e||!rt(t))return i;do{t%2&&(i+=e),t=nt(t/2),e+=e}while(t);return i}var wr=Ri((function(e,t,i){return e+(i?"_":"")+t.toLowerCase()})),Sr=Ri((function(e,t,i){return e+(i?" ":"")+(t.charAt(0).toUpperCase()+t.slice(1))}));function Mr(e,t,i){var n=e;return(e=Ce(e))?(i?dn(n,t,i):null==t)?e.slice(Fe(e),je(e)+1):(t+="",e.slice(Ie(e,t),Pe(e,t)+1)):e}function Tr(e,t,n){return n&&dn(e,t,n)&&(t=i),(e=Ce(e)).match(t||se)||[]}var Ar=La((function(e,t){try{return e.apply(i,t)}catch(e){return Ua(e)?e:new v(e)}}));function Er(e,t,n){return n&&dn(e,t,n)&&(t=i),Be(e)?Ir(e):zt(e,t)}function Cr(e){return e}function Ir(e){return ri(Ut(e,!0))}var Pr=La((function(e,t){return function(i){return cn(i,e,t)}})),Rr=La((function(e,t){return function(i){return cn(e,i,t)}}));function Or(e,t,n){if(null==n){var a=ja(t),r=a?lr(t):i,s=r&&r.length?ei(t,r):i;(s?s.length:a)||(s=!1,n=t,t=e,e=this)}s||(s=ei(t,lr(t)));var o=!0,l=-1,c=Fa(e),h=s.length;!1===n?o=!1:ja(n)&&"chain"in n&&(o=n.chain);for(;++l<h;){var u=s[l],d=t[u];e[u]=d,c&&(e.prototype[u]=function(t){return function(){var i=this.__chain__;if(o||i){var n=e(this.__wrapped__),a=n.__actions__=Tt(this.__actions__);return a.push({func:t,args:arguments,thisArg:e}),n.__chain__=i,n}return t.apply(e,Pt([this.value()],arguments))}}(d))}return e}function Dr(){}function Lr(e){return pn(e)?oi(e):function(e){var t=e+"";return e=An(e),function(i){return ti(i,e,t)}}(e)}var kr,Nr=Ji("ceil"),Br=Ji("floor"),zr=ki(ka,dt),Ur=ki(Za,pt),Fr=Ji("round");return vt.prototype=bt.prototype,_t.prototype=Ft(bt.prototype),_t.prototype.constructor=_t,xt.prototype=Ft(bt.prototype),xt.prototype.constructor=xt,wt.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},wt.prototype.get=function(e){return"__proto__"==e?i:this.__data__[e]},wt.prototype.has=function(e){return"__proto__"!=e&&_e.call(this.__data__,e)},wt.prototype.set=function(e,t){return"__proto__"!=e&&(this.__data__[e]=t),this},St.prototype.push=function(e){var t=this.data;"string"==typeof e||ja(e)?t.set.add(e):t.hash[e]=!0},Ia.Cache=wt,vt.after=function(e,t){if("function"!=typeof t){if("function"!=typeof e)throw new fe(h);var i=e;e=t,t=i}return e=rt(e=+e)?e:0,function(){if(--e<1)return t.apply(this,arguments)}},vt.ary=function(e,t,n){return n&&dn(e,t,n)&&(t=i),t=e&&null==t?e.length:ot(+t||0,0),Ki(e,o,i,i,i,i,t)},vt.assign=Ka,vt.at=Kn,vt.before=va,vt.bind=ba,vt.bindAll=_a,vt.bindKey=xa,vt.callback=Er,vt.chain=qn,vt.chunk=function(e,t,i){t=(i?dn(e,t,i):null==t)?1:ot(nt(t)||1,1);for(var a=0,r=e?e.length:0,s=-1,o=n(tt(r/t));a<r;)o[++s]=di(e,a,a+=t);return o},vt.compact=function(e){for(var t=-1,i=e?e.length:0,n=-1,a=[];++t<i;){var r=e[t];r&&(a[++n]=r)}return a},vt.constant=function(e){return function(){return e}},vt.countBy=$n,vt.create=function(e,t,n){var a=Ft(e);return n&&dn(e,t,n)&&(t=i),t?kt(a,t):a},vt.curry=wa,vt.curryRight=Sa,vt.debounce=Ma,vt.defaults=$a,vt.defaultsDeep=er,vt.defer=Ta,vt.delay=Aa,vt.difference=Cn,vt.drop=In,vt.dropRight=Pn,vt.dropRightWhile=function(e,t,i){return e&&e.length?vi(e,tn(t,i,3),!0,!0):[]},vt.dropWhile=function(e,t,i){return e&&e.length?vi(e,tn(t,i,3),!0):[]},vt.fill=function(e,t,n,a){var r=e?e.length:0;return r?(n&&"number"!=typeof n&&dn(e,t,n)&&(n=0,a=r),function(e,t,n,a){var r=e.length;for((n=null==n?0:+n||0)<0&&(n=-n>r?0:r+n),(a=a===i||a>r?r:+a||0)<0&&(a+=r),r=n>a?0:a>>>0,n>>>=0;n<r;)e[n++]=t;return e}(e,t,n,a)):[]},vt.filter=ta,vt.flatten=function(e,t,i){var n=e?e.length:0;return i&&dn(e,t,i)&&(t=!1),n?Zt(e,t):[]},vt.flattenDeep=function(e){return(e?e.length:0)?Zt(e,!0):[]},vt.flow=Ea,vt.flowRight=Ca,vt.forEach=aa,vt.forEachRight=ra,vt.forIn=nr,vt.forInRight=ar,vt.forOwn=rr,vt.forOwnRight=sr,vt.functions=or,vt.groupBy=sa,vt.indexBy=la,vt.initial=function(e){return Pn(e,1)},vt.intersection=kn,vt.invert=function(e,t,n){n&&dn(e,t,n)&&(t=i);for(var a=-1,r=lr(e),s=r.length,o={};++a<s;){var l=r[a],c=e[l];t?_e.call(o,c)?o[c].push(l):o[c]=[l]:o[c]=l}return o},vt.invoke=ca,vt.keys=lr,vt.keysIn=cr,vt.map=ha,vt.mapKeys=hr,vt.mapValues=ur,vt.matches=Ir,vt.matchesProperty=function(e,t){return si(e,Ut(t,!0))},vt.memoize=Ia,vt.merge=Qa,vt.method=Pr,vt.methodOf=Rr,vt.mixin=Or,vt.modArgs=Pa,vt.negate=function(e){if("function"!=typeof e)throw new fe(h);return function(){return!e.apply(this,arguments)}},vt.omit=dr,vt.once=function(e){return va(2,e)},vt.pairs=pr,vt.partial=Ra,vt.partialRight=Oa,vt.partition=ua,vt.pick=mr,vt.pluck=function(e,t){return ha(e,Lr(t))},vt.property=Lr,vt.propertyOf=function(e){return function(t){return ti(e,An(t),t+"")}},vt.pull=function(){var e=arguments,t=e[0];if(!t||!t.length)return t;for(var i=0,n=rn(),a=e.length;++i<a;)for(var r=0,s=e[i];(r=n(t,s,r))>-1;)Ke.call(t,r,1);return t},vt.pullAt=Bn,vt.range=function(e,t,a){a&&dn(e,t,a)&&(t=a=i),e=+e||0,null==t?(t=e,e=0):t=+t||0;for(var r=-1,s=ot(tt((t-e)/((a=null==a?1:+a||0)||1)),0),o=n(s);++r<s;)o[r]=e,e+=a;return o},vt.rearg=Da,vt.reject=function(e,t,i){var n=Ba(e)?Ct:Yt;return t=tn(t,i,3),n(e,(function(e,i,n){return!t(e,i,n)}))},vt.remove=function(e,t,i){var n=[];if(!e||!e.length)return n;var a=-1,r=[],s=e.length;for(t=tn(t,i,3);++a<s;){var o=e[a];t(o,a,e)&&(n.push(o),r.push(a))}return li(e,r),n},vt.rest=zn,vt.restParam=La,vt.set=function(e,t,i){if(null==e)return e;for(var n=t+"",a=-1,r=(t=null!=e[n]||pn(t,e)?[n]:An(t)).length,s=r-1,o=e;null!=o&&++a<r;){var l=t[a];ja(o)&&(a==s?o[l]=i:null==o[l]&&(o[l]=un(t[a+1])?[]:{})),o=o[l]}return e},vt.shuffle=function(e){return ma(e,pt)},vt.slice=function(e,t,i){var n=e?e.length:0;return n?(i&&"number"!=typeof i&&dn(e,t,i)&&(t=0,i=n),di(e,t,i)):[]},vt.sortBy=function(e,t,n){if(null==e)return[];n&&dn(e,t,n)&&(t=i);var a=-1;return t=tn(t,n,3),mi(ai(e,(function(e,i,n){return{criteria:t(e,i,n),index:++a,value:e}})),Re)},vt.sortByAll=ga,vt.sortByOrder=function(e,t,n,a){return null==e?[]:(a&&dn(t,n,a)&&(n=i),Ba(t)||(t=null==t?[]:[t]),Ba(n)||(n=null==n?[]:[n]),fi(e,t,n))},vt.spread=function(e){if("function"!=typeof e)throw new fe(h);return function(t){return e.apply(this,t)}},vt.take=function(e,t,i){return(e?e.length:0)?((i?dn(e,t,i):null==t)&&(t=1),di(e,0,t<0?0:t)):[]},vt.takeRight=function(e,t,i){var n=e?e.length:0;return n?((i?dn(e,t,i):null==t)&&(t=1),di(e,(t=n-(+t||0))<0?0:t)):[]},vt.takeRightWhile=function(e,t,i){return e&&e.length?vi(e,tn(t,i,3),!1,!0):[]},vt.takeWhile=function(e,t,i){return e&&e.length?vi(e,tn(t,i,3)):[]},vt.tap=function(e,t,i){return t.call(i,e),e},vt.throttle=function(e,t,i){var n=!0,a=!0;if("function"!=typeof e)throw new fe(h);return!1===i?n=!1:ja(i)&&(n="leading"in i?!!i.leading:n,a="trailing"in i?!!i.trailing:a),Ma(e,t,{leading:n,maxWait:+t,trailing:a})},vt.thru=Jn,vt.times=function(e,t,i){if((e=nt(e))<1||!rt(e))return[];var a=-1,r=n(lt(e,mt));for(t=wi(t,i,1);++a<e;)a<mt?r[a]=t(a):t(a);return r},vt.toArray=qa,vt.toPlainObject=Ja,vt.transform=function(e,t,n,a){var r=Ba(e)||Xa(e);if(t=tn(t,a,4),null==n)if(r||ja(e)){var s=e.constructor;n=r?Ba(e)?new s:[]:Ft(Fa(s)?s.prototype:i)}else n={};return(r?At:Kt)(e,(function(e,i,a){return t(n,e,i,a)})),n},vt.union=jn,vt.uniq=Hn,vt.unzip=Gn,vt.unzipWith=Vn,vt.values=fr,vt.valuesIn=function(e){return yi(e,cr(e))},vt.where=function(e,t){return ta(e,ri(t))},vt.without=Wn,vt.wrap=function(e,t){return Ki(t=null==t?Cr:t,r,i,[e],[])},vt.xor=function(){for(var e=-1,t=arguments.length;++e<t;){var i=arguments[e];if(hn(i))var n=n?Pt(Ht(n,i),Ht(i,n)):i}return n?gi(n):[]},vt.zip=Yn,vt.zipObject=Xn,vt.zipWith=Zn,vt.backflow=Ca,vt.collect=ha,vt.compose=Ca,vt.each=aa,vt.eachRight=ra,vt.extend=Ka,vt.iteratee=Er,vt.methods=or,vt.object=Xn,vt.select=ta,vt.tail=zn,vt.unique=Hn,Or(vt,vt),vt.add=function(e,t){return(+e||0)+(+t||0)},vt.attempt=Ar,vt.camelCase=gr,vt.capitalize=function(e){return(e=Ce(e))&&e.charAt(0).toUpperCase()+e.slice(1)},vt.ceil=Nr,vt.clone=function(e,t,i,n){return t&&"boolean"!=typeof t&&dn(e,t,i)?t=!1:"function"==typeof t&&(n=i,i=t,t=!1),"function"==typeof i?Ut(e,t,wi(i,n,1)):Ut(e,t)},vt.cloneDeep=function(e,t,i){return"function"==typeof t?Ut(e,!0,wi(t,i,1)):Ut(e,!0)},vt.deburr=yr,vt.endsWith=function(e,t,n){t+="";var a=(e=Ce(e)).length;return n=n===i?a:lt(n<0?0:+n||0,a),(n-=t.length)>=0&&e.indexOf(t,n)==n},vt.escape=function(e){return(e=Ce(e))&&j.test(e)?e.replace(U,De):e},vt.escapeRegExp=function(e){return(e=Ce(e))&&q.test(e)?e.replace(Z,Le):e||"(?:)"},vt.every=ea,vt.find=ia,vt.findIndex=Rn,vt.findKey=tr,vt.findLast=na,vt.findLastIndex=On,vt.findLastKey=ir,vt.findWhere=function(e,t){return ia(e,ri(t))},vt.first=Dn,vt.floor=Br,vt.get=function(e,t,n){var a=null==e?i:ti(e,An(t),t+"");return a===i?n:a},vt.gt=ka,vt.gte=function(e,t){return e>=t},vt.has=function(e,t){if(null==e)return!1;var i=_e.call(e,t);if(!i&&!pn(t)){if(null==(e=1==(t=An(t)).length?e:ti(e,di(t,0,-1))))return!1;t=Nn(t),i=_e.call(e,t)}return i||fn(e.length)&&un(t,e.length)&&(Ba(e)||Na(e))},vt.identity=Cr,vt.includes=oa,vt.indexOf=Ln,vt.inRange=function(e,t,n){return t=+t||0,n===i?(n=t,t=0):n=+n||0,e>=lt(t,n)&&e<ot(t,n)},vt.isArguments=Na,vt.isArray=Ba,vt.isBoolean=function(e){return!0===e||!1===e||Be(e)&&we.call(e)==m},vt.isDate=function(e){return Be(e)&&we.call(e)==f},vt.isElement=function(e){return!!e&&1===e.nodeType&&Be(e)&&!Va(e)},vt.isEmpty=function(e){return null==e||(hn(e)&&(Ba(e)||Ya(e)||Na(e)||Be(e)&&Fa(e.splice))?!e.length:!lr(e).length)},vt.isEqual=za,vt.isError=Ua,vt.isFinite=function(e){return"number"==typeof e&&rt(e)},vt.isFunction=Fa,vt.isMatch=function(e,t,n,a){return n="function"==typeof n?wi(n,a,3):i,ni(e,on(t),n)},vt.isNaN=function(e){return Ga(e)&&e!=+e},vt.isNative=Ha,vt.isNull=function(e){return null===e},vt.isNumber=Ga,vt.isObject=ja,vt.isPlainObject=Va,vt.isRegExp=Wa,vt.isString=Ya,vt.isTypedArray=Xa,vt.isUndefined=function(e){return e===i},vt.kebabCase=vr,vt.last=Nn,vt.lastIndexOf=function(e,t,i){var n=e?e.length:0;if(!n)return-1;var a=n;if("number"==typeof i)a=(i<0?ot(n+i,0):lt(i||0,n-1))+1;else if(i){var r=e[a=_i(e,t,!0)-1];return(t==t?t===r:r!=r)?a:-1}if(t!=t)return Ne(e,a,!0);for(;a--;)if(e[a]===t)return a;return-1},vt.lt=Za,vt.lte=function(e,t){return e<=t},vt.max=zr,vt.min=Ur,vt.noConflict=function(){return Se._=ze,this},vt.noop=Dr,vt.now=ya,vt.pad=function(e,t,i){t=+t;var n=(e=Ce(e)).length;if(n>=t||!rt(t))return e;var a=(t-n)/2,r=nt(a);return(i=Zi("",tt(a),i)).slice(0,r)+e+i},vt.padLeft=br,vt.padRight=_r,vt.parseInt=function(e,t,i){return(i?dn(e,t,i):null==t)?t=0:t&&(t=+t),e=Mr(e),ht(e,t||(ee.test(e)?16:10))},vt.random=function(e,t,n){n&&dn(e,t,n)&&(t=n=i);var a=null==e,r=null==t;if(null==n&&(r&&"boolean"==typeof e?(n=e,e=1):"boolean"==typeof t&&(n=t,r=!0)),a&&r&&(t=1,r=!1),e=+e||0,r?(t=e,e=0):t=+t||0,n||e%1||t%1){var s=ut();return lt(e+s*(t-e+Xe("1e-"+((s+"").length-1))),t)}return ci(e,t)},vt.reduce=da,vt.reduceRight=pa,vt.repeat=xr,vt.result=function(e,t,n){var a=null==e?i:e[t];return a===i&&(null==e||pn(t,e)||(a=null==(e=1==(t=An(t)).length?e:ti(e,di(t,0,-1)))?i:e[Nn(t)]),a=a===i?n:a),Fa(a)?a.call(e):a},vt.round=Fr,vt.runInContext=e,vt.size=function(e){var t=e?sn(e):0;return fn(t)?t:lr(e).length},vt.snakeCase=wr,vt.some=fa,vt.sortedIndex=Un,vt.sortedLastIndex=Fn,vt.startCase=Sr,vt.startsWith=function(e,t,i){return e=Ce(e),i=null==i?0:lt(i<0?0:+i||0,e.length),e.lastIndexOf(t,i)==i},vt.sum=function(e,t,n){return n&&dn(e,t,n)&&(t=i),1==(t=tn(t,n,3)).length?function(e,t){for(var i=e.length,n=0;i--;)n+=+t(e[i])||0;return n}(Ba(e)?e:Mn(e),t):function(e,t){var i=0;return Gt(e,(function(e,n,a){i+=+t(e,n,a)||0})),i}(e,t)},vt.template=function(e,t,n){var a=vt.templateSettings;n&&dn(e,t,n)&&(t=n=i),e=Ce(e),t=Lt(kt({},n||t),a,Dt);var r,s,o=Lt(kt({},t.imports),a.imports,Dt),l=lr(o),c=yi(o,l),h=0,u=t.interpolate||ae,d="__p += '",p=pe((t.escape||ae).source+"|"+u.source+"|"+(u===V?K:ae).source+"|"+(t.evaluate||ae).source+"|$","g"),m="//# sourceURL="+("sourceURL"in t?t.sourceURL:"lodash.templateSources["+ ++le+"]")+"\n";e.replace(p,(function(t,i,n,a,o,l){return n||(n=a),d+=e.slice(h,l).replace(re,ke),i&&(r=!0,d+="' +\n__e("+i+") +\n'"),o&&(s=!0,d+="';\n"+o+";\n__p += '"),n&&(d+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),h=l+t.length,t})),d+="';\n";var f=t.variable;f||(d="with (obj) {\n"+d+"\n}\n"),d=(s?d.replace(k,""):d).replace(N,"$1").replace(B,"$1;"),d="function("+(f||"obj")+") {\n"+(f?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(r?", __e = _.escape":"")+(s?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+d+"return __p\n}";var g=Ar((function(){return w(l,m+"return "+d).apply(i,c)}));if(g.source=d,Ua(g))throw g;return g},vt.trim=Mr,vt.trimLeft=function(e,t,i){var n=e;return(e=Ce(e))?(i?dn(n,t,i):null==t)?e.slice(Fe(e)):e.slice(Ie(e,t+"")):e},vt.trimRight=function(e,t,i){var n=e;return(e=Ce(e))?(i?dn(n,t,i):null==t)?e.slice(0,je(e)+1):e.slice(0,Pe(e,t+"")+1):e},vt.trunc=function(e,t,n){n&&dn(e,t,n)&&(t=i);var a=30,r="...";if(null!=t)if(ja(t)){var s="separator"in t?t.separator:s;a="length"in t?+t.length||0:a,r="omission"in t?Ce(t.omission):r}else a=+t||0;if(a>=(e=Ce(e)).length)return e;var o=a-r.length;if(o<1)return r;var l=e.slice(0,o);if(null==s)return l+r;if(Wa(s)){if(e.slice(o).search(s)){var c,h,u=e.slice(0,o);for(s.global||(s=pe(s.source,($.exec(s)||"")+"g")),s.lastIndex=0;c=s.exec(u);)h=c.index;l=l.slice(0,null==h?o:h)}}else if(e.indexOf(s,o)!=o){var d=l.lastIndexOf(s);d>-1&&(l=l.slice(0,d))}return l+r},vt.unescape=function(e){return(e=Ce(e))&&F.test(e)?e.replace(z,He):e},vt.uniqueId=function(e){var t=++xe;return Ce(e)+t},vt.words=Tr,vt.all=ea,vt.any=fa,vt.contains=oa,vt.eq=za,vt.detect=ia,vt.foldl=da,vt.foldr=pa,vt.head=Dn,vt.include=oa,vt.inject=da,Or(vt,(kr={},Kt(vt,(function(e,t){vt.prototype[t]||(kr[t]=e)})),kr),!1),vt.sample=ma,vt.prototype.sample=function(e){return this.__chain__||null!=e?this.thru((function(t){return ma(t,e)})):ma(this.value())},vt.VERSION="3.10.1",At(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(e){vt[e].placeholder=vt})),At(["drop","take"],(function(e,t){xt.prototype[e]=function(i){var n=this.__filtered__;if(n&&!t)return new xt(this);i=null==i?1:ot(nt(i)||0,0);var a=this.clone();return n?a.__takeCount__=lt(a.__takeCount__,i):a.__views__.push({size:i,type:e+(a.__dir__<0?"Right":"")}),a},xt.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}})),At(["filter","map","takeWhile"],(function(e,t){var i=t+1,n=2!=i;xt.prototype[e]=function(e,t){var a=this.clone();return a.__iteratees__.push({iteratee:tn(e,t,1),type:i}),a.__filtered__=a.__filtered__||n,a}})),At(["first","last"],(function(e,t){var i="take"+(t?"Right":"");xt.prototype[e]=function(){return this[i](1).value()[0]}})),At(["initial","rest"],(function(e,t){var i="drop"+(t?"":"Right");xt.prototype[e]=function(){return this.__filtered__?new xt(this):this[i](1)}})),At(["pluck","where"],(function(e,t){var i=t?"filter":"map",n=t?ri:Lr;xt.prototype[e]=function(e){return this[i](n(e))}})),xt.prototype.compact=function(){return this.filter(Cr)},xt.prototype.reject=function(e,t){return e=tn(e,t,1),this.filter((function(t){return!e(t)}))},xt.prototype.slice=function(e,t){e=null==e?0:+e||0;var n=this;return n.__filtered__&&(e>0||t<0)?new xt(n):(e<0?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==i&&(n=(t=+t||0)<0?n.dropRight(-t):n.take(t-e)),n)},xt.prototype.takeRightWhile=function(e,t){return this.reverse().takeWhile(e,t).reverse()},xt.prototype.toArray=function(){return this.take(pt)},Kt(xt.prototype,(function(e,t){var n=/^(?:filter|map|reject)|While$/.test(t),a=/^(?:first|last)$/.test(t),r=vt[a?"take"+("last"==t?"Right":""):t];r&&(vt.prototype[t]=function(){var t=a?[1]:arguments,s=this.__chain__,o=this.__wrapped__,l=!!this.__actions__.length,c=o instanceof xt,h=t[0],u=c||Ba(o);u&&n&&"function"==typeof h&&1!=h.length&&(c=u=!1);var d=function(e){return a&&s?r(e,1)[0]:r.apply(i,Pt([e],t))},p={func:Jn,args:[d],thisArg:i},m=c&&!l;if(a&&!s)return m?((o=o.clone()).__actions__.push(p),e.call(o)):r.call(i,this.value())[0];if(!a&&u){o=m?o:new xt(this);var f=e.apply(o,t);return f.__actions__.push(p),new _t(f,s)}return this.thru(d)})})),At(["join","pop","push","replace","shift","sort","splice","split","unshift"],(function(e){var t=(/^(?:replace|split)$/.test(e)?ve:ge)[e],i=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",n=/^(?:join|pop|replace|shift)$/.test(e);vt.prototype[e]=function(){var e=arguments;return n&&!this.__chain__?t.apply(this.value(),e):this[i]((function(i){return t.apply(i,e)}))}})),Kt(xt.prototype,(function(e,t){var i=vt[t];if(i){var n=i.name;(yt[n]||(yt[n]=[])).push({name:t,func:i})}})),yt[Xi(i,2).name]=[{name:"wrapper",func:i}],xt.prototype.clone=function(){var e=new xt(this.__wrapped__);return e.__actions__=Tt(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=Tt(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=Tt(this.__views__),e},xt.prototype.reverse=function(){if(this.__filtered__){var e=new xt(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},xt.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,i=Ba(e),n=t<0,a=i?e.length:0,r=function(e,t,i){var n=-1,a=i.length;for(;++n<a;){var r=i[n],s=r.size;switch(r.type){case"drop":e+=s;break;case"dropRight":t-=s;break;case"take":t=lt(t,e+s);break;case"takeRight":e=ot(e,t-s)}}return{start:e,end:t}}(0,a,this.__views__),s=r.start,o=r.end,l=o-s,h=n?o:s-1,u=this.__iteratees__,d=u.length,p=0,m=lt(l,this.__takeCount__);if(!i||a<c||a==l&&m==l)return bi(n&&i?e.reverse():e,this.__actions__);var f=[];e:for(;l--&&p<m;){for(var g=-1,y=e[h+=t];++g<d;){var v=u[g],b=v.iteratee,_=v.type,x=b(y);if(2==_)y=x;else if(!x){if(1==_)continue e;break e}}f[p++]=y}return f},vt.prototype.chain=function(){return qn(this)},vt.prototype.commit=function(){return new _t(this.value(),this.__chain__)},vt.prototype.concat=Qn,vt.prototype.plant=function(e){for(var t,i=this;i instanceof bt;){var n=En(i);t?a.__wrapped__=n:t=n;var a=n;i=i.__wrapped__}return a.__wrapped__=e,t},vt.prototype.reverse=function(){var e=this.__wrapped__,t=function(e){return n&&n.__dir__<0?e:e.reverse()};if(e instanceof xt){var n=e;return this.__actions__.length&&(n=new xt(this)),(n=n.reverse()).__actions__.push({func:Jn,args:[t],thisArg:i}),new _t(n,this.__chain__)}return this.thru(t)},vt.prototype.toString=function(){return this.value()+""},vt.prototype.run=vt.prototype.toJSON=vt.prototype.valueOf=vt.prototype.value=function(){return bi(this.__wrapped__,this.__actions__)},vt.prototype.collect=vt.prototype.map,vt.prototype.head=vt.prototype.first,vt.prototype.select=vt.prototype.filter,vt.prototype.tail=vt.prototype.rest,vt}();ye&&ve?we?(ve.exports=Ge)._=Ge:ye._=Ge:Se._=Ge}).call(Bg)}));const RA={uScaling:{value:new Ce}};class OA{constructor(e,t,i=!0){let n=[0,0];t=t||1;let a,r,s=n[0],o=n[1],l=(e=e||[1,1])[0],c=e[1],h=t+1,u=new Array(h*h);for(a=0;a<h;a++)for(r=0;r<h;r++){u[a*h+r]={x:s+a*(l/t),y:o-r*(c/t),uvx:a/t,uvy:r/t}}let d=6*t*t;i&&(d+=24*t),this.positions=new Float32Array(4*d),this.index=new Array(d);let p=0,m=(e,t,i,n,a)=>{let r=u[t],s=u[i],o=u[n],l=u[a];let c=e=>[e.x,e.y,e.uvx,e.uvy];this.positions.set(c(r),4*(e+0)),this.positions.set(c(s),4*(e+1)),this.positions.set(c(o),4*(e+2)),this.positions.set(c(o),4*(e+3)),this.positions.set(c(s),4*(e+4)),this.positions.set(c(l),4*(e+5)),this.index[e+0]=t,this.index[e+1]=i,this.index[e+2]=n,this.index[e+3]=n,this.index[e+4]=i,this.index[e+5]=a};for(a=0;a<t;a++)for(r=0;r<t;r++,p++){m(6*p,a*h+r,a*h+r+1,(a+1)*h+r,(a+1)*h+r+1)}if(i)for(let e=0;e<4;e++)for(let i=0;i<t;i++,p++){let n,s;0===e?(a=0,r=i):1===e?(a=t,r=i):2===e?(a=i,r=0):3===e&&(a=i,r=t),e<2?(n=u[a*h+r],s=u[a*h+r+1]):(n=u[a*h+r],s=u[(a+1)*h+r]),0!==e&&3!==e||([n,s]=[s,n]);let o=n,l=s;this.positions[24*p]=n.x,this.positions[24*p+1]=n.y,this.positions[4*(6*p+1)]=s.x,this.positions[4*(6*p+1)+1]=s.y,this.positions[4*(6*p+2)]=o.x,this.positions[4*(6*p+2)+1]=o.y,this.positions[4*(6*p+3)]=o.x,this.positions[4*(6*p+3)+1]=o.y,this.positions[4*(6*p+4)]=s.x,this.positions[4*(6*p+4)+1]=s.y,this.positions[4*(6*p+5)]=l.x,this.positions[4*(6*p+5)+1]=l.y,this.positions[24*p+2]=n.uvx,this.positions[24*p+3]=n.uvy,this.positions[4*(6*p+1)+2]=s.uvx,this.positions[4*(6*p+1)+3]=s.uvy,this.positions[4*(6*p+2)+2]=o.uvx+10,this.positions[4*(6*p+2)+3]=o.uvy+10,this.positions[4*(6*p+3)+2]=o.uvx+10,this.positions[4*(6*p+3)+3]=o.uvy+10,this.positions[4*(6*p+4)+2]=s.uvx,this.positions[4*(6*p+4)+3]=s.uvy,this.positions[4*(6*p+5)+2]=l.uvx+10,this.positions[4*(6*p+5)+3]=l.uvy+10}for(d=u.length,this.grid=new Float32Array(4*d),a=0;a<d;a++){let e=u[a];this.grid[4*a+0]=e.x,this.grid[4*a+1]=e.y,this.grid[4*a+2]=e.uvx,this.grid[4*a+3]=e.uvy}}}const DA=function(e){this.value=e};DA.prototype.define=function(e,t){var i=new RegExp("#define "+e+" .*","g"),n="#define "+e+(t?" "+t:"");this.value.match(i)?this.value=this.value.replace(i,n):this.value=n+"\n"+this.value},DA.prototype.clone=function(){return new DA(this.value)};let LA=new DA("precision highp float;\n#define GLSLIFY 1\nuniform mat4 modelMatrix;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 cameraPosition;attribute vec4 position;uniform vec4 uOffset;uniform vec4 uImageryUvOffset;varying vec4 vUV;varying float D;\n#ifdef USE_SHADOWMAP\nuniform bool receiveShadow;\n#if NUM_DIR_LIGHT_SHADOWS > 0\nuniform mat4 directionalShadowMatrix[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS > 0\nuniform mat4 spotShadowMatrix[NUM_SPOT_LIGHT_SHADOWS];varying vec4 vSpotShadowCoord[NUM_SPOT_LIGHT_SHADOWS];struct SpotLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS > 0\nuniform mat4 pointShadowMatrix[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\n#endif\n#define VIRTUAL_TEXTURE_ARRAY_BLOCKS 4.0\n#define VIRTUAL_TEXTURE_ARRAY_SIZE 512.0\n#define TEX_SIZE (VIRTUAL_TEXTURE_ARRAY_SIZE * VIRTUAL_TEXTURE_ARRAY_BLOCKS)\nconst vec2 texelSize=vec2(1.0/TEX_SIZE,0.0);vec4 texture2D_bilinear(const in sampler2D t,in vec2 uv){uv-=0.5*texelSize.xx;vec2 f=fract(uv*TEX_SIZE);vec2 uvSnapped=uv-texelSize.xx*f+0.5*texelSize.xx;\n#ifdef HEIGHT_LOOKUP_BIAS\nvec4 tl=texture2D(t,uvSnapped,-10.0);vec4 tr=texture2D(t,uvSnapped+texelSize,-10.0);vec4 bl=texture2D(t,uvSnapped+texelSize.yx,-10.0);vec4 br=texture2D(t,uvSnapped+texelSize.xx,-10.0);\n#else\nvec4 tl=texture2D(t,uvSnapped);vec4 tr=texture2D(t,uvSnapped+texelSize);vec4 bl=texture2D(t,uvSnapped+texelSize.yx);vec4 br=texture2D(t,uvSnapped+texelSize.xx);\n#endif\nvec4 tA=mix(tl,tr,f.x);vec4 tB=mix(bl,br,f.x);return mix(tA,tB,f.y);}vec4 readTex(in sampler2D tex,in vec2 uv,in float index){vec2 offset=vec2(mod(float(index),VIRTUAL_TEXTURE_ARRAY_BLOCKS),floor(float(index)/VIRTUAL_TEXTURE_ARRAY_BLOCKS));const float padding=0.5;vec2 limits=vec2(padding,VIRTUAL_TEXTURE_ARRAY_SIZE-padding)/VIRTUAL_TEXTURE_ARRAY_SIZE;vec2 scaledUv=(clamp(uv,limits.x,limits.y)+offset)/VIRTUAL_TEXTURE_ARRAY_BLOCKS;\n#ifdef MANUAL_TEXTURE_BILINEAR\nreturn texture2D_bilinear(tex,scaledUv);\n#else\nreturn texture2D(tex,scaledUv);\n#endif\n}uniform highp sampler2D indirectionTexture;uniform vec2 uGlobalOffset;uniform vec3 uSceneScale;float heightScale(in float tileY){float n=3.141592653589793+uSceneScale.x*tileY;float cosh_n=dot(vec2(0.5),exp(vec2(n,-n)));return uSceneScale.y*cosh_n;}uniform lowp sampler2D elevationArray;float getHeight(in vec2 p){const float indirectionSize=1024.0;vec2 tile=p.xy-uGlobalOffset;tile*=uSceneScale.z;tile*=vec2(1.0,-1.0);vec2 indirectionUv=tile/indirectionSize;const vec2 halfTexel=vec2(0.5);vec2 snapped=(floor(tile-halfTexel)+halfTexel);snapped+=step(halfTexel,tile-snapped);vec2 indirectionUvRounded=snapped/indirectionSize;vec4 indirection=texture2D(indirectionTexture,fract(indirectionUvRounded));float index=indirection.r;float tileSize=indirection.g;vec2 tileOrigin=indirection.ba;vec2 scaledUv=indirectionUv*tileSize+tileOrigin;return heightScale(tile.y)*readTex(elevationArray,scaledUv,index).r;}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}vec3 packNormalToRGB(const in vec3 normal){return normalize(normal)*0.5+0.5;}vec3 unpackRGBToNormal(const in vec3 rgb){return 2.0*rgb.xyz-1.0;}const float PackUpscale=256./255.;const float UnpackDownscale=255./256.;const vec3 PackFactors=vec3(256.*256.*256.,256.*256.,256.);const vec4 UnpackFactors=UnpackDownscale/vec4(PackFactors,1.);const float ShiftRight8=1./256.;vec4 packDepthToRGBA(const in float v){vec4 r=vec4(fract(v*PackFactors),v);r.yzw-=r.xyz*ShiftRight8;return r*PackUpscale;}float unpackRGBAToDepth(const in vec4 v){return dot(v,UnpackFactors);}vec4 pack2HalfToRGBA(vec2 v){vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}vec2 unpackRGBATo2Half(vec4 v){return vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));}float viewZToOrthographicDepth(const in float viewZ,const in float near,const in float far){return(viewZ+near)/(near-far);}float orthographicDepthToViewZ(const in float linearClipZ,const in float near,const in float far){return linearClipZ*(near-far)-near;}float viewZToPerspectiveDepth(const in float viewZ,const in float near,const in float far){return((near+viewZ)*far)/((far-near)*viewZ);}float perspectiveDepthToViewZ(const in float invClipZ,const in float near,const in float far){return(near*far)/((far-near)*invClipZ-far);}void main(){vec4 p=vec4(position.xy,0.0,1.0);p.xy*=uOffset.z;p.xy+=uOffset.xy;vec2 skirt=10.0*floor(position.zw/10.0);vec2 uv=position.zw-skirt;p.z=getHeight(p.xy);p.z-=0.01*uOffset.z*skirt.x;vUV.xy=uImageryUvOffset.z*uv.xy+uImageryUvOffset.xy;vUV.zw=uv.xy;vec4 worldPosition=modelMatrix*p;vec4 mvPosition=viewMatrix*worldPosition;D=-mvPosition.z;gl_Position=projectionMatrix*viewMatrix*worldPosition;\n#ifdef USE_SHADOWMAP\nif(receiveShadow){\n#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\nvec3 shadowWorldNormal=inverseTransformDirection(vec3(0.0,1.0,0.0),viewMatrix);vec4 shadowWorldPosition;\n#endif\n#if NUM_DIR_LIGHT_SHADOWS > 0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*directionalLightShadows[i].shadowNormalBias,0);vDirectionalShadowCoord[i]=directionalShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS > 0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*spotLightShadows[i].shadowNormalBias,0);vSpotShadowCoord[i]=spotShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS > 0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*pointLightShadows[i].shadowNormalBias,0);vPointShadowCoord[i]=pointShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n}\n#endif\n}"),kA=new DA("precision highp float;\n#define GLSLIFY 1\nuniform mat4 modelMatrix;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 cameraPosition;attribute vec4 position;uniform vec4 uOffset;uniform vec4 uImageryUvOffset;varying vec4 vUV;varying float D;varying vec4 coord;\n#define VIRTUAL_TEXTURE_ARRAY_BLOCKS 4.0\n#define VIRTUAL_TEXTURE_ARRAY_SIZE 512.0\n#define TEX_SIZE (VIRTUAL_TEXTURE_ARRAY_SIZE * VIRTUAL_TEXTURE_ARRAY_BLOCKS)\nconst vec2 texelSize=vec2(1.0/TEX_SIZE,0.0);vec4 texture2D_bilinear(const in sampler2D t,in vec2 uv){uv-=0.5*texelSize.xx;vec2 f=fract(uv*TEX_SIZE);vec2 uvSnapped=uv-texelSize.xx*f+0.5*texelSize.xx;\n#ifdef HEIGHT_LOOKUP_BIAS\nvec4 tl=texture2D(t,uvSnapped,-10.0);vec4 tr=texture2D(t,uvSnapped+texelSize,-10.0);vec4 bl=texture2D(t,uvSnapped+texelSize.yx,-10.0);vec4 br=texture2D(t,uvSnapped+texelSize.xx,-10.0);\n#else\nvec4 tl=texture2D(t,uvSnapped);vec4 tr=texture2D(t,uvSnapped+texelSize);vec4 bl=texture2D(t,uvSnapped+texelSize.yx);vec4 br=texture2D(t,uvSnapped+texelSize.xx);\n#endif\nvec4 tA=mix(tl,tr,f.x);vec4 tB=mix(bl,br,f.x);return mix(tA,tB,f.y);}vec4 readTex(in sampler2D tex,in vec2 uv,in float index){vec2 offset=vec2(mod(float(index),VIRTUAL_TEXTURE_ARRAY_BLOCKS),floor(float(index)/VIRTUAL_TEXTURE_ARRAY_BLOCKS));const float padding=0.5;vec2 limits=vec2(padding,VIRTUAL_TEXTURE_ARRAY_SIZE-padding)/VIRTUAL_TEXTURE_ARRAY_SIZE;vec2 scaledUv=(clamp(uv,limits.x,limits.y)+offset)/VIRTUAL_TEXTURE_ARRAY_BLOCKS;\n#ifdef MANUAL_TEXTURE_BILINEAR\nreturn texture2D_bilinear(tex,scaledUv);\n#else\nreturn texture2D(tex,scaledUv);\n#endif\n}uniform highp sampler2D indirectionTexture;uniform vec2 uGlobalOffset;uniform vec3 uSceneScale;float heightScale(in float tileY){float n=3.141592653589793+uSceneScale.x*tileY;float cosh_n=dot(vec2(0.5),exp(vec2(n,-n)));return uSceneScale.y*cosh_n;}uniform lowp sampler2D elevationArray;float getHeight(in vec2 p){const float indirectionSize=1024.0;vec2 tile=p.xy-uGlobalOffset;tile*=uSceneScale.z;tile*=vec2(1.0,-1.0);vec2 indirectionUv=tile/indirectionSize;const vec2 halfTexel=vec2(0.5);vec2 snapped=(floor(tile-halfTexel)+halfTexel);snapped+=step(halfTexel,tile-snapped);vec2 indirectionUvRounded=snapped/indirectionSize;vec4 indirection=texture2D(indirectionTexture,fract(indirectionUvRounded));float index=indirection.r;float tileSize=indirection.g;vec2 tileOrigin=indirection.ba;vec2 scaledUv=indirectionUv*tileSize+tileOrigin;return heightScale(tile.y)*readTex(elevationArray,scaledUv,index).r;}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}vec3 packNormalToRGB(const in vec3 normal){return normalize(normal)*0.5+0.5;}vec3 unpackRGBToNormal(const in vec3 rgb){return 2.0*rgb.xyz-1.0;}const float PackUpscale=256./255.;const float UnpackDownscale=255./256.;const vec3 PackFactors=vec3(256.*256.*256.,256.*256.,256.);const vec4 UnpackFactors=UnpackDownscale/vec4(PackFactors,1.);const float ShiftRight8=1./256.;vec4 packDepthToRGBA(const in float v){vec4 r=vec4(fract(v*PackFactors),v);r.yzw-=r.xyz*ShiftRight8;return r*PackUpscale;}float unpackRGBAToDepth(const in vec4 v){return dot(v,UnpackFactors);}vec4 pack2HalfToRGBA(vec2 v){vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}vec2 unpackRGBATo2Half(vec4 v){return vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));}float viewZToOrthographicDepth(const in float viewZ,const in float near,const in float far){return(viewZ+near)/(near-far);}float orthographicDepthToViewZ(const in float linearClipZ,const in float near,const in float far){return linearClipZ*(near-far)-near;}float viewZToPerspectiveDepth(const in float viewZ,const in float near,const in float far){return((near+viewZ)*far)/((far-near)*viewZ);}float perspectiveDepthToViewZ(const in float invClipZ,const in float near,const in float far){return(near*far)/((far-near)*invClipZ-far);}void main(){vec4 p=vec4(position.xy,0.0,1.0);p.xy*=uOffset.z;p.xy+=uOffset.xy;vec2 skirt=10.0*floor(position.zw/10.0);vec2 uv=position.zw-skirt;p.z=getHeight(p.xy);vUV.xy=uImageryUvOffset.z*uv.xy+uImageryUvOffset.xy;vUV.zw=uv.xy;vec4 worldPosition=modelMatrix*p;vec4 mvPosition=viewMatrix*worldPosition;D=-mvPosition.z;coord=worldPosition;gl_Position=projectionMatrix*viewMatrix*worldPosition;}"),NA=new DA("precision highp float;\n#define GLSLIFY 1\nvarying vec4 vUV;varying float D;uniform lowp sampler2D imageryArray;uniform float uStyle;uniform vec3 uMaskColor;uniform vec3 fogColor;uniform float fogNear;uniform float fogFar;uniform float opacity;uniform vec3 ambientLightColor;uniform vec3 lightProbe[9];uniform bool receiveShadow;uniform vec4 uImageryUvOffset;\n#if 1 > 0\nstruct DirectionalLight{vec3 direction;vec3 color;};uniform DirectionalLight directionalLights[1];\n#endif\nvec3 packNormalToRGB(const in vec3 normal){return normalize(normal)*0.5+0.5;}vec3 unpackRGBToNormal(const in vec3 rgb){return 2.0*rgb.xyz-1.0;}const float PackUpscale=256./255.;const float UnpackDownscale=255./256.;const vec3 PackFactors=vec3(256.*256.*256.,256.*256.,256.);const vec4 UnpackFactors=UnpackDownscale/vec4(PackFactors,1.);const float ShiftRight8=1./256.;vec4 packDepthToRGBA(const in float v){vec4 r=vec4(fract(v*PackFactors),v);r.yzw-=r.xyz*ShiftRight8;return r*PackUpscale;}float unpackRGBAToDepth(const in vec4 v){return dot(v,UnpackFactors);}vec4 pack2HalfToRGBA(vec2 v){vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}vec2 unpackRGBATo2Half(vec4 v){return vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));}float viewZToOrthographicDepth(const in float viewZ,const in float near,const in float far){return(viewZ+near)/(near-far);}float orthographicDepthToViewZ(const in float linearClipZ,const in float near,const in float far){return linearClipZ*(near-far)-near;}float viewZToPerspectiveDepth(const in float viewZ,const in float near,const in float far){return((near+viewZ)*far)/((far-near)*viewZ);}float perspectiveDepthToViewZ(const in float invClipZ,const in float near,const in float far){return(near*far)/((far-near)*invClipZ-far);}\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS > 0\nuniform sampler2D directionalShadowMap[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\nfloat texture2DCompare(sampler2D depths,vec2 uv,float compare){return step(compare,unpackRGBAToDepth(texture2D(depths,uv)));}vec2 texture2DDistribution(sampler2D shadow,vec2 uv){return unpackRGBATo2Half(texture2D(shadow,uv));}float VSMShadow(sampler2D shadow,vec2 uv,float compare){float occlusion=1.0;vec2 distribution=texture2DDistribution(shadow,uv);float hard_shadow=step(compare,distribution.x);if(hard_shadow!=1.0){float distance=compare-distribution.x;float variance=max(0.00000,distribution.y*distribution.y);float softness_probability=variance/(variance+distance*distance);softness_probability=clamp((softness_probability-0.3)/(0.95-0.3),0.0,1.0);occlusion=clamp(max(hard_shadow,softness_probability),0.0,1.0);}return occlusion;}float getShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord){float shadow=1.0;shadowCoord.xyz/=shadowCoord.w;shadowCoord.z+=shadowBias;bvec4 inFrustumVec=bvec4(shadowCoord.x>=0.0,shadowCoord.x<=1.0,shadowCoord.y>=0.0,shadowCoord.y<=1.0);bool inFrustum=all(inFrustumVec);bvec2 frustumTestVec=bvec2(inFrustum,shadowCoord.z<=1.0);bool frustumTest=all(frustumTestVec);if(frustumTest){\n#if defined( SHADOWMAP_TYPE_PCF )\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx0=-texelSize.x*shadowRadius;float dy0=-texelSize.y*shadowRadius;float dx1=+texelSize.x*shadowRadius;float dy1=+texelSize.y*shadowRadius;float dx2=dx0/2.0;float dy2=dy0/2.0;float dx3=dx1/2.0;float dy3=dy1/2.0;shadow=(texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy1),shadowCoord.z))*(1.0/17.0);\n#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx=texelSize.x;float dy=texelSize.y;vec2 uv=shadowCoord.xy;vec2 f=fract(uv*shadowMapSize+0.5);uv-=f*texelSize;shadow=(texture2DCompare(shadowMap,uv,shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(dx,0.0),shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(0.0,dy),shadowCoord.z)+texture2DCompare(shadowMap,uv+texelSize,shadowCoord.z)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,0.0),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,0.0),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,dy),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(0.0,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(0.0,2.0*dy),shadowCoord.z),f.y)+mix(texture2DCompare(shadowMap,uv+vec2(dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(dx,2.0*dy),shadowCoord.z),f.y)+mix(mix(texture2DCompare(shadowMap,uv+vec2(-dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,-dy),shadowCoord.z),f.x),mix(texture2DCompare(shadowMap,uv+vec2(-dx,2.0*dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,2.0*dy),shadowCoord.z),f.x),f.y))*(1.0/9.0);\n#elif defined( SHADOWMAP_TYPE_VSM )\nshadow=VSMShadow(shadowMap,shadowCoord.xy,shadowCoord.z);\n#else\nshadow=texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);\n#endif\n}return shadow;}vec2 cubeToUV(vec3 v,float texelSizeY){vec3 absV=abs(v);float scaleToCube=1.0/max(absV.x,max(absV.y,absV.z));absV*=scaleToCube;v*=scaleToCube*(1.0-2.0*texelSizeY);vec2 planar=v.xy;float almostATexel=1.5*texelSizeY;float almostOne=1.0-almostATexel;if(absV.z>=almostOne){if(v.z>0.0)planar.x=4.0-v.x;}else if(absV.x>=almostOne){float signX=sign(v.x);planar.x=v.z*signX+2.0*signX;}else if(absV.y>=almostOne){float signY=sign(v.y);planar.x=v.x+2.0*signY+2.0;planar.y=v.z*signY-2.0;}return vec2(0.125,0.25)*planar+vec2(0.375,0.75);}float getPointShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord,float shadowCameraNear,float shadowCameraFar){vec2 texelSize=vec2(1.0)/(shadowMapSize*vec2(4.0,2.0));vec3 lightToPosition=shadowCoord.xyz;float dp=(length(lightToPosition)-shadowCameraNear)/(shadowCameraFar-shadowCameraNear);dp+=shadowBias;vec3 bd3D=normalize(lightToPosition);\n#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\nvec2 offset=vec2(-1,1)*shadowRadius*texelSize.y;return(texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxx,texelSize.y),dp))*(1.0/9.0);\n#else\nreturn texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp);\n#endif\n}\n#endif\nfloat fogFactor(in float dist){float fog=smoothstep(fogNear,fogFar,dist);return clamp(fog,0.0,1.0);}float fogFactor(in vec3 camera,in vec3 pos){float dist=distance(camera,pos);return fogFactor(dist);}\n#define VIRTUAL_TEXTURE_ARRAY_BLOCKS 16.0\n#define VIRTUAL_TEXTURE_ARRAY_SIZE 256.0\n#define TEX_SIZE (VIRTUAL_TEXTURE_ARRAY_SIZE * VIRTUAL_TEXTURE_ARRAY_BLOCKS)\nconst vec2 texelSize=vec2(1.0/TEX_SIZE,0.0);vec4 texture2D_bilinear(const in sampler2D t,in vec2 uv){uv-=0.5*texelSize.xx;vec2 f=fract(uv*TEX_SIZE);vec2 uvSnapped=uv-texelSize.xx*f+0.5*texelSize.xx;\n#ifdef HEIGHT_LOOKUP_BIAS\nvec4 tl=texture2D(t,uvSnapped,-10.0);vec4 tr=texture2D(t,uvSnapped+texelSize,-10.0);vec4 bl=texture2D(t,uvSnapped+texelSize.yx,-10.0);vec4 br=texture2D(t,uvSnapped+texelSize.xx,-10.0);\n#else\nvec4 tl=texture2D(t,uvSnapped);vec4 tr=texture2D(t,uvSnapped+texelSize);vec4 bl=texture2D(t,uvSnapped+texelSize.yx);vec4 br=texture2D(t,uvSnapped+texelSize.xx);\n#endif\nvec4 tA=mix(tl,tr,f.x);vec4 tB=mix(bl,br,f.x);return mix(tA,tB,f.y);}vec4 readTex(in sampler2D tex,in vec2 uv,in float index){vec2 offset=vec2(mod(float(index),VIRTUAL_TEXTURE_ARRAY_BLOCKS),floor(float(index)/VIRTUAL_TEXTURE_ARRAY_BLOCKS));const float padding=0.5;vec2 limits=vec2(padding,VIRTUAL_TEXTURE_ARRAY_SIZE-padding)/VIRTUAL_TEXTURE_ARRAY_SIZE;vec2 scaledUv=(clamp(uv,limits.x,limits.y)+offset)/VIRTUAL_TEXTURE_ARRAY_BLOCKS;\n#ifdef MANUAL_TEXTURE_BILINEAR\nreturn texture2D_bilinear(tex,scaledUv);\n#else\nreturn texture2D(tex,scaledUv);\n#endif\n}float getShadowMask(){float shadow=1.0;\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS > 0\nDirectionalLightShadow directionalLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){directionalLight=directionalLightShadows[i];shadow*=receiveShadow ? getShadow(directionalShadowMap[i],directionalLight.shadowMapSize,directionalLight.shadowBias,directionalLight.shadowRadius,vDirectionalShadowCoord[i]): 1.0;}\n#pragma unroll_loop_end\n#endif\n#endif\nreturn shadow;}vec3 shGetIrradianceAt(in vec3 normal,in vec3 shCoefficients[9]){float x=normal.x,y=normal.y,z=normal.z;vec3 result=shCoefficients[0]*0.886227;result+=shCoefficients[1]*2.0*0.511664*y;result+=shCoefficients[2]*2.0*0.511664*z;result+=shCoefficients[3]*2.0*0.511664*x;result+=shCoefficients[4]*2.0*0.429043*x*y;result+=shCoefficients[5]*2.0*0.429043*y*z;result+=shCoefficients[6]*(0.743125*z*z-0.247708);result+=shCoefficients[7]*2.0*0.429043*x*z;result+=shCoefficients[8]*0.429043*(x*x-y*y);return result;}void main(){vec3 color=readTex(imageryArray,vUV.xy,uImageryUvOffset.w).rgb;vec3 irradiance=ambientLightColor;vec3 shadowLightsIrradiance=vec3(0.0);\n#if 1 > 0\nDirectionalLight directionalLight;\n#pragma unroll_loop_start\nfor(int i=0;i<1;i++){directionalLight=directionalLights[i];shadowLightsIrradiance+=directionalLight.color;}\n#pragma unroll_loop_end\n#endif\nvec3 shadowStep=step(irradiance,shadowLightsIrradiance/2.0);if(uStyle>0.0){float grey=color.r*0.2989+color.g*0.587+color.b*0.114;if(uStyle==1.0){color=vec3(1.0-color.r,1.0*color.g,1.0-color.b);}if(uStyle==2.0){color=vec3(grey);color*=uMaskColor;}if(uStyle==12.0){color=vec3(1.0-color.r,1.0-color.g,1.0-color.b);grey=color.r*0.2989+color.g*0.587+color.b*0.114;color=vec3(grey);color*=uMaskColor;}if(uStyle==3.0){vec3 maskColor=clamp(uMaskColor,vec3(0.004,0.004,0.004),vec3(1.0,1.0,1.0));color=vec3(1.0-(1.0-grey)/maskColor.r,1.0-(1.0-grey)/maskColor.g,1.0-(1.0-grey)/maskColor.b);}if(uStyle==4.0){color=vec3(grey+uMaskColor.r-1.0,grey+uMaskColor.g-1.0,grey+uMaskColor.b-1.0);}if(uStyle==15.0){color=vec3(1.0-color.r,1.0-color.g,1.0-color.b);grey=color.r*0.2989+color.g*0.587+color.b*0.114;color=vec3(grey);color=(2.0*uMaskColor-vec3(1.0))*(sqrt(color)-color)+color;}}if(receiveShadow){color*=irradiance+shadowLightsIrradiance/2.0*shadowStep*getShadowMask();}else{color*=irradiance+(shadowLightsIrradiance/2.0)*shadowStep;}float fogAmount=fogFactor(D);color=mix(color,fogColor,fogAmount);gl_FragColor=vec4(color,opacity);}"),BA=new DA("precision highp float;\n#define GLSLIFY 1\nuniform int uPass;varying vec4 vUV;varying vec4 coord;const float PackUpscale=256./255.;const vec3 PackFactors=vec3(256.*256.*256.,256.*256.,256.);const float ShiftRight8=1./256.;vec4 packDepthToRGBA(const in float v){vec4 r=vec4(fract(v*PackFactors),v);r.yzw-=r.xyz*ShiftRight8;return r*PackUpscale;}vec4 packToRGBA(const in float v){if(v>8388608.||v<-8388608.){return vec4(0.0,0.0,0.0,0.0);}float a=v;a+=8388608.;float r=floor(a/65536.);a-=r*65536.;float g=floor(a/256.);a-=g*256.;float b=floor(a);a-=b;a=255.-floor(0.5+a*10.);return vec4(1.,1.,1.,0.5);return vec4(r/255.,g/255.,b/255.,0.5);return vec4(r/255.,g/255.,b/255.,a/255.);}vec4 packToRGBAFloat(const in float v){return vec4(vec3(v),1.);}vec4 packToRGBA2000(const in float v){float a=v;a+=1000.;return vec4(a/2000.,1.,1.,1.);}vec4 packToRGBADEC(float v){float r=floor(abs(v)/1000000.);float g=floor((abs(v)-r*1000000.)/10000.);float b=floor((abs(v)-r*1000000.-g*10000.)/100.);float a=abs(v)-r*1000000.-g*10000.-b*100.;if(v<0.){r+=100.;}return vec4(r/255.,g/255.,b/255.,a/255.);}vec4 packToRGBAFract(const in float v){return vec4(v/65536.,v-floor(v/256.)*256.,1.,1.);}vec4 packToRGBAFloor(const in float v){float sign=v/abs(v);return vec4(floor(abs(v)/256.)/255.0,fract(abs(v)/256.),(sign+1.0)/2.0,fract(abs(v))+0.5);}void main(){gl_FragColor=vec4(coord.xyz,1.);}"),zA=new DA("#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nuniform mat4 viewMatrix;uniform mat4 projectionMatrix;in vec4 position;uniform vec4 uOffset;uniform vec4 uImageryUvOffset;uniform vec3 uScaling;out vec4 vUV;\n#define MANUAL_TEXTURE_BILINEAR 1\n#define VIRTUAL_TEXTURE_ARRAY_BLOCKS 4.0\n#define VIRTUAL_TEXTURE_ARRAY_SIZE 512.0\n#define TEX_SIZE (VIRTUAL_TEXTURE_ARRAY_SIZE * VIRTUAL_TEXTURE_ARRAY_BLOCKS)\nconst vec2 texelSize=vec2(1.0/TEX_SIZE,0.0);vec4 texture2D_bilinear(const in sampler2D t,in vec2 uv){uv-=0.5*texelSize.xx;vec2 f=fract(uv*TEX_SIZE);vec2 uvSnapped=uv-texelSize.xx*f+0.5*texelSize.xx;\n#ifdef HEIGHT_LOOKUP_BIAS\nvec4 tl=texture(t,uvSnapped,-10.0);vec4 tr=texture(t,uvSnapped+texelSize,-10.0);vec4 bl=texture(t,uvSnapped+texelSize.yx,-10.0);vec4 br=texture(t,uvSnapped+texelSize.xx,-10.0);\n#else\nvec4 tl=texture(t,uvSnapped);vec4 tr=texture(t,uvSnapped+texelSize);vec4 bl=texture(t,uvSnapped+texelSize.yx);vec4 br=texture(t,uvSnapped+texelSize.xx);\n#endif\nvec4 tA=mix(tl,tr,f.x);vec4 tB=mix(bl,br,f.x);return mix(tA,tB,f.y);}vec4 readTex(in sampler2D tex,in vec2 uv,in float index){vec2 offset=vec2(mod(float(index),VIRTUAL_TEXTURE_ARRAY_BLOCKS),floor(float(index)/VIRTUAL_TEXTURE_ARRAY_BLOCKS));const float padding=0.5;vec2 limits=vec2(padding,VIRTUAL_TEXTURE_ARRAY_SIZE-padding)/VIRTUAL_TEXTURE_ARRAY_SIZE;vec2 scaledUv=(clamp(uv,limits.x,limits.y)+offset)/VIRTUAL_TEXTURE_ARRAY_BLOCKS;\n#ifdef MANUAL_TEXTURE_BILINEAR\nreturn texture2D_bilinear(tex,scaledUv);\n#else\nreturn texture(tex,scaledUv);\n#endif\n}uniform highp sampler2D indirectionTexture;uniform vec2 uGlobalOffset;uniform vec3 uSceneScale;float heightScale(in float tileY){float n=3.141592653589793+uSceneScale.x*tileY;float cosh_n=dot(vec2(0.5),exp(vec2(n,-n)));return uSceneScale.y*cosh_n;}uniform lowp sampler2D elevationArray;float getHeight(in vec2 p){const float indirectionSize=1024.0;vec2 tile=p.xy-uGlobalOffset;tile*=uSceneScale.z;tile*=vec2(1.0,-1.0);vec2 indirectionUv=tile/indirectionSize;const vec2 halfTexel=vec2(0.5);vec2 snapped=(floor(tile-halfTexel)+halfTexel);snapped+=step(halfTexel,tile-snapped);vec2 indirectionUvRounded=snapped/indirectionSize;vec4 indirection=texture(indirectionTexture,fract(indirectionUvRounded));float index=indirection.r;float tileSize=indirection.g;vec2 tileOrigin=indirection.ba;vec2 scaledUv=indirectionUv*tileSize+tileOrigin;return heightScale(tile.y)*readTex(elevationArray,scaledUv,index).r;}void main(){vec4 p=vec4(position.xy,0.0,1.0);p.xy*=uOffset.z;p.xy+=uOffset.xy;vec2 skirt=10.0*floor(position.zw/10.0);vec2 uv=position.zw-skirt;p.z=getHeight(p.xy);p.z-=0.01*uOffset.z*skirt.x;float tileId=uOffset.w;vec2 encodedTileId=vec2(floor(tileId/256.0)/256.0,fract(tileId/256.0))*(256.0/255.0);vUV.xy=uv.xy*uScaling.z;vUV.zw=encodedTileId;vec4 pYUp=vec4(p.x,p.z,-p.y,p.w);gl_Position=projectionMatrix*viewMatrix*pYUp;}"),UA=new DA("#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nuniform vec3 uScaling;in vec4 vUV;out highp vec4 pc_fragColor;void main(){vec2 deltaUV=dFdx(vUV.xy);float err=log2(length(deltaUV));vec2 encodedTileId=vUV.zw;float encodedError=0.1*err+0.5;float scaledZ=256.0*255.0*gl_FragCoord.z;vec2 encodedZ=vec2(floor(scaledZ/256.0),mod(scaledZ,256.0))/255.0;float isCenter=step(distance(gl_FragCoord.xy,uScaling.xy),4.0);vec4 standard=vec4(encodedTileId,0.0,encodedError);vec4 centerPixels=vec4(0.0,0.0,encodedZ);pc_fragColor=mix(standard,centerPixels,isCenter);}");[LA,kA,zA].forEach((e=>{cA||e.define("MANUAL_TEXTURE_BILINEAR","1"),e.define("VIRTUAL_TEXTURE_ARRAY_BLOCKS",Math.sqrt(sA).toExponential()),e.define("VIRTUAL_TEXTURE_ARRAY_SIZE",oA.toExponential())})),NA.define("VIRTUAL_TEXTURE_ARRAY_BLOCKS",Math.sqrt(lA).toExponential()),NA.define("VIRTUAL_TEXTURE_ARRAY_SIZE",256..toExponential()),BA.define("VIRTUAL_TEXTURE_ARRAY_BLOCKS",Math.sqrt(lA).toExponential()),BA.define("VIRTUAL_TEXTURE_ARRAY_SIZE",256..toExponential());let FA=[],jA=1;class HA{constructor(){this.id=jA++;const e=this.refreshIndices.bind(this);HA.imageryDatasource&&HA.imageryDatasource.addListener(e),HA.elevationDatasource&&HA.elevationDatasource.addListener(e);let t=HA.geometry[64];t=t.getGeometry(),this.offset=new Me(0,0,1,1),this.imageryUvOffset=new Me,this.terrainMaterial=new wo({uniforms:PA.assign({uOffset:{value:this.offset},uImageryUvOffset:{value:this.imageryUvOffset},receiveShadow:{value:!!HA.receiveShadow},ambientLightColor:{value:null},lightProbe:{value:null},directionalLights:{value:null},directionalLightShadows:{value:null},spotLights:{value:null},spotLightShadows:{value:null},rectAreaLights:{value:null},ltc_1:{value:null},ltc_2:{value:null},pointLights:{value:null},pointLightShadows:{value:null},hemisphereLights:{value:null},directionalShadowMap:{value:null},directionalShadowMatrix:{value:null},spotShadowMap:{value:null},spotShadowMatrix:{value:null},pointShadowMap:{value:null},pointShadowMatrix:{value:null},shadowMapType:{value:null},imageryArray:{value:HA.imageryDatasource.textureArray},opacity:{type:"f",value:HA.opacity}},HA.fogUniforms,HA.styleUniforms,Ep.pgl.heightUniforms),vertexShader:LA.value,fragmentShader:NA.value,transparent:!0}),this.terrainMaterial.name="TerrainMaterialImagery",this.terrainMaterial.fog=!0,this.terrainMaterial.polygonOffset=!0,this.terrainMaterial.polygonOffsetFactor=2,this.terrainMaterial.polygonOffsetUnits=1,this.terrainMaterial.lights=!0,this.terrainCoordMaterial=new wo({uniforms:PA.assign({uOffset:{value:this.offset},uImageryUvOffset:{value:this.imageryUvOffset},uPass:{value:0}},Ep.pgl.heightUniforms),vertexShader:kA.value,fragmentShader:BA.value,transparent:!0}),this.terrainPickerMaterial=new wo({uniforms:PA.assign({uOffset:{value:this.offset},uImageryUvOffset:{value:this.imageryUvOffset},receiveShadow:{value:!!HA.receiveShadow},ambientLightColor:{value:null},lightProbe:{value:null},directionalLights:{value:null},directionalLightShadows:{value:null},spotLights:{value:null},spotLightShadows:{value:null},rectAreaLights:{value:null},ltc_1:{value:null},ltc_2:{value:null},pointLights:{value:null},pointLightShadows:{value:null},hemisphereLights:{value:null},directionalShadowMap:{value:null},directionalShadowMatrix:{value:null},spotShadowMap:{value:null},spotShadowMatrix:{value:null},pointShadowMap:{value:null},pointShadowMatrix:{value:null},shadowMapType:{value:null}},Ep.pgl.heightUniforms,RA),vertexShader:zA.value,fragmentShader:UA.value}),this.mesh=new Fi(t,this.terrainMaterial),this.mesh.receiveShadow=!0,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,new Ce,this.mesh.raycast=function(e,t){},this.terrainPickerMaterial.name="TerrainMaterialPicker",this.pickerMesh=new Fi(t,this.terrainPickerMaterial),this.init(...arguments)}init(e,t,i){if(isNaN(e)||isNaN(t)||isNaN(i))throw Error("Invalid tile initialization");this.wasSeen=!1,this.wasRendered=!1,Ep.scene.pgl.add(this.mesh),Ep.scene.tilepickerScene.add(this.pickerMesh),this.x=e,this.y=t,this.z=i;let n=Math.max(2,this.z-(HA.elevationDatasource?HA.elevationDatasource.maxZoom:0));this.x2=Math.floor(this.x/Math.pow(2,n)),this.y2=Math.floor(this.y/Math.pow(2,n)),this.z2=this.z-n;let a=1024/Math.pow(2,n);a=Math.min(64,Math.max(1,a));let r=HA.geometry[a].clone();r=r.getGeometry();let s=HA.geometry[Math.max(1,a/8)].clone();s=s.getGeometry(),this.mesh.geometry=r,this.pickerMesh.geometry=s,this.calculateOffset(),this.imageryKey=tA.tileToQuadkey([this.x,this.y,this.z]),this.elevationKey=tA.tileToQuadkey([this.x2,this.y2,this.z2]),this.imageryIndex=0,this.elevationIndex=0;let o=new Ce(this.offset.x+.5*this.offset.z,this.offset.y-.5*this.offset.z,.5*this.offset.w*3800),l=Math.max(.5*this.offset.w*4200,.5*this.offset.z);l*=Math.sqrt(3);let c=new Xe(o,l);return this.mesh.geometry.boundingSphere=c,this.pickerMesh.geometry.boundingSphere=c,this}calculateOffset(){const e=Ep.pgl.geoproject.sceneScale,t=Ep.pgl.geoproject.globalOffset;let i=Math.pow(2,15-this.z)*e;this.offset.set(this.x*i+t.x,-this.y*i+t.y,i,this.id)}split(){let e=tA.getChildren([this.x,this.y,this.z]);return e=[this.init(...e[0]),HA.next(...e[1]),HA.next(...e[2]),HA.next(...e[3])],e}grow(){return this.init(...tA.getParent([this.x,this.y,this.z])),this}shift(e,t,i){i>this.z&&console.error("Cannot shift at zoom level bigger than this.z");const n=Math.round(this.x+e*Math.pow(2,this.z-i)),a=Math.round(this.y+t*Math.pow(2,this.z-i));return this.init(n,a,this.z),this}recycle(){FA.push(this),Ep.scene.pgl.remove(this.mesh),Ep.scene.tilepickerScene.remove(this.pickerMesh)}fetchData(){this.wasSeen||this.z<8?(HA.elevationDatasource&&HA.elevationDatasource.fetchIfNeeded(this.elevationKey),HA.imageryDatasource&&HA.imageryDatasource.fetchIfNeeded(this.imageryKey)):this.wasRendered&&this.z>10?HA.imageryDatasource&&HA.imageryDatasource.fetchIfNeeded(this.imageryKey.slice(0,-2)):(HA.imageryDatasource&&HA.imageryDatasource.fetchIfNeeded(this.imageryKey.slice(0,5)),HA.elevationDatasource&&HA.elevationDatasource.fetchIfNeeded(this.elevationKey.slice(0,5))),this.refreshIndices()}calculateImageryOffset(e){let t=e.quadkey?this.imageryKey.length-e.quadkey.length:0,i=Math.pow(2,-t),[n,a]=e.quadkey?tA.quadkeyToTile(e.quadkey):[this.x,this.y,this.z];this.imageryUvOffset.set(this.x*i-n,this.y*i-a,i,this.imageryIndex)}refreshIndices(){let e=tA.quadkeyToTile(this.imageryKey),t=tA.tileToQuadkey(e);HA.elevationDatasource&&(this.elevationIndex=HA.elevationDatasource.findBestAvailableData(t,!0).index),HA.imageryDatasource&&(this.bestImagery=HA.imageryDatasource.findBestAvailableData(this.imageryKey)),this.imageryIndex=this.bestImagery.index,this.calculateImageryOffset(this.bestImagery)}onSeen(){HA.elevationDatasource&&HA.elevationDatasource.indexPool.tap(this.elevationIndex),HA.imageryDatasource&&HA.imageryDatasource.indexPool.tap(this.imageryIndex)}}HA.next=function(){return FA.length>0?FA.splice(0,1)[0].init(...arguments):new HA(...arguments)},HA.clear=function(){const e=FA;FA=[],jA=1;for(const t of e)_y.disposeThreeObject(t.mesh),_y.disposeThreeObject(t.pickerMesh)},HA.tilePool=function(){return FA},HA.opacity=1,HA.fogUniforms||(HA.fogUniforms={fogColor:{type:"c",value:new Qt(16777215)},fogNear:{type:"f",value:0},fogFar:{type:"f",value:0}}),HA.styleUniforms||(HA.styleUniforms={uStyle:{type:"f",value:0},uMaskColor:{type:"c",value:new Qt(16777215)}}),wi.prototype.getGeometry=function(){return this};let GA=64;for(HA.geometry=[];GA>=1;){let e=new OA([1,1],GA),t=new wi;t.setAttribute("position",new hi(e.positions,4)),HA.geometry[GA]=t;let i=new OA([1,1],GA,!1),n=new wi;n.setAttribute("position",new hi(i.positions,4)),t.other=n,n.other=t,t.getGeometry=s.bind(t,!0),n.getGeometry=s.bind(n,!1);const a=t.clone.bind(t);t.clone=function(e=!0){const t=a();if(t.getGeometry=s.bind(t,!0),!0===e){const e=this.other.clone(!1);t.other=e,e.other=t}return t};const r=n.clone.bind(n);function s(e){return e?HA.opacity>=1?this:this.other:HA.opacity>=1?this.other:this}n.clone=function(e=!0){const t=r();if(t.getGeometry=s.bind(t,!1),!0===e){const e=this.other.clone(!1);t.other=e,e.other=t}return t},GA/=2}class VA{constructor({scene:e,renderer:t,camera:i,imageryDatasource:n,elevationDatasource:a,minError:r=-1.5,maxError:s=0,receiveShadow:o=!1}){this.scene=e,this.renderer=t,this.shiftThreshold=1/0,this.x=0,this.y=0,this.z=0,this.baseZ=5,this.tileDelta=new ye,this.minError=r,this.maxError=s,this._receiveShadow=o,HA.receiveShadow=o,n&&n.urlFormat&&(this.imageryDatasource=new IA({urlFormat:n.urlFormat,maxZoom:n.maxZoom||18,textureSize:n.textureSize||256,poolSize:n.poolSize||lA,apiKey:n.apiKey||"",flipY:"boolean"==typeof n.flipY&&n.flipY}),a&&a.urlFormat&&(this.elevationDatasource=new IA({urlFormat:a.urlFormat,maxZoom:a.maxZoom||12,textureSize:a.textureSize||oA,pixelEncoding:a.pixelEncoding||pA,poolSize:a.poolSize||sA,useFloat:"boolean"!=typeof a.useFloat||a.useFloat,apiKey:a.apiKey||"",flipY:"boolean"==typeof a.flipY&&a.flipY}))),this.updateImageryDatasource=({datasource:e})=>{if(e.imagery)for(let t of["apiKey","maxZoom","urlFormat"]){const i=e.imagery[t];i&&(this.imageryDatasource[t]=i)}},this.updateElevationDatasource=({datasource:e})=>{if(e.elevation)for(let t of["apiKey","maxZoom","pixelEncoding","urlFormat"]){const i=e.elevation[t];i&&(this.elevationDatasource[t]=i)}},HA.imageryDatasource=this.imageryDatasource,HA.elevationDatasource=this.elevationDatasource;let l,c=[],h={},u=0,d=null,p=!1;this.draw=()=>{if(!1===this.visible)return;if(0===c.length)return;u++;let e=new Set,t=new Set,i=new Set,n={},a=1;const r=5+1*a+1;let s=u%r,o=0===s,m=(s-1-4)%1==0&&s>4&&s<5+1*a,f=s===r-1;if(p||(o=!0,m=!0,f=!0,a=1),o&&(this.renderer.setRenderTarget(Ep.pgl.tilePicker.target),this.renderer.clear(!0,!0,!0),this.renderer.render(this.scene.tilepickerScene,Ep.camera),this.renderer.setRenderTarget(null),l=Ep.camera.projectionMatrix.elements),m){let e=p?(s-1-4)/1:0,t=4*Ep.pgl.tilePicker.target.width*Ep.pgl.tilePicker.target.height/a,i=new Uint8Array(Ep.pgl.tilePicker.data.buffer,e*t,t);this.renderer.readRenderTargetPixels(Ep.pgl.tilePicker.target,0,e*Ep.pgl.tilePicker.target.height/a,Ep.pgl.tilePicker.target.width,Ep.pgl.tilePicker.target.height/a,i),this.renderer.setRenderTarget(null)}if(f){let a,r,s=2*(Ep.pgl.tilePicker.target.width+Ep.pgl.tilePicker.target.width*Ep.pgl.tilePicker.target.height);s=Math.round(s);let o=256*Ep.pgl.tilePicker.data[s+2]+Ep.pgl.tilePicker.data[s+3];o/=65280,d=l[14]/(2*o-1+l[10]),Ep.orbitControls.setDistanceToTarget(d);let u=Ep.pgl.tilePicker.data.length;for(s=0;s<u;s+=4){if(a=256*Ep.pgl.tilePicker.data[s]+Ep.pgl.tilePicker.data[s+1],r=Ep.pgl.tilePicker.data[s+3]/255,r=10*r-5,0===a)continue;let n=c.find((e=>e.id===a));void 0!==n&&(r<this.minError&&n.z<this.imageryDatasource.maxZoom?(t.add(n),e.add(n)):r>this.maxError&&n.z>7?i.add(n):e.add(n))}c.forEach((t=>{if(void 0===h[t.imageryKey]&&(h[t.imageryKey]=0),e.has(t))h[t.imageryKey]=0;else{h[t.imageryKey]++>5&&i.add(t)}}));let m=new Set([...i].filter((e=>t.has(e))));i=new Set([...i].filter((t=>!m.has(t)&&!e.has(t)))),t=new Set([...t].filter((e=>!m.has(e)))),[...e].filter((e=>!t.has(e))).forEach((e=>e.wasSeen=!0)),[...c].filter((e=>!t.has(e))).forEach((e=>e.wasRendered=!0)),i.forEach((e=>{let t=e.imageryKey.slice(0,-1);void 0===n[t]?n[t]=new Set([e]):n[t].add(e)})),t.forEach((e=>{if(window.noSplit)return;let t=e.split();t.forEach((e=>e.fetchData())),c.push(...t.splice(1,3))})),0===t.size&&(p=!0),Object.values(n).forEach((e=>{if(4!==e.size)return;let t=[...e],i=t[0],n=t.splice(1,3);delete h[i.imageryKey],i.grow().fetchData(),n.forEach((e=>{let t=c.indexOf(e);c.splice(t,1),delete h[e.imageryKey],e.recycle()}))}));const f=Ep.orbitControls.target;c.forEach((e=>{this.tileDelta.copy(e.mesh.geometry.boundingSphere.center),this.tileDelta.sub(f);const t=Math.abs(this.tileDelta.x)>this.shiftThreshold?-Math.sign(this.tileDelta.x):0,i=Math.abs(this.tileDelta.y)>this.shiftThreshold?Math.sign(this.tileDelta.y):0;(t||i)&&(e.shift(t,i,this.baseZ),e.fetchData())})),c.filter((e=>e.bestImagery.downsample>0)).forEach((e=>e.fetchData())),c.forEach((e=>{h[e.imageryKey]<10&&e.onSeen()}))}return this.imageryDatasource&&this.imageryDatasource.hasUpdates&&this.imageryDatasource.broadcastUpdate(),this.elevationDatasource&&this.elevationDatasource.hasUpdates&&this.elevationDatasource.broadcastUpdate(),!!o||void 0},this.createScene=()=>{c.forEach((e=>e.recycle())),c=[],c.push(HA.next(this.x,this.y,this.z));let e=c[0].split();c.push(...e.splice(1,3)),c.forEach((e=>e.fetchData()))},this.getTiles=()=>c,this.pickingTexture=new Te(1,1),this.changeMaterial=e=>{if("number"==typeof e)for(const t of c)t.mesh.material=t.terrainCoordMaterial,0!=e&&1!=e&&2!=e||(t.mesh.material.uniforms.uPass.value=e);else for(const e of c)e.mesh.material=e.terrainMaterial},this.pickTerrain=e=>{if(!(Ep.camera instanceof Zi))return;for(const e of c)e.mesh.material=e.terrainCoordMaterial;Ep.camera.setViewOffset(Ep.renderer.domElement.width,Ep.renderer.domElement.height,e.x,e.y,1,1);const t=new Ce,i=new Te(1,1,{minFilter:g,magFilter:g,format:I,type:T}),n=new Float32Array(4);Ep.renderer.setRenderTarget(i),Ep.renderer.clear(),Ep.renderer.render(Ep.scene.pgl,Ep.camera),Ep.renderer.readRenderTargetPixels(i,0,0,1,1,n),t.set(n[0],n[1],n[2]),Ep.renderer.setRenderTarget(null),i.dispose(),Ep.camera.clearViewOffset();for(const e of c)e.mesh.material=e.terrainMaterial;const a={hit:0!==n[3],distance:-1,object:Ep.scene.pgl,point:t};return a.hit&&(a.distance=t.distanceTo(Ep.camera.position)),a},this.unpackRGBAToFloat=e=>{const t=e[3]/255;let i=Math.round(e[0]/t),n=Math.round(e[1]/t),a=Math.round(e[2]/t);console.log(e,i,n,a,e[3]);const r=65536*i+256*n+a+(255-e[3])/10-8388608;return console.log(r),r},this.unpackRGBAToFloat2000=e=>{console.log("rgba",e);const t=e[0]/255*2e3-1e3;return console.log(t),t},this.unpackRGBAToFloatDec=e=>{console.log("rgba",e);let t=1;e[0]>100&&(t=-1,e[0]-=100);let i=1e6*e[0]+1e4*e[1]+100*e[2]+e[3];return i*=t,console.log(i),i},this.unpackRGBAToFloatFloor=e=>{console.log(e);let t=(256*e[0]+e[1])/(e[3]/255)+(e[3]/255-.5);return e[2]>128?t:-t}}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){Ep.scene.pgl&&Ep.scene.pgl.children instanceof Array&&"boolean"==typeof e&&(this._receiveShadow=e,HA.receiveShadow=e,Ep.scene.pgl.children.forEach((t=>{t.material.uniforms.receiveShadow.value=e,e?(t.material.vertexShader=t.material.vertexShader.replace("uniform vec4 uImageryUvOffset;",["","#define USE_SHADOWMAP;","#define SHADOWMAP_TYPE_PCF_SOFT;","uniform vec4 uImageryUvOffset;"].join("\n")),t.material.fragmentShader=t.material.fragmentShader.replace("uniform vec4 uImageryUvOffset;",["","#define USE_SHADOWMAP;","#define SHADOWMAP_TYPE_PCF_SOFT;","uniform vec4 uImageryUvOffset;"].join("\n"))):(t.material.vertexShader=t.material.vertexShader.replace(["","#define USE_SHADOWMAP;","#define SHADOWMAP_TYPE_PCF_SOFT;","uniform vec4 uImageryUvOffset;"].join("\n"),"uniform vec4 uImageryUvOffset;"),t.material.fragmentShader=t.material.fragmentShader.replace(["","#define USE_SHADOWMAP;","#define SHADOWMAP_TYPE_PCF_SOFT;","uniform vec4 uImageryUvOffset;"].join("\n"),"uniform vec4 uImageryUvOffset;")),t.material.needsUpdate=!0})))}}class WA{constructor(){this.data=new Uint8Array(4*Ep.renderer.domElement.width*Ep.renderer.domElement.height),this.target=new Te(Ep.renderer.domElement.width,Ep.renderer.domElement.height)}updateSize({width:e,height:t,renderRatio:i}){let n=Math.sqrt(e*t/500),a=2*Math.round(.5*e/n),r=2*Math.round(.5*t/n);this.target&&a===this.target.width&&r===this.target.height||(this.target=new Te(a,r),this.data=new Uint8Array(4*this.target.width*this.target.height),RA.uScaling.value.set(.5*a,.5*r,256/(i*n)))}}const YA=[256,1,1/256,-32768],XA=[6553.6,25.6,.1,-1e4],ZA=[0,0,1e4/255*1,-1];class qA{constructor(){this.terrainState=0}initTerrain({id:e,place:t={longitude:116.39131,latitude:39.90707},imagery:i,elevation:n,receiveShadow:a=!1}={},r){if(1===this.terrainState)return;if(!i)return;const{alpha:s=1}=arguments[0];HA.opacity=s,Ep.scene.hd=new mr,Ep.scene.tilepickerScene=new mr,Ep.scene.pickerScene=new mr,Ep.scene.pgl=new sr,Ep.scene.pgl.name="__pgl",Ep.scene.pgl.rotateX(Math.PI/-2),Ep.scene.add(Ep.scene.pgl),Ep.pgl.tilePicker=new WA,Ep.pgl.tilePicker.updateSize({width:Ep.renderer.domElement.width,height:Ep.renderer.domElement.height,renderRatio:Ep.renderer.getPixelRatio()}),Ep.pgl.terrain=new VA({scene:Ep.scene,renderer:Ep.renderer,camera:Ep.camera,imageryDatasource:i,elevationDatasource:n,minError:-1.2,maxError:.3,receiveShadow:a}),Ep.pgl.heightUniforms={elevationArray:{value:Ep.pgl.terrain.elevationDatasource?Ep.pgl.terrain.elevationDatasource.textureArray:[]},indirectionTexture:{value:Ep.pgl.terrain.elevationDatasource?Ep.pgl.terrain.elevationDatasource.indirectionTexture:[]},uGlobalOffset:{type:"v2",value:new ye},uSceneScale:{type:"v3",value:new Ce(1,1,1)},updateSceneScale:e=>{const t=Ep.pgl.terrain.elevationDatasource?Ep.pgl.terrain.elevationDatasource.maxZoom:12,i=Math.pow(2,15-t),n=40075016.686/(e*Math.pow(2,15)),a=-6.283185307179586/Math.pow(2,t),r=1/(e*i);Ep.pgl.heightUniforms.uSceneScale.value.set(a,n,r)},update:({globalOffset:e,sceneScale:t})=>{Ep.pgl.heightUniforms.uGlobalOffset.value.copy(e),Ep.pgl.heightUniforms.updateSceneScale(t)}};var o=.05;[Ep.pgl.terrain.x,Ep.pgl.terrain.y,Ep.pgl.terrain.z]=tA.pointToTileFraction(Math.round(t.longitude/o)*o,Math.round(t.latitude/o)*o,Ep.pgl.terrain.baseZ),Ep.pgl.geoproject=new iA,Ep.pgl.geoproject.setCurrentPlace(t);const l=Ep.pgl.geoproject.sceneScale;if(Ep.pgl.terrain.shiftThreshold=.6*l*Math.pow(2,15-Ep.pgl.terrain.baseZ),Ep.pgl.terrain.x=Math.floor(Ep.pgl.terrain.x),Ep.pgl.terrain.y=Math.floor(Ep.pgl.terrain.y),Ep.pgl.terrain.createScene(),this.valid={callback:r},i&&i.urlFormat){let e="";for(const t of i.urlFormat){if("{"===t)break;e+=t}this.valid.imageryUrl=e}if(n&&n.urlFormat){let e="";for(const t of n.urlFormat){if("{"===t)break;e+=t}this.valid.elevationUrl=e}this.terrainState=1}dataAtPoint(e){if(Ep.pgl.terrain&&Ep.pgl.terrain.elevationDatasource)return Ep.pgl.terrain.elevationDatasource.dataAtPoint(e)}heightAtPoint(e){if(Ep.pgl.terrain&&Ep.pgl.terrain.elevationDatasource)return function(e,t){if(!(e instanceof Uint8ClampedArray))return 0;if(0===e[0]&&0===e[1])return 0;let i;return t===uA||t===hA?i=YA:t===dA?i=XA:t===PIXEL_ENCODING_GREYSCALE_RGBA&&(i=ZA),i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]}(Ep.pgl.terrain.elevationDatasource.dataAtPoint(e),Ep.pgl.terrain.elevationDatasource.pixelEncoding)}setStyle(e,t){HA.styleUniforms||(HA.styleUniforms={uStyle:{type:"f",value:0},uMaskColor:{type:"c",value:new Qt(16777215)}}),HA.styleUniforms.uStyle.value=e,HA.styleUniforms.uMaskColor.value.setStyle(t)}testGeoJSON({url:e,batch:t,callback:i}={}){e&&_y.fetchJSON(e,"get").then((t=>{const i=new sr;i.name=e;const n=[];JSON.parse(t).features.forEach((e=>{var t=e.properties.height||30;(new sr).data=e,e.geometry.coordinates.forEach((e=>{e[0][0]instanceof Array?e.forEach((e=>{n.push(this.drawGeometry(e,t))})):n.push(this.drawGeometry(p,t))}))}));const a=this.drawMaterial();if(n.length>128){let e=this.chunk(n,128);n.length=0;for(let t of e){const e=new Fi(xb.mergeBufferGeometries(t),a);i.add(e)}}else{const e=new Fi(xb.mergeBufferGeometries(n),a);i.add(e)}const r=new sr;r.add(i),r.name="__geojson",Ep.scene.add(r),r.rotateX(3*Math.PI/2)}))}drawModel(e,t){const i=new El;e.forEach(((t,n)=>{const[a,r]=t;let s,o,l=_y.lonLatToWebMercator(a,r,0),c=_y.lonLatToWebMercator(Ep.datumShiftModel.lon,Ep.datumShiftModel.lat,0);s=l.x-c.x,o=l.y-c.y,0===n?i.moveTo(s,o):n===e.length-1?i.quadraticCurveTo(s,o,s,o):i.lineTo(s,o,s,o)}));return new Fi(new ao(i,{depth:t||-2,bevelEnabled:!1}),new Co({color:new Qt(13421772),transparent:!0,opacity:.9,side:2}))}drawMaterial(e){return new Co({color:new Qt(13421772),transparent:!0,opacity:.9,side:2})}drawGeometry(e,t){const i=new El;e.forEach(((t,n)=>{const[a,r]=t;let s,o,l=_y.lonLatToWebMercator(a,r,0),c=_y.lonLatToWebMercator(Ep.datumShiftModel.lon,Ep.datumShiftModel.lat,0);s=l.x-c.x,o=l.y-c.y,0===n?i.moveTo(s,o):n===e.length-1?i.quadraticCurveTo(s,o,s,o):i.lineTo(s,o,s,o)}));return new ao(i,{depth:t||-2,bevelEnabled:!1})}chunk(e,t){if(t<=1)return e;let i=[];for(let n=0;n<e.length;n+=t){let a=[];for(let i=0;i<t&&n+i<e.length;i++)a.push(e[n+i]);i.push(a)}return i}disposeTerrain(){if(Ep.pgl={},Ep.scene.remove(Ep.scene.pgl),_y.disposeThreeObject(Ep.scene.pgl),Ep.scene.hd&&Ep.scene.hd.children)for(const e of Ep.scene.hd.children)_y.disposeThreeObject(e),Ep.scene.hd.remove(e);if(Ep.scene.tilepickerScene&&Ep.scene.tilepickerScene.children)for(const e of Ep.scene.tilepickerScene.children)_y.disposeThreeObject(e),Ep.scene.hd.remove(e);if(Ep.scene.pickerScene&&Ep.scene.pickerScene.children)for(const e of Ep.scene.pickerScene.children)_y.disposeThreeObject(e),Ep.scene.hd.remove(e);Ep.scene.pgl=null,Ep.scene.hd=null,Ep.scene.tilepickerScene=null,Ep.scene.pickerScene=null,HA.clear(),this.terrainState=0}setVisibility(e){Ep.scene.pgl&&(Ep.scene.pgl.visible=e),Ep.pgl.terrain&&(Ep.pgl.terrain.visible=!!e)}updateStyle(e,t){const{alpha:i=1}=e;if(HA.opacity=i,Ep.pgl.terrain){for(const e of Ep.pgl.terrain.getTiles())e.mesh.material.uniforms.opacity.value=HA.opacity,e.mesh.geometry=e.mesh.geometry.getGeometry();for(const e of HA.tilePool())e.mesh.material.uniforms.opacity.value=HA.opacity,e.mesh.geometry=e.mesh.geometry.getGeometry()}t&&t({result:1,message:"成功。"})}getSettings(){}applySettings(e){}checkAddress(e){if(!this.valid)return;if(!this.valid.callback)return;if(this.valid.elevationUrl&&void 0===this.valid.elevationResult&&-1!=e.indexOf(this.valid.elevationUrl)){let i=new XMLHttpRequest;i.open("get",e,!0),i.timeout=1e3,i.onreadystatechange=()=>{4!=i.readyState&&(200==i.status?(this.valid.elevationResult="success",t()):(this.valid.elevationResult="fail",t()))},i.ontimeout=()=>{this.valid.elevationResult="timeout",t()},i.onerror=()=>{this.valid.elevationResult="error",t()},i.send()}if(this.valid.imageryUrl&&void 0===this.valid.imageryResult&&-1!=e.indexOf(this.valid.imageryUrl)){let i=new XMLHttpRequest;i.open("get",e,!0),i.timeout=1e3,i.onreadystatechange=()=>{4!=i.readyState&&(200==i.status?(this.valid.imageryResult="success",t()):(this.valid.imageryResult="fail",t()))},i.ontimeout=()=>{this.valid.imageryResult="timeout",t()},i.onerror=()=>{this.valid.imageryResult="error",t()},i.send()}const t=()=>{if(void 0===this.valid.imageryUrl&&(this.valid.imageryResult="complete"),void 0===this.valid.elevationUrl&&(this.valid.elevationResult="complete"),void 0===this.valid.imageryResult||void 0===this.valid.elevationResult)return;const e=this.valid;this.valid=void 0;let t="";"timeout"===e.elevationUrl?t="高程数据请求超时":"error"===e.elevationUrl?t="高程数据不支持跨域访问":"fail"===e.elevationUrl&&(t="高程数据无资源文件");let i="";if("timeout"===e.imageryResult?i="瓦片数据请求超时":"error"===e.imageryResult?i="瓦片数据不支持跨域访问":"fail"===e.imageryResult&&(i="瓦片数据无资源文件"),t||i){let n="失败";t&&(n+="，"+t),i&&(n+="，"+i),this.disposeTerrain(),e.callback({result:0,message:n+"。"})}else e.callback({result:1,message:"成功。"})}}}class JA{constructor(){var e=[];this.add=t=>{e.push(t)},this.findInstancedObject=t=>e.find((e=>e.name===t))||void 0,this.getInstancedObject=()=>e,this.remove=t=>{for(let i=e.length-1;i>=0;i--)e[i]===t&&(e[i].dispose&&e[i].dispose(),e[i]=null,e.splice(i,1))},this.resume=()=>{_isPaused=!1},this.update=t=>{if(!_isPaused)for(let i of e)i.update(t)}}}const QA=new Ce,KA=new Ce,$A=new Ce;class eE extends Et{constructor(e,t,i){super(),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===t&&(t=1);let n=new wi;n.setAttribute("position",new hi([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));const a=new Kr({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1});this.lightPlane=new as(n,a),this.add(this.lightPlane),n=new wi,n.setAttribute("position",new hi([0,0,0,0,0,1],3)),this.targetLine=new as(n,a),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){QA.setFromMatrixPosition(this.light.matrixWorld),KA.setFromMatrixPosition(this.light.target.matrixWorld),$A.subVectors(KA,QA),this.lightPlane.lookAt(KA),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(KA),this.targetLine.scale.z=$A.length()}}const tE=new Ce,iE=new Xi;class nE extends os{constructor(e){const t=new wi,i=new Kr({depthTest:!1,depthWrite:!1,color:16777215,vertexColors:!0,toneMapped:!1}),n=[],a=[],r={},s=new Qt(16755200),o=new Qt(16711680),l=new Qt(43775),c=new Qt(16777215),h=new Qt(3355443);function u(e,t,i){d(e,i),d(t,i)}function d(e,t){n.push(0,0,0),a.push(t.r,t.g,t.b),void 0===r[e]&&(r[e]=[]),r[e].push(n.length/3-1)}u("n1","n2",s),u("n2","n4",s),u("n4","n3",s),u("n3","n1",s),u("f1","f2",s),u("f2","f4",s),u("f4","f3",s),u("f3","f1",s),u("n1","f1",s),u("n2","f2",s),u("n3","f3",s),u("n4","f4",s),u("p","n1",o),u("p","n2",o),u("p","n3",o),u("p","n4",o),u("u1","u2",l),u("u2","u3",l),u("u3","u1",l),u("c","t",c),u("p","c",h),u("cn1","cn2",h),u("cn3","cn4",h),u("cf1","cf2",h),u("cf3","cf4",h),t.setAttribute("position",new hi(n,3)),t.setAttribute("color",new hi(a,3)),super(t,i),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=r,this.update()}update(){const e=this.geometry,t=this.pointMap;iE.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),aE("c",t,e,iE,0,0,-1),aE("t",t,e,iE,0,0,1),aE("n1",t,e,iE,-1,-1,-1),aE("n2",t,e,iE,1,-1,-1),aE("n3",t,e,iE,-1,1,-1),aE("n4",t,e,iE,1,1,-1),aE("f1",t,e,iE,-1,-1,1),aE("f2",t,e,iE,1,-1,1),aE("f3",t,e,iE,-1,1,1),aE("f4",t,e,iE,1,1,1),aE("u1",t,e,iE,.7,1.1,-1),aE("u2",t,e,iE,-.7,1.1,-1),aE("u3",t,e,iE,0,2,-1),aE("cf1",t,e,iE,-1,0,1),aE("cf2",t,e,iE,1,0,1),aE("cf3",t,e,iE,0,-1,1),aE("cf4",t,e,iE,0,1,1),aE("cn1",t,e,iE,-1,0,-1),aE("cn2",t,e,iE,1,0,-1),aE("cn3",t,e,iE,0,-1,-1),aE("cn4",t,e,iE,0,1,-1),e.getAttribute("position").needsUpdate=!0}}function aE(e,t,i,n,a,r,s){tE.set(a,r,s).unproject(n);const o=t[e];if(void 0!==o){const e=i.getAttribute("position");for(let t=0,i=o.length;t<i;t++)e.setXYZ(o[t],tE.x,tE.y,tE.z)}}class rE{constructor(e,t){this._scene=e,this._context=t,this._lightGroupId="",this._showingHelpers=!1,this._azimuthAngleOffset=0;let i=this._scene.getObjectByName("__lightGroup");if(i&&this._scene.remove(i),this._scene){this._ambientLight=new Vl(16777215,1),this._ambientLight.intensity0=1,this._ambientLight.name="__ambientLight",this._ambientLightProbe=new hc(16777215,0),this._ambientLightProbe.name="__ambientLightProbe",this._ambientLightProbeEnabled=!1;let e=new sr;e.name="__lightGroup",e.add(this._ambientLight),e.add(this._ambientLightProbe),this._lightGroupId=e.id,this._scene.add(e)}this._directionalLights=new Object;let n=this;this._transformDirectionalLightCallback=e=>{if(!n.transformedLight)return;n.updateLightHelpers(),e.object.dummy.updateMatrixWorld();let t=e.object.dummy.position.clone();if(t.applyMatrix4(e.object.matrix),n.transformedLight.position.copy(t),"GlobalDirectionalLight"===n.transformedLight.name&&n._syncDirectionalLights(),"function"==typeof n.transformCallback){let t={x:n.transformedLight.position.x,y:n.transformedLight.position.y,z:n.transformedLight.position.z},i=n.transformedLight.position.distanceTo(e.object.position);n.transformCallback({mode:n.transformMode,position:t,targetPosition:{x:e.object.position.x,y:e.object.position.y,z:e.object.position.z},azimuthAngle:Math.atan2(-(t.z-e.object.position.z),t.x-e.object.position.x)/Math.PI*180+90,inclinationAngle:Math.asin((t.y-e.object.position.y)/i)/Math.PI*-180})}}}enableLightProbe(){const e=this._scene.background instanceof Qi&&Ep.background&&"skybox"===Ep.background.mode?this._scene.background:this._scene.environment instanceof Qi?this._scene.environment:null;if(e)this._ambientLightProbe.copy(zx(e)),this._ambientLightProbe.intensity=this._ambientLight.intensity0/2,this._ambientLightProbeEnabled=!0,this._ambientLight.intensity=this._ambientLight.intensity0/2,this._ambientLight.visible=!1;else{const e=this._scene.background instanceof we&&Ep.background&&"skybox"===Ep.background.mode?this._scene.background:this._scene.environment instanceof we?this._scene.environment:null;if(e){const t=new Ki(e.image.width);t.fromEquirectangularTexture(Ep.renderer,e),this._ambientLightProbe.copy(Ux(Ep.renderer,t)),this._ambientLightProbe.intensity=this._ambientLight.intensity0/2,this._ambientLightProbeEnabled=!0,this._ambientLight.intensity=this._ambientLight.intensity0/2}}}disableLightProbe(){this._ambientLightProbe&&(this._ambientLightProbe.visible=!1,this._ambientLightProbeEnabled=!1,this._ambientLight.visible=!0,this._ambientLight.intensity=this._ambientLight.intensity0)}showLightHelpers(){this._showingHelpers=!0,this._getLightGroup().traverse((e=>{e instanceof eE&&(e.visible=!e.getLight||e.getLight().visible),e instanceof nE&&(e.visible=!e.getLight||e.getLight().visible&&e.getLight().castShadow&&e.getLight().shadow&&e.getLight().shadow.camera)}))}hideLightHelpers(){this._showingHelpers=!1,this._getLightGroup().traverse((e=>{(e instanceof eE||e instanceof nE)&&(e.visible=!1)}))}updateLightHelpers(e=!0,t=!0){this._getLightGroup().traverse((t=>{e&&t instanceof eE&&(t.light.updateMatrixWorld(),t.light.target.updateMatrixWorld(),t.updateMatrixWorld(),t.update(),this._syncDirectionalLights()),e&&t instanceof nE&&t.update()}))}setAmbientLight(e,t){this._scene&&"number"==typeof t&&(this._ambientLight.intensity0=t,this._ambientLight.color=new Qt(e)||this._ambientLight.color,this._ambientLightProbeEnabled?this._ambientLight.intensity=t/2:this._ambientLight.intensity=t,this._ambientLightProbe&&(this._ambientLightProbe.intensity=this._ambientLight.intensity+0))}getAmbientLight(){if(this._scene)return this._ambientLight}setAmbientLightProbe(e,t){this._scene&&(this._ambientLight.color=new Qt(e)||this._ambientLight.color,this._ambientLight.intensity=_y.numberOrDefault(t+0,this._ambientLight.intensity+0))}getAmbientLightProbe(){if(this._scene)return this._ambientLight}setDirectionalLight(e,t=0){if(logger.debug("TRACE: LightStore.setDirectionalLight() - Entering.",e),!this._scene||!e)return void logger.debug("TRACE: LightStore.setDirectionalLight() - Exiting.");let i=this.findDirectionalLight(e.name),n=!1;if(i){for(let a in e)switch(a){case"color":_y.isCSSColor(e[a])&&i.color.setStyle(e[a]);break;case"position":if(e[a]instanceof Array&&3===e[a].length)if(t<.05)i.position.set(e[a][0],e[a][1],e[a][2]);else{let n=Ep.animationStore.findAnimation("LightTransformAnimation");n&&(logger.warn("Light transform animation has been interrupted by another animation."),Ep.animationStore.remove(n));let r=new Cv(i,{position:new Ce(e[a][0],e[a][1],e[a][2])},t);r.name="LightTransformAnimation",Ep.animationStore.add(r)}break;case"targetPosition":e[a]instanceof Array&&3===e[a].length&&i.target&&i.target.position.set(e[a][0],e[a][1],e[a][2]);break;case"shadow":let r=e[a].camera;if(r&&(i.shadow.camera.top=_y.numberOrDefault(r.top,i.shadow.camera.top),i.shadow.camera.bottom=_y.numberOrDefault(r.bottom,i.shadow.camera.bottom),i.shadow.camera.left=_y.numberOrDefault(r.left,i.shadow.camera.left),i.shadow.camera.right=_y.numberOrDefault(r.right,i.shadow.camera.right),i.shadow.camera.near=_y.numberOrDefault(r.near,i.shadow.camera.near),i.shadow.camera.far=_y.numberOrDefault(r.far,i.shadow.camera.far),i.shadow.camera.updateProjectionMatrix(),n=!0),e[a].mapSize)if(e[a].mapSize instanceof Array){if(i.shadow.mapSize.width=_y.numberOrDefault(e[a].mapSize[0],i.shadow.mapSize.width),i.shadow.mapSize.height=_y.numberOrDefault(e[a].mapSize[1],i.shadow.mapSize.height),Ep.publishQuality&&Ep.publishQuality.shadow)switch(Ep.publishQuality.shadow.toLowerCase()){case"medium":i.shadow.mapSize.width=Math.min(1024,i.shadow.mapSize.width),i.shadow.mapSize.height=Math.min(1024,i.shadow.mapSize.height);break;case"low":i.shadow.mapSize.width=Math.min(512,i.shadow.mapSize.width),i.shadow.mapSize.height=Math.min(512,i.shadow.mapSize.height)}i.shadow.map&&(i.shadow.map.dispose(),i.shadow.map=null)}else if(e[a].mapSize instanceof Object){if(i.shadow.mapSize.width=_y.numberOrDefault(e[a].mapSize.width||e[a].mapSize.x,i.shadow.mapSize.width),i.shadow.mapSize.height=_y.numberOrDefault(e[a].mapSize.height||e[a].mapSize.y,i.shadow.mapSize.height),Ep.publishQuality&&Ep.publishQuality.shadow)switch(Ep.publishQuality.shadow.toLowerCase()){case"medium":i.shadow.mapSize.width=Math.min(1024,i.shadow.mapSize.width),i.shadow.mapSize.height=Math.min(1024,i.shadow.mapSize.height);break;case"low":i.shadow.mapSize.width=Math.min(512,i.shadow.mapSize.width),i.shadow.mapSize.height=Math.min(512,i.shadow.mapSize.height)}i.shadow.map&&(i.shadow.map.dispose(),i.shadow.map=null)}i.shadow.bias=_y.numberOrDefault(e[a].bias,0);break;case"castShadow":case"visible":if("castShadow"===a&&Ep.publishQuality&&Ep.publishQuality.shadow)switch(Ep.publishQuality.shadow.toLowerCase()){case"none":e[a]=!1}if(i[a]===e[a])break;i[a]=e[a];let s=this._showingHelpers&&i.visible;s&&!i.getDirectionalLightHelper&&this._createDirectionalLightHelper(i),i.getDirectionalLightHelper&&(this._getLightGroup().getObjectByName(e.name+".helper").visible=s);let o=i.shadow&&i.shadow.camera&&i.castShadow&&!i.getShadowCameraHelper,l=this._showingHelpers&&i.visible&&i.castShadow&&i.shadow&&i.shadow.camera;o&&this._createShadowCameraHelper(i),i.getShadowCameraHelper&&(i.getShadowCameraHelper().visible=l);break;case"rotation":case"scale":case"getShadowCameraHelper":case"getDirectionalLightHelper":break;case"intensity":i[a]=1*e[a];break;default:i[a]=e[a]}i.target&&i.target.dummy&&(i.target.dummy.position.copy(i.position),i.target.dummy.position.sub(i.target.position))}else i=this._createDirectionalLight(e),this._getLightGroup()&&(i.target&&(i.target.name=`${i.name}.target`,this._getLightGroup().add(i.target)),this._createDirectionalLightHelper(i),i.shadow&&i.shadow.camera&&i.castShadow&&this._createShadowCameraHelper(i),this._getLightGroup().add(i),this._directionalLights[e.name]=i);this.updateLightHelpers(!0,n),"number"==typeof e.azimuthAngleOffset&&(this._azimuthAngleOffset=e.azimuthAngleOffset),"number"==typeof e.azimuthAngle&&(i.azimuthAngle=e.azimuthAngle),"number"==typeof e.inclinationAngle&&(i.inclinationAngle=e.inclinationAngle),logger.debug("TRACE: LightStore.setDirectionalLight() - Exiting.")}updateDirectionalLight(e,t){this._scene&&e&&t&&(this.findDirectionalLight(e)?logger.warn(`DirectionalLight with name "${e}" already exists.`):(t.name=e,this._getLightGroup()&&(this._getLightGroup().add(t),this._directionalLights[e]=t)))}clearDirectionalLight(){if(this._scene)for(let e in this._directionalLights)this._getLightGroup()&&(this._getLightGroup().remove(this._directionalLights[e]),delete this._directionalLights[e])}getDirectionalLights(){return this._directionalLights}findDirectionalLight(e){if(this._scene&&e)return this._directionalLights[e]}removeDirectionalLight(e){this._scene&&e&&(this._getLightGroup().remove(this._getLightGroup().getObjectByName(e)),this._getLightGroup().remove(this._getLightGroup().getObjectByName(e+".helper")),this._getLightGroup().remove(this._getLightGroup().getObjectByName(e+".target")),delete this._directionalLights[e])}hideDirectionalLight(e){this._scene}showDirectionalLight(e){this._scene}findDirectionalLightHelper(e){if(this._scene&&e)return this._directionalLights[e]&&this._directionalLights[e].getDirectionalLightHelper?this._directionalLights[e].getDirectionalLightHelper():void 0}transformDirectionalLight(e,t){let i=this.findDirectionalLight(e);return!(!i||!i.target)&&(this.transformControls||(this.transformControls=Ep.transformControls),this.transformedLight=i,this.transformOffset={translate:i.position.clone(),quaternion:i.quaternion.clone(),distance:0},"function"==typeof t&&(this.transformCallback=t),this.transformMode="translate",this.transformOffset.translate.sub(i.target.position),this.transformOffset.distance=i.position.distanceTo(i.target.position),i.target.dummy||(i.target.dummy=new Et,i.target.dummy.name="lightTargetDummy",i.target.add(i.target.dummy)),i.target.dummy.position.copy(i.position),i.target.dummy.position.sub(i.target.position),this.transformControls.attach(i.target),this.transformControls.setMode("translate"),this.transformControls.addEventListener("translate",this._transformDirectionalLightCallback),!0)}setTransformMode(e){if(!this.transformMode||!this.transformControls)return!1;switch(e.toLowerCase()){case"translate":return this.transformMode=e.toLowerCase(),this.transformControls.setMode(this.transformMode),!0;default:return!1}}disableTransformDirectionalLight(){return!!this.transformControls&&(this.transformedLight=void 0,this.transformOffset={translate:0,quaternion:0,distance:0},this.transformCallback=void 0,this.transformMode=void 0,this.transformControls.detach(),this.transformControls.removeEventListener("translate",this._transformDirectionalLightCallback),!0)}_syncDirectionalLights(){let e;for(let t in this._directionalLights)"GlobalDirectionalLight"===this._directionalLights[t].name&&this._directionalLights[t].target&&this._directionalLights[t].target.position&&(e=this._directionalLights[t].target.position.clone());if(e)for(let t in this._directionalLights)if("GlobalDirectionalLight"!==this._directionalLights[t].name){let i=this._directionalLights[t].position.clone();i.sub(this._directionalLights[t].target.position),this._directionalLights[t].target.position.copy(e),this._directionalLights[t].position.addVectors(this._directionalLights[t].target.position,i)}}_getLightGroup(){return this._lightGroupId?this._scene.getObjectById(this._lightGroupId):void 0}_createDirectionalLight({name:e,visible:t,color:i="#ffffff",position:n=[100,100,100],targetPosition:a,castShadow:r=!0,shadow:s={camera:{top:100,bottom:-100,left:-100,right:100,far:200},mapSize:{height:1024,width:1024,x:1024,y:1024}},intensity:o=1,type:l,distance:c,label:h}){if(Ep.publishQuality&&Ep.publishQuality.shadow)switch(Ep.publishQuality.shadow.toLowerCase()){case"none":r=!1}let u=new Gl(i);if(u.name=e,u.visible="boolean"!=typeof t||t,u.position.set(n[0],n[1],n[2]),u.castShadow=r,u.distance=c,u.label=h,s.camera&&(u.shadow.camera.top=_y.numberOrDefault(s.camera.top,100),u.shadow.camera.bottom=_y.numberOrDefault(s.camera.bottom,-100),u.shadow.camera.left=_y.numberOrDefault(s.camera.left,-100),u.shadow.camera.right=_y.numberOrDefault(s.camera.right,100),u.shadow.camera.near=_y.numberOrDefault(s.camera.near,.1),u.shadow.camera.far=_y.numberOrDefault(s.camera.far,200)),s.mapSize)if(s.mapSize instanceof Array){if(u.shadow.mapSize.width=_y.numberOrDefault(s.mapSize[0],2048),u.shadow.mapSize.height=_y.numberOrDefault(s.mapSize[1],2048),Ep.publishQuality&&Ep.publishQuality.shadow)switch(Ep.publishQuality.shadow.toLowerCase()){case"medium":u.shadow.mapSize.width=Math.min(1024,u.shadow.mapSize.width),u.shadow.mapSize.height=Math.min(1024,u.shadow.mapSize.height);break;case"low":case"none":u.shadow.mapSize.width=Math.min(512,u.shadow.mapSize.width),u.shadow.mapSize.height=Math.min(512,u.shadow.mapSize.height)}}else if(s.mapSize instanceof Object&&(u.shadow.mapSize.width=_y.numberOrDefault(s.mapSize.width||s.mapSize.x,2048),u.shadow.mapSize.height=_y.numberOrDefault(s.mapSize.height||s.mapSize.y,2048),Ep.publishQuality&&Ep.publishQuality.shadow))switch(Ep.publishQuality.shadow.toLowerCase()){case"medium":u.shadow.mapSize.width=Math.min(1024,u.shadow.mapSize.width),u.shadow.mapSize.height=Math.min(1024,u.shadow.mapSize.height);break;case"low":case"none":u.shadow.mapSize.width=Math.min(512,u.shadow.mapSize.width),u.shadow.mapSize.height=Math.min(512,u.shadow.mapSize.height)}"number"==typeof s.bias&&(u.shadow.bias=s.bias);let d=new Et;return u.target=d,"supplemental"===l?d.position.set(0,n[1],0):d.position.set(0,-.01,0),a instanceof Array&&d.position.set(a[0],a[1],a[2]),u.intensity=1*o,u}_createDirectionalLightHelper(e,t=5){var i=new eE(e,t);i.name=`${e.name}.helper`,i.visible=e.visible&&this._showingHelpers,i.renderOrder=1/0,i.traverse((e=>{e.material&&(e.material.transparent=!0)})),i.getLight=function(){return e},e.getDirectionalLightHelper=function(){return i},this._getLightGroup().add(i)}_createShadowCameraHelper(e){let t=new nE(e.shadow.camera);t.name=`${e.name}.shadowHelper`,t.visible=this._showingHelpers&&e.castShadow,t.renderOrder=1/0,t.traverse((e=>{e.material&&(e.material.transparent=!0)})),t.getLight=function(){return e},e.getShadowCameraHelper=function(){return t},t.frustumCulled=!1,this._getLightGroup().add(t)}getSettings(){logger.debug("TRACE: LightStore.getSettings() - Entering.");let e={ambientLight:{},directionalLights:{},azimuthAngleOffset:this._azimuthAngleOffset};for(let t in this._ambientLight)"uuid"!==t&&"parent"!==t&&"quaternion"!==t&&"matrix"!==t&&"matrixWorld"!==t&&"matrixAutoUpdate"!==t&&"matrixWorldNeedsUpdate"!==t&&"layers"!==t&&"target"!==t&&"layers"!==t&&"userData"!==t&&"isDirectionalLight"!==t&&"isLight"!==t&&"isObject3D"!==t&&"animation"!==t&&"function"!=typeof this._ambientLight[t]&&(this._ambientLight[t],e.ambientLight[t.replace("_","")]=this._ambientLight[t]);e.ambientLight.intensity="number"==typeof e.ambientLight.intensity0?e.ambientLight.intensity0:e.ambientLight.intensity;for(let t in this._directionalLights){let i={};for(let e in this._directionalLights[t])if("uuid"!==e&&"parent"!==e&&"quaternion"!==e&&"matrix"!==e&&"matrixWorld"!==e&&"matrixAutoUpdate"!==e&&"matrixWorldNeedsUpdate"!==e&&"layers"!==e&&"layers"!==e&&"userData"!==e&&"isDirectionalLight"!==e&&"isLight"!==e&&"isObject3D"!==e&&"animation"!==e&&"function"!=typeof this._ambientLight[e])switch(e){case"color":i[e.replace("_","")]=`#${this._directionalLights[t][e].getHexString()}`;break;case"position":i[e.replace("_","")]=[this._directionalLights[t][e].x,this._directionalLights[t][e].y,this._directionalLights[t][e].z];break;case"target":i.targetPosition=[this._directionalLights[t][e].position.x,this._directionalLights[t][e].position.y,this._directionalLights[t][e].position.z];break;case"targetPosition":break;case"shadow":i[e.replace("_","")]=JSON.parse(JSON.stringify(this._directionalLights[t][e])),i[e.replace("_","")].mapSize=JSON.parse(JSON.stringify(this._directionalLights[t][e].mapSize)),i[e.replace("_","")].camera&&delete i[e.replace("_","")].camera.uuid;break;default:i[e.replace("_","")]=this._directionalLights[t][e]}e.directionalLights[t]=i}return logger.debug("TRACE: LightStore.getSettings() - Exiting.",e),e}applySettings(e,t,i){if(logger.debug("TRACE: LightStore.getSettings() - Entering.",e),e)if(this._context){for(let t in this._directionalLights)null==e.directionalLights[t]&&(this.removeDirectionalLight(t),delete this._directionalLights[t]);e.directionalLights.GlobalDirectionalLight.duration=i;for(let t in e.directionalLights)"GlobalDirectionalLight"!==t&&this.setDirectionalLight(e.directionalLights[t]);"number"==typeof e.azimuthAngleOffset&&(this._azimuthAngleOffset=e.azimuthAngleOffset),this._context.setGlobalIllumination({skybox:e.skybox,skyboxPath:e.skyboxPath,ambientLight:e.ambientLight,directionalLight:e.directionalLights.GlobalDirectionalLight},(e=>{t&&t(e)})),this._syncDirectionalLights(),logger.debug("TRACE: LightStore.applySettings() - Exiting.")}else logger.error("无效的上下文设置。");else logger.error("无效的灯光设置。")}dispose(){for(const e in this._directionalLights)Object.hasOwnProperty.call(this._directionalLights,e)&&_y.disposeThreeObject(this._directionalLights[e]);this._directionalLights=null}}class sE{constructor(e){this._scene=e,this._scene.models||(this._scene.models=new sr("__models"),this._scene.models.name="__models",this._scene.add(this._scene.models)),this._models=new Object,this._nodeSelection=new $y(e),this._animationMixers=[],this._states={}}add(e,t,i,n){this._scene&&e&&n&&(this.find(e)||(n.index="number"==typeof i?i:void 0,n.name=e,n.url=t,this._scene.models.add(n),this._models[e]=n,this._animationMixers.push(new Fc(n))))}clear(){if(this._scene)for(let e in this._models)this._scene.models.remove(this._models[e]),delete this._models[e]}find(e){if(!this._scene||!e)return;return this.getModels().find((t=>t.name===e))}rename(e,t,i){if(this._scene&&e&&t){Ep.modelStore.find(t).name=e;for(let n=0;n<this._scene.models.children.length;n++)this._scene.models.children[n].name===t&&(this._scene.models.children[n].name=e,i&&i(1));for(let i in this._models)i===t&&(this._models[e]=this._models[i],delete this._models[i])}}getModels(){let e=[];for(let t in this._models){let i=new Px({name:this._models[t].name,url:this._models[t].url,animations:this._models[t].animations,isVisible:this._models[t].visible,index:this._models[t].index});i.children=qy._fromThreeObject(this._models[t]).children,e.push(i)}return e}loadScene(e,t){if(t.inBackground)for(let i of e.children)e.userData.dhExtension&&(i.userData.dhExtension=e.userData.dhExtension),t.translate instanceof Array&&(i.translateX(t.translate[0]||0),i.translateY(t.translate[1]||0),i.translateZ(t.translate[2]||0)),i.visible=!1,this._scene.models.add(i),this._models[i.name]=i;else{e.name="__models",this._scene.remove(this._scene.models),this._scene.models=e,this._scene.add(e);for(let t of e.children)e.userData.dhExtension&&(t.userData.dhExtension=e.userData.dhExtension),this._models[t.name]=t}}remove(e,t){let i=null;if(this._scene&&e){for(let n in this._models)this._models[n].name==e&&(i=this._models[n].index,this._scene.models.remove(this._models[n]),delete this._models[this._models[n].name],t&&t(1));for(let e in this._models)i<this._models[e].index&&(this._models[e].index-=1)}}copy(e,t){if(this._scene&&e)for(let a in this._models)if(this._models[a].name==e){var i=this._models[a].clone();i.url=this._models[a].url;var n=new Date;n.toLocaleDateString(),i.name=i.name+"_副本_"+(n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1)+(n.getDate()<10?"0"+n.getDate():n.getDate())+(n.getHours()<10?"0"+n.getHours():n.getHours())+(n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes())+(n.getSeconds()<10?"0"+n.getSeconds():n.getSeconds()),this._scene.models.add(i),this._models[i.name]=i,t&&t(1)}}hide(e,t={}){if(!this._scene||!e||!this.find(e))return;let i=this._models[e];if(i instanceof Et&&(i.visible=!1,this._scene.children.map((t=>{"__sysObjectsWater"===t.name&&t.children.map((t=>{t.userData.modelName===e&&(t.visible=!1)}))})),""!==Ep.stateStore.getCurrentState())){let t=Ep.stateStore.findState(Ep.stateStore.getCurrentState());t.settings.models=t.settings.models||{},t.settings.models[e]=t.settings.models[e]||{},t.settings.models[e].visible=!1}}show(e,t={}){if(!this._scene||!e||!this.find(e))return;let i=this._models[e];if(t.exlusively)for(let t in this._models)this._models[t].name!==e&&(this._models[t].visible=!1);if(t.withSettings&&i.userData.dhExtension&&(Ep.materialStore.applySettings(i.userData.dhExtension.materials),Ep.lightStore.applySettings(i.userData.dhExtension.lights),i.userData.dhExtension.view.duration=t.duration||0,Ep.instance.defaultView.applySettings(i.userData.dhExtension.view),Ep.instance.defaultEffectStore.applySettings(i.userData.dhExtension.effects)),i instanceof Et&&(i.visible=!0,this._scene.children.map((t=>{"__sysObjectsWater"===t.name&&t.children.map((t=>{t.userData.modelName===e&&(t.visible=!0)}))})),""!==Ep.stateStore.getCurrentState())){let t=Ep.stateStore.findState(Ep.stateStore.getCurrentState());t.settings.models=t.settings.models||{},t.settings.models[e]=t.settings.models[e]||{},t.settings.models[e].visible=!0}}hideNode(e,t){if(!(this._scene&&e&&t&&this.find(e)))return;let i=this._models[e];if(i instanceof Et){let e;i.traverse((function(i){i.name===t&&(e=i)})),e&&(e.visible=!1,e.traverse((function(e){typeof e.name===t&&"boolean"==typeof e.visible&&(e.visible=!1)})))}}showNode(e,t){if(!(this._scene&&e&&t&&this.find(e)))return;let i=this._models[e];if(i instanceof Et){let e;i.traverse((function(i){i.name===t&&(e=i)})),e&&(e.visible=!0,e.traverse((function(e){typeof e.name===t&&"boolean"==typeof e.visible&&(e.visible=!0)})))}}rankUp(e,t){let i=this;this._scene.models.children.map(((n,a)=>{n.name===e&&(0===n.index?t&&t(0,"已是第一名无法上移"):(n.index-=1,i._scene.models.children.map((e=>{e.index===n.index&&e.name!=n.name&&(e.index+=1)})),t&&t(1,"成功")))}))}rankDown(e,t){let i=this;this._scene.models.children.map(((n,a)=>{n.name===e&&(n.index===i._scene.models.children.length-1?t&&t(0,"已是最后一名无法下移"):(n.index+=1,i._scene.models.children.map((e=>{e.index===n.index&&e.name!=n.name&&(e.index-=1)})),t&&t(1,"成功")))}))}findAnimationClipAction(e,t){if(!this._models[e])return;let i=this._animationMixers.find((t=>t.getRoot().name===this._models[e].name));if(!i)return;let n=this._models[e].animations.find((e=>e.name===t));return n?i.clipAction(n):void 0}stopAnimation(e,t){let i=this.findAnimationClipAction(e,t);i&&i.stop()}playAnimation(e,t,i){let n=this.findAnimationClipAction(e,t);"number"==typeof i&&(n.timeScale=i),n&&n.play()}updateAnimation(e){for(let t=0;t<this._animationMixers.length;t++)this._animationMixers[t].update(e)}applyState(e){}getSettings(){let e=this.getModels();return mx(e).forEach((function(){this.node&&this.node.id&&delete this.node.id})),this.result=e.sort(((e,t)=>e.index-t.index)),this.transformRecursion(e,this._models),e}transformRecursion(e,t){for(let i=0;i<e.length;i++)if(e[i].transform={},t instanceof Array)for(let n=0;n<t.length;n++)e[i].name===t[n].name&&(e[i].transform.position=t[n].position,e[i].transform.rotation=t[n].rotation,e[i].transform.scale=t[n].scale,e[i].children.length>0&&this.transformRecursion(e[i].children,t[n].children));else if(t instanceof Object)for(let n in t)t[n].name===e[i].name&&(e[i].transform.position=t[n].position,e[i].transform.rotation=t[n].rotation,e[i].transform.scale=t[n].scale,e[i].children.length>0&&this.transformRecursion(e[i].children,t[n].children))}setTransformRecursion(e,t){if(t instanceof Array)for(let i=0;i<e.length;i++)for(let n=0;n<t.length;n++)e[i].transform&&t[n].name===e[i].name&&(t[n].position.x=e[i].transform.position.x,t[n].position.y=e[i].transform.position.y,t[n].position.z=e[i].transform.position.z,t[n].rotation.order=e[i].transform.rotation._order,t[n].rotation.x=e[i].transform.rotation._x,t[n].rotation.y=e[i].transform.rotation._y,t[n].rotation.z=e[i].transform.rotation._z,t[n].scale.x=e[i].transform.scale.x,t[n].scale.y=e[i].transform.scale.y,t[n].scale.z=e[i].transform.scale.z,t[i].children.length>0&&this.setTransformRecursion(e[i].children,t[n].children));else if(t instanceof Object)for(let i=0;i<e.length;i++)for(let n in t)e[i].transform&&t[n].name===e[i].name&&(t[n].position.x=e[i].transform.position.x,t[n].position.y=e[i].transform.position.y,t[n].position.z=e[i].transform.position.z,t[n].rotation.order=e[i].transform.rotation._order,t[n].rotation.x=e[i].transform.rotation._x,t[n].rotation.y=e[i].transform.rotation._y,t[n].rotation.z=e[i].transform.rotation._z,t[n].scale.x=e[i].transform.scale.x,t[n].scale.y=e[i].transform.scale.y,t[n].scale.z=e[i].transform.scale.z,t[n].children.length>0&&this.setTransformRecursion(e[i].children,t[n].children))}applySettings(e){if(!e)return void logger.error("无效的模型设置。");this.setTransformRecursion(e,this._models);let t=this._nodeSelection;for(let i of e){let e=this.find(i.name);if(e){if(i.animations instanceof Array)for(let e of i.animations){let t=[];for(let i of e.tracks){let e;switch(i.type){case"bool":e=new zo(i.name,i.times,i.values);break;case"color":e=new Uo(i.name,i.times,i.values);break;case"number":e=new Fo(i.name,i.times,i.values);break;case"quaternion":e=new Ho(i.name,i.times,i.values);break;case"string":e=new Go(i.name,i.times,i.values);break;case"vector":e=new Vo(i.name,i.times,i.values);break;default:e=new Bo(i.name,i.times,i.values)}t.push(e)}let n=new Wo(e.name,e.duration,t);this._models[i.name].animations.push(n)}this._models[i.name].visible=i.isVisible,i.transform&&(this._models[i.name].position.x=i.transform.position.x,this._models[i.name].position.y=i.transform.position.y,this._models[i.name].position.z=i.transform.position.z,this._models[i.name].rotation._order=i.transform.rotation._order,this._models[i.name].rotation._x=i.transform.rotation._x,this._models[i.name].rotation._y=i.transform.rotation._y,this._models[i.name].rotation._z=i.transform.rotation._z,this._models[i.name].scale.x=i.transform.scale.x,this._models[i.name].scale.y=i.transform.scale.y,this._models[i.name].scale.z=i.transform.scale.z),this._animationMixers.push(new Fc(this._models[i.name])),mx(i.children).forEach((function(){if(this.node&&this.node.isNode&&e.findNode){t.selectNodes([e.findNode(this.node.name)]);for(let e in this.node)"children"!==e&&"isNode"!==e&&"material"!==e&&"name"!==e&&t.setProperty(e,this.node[e])}}))}}}dispose(){for(const e in this._models)Object.hasOwnProperty.call(this._models,e)&&_y.disposeThreeObject(this._models[e]);this._models=null,this._nodeSelection.dispose&&this._nodeSelection.dispose(),this._nodeSelection=null,this._animationMixers.forEach((e=>{e.uncacheRoot(e.getRoot())})),this._animationMixers=null,this._states=null}}class oE{constructor(e){this._scene=e,this._sceneObjects=new sr,this._sceneObjects.name="__objects",this._scene.add(this._sceneObjects),this._objects=new Object}add(e,t){this._sceneObjects&&e&&t&&(this.find(e)||(t.name=e,this._sceneObjects.add(t),this._objects[e]=t))}clear(){if(this._sceneObjects)for(let e in this._objects)this._sceneObjects.remove(this._objects[e]),delete this._objects[e]}find(e){if(this._sceneObjects&&e)return this._objects[e]}remove(e){if(!this._sceneObjects||!e)return;let t=this.find(e);Ep.transformControls.object===t&&Ep.transformControls.detach(),t&&(t.userData.mesh&&(t.userData.mesh.geometry.dispose(),t.userData.mesh.material.dispose()),t.traverse&&t.traverse((e=>{if(e instanceof Fi)if(e.geometry.dispose(),e.material instanceof Array)for(let t=0;t<e.material.length;t++){if(!e.material[t])return;for(let i in e.material[t])e.material[t][i]instanceof we&&e.material[t][i].dispose();e.material[t].dispose()}else{for(let t in e.material)e.material[t]instanceof we&&e.material[t].dispose();e.material.dispose()}else if(e instanceof Or){for(let t in e.material)e.material[t]instanceof we&&e.material[t].dispose();e.material.dispose()}})),this._sceneObjects.remove(t),delete this._objects[t.name])}hide(e){this._sceneObjects&&e&&(this._objects[e].visible=!1,this._objects[e].activeVisible=!1)}show(e){this._sceneObjects&&e&&(this._objects[e].visible=!0,this._objects[e].activeVisible=!0)}forEach(e){if(!_y.isFunction(e))return!1;for(let t in this._objects)e(this._objects[t])}dispose(){this._sceneObjects&&this._sceneObjects.children&&this._sceneObjects.children.forEach((e=>{_y.disposeThreeObject(e)})),this._sceneObjects=null,this._objects&&_y.disposeThreeObject(this._objects),this._objects=null}}class lE{constructor(){const e=[{name:"GISCity",src:"/public/tgapp/plugins/GISCity.js"}],t=[];this.add=(i,n)=>{if(!i)return;let a=e.find((e=>e.name===i));a&&_y.fetchJSON(a.src).then((e=>{if(null!=e&&!document.getElementById(i)){var a=document.getElementsByTagName("HEAD").item(0),r=document.createElement("script");r.language="javascript",r.type="text/javascript",r.id=`SCRIPT_${i}`,r.defer=!0,r.text=e,console.log(r),"function"==typeof define&&define.amd&&delete define.amd,a.appendChild(r),t.push({name:i,instance:window.avwPlugins[i]}),window.avwPlugins[i].initPlugin({inContext:Ep,inProj4:Gm,inTHREE:eu,inBufferGeometryUtils:xb}),"function"==typeof n&&n(window.avwPlugins[i]),delete window.avwPlugins}}))},this.clear=()=>{if(this._sceneObjects)for(let e in this._objects)this._sceneObjects.remove(this._objects[e]),delete this._objects[e]},this.find=e=>{let i=t.find((t=>t.name===e));if(i)return i.instance},this.remove=e=>{},this.dispose=()=>{}}}class cE{constructor(e){this._scene=e,this.sysObjectStore=new sr,this.sysObjectStore.name="__sysObjectsWater",this._scene.add(this.sysObjectStore)}add(e,t){this.sysObjectStore&&e&&t&&(this.find(e)||(t.name=e,this.sysObjectStore.add(t)))}clear(){this.sysObjectStore&&this.sysObjectStore.traverse((e=>{this.sysObjectStore.remove(e)}))}find(e){if(this.sysObjectStore&&e){var t=null;return this.sysObjectStore.traverse((i=>{i.name===e&&(t=i)})),t}}remove(e){if(!this.sysObjectStore||!e)return;let t=this.find(e);t&&this.sysObjectStore.remove(t)}hide(e){this.sysObjectStore&&e&&this.sysObjectStore.traverse((t=>{t.name===e&&(t.visible=!1,t.activeVisible=!1)}))}show(e){this.sysObjectStore&&e&&this.sysObjectStore.traverse((t=>{t.name===e&&(t.visible=!0,t.activeVisible=!0)}))}dispose(){_y.disposeThreeObject(this.sysObjectStore),this.sysObjectStore=null}}class hE{constructor(e="textureStore"){this._textures=new Object,this._type=e,this._glCanvas=document.createElement("canvas"),this._gl=this._glCanvas.getContext("webgl2")}handleGLBlobToDataURL(e){const t=this._gl.createTexture(),i=this._gl.createFramebuffer(),n=new Uint8Array(e.width*e.height*4);this._gl.activeTexture(this._gl.TEXTURE0),this._gl.bindTexture(this._gl.TEXTURE_2D,t),this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,i),this._gl.framebufferTexture2D(this._gl.FRAMEBUFFER,this._gl.COLOR_ATTACHMENT0,this._gl.TEXTURE_2D,t,0),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),this._gl.drawBuffers([this._gl.COLOR_ATTACHMENT0]),this._gl.readPixels(0,0,e.width,e.height,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n);let a=new yw.PNG({width:e.width,height:e.height,filterType:4});for(let e=0;e<a.data.length;e+=4)a.data[e+0]=n[e+0],a.data[e+1]=n[e+1],a.data[e+2]=n[e+2],a.data[e+3]=n[e+3];a.pack();const r=yw.PNG.sync.write(a,{colorType:6});return oy(r)}loadTexture({url:e,name:t,onLoad:i,onProgress:n,isBackground:a,isSkybox:r}={}){e?(t||(t=e,logger.debug("TextureStore.loadTexture() 参数name为空,使用url作为name。")),Ep.cacheStore.load({path:e,type:"imagebitmap",onLoad:n=>{n.name=e,n.wrapT=d,n.wrapS=d,n.flipY=!1;let s=this.add(e,n,void 0,void 0,t);s.url=e,s.isBackground=a,s.isSkybox=r,i&&i(s),logger.debug("TextureStore.loadTexture() onLoad。")},onProgress:e=>{n&&n(e),logger.debug("TextureStore.loadTexture() onProgress")},onError:()=>{i&&i(0)}})):logger.debug("TextureStore.loadTexture() 参数url为空。")}add(e,t,i,n,a){if(e&&t)return this.find(e)?(t.name||(t.name=e),this.find(e)):(t.name=e,this._textures[e]=Tb._fromThreeObject(t),this._textures[e].sourceModelKey=i,this._textures[e].shouldRetain=!!n,this._textures[e].displayName=a,this._textures[e])}clear(){for(let e in this._textures)delete this._textures[e]}find(e){if(e)return this._textures[e]}findByDisplayName(e){if(e)for(const t in this._textures)if(this._textures[t].displayName===e)return this._textures[t]}remove(e){if(!e)return;let t=this.find(e);t&&delete this._textures[t.name]}textureSort(e){e.sort(((e,t)=>e.name.localeCompare(t.name)))}getAll(){if(!this._textures)return[];let e=[];for(let t in this._textures)e.push(this._textures[t]);return this.textureSort(e),e}dispose(){for(const e in this._textures)Object.hasOwnProperty.call(this._textures,e)&&this._textures[e].destroyCanvas&&this._textures[e].destroyCanvas();this._textures=null}isTextureStore(){return"texturestore"===this._type.toLowerCase()}isCustomTextureStore(){return"customtexturestore"===this._type.toLowerCase()}getSettings(){if(this.isTextureStore()){const e=[];for(const t in this._textures){const i=this._textures[t].sourceModelKey;if("string"==typeof i&&""!==i){if(!this._textures[t].shouldRetain)continue;let n=!1;if(Ep.defaultObjectTree.traverse((e=>{e.getGroup&&e.getGroup()&&e.getGroup().sourceModelKey===i&&(n=!0)})),!n){let n=!1;if(Ep.scene.traverse((e=>{if(e.material)if(e.material instanceof Array)e.material.forEach((e=>{for(var i in e)e[i]&&e[i].image&&this._textures[t]._textureSource===e[i].image&&(n=!0)}));else for(var i in e.material)e.material[i]&&e.material[i].image&&this._textures[t]._textureSource===e.material[i].image&&(n=!0)})),!n)continue;const a=this._textures[t]._textureSource,r=this.handleGLBlobToDataURL(a);e.push({key:t,sourceToBase64:r,sourceModelKey:i,width:a.width,height:a.height})}}}return{orphanTextures:e}}if(this.isCustomTextureStore()){let e=[],t=this.getAll();return Ep.scene.traverse((i=>{if(i.material)if(i.material instanceof Array)i.material.forEach((i=>{for(var n in i)i[n]&&i[n].image&&i[n].image&&t.forEach((t=>{if(t.url&&i[n].image===t.textureSource&&!e.find((e=>e.url===t.url))){let i={name:t.name,url:t.url,displayName:t.displayName};e.push(i)}})),"uniforms"===n&&i[n]&&i[n].maps&&i[n].maps.value&&i[n].maps.value.image&&t.forEach((t=>{if(t.url&&i[n].maps.value.image===t.textureSource&&!e.find((e=>e.url===t.url))){let i={name:t.name,url:t.url,displayName:t.displayName};e.push(i)}}))}));else for(var n in i.material)i.material[n]&&i.material[n].image&&i.material[n].image&&t.forEach((t=>{if(t.url&&i.material[n].image===t.textureSource&&!e.find((e=>e.url===t.url))){let i={name:t.name,url:t.url,displayName:t.displayName};e.push(i)}})),"uniforms"===n&&i.material[n]&&i.material[n].maps&&i.material[n].maps.value&&i.material[n].maps.value.image&&t.forEach((t=>{if(t.url&&i.material[n].maps.value.image===t.textureSource&&!e.find((e=>e.url===t.url))){let i={name:t.name,url:t.url,displayName:t.displayName};e.push(i)}}))})),t.forEach((t=>{if(t.url&&(t.isBackground||t.isSkybox)&&!e.find((e=>e.url===t.url))){let i={name:t.name,url:t.url,displayName:t.displayName};e.push(i)}})),e}}applySettings(e){return this.isTextureStore()?new Promise((t=>{let i=[],n=e.orphanTextures||[];for(const e of n)i.push(new Promise((t=>{var i=ly(e.sourceToBase64);new yw.PNG({filterType:4}).parse(i,((i,n)=>{const a=yw.PNG.sync.write(n),r=new Blob([a],{type:"image/png"}),s=new FileReader;s.readAsDataURL(r),s.onload=i=>{Ep.loaders.textureLoader.load(i.target.result,(i=>{i.wrapT=d,i.wrapS=d,this.add(e.key,i,e.sourceModelKey,!0),t()}))}}))})));i.length?Promise.all(i).then((e=>{logger.debug("TextureStore.applySettings() loadTexture end。"),t(1)})):(logger.debug("TextureStore.applySettings() loadTexture end。"),t(1))})):this.isCustomTextureStore()?new Promise((t=>{let i=[];e.forEach((e=>{i.push(new Promise((t=>{this.loadTexture({name:e.displayName,url:e.url,onLoad:()=>{t()}})})))})),i.length?Promise.all(i).then((e=>{logger.debug("TextureStore.applySettings() loadTexture end。"),t(1)})):(logger.debug("TextureStore.applySettings() loadTexture end。"),t(1))})):void 0}getExportTextureGroup(){let e=this.getSettings();if(!e.length)return;let t=new sr;return e.forEach((e=>{let i=this.find(e.url),n=new Fi(new sn(1.4,1.4,10,10));n.name=e.url,n.userData={name:e.name,url:e.url},n.material=new Vt,n.material.color=new Qt,n.material.map=new we(i.textureSource),n.material.map.wrapS=d,n.material.map.wrapT=d,n.material.map.flipY=!1,n.material.map.name=i.name,t.add(n)})),t.userData={customTexture:!0},t}findOrphanTexturesByOne(e,t){if(e)for(let i in this._textures)if(this._textures[i].sourceModelKey===e){let n=[];for(let t of Ep.defaultObjectTree.children){let a=!1;t.getGroup().sourceModelKey!==e&&(t.getGroup().traverse((e=>{if(e.material)if(e.material instanceof Array)e.material.forEach((e=>{for(var t in e)e[t]&&e[t].image&&this._textures[i]._textureSource===e[t].image&&(a=!0)}));else for(var t in e.material)e.material[t]&&e.material[t].image&&this._textures[i]._textureSource===e.material[t].image&&(a=!0)})),a&&n.push(t.name))}n.length>0&&t.push({textureName:this._textures[i].name,usedBy:n})}}findOrphanTextures(e,t){let i=[];if(!e){if(t&&t.children.length){let e=this;t.children.forEach((t=>{e.findOrphanTexturesByOne(t.sourceModelKey,i)}))}return i}return this.findOrphanTexturesByOne(e,i),i}}class uE{constructor(e){this._defaultState={},this._states=[],this._currentState="",this._nodeSelection=new $y(e),this._camera={}}isDefaultState(){return""===this._currentState}add(e){if(!e||this.find(e))return;let t={};return t.id=_y.guid(),t.name=e,Ep.instance.notState?t.settings=JSON.parse(JSON.stringify(Ep.instance.notState)):(t.settings=JSON.parse(JSON.stringify(Ep.instance.getSettings())),Ep.instance._notView&&(t.settings.view=Ep.instance._notView)),delete t.settings.sceneModelTransform,delete t.settings.datumShiftModel,delete t.settings.states,delete t.settings.cache,delete t.settings.texture0,!window.firstLoadEnd&&Ep.sceneSettings&&(t.settings.view.camera=Ep.sceneSettings.view.camera),0===this._states.length?t.defaultState=!0:t.defaultState=!1,t.settings.objectTree.children.forEach((e=>{"BuildingItem"===e.type?e.children.forEach((e=>{"ModelItem"===e.type?e.articulationAnimations&&e.articulationAnimations.forEach((e=>{e.isEnable=!1})):"BuildingFloorItem"===e.type&&e.children.forEach((e=>{"ModelItem"===e.type&&e.articulationAnimations&&e.articulationAnimations.forEach((e=>{e.isEnable=!1}))}))})):"ModelItem"===e.type||"ModelAsset"===e.type?e.articulationAnimations&&e.articulationAnimations.forEach((e=>{e.isEnable=!1})):"PaintItem"===e.type&&(e.children.forEach((e=>{"ModelItem"===e.type&&e.articulationAnimations&&e.articulationAnimations.forEach((e=>{e.isEnable=!1}))})),e.modelInstanced.forEach((e=>{e.articulationAnimations&&e.articulationAnimations.forEach((e=>{e.isEnable=!1}))})))})),this._states.push(t),t.name}clear(){this._states=[],this._currentState}find(e){if(e&&""!==e)return this._states.find((t=>t.name===e))}getStates(){let e=[];this._states.length||this.add("默认状态");for(let i of this._states)if(i.defaultState){t={name:i.name,default:i.defaultState};e.unshift(t)}else{var t={name:i.name,default:i.defaultState};e.push(t)}return e}remove(e){if(e)for(let t=0;t<this._states.length;t++)if(this._states[t].name===e&&!this._states[t].defaultState){this._states.splice(t,1);break}}update(e,t){if(e&&t){for(let i=0;i<this._states.length;i++)if(this._states[i].name===e){this._states[i].name=t;break}this._currentState===e&&(this._currentState=t)}}copyState(e,t){let i={};i.id=_y.guid(),i.name=t;let n=this._states.find((t=>t.name==e));return i.settings=n?JSON.parse(JSON.stringify(n.settings)):JSON.parse(JSON.stringify(Ep.instance.getSettings())),delete i.settings.sceneModelTransform,delete i.settings.datumShiftModel,delete i.settings.states,delete i.settings.cache,delete i.settings.texture0,i.defaultState=!1,this._states.push(i),i}getCurrentState(){return this._currentState}saveCurrentStateSettings(){let e=this.find(this._currentState);e&&(e.settings=JSON.parse(JSON.stringify(Ep.instance.getSettings())),delete e.settings.sceneModelTransform,delete e.settings.datumShiftModel,delete e.settings.states,delete e.settings.cache,e.settings.view.camera.azimuth=this._camera.azimuthAngle,e.settings.view.camera.viewLimitRadius=this._camera.viewLimitRadius,e.settings.view.camera.inclination=this._camera.inclinationAngle,e.settings.view.camera.fov=this._camera.fov,e.settings.view.camera.distance=this._camera.viewDistance,e.settings.view.camera.distanceMax=this._camera.distanceMax,e.settings.view.camera.distanceMin=this._camera.distanceMin,e.settings.view.camera.viewDistanceMin=this._camera.near,e.settings.view.camera.viewDistanceMax=this._camera.far,e.settings.view.camera.targetX=this._camera.targetX,e.settings.view.camera.targetY=this._camera.targetY,e.settings.view.camera.targetZ=this._camera.targetZ,e.settings.view.camera.inclinationAngleMin=this._camera.inclinationAngleMin,e.settings.view.camera.inclinationAngleMax=this._camera.inclinationAngleMax,e.settings.view.camera.duration=null!=this._camera.duration?this._camera.duration:1.5,e.settings.view.camera.autoRotate=this._camera.autoRotate,e.settings.view.camera.autoRotateSpeed=this._camera.autoRotateSpeed,e.settings.view.camera.autoRotateDirection=this._camera.autoRotateDirection,Ep.instance.saveSceneSettings(JSON.parse(JSON.stringify(Ep.instance.getSettings()))))}saveCameraParam(e,t){Ep.orbitControls.defaultTargetPosition=new Ce(e.targetX,e.targetY,e.targetZ),Ep.orbitControls.viewLimitRadius=e.viewLimitRadius,Ep.instance.setAutoRotate(!1,0),Ep.instance.nextRender((()=>{Ep.instance.setAutoRotate(e.autoRotate,_y.getAutoRotateTime(e.autoRotateSpeed,e.autoRotateDirection))})),this._camera=JSON.parse(JSON.stringify(e)),this._camera.duration=t,this.saveCurrentStateSettings()}selectState(e="",t,i){if(""!==e&&!this.find(e))return void(t&&t(0,"名为"+e+"的状态不存在"));this._currentState=e;let n=this.find(e);return n?(null!=n.settings.view.camera.azimuth&&(void 0===n.settings.view.camera.duration&&(n.settings.view.camera.duration=1.5),this._camera.azimuthAngle=n.settings.view.camera.azimuth,0==n.settings.view.camera.viewLimitRadius||n.settings.view.camera.viewLimitRadius||(n.settings.view.camera.viewLimitRadius=1e8),this._camera.viewLimitRadius=n.settings.view.camera.viewLimitRadius,this._camera.inclinationAngle=n.settings.view.camera.inclination,this._camera.fov=n.settings.view.camera.fov,this._camera.viewDistance=n.settings.view.camera.distance,this._camera.distanceMax=n.settings.view.camera.distanceMax,this._camera.distanceMin=n.settings.view.camera.distanceMin,this._camera.near=n.settings.view.camera.viewDistanceMin,this._camera.far=n.settings.view.camera.viewDistanceMax,this._camera.targetX=n.settings.view.camera.targetX,this._camera.targetY=n.settings.view.camera.targetY,this._camera.targetZ=n.settings.view.camera.targetZ,this._camera.inclinationAngleMin=n.settings.view.camera.inclinationAngleMin,this._camera.inclinationAngleMax=n.settings.view.camera.inclinationAngleMax,this._camera.duration=n.settings.view.camera.duration,this._camera.autoRotate=n.settings.view.camera.autoRotate,this._camera.duration=n.settings.view.camera.duration,this._camera.autoRotateSpeed=n.settings.view.camera.autoRotateSpeed,this._camera.autoRotateDirection=n.settings.view.camera.autoRotateDirection),Ep.instance.applySceneSettings(n.settings,t),this.syncAnimation(n,e),i&&i({name:e,default:n.defaultState}),n.settings):void 0}syncAnimation(e,t){this._states.filter((e=>e.name!==t)).forEach((e=>{e.settings.objectTree.children&&e.settings.objectTree.children.forEach&&e.settings.objectTree.children.forEach((e=>{let t=Ep.instance.getDefaultObjectTree().getItemByName(e.name);t&&(e.articulationAnimations&&e.articulationAnimations.filter((e=>e.isEnable)).forEach((e=>{t.resetArticulationAnimation(e.animationName)})),e.articulations&&e.articulations.forEach((e=>{let i=t.articulations.find((t=>t._name==e._name));i&&i.type==my&&i.deleteArticulation()})),e.articulations&&e.articulations.filter((e=>e.isEnable)).forEach((e=>{let i=t.articulations.find((t=>t._name==e._name));i&&i.set(e.value)})),Ep.effectStore.initOutlinePass())}))})),e.settings.objectTree.children&&e.settings.objectTree.children.forEach&&e.settings.objectTree.children.forEach((e=>{let t=Ep.instance.getDefaultObjectTree().getItemByName(e.name);t&&(e.articulations&&e.articulations.forEach((e=>{let i=t.articulations.find((t=>t._name==e._name));i&&i.type==my&&i.deleteArticulation()})),e.articulations&&e.articulations.filter((e=>e.isEnable)).forEach((e=>{let i=t.articulations.find((t=>t._name==e._name));i&&(i.type==my?i.addOrUpdateTextArticulation():i.set(e.value))})),Ep.instance.nextRender((()=>{e.articulationAnimations&&e.articulationAnimations.filter((e=>e.isEnable)).forEach((e=>{t.resetArticulationAnimation(e.animationName),t.playArticulationAnimation(e.animationName)}))})))}))}setCamera(e){this.find(this._currentState)&&(this.find(this._currentState).camera=e)}setGlobalIlluminationInCurrentState(e){this.find(this._currentState)&&(this.find(this._currentState).globalIllumination=e)}getSettings(){let e=[];return this._states.map((t=>{e.push(t)})),e}setNotState(){this._currentState=""}setDefaultState(e){this._states.forEach((e=>{e.defaultState=!1})),this._states.forEach((t=>{t.name===e&&(t.defaultState=!0)}))}setStateMoveUp(e){let t=this._states.findIndex((t=>t.name===e)),i=t-1;this._states[t-1]&&this._states[t-1].defaultState&&(i=t-2);let n=this._states.splice(t,1);this._states.splice(i,0,n[0])}setStateMoveDown(e){let t=this._states.findIndex((t=>t.name===e)),i=t+1;this._states[t+1]&&this._states[t+1].defaultState&&(i=t+2);let n=this._states.splice(t,1);this._states.splice(i,0,n[0])}applySettings(e){e&&e.map((e=>{0===this._states.filter((t=>t.name===e.name)).length&&(delete e.settings.texture0,this._states.push(e))}))}synchronizaArticulation(){Ep.instance.getSettings().objectTree.children.forEach((e=>{this._states.forEach((t=>{let i=t.settings.objectTree.children.find((t=>t.name===e.name));if(i&&i.articulations){let t={};i.articulations.forEach((e=>{t[e._name]={},t[e._name].isEnable=e.isEnable,t[e._name].value=e.value,t[e._name].defaultValue=e.defaultValue,t[e._name]._defaultValue=e._defaultValue})),i.articulations=[],i.articulations=JSON.parse(JSON.stringify(e.articulations)),i.articulations.forEach((e=>{t[e._name]&&(e.isEnable=t[e._name].isEnable,e.value=t[e._name].value,e.defaultValue=t[e._name].defaultValue,e._defaultValue=t[e._name]._defaultValue)}))}}))}))}synchronizaAnimation(){Ep.instance.getSettings().objectTree.children.forEach((e=>{this._states.forEach((t=>{let i=t.settings.objectTree.children.find((t=>t.name===e.name));if(i&&i.articulationAnimations){let t={};i.articulationAnimations.forEach((e=>{t[e.animationName]={},t[e.animationName].isEnable=e.isEnable})),i.articulationAnimations=[],i.articulationAnimations=JSON.parse(JSON.stringify(e.articulationAnimations)),i.articulationAnimations.forEach((e=>{t[e.animationName]&&(e.isEnable=t[e.animationName].isEnable)}))}}))}))}getCurrentStateSetting(){return""!==this._currentState&&this._states.find((e=>e.name==this._currentState)).settings}dispose(){this._defaultState={},this._states=[],this._currentState="",this._nodeSelection.dispose&&this._nodeSelection.dispose(),this._camera=null}}class dE{constructor(){this.scenes={},this.currentName=""}addScene(e,t,i,n=!1){return this.scenes[e]={serviceName:e,scenePath:t,token:i,defaultScene:n},this.scenes[e]}findScene(e){return this.scenes[e]}createCache(e=this.currentName){this.scenes[e].cache||(this.scenes[e].cache={}),this.scenes[e].cache.scene!==Ep.scene&&(this.scenes[e].cache.scene=Ep.scene),this.scenes[e].cache.objectStore!==Ep.objectStore&&(this.scenes[e].cache.objectStore=Ep.objectStore)}destroyCache(e=this.currentName){if(!this.scenes[e].cache)return;const t=this.scenes[e].cache;t.scene&&_y.disposeThreeObject(t.scene),t.objectStore&&t.objectStore.dispose&&t.objectStore.dispose(),delete this.scenes[e].cache}destroy(){for(const e in this.scenes)this.destroyCache(e);this.scenes={}}createScene(e,t,i,n,a=!1){const r={};r.serviceName=e,r.scenePath=t,r.token=n,r.defaultScene=a,r.cache={};const s=r.cache;void 0!==i?(s.scene=i,s.models=Ep.models,s.sysObjects=Ep.sysObjects,s.noneModels=Ep.noneModels,s.axesHelper=Ep.axesHelper,s.objectStore=Ep.objectStore):(s.scene=new mr,s.scene.name="__newAvwCore"+_y.guid(),s.models=new sr,s.models.name="__models",s.scene.models=s.models,s.scene.add(s.models),s.sysObjects=new sr,s.sysObjects.name="__sysObjects",s.sysObjects.renderOrder=1/0,s.scene.sysObjects=s.sysObjects,s.scene.add(s.sysObjects),s.noneModels=new sr,s.noneModels.name="__noneModels",s.scene.noneModels=s.noneModels,s.scene.add(s.noneModels),s.axesHelper=new Sh(50),s.axesHelper.name="__axesHelper",s.axesHelper.visible=!1,s.scene.axesHelper=s.axesHelper,s.scene.add(s.axesHelper),Ep.alpha||(s.scene.background=new Qt(0)),s.scene.setNodeRotation=Ep.instance.setNodeRotation,s.scene.setNodeRotating=Ep.instance.setNodeRotating,s.scene.setNodeScaling=Ep.instance.setNodeScaling,s.scene.setNodeBreathing=Ep.instance.setNodeBreathing,s.objectStore=new oE(s.scene)),this.scenes[e]=r}addOrUpdateScene({serviceName:e,scenePath:t,scene:i,token:n,defaultScene:a=!1}){const r=this.findSceneCache(e);r?(i&&(r.scene=i),t&&(r.scenePath=t),n&&(r.token=n)):this.createScene(e,t,i,n,a)}getScenes(){const e=[];for(const t in this.scenes){const i=this.scenes[t];e.push({name:i.serviceName,default:!!i.defaultScene,url:i.scenePath,token:void 0!==i.token?i.token:""})}return e}findSceneCache(e){return this.scenes[e]}}var pE={type:"objectChange"},mE={type:"stateChange"},fE={type:"historyMove"};class gE extends pe{constructor(e){super("TransformStore");let t=this;this.mode="model",this.transformControls=e,this.transformHistory={model:[],node:[]},this._historyState={model:0,node:0},this._historyType={model:"new",node:"new"},this._selectionType={model:"defaultModelSelection",node:"defaultNodeSelection"};let i=[];this.controlState={redo:!1,undo:!1},this._getHelperTransform=e=>{let{key:t}=e.userData;return e.instanced.getTransform(t)},this.mouseDown=e=>{if(i=[],Ep.instance[this._selectionType[this.mode]].getSelectionList().length)Ep.instance[this._selectionType[this.mode]].getSelectionList().forEach((e=>{let t={},n=Ep.scene.getObjectByProperty("uuid",e),a={};if(n){let e=n.position.clone(),t=n.rotation.clone(),i=n.scale.clone();if(n instanceof Mb){let a=this._getHelperTransform(n);e=a.position,t=a.rotation,i=a.scale}a.position=JSON.parse(JSON.stringify(e)),a.rotation=JSON.parse(JSON.stringify(t)),a.scale=JSON.parse(JSON.stringify(i)),a.rotation.x=a.rotation._x=ge.radToDeg(t._x),a.rotation.y=a.rotation._y=ge.radToDeg(t._y),a.rotation.z=a.rotation._z=ge.radToDeg(t._z)}t.object=n,t.oldTransform=a,i.push(t)}));else{let t={},n=e.target.object;if(!n&&e.uuid&&(n=Ep.scene.getObjectByProperty("uuid",e.uuid)),!Ep.instance.defaultObjectTree.getItemByUUID(n.uuid))return;let a={};if(n){let e=n.position.clone(),t=n.rotation.clone(),i=n.scale.clone();if(n instanceof Mb){let a=this._getHelperTransform(n);e=a.position,t=a.rotation,i=a.scale}a.position=JSON.parse(JSON.stringify(e)),a.rotation=JSON.parse(JSON.stringify(t)),a.scale=JSON.parse(JSON.stringify(i)),a.rotation.x=a.rotation._x=ge.radToDeg(t._x),a.rotation.y=a.rotation._y=ge.radToDeg(t._y),a.rotation.z=a.rotation._z=ge.radToDeg(t._z)}t.object=n,t.oldTransform=a,i.push(t)}},this.mouseUp=e=>{if(!i.length)return;let n=new Map;if(Ep.instance[this._selectionType[this.mode]].getSelectionList().length)Ep.instance[this._selectionType[this.mode]].getSelectionList().forEach((e=>{let t=Ep.scene.getObjectByProperty("uuid",e),i={};if(t){let e=t.position.clone(),a=t.rotation.clone(),r=t.scale.clone();if(t instanceof Mb){let i=this._getHelperTransform(t);e=i.position,a=i.rotation,r=i.scale}i.position=JSON.parse(JSON.stringify(e)),i.rotation=JSON.parse(JSON.stringify(a)),i.scale=JSON.parse(JSON.stringify(r)),i.rotation.x=i.rotation._x=ge.radToDeg(a._x),i.rotation.y=i.rotation._y=ge.radToDeg(a._y),i.rotation.z=i.rotation._z=ge.radToDeg(a._z),n.set(t,i)}}));else{let t=e.target.object;!t&&e.uuid&&(t=Ep.scene.getObjectByProperty("uuid",e.uuid));let i={};if(t){let e=t.position.clone(),a=t.rotation.clone(),r=t.scale.clone();if(t instanceof Mb){let i=this._getHelperTransform(t);e=i.position,a=i.rotation,r=i.scale}i.position=JSON.parse(JSON.stringify(e)),i.rotation=JSON.parse(JSON.stringify(a)),i.scale=JSON.parse(JSON.stringify(r)),i.rotation.x=i.rotation._x=ge.radToDeg(a._x),i.rotation.y=i.rotation._y=ge.radToDeg(a._y),i.rotation.z=i.rotation._z=ge.radToDeg(a._z),n.set(t,i)}}let a=i.map((e=>e.oldTransform)),r=i.map((e=>e.object)).map((e=>n.get(e)));if(a.length===r.length&&JSON.stringify(a)!=JSON.stringify(r)){let e;i.forEach((e=>{e.newTransform=n.get(e.object)})),e="new"==t.historyType[this.mode]?t.historyState[this.mode]+1:t.historyState[this.mode],t.transformHistory[this.mode].splice(e),t.transformHistory[this.mode].push(i),t.historyState[this.mode]=t.transformHistory[this.mode].length-1,t.historyType[this.mode]="new",i=[],this.historyState=this.historyState,this.historyType=this.historyType}},this.transformControls.addEventListener("mouseDown",this.mouseDown),this.transformControls.addEventListener("mouseUp",this.mouseUp)}onGoHistory(e,t){if(e.length>1){let i=e.map((e=>(Ep.instance.setModelTransformByUUID(e.object.uuid,e[t]),e.object.uuid)));Ep.instance[this._selectionType[this.mode]].selectObjectByUUID(i),Ep.instance[this._selectionType[this.mode]].enableTransformControl(),fE.object=i,fE.eventType="multiple",this.dispatchEvent(fE)}else e.forEach((e=>{Ep.instance.setModelTransformByUUID(e.object.uuid,e[t]),fE.object=e.object,fE.eventType="radio",this.dispatchEvent(fE)}))}advance(){if(this.controlState.redo&&!(this.transformHistory[this.mode].length<=0)){if(this.historyState[this.mode]<this.transformHistory[this.mode].length-1)if("new"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]+1];this.onGoHistory(e,"newTransform"),this.historyState[this.mode]=this.historyState[this.mode]+1,this.historyType[this.mode]="new"}else{let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"newTransform"),this.historyType[this.mode]="new"}if(this.historyState[this.mode]==this.transformHistory[this.mode].length-1&&"old"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"newTransform"),this.historyType[this.mode]="new"}this.historyState=this.historyState,this.historyType=this.historyType,this.transformControls.object&&this.transformControls.dispatchEvent(pE)}}backOff(){if(this.controlState.undo&&!(this.transformHistory[this.mode].length<=0)){if(this.historyState[this.mode]>0)if("old"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]-1];this.onGoHistory(e,"oldTransform"),this.historyState[this.mode]=this.historyState[this.mode]-1,this.historyType[this.mode]="old"}else{let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"oldTransform"),this.historyType[this.mode]="old"}if(0==this.historyState[this.mode]&&"new"==this.historyType[this.mode]){let e=this.transformHistory[this.mode][this.historyState[this.mode]];this.onGoHistory(e,"oldTransform"),this.historyType[this.mode]="old"}this.historyState=this.historyState,this.historyType=this.historyType,this.transformControls.object&&this.transformControls.dispatchEvent(pE)}}clear(){this.transformHistory[this.mode]=[],this.historyState[this.mode]=0,this.historyState=this.historyState,this.historyType[this.mode]="new",this.historyType=this.historyType}destroy(){this.transformControls.removeEventListener("mouseDown",this.mouseDown),this.transformControls.removeEventListener("mouseUp",this.mouseUp),this.transformControls=null,this.transformHistory=null,this.historyState=null,this.historyType=null}returnChangeState(){if(!this.historyState)return;if(null===this.historyState[this.mode])return;if(null===this.historyType[this.mode])return;let e={redo:!1,undo:!1};this.transformHistory[this.mode].length>0&&("old"==this.historyType[this.mode]?(this.historyState[this.mode]>0&&(e.undo=!0),this.historyState[this.mode]<=this.transformHistory[this.mode].length-1&&(e.redo=!0)):"new"==this.historyType[this.mode]&&(this.historyState[this.mode]>=0&&(e.undo=!0),this.historyState[this.mode]<this.transformHistory[this.mode].length-1&&(e.redo=!0))),this.controlState=e,this.dispatchEvent(mE)}setMode(e){this.mode=e,this.historyState=this.historyState,this.historyType=this.historyType}get historyState(){return this._historyState}set historyState(e){this._historyState=e,this.returnChangeState()}get historyType(){return this._historyType}set historyType(e){this._historyType=e,this.returnChangeState()}}class yE extends wi{constructor(e=[],t=1,i=1,n=!1,a){super(),this.type="AreaGeometry",this.faceType=a,this.parameters={points:e,height:t,steps:i,openEnded:n};const r=this;i=Math.floor(i);const s=e.length;let o=[0],l=0;this.min={x:1/0,y:1/0},this.max={x:-1/0,y:-1/0};for(let t=1;t<e.length;t++){e[t].x>this.max.x&&(this.max.x=e[t].x),e[t].x<this.min.x&&(this.min.x=e[t].x),e[t].y>this.max.y&&(this.max.y=e[t].y),e[t].y<this.min.y&&(this.min.y=e[t].y);let i=Math.sqrt((e[t].x-e[t-1].x)*(e[t].x-e[t-1].x)+(e[t].y-e[t-1].y)*(e[t].y-e[t-1].y));l+=i,o.push(l)}if(this.max.x===this.min.x||this.max.y===this.min.y)return;this.center={x:(this.max.x-this.min.x)/2+this.min.x,y:(this.max.y-this.min.y)/2+this.min.y},this.sideWallSegments=l/t;const c=[],h=[],u=[],d=[];let p=0;const m=[];let f=0;!function(){const n=new Ce,a=new Ce;let g=0;for(let r=0;r<=i;r++){const c=[],f=r/i;for(let i=0;i<s;i++)a.x=e[i].x,a.y=f*t,a.z=-e[i].y,h.push(a.x,a.y,a.z),n.set(a.x,0,a.z).normalize(),u.push(n.x,n.y,n.z),d.push(o[i]/l,1-f),c.push(p++);m.push(c)}for(let e=0;e<s;e++)for(let t=0;t<i;t++){const i=m[t][e],n=m[t+1][e],a=m[t+1][e+1],r=m[t][e+1];c.push(i,n,r),c.push(n,a,r),g+=6}r.addGroup(f,g,0),f+=g}();const g=[];let y=new El;y.setFromPoints(e);const v=y.extractPoints(12);let b=v.shape;const _=v.holes;if(!to.isClockWise(b)){b=b.reverse();for(let e=0,t=_.length;e<t;e++){const t=_[e];to.isClockWise(t)&&(_[e]=t.reverse())}}const x=to.triangulateShape(b,_);for(let e=0,t=_.length;e<t;e++){const t=_[e];b=b.concat(t)}const w=b.length,S=x.length;for(let e=0;e<w;e++){const i=b[e];M(i.x,i.y,t)}for(let e=0;e<w;e++){const t=b[e];M(t.x,t.y,0)}function M(e,t,i){g.push(e),g.push(t),g.push(i)}function T(e,t,i){A(e),A(t),A(i)}function A(e){h.push(g[3*e+0]),h.push(g[3*e+2]),h.push(-g[3*e+1]),u.push(0,g[3*e+2]>0?1:-1,0);let t=new ye;var i;t.x=(g[3*e+0]-r.min.x)/(r.max.x-r.min.x),t.y=(g[3*e+1]-r.min.y)/(r.max.y-r.min.y),i=t,d.push(i.x),d.push(i.y),c.push(p),p++}!function(e){if(0===e)return;const t=p;let i=!1;if(1===e||2===e){i=!0;for(let e=0;e<S;e++){const t=x[e];T(t[0],t[1],t[2])}r.addGroup(3*t,p-t,1)}if(-1===e||2===e){const e=2*t+p;for(let e=0;e<S;e++){const t=x[e];T(t[2]+w,t[1]+w,t[0]+w)}r.addGroup(e,p-e+2*t,i?2:1)}}(this.faceType),this.setIndex(c),this.setAttribute("position",new hi(h,3)),this.setAttribute("normal",new hi(u,3)),this.setAttribute("uv",new hi(d,2))}}class vE extends wi{constructor(e=[],t=1,i=1,n=!1,a,r){super(),this.type="AreaOnGlobeGeometry",this.faceType=a;let s=[];e.forEach((e=>{s.push(e.x),s.push(e.y)}));let o=_y.interpolateAlongGlobe2D(s,2,32,!1,r),l=[];for(let e=0;e<o.length/2;e++){let t=new Ce(o[2*e],o[2*e+1],0);l.push(t)}l=e,this.parameters={points:l,height:t,steps:i,openEnded:n};const c=this;i=Math.floor(i);const h=l.length;let u=[0],d=0;this.min={x:1/0,y:1/0,z:1/0},this.max={x:-1/0,y:-1/0,z:-1/0};for(let e=1;e<l.length;e++){l[e].x>this.max.x&&(this.max.x=l[e].x),l[e].x<this.min.x&&(this.min.x=l[e].x),l[e].y>this.max.y&&(this.max.y=l[e].y),l[e].y<this.min.y&&(this.min.y=l[e].y),l[e].z>this.max.z&&(this.max.z=l[e].z),l[e].z<this.min.z&&(this.min.z=l[e].z);let t=Math.sqrt((l[e].x-l[e-1].x)*(l[e].x-l[e-1].x)+(l[e].y-l[e-1].y)*(l[e].y-l[e-1].y)+(l[e].z-l[e-1].z)*(l[e].z-l[e-1].z));d+=t,u.push(d)}if(this.max.x===this.min.x||this.max.y===this.min.y)return;this.center={x:(this.max.x-this.min.x)/2+this.min.x,y:(this.max.y-this.min.y)/2+this.min.y,z:(this.max.z-this.min.z)/2+this.min.z},this.sideWallSegments=d/t;const p=[],m=[],f=[],g=[];let y=0;const v=[];let b=0;!function(){const e=new Ce,n=new Ce;let a=0;for(let a=0;a<=i;a++){const s=[],o=a/i;for(let i=0;i<h;i++){n.x=l[i].x,n.y=o*t,n.z=-l[i].y;let a=r-Math.sin(Math.acos(Math.sqrt(n.x*n.x+n.z*n.z)/r))*r;n.y-=a,m.push(n.x,n.y,n.z),e.set(n.x,0,n.z).normalize(),f.push(e.x,e.y,e.z),g.push(u[i]/d,1-o),s.push(y++)}v.push(s)}for(let e=0;e<h;e++)for(let t=0;t<i;t++){const i=v[t][e],n=v[t+1][e],r=v[t+1][e+1],s=v[t][e+1];p.push(i,n,s),p.push(n,r,s),a+=6}c.addGroup(b,a,0),b+=a}();const _=[];let x=new El;x.setFromPoints(l);const w=x.extractPoints(12);let S=w.shape;const M=w.holes;if(!to.isClockWise(S)){S=S.reverse();for(let e=0,t=M.length;e<t;e++){const t=M[e];to.isClockWise(t)&&(M[e]=t.reverse())}}const T=to.triangulateShape(S,M);for(let e=0,t=M.length;e<t;e++){const t=M[e];S=S.concat(t)}const A=S.length,E=T.length;for(let e=0;e<A;e++){const i=S[e];C(i.x,i.y,t)}for(let e=0;e<A;e++){const t=S[e];C(t.x,t.y,0)}function C(e,t,i){_.push(e),_.push(t),_.push(i)}function I(e,t,i){P(e),P(t),P(i)}function P(e){let t=_[3*e+0],i=_[3*e+2],n=-_[3*e+1];i-=r-Math.sin(Math.acos(Math.sqrt(t*t+n*n)/r))*r,m.push(t),m.push(i),m.push(n),f.push(0,i>0?1:-1,0);let a=new ye;var s;a.x=(t-c.min.x)/(c.max.x-c.min.x),a.y=(-n-c.min.y)/(c.max.y-c.min.y),s=a,g.push(s.x),g.push(s.y),p.push(y),y++}!function(e){if(0===e)return;const t=y;let i=!1;if(1===e||2===e){i=!0;for(let e=0;e<E;e++){const t=T[e];I(t[0],t[1],t[2])}c.addGroup(3*t,y-t,1)}if(-1===e||2===e){const e=2*t+y;for(let e=0;e<E;e++){const t=T[e];I(t[2]+A,t[1]+A,t[0]+A)}c.addGroup(e,y-e+2*t,i?2:1)}}(this.faceType),this.setIndex(p),this.setAttribute("position",new hi(m,3)),this.setAttribute("normal",new hi(f,3)),this.setAttribute("uv",new hi(g,2))}}class bE extends Or{constructor(e,t={}){if(!e||!e.map)return void console.warn("AnimatedSprite 必须在构造时提供材质和基本帖图。");super(e);let i=t.dimension instanceof Array?t.dimension:[1,1],n="number"==typeof t.duration?t.duration:1;this.loop=!!t.loop,this.destroyOnFinish=!!t.destroyOnFinish,e.map.wrapS=d,e.map.wrapT=d,e.map.repeat.set(1/i[0],1/i[1]),e.map.offset.set(0,1-1/i[1]);let a=e.opacity,r=!1,s=i[0]*i[1],o=n/s,l=0,c=1;this.fadeInFrame="number"==typeof t.fadeInFrame?Math.floor(t.fadeInFrame):-1,this.fadeOutFrame="number"==typeof t.fadeOutFrame?Math.floor(t.fadeOutFrame):-1,this.needsRemove=!1,this.play=()=>{this.material.map.offset.set(0,1-1/i[1]),this.material.opacity=a,r=!0},this.stop=()=>{r=!1},this.update=e=>{if(r&&(l+=e=e||1/60,l>=o)){if(c++,l=0,c>s&&(c=1,!this.loop))return r=!1,void(this.destroyOnFinish&&(this.needsRemove=!0));this.material.opacity=a,this.fadeInFrame>0&&c<this.fadeInFrame&&(this.material.transparent=!0,this.material.opacity=a*(c/this.fadeInFrame+1)),this.fadeOutFrame>0&&c>this.fadeOutFrame&&(this.material.transparent=!0,this.material.opacity=a*(s-c)/(s-this.fadeOutFrame+1));let e=(c-1)%i[0]/i[0],t=Math.floor((s-c)/i[0])/i[1];this.material.map.offset.set(e,t)}},this.dispose=()=>{this.material.map.dispose(),this.material.dispose()},this.setOpacity=e=>{a=e}}get isPlaying(){return _isPlaying}get dimension(){return _dimension}set dimension(e){e instanceof Array&&e.length>=2&&(_dimension=e,_frameCount=_dimension[0]*_dimension[1],_frameDuration=_duration/_frameCount,this.material.map.repeat.set(1/_dimension[0],1/_dimension[1]),this.material.map.offset.set(0,1-1/_dimension[1]))}get duration(){return _duration}set duration(e){"number"==typeof e&&(_duration=e,_frameDuration=_duration/_frameCount)}}class _E{static createText(e,t){var i;if(null!=t){var n=t.canvas,a=new vs(n),r=new vr({map:a,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:t.sizeAttenuation});return(i=new Or(r)).onBeforeRender=function(){this.userData.inView=!0},i.scale.set(t.width,t.height,1),i.center=new ye(t.offsetV,t.offsetH),i.visible=t.enableText,e?e.add(i):Ep.objectStore.add(i),i}}static createText_Billboard(e,t){var i;if(null!=t){var n=t.canvas,a=new vs(n),r=new vr({map:a,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:t.sizeAttenuation});if((i=new Or(r)).onBeforeRender=function(){this.userData.inView=!0},i.scale.set(t.sizeAttenuation?.045*t.canvas.width:405e-6*t.canvas.width,t.sizeAttenuation?.045*t.canvas.height:405e-6*t.canvas.height,1),"left"===t.labelAlignment){let n=e.children[1].material.map.image.width,r=n/e.children[1].scale.x,s=a.image.width;n=n/r*(s/i.scale.x);let o=n/1.8/s*-1;i.center.set(o,t.offsetH)}else i.center.set(t.offsetV,t.offsetH);return i.visible=t.enableText,e?e.add(i):Ep.objectStore.add(i),i}}static generateLableCanvas(e="",t=5,i="#111111",n="#ffffff",a=!1,r=!1,s="微软雅黑"){let o=document.createElement("canvas"),l=o.getContext("2d");var c=8*t,h="";r&&(h="italic");var u="";return a&&(u="bold"),l.font=`${h} ${u} ${c}px ${s}`,l.textAlign="center",l.textBaseline="middle",o.width=l.measureText(e).width+c,o.height=2*c,l.fillStyle=i,l.fillRect(0,0,o.width,o.height),l.font=`${h} ${u} ${c}px ${s}`,l.fillStyle=n,l.textAlign="center",l.textBaseline="middle",l.fillText(e,o.width/2,o.height/2),o}static createWord(e,t,i){const n=t.textParam.textSize,a=t.textParam.text,r=t.textParam.fontFamily?t.textParam.fontFamily:"微软雅黑, Microsoft Yahei, PingFang SC, Helvetica, Noto Sans CJK SC, Source Han Sans SC, SimHei, sans-serif",s=t.textParam.color,o=t.textParam.fontBold?"bold":"normal",l=t.textParam.enableItalic?"italic":"normal",c=t.textParam.background,h=t.textParam.padding?2*t.textParam.padding:10,u=document.createElement("canvas"),d=u.getContext("2d");d.font=`${l} ${o} ${n}px ${r}`,u.width=d.measureText(a).width+h,u.height=n+h,d.fillStyle=c,d.fillRect(0,0,u.width,u.height),d.font=`${l} ${o} ${n}px ${r}`,d.fillStyle=s,d.textAlign="center",d.textBaseline="middle",d.fillText(a,u.width/2,u.height/2);const p=new vs(u),m=new vr({map:p,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:t.param.sizeAttenuation});return i?i.material=m:(i=new Or(m),e.add(i)),t.param.sizeAttenuation?i.scale.set(u.width,u.height,1):i.scale.set(u.width/Ep.renderer.domElement.height,u.height/Ep.renderer.domElement.height,1),i.center=new ye(t.textParam.offsetV,t.textParam.offsetH),i.type="IconAsset",i.name=t.name+"文字",i}}var xE=new class{getPaintLayerItem(e){const t={},i=Ep.defaultObjectTree.children.filter((e=>"PaintItem"===e.type));for(const n of i){const i=n.getItemByName(e);if(i)return i instanceof $_?t.modelItem=i:i instanceof _b&&(t.instancedItem=i),t}return t}createVector3(){return new Ce}setModelClipping(e,t){const i=Ep.instance.defaultObjectTree.getItemByName(e);i?(Ep.clippingControls.attach(i.getGroup()),t&&t(1,"成功。")):t&&t(0,"模型不存在。")}highlightRoom(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i,n,a=Ep.instance.defaultObjectTree.getItemByName(e.id);if(a)if("BuildingItem"===(Ep.instance.defaultObjectTree.findItemByObject3D(a.getGroup())||{}).getType())if(a.children.forEach((t=>{t.level===Number(e.floor)&&(i=t)})),i){for(const t of i.children)t.name===e.room&&(n=t);n?("none"===e.type?Ep.effectStore.cancleHighlightObject(n.getGroup()):Ep.effectStore.highlightObject(n.getGroup(),!0),t&&t({result:1,message:"成功"})):t&&t({result:0,message:"房间不存在"})}else t&&t({result:0,message:"楼层号不存在"});else t&&t({result:0,message:"指定的对象非建筑"});else t&&t({result:0,message:"建筑不存在"})}_onIconModelClick(e,t,i){if(!t||"iconModel"!==t.type)return;if(t.isIcon)return;const n=t._name,a=Ep.instance.defaultObjectTree.getItemByName(n).getGroup();if(!a.userData.behavior)return;const r=!a.userData.checked;a.userData.checked=r;const s=r?.5:0;a.traverse((e=>{if(e.material)if(e.material instanceof Array)for(const t of e.material)void 0===t.userData.originalOpacity&&(t.userData.originalOpacity=t.opacity),t.opacity=t.userData.originalOpacity*s,t.transparent=t.opacity<=1;else void 0===e.material.userData.originalOpacity&&(e.material.userData.originalOpacity=e.material.opacity),e.material.opacity=e.material.userData.originalOpacity*s,e.material.transparent=e.material.opacity<=1}))}_onIconModelHover(e,t,i){if(!t||"iconModel"!==t.type)return;if(t.isIcon)return;const n=t.name,a=Ep.instance.defaultObjectTree.getItemByName(n).getGroup();if(!a.userData.behavior)return;if(Ep.effectStore.highlightObject(a,!0),a.userData.checked)return;a.traverse((e=>{if(e.material)if(e.material instanceof Array)for(const t of e.material)void 0===t.userData.originalOpacity&&(t.userData.originalOpacity=t.opacity),t.opacity=.5*t.userData.originalOpacity,t.transparent=t.opacity<=1;else void 0===e.material.userData.originalOpacity&&(e.material.userData.originalOpacity=e.material.opacity),e.material.opacity=.5*e.material.userData.originalOpacity,e.material.transparent=e.material.opacity<=1}))}_onIconModelUnhover(e,t,i){if(!t||"iconModel"!==t.type)return;if(t.isIcon)return;const n=t.name,a=Ep.instance.defaultObjectTree.getItemByName(n).getGroup();if(!a.userData.behavior)return;if(Ep.effectStore.cancleHighlightObject(a),a.userData.checked)return;a.traverse((e=>{if(e.material)if(e.material instanceof Array)for(const t of e.material)void 0===t.userData.originalOpacity&&(t.userData.originalOpacity=t.opacity),t.opacity=0*t.userData.originalOpacity,t.transparent=t.opacity<=1;else void 0===e.material.userData.originalOpacity&&(e.material.userData.originalOpacity=e.material.opacity),e.material.opacity=0*e.material.userData.originalOpacity,e.material.transparent=e.material.opacity<=1}))}addIconModel(e){const t=e.callback;Ep.instance.defaultObjectTree.findItemByName(e.id)?t&&t({result:0,message:`模型 ${e.id} 已经存在！`}):(e.token&&e.token.length>64&&Ep.instance.setAvwToken("header","authorization:bearer",e.token),Ep.cacheStore.loadTGPW({path:e.url,onLoad:async i=>{const n=i.userData.icon,a=i.userData.setting,r=_y.cloneDeep(i.children[0].userData.dhExtension);await Ep.textureStore.applySettings(r.texture0||{}),delete r.texture0,await Ep.customTextureStore.applySettings(r.texture||[]);const s=r.objectTree.children[0];Ep.instance.defaultObjectTree.addModel({name:s.name,modelPath:s.modelPath,modelType:s.modelType||"glb",transform:s.transform,index:Math.max(...Ep.defaultObjectTree.children.map((e=>e.index)))+1,isVisible:null==s.isVisible||s.isVisible,isLock:null!=s.isLock&&s.isLock},((i,s,o)=>{Ep.instance.defaultObjectTree.applySettings({children:[r.objectTree.children[0]]}),o.name=e.id,o.isIconModel=!0,o.formApi=!0,o.isDrawable=e.isDrawable;const l=o.getGroup();l.name=e.id;for(const t of o.articulationAnimations)for(const i of t.articulationAnimationItems)i.modelId=e.id;Ep.instance.setTransform(l,{position:e.position,rotation:e.rotation,scale:e.scale,forApi:!0}),void 0!==e.labelText&&(a.iconSetting.textParam.text=e.labelText),a.iconScale=e.iconScale,a.labelScale=e.labelScale,l.userData.icon=n,l.userData.setting=a,this.setIconModel({modelItem:o,icon:n,setting:a,alpha:e.alpha,visible:e.visible,zLevel:e.zLevel,callback:e=>{this.updateIconModelInterval(o),t&&t(e)}})}))},onError:()=>{t&&t({result:0,message:`模型型号加载失败：${e.partNumberId}`})}}))}setIconModel({modelItem:e,icon:t,setting:i,callback:n,alpha:a,visible:r,zLevel:s}){if(!e)return;void 0===i.iconScale&&(i.iconScale=1),void 0===i.labelScale&&(i.labelScale=1);const o=e.getGroup();if("toggle"===i.behavior?(Ep.eventHandlerStore.add("click","model",this._onIconModelClick),Ep.eventHandlerStore.add("mousehover","model",this._onIconModelHover),Ep.eventHandlerStore.add("unmousehover","model",this._onIconModelUnhover),o.userData.behavior="toggle",o.userData.checked=!1,a=0):(delete o.userData.behavior,delete o.userData.checked,void 0===a&&(a=1)),o.traverse((e=>{if(e.isMesh&&!e.isWater)if(e.material instanceof Array)for(const t of e.material)void 0===t.userData.originalOpacity&&(t.userData.originalOpacity=t.opacity),t.opacity=t.userData.originalOpacity*a,t.transparent=t.opacity<1;else void 0===e.material.userData.originalOpacity&&(e.material.userData.originalOpacity=e.material.opacity),e.material.opacity=e.material.userData.originalOpacity*a,e.material.transparent=e.material.opacity<1})),Ep.animationStore.findAnimation(o.uuid,yy.type)||(o.activeVisible=!0,o.enableAutoHidebyDistance=!0,Ep.animationStore.addDistance(o.uuid,yy,Ep.camera,o)),o.minDistance=i.visibleSetting.modelNear*Ep.worldScale,o.maxDistance=i.visibleSetting.modelFar*Ep.worldScale,void 0!==r&&(o.visible=!!r,o.activeVisible=!!r),!t)return void(n&&n({result:1,message:"成功。"}));const l=e.name+"-IconAssect";let c=Ep.instance.defaultObjectTree.getItemByName(l);if(c)c.update({name:l,isVisible:o.visible,transform:{position:{x:i.iconSetting.transformNode.position.x,y:i.iconSetting.transformNode.position.y,z:i.iconSetting.transformNode.position.z},scale:i.iconSetting.transformNode.scale},param:{background:"",backgroundColor:"",height:128,width:128,offsetH:.5,offsetV:0,path:t,minDistance:i.visibleSetting.iconNear,maxDistance:i.visibleSetting.iconFar,polygonOffset:!1,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,sizeAttenuation:!1,iconScale:i.iconScale},textParam:{background:i.iconSetting.textParam.background,color:i.iconSetting.textParam.color,enableItalic:i.iconSetting.textParam.enableItalic,enableText:i.iconSetting.textParam.enableText,fontBold:i.iconSetting.textParam.fontBold,fontFamily:i.iconSetting.textParam.fontFamily,fontSize:i.iconSetting.textParam.fontSize,textSize:i.iconSetting.textParam.textSize,offsetH:i.iconSetting.textParam.offsetH,offsetV:i.iconSetting.textParam.offsetV,text:i.iconSetting.textParam.text,fontWeight:i.iconSetting.textParam.fontWeight,hiddenDistance:i.iconSetting.textParam.hiddenDistance,minDistance:i.iconSetting.textParam.textNear,maxDistance:i.iconSetting.textParam.textFar,padding:i.iconSetting.textParam.padding,position:i.iconSetting.textParam.position,labelScale:i.labelScale},type:"IconAsset",parent:"objectTree",isCustom:!1},(e=>{const t=c.getGroup();void 0!==r&&(t.visible=!!r,t.activeVisible=!!r),Ep.defaultObjectTree.setModelTransform(l,{position:{x:i.iconSetting.transformNode.position.x,y:i.iconSetting.transformNode.position.y,z:i.iconSetting.transformNode.position.z},scale:i.iconSetting.transformNode.scale},(()=>{n&&n({result:1,message:"成功。"})}))}));else{const e=Math.max(...Ep.defaultObjectTree.children.map((e=>e.index)))+1;c=new yb({name:l,index:e,isVisible:o.visible,transform:{position:{x:i.iconSetting.transformNode.position.x,y:i.iconSetting.transformNode.position.y,z:i.iconSetting.transformNode.position.z},scale:i.iconSetting.transformNode.scale},param:{background:"",backgroundColor:"",height:128,width:128,offsetH:.5,offsetV:0,path:t,minDistance:i.visibleSetting.iconNear,maxDistance:i.visibleSetting.iconFar,polygonOffset:!1,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,sizeAttenuation:!1,iconScale:i.iconScale},textParam:{background:i.iconSetting.textParam.background,color:i.iconSetting.textParam.color,enableItalic:i.iconSetting.textParam.enableItalic,enableText:i.iconSetting.textParam.enableText,fontBold:i.iconSetting.textParam.fontBold,fontFamily:i.iconSetting.textParam.fontFamily,fontSize:i.iconSetting.textParam.fontSize,textSize:i.iconSetting.textParam.textSize,offsetH:i.iconSetting.textParam.offsetH,offsetV:i.iconSetting.textParam.offsetV,text:i.iconSetting.textParam.text,fontWeight:i.iconSetting.textParam.fontWeight,hiddenDistance:i.iconSetting.textParam.hiddenDistance,minDistance:i.iconSetting.textParam.textNear,maxDistance:i.iconSetting.textParam.textFar,padding:i.iconSetting.textParam.padding,position:i.iconSetting.textParam.position,labelScale:i.labelScale},type:"IconAsset",parent:"objectTree",isCustom:!1},void 0,void 0,void 0,((e,t)=>{t.formApi=!0,t.isIconModelIcon=!0;const i=t.getGroup();i.name=l,void 0!==r&&(i.visible=!!r,i.activeVisible=!!r),void 0!==s&&(o.renderOrder=Fy+s,i.renderOrder=Fy+s),n&&n({result:1,message:"成功。"})}))}}updateIconModel(e,t){return new Promise((i=>{const n=Ep.defaultObjectTree.getItemByName(e.id);if(!n)return void i();const a=n.getGroup();Ep.instance.setTransform(a,{position:e.position,rotation:e.rotation,scale:e.scale,forApi:!0}),"toggle"===a.userData.behavior?a.userData.checked?e.alpha=.5:e.alpha=0:void 0===e.alpha&&(e.alpha=1),a.traverse((t=>{if(t.isMesh&&!t.isWater)if(t.material instanceof Array)for(const i of t.material)void 0===i.userData.originalOpacity&&(i.userData.originalOpacity=i.opacity),i.opacity=i.userData.originalOpacity*e.alpha,i.transparent=i.opacity<=1;else void 0===t.material.userData.originalOpacity&&(t.material.userData.originalOpacity=t.material.opacity),t.material.opacity=t.material.userData.originalOpacity*e.alpha,t.material.transparent=t.material.opacity<=1}));const r=n.name+"-IconAssect",s=Ep.instance.defaultObjectTree.getItemByName(r),o=a.userData.icon,l=a.userData.setting;s&&s.update({name:r,isVisible:a.visible,transform:{position:{x:l.iconSetting.transformNode.position.x,y:l.iconSetting.transformNode.position.y,z:l.iconSetting.transformNode.position.z},scale:l.iconSetting.transformNode.scale},param:{background:"",backgroundColor:"",height:128,width:128,offsetH:.5,offsetV:0,path:o,minDistance:l.visibleSetting.iconNear,maxDistance:l.visibleSetting.iconFar,polygonOffset:!1,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,sizeAttenuation:!1,iconScale:e.iconScale},textParam:{background:l.iconSetting.textParam.background,color:l.iconSetting.textParam.color,enableItalic:l.iconSetting.textParam.enableItalic,enableText:l.iconSetting.textParam.enableText,fontBold:l.iconSetting.textParam.fontBold,fontFamily:l.iconSetting.textParam.fontFamily,fontSize:l.iconSetting.textParam.fontSize,textSize:l.iconSetting.textParam.textSize,offsetH:l.iconSetting.textParam.offsetH,offsetV:l.iconSetting.textParam.offsetV,text:e.labelText,fontWeight:l.iconSetting.textParam.fontWeight,hiddenDistance:l.iconSetting.textParam.hiddenDistance,minDistance:l.iconSetting.textParam.textNear,maxDistance:l.iconSetting.textParam.textFar,padding:l.iconSetting.textParam.padding,position:l.iconSetting.textParam.position,labelScale:e.labelScale},type:"IconAsset",parent:"objectTree",isCustom:!1},(e=>{Ep.defaultObjectTree.setModelTransform(r,{position:{x:l.iconSetting.transformNode.position.x,y:l.iconSetting.transformNode.position.y,z:l.iconSetting.transformNode.position.z},scale:l.iconSetting.transformNode.scale},(()=>{this.updateIconModelInterval(n),t&&t(1),i()}))}))}))}setIconModelTrail(e,t){const i=e.id+"/Line";let n=Ep.animationStore.findAnimation(i,"IconModelTrailMovingController");if(e.isRemove)return n&&Ep.animationStore.remove(n),void(t&&t(1));const a=Ep.defaultObjectTree.findItemByName(e.id),r=a.getGroup();n?n.set({modelItem:a,modelObject:r,duration:e.duration,position:e.position,isAutoRotation:e.isAutoRotation,trackStyle:e.trackStyle,trackDuration:e.trackDuration,trackWidth:e.trackWidth}):(n=new mb({name:i,modelItem:a,modelObject:r,duration:e.duration,position:e.position,isAutoRotation:e.isAutoRotation,trackStyle:e.trackStyle,trackDuration:e.trackDuration,trackWidth:e.trackWidth}),Ep.animationStore.add(n)),t&&t(1)}getIconModelInterval(e){if("string"==typeof e&&(e=Ep.instance.defaultObjectTree.getItemByName(e)),!e)return;const t=e.name+"-IconAssect",i=Ep.instance.defaultObjectTree.getItemByName(t);if(!i)return;const n=new Nv;n.expandByObject(e.getGroup());const a=new Ce;n.getCenter(a);const r=i.getGroup().position.clone().sub(a),s=new tt(a.clone(),r.clone().normalize()),o=new Ce;s.intersectBox(n,o);const l=i.getGroup().position.clone().sub(o);return l.isIn=n.containsPoint(i.getGroup().position),l}updateIconModelInterval(e){if("string"==typeof e&&(e=Ep.instance.defaultObjectTree.getItemByName(e)),!e)return;const t=e.name+"-IconAssect",i=Ep.instance.defaultObjectTree.getItemByName(t);if(!i)return;const n=e.getGroup(),a=n.userData.setting;void 0===n.userData.originalScale&&(n.userData.originalScale=n.scale.clone()),void 0===n.userData.originalRotation&&(n.userData.originalRotation=n.rotation.clone());const r=a.iconSetting.transformNode.interval;if(!r)return;const s=(new Ce).copy(r),o=s.length(),l=n.scale.clone().divide(n.userData.originalScale);s.multiply(l).setLength(o);const c=(new Ce).copy(n.rotation),h=(new Ce).copy(n.userData.originalRotation),u=n.rotation.clone();s.applyEuler(u.setFromVector3(c.sub(h))).setLength(o);const d=s.clone();r.isIn&&d.negate();const p=new Nv;p.expandByObject(e.getGroup());const m=new Ce;p.getCenter(m);const f=new tt(m.clone(),d.clone().normalize()),g=new Ce;f.intersectBox(p,g),i.getGroup().position.copy(g.add(s))}setModelMaterial(e,t){if(!e.texture)return void(t&&t({result:0,message:`失败，纹理文件参数 ${e.texture} 错误。`}));const i=Ep.defaultObjectTree.getItemByName(e.id);if(!i)return void(t&&t({result:0,message:`失败，模型 ${e.id} 不存在。`}));const n=i.findNode(e.nodeId);if(!n)return void(t&&t({result:0,message:`失败，模型节点 ${e.nodeId} 不存在。`}));let a=Ep.customTextureStore.findByDisplayName(e.texture);if(a||(a=Ep.textureStore.find(e.texture)),a){const e=new we(a.textureSource);if(e.name=a.name,e.encoding=3001,e.flipY=!1,e.format=1022,e.version=10,e.wrapS=a._wrapS,e.wrapT=a._wrapT,Array.isArray(n.material))for(const t of n.material)t.map=e,t.needsUpdate=!0;else n.material.map=e,n.material.needsUpdate=!0;t&&t({result:1,message:"成功。"})}else Ep.cacheStore.load({path:e.texture,type:"texture",onLoad:i=>{if(i){if(i.version=i.version||1,i.flipY=!1,Array.isArray(n.material))for(const e of n.material)e.map=i,e.needsUpdate=!0;else n.material.map=i,n.material.needsUpdate=!0;t&&t({result:1,message:"成功。"})}else t&&t({result:0,message:`失败，纹理文件 ${e.texture} 获取失败。`})}})}highlightModel(e,t=!0){const i=Ep.defaultObjectTree.getItemByName(e);if(!i)return!1;if(Ep.effectStore.highlightObject(i.getGroup(),t),i.isIconModel){const t=Ep.defaultObjectTree.getItemByName(e+"-IconAssect");t&&t.highlight()}return!0}cancleHighlightModel(e,t){if(void 0!==t){if("BuildingItem"===t.type){const e=Ep.instance.defaultObjectTree.getItemByName(t.name);Ep.effectStore.cancleHighlightObject(e.getGroup())}if("BuildingFloorItem"===t.type){const e=Ep.instance.defaultObjectTree.getItemByName(t.buildingName);for(const i of e.children)if("BuildingFloorItem"===i.type&&i.name==t.name){Ep.effectStore.cancleHighlightObject(i.getGroup());break}}if("BuildingRoomItem"===t.type){const e=Ep.instance.defaultObjectTree.getItemByName(t.buildingName);for(const i of e.children)if("BuildingFloorItem"===i.type&&i.name==t.floorName){for(const e of i.children)if("BuildingRoomItem"===e.type&&e.name===t.name){Ep.effectStore.cancleHighlightObject(e.getGroup());break}break}}if("node"===t.type){const e=Ep.defaultObjectTree.getItemByName(t.modelName);if(e){const i=_y.findModelItemNodeByName(e,t.nodeName);if(i){const e=i.getNodeMesh||i.getGroup;Ep.effectStore.cancleHighlightObject(e())}}}if("layer"===t.type){const e=Ep.defaultObjectTree.getItemByName(t.layerName);if(e){const i=e.children.find((e=>e.name===t.itemName));i instanceof $_?Ep.effectStore.cancleHighlightObject(i.getGroup()):i instanceof _b&&i.cancelHightLight()}}return}const i=Ep.defaultObjectTree.getItemByName(e);if(!i)return!1;if(Ep.effectStore.cancleHighlightObject(i.getGroup()),i.isIconModel){const t=Ep.defaultObjectTree.getItemByName(e+"-IconAssect");t&&t.cancleHighlight()}return!0}setModelTransform2(e,t){const i=Ep.defaultObjectTree.getItemByName(e.id);if(!i)return void(t&&t({result:0,message:`失败，模型 ${e.id} 不存在。`}));let n=Ep.animationStore.findNodeAnimation(i.getGroup(),bv.type);n&&Ep.animationStore.remove(n);const a=i.getGroup();void 0===a.userData.originalScale&&(a.userData.originalScale=a.scale.clone()),0===e.duration?(a.position.copy(e.position),a.rotation.copy(e.rotation),a.scale.copy(e.scale)):(n=new bv(i,e),Ep.animationStore.add(n)),t&&t({result:1,message:"成功。"})}setModelStyle(e,{nodeId:t,scale:i,isVisible:n,xRay:a,alpha:r,maskType:s,maskAlpha:o,maskColor:l,maskPicture:c,maskPictureScale:h,maskFlowSpeed:u,maskFlowDirection:p}){let m=Ep.defaultObjectTree.getItemByName(e);if(!m)return;let f,g=m.getGroup();if(!0==!!t&&g.traverse((e=>{e.name===t&&(g=e)})),"none"===s&&g.traverse((e=>{if(e.isMesh){if(void 0!==e.userData.material){let t=Ep.animationStore.findMaterialAnimation(e.material,nv.type);t&&Ep.animationStore.remove(t),e.material.dispose(),e.material=e.userData.material,e.userData.material=void 0}if(void 0!==e.userData.color){if(Array.isArray(e.userData.color))for(let t=0;t<e.userData.color.length;t++)e.material[t].color=e.userData.color[t];else e.material.color=e.userData.color;e.userData.color=void 0}}})),"color"===s&&(g.traverse((e=>{if(e.isMesh)if(Array.isArray(e.material)){if(void 0===e.userData.color){e.userData.color=[];for(const t of e.material)e.userData.color.push(t.color)}}else void 0===e.userData.color&&(e.userData.color=e.material.color)})),g.traverse((e=>{if(e.isMesh)if(Array.isArray(e.material))for(const t of e.material)t.color=new Qt(l);else e.material.color=new Qt(l)})),f=o),"picture"===s){let e=`texture/path/${c.toLowerCase()}.jpg`;g.traverse((t=>{if(!t.isMesh)return;if(void 0!==t.userData.defaultStyle)return;if(null!=t.userData.material){let e=Ep.animationStore.findMaterialAnimation(t.material,nv.type);e&&Ep.animationStore.remove(e),t.material.map&&t.material.map.dispose(),t.material.dispose()}null==t.userData.material&&(t.userData.material=t.material);let i=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,e));if(t.material=new Co({map:i,alphaMap:i}),i.wrapS=d,i.wrapT=d,void 0!==h&&(i.repeat.x=h,i.repeat.y=h),null!=u){t.material.map.wrapS=d,t.material.map.wrapT=d;let e=ge.degToRad(p),i=u*Math.cos(e),n=u*Math.sin(e);i=Math.round(100*i)/100,n=Math.round(100*n)/100;let a=0!==i,r=0!==n,s=Ep.animationStore.findMaterialAnimation(t.material,nv.type);if(s)s.enableU=a,s.enableV=r,s.uSpeed=i,s.vSpeed=n;else{let e=new nv(t.material,a,r,i,n);Ep.animationStore.add(e)}}})),f=o}void 0!==i&&(void 0===g.userData.originalScale&&(g.userData.originalScale=g.scale.clone()),g.scale.copy(g.userData.originalScale),g.scale.multiplyScalar(i)),void 0!==a&&g.traverse((e=>{if(e.isMesh)if(e.material instanceof Array)for(const t of e.material)t.depthTest="off"===a;else e.material.depthTest="off"===a})),void 0===r&&void 0===f||(void 0===r&&(r=1),void 0===f&&(f=1),f*=r,g.traverse((e=>{if(e.isMesh&&!e.isWater)if(e.material instanceof Array)for(const t of e.material)t.opacity=f,t.transparent=f<1;else e.material.opacity=f,e.material.transparent=f<1}))),null!=n&&(g.visible=!!n)}setModelArticulation(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i=Ep.instance.defaultObjectTree.getItemByName(e.id);i?(e.data&&e.data.forEach((n=>{let a=i.articulations.find((e=>e._name==n.articulation));if(a){let t;switch(n.type){case"float":t=Number(n.value);break;case"enum":t=n.value;break;case"bool":t=n.value&&"false"!==n.value.toString()}e.startEvent&&e.startEvent({id:n.articulation}),a.set(t,e.duration,(()=>{e.endEvent&&e.endEvent({id:n.articulation})}))}else t&&t({result:0,message:`找不到名称为${n.articulation}的模型关节！`})})),t&&t({result:1,message:"成功"})):t&&t({result:0,message:`找不到名称为${e.id}的模型！`})}selectModel(e,t){e&&Ep.selectControl.startSelect({type:e.type,modelType:e.modelType,selectType:"select",events:t})}endSelectModel(e){e&&Ep.selectControl.endSelect(e)}pickModel(e,t){e&&Ep.selectControl.startSelect({type:e.type,modelType:e.modelType,selectType:"pick",events:t})}endPickModel(e){e&&Ep.selectControl.endSelect(e)}clickModel(e,t,i){if(!e)return;let n;"model"===e.modelType&&(n="ModelItem"),"building"===e.modelType&&(n="BuildingItem"),"iconmodel"===e.modelType.toLowerCase()&&(n="iconModel");let a=Ep.scene.models.children.find((t=>t.name===e.id));if(a){let r=Ep.defaultObjectTree.findItemByObject3D(a)||{};if("iconModel"===n){if(!r.isIconModel)return void(t&&t({result:0,message:"模型id和模型类型不匹配！"}))}else if(r.getType()!==n)return void(t&&t({result:0,message:"模型id和模型类型不匹配！"}));if(!0===a.visible){e.selected?Ep.effectStore.highlightObject(a,!1):Ep.effectStore.cancleHighlightObject(a);let n={type:e.modelType,id:a.name,selected:e.selected};i&&i(n),t&&t({result:1,message:"成功。"})}else t&&t({result:0,message:"失败，模型未显示。"})}else t&&t({result:0,message:`模型${id}不存在！`})}clickModelType(e,t){if(!e)return;let i;"model"===e.modelType&&(i="ModelItem"),"building"===e.modelType&&(i="BuildingItem"),"iconModel"===e.modelType&&(i="iconModel");let n={type:e.modelType,selected:e.selected,data:[]},a=[];Ep.scene.models.children.forEach((t=>{let n=Ep.defaultObjectTree.findItemByObject3D(t)||{};if("iconModel"===i){if(!n.isIconModel)return}else if(n.getType()!==i)return;!0===t.visible&&(a.push(t),e.selected?Ep.effectStore.highlightObject(t,!0):Ep.effectStore.highlightObject())})),n={type:e.modelType,selected:e.selected,data:a.map((e=>({id:e.name})))},t&&t(n)}clearModelSelected(e){Ep.effectStore.highlightObject()}highlightBuilding(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i=Ep.instance.defaultObjectTree.getItemByName(e.id);i?("none"===e.type?Ep.effectStore.cancleHighlightObject(i.getGroup()):Ep.effectStore.highlightObject(i.getGroup(),!1),t&&t({result:1,message:"成功"})):t&&t({result:0,message:`建筑${e.id}不存在`})}highlightFloor(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i,n=Ep.instance.defaultObjectTree.getItemByName(e.id);n?"BuildingItem"===(Ep.instance.defaultObjectTree.findItemByObject3D(n.getGroup())||{}).getType()?(n.children.forEach((t=>{t.level===Number(e.floor)&&(i=t)})),i?("none"===e.type?Ep.effectStore.highlightObject():this.highlightNode(n.name,i.name,!1),t&&t({result:1,message:"成功"})):t&&t({result:0,message:`楼层号${e.floor}不存在`})):t&&t({result:0,message:"指定的对象非建筑"}):t&&t({result:0,message:`建筑${e.id}不存在`})}getBuildings(e,t){let i={result:1,message:"成功",buildings:[]};Ep.scene.models.children.forEach((e=>{if("BuildingItem"===(Ep.defaultObjectTree.findItemByObject3D(e)||{}).getType()){let t=Ep.instance.defaultObjectTree.getItemByName(e.name),n={id:e.name,floors:[]};t.children.forEach((e=>{if("BuildingFloorItem"===e.type){const t={num:e.level,rooms:[]};n.floors.push(t);for(const i of e.children)"BuildingRoomItem"===i.type&&t.rooms.push({name:i.name})}})),i.buildings.push(n)}})),t&&t(i)}highlightNode(e,t,i){if(!Ep.scene)return void logger.debug("_context.scene 为空");if(!e)return Ep.effectStore.highlightObject(void 0),!1;if(!Ep.instance.defaultObjectTree.getItemByName(e))return;let n=Ep.instance.defaultObjectTree.getItemByName(e).getGroup();if(null==t)return n?(Ep.effectStore.highlightObject(n,i),!0):(Ep.effectStore.highlightObject(void 0),!1);if(n&&n instanceof Et){let e;if(n.traverse((function(i){i.name===t&&(e=i)})),e)return Ep.effectStore.highlightObject(e,i),!0}}setModelRotationState(e,t){if(!e)return;const i=Ep.defaultObjectTree.getItemByName(e.id).getGroup();let n=Ep.animationStore.findNodeAnimation(i,Sv.type);n?("stop"==e.state?(n.reset(),Ep.animationStore.remove(n)):"pause"==e.state?n.pause():"continue"==e.state&&n.resume(),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"动画未执行"})}blinkingModel(e){const t=Ep.defaultObjectTree.getItemByName(e.id).getGroup();let i=Ep.animationStore.findNodeAnimation(t,_v.type);i&&(i.reset(),Ep.animationStore.remove(i)),i=new _v(t,e.duration,e.color,e.type),Ep.animationStore.add(i)}setModelBlinkState(e,t){const i=Ep.defaultObjectTree.getItemByName(e.id).getGroup();let n=Ep.animationStore.findNodeAnimation(i,_v.type);n?("stop"==e.state?(n.reset(),Ep.animationStore.remove(n)):"pause"==e.state?n.pause():"continue"==e.state&&n.resume(),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"动画未执行"})}movingModel(e){e&&Ep.scene.models.traverse((t=>{if(t.name===e.id){let i=Ep.animationStore.findNodeAnimation(t,wv.type);i&&(i.reset(),Ep.animationStore.remove(i)),i=new wv(t,e.loopMode,e.reverse,e.direction,e.points,e.offset),Ep.animationStore.add(i)}}))}setModelMoveState(e,t){e&&Ep.scene.models.traverse((i=>{if(i.name===e.id){let n=Ep.animationStore.findNodeAnimation(i,wv.type);n?("stop"==e.state?(n.reset(),Ep.animationStore.remove(n)):"pause"==e.state?n.pause():"continue"==e.state&&n.resume(),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"动画未执行"})}}))}pathingModel(e){if(!e)return;e.points.forEach((t=>{t.speed=e.speed}));const t=Ep.defaultObjectTree.getItemByName(e.id);if(!t)return;const i=t.getGroup();let n=Ep.animationStore.findNodeAnimation(i,wv.type);n&&(n.reset(),Ep.animationStore.remove(n)),n=new wv(i,e.loopMode,e.reverse,e.direction,e.points,e.offset,e.pathId,e.passChange),Ep.animationStore.add(n)}updatePathingModel(e,t,i){Ep.animationStore.findAnimationByPathId(e,wv.type).forEach((n=>{n.reset();let a=n.points[0].speed;t.forEach((e=>{e.speed=a}));let r=new wv(n.animationObject,n.loopMode,n.reverse,n.direction,t,n.offset,e,i);Ep.animationStore.add(r),Ep.animationStore.remove(n)}))}deletePathingModel(e){Ep.animationStore.findAnimationByPathId(e,wv.type).forEach((e=>{e.reset(),Ep.animationStore.remove(e)}))}setModelPathingState(e,t){const i=Ep.defaultObjectTree.getItemByName(e.id).getGroup();let n=Ep.animationStore.findNodeAnimation(i,wv.type);n?("stop"==e.state?(n.reset(),Ep.animationStore.remove(n),e.passChange&&e.passChange({id:n.pathId,pass:0,ratio:0})):"pause"==e.state?n.pause():"continue"==e.state&&n.resume(),t&&t({result:1,message:"成功。"})):t&&t({result:0,message:"动画未执行"})}getModelArticulation(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i=Ep.instance.defaultObjectTree.getItemByName(e.id);if(!i)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=[];i.articulations.forEach((e=>{let t={};switch(t.articulation=e.name,t.currentValue=e.value,e.type){case"numeric":t.type="float",t.minValue=Math.min(...e._values),t.maxValue=Math.max(...e._values);break;case"boolean":t.type="bool";break;case"enum":t.type="enum",t.value=[...e._values];break;case"text":t.type="string"}n.push(t)})),t&&t({result:1,message:"成功",id:e.id,data:n})}getModelAnimation(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i=Ep.instance.defaultObjectTree.getItemByName(e.id);if(!i)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=[];i.articulationAnimations.forEach((e=>{let t={};t.name=e.animationName,t.speed=e.animationSpeed,t.rerverserType=e.animationType;let a=Ep.animationStore.findAnimation(i.name+e.animationName,cv.type);a?a.getIsPaused()?t.state="pause":t.state="playing":t.state="stop",n.push(t)})),n.length<=0?t&&t({result:0,message:"失败，模型没有动画。"}):t&&t({result:1,message:"成功",id:e.id,data:n})}playModelAnimation(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i=Ep.instance.defaultObjectTree.getItemByName(e.id);if(!i)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=i.articulationAnimations.find((t=>t.animationName===e.name));if(n)switch(e.state.toLocaleLowerCase()){case"begin":e.startEvent&&e.startEvent({id:e.id}),i.playArticulationAnimation(n.animationName,(t=>{!0===t.isEnd&&e.endEvent&&e.endEvent({id:e.id})})),t&&t({result:1,message:"成功"});break;case"pause":i.pauseArticulationAnimation(n.animationName),t&&t({result:1,message:"成功"});break;case"restart":i.resetArticulationAnimation(n.animationName),e.endEvent&&e.endEvent({id:e.id}),e.startEvent&&e.startEvent({id:e.id}),i.playArticulationAnimation(n.animationName,(t=>{!0===t.isEnd&&e.endEvent&&e.endEvent({id:e.id})}));break;case"stop":i.resetArticulationAnimation(n.animationName),e.endEvent&&e.endEvent({id:e.id}),t&&t({result:1,message:"成功"});break;default:t&&t({result:1,message:"成功"})}else t&&t({result:0,message:`找不到名称为${e.id}的模型动画！`})}setModelAnimation(e,t){if(!e)return void(t&&t({result:0,message:"参数错误"}));let i=Ep.instance.defaultObjectTree.getItemByName(e.id);if(!i)return void(t&&t({result:0,message:`找不到名称为${e.id}的模型！`}));let n=i.articulationAnimations.find((t=>t.animationName===e.name));n?Number(e.speed)<=0||!["none","round","repeat"].includes(e.rerverserType.toLowerCase())?t&&t({result:0,message:"参数异常!"}):(n.animationSpeed=Number(e.speed),n.animationType=e.rerverserType,t&&t({result:1,message:"成功"})):t&&t({result:0,message:`找不到名称为${e.id}的模型动画！`})}getModelType(e,t){const i=[];Ep.instance.defaultObjectTree.children.forEach((e=>{e.formApi||i.push(e.name)})),t&&t({result:1,message:"成功。",modelType:i})}addModelForApi(e,t){let i,n=!1;if(Ep.instance.defaultObjectTree.children.forEach((t=>{t.name===e.id&&(n=!0),t.name===e.modelType&&(i=t)})),n)return void(t&&t({result:0,message:`模型${e.id}已经存在！`}));if(!i)return void(t&&t({result:0,message:`模型${e.modelType}不存在！`}));if(i.formApi)return void(t&&t({result:0,message:`模型${e.modelType}非可添加类型！`}));e.opacity="number"==typeof e.alpha&&e.alpha>=0&&e.alpha<=1?e.alpha:1;let a=Ep.scene.models.children.find((t=>t.name==e.modelType));a||t&&t({result:1,message:`添加失败,未找到modelType为${e.modelType}的模型`});let r=a.clone();r.name=e.id,r.position.setScalar(0),r.visible=!0,r.activeVisible=!0,r.traverse((t=>{if("Mesh"==t.type)if(t.geometry=t.geometry.clone(),t.material instanceof Array){t.material=t.material.map((e=>e.clone()));for(let i of t.material)i.opacity=e.opacity,i.transparent=e.opacity<1}else t.material=t.material.clone(),t.material.opacity=e.opacity,t.material.transparent=e.opacity<1}));const s=new sr;if(s.name=e.id,s.userData.originalScale=s.scale.clone(),s.visible=e.visible,void 0!==s.visible&&null!==s.visible||(s.visible=!0),s.activeVisible=s.visible,s.add(r),s.userData.isAddForApi=!0,e.titleText){let t=new sr;t.name=e.id+"title";let i=_E.createWord(t,{textParam:{text:e.titleText,textSize:e.titleFontSize,color:e.titleColor,background:e.titleBackgroundColor,offsetV:.5,offsetH:.5},param:{sizeAttenuation:!1}});i.name=e.id,i.renderOrder=Fy+("number"==typeof e.zLevel?e.zLevel:0),s.add(t);const n=new Re;n.expandByObject(r);const a=new Ce;n.getSize(a),t.position.y=a.y;const o=t.updateMatrix;t.updateMatrix=function(){this.scale.set(1/this.parent.scale.x,1/this.parent.scale.y,1/this.parent.scale.z),o.call(this)}}Ep.scene.models.add(s);let o=_y.cloneDeep(i.getSettings());if(o.name=e.id,o.loadModel=s,"ModelItem"==i.type){const e=new $_(o);Ep.instance.defaultObjectTree.addItem(e),_y.setArticulation(o,e)}if("IconAsset"==i.type&&new yb(o,null),"GroupItem"==i.type){let e=new Sb(o);o.children.forEach((t=>{switch(t.type){case"IconAsset":new yb(t,e);break;case"ModelAsset":let i={name:t.name,gltf:{scene:o.loadModel},transform:t.transform,points:t.points,matrix:t.matrix},n=e.children.find((e=>e.name===i.name));n?n.restoreInstanceFromMatrix(i.matrix):e.childrenAdd(new X_(i,e))}}))}"BuildingItem"==i.type&&Ep.instance.defaultObjectTree.addBuilding(o),Ep.instance.defaultObjectTree.children.find((t=>t.name===e.id)).formApi=!0,s.position.set(e.position.x,e.position.y,e.position.z),s.rotation.set(ge.degToRad(e.rotation.x),ge.degToRad(e.rotation.y),ge.degToRad(e.rotation.z)),s.scale.set(e.scale.x,e.scale.y,e.scale.z),Ep.instance.nextRender((()=>{t&&t({result:1,message:"成功。"})}))}removeModelForApi(e,t){let i=Ep.instance.defaultObjectTree.children.find((t=>t.name===e.id));if(!i)return void(t&&t({result:0,message:`模型${e.id}不存在！`}));if(!i.formApi)return void(t&&t({result:0,message:"非接口添加不能删除！"}));let n=Ep.scene.models.children.find((t=>t.name==e.id));if(n&&_y.disposeThreeObject(n),Ep.instance.defaultObjectTree.removeItem(e.id),Ep.instance.defaultObjectTree.removeAsset(e.id),Ep.transformControls.object===n&&Ep.transformControls.detach(),!0===i.isIconModel)return e.id+="-IconAssect",void this.removeModelForApi(e,t);t&&t({result:1,message:"成功。"})}};function wE(e,t,i){function n(e){return new Promise((function(t){Ep.loaders.textureLoader.load(e,(function(e){t(e)}))}))}function a(e){e.traverse((function(e){!0===e.isMesh&&!0===e.isSprite&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach((function(e){e.dispose(),e.map&&e.map.dispose()})):(e.material.dispose(),e.material.map&&e.material.map.dispose()));const t=Ep.animationStore.findAnimation(e.uuid,yy);t&&Ep.animationStore.remove(t)}))}function r(e,t){e.traverse((function(e){if(!0===e.isMesh||!0===e.isSprite){if(!Array.isArray(e.material))return void 0===e.userData.transparent&&(e.userData.transparent=e.material.transparent),void(t<1?(e.material.transparent=!0,e.material.opacity=t):(e.material.transparent=e.userData.transparent,e.material.opacity=t));if(void 0===e.userData.transparent){e.userData.transparent={};for(const t of e.material)e.userData.transparent[t.uuid]=t.transparent}if(t<1)for(const i of e.material)i.transparent=!0,i.opacity=t;else for(const i of e.material)i.transparent=e.userData.transparent[i.uuid],i.opacity=t}}))}function s(){const{modelType:i}=t,n=Ep.defaultObjectTree.getItemByName(i).getGroup().clone();n.name=e,n.position.setScalar(0),n.userData.modelType=i;const{rotation:a}=t,r=ge.degToRad(a.x),s=ge.degToRad(a.y),o=ge.degToRad(a.z);n.rotation.set(r,s,o);const{scale:l}=t;void 0===n.userData.originalScale&&(n.userData.originalScale=n.scale.clone()),n.scale.x=n.userData.originalScale.x*l,n.scale.y=n.userData.originalScale.y*l,n.scale.z=n.userData.originalScale.z*l;const{modelMaxDistance:c}=t;return n.enableAutoHidebyDistance=!0,n.minDistance=0,n.maxDistance=c*Ep.worldScale,Ep.animationStore.addDistance(n.uuid,yy,Ep.camera,n),n}async function o(){const{iconAssetName:i}=t,n=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===i)),a=JSON.parse(JSON.stringify(n));a.transform.position.x=0,a.transform.position.y=0,a.transform.position.z=0;const{labelText:r,labelColor:s,labelBackground:o}=t;a.textParam.enableText=!!r,a.textParam.text=r,a.textParam.color=s,a.textParam.background=o;const l=new sr,c=await function(e,t){return new Promise((function(i){new yb(e,t,(function(e,t){i(t)}))}))}(a,l),h=l.children[0];h.name=e,h.userData.iconItem=c;for(const t of h.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;const{modelMaxDistance:u,iconMaxDistance:d}=t;return h.enableAutoHidebyDistance=!0,h.minDistance=u*Ep.worldScale,h.maxDistance=d*Ep.worldScale,Ep.animationStore.addDistance(h.uuid,yy,Ep.camera,h),h}async function l(){const i=new sr;i.name=e;let a=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(a=!1);const{iconBackground:r}=t;if(r){const s="texture/iconBackground/"+r+".png",o=_y.url(Ep.instance.resourceBasePath,s),l=await n(o),{iconBackgroundColor:c,sizeAttenuation:h,polygonOffset:u,polygonOffsetFactor:d,polygonOffsetUnits:p}=t,m=new vr({alphaTest:.1,transparent:!0,fog:Uy,depthWrite:a,depthTest:a,map:l,color:new Qt(c),sizeAttenuation:h,polygonOffset:u,polygonOffsetFactor:d,polygonOffsetUnits:p});if("rgba"===c.substring(0,4)){let e=c.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),m.opacity=e}const f=new Or(m);f.name=e,f.onBeforeRender=function(){this.userData.inView=!0};const{iconWidth:g,iconHeight:y,iconScale:v=1}=t,b=h?g/30:g/3e3,_=h?y/30:y/3e3;f.scale.set(b*v,_*v,1);const{iconXOffset:x,iconYOffset:w,factor:S=-.1}=t,M=x/30*S+.5,T=w/30*S+.5;f.center=new ye(M,T),f.userData.iconBackground=r,i.add(f)}else i.add(new sr);const{iconPath:s}=t,o=await n(s),{sizeAttenuation:l,polygonOffset:c,polygonOffsetFactor:h,polygonOffsetUnits:u}=t,d=new vr({alphaTest:.1,transparent:!0,color:new Qt("#ffffff"),fog:Uy,depthWrite:a,depthTest:a,map:o,sizeAttenuation:l,polygonOffset:c,polygonOffsetFactor:h,polygonOffsetUnits:u}),p=new Or(d);p.name=e,p.onBeforeRender=function(){this.userData.inView=!0};const{iconWidth:m,iconHeight:f,iconScale:g=1}=t,y=l?m/50:m/5e3,v=l?f/50:f/5e3;p.scale.set(y*g,v*g,1);const{iconXOffset:b,iconYOffset:_}=t;p.center.set(b,_),p.userData.iconPath=s,i.add(p);const{enableLabel:x}=t;if(x){const{labelCanvas:n,labelAlignment:r,labelXOffset:s,labelYOffset:o}=t,c={enableText:x,canvas:n,sizeAttenuation:l,labelAlignment:r,offsetV:s,offsetH:o*g},h=_E.createText_Billboard(i,c);h.name=e,h.material.depthWrite=a,h.material.depthTest=a}else i.add(new sr);const{modelMaxDistance:w,iconMaxDistance:S}=t;return i.enableAutoHidebyDistance=!0,i.minDistance=w*Ep.worldScale,i.maxDistance=S*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i),i}async function c(i){const{useIconAsset:r}=t;!0===r?void 0!==i.userData.iconItem?i=function(i){const{iconAssetName:n}=t,a=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===n)),r=JSON.parse(JSON.stringify(a));r.transform.position.x=0,r.transform.position.y=0,r.transform.position.z=0;const{labelText:s,labelColor:o,labelBackground:l}=t;r.textParam.enableText=!!s,r.textParam.text=s,r.textParam.color=o,r.textParam.background=l,i.userData.iconItem.update(r,void 0,!1),i.name=e;for(const t of i.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;const{modelMaxDistance:c,iconMaxDistance:h}=t;return i.minDistance=c*Ep.worldScale,i.maxDistance=h*Ep.worldScale,i}(i):(a(i),(i=await o()).enableAutoHidebyDistance=!0,i.minDistance=0,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i)):void 0===i.userData.iconItem?i=await async function(i){let r=i.children[0],s=i.children[1],o=i.children[2],l=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(l=!1);const{iconBackground:c}=t;if(c){if(!0!==r.isSprite){const t=new vr({alphaTest:.1,transparent:!0,fog:Uy});r=new Or(t),r.name=e}if(r.userData.iconBackground!==c){const e="texture/iconBackground/"+c+".png",t=_y.url(Ep.instance.resourceBasePath,e),i=await n(t);r.material.map.dispose(),r.material.map=i}r.material.depthWrite=l,r.material.depthTest=l;const{iconBackgroundColor:i,sizeAttenuation:a,polygonOffset:s,polygonOffsetFactor:o,polygonOffsetUnits:h}=t;if(r.material.color=new Qt(i),r.material.sizeAttenuation=a,r.material.polygonOffset=s,r.material.polygonOffsetFactor=o,r.material.polygonOffsetUnits=h,"rgba"===i.substring(0,4)){let e=i.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),r.material.opacity=e}const{iconWidth:u,iconHeight:d,iconScale:p=1}=t,m=a?u/30:u/3e3,f=a?d/30:d/3e3;r.scale.set(m*p,f*p,1);const{iconXOffset:g,iconYOffset:y,factor:v=-.1}=t,b=g/30*v+.5,_=y/30*v+.5;r.center=new ye(b,_)}else a(r),r=new sr;const{iconPath:h}=t;if(s.userData.iconPath!==h){const e=await n(h);s.material.map.dispose(),s.material.map=e}s.material.depthWrite=l,s.material.depthTest=l;const{sizeAttenuation:u,polygonOffset:d,polygonOffsetFactor:p,polygonOffsetUnits:m}=t;s.material.sizeAttenuation=u,s.material.polygonOffset=d,s.material.polygonOffsetFactor=p,s.material.polygonOffsetUnits=m;const{iconWidth:f,iconHeight:g,iconScale:y=1}=t,v=u?f/50:f/5e3,b=u?g/50:g/5e3;s.scale.set(v*y,b*y,1);const{iconXOffset:_,iconYOffset:x}=t;s.center.set(_,x);const{enableLabel:w}=t;if(a(o),w){const{labelCanvas:i,labelAlignment:n,labelXOffset:a,labelYOffset:r}=t,c={enableText:w,canvas:i,sizeAttenuation:u,labelAlignment:n,offsetV:a,offsetH:r*y},h=new sr;h.children[1]=s,o=_E.createText_Billboard(h,c),o.name=e,o.material.depthWrite=l,o.material.depthTest=l}else o=new sr;i.clear(),i.add(r),i.add(s),i.add(o);const{modelMaxDistance:S,iconMaxDistance:M}=t;return i.minDistance=S*Ep.worldScale,i.maxDistance=M*Ep.worldScale,i}(i):(a(i),(i=await l()).enableAutoHidebyDistance=!0,i.minDistance=0,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i)),i.activeVisible=!0;const{iconMaxDistance:s}=t;return i.maxDistance=s*Ep.worldScale,i}return{create:async function(){const n=function(){Ep.objectStore.remove(e);const i=new sr;i.name=e;const{renderOrder:n,scale:a}=t;i.renderOrder=Fy+n;const{isShow:r}=t;i.visible=!!r,i.activeVisible=!!r;const{enableAutoHidebyDistance:s,minDistance:o,maxDistance:l}=t;i.enableAutoHidebyDistance=!!s,i.minDistance=o*Ep.worldScale,i.maxDistance=l*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i);let{position:c}=t;return i.position.set(c.x,c.y,c.z),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(i.rotation.order="YXZ",i.rotation.y=(c.lon+90)/180*Math.PI,i.rotation.x=(90-c.lat)/180*Math.PI),i}(),a=s(),c=await async function(){let e=null;const{useIconAsset:i}=t;e=!0===i?await o():await l(),e.activeVisible=!0;const{modelMaxDistance:n,iconMaxDistance:a}=t;return e.enableAutoHidebyDistance=!0,e.minDistance=n*Ep.worldScale,e.maxDistance=a*Ep.worldScale,Ep.animationStore.addDistance(e.uuid,yy,Ep.camera,e),e}();if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){const e=new fv(c,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR);Ep.drawableDepthTest?e.resume():e.pause(),Ep.animationStore.add(e)}n.add(a),n.add(c);const{alpha:h}=t;r(n,h),Ep.objectStore.add(e,n),i&&i(1)},update:async function(){const n=Ep.objectStore.find(e);if(void 0===n)return void(i&&i(0));!function(e){const{renderOrder:i,scale:n}=t;e.renderOrder=Fy+i;const{isShow:a}=t;e.visible=!!a,e.activeVisible=!!a;const{enableAutoHidebyDistance:r,minDistance:s,maxDistance:o}=t;e.enableAutoHidebyDistance=!!r,e.minDistance=s*Ep.worldScale,e.maxDistance=o*Ep.worldScale;let{position:l}=t;e.position.set(l.x,l.y,l.z)}(n);const o=function(e){const{modelType:i}=t;if(e.userData.modelType!==i)a(e),e=s();else{const{rotation:i}=t,n=ge.degToRad(i.x),a=ge.degToRad(i.y),r=ge.degToRad(i.z);e.rotation.set(n,a,r);const{scale:s}=t;void 0===e.userData.originalScale&&(e.userData.originalScale=e.scale.clone()),e.scale.x=e.userData.originalScale.x*s,e.scale.y=e.userData.originalScale.y*s,e.scale.z=e.userData.originalScale.z*s;const{modelMaxDistance:o}=t;e.maxDistance=o*Ep.worldScale}return e}(n.children[0]),l=await c(n.children[1]);n.clear(),n.add(o),n.add(l);const{alpha:h}=t;r(n,h),i&&i(1)}}}var SE=new class{addModelLandmark(e,t,i){wE(...arguments).create()}updateModelLandmark(e,t,i){wE(...arguments).update()}setModelLandmarkHighlight(e,t){const i=Ep.objectStore.find(e);if(void 0===i)return void(callback&&callback(0));const n=i.children[1];if(!1===t){if(Ep.effectStore.cancleHighlightObject(i.children[0]),void 0!==n.children[3]){let e=n.children[3];e.material.map.dispose(),e.material.dispose(),e.geometry.dispose(),n.remove(e)}}else if(Ep.effectStore.highlightObject(i.children[0],!0),void 0===n.children[3]){const t="texture/ui/highlight-landmark.png",i=n.children[1],a=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,t)),r=new vr({map:a,color:16777215,fog:!1,sizeAttenuation:i.material.sizeAttenuation,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest}),s=new Or(r);s.name=e+"_selector",s.position.set(i.position.x,i.position.y,i.position.z),s.scale.set(.02304/n.scale.x,.02304/n.scale.y,1),s.center=new ye(.5,.5),n.add(s)}}};function ME(e,t,i){function n(e){return new Promise((function(t){Ep.loaders.textureLoader.load(e,(function(e){t(e)}))}))}function a(e){e.traverse((function(e){!0===e.isMesh&&!0===e.isSprite&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach((function(e){e.dispose(),e.map&&e.map.dispose()})):(e.material.dispose(),e.material.map&&e.material.map.dispose()));const t=Ep.animationStore.findAnimation(e.uuid,yy);t&&Ep.animationStore.remove(t)}))}function r(){const{modelType:i}=t,n=Ep.defaultObjectTree.getItemByName(i).getGroup().clone();n.position.setScalar(0),n.userData.modelType=i,n.traverse((function(t){t.onBeforeRender=function(){this.userData.inView=!0},t.name=e}));const{rotation:a}=t,r=ge.degToRad(a.x),s=ge.degToRad(a.y),o=ge.degToRad(a.z);n.rotation.set(r,s,o);const{scale:l}=t;void 0===n.userData.originalScale&&(n.userData.originalScale=n.scale.clone()),n.scale.x=n.userData.originalScale.x*l,n.scale.y=n.userData.originalScale.y*l,n.scale.z=n.userData.originalScale.z*l;const{modelMaxDistance:c}=t;return n.enableAutoHidebyDistance=!0,n.minDistance=0,n.maxDistance=c*Ep.worldScale,Ep.animationStore.addDistance(n.uuid,yy,Ep.camera,n),n}async function s(){const{iconAssetName:i}=t,n=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===i)),a=JSON.parse(JSON.stringify(n));a.transform.position.x=0,a.transform.position.y=0,a.transform.position.z=0;const{labelText:r,labelColor:s,labelBackground:o}=t;a.textParam.enableText=!!r,a.textParam.text=r,a.textParam.color=s,a.textParam.background=o;const l=new sr,c=await function(e,t){return new Promise((function(i){new yb(e,t,(function(e,t){i(t)}))}))}(a,l),h=l.children[0];h.name=e,h.userData.iconItem=c;for(const t of h.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;const{modelMaxDistance:u,iconMaxDistance:d}=t;return h.enableAutoHidebyDistance=!0,h.minDistance=u*Ep.worldScale,h.maxDistance=d*Ep.worldScale,Ep.animationStore.addDistance(h.uuid,yy,Ep.camera,h),h}async function o(){const i=new sr;i.name=e;let a=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(a=!1);const{iconBackground:r}=t;if(r){const s="texture/iconBackground/"+r+".png",o=_y.url(Ep.instance.resourceBasePath,s),l=await n(o),{iconBackgroundColor:c,sizeAttenuation:h,polygonOffset:u,polygonOffsetFactor:d,polygonOffsetUnits:p}=t,m=new vr({alphaTest:.1,transparent:!0,fog:Uy,depthWrite:a,depthTest:a,map:l,color:new Qt(c),sizeAttenuation:h,polygonOffset:u,polygonOffsetFactor:d,polygonOffsetUnits:p});if("rgba"===c.substring(0,4)){let e=c.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),m.opacity=e}const f=new Or(m);f.name=e,f.onBeforeRender=function(){this.userData.inView=!0};const{iconWidth:g,iconHeight:y,iconScale:v=1}=t,b=h?g/30:g/3e3,_=h?y/30:y/3e3;f.scale.set(b*v,_*v,1);const{iconXOffset:x,iconYOffset:w,factor:S=-.1}=t,M=x/30*S+.5,T=w/30*S+.5;f.center=new ye(M,T),f.userData.iconBackground=r,i.add(f)}else i.add(new sr);const{iconPath:s}=t,o=await n(s),{sizeAttenuation:l,polygonOffset:c,polygonOffsetFactor:h,polygonOffsetUnits:u}=t,d=new vr({alphaTest:.1,transparent:!0,color:new Qt("#ffffff"),fog:Uy,depthWrite:a,depthTest:a,map:o,sizeAttenuation:l,polygonOffset:c,polygonOffsetFactor:h,polygonOffsetUnits:u}),p=new Or(d);p.name=e,p.onBeforeRender=function(){this.userData.inView=!0};const{iconWidth:m,iconHeight:f,iconScale:g=1}=t,y=l?m/50:m/5e3,v=l?f/50:f/5e3;p.scale.set(y*g,v*g,1);const{iconXOffset:b,iconYOffset:_}=t;p.center.set(b,_),p.userData.iconPath=s,i.add(p);const{enableLabel:x}=t;if(x){const{labelCanvas:n,labelAlignment:r,labelXOffset:s,labelYOffset:o}=t,c={enableText:x,canvas:n,sizeAttenuation:l,labelAlignment:r,offsetV:s,offsetH:o*g},h=_E.createText_Billboard(i,c);h.name=e,h.material.depthWrite=a,h.material.depthTest=a}else i.add(new sr);const{modelMaxDistance:w,iconMaxDistance:S}=t;return i.enableAutoHidebyDistance=!0,i.minDistance=w*Ep.worldScale,i.maxDistance=S*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i),i}async function l(i){const{useIconAsset:r}=t;if(!0===r){if(void 0!==i.userData.iconItem)return i=function(i){const{iconAssetName:n}=t,a=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===n)),r=JSON.parse(JSON.stringify(a));r.transform.position.x=0,r.transform.position.y=0,r.transform.position.z=0;const{labelText:s,labelColor:o,labelBackground:l}=t;r.textParam.enableText=!!s,r.textParam.text=s,r.textParam.color=o,r.textParam.background=l,i.userData.iconItem.update(r,void 0,!1),i.name=e;for(const t of i.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;const{modelMaxDistance:c,iconMaxDistance:h}=t;return i.minDistance=c*Ep.worldScale,i.maxDistance=h*Ep.worldScale,i}(i);a(i);return await s()}if(void 0===i.userData.iconItem)return i=await async function(i){let r=i.children[0],s=i.children[1],o=i.children[2],l=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(l=!1);const{iconBackground:c}=t;if(c){if(!0!==r.isSprite){const t=new vr({alphaTest:.1,transparent:!0,fog:Uy});r=new Or(t),r.name=e}if(r.userData.iconBackground!==c){const e="texture/iconBackground/"+c+".png",t=_y.url(Ep.instance.resourceBasePath,e),i=await n(t);r.material.map.dispose(),r.material.map=i}r.material.depthWrite=l,r.material.depthTest=l;const{iconBackgroundColor:i,sizeAttenuation:a,polygonOffset:s,polygonOffsetFactor:o,polygonOffsetUnits:h}=t;if(r.material.color=new Qt(i),r.material.sizeAttenuation=a,r.material.polygonOffset=s,r.material.polygonOffsetFactor=o,r.material.polygonOffsetUnits=h,"rgba"===i.substring(0,4)){let e=i.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),r.material.opacity=e}const{iconWidth:u,iconHeight:d,iconScale:p=1}=t,m=a?u/30:u/3e3,f=a?d/30:d/3e3;r.scale.set(m*p,f*p,1);const{iconXOffset:g,iconYOffset:y,factor:v=-.1}=t,b=g/30*v+.5,_=y/30*v+.5;r.center=new ye(b,_)}else a(r),r=new sr;const{iconPath:h}=t;if(s.userData.iconPath!==h){const e=await n(h);s.material.map.dispose(),s.material.map=e}s.material.depthWrite=l,s.material.depthTest=l;const{sizeAttenuation:u,polygonOffset:d,polygonOffsetFactor:p,polygonOffsetUnits:m}=t;s.material.sizeAttenuation=u,s.material.polygonOffset=d,s.material.polygonOffsetFactor=p,s.material.polygonOffsetUnits=m;const{iconWidth:f,iconHeight:g,iconScale:y=1}=t,v=u?f/50:f/5e3,b=u?g/50:g/5e3;s.scale.set(v*y,b*y,1);const{iconXOffset:_,iconYOffset:x}=t;s.center.set(_,x);const{enableLabel:w}=t;if(a(o),w){const{labelCanvas:i,labelAlignment:n,labelXOffset:a,labelYOffset:r}=t,c={enableText:w,canvas:i,sizeAttenuation:u,labelAlignment:n,offsetV:a,offsetH:r*y},h=new sr;h.children[1]=s,o=_E.createText_Billboard(h,c),o.name=e,o.material.depthWrite=l,o.material.depthTest=l}else o=new sr;i.clear(),i.add(r),i.add(s),i.add(o);const{modelMaxDistance:S,iconMaxDistance:M}=t;return i.minDistance=S*Ep.worldScale,i.maxDistance=M*Ep.worldScale,i}(i);a(i);return await o()}return{create:async function(){const a=function(){Ep.objectStore.remove(e);const i=new sr;i.name=e;const{renderOrder:n,scale:a}=t;i.renderOrder=Fy+n;const{isShow:r}=t;i.visible=!!r,i.activeVisible=!!r;const{enableAutoHidebyDistance:s,minDistance:o,maxDistance:l}=t;i.enableAutoHidebyDistance=!!s,i.minDistance=o*Ep.worldScale,i.maxDistance=l*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i);let{position:c}=t;return i.position.set(c.x,c.y,c.z),i}(),l=r(),c=await async function(){const{useIconAsset:e}=t;if(!0===e)return await s();return await o()}();if(c.activeVisible=!0,Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){const e=new fv(c,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR);Ep.drawableDepthTest?e.resume():e.pause(),Ep.animationStore.add(e)}await async function(i){const a=i.position;i.userData.startPos=a.clone(),i.userData.targetPos=a.clone(),Ep.baseCarrierController.add(e,i);const r=_y.url(Ep.instance.resourceBasePath,"texture/trail/trail.png"),s=await n(r);s.wrapS=m,s.wrapT=m,s.repeat.set(1,1);const{trailColor:o="#ff0000",trackWidth:l}=t,c=new ye(window.innerWidth,window.innerHeight),h=new lb.MeshLineMaterial({fog:Uy,map:s,useMap:!0,color:new Qt(o),opacity:1,resolution:c,sizeAttenuation:0,lineWidth:l*Ep.worldScale,depthWrite:Ep.drawableDepthTest,depthTest:!0,alphaTest:0,transparent:!0,side:2,repeat:new ye(1,1),dashArray:0,dashOffset:1,dashRatio:0}),u=new Ov.MeshLine;u.setPoints([a.x,a.y,a.z]);const d=new Fi(u,h);d.onBeforeRender=function(){this.userData.inView=!0},d.renderOrder=i.renderOrder;const{iconMaxDistance:p}=t;d.enableAutoHidebyDistance=!0,d.minDistance=0,d.maxDistance=p*Ep.worldScale,Ep.animationStore.addDistance(e+"Line",yy,Ep.camera,d);const{duration:f,trackDuration:g}=t;i.userData.mesh=d,i.userData.currentTime=0,i.userData.duration=f,i.userData.trailDuration=g,i.userData.moveComplete=!0;let y=Ep.animationStore.findLayerAnimation(e,Pv.type);y&&Ep.animationStore.remove(y);const v=new Dv(i);y=new Pv(Ep.baseCarrierController,v,e),Ep.animationStore.add(y),Ep.objectStore.add(e+"Line",d)}(a),a.add(l),a.add(c),Ep.objectStore.add(e,a),i&&i(1)},update:async function(){const n=Ep.objectStore.find(e);if(void 0===n)return void(i&&i(0));!function(e){const{renderOrder:i,scale:n}=t;e.renderOrder=Fy+i;const{isShow:a}=t;e.visible=!!a,e.activeVisible=!!a;const{enableAutoHidebyDistance:r,minDistance:s,maxDistance:o}=t;e.enableAutoHidebyDistance=!!r,e.minDistance=s*Ep.worldScale,e.maxDistance=o*Ep.worldScale}(n);const s=function(e){const{modelType:i}=t;if(e.userData.modelType!==i)a(e),e=r();else{const{rotation:i}=t,n=ge.degToRad(i.x),a=ge.degToRad(i.y),r=ge.degToRad(i.z);e.rotation.set(n,a,r);const{scale:s}=t;void 0===e.userData.originalScale&&(e.userData.originalScale=e.scale.clone()),e.scale.x=e.userData.originalScale.x*s,e.scale.y=e.userData.originalScale.y*s,e.scale.z=e.userData.originalScale.z*s;const{modelMaxDistance:o}=t;e.maxDistance=o*Ep.worldScale}return e}(n.children[0]),o=await l(n.children[1]);o.activeVisible=!0,async function(e){e.userData.currentTime=0,e.userData.startPos=e.position.clone();let{position:i}=t;e.userData.targetPos=i;const{duration:n,trackDuration:a}=t;e.userData.duration=n,e.userData.trailDuration=a;const{trailColor:r="#ff0000",trackWidth:s}=t;e.userData.mesh.material.lineWidth=s,e.userData.mesh.material.color=new Qt(r);const{iconMaxDistance:o}=t;e.userData.mesh.maxDistance=o*Ep.worldScale,e.userData.moveComplete=!1}(n),n.clear(),n.add(s),n.add(o),i&&i(1)}}}var TE=new class{addModelTrail(e,t,i){ME(...arguments).create()}updateModelTrail(e,t,i){ME(...arguments).update()}setModelTrailHighlight(e,t){const i=Ep.objectStore.find(e);if(void 0===i)return void(callback&&callback(0));const n=i.children[1];if(!1===t){if(Ep.effectStore.cancleHighlightObject(i.children[0]),void 0!==n.children[3]){let e=n.children[3];e.material.map.dispose(),e.material.dispose(),e.geometry.dispose(),n.remove(e)}}else if(Ep.effectStore.highlightObject(i.children[0],!0),void 0===n.children[3]){const t="texture/ui/highlight-landmark.png",i=n.children[1],a=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,t)),r=new vr({map:a,color:16777215,fog:!1,sizeAttenuation:i.material.sizeAttenuation,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest}),s=new Or(r);s.name=e+"_selector",s.position.set(i.position.x,i.position.y,i.position.z),s.scale.set(.02304/n.scale.x,.02304/n.scale.y,1),s.center=new ye(.5,.5),n.add(s)}}};function AE(e,t,i){function n(e){return new Promise((function(t){Ep.loaders.textureLoader.load(e,(function(e){t(e)}))}))}function a(e){e.userData.marker&&e.userData.marker.destroy(),e.traverse((function(e){!0===e.isMesh&&!0===e.isSprite&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach((function(e){e.dispose(),e.map&&e.map.dispose()})):(e.material.dispose(),e.material.map&&e.material.map.dispose()));const t=Ep.animationStore.findAnimation(e.uuid,yy);t&&Ep.animationStore.remove(t)}))}function r(e,t){e.traverse((function(e){if(e.material){if(e.setOpacity&&e.setOpacity(t),!Array.isArray(e.material))return void 0===e.userData.transparent&&(e.userData.transparent=e.material.transparent),void(t<1?(e.material.transparent=!0,e.material.opacity=t):(e.material.transparent=e.userData.transparent,e.material.opacity=t));if(void 0===e.userData.transparent){e.userData.transparent={};for(const t of e.material)e.userData.transparent[t.uuid]=t.transparent}if(t<1)for(const i of e.material)i.transparent=!0,i.opacity=t;else for(const i of e.material)i.transparent=e.userData.transparent[i.uuid],i.opacity=t}}))}function s(){const{asset:e,labelCanvas:i,enableLabel:n}=t;return e.color=e.color||"#ffffff",e.position=e.position||[0,0,0],e.size="number"==typeof e.size&&e.size>=0?e.size:100,e.opacity="number"==typeof e.opacity&&e.opacity>=0&&e.opacity<=1?e.opacity:1,new Promise(((a,r)=>{(new sr).name=e.name;const{scale:s}=t;if(e.isExplosion)e.isShow=!0,e.scale=s,e.position={x:0,y:0,z:0},i&&n&&(e.canvas=i),Ep.instance.addAnimatedSprite(e,(i=>{i.userData.modelType=e.name;const{rotation:n}=t,r=ge.degToRad(n.x),s=ge.degToRad(n.y),o=ge.degToRad(n.z);i.rotation.set(r,s,o);const{modelMaxDistance:l}=t;i.enableAutoHidebyDistance=!0,i.minDistance=0,i.maxDistance=l*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i),a(i)}),!0);else{let r=new Ix;r.load(e,((o,l)=>{l.children[0].scale.setScalar(s*Ep.worldScale);let c=new sr;if(c.name=e.name+"title",l.add(c),i&&n){let t=_E.createText(c,{canvas:i,sizeAttenuation:!1,width:414e-6*i.width,height:414e-6*i.height,offsetV:.5,offsetH:.5,enableText:!0});t.name=e.name,t.position.y=e.titleHeight*s*Ep.worldScale}l.userData.modelType=e.name;const{rotation:h}=t,u=ge.degToRad(h.x),d=ge.degToRad(h.y),p=ge.degToRad(h.z);l.rotation.set(u,d,p);const{modelMaxDistance:m}=t;l.enableAutoHidebyDistance=!0,l.minDistance=0,l.maxDistance=m*Ep.worldScale,Ep.animationStore.addDistance(l.uuid,yy,Ep.camera,l),l.userData.marker=r,a(l)}))}}))}async function o(){const{iconAssetName:i}=t,n=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===i)),a=JSON.parse(JSON.stringify(n));a.transform.position.x=0,a.transform.position.y=0,a.transform.position.z=0;const{labelText:r,labelColor:s,labelBackground:o}=t;a.textParam.enableText=!!r,a.textParam.text=r,a.textParam.color=s,a.textParam.background=o;const l=new sr,c=await function(e,t){return new Promise((function(i){new yb(e,t,(function(e,t){i(t)}))}))}(a,l),h=l.children[0];h.name=e,h.userData.iconItem=c;for(const t of h.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;const{modelMaxDistance:u,iconMaxDistance:d}=t;return h.enableAutoHidebyDistance=!0,h.minDistance=u*Ep.worldScale,h.maxDistance=d*Ep.worldScale,Ep.animationStore.addDistance(h.uuid,yy,Ep.camera,h),h}async function l(){const i=new sr;i.name=e;let a=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(a=!1);const{iconBackground:r}=t;if(r){const s="texture/iconBackground/"+r+".png",o=_y.url(Ep.instance.resourceBasePath,s),l=await n(o),{iconBackgroundColor:c,sizeAttenuation:h,polygonOffset:u,polygonOffsetFactor:d,polygonOffsetUnits:p}=t,m=new vr({alphaTest:.1,transparent:!0,fog:Uy,depthWrite:a,depthTest:a,map:l,color:new Qt(c),sizeAttenuation:h,polygonOffset:u,polygonOffsetFactor:d,polygonOffsetUnits:p});if("rgba"===c.substring(0,4)){let e=c.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),m.opacity=e}const f=new Or(m);f.name=e,f.onBeforeRender=function(){this.userData.inView=!0};const{iconWidth:g,iconHeight:y,iconScale:v=1}=t,b=h?g/30:g/3e3,_=h?y/30:y/3e3;f.scale.set(b*v,_*v,1);const{iconXOffset:x,iconYOffset:w,factor:S=-.1}=t,M=x/30*S+.5,T=w/30*S+.5;f.center=new ye(M,T),f.userData.iconBackground=r,i.add(f)}else i.add(new sr);const{iconPath:s}=t,o=await n(s),{sizeAttenuation:l,polygonOffset:c,polygonOffsetFactor:h,polygonOffsetUnits:u}=t,d=new vr({alphaTest:.1,depthWrite:!1,transparent:!0,color:new Qt("#ffffff"),fog:Uy,depthTest:a,map:o,sizeAttenuation:l,polygonOffset:c,polygonOffsetFactor:h,polygonOffsetUnits:u}),p=new Or(d);p.name=e,p.onBeforeRender=function(){this.userData.inView=!0};const{iconWidth:m,iconHeight:f,iconScale:g=1}=t,y=l?m/50:m/5e3,v=l?f/50:f/5e3;p.scale.set(y*g,v*g,1);const{iconXOffset:b,iconYOffset:_}=t;p.center.set(b,_),p.userData.iconPath=s,i.add(p);const{enableLabel:x}=t;if(x){const{labelCanvas:n,labelAlignment:r,labelXOffset:s,labelYOffset:o}=t,c={enableText:x,canvas:n,sizeAttenuation:l,labelAlignment:r,offsetV:s,offsetH:o*g},h=_E.createText_Billboard(i,c);h.name=e,h.material.depthWrite=a,h.material.depthTest=a}else i.add(new sr);i.activeVisible=!0;const{modelMaxDistance:w,iconMaxDistance:S}=t;return i.enableAutoHidebyDistance=!0,i.minDistance=w*Ep.worldScale,i.maxDistance=S*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i),i}async function c(i){const{useIconAsset:r}=t;return!0===r?void 0!==i.userData.iconItem?i=function(i){const{iconAssetName:n}=t,a=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===n)),r=JSON.parse(JSON.stringify(a));r.transform.position.x=0,r.transform.position.y=0,r.transform.position.z=0;const{labelText:s,labelColor:o,labelBackground:l}=t;r.textParam.enableText=!!s,r.textParam.text=s,r.textParam.color=o,r.textParam.background=l,i.userData.iconItem.update(r,void 0,!1),i.name=e;for(const t of i.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;const{modelMaxDistance:c,iconMaxDistance:h}=t;return i.minDistance=c*Ep.worldScale,i.maxDistance=h*Ep.worldScale,i}(i):(a(i),i=await o()):void 0===i.userData.iconItem?i=await async function(i){let r=i.children[0],s=i.children[1],o=i.children[2],l=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(l=!1);const{iconBackground:c}=t;if(c){if(!0!==r.isSprite){const t=new vr({alphaTest:.1,transparent:!0,fog:Uy});r=new Or(t),r.name=e}if(r.userData.iconBackground!==c){const e="texture/iconBackground/"+c+".png",t=_y.url(Ep.instance.resourceBasePath,e),i=await n(t);r.material.map.dispose(),r.material.map=i}r.material.depthWrite=l,r.material.depthTest=l;const{iconBackgroundColor:i,sizeAttenuation:a,polygonOffset:s,polygonOffsetFactor:o,polygonOffsetUnits:h}=t;if(r.material.color=new Qt(i),r.material.sizeAttenuation=a,r.material.polygonOffset=s,r.material.polygonOffsetFactor=o,r.material.polygonOffsetUnits=h,"rgba"===i.substring(0,4)){let e=i.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),r.material.opacity=e}const{iconWidth:u,iconHeight:d,iconScale:p=1}=t,m=a?u/30:u/3e3,f=a?d/30:d/3e3;r.scale.set(m*p,f*p,1);const{iconXOffset:g,iconYOffset:y,factor:v=-.1}=t,b=g/30*v+.5,_=y/30*v+.5;r.center=new ye(b,_)}else a(r),r=new sr;const{iconPath:h}=t;if(s.userData.iconPath!==h){const e=await n(h);s.material.map.dispose(),s.material.map=e}s.material.depthTest=l;const{sizeAttenuation:u,polygonOffset:d,polygonOffsetFactor:p,polygonOffsetUnits:m}=t;s.material.sizeAttenuation=u,s.material.polygonOffset=d,s.material.polygonOffsetFactor=p,s.material.polygonOffsetUnits=m;const{iconWidth:f,iconHeight:g,iconScale:y=1}=t,v=u?f/50:f/5e3,b=u?g/50:g/5e3;s.scale.set(v*y,b*y,1);const{iconXOffset:_,iconYOffset:x}=t;s.center.set(_,x);const{enableLabel:w}=t;if(a(o),w){const{labelCanvas:i,labelAlignment:n,labelXOffset:a,labelYOffset:r}=t,c={enableText:w,canvas:i,sizeAttenuation:u,labelAlignment:n,offsetV:a,offsetH:r*y},h=new sr;h.children[1]=s,o=_E.createText_Billboard(h,c),o.name=e,o.material.depthWrite=l,o.material.depthTest=l}else o=new sr;i.clear(),i.add(r),i.add(s),i.add(o);const{modelMaxDistance:S,iconMaxDistance:M}=t;return i.minDistance=S*Ep.worldScale,i.maxDistance=M*Ep.worldScale,i}(i):(a(i),i=await l()),i}return{create:async function(){const n=function(){Ep.objectStore.remove(e);const i=new sr;i.name=e;const{renderOrder:n}=t;i.renderOrder=Fy+n;const{isShow:a}=t;i.visible=!!a,i.activeVisible=!!a;const{enableAutoHidebyDistance:r,minDistance:s,maxDistance:o}=t;i.enableAutoHidebyDistance=!!r,i.minDistance=s*Ep.worldScale,i.maxDistance=o*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i);let{position:l}=t;if(i.position.set(l.x,l.y,l.z),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){i.rotation.order="YXZ";const{pos:e}=t;i.rotation.y=(e.lon+90)/180*Math.PI,i.rotation.x=(90-e.lat)/180*Math.PI}return i}(),a=await s(),c=await async function(){let e=null;const{useIconAsset:i}=t;return e=!0===i?await o():await l(),e}();if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){const e=new fv(c,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR);Ep.drawableDepthTest?e.resume():e.pause(),Ep.animationStore.add(e)}n.add(a),n.add(c);const{alpha:h}=t;r(n,h),Ep.objectStore.add(e,n),i&&i(n)},update:async function(){const n=Ep.objectStore.find(e);if(void 0===n)return void(i&&i(0));!function(e){const{renderOrder:i}=t;e.renderOrder=Fy+i;const{isShow:n}=t;e.visible=!!n,e.activeVisible=!!n;const{enableAutoHidebyDistance:a,minDistance:r,maxDistance:s}=t;e.enableAutoHidebyDistance=!!a,e.minDistance=r*Ep.worldScale,e.maxDistance=s*Ep.worldScale;let{position:o}=t;if(e.position.set(o.x,o.y,o.z),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){e.rotation.order="YXZ";const{pos:i}=t;e.rotation.y=(i.lon+90)/180*Math.PI,e.rotation.x=(90-i.lat)/180*Math.PI}}(n);const o=await async function(e){return a(e),await s()}(n.children[0]),l=await c(n.children[1]);n.clear(),n.add(o),n.add(l);const{alpha:h}=t;r(n,h),i&&i(1)}}}var EE=new class{addMarkerLandmark(e,t,i){AE(...arguments).create()}updateMarkerLandmark(e,t,i){AE(...arguments).update()}};function CE(e,t,i,n){function a(e){return new Promise((function(t){Ep.loaders.textureLoader.load(e,(function(e){t(e)}))}))}function r(e){e.traverse((function(e){!0===e.isMesh&&!0===e.isSprite&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach((function(e){e.dispose(),e.map&&e.map.dispose()})):(e.material.dispose(),e.material.map&&e.material.map.dispose()));const t=Ep.animationStore.findAnimation(e.uuid,yy);t&&Ep.animationStore.remove(t)}))}async function s(){const{iconAssetName:n}=t,a=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===n)),r=JSON.parse(JSON.stringify(a));r.transform.position.x=0,r.transform.position.y=0,r.transform.position.z=0;const{enableText:s,labelText:o}=i;r.textParam.enableText=s,r.textParam.text=o,r.param.iconScale=t.iconScale,r.textParam.labelScale=i.labelScale;const l=new sr,c=await function(e,t){return new Promise((function(i){new yb(e,t,(function(e,t){i(t)}))}))}(r,l),h=l.children[0];h.userData.iconItem=c;for(const t of h.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;return h}async function o(){const n=new sr;n.name=e;let r=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(r=!1);const{background:s}=t;if(s){const i="texture/iconBackground/"+s+".png",o=_y.url(Ep.instance.resourceBasePath,i),l=await a(o),{backgroundColor:c,sizeAttenuation:h}=t,u=new vr({alphaTest:.1,transparent:!0,fog:Uy,depthWrite:r,depthTest:r,map:l,color:new Qt(c),sizeAttenuation:h});if("rgba"===c.substring(0,4)){let e=c.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),u.opacity=e}const d=new Or(u);d.name=e,d.onBeforeRender=function(){this.userData.inView=!0};const{width:p,height:m,iconScale:f=1}=t,g=h?p/30:p/3e3,y=h?m/30:m/3e3;d.scale.set(g*f,y*f,1);const{offsetV:v,offsetH:b,factor:_=-.1}=t,x=v/30*_+.5,w=b/30*_+.5;d.center=new ye(x,w),d.userData.background=s,n.add(d)}else n.add(new sr);const{path:o}=t,l=await a(o),{sizeAttenuation:c}=t,h=new vr({alphaTest:.1,transparent:!0,color:new Qt("#ffffff"),fog:Uy,depthWrite:r,depthTest:r,map:l,sizeAttenuation:c}),u=new Or(h);u.name=e,u.onBeforeRender=function(){this.userData.inView=!0};const{width:d,height:p,iconScale:m=1}=t,f=c?d/50:d/5e3,g=c?p/50:p/5e3;u.scale.set(f*m,g*m,1);const{offsetV:y,offsetH:v}=t;u.center.set(y,v),u.userData.path=o,n.add(u);const{enableText:b}=i;if(b){const{canvas:t,labelAlignment:a,offsetV:s,offsetH:o,labelScale:l=1}=i,h={enableText:b,canvas:t,sizeAttenuation:c,labelAlignment:a,offsetV:s,offsetH:o*m},u=_E.createText_Billboard(n,h);u.name=e,u.material.depthWrite=r,u.material.depthTest=r,u.scale.x*=l,u.scale.y*=l,u.center.y/=l}else n.add(new sr);return n}async function l(n){const{useIconAsset:l}=t;if(!0===l){if(void 0!==n.userData.iconItem)return n=await async function(n){const{iconAssetName:a}=t,r=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===a)),s=JSON.parse(JSON.stringify(r));s.transform.position.x=0,s.transform.position.y=0,s.transform.position.z=0;const{labelText:o}=i;s.textParam.enableText=!!o,s.textParam.text=o,s.param.iconScale=t.iconScale,s.textParam.labelScale=i.labelScale;const l=n.userData.iconItem;await l.update(s,void 0,!1),n.name=e;for(const t of n.children)t.onBeforeRender=function(){this.userData.inView=!0},t.name=e;return n}(n);r(n);return await s()}if(void 0===n.userData.iconItem)return n=await async function(n){let s=n.children[0],o=n.children[1],l=n.children[2],c=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(c=!1);const{background:h}=t;if(h){if(!0!==s.isSprite){const t=new vr({alphaTest:.1,transparent:!0,fog:Uy});s=new Or(t),s.name=e}if(s.userData.background!==h){const e="texture/iconBackground/"+h+".png",t=_y.url(Ep.instance.resourceBasePath,e),i=await a(t);s.material.map.dispose(),s.material.map=i,s.userData.background=h}s.material.depthWrite=c,s.material.depthTest=c;const{backgroundColor:i,sizeAttenuation:n}=t;if(s.material.color=new Qt(i),s.material.sizeAttenuation=n,"rgba"===i.substring(0,4)){let e=i.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),s.material.opacity=e}const{width:r,height:o,iconScale:l=1}=t,u=n?r/30:r/3e3,d=n?o/30:o/3e3;s.scale.set(u*l,d*l,1);const{offsetV:p,offsetH:m,factor:f=-.1}=t,g=p/30*f+.5,y=m/30*f+.5;s.center=new ye(g,y)}else r(s),s=new sr;const{path:u}=t;if(o.userData.path!==u){const e=await a(u);o.material.map.dispose(),o.material.map=e}o.material.depthWrite=c,o.material.depthTest=c;const{sizeAttenuation:d}=t;o.material.sizeAttenuation=d;const{width:p,height:m,iconScale:f=1}=t,g=d?p/50:p/5e3,y=d?m/50:m/5e3;o.scale.set(g*f,y*f,1);const{offsetV:v,offsetH:b}=t;o.center.set(v,b);const{enableText:_}=i;if(r(l),_){const{canvas:t,labelAlignment:n,offsetV:a,offsetH:r,labelScale:s=1}=i,h={enableText:_,canvas:t,sizeAttenuation:d,labelAlignment:n,offsetV:a,offsetH:r*f},u=new sr;u.children[1]=o,l=_E.createText_Billboard(u,h),l.name=e,l.material.depthWrite=c,l.material.depthTest=c,l.scale.x*=s,l.scale.y*=s,l.center.y/=s}else l=new sr;return n.clear(),n.add(s),n.add(o),n.add(l),n}(n);r(n);return await o()}return void 0===t.iconScale&&(t.iconScale=1),void 0===i.labelScale&&(i.labelScale=1),{create:async function(){const i=function(){Ep.objectStore.remove(e);const i=new sr;i.name=e;const{renderOrder:n}=t;i.renderOrder=Fy+n;const{isShow:a}=t;i.visible=!!a,i.activeVisible=!!a;const{enableAutoHidebyDistance:r,minDistance:s,maxDistance:o}=t;i.enableAutoHidebyDistance=!!r,i.minDistance=s*Ep.worldScale,i.maxDistance=o*Ep.worldScale,Ep.animationStore.addDistance(i.uuid,yy,Ep.camera,i);let{pos:l}=t;return i.position.set(l.x,l.y,l.z),i}(),r=await async function(){const{useIconAsset:e}=t;if(!0===e)return await s();return await o()}();if(i.add(...r.children),i.userData.billboard=r,i.rotation.copy(r.rotation),i.scale.copy(r.scale),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){const e=new fv(i,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR);Ep.drawableDepthTest?e.resume():e.pause(),Ep.animationStore.add(e)}await async function(i){const n=i.position;i.userData.startPos=n.clone(),i.userData.targetPos=n.clone(),Ep.baseCarrierController.add(e,i);const r=_y.url(Ep.instance.resourceBasePath,"texture/trail/trail.png"),s=await a(r);s.wrapS=m,s.wrapT=m,s.repeat.set(1,1);const{color:o="#ff0000",lineWidth:l}=t,c=new ye(window.innerWidth,window.innerHeight),h=new lb.MeshLineMaterial({opacity:1,dashArray:0,dashOffset:1,dashRatio:0,sizeAttenuation:1,alphaTest:0,useMap:!0,transparent:!0,repeat:new ye(1,1),side:2,depthWrite:Ep.drawableDepthTest,depthTest:!0,fog:Uy,resolution:c,map:s,color:new Qt(o),lineWidth:l*Ep.worldScale}),u=new Ov.MeshLine;u.setPoints([n.x,n.y,n.z]);const d=new Fi(u,h);d.onBeforeRender=function(){this.userData.inView=!0},d.renderOrder=i.renderOrder;const{enableAutoHidebyDistance:p,minDistance:f,maxDistance:g}=t;d.enableAutoHidebyDistance=!!p,d.minDistance=f*Ep.worldScale,d.maxDistance=g*Ep.worldScale,Ep.animationStore.addDistance(e+"Line",yy,Ep.camera,d),d.visible=!!t.isShow,d.activeVisible=!!t.isShow;const{duration:y}=t;i.userData.mesh=d,i.userData.currentTime=0,i.userData.duration=0,i.userData.trailDuration=y,i.userData.moveComplete=!0;let v=Ep.animationStore.findLayerAnimation(e,Pv.type);v&&Ep.animationStore.remove(v);const b=new Dv(i);v=new Pv(Ep.baseCarrierController,b,e),Ep.animationStore.add(v),Ep.objectStore.add(e+"Line",d)}(i),Ep.objectStore.add(e,i),n&&n(1)},update:async function(){const i=Ep.objectStore.find(e);if(void 0===i)return void(n&&n(0));!function(e){const{renderOrder:i}=t;e.renderOrder=Fy+i;const{isShow:n}=t;e.visible=!!n,e.activeVisible=!!n;const{enableAutoHidebyDistance:a,minDistance:r,maxDistance:s}=t;e.enableAutoHidebyDistance=!!a,e.minDistance=r*Ep.worldScale,e.maxDistance=s*Ep.worldScale}(i);const a=i.children[3];i.userData.billboard.add(...i.children);const r=await l(i.userData.billboard);i.add(...r.children),i.userData.billboard=r,i.rotation.copy(r.rotation),i.scale.copy(r.scale),void 0!==a&&i.add(a),async function(e){e.userData.currentTime=0,e.userData.startPos=e.position.clone();let{pos:i}=t;e.userData.targetPos=i;const{travelingTime:n,duration:a}=t;e.userData.duration=n,e.userData.trailDuration=a;const{color:r="#ff0000",lineWidth:s}=t;e.userData.mesh.material.lineWidth=s*Ep.worldScale,e.userData.mesh.material.color=new Qt(r);const{enableAutoHidebyDistance:o,minDistance:l,maxDistance:c}=t;e.userData.mesh.enableAutoHidebyDistance=!!o,e.userData.mesh.minDistance=l*Ep.worldScale,e.userData.mesh.maxDistance=c*Ep.worldScale,e.userData.moveComplete=!1}(i),n&&n(1)}}}var IE=new class{addTrail(e,t,i,n){CE(...arguments).create()}updateTrail(e,t,i){CE(...arguments).update()}};var PE=new class{addStarLight_bak(e,t){const i=e.getFullName();Ep.objectStore.remove(i);var n=new sr;n.renderOrder=Fy+("number"==typeof e.zLevel?e.zLevel:0),n.name=i;const a=e.radius*Ep.worldScale,r=new Qr(new sn(a,a),new Kt({depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,transparent:!0,opacity:e.alpha,color:e.color}),e.points.length);r.name=i,r.onBeforeRender=function(){this.userData.inView=!0};const s=new it;for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];s.makeRotationX(-Math.PI/2),s.setPosition(i.x,i.y,i.z),r.setMatrixAt(t,s)}r.instanceMatrix.needsUpdate=!0,n.add(r),Ep.objectStore.add(i,n),t&&t(n)}createCanvas_bak(e){const t=e.radius*Ep.worldScale,i=document.createElement("canvas");i.setAttribute("width",t),i.setAttribute("height",t);const n=i.getContext("2d");return n.fillStyle=e.color,n.strokeStyle=e.color,n.fillRect(0,0,t,t),n.strokeRect(0,0,t,t),{canvas:i,width:t,height:t}}addStarLight(e,t){const i=e.getFullName();if(Ep.objectStore.remove(i),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type)return void this.addStarLight_ecef(e,t);var n=new sr;n.renderOrder=Fy+("number"==typeof e.zLevel?e.zLevel:0),n.name=i;const a=this.createCanvas(e),r=new sn(a.width,a.height),s=new vs(a.canvas),o=new Fi(r,new To({map:s,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,transparent:!0,opacity:e.alpha}));o.name=i,n.add(o),o.rotation.x=-Math.PI/2,o.scale.setScalar(a.scale),n.position.copy(a.center),Ep.objectStore.add(i,n),t&&t(n)}createCanvas(e){const t=Math.floor(e.radius),i=new Re;i.setFromPoints(e.points),i.max.addScalar(t/2),i.min.subScalar(t/2);const n=Math.ceil(i.max.x-i.min.x),a=Math.ceil(i.max.z-i.min.z);let r=4096,s=4096;n>a?s=Math.ceil(r/n*a):r=Math.ceil(s/a*n);const o=new Array(s*r);for(const l of e.points){const e=Math.ceil((l.x-i.min.x)*(r/n)),c=Math.ceil((l.z-i.min.z)*(s/a));for(let i=0;i<t;i++)for(let n=0;n<t;n++){const t=(c+i)*r+n+e;void 0===o[t]&&(o[t]=0),o[t]+=1}}const l=document.createElement("canvas"),c=l.getContext("2d");l.width=r,l.height=s;const h=new Qt(e.color),u={};h.getHSL(u);const d=h.clone().setHSL(u.h,u.s,1);let p=-1/0,m=1/0;o.forEach((function(e){void 0!==e&&(m=Math.min(m,e),p=Math.max(p,e))}));const f=c.getImageData(0,0,l.width,l.height);for(let e=0;e<s*r;e++){if(void 0===o[e])continue;let t=h;p!==m&&(t=h.clone().lerp(d,(o[e]-m)/(p-m)));const i=4*e;f.data[i]=255*t.r,f.data[i+1]=255*t.g,f.data[i+2]=255*t.b,f.data[i+3]=255}c.putImageData(f,0,0);return{canvas:l,width:r,height:s,center:i.getCenter(),scale:n/r}}addStarLight_ecef(e,t){const i=[];for(const t of e.points)i.push(Ep.instance.convertLLAToXYZ({x:t.lon,y:t.lat,z:t.alt}));const n=new Re;n.setFromPoints(i);const a=new Ce;n.getCenter(a);const r=Ep.instance.convertXYZToLLA(a.clone()),s=ge.degToRad(90-r.y),o=ge.degToRad(90+r.x),l=new Ee;l.setFromEuler(new dt(s,o,0,"YXZ")).invert();for(const e of i)e.applyQuaternion(l);n.setFromPoints(i);const c=new Ce;n.getSize(c);const h=Math.ceil(e.radius*Ep.worldScale),u=Math.ceil(c.x+2*h),d=Math.ceil(c.z+2*h),p=55500*Ep.worldScale,m=Math.ceil(u/p),f=Math.ceil(d/p),g=new sn(u,d,m,f),y=new dt,v=new it;y.x=-Math.PI/2,v.makeRotationFromEuler(y),g.applyMatrix4(v),n.getCenter(a),a.copy(Ep.instance.convertXYZToLLA(a)),a.z=e.points[0].alt,a.copy(Ep.instance.convertLLAToXYZ(a)),a.applyQuaternion(l.invert());const b=Ep.instance.convertXYZToLLA(a);e.center=a.clone(),e.center.type="xyz",y.order="YXZ",y.y=ge.degToRad(90+b.x),y.x=ge.degToRad(90-b.y),v.makeRotationFromEuler(y),v.setPosition(a.x,a.y,a.z),g.applyMatrix4(v);const _=g.attributes.position.array,x=new Ce,w=a.length(),S=a.lengthSq(),M=a.clone().normalize();for(let e=0;e<_.length;e+=3){x.fromArray(_,e);const t=x.clone().sub(a).lengthSq();M.setLength(w-Math.sqrt(S-t)),x.sub(M).toArray(_,e)}let T=4096,A=4096,E=h;u>d?(A=Math.ceil(A*(d/u)),E=Math.ceil(E*(T/u))):(T=Math.ceil(T*(u/d)),E=Math.ceil(E*(A/d)));const C=new Array(T*A),I=T/u,P=A/d,R=E-1;for(const e of i){const t=Math.ceil((e.x-n.min.x)*I)+R,i=Math.ceil((e.z-n.min.z)*P)+R;for(let e=-R;e<R;e++)for(let n=-R;n<R;n++){const a=T*(i+e)+(t+n);void 0===C[a]&&(C[a]=0),C[a]+=1}}let O=-1/0,D=1/0;for(const e of C)void 0!==e&&(D=Math.min(D,e),O=Math.max(O,e));const L=new Qt(e.color),k=L.clone();if(O!==D){const e={};L.getHSL(e),k.setHSL(e.h,e.s,1)}const N=document.createElement("canvas"),B=N.getContext("2d");N.width=T,N.height=A;const z=B.getImageData(0,0,N.width,N.height),U=O-D;for(let e=0;e<C.length;e++){if(void 0===C[e])continue;let t=(C[e]-D)/U;t||(t=0);const i=L.clone().lerp(k,t),n=4*e;z.data[n]=255*i.r,z.data[n+1]=255*i.g,z.data[n+2]=255*i.b,z.data[n+3]=255}B.putImageData(z,0,0);const F=new vs(N),j=new To({map:F,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,transparent:!0,opacity:e.alpha,polygonOffset:!0,polygonOffsetFactor:.1,polygonOffsetUnits:-4}),H=e.getFullName(),G=new Fi(g,j);G.onBeforeRender=function(){this.userData.inView=!0},G.name=H;var V=new sr;V.renderOrder=Fy+("number"==typeof e.zLevel?e.zLevel:0),V.name=H,V.add(G),V.activeVisible=!!e.isShow,V.visible=!!e.isShow,Ep.objectStore.add(H,V),t&&t(V)}};const RE=function(){let e,t,i,n,a,r;function s(t,{name:i=""}){if(!i.includes("/iconmodellandmark"))return;const n=i.split("/"),a=n[0],r=n[1],s=e[a].data[r];s.iconModel.isToggle&&(s.isChecked=!s.isChecked,s.controller.toggle(s.isChecked))}function o(t,{name:i=""}){if(!i.includes("/iconmodellandmark"))return;const n=i.split("/"),a=n[0],r=n[1],s=e[a].data[r];s.iconModel.isToggle&&(f({layer:a,name:r,showBox:!0}),s.isChecked||s.controller.toggle(!0))}function l(t,{name:i=""}){if(!i.includes("/iconmodellandmark"))return;const n=i.split("/"),a=n[0],r=n[1],s=e[a].data[r];s.iconModel.isToggle&&(f({layer:a,name:r,showBox:!1}),s.isChecked||s.controller.toggle(!1))}function c(e,t,i){const n=Math.max(...Ep.defaultObjectTree.children.map((e=>e.index)))+1;return new Promise((function(a){new yb({name:e.id,index:n,isVisible:e.visible,transform:{position:{x:i.iconSetting.transformNode.position.x,y:i.iconSetting.transformNode.position.y,z:i.iconSetting.transformNode.position.z},scale:i.iconSetting.transformNode.scale},param:{background:"",backgroundColor:"",height:128,width:128,offsetH:.5,offsetV:0,path:t,minDistance:i.visibleSetting.iconNear,maxDistance:i.visibleSetting.iconFar,polygonOffset:!1,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,sizeAttenuation:!1,iconScale:e.iconScale},textParam:{background:i.iconSetting.textParam.background,color:i.iconSetting.textParam.color,enableItalic:i.iconSetting.textParam.enableItalic,enableText:i.iconSetting.textParam.enableText,fontBold:i.iconSetting.textParam.fontBold,fontFamily:i.iconSetting.textParam.fontFamily,fontSize:i.iconSetting.textParam.fontSize,textSize:i.iconSetting.textParam.textSize,offsetH:i.iconSetting.textParam.offsetH,offsetV:i.iconSetting.textParam.offsetV,text:e.labelText,fontWeight:i.iconSetting.textParam.fontWeight,hiddenDistance:i.iconSetting.textParam.hiddenDistance,minDistance:i.iconSetting.textParam.textNear,maxDistance:i.iconSetting.textParam.textFar,padding:i.iconSetting.textParam.padding,position:i.iconSetting.textParam.position,labelScale:e.labelScale},type:"IconAsset",parent:"objectTree",isCustom:!1},void 0,void 0,void 0,((t,i)=>{const n=Ep.defaultObjectTree.children.indexOf((e=>e===i));Ep.defaultObjectTree.children.splice(n,1);const r=i.getGroup();r.parent.remove(r),r.renderOrder=Fy+e.zLevel,r.traverse((t=>t.name=e.id)),a(r)}))}))}function h(e){return new Promise((function(t){e.token&&e.token.length>64&&Ep.instance.setAvwToken("header","authorization:bearer",e.token),Ep.cacheStore.loadTGPW({path:e.url,onLoad:async n=>{const a=_y.cloneDeep(n.children[0].userData.dhExtension);await Ep.textureStore.applySettings(a.texture0||{}),delete a.texture0,await Ep.customTextureStore.applySettings(a.texture||[]);const r=a.objectTree.children[0];Ep.instance.defaultObjectTree.addModel({name:r.name,modelPath:r.modelPath,modelType:r.modelType||"glb",transform:r.transform,index:Math.max(...Ep.defaultObjectTree.children.map((e=>e.index)))+1,isVisible:null==r.isVisible||r.isVisible,isLock:null!=r.isLock&&r.isLock},(async(r,s,o)=>{Ep.instance.defaultObjectTree.applySettings({children:[a.objectTree.children[0]]});const l=Ep.defaultObjectTree.children.indexOf((e=>e===o));Ep.defaultObjectTree.children.splice(l,1);const c=o.getGroup();c.parent.remove(c),c.updateMatrixWorld();const h=new Re;h.expandByObject(c);const u=[];c.traverse((function(t){if(t.userData.originPosition=t.position.clone(),t.userData.originRotation=t.rotation.clone(),t.userData.originScale=t.scale.clone(),!t.isMesh)return;const n=new Qr(t.geometry.clone(),t.material,zy);if(Array.isArray(n.material))for(const e of n.material)e.depthWrite=Ep.drawableDepthTest,e.depthTest=Ep.drawableDepthTest;else n.material.depthWrite=Ep.drawableDepthTest,n.material.depthTest=Ep.drawableDepthTest;n.material.needsUpdate=!0,n.instanceColor=new ti(new Float32Array(196605),3),n.receiveShadow=t.receiveShadow,n.castShadow=t.castShadow;const a=e.id.split("/");a[1]=e.iconModelId,n.name=a.join("/"),n.count=0,n.instanceMatrix.setUsage(he),n.renderOrder=Fy+e.zLevel,t.userData.instancedMeshIndex=u.length,n.userData.matrixWorld=t.matrixWorld.clone(),i.add(n),u.push(n)}));const d=[],p="toggle"===n.userData.setting.behavior;if(p)for(const e of u){const t=e.clone();if(Array.isArray(t.material)){const e=t.material.length;for(let i=0;i<e;i++){const e=t.material[i];e.transparent=!0,e.opacity=0,t.material[i]=e.clone(),t.material[i].opacity=.5}}else t.material.transparent=!0,t.material.opacity=0,t.material=t.material.clone(),t.material.opacity=.5;i.add(t),d.push(t)}const m=[],f=[];if(o.articulations){for(const e of o.articulations){if("numeric"!==e.type)continue;const t={name:e.name,defaultValue:e.getDefaultValue(),minState:e.getValues()[0],maxState:e.getValues()[1],properties:[],state:"stopped",elapsedTime:0};for(const i of e.properties)for(const e of i.nodes)for(const n of i.modifiers)t.properties.push({nodeName:e,type:n.key,minValue:n.values[0],maxValue:n.values[1]});t.properties.length<=0||f.push(t)}if(f.length>0&&o.articulationAnimations)for(const e of o.articulationAnimations){const t={name:e.animationName,loopType:e.animationType,speed:e.animationSpeed,items:[],elapsedTime:0,state:"stopped",duration:0,direction:1};for(const i of e.articulationAnimationItems){if(!i.articulationName)continue;if(!f.find((e=>e.name===i.articulationName)))continue;const e={startTime:i.startTime,duration:i.continueTime,startState:i.startState,endState:i.endState,articulationName:i.articulationName,state:"stopped"};t.items.push(e),t.duration=Math.max(t.duration,i.startTime+i.continueTime)}t.items.length<=0||m.push(t)}}t({iconModelId:e.iconModelId,modelItem:o,modelObject:c,box:h,animations:m,articulations:f,meshes:u,toggleMeshes:d,isToggle:p,interval:n.userData.setting.iconSetting.transformNode.interval,icon:n.userData.icon,setting:n.userData.setting})}))},onError:()=>{t()}})}))}function u(e){const t=(new Ce).copy(e.position),i=(new Ce).copy(e.scale),n=ge.degToRad(e.rotation.x),a=ge.degToRad(e.rotation.y),r=ge.degToRad(e.rotation.z),s=new dt(n,a,r),o=(new Ee).setFromEuler(s);return(new it).compose(t,o,i)}async function d(t,i,a){e[t.layer]||(e[t.layer]={name:t.layer,data:{},iconModes:{}});const r=e[t.layer];r.data[t.name]||(r.data[t.name]={name:t.name,id:t.id,parameters:t,controller:void 0,isChecked:!1,matrix:new it,box:new Re,visible:!!t.visible});const s=r.data[t.name];r.iconModes[t.iconModelId]||(r.iconModes[t.iconModelId]=await h(t));const o=r.iconModes[t.iconModelId];s.iconModel=o,s.box.copy(o.box),s.matrix.copy(u(t));for(const e of o.meshes)s.index=e.count,e.setColorAt(s.index,new Qt),e.instanceColor.needsUpdate=!0,e.count++;for(const e of o.toggleMeshes)e.setColorAt(s.index,new Qt),e.instanceColor.needsUpdate=!0,e.count++,e.instanceMatrix.needsUpdate=!0;if(s.visible=!!t.visible,s.maxDistance=o.setting.visibleSetting.modelFar*Ep.worldScale,s.minDistance=o.setting.visibleSetting.modelNear*Ep.worldScale,o.icon){const e=await c(t,o.icon,o.setting);e.userData.labelText=t.labelText,n.add(e),e.visible=t.visible,e.activeVisible=t.visible,s.icon=e}let l=a;l||(l=new gb(Ep.camera)),Ep.animationStore.add(l),l.bindData(s),s.controller=l,i&&i({result:1,message:"成功。"})}function p(t,s){const o=t.id.split("/"),l=e[o[0]];if(!l)return;const c=l.data[o[1]];if(!c)return;const h=c.index,u=c.iconModel.meshes.length;for(let e=0;e<u;e++){const t=c.iconModel.meshes[e];if(t.count--,c.iconModel.isToggle&&c.iconModel.toggleMeshes[e].count--,0===t.count&&(delete l.iconModes[c.iconModel.iconModelId],i.remove(t),_y.disposeThreeObject(t),c.iconModel.isToggle)){const t=c.iconModel.toggleMeshes[e];i.remove(t),_y.disposeThreeObject(t)}}delete l.data[o[1]];for(const e in l.data)l.data[e].iconModel===c.iconModel&&l.data[e].index>h&&(l.data[e].index--,l.data[e].controller.index--,l.data[e].controller.changed=!0);c.icon&&(n.remove(c.icon),_y.disposeThreeObject(c.icon)),c.boxHelper&&(a.remove(c.boxHelper),_y.disposeThreeObject(c.boxHelper)),c.trail&&(r.remove(c.trail),_y.disposeThreeObject(c.trail),Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(c.id+"Line",yy.type))),c.controller&&Ep.animationStore.remove(c.controller),s&&s({result:1,message:"成功。"})}function f(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"不存在"}));const r=n.data[t.name];if(r){if(t.showBox){if(!r.boxHelper){const e=new Mb(new Re,16776960,{},{},0,!0);e.name=r.id,e.material.depthTest=Ep.drawableDepthTest,e.material.depthWrite=Ep.drawableDepthTest,e.renderOrder=Fy+r.parameters.zLevel;const t=r.box.clone().applyMatrix4(r.matrix);e.box.copy(t),a.add(e),r.boxHelper=e}}else r.boxHelper&&(a.remove(r.boxHelper),_y.disposeThreeObject(r.boxHelper),delete r.boxHelper);i&&i({result:1,message:"成功。"})}else i&&i({result:0,message:"不存在"})}return{init:function(){t=new sr,t.name="__instancedIconModelLandmark",Ep.scene.add(t),Ep.scene.instancedIconModelLandmark=t,i=new sr,i.name="instanced",t.add(i),n=new sr,n.name="iconObject",t.add(n),a=new sr,a.name="boxObject",t.add(a),r=new sr,r.name="trailObject",t.add(r),Ep.eventHandlerStore.add("click","drawable",s),Ep.eventHandlerStore.add("mousehover","drawable",o),Ep.eventHandlerStore.add("unmousehover","drawable",l),e={},Ep.instancedIconModelLandmarkLayers=e},add:d,update:async function(t,i){const a=e[t.layer];if(!a)return void(i&&i({result:0,message:"不存在"}));let r=a.data[t.name];if(!r)return void(i&&i({result:0,message:"不存在"}));let o=a.iconModes[t.iconModelId];if(o||(a.iconModes[t.iconModelId]=await h(t),o=a.iconModes[t.iconModelId]),void 0===t.position&&(t.position=r.parameters.position),r.parameters=t,r.iconModel!==o){const e=!!r.boxHelper,n=!!r.isChecked,a=r.controller;delete r.controller,Ep.animationStore.remove(a),p(t),d(t,(a=>{e&&f({...t,showBox:!0}),n&&s(0,{name:t.id}),i&&i(a)}),a)}else{const e=u(t);if(r.matrix.copy(e),r.icon&&r.icon.userData.labelText!==t.labelText){n.remove(r.icon),_y.disposeThreeObject(r.icon);const e=await c(t,o.icon,o.setting);e.userData.labelText=t.labelText,n.add(e),e.visible=t.visible,e.activeVisible=t.visible,r.icon=e}r.controller.changed=!0,i&&i({result:1,message:"成功。"})}},remove:p,setVisible:function(t,i){const{id:n,isShow:a}=t,r=n.split("/"),s=e[r[0]];if(!s)return;const o=s.data[r[1]];o&&(o.visible=!!a,o.parameters.visible=!!a,o.icon&&(o.icon.visible=!!a,o.icon.activeVisible=!!a),o.boxHelper&&(o.boxHelper.visible=!!a,o.boxHelper.activeVisible=!!a),o.trail&&(o.trail.visible=!!a,o.trail.activeVisible=!!a),i&&i({result:1,message:"成功。"}))},getInfo:function(t,i){const{name:n,index:a}=t,r=n.split("/"),s=r[0],o=e[s];if(!o)return;let l;if(void 0===a){const e=r[1];for(const t in o.data)if(t===e){l=o.data[t];break}}else{const e=r[1];for(const t in o.data)if(o.data[t].iconModel.iconModelId===e&&o.data[t].index===a){l=o.data[t];break}}return i&&i({result:1,message:"成功。",layer:o,data:l,id:l.id}),{layer:o,data:l,id:l.id}},showBox:f,setTransform:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"不存在"}));const a=n.data[t.name];if(!a)return void(i&&i({result:0,message:"不存在"}));const r=new Ce,s=new Ee,o=new Ce;a.matrix.decompose(r,s,o),t.position&&r.copy(t.position),t.rotation&&s.copy(t.rotation),t.scale&&o.copy(t.scale),a.matrix.compose(r,s,o),a.controller.changed=!0},getAnimation:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"找不到"}));const a=n.data[t.name];if(!a)return void(i&&i({result:0,message:"找不到"}));const r=[];for(const e of a.controller.animations){const t={name:e.name,speed:e.speed,rerverserType:e.loopType,state:"stop"};"playing"===e.state&&(t.state="playing","paused"===e.state&&(t.state="pause")),r.push(t)}r.length<=0?i&&i({result:0,message:"失败，模型没有动画。"}):i&&i({result:1,message:"成功",id:t.id,data:r})},playAnimation:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"找不到"}));const a=n.data[t.name];a?a.controller.setAnimationState(t,i):i&&i({result:0,message:"找不到"})},getArticulation:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"找不到"}));const a=n.data[t.name];if(!a)return void(i&&i({result:0,message:"找不到"}));const r=[];for(const e of a.controller.articulations)r.push({articulation:e.name,currentValue:e.defaultValue,type:"float",minValue:e.minState,maxValue:e.maxState});r.length<=0?i&&i({result:0,message:"找不到"}):i&&i({result:1,message:"成功",id:t.id,data:r})},setArticulation:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"找不到"}));const a=n.data[t.name];a?a.controller.setArticulationState(t,i):i&&i({result:0,message:"找不到"})},setTrail:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"不存在"}));const a=n.data[t.name];if(a){if(!a.trail){const e=_y.url(Ep.instance.resourceBasePath,"texture/trail/trail.png"),i=Ep.loaders.textureLoader.load(e);i.wrapS=m,i.wrapT=m,i.repeat.set(1,1);const n=new lb.MeshLineMaterial({fog:Uy,map:i,useMap:!0,color:new Qt("#ff0000"),opacity:1,resolution:new ye(window.innerWidth,window.innerHeight),sizeAttenuation:0,lineWidth:0,depthWrite:Ep.drawableDepthTest,depthTest:!0,alphaTest:0,transparent:!0,side:2,repeat:new ye(1,1),dashArray:0,dashOffset:1,dashRatio:0}),s=new Fi(new Ov.MeshLine,n);s.name=this.name,s.onBeforeRender=function(){this.userData.inView=!0},s.renderOrder=Ep.DRAWABLE_RENDER_ORDER_BASE+t.zLevel,r.add(s),a.trail=s,s.enableAutoHidebyDistance=!0,s.minDistance=a.minDistance,s.maxDistance=a.maxDistance,Ep.animationStore.addDistance(a.id+"Line",yy,Ep.camera,s),s.visible=a.visible,s.activeVisible=a.visible}a.trail.material.lineWidth=t.trackWidth*Ep.worldScale,a.controller.setTrail({duration:t.duration,position:t.position,isAutoRotation:t.isAutoRotation,trackStyle:t.trackStyle,trackDuration:t.trackDuration,trackWidth:t.trackWidth}),i&&i({result:1,message:"成功。"})}else i&&i({result:0,message:"不存在"})},setColor:function(t,i){const n=e[t.layer];if(!n)return void(i&&i({result:0,message:"不存在"}));const a=n.data[t.name];if(!a)return void(i&&i({result:0,message:"不存在"}));const r=a.iconModel;for(const e of r.meshes)e.setColorAt(a.index,new Qt(t.color)),e.instanceColor.needsUpdate=!0;for(const e of r.toggleMeshes)e.setColorAt(a.index,new Qt(t.color)),e.instanceColor.needsUpdate=!0}}}();var OE=new class{InstancedIconModelLandmarkInit(){RE.init()}addInstancedIconModelLandmark(e,t){RE.add(e,t)}updateInstancedIconModelLandmark(e,t){RE.update(e,t)}removeInstancedIconModelLandmark(e,t){RE.remove(e,t)}setInstancedIconModelLandmarkVisible(e,t){RE.setVisible(e,t)}getInstancedIconModelLandmarkInfo(e,t){return RE.getInfo(e,t)}setInstancedIconModelLandmarkShowBox(e,t){return RE.showBox(e,t)}setInstancedIconModelLandmarkTransform(e,t){RE.setTransform(e,t)}getInstancedIconModelLandmarkAnimation(e,t){RE.getAnimation(e,t)}playInstancedIconModelLandmarkAnimation(e,t){RE.playAnimation(e,t)}getInstancedIconModelLandmarkArticulation(e,t){RE.getArticulation(e,t)}setInstancedIconModelLandmarkArticulation(e,t){RE.setArticulation(e,t)}setInstancedIconModelLandmarkTrail(e,t){RE.setTrail(e,t)}setInstancedIconModelLandmarkColor(e,t){RE.setColor(e,t)}},DE=Object.freeze({__proto__:null,ModelsPartial:xE,ModelLandmark:SE,ModelTrail:TE,MarkerLandmark:EE,Trail:IE,StartLight:PE,instancedIconModelLandmark:OE});class LE{constructor(e){this.container=e,this.materialPreview={},this.materialPreview.renderer=new hr({antialias:!0,alpha:!0}),this.materialPreview.scene=new mr,this.materialPreview.renderer.setClearAlpha(0);const t=new Vl(16777215,1);this.materialPreview.scene.add(t);let i=new Gl(16777215,1),n=new Gl(16777215,.8),a=new Gl(16777215,.6);i.position.set(10,7,10),n.position.set(-10,2,10),a.position.set(0,0,-10),i.target.position.set(0,0,0),n.target.position.set(0,0,0),a.target.position.set(0,0,0),this.materialPreview.scene.add(i),this.materialPreview.scene.add(n),this.materialPreview.scene.add(a),this.materialPreview.camera=new Zi(50,e.getBoundingClientRect().width/e.getBoundingClientRect().height,.1,1e3),this.materialPreview.camera.position.set(0,0,2.37),this.materialPreview.renderer.setSize(e.getBoundingClientRect().width,e.getBoundingClientRect().height),e.appendChild(this.materialPreview.renderer.domElement),this.scene=this.materialPreview.scene,this.showType=null,this.models=new sr,this.scene.add(this.models),this.createSpherePreview()}createSpherePreview(e){let t=new Fi(new po(1,40,40),e);this.sphere=t,this.showType="sphere",this.models.add(t)}printScreen(e,t,i,n=[]){return new Promise((a=>{Ep.scene=this.materialPreview.scene,Ep.instance={},Ep.instance.resourceBasePath="."==window.SCENE_RESOURCE_BASE_PATH?"./lib/scene/":window.SCENE_RESOURCE_BASE_PATH,Ep.defaultObjectTree={children:[]},Ep.defaultObjectTree.getItemByUUID=()=>null,Ep.animationStore=new kT;let r=Ab._fromThreeObject(e);this.sphere.material=e,this.sphere.material.needsUpdate=!0,_y.setMaterialParam(t,r,i,n),_y.markObjectsNeedsUpdate(),Ep.animationStore.update(.136),this.materialPreview.renderer.render(this.materialPreview.scene,this.materialPreview.camera),this.materialPreview.renderer.domElement.toBlob((e=>{a(e)}))}))}dispose(){for(_y.disposeThreeObject(this.models),this.models.remove(this.sphere),this.models.remove(this.cylinder),this.models.remove(this.plane),this.models.remove(this.box),this.materialPreview.scene.traverse((function(e){if(e.isMesh)if(_objectCount--,e.geometry.dispose(),e.material instanceof Array)for(let t of e.material)t.dispose();else e.material.dispose();e.isSprite&&e.material.dispose()}));this.materialPreview.scene.children.length;)this.materialPreview.scene.remove(this.materialPreview.scene.children[0]);this.materialPreview.renderer.domElement&&this.container.removeChild(this.materialPreview.renderer.domElement),this.materialPreview.scene=null,this.materialPreview.camera=null,this.materialPreview.renderer.dispose(),this.materialPreview.renderer.forceContextLoss(),this.materialPreview.renderer.content=null;let e=this.materialPreview.renderer.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext(),this.materialPreview.renderer=null,this.materialPreview=null,Ep.scene=null,Ep.instance=null,Ep.animationStore=null,Ep.objectsNeedsUpdate=null}}let kE=new bw,NE=null,BE=(e,t,i)=>{for(let n in e)if(t[n]instanceof hy){for(let t in e[n])if(e[n][t.replace("_","")]=e[n][t],e[n][t.replace("_","")]instanceof Array);else if(e[n][t.replace("_","")]instanceof Object)for(let i in e[n][t.replace("_","")])e[n][t.replace("_","")][i.replace("_","")]=e[n][t.replace("_","")][i];switch(e[n].type){case"imagebitmap":let a="undefined"!=typeof ImageBitmap&&e[n].source instanceof ImageBitmap?e[n].source:void 0!==e[n].name?i.get(e[n].name)||Ep.customTextureStore.find(e[n].name):i.get(t.name+"#"+n);if(("metalnessMap"===n||"roughnessMap"===n)&&!a){let t="",r="";e.roughnessMap&&(r=e.roughnessMap.name||e.roughnessMap._name||""),e.metalnessMap&&(t=e.metalnessMap.name||e.metalnessMap._name||""),a=i.get(t+r),a||(a=i.get(r+t)),i.forEach((t=>{t.name.indexOf(e[n].name)>-1&&t.name.indexOf("#MetalnessAndRoughness#")>-1&&(a=t)}))}if(!a&&e[n].name&&0===e[n].name.indexOf("[[origin]]")){Ep.customTextureStore.loadTexture({url:e[n].name,name:e[n].name,onLoad:()=>{let a="undefined"!=typeof ImageBitmap&&e[n].source instanceof ImageBitmap?e[n].source:void 0!==e[n].name?i.get(e[n].name)||Ep.customTextureStore.find(e[n].name):i.get(t.name+"#"+n);t[n]={type:"imagebitmap",source:a,reset:!0}}}),console.log("可能加载的模型引用了自定义贴图，自定义贴图需要重新load");break}t[n]={type:"imagebitmap",source:a,reset:!0};break;case"color":e[n].reset=!0,t[n]=e[n];break;case"file":break;default:t[n]=e[n]}}else switch(n){case"normalMapType":t[n]="normal";break;case"type":case"mapType":t[n]="metalness";break;default:t[n]=e[n]}e.color&&(t.color=e.color)};class zE{constructor(e,t,i,n){this.loadedState=!1,this.progress={total:0,loaded:0},this.loading=!1;let a=new fS,r=[];if(a.setRequestHeader){let t={};t.Authorization="Bearer "+e.tokenValue,a.setRequestHeader(t)}for(let e in a.requestHeader)r.push({key:e,value:a.requestHeader[e]});this.then=async()=>{let s=[],o=[],l=new Map,c=new Map;await Ep.customTextureStore.applySettings(e.texture||[]),e.objectTree.children.forEach((e=>{if("ModelItem"==e.type){let n=e.modelPath.replace("[[origin]]",t);s.push(_y.fetchContentLength(n,r)),o.push(new Promise((t=>{a.load(n,(i=>{let n=new Map;i.scene.traverse((e=>{if(e.material){n.set(e.material.name,e.material);for(let t in e.material)e.material[t]instanceof we&&e.material[t].image&&l.set(e.material[t].name||`${e.material.name}#${t}`,Tb._fromThreeObject(e.material[t]))}})),t({gltf:i,objectItem:e,materialMap:n})}),(e=>{c.set(n,e.loaded);let t=0;c.forEach((e=>{t+=e})),this.progress.loaded=t,i&&i(this.progress)}),(()=>{}))}))),c.set(n,0)}})),this.loading=!0,Promise.all(s).then((e=>{if(e instanceof Array)for(let t of e)this.progress.total+=Number(t);Promise.all(o).then((e=>{let t=[];e.forEach((e=>{t.push(new Promise((t=>{if(e.objectItem.materials)for(var i in e.objectItem.materials){let t=e.materialMap.get(i),n=new Ab({materialOfThree:t,id:t.uuid,name:t.name,type:"metalness",mapType:"metalness",color:t.color,map:t.map,mapIntensit:t.mapIntensit,metalnessMap:t.metalnessMap,metalnessIntensity:t.metalness,roughnessMap:t.roughnessMap,roughnessIntensity:t.roughness,enableSpecularMap:!!t.envMap,specularMapType:t.envMap?"custom":"envmap",specularMap:t.envMap,specularMapIntensity:t.envMapIntensity/5,enableNormalMap:!!t.normalMap,normalMapType:"",normalMap:t.normalMap,normalMapFlipY:t.normalMapFlipY,normalMapIntensity:t.normalScale?t.normalScale.x:1,enableDisplacement:!!t.displacementMap,displacementMap:t.displacementMap,displacementIntensity:t.displacementScale,enableOpacity:t.transparent||!!t.alphaMap,opacityType:"blend",opacityMap:t.alphaMap,opacityIntensity:t.opacity,opacityInverted:!1,emissive:t.emissive,enableEmissive:!!t.emissiveMap||0!==t.emissive.r||0!==t.emissive.g||0!==t.emissive.b,emissiveMap:t.emissiveMap,emissiveIntensity:t.emissiveIntensity,enableLightMap:!!t.lightMap,lightMap:t.lightMap,lightMapIntensity:t.lightMapIntensity,enableSSR:t.enableSSR,envMapIntensity:t.envMapIntensity,side:t.side,depth:t.depthTest&&t.depthWrite?2:t.depthTest||t.depthWrite?1:0});BE(e.objectItem.materials[n.name],n,l)}e.gltf.scene.userData.dhAsset=JSON.parse(JSON.stringify(e.objectItem)),e.gltf.scene.traverse((e=>{e.geometry&&(e.geometry=new sn)}));let n={trs:!0,onlyVisible:!1,truncateDrawRange:!0,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:1/0};kE.parse(e.gltf.scene,(async i=>{if(i instanceof ArrayBuffer){let a=new Blob([i],{type:"application/octet-stream"}),r=null;if(1===e.materialMap.size)for(var n in e.objectItem.materials)r=await NE.printScreen(e.materialMap.get(n),e.objectItem.materials[n],l);_y.disposeThreeObject(e.gltf.scene),t({blob:a,name:e.objectItem.name,image:r})}}),n)})))})),Promise.all(t).then((e=>{this.loadedState=!0,this.loading=!1,n&&n(e)}))}))}))}}}let UE=new bw,FE=function(){let e,t,i,n,a,r=document.createElement("div");r.style.position="absolute",r.style.top="-250px",r.style.display="none",r.style.width="200px",r.style.height="200px";let s={renderer:e,scene:t,group:n,set:null,print:null};return setTimeout((()=>{document.body.append(r),r.style.display="block",e=new hr({antialias:!0,alpha:!0}),t=new mr,i=new Zi(50,1,.1,1e3);const o=new Vl(16777215,1);e.setClearAlpha(0),t.add(o),e.render(t,i);let l=new Gl(16777215,1),c=new Gl(16777215,.8),h=new Gl(16777215,.6);l.position.set(10,7,10),c.position.set(-10,2,10),h.position.set(0,0,-10),l.target.position.set(0,0,0),c.target.position.set(0,0,0),h.target.position.set(0,0,0),t.add(l),t.add(c),t.add(h),i.position.set(0,0,2.37),e.setSize(200,200),r.appendChild(e.domElement),n=new sr;let u=new po(1,40,40);a=new Fi(u),a.userData.dhAsset={materials:{}},n.add(a),t.add(n);let d=()=>{e.render(t,i),requestAnimationFrame(d)};d(),s.renderer=e,s.scene=t,s.group=n}),100),s.print=()=>new Promise((n=>{e.render(t,i),e.domElement.toBlob((e=>{n(e)}))})),s.set=(e,t)=>{a.material=e,a.userData.dhAsset.materials[e.name]=t,t.type,a.needsUpdate=!0},Ep.previewTextureStore=new hE,s}(),jE={opacityMap:"alphaMap",specularMap:"envMap"},HE=e=>{var t=document.createElement("canvas");return t.width=e.image.width,t.height=e.image.height,t.getContext("2d").drawImage(e.image,0,0,t.width,t.height),t.toDataURL()};const GE={Core:class{constructor(){Xo.enabled=!0;for(const e in DE){const t=DE[e];Object.getOwnPropertyNames(t.__proto__).filter((e=>"constructor"!==e)).forEach((e=>{this[e]=t[e].bind(t)}))}let e,t;Ep.util=_y,this.context=Ep,logger.debug("avw.scene.Core constructed.");let i,n,a=!1,r=!1,s=!0,o=!1,l=!1,c=!1,h={},u=!0,p=!0,g=!1,y=null,v={},b={},_=1,w=-1,S=new Ce(0,0,0),M=new ye(0,0),T=new Vc,A=0,E=new Vc,I="",P="",R=0,O=!1,D=null,L=null,k=new Ce,N=!1,B={},z=null,U=null,F=null,j=null,H={position:{x:0,y:0,z:0},rotation:{_x:0,_y:0,_z:0,_order:"XYZ"},scale:{x:1,y:1,z:1}},G=[],V=null,W=[],Y=null,X=null,Z=!0;Ep.sceneName="",Ep.currentMeshs=[],Ep.globalTextureMap=new Map,Ep.objectStore=e,Ep.eventHandlerStore=t,Ep.exporters=v,Ep.loaders=b,Ep.instance=this,Ep.background={},Ep.sceneSettings=null,Ep.ssr=[],Ep.envMapIntensity=[],Ep.copyModel=null,Ep.backgroundBlur=null,Ep.backgroundRotationY=null,Ep.background.colorCSSValue={type:"single",dataUrl:"",color1:"#3070a0",color2:"",gradientValue:""},Ep.background.textureURL={textureName:"MSE01Background-blue",customName:"",customDataUrl:"",imgType:"default"},Ep.worldScale=1,Ep.drawableDepthTest=!1,Ep.drawableEmissiveIntensity=1,Ep.drawableClickColor="#ffee00";let q={},J=null;this.container=void 0,this.resourceBasePath="./",this.defaultNodeSelection,this.defaultModelSelection,this.selectionControls,this.defaultEffectStore,this.defaultView,this.sysObjectStore,this.allState,this.notState;var Q=[];this.nextRender=function(e,t=1){Q.push({frameCount:t,callback:e})},this.onNextRender=function(e){Q.forEach((t=>{t.frameCount-=1,t.frameCount<0&&t.callback(e)}))},this.destroyNextRender=function(){Q=Q.filter((e=>e.frameCount>=0))},this.setPaused=function(e){a=e},this.setMark=(e,t)=>{!0===e&&this.container&&!Ep.markDom&&(Ep.markDom=document.createElement("div"),Ep.markDom.style="position: absolute;top:0;left:0;right:0;bottom: 0;background: #000000;z-index: 1;",t&&(Ep.markDom.innerText=t,Ep.markDom.style="\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: #000000;\n                z-index: 1;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                font-size: 25px;\n                color: #ffffff;\n              "),this.container.append(Ep.markDom)),!1===e&&this.container&&Ep.markDom&&(this.container.removeChild(Ep.markDom),Ep.markDom=null)},this.setMarkFreeze=()=>{!Ep.markCrossfade&&Ep.renderer&&(Ep.markDom||(Ep.markCrossfade=!0,K(),Ep.markDom=document.createElement("img"),Ep.markDom.style.position="absolute",Ep.markDom.style.height=Ep.renderer.domElement.clientHeight+"px",Ep.markDom.style.width=Ep.renderer.domElement.clientWidth+"px",Ep.markDom.style.left=Ep.renderer.domElement.clientLeft+"px",Ep.markDom.style.top=Ep.renderer.domElement.clientTop+"px",Ep.markDom.style.pointerEvents="none",Ep.markDom.src=Ep.renderer.domElement.toDataURL(),Ep.renderer.domElement.parentElement.appendChild(Ep.markDom)))},this.setMarkCrossfade=e=>{let t=this;if(!Ep.markCrossfade||Ep.onMarkCrossfade)return;Ep.onMarkCrossfade=!0;var i=.9;let n;e=e/60||10;let a=(new Date).getTime();function r(){Ep.markDom&&(n=((new Date).getTime()-a)/(e/10),(new Date).getTime()-a>100&&(n=100/(e/10)),a=(new Date).getTime(),i>0?(Ep.markDom.style.opacity=i-=.001*n,t.nextRender((()=>{r()}))):(Ep.markDom.parentElement.removeChild(Ep.markDom),Ep.markDom=null,Ep.markCrossfade=!1,Ep.onMarkCrossfade=!1))}this.nextRender((()=>{r()}))};var K=()=>{if(a)return Ep.targetCameraControls.update(Ep.deltaA),void Ep.orbitControls.update(Ep.deltaA);if(h.rS&&h.rS("frame").start(),h.rS&&h.rS("rAF").tick(),h.rS&&h.rS("FPS").frame(),h.rS&&h.rS("setup").start(),l&&i.update(Ep.deltaA),Ep.rafCallbacks instanceof Array)for(let e of Ep.rafCallbacks)e(Ep.deltaA),Ep.sceneBufferCacheExpired=!0;if(Ep.materialPreview&&Ep.materialPreview.hasRenderer&&Ep.materialPreview.renderer&&Ep.materialPreview.scene&&Ep.materialPreview.camera&&Ep.materialPreview.orbitControls&&(Ep.materialPreview.orbitControls.update(),Ep.materialPreview.renderer.render(Ep.materialPreview.scene,Ep.materialPreview.camera)),Ep.particlePreview&&Ep.particlePreview.hasRenderer&&Ep.particlePreview.renderer&&Ep.particlePreview.scene&&Ep.particlePreview.camera&&Ep.particlePreview.orbitControls&&(Ep.particlePreview.orbitControls.update(),Ep.particlePreview.renderer.render(Ep.particlePreview.scene,Ep.particlePreview.camera)),Ep.scene.traverse((e=>e.userData.inView=!1)),!Z)for(let e of Ep.animationMixers)e.update(Ep.deltaA),Ep.sceneBufferCacheExpired=!0;if(Ep.pgl.terrain&&Ep.pgl.terrain.draw(),Ep.animationStore.update(Ep.deltaA)&&(Ep.sceneBufferCacheExpired=!0),Ep.modelStore.updateAnimation(Ep.deltaA)&&(Ep.sceneBufferCacheExpired=!0),O)Ep.alpha&&Ep.renderer.getContext().clearColor(0,0,0,0),h.rS&&h.rS("setup").end(),this.passiveMode&&!Ep.sceneBufferCacheExpired||Ep.renderer.render(Ep.scene,Ep.cameraOrtho);else{if(Ep.instancedObjectStore){let e=Ep.instancedObjectStore.findInstancedObject("tree");if(e&&e.points instanceof Array){let t=.01+.02*Math.random();e.setPoints(t)}}t.update(),Ep.firstPersonControls.enabled?(Ep.firstPersonControls.update(Ep.deltaA),r=!0):(Ep.targetCameraControls.update(Ep.deltaA),Ep.orbitControls.update(Ep.deltaA)),Ep.sceneBufferCacheExpired=Ep.sceneBufferCacheExpired||r,h.rS&&h.rS("setup").end(),this.passiveMode&&Ep.sceneBufferCacheExpired&&1!==this.passiveModeRenderRate&&!r&&(++Ep.passiveModeRenderRateFrameCount<1/this.passiveModeRenderRate?Ep.sceneBufferCacheExpired=!1:Ep.passiveModeRenderRateFrameCount=0),r=!1;let e=this.passiveMode&&!Ep.sceneBufferCacheExpired;e?++Ep.passiveModeSkipFrameCount>60&&(e=!1,Ep.passiveModeSkipFrameCount=0):Ep.passiveModeSkipFrameCount=0,window.avwMinMode?Ep.renderer.render(Ep.scene,Ep.camera):Ep.composer.render(Ep.deltaA,e)}this._tilesRenderers&&this._tilesNeedRerender&&this._tilesRenderers.forEach((e=>{e.update()})),h.rS&&h.rS("focus").start(),Ep.effectStore.visualEffect.enableDOF&&"auto"===Ep.effectStore.visualEffect.dofFocus&&(A+=Ep.deltaA,A>=1&&(A=0,this.passiveMode&&!Ep.sceneBufferCacheExpired||this.focus())),h.rS&&h.rS("focus").end(),h.rS&&h.rS("frame").end(),h.rS&&h.rS("rStats").start(),h.rS&&h.rS().update(),h.rS&&h.rS("rStats").end(),Ep.statistics.update(),Ep.rendererInfo=Ep.statistics.getRendererInfo(Ep.renderer),Ep.renderer.info.reset(),Ep.deltaA=0,Ep.sceneBufferCacheExpired&&(Ep.sceneBufferCacheExpired=!1)},$=()=>{if(s)return;const e=Ep.clock.getDelta();if(Ep.deltaA+=e,Ep.deltaA<Ep.frameTimeLimit)return Ep.frameTimeGap<Ep.frameTimeLimit?void(this.frameId=requestAnimationFrame($.bind(this))):(K(),Ep.instance.onNextRender(),Ep.instance.destroyNextRender(),this.frameId=requestAnimationFrame($.bind(this)),void(Ep.frameTimeGap-=Ep.frameTimeLimit-e));Ep.deltaA<1&&(Ep.frameTimeGap+=Ep.deltaA-Ep.frameTimeLimit),K(),Ep.instance.onNextRender(Ep.deltaA),Ep.instance.destroyNextRender(),this.frameId=requestAnimationFrame($.bind(this))};let ne=()=>{T.setFromCamera(M,Ep.camera);let e=T.intersectObjects(Ep.scene.models.children,!0);if(logger.debug(`Picked ${e.length} objects at ${M.x}, ${M.y}.`),e.length>0){var t=e[0];t.distance>=0?(S.set(t.point.x,t.point.y,t.point.z),w=t.distance):(S.set(0,0,0),w=-1)}else S.set(0,0,0),w=-1;return M.set(0,0),w};this._pausePickInFocusObject=()=>{},this._resumePickInFocusObject=()=>{},this.pickObjectInFocus=()=>{ne()};let ae=(e,t)=>{let i=document.createElement("a");i.style.display="none",document.body.appendChild(i),i.href=URL.createObjectURL(e),i.download=t,i.click(),document.body.removeChild(i)},re=e=>`${this.resourceBasePath}///${e}`.replace("/////","/").replace("////","/").replace("///","/");this._exportScene=e=>{switch((e=e||"gltf").toLowerCase()){case"gltf":default:let e={trs:!0,onlyVisible:!1,truncateDrawRange:!1,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:1/0};logger.debug(Ep.scene),v.gltfExporter.parse(Ep.scene,(e=>{var t;e instanceof ArrayBuffer?(t="scene.glb",ae(new Blob([e],{type:"application/octet-stream"}),t)):((e,t)=>{ae(new Blob([e],{type:"text/plain"}),t)})(JSON.stringify(e,null,2),"scene.gltf")}),e)}};const se=async function(t,i,n,a){e.remove(t);var r=new sr;r.name=t,r.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),i.fillRepeat=i.fillRepeat||[1,1];let s=0;switch(i.fillType){case"top":s=1;break;case"bottom":s=-1;break;case"both":s=2;break;case"none":s=0}let o,l=[],c={lon:0,lat:0},h=0;if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){let e=[];for(var u=0;u<i.vectors.length;u++){let t=L.XYZToLLA(i.vectors[u]);e.push(t),l.push(new Ce(i.vectors[u].x,i.vectors[u].y,i.vectors[u].z))}let t=new ye(-1/0,-1/0),n=new ye(1/0,1/0);for(let i of e)t.x=Math.max(t.x,i.x),t.y=Math.max(t.y,i.y),n.x=Math.min(n.x,i.x),n.y=Math.min(n.y,i.y);c.lon=(t.x+n.x+360)/2-180,c.lat=(t.y+n.y)/2,console.log(c);let a=new it;a.makeRotationY(ge.degToRad(-90-c.lon));let r=new it;r.makeRotationX(ge.degToRad(c.lat-90));for(let e=0;e<l.length;e++)l[e].applyMatrix4(a),l[e].applyMatrix4(r),l[e].y=-l[e].z;let d=Pp.EARTH_RADIUS_EQUATOR,p=Pp.EARTH_RADIUS_POLAR,m=c.lat;if(0===m)h=d;else{let e=m/180*Math.PI;h=Math.sin(e)*p/Math.sin(Math.atan(Math.tan(e)*(p/d)))}h+=i.coordZ,o=new vE(l,i.depth*Ep.worldScale,1,!1,s,h)}else{for(u=0;u<i.point.length;u+=2)l.push(new ye(i.point[u],i.point[u+1]));l.push(new ye(i.point[0],i.point[1])),o=new yE(l,i.depth*Ep.worldScale,1,!1,s)}let p=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(p=!0);const{color:m,alpha:g}=i,y=new To({name:"fillMaterial",transparent:!0,fog:Uy,color:new Qt(m),emissive:new Qt(m),opacity:g,side:2,emissiveIntensity:1,depthWrite:p,depthTest:p});y.userData.defaultEmissiveIntensity=y.emissiveIntensity,y.emissiveIntensity*=Ep.drawableEmissiveIntensity;const v=i.fillArea.toLowerCase();if("none"===v)y.opacity=1;else if("solid01"===v)y.opacity=.2;else if("solid02"===v)y.opacity=.4;else if("solid03"===v)y.opacity=.6;else if("solid04"===v)y.opacity=.8;else if("solid05"===v)y.opacity=1;else{const e=re(`texture/area/fill/${v}.jpg`),t=await ce(e);t.wrapS=d,t.wrapT=d;const n=Math.max(...l.map((e=>e.x)))-Math.min(...l.map((e=>e.x))),a=Math.max(...l.map((e=>e.y)))-Math.min(...l.map((e=>e.y)));t.repeat.set(n/t.image.height*2,1),y.map=t,y.alphaMap=t;let r=0,s=0;if("gradient01"===v)r=1/6,t.repeat.set(30*n/t.image.height,1);else if("gradient02"===v)r=1/6,t.repeat.set(30*n/t.image.height,1);else if("grid01"===v){r=1/6;const e=25*n/t.image.height,i=22*a/t.image.height;t.repeat.set(e,i)}else if("grid02"===v){r=1/6;const e=25*n/t.image.height,i=14*a/t.image.height;t.repeat.set(e,i)}else if("Segment01"===i.fillArea){r=1/6;const e=25*n/t.image.height,i=14*a/t.image.height;t.repeat.set(e,i)}else if("Segment02"===i.fillArea){s=-1/6;const e=90*n/t.image.height,i=10*a/t.image.height;t.repeat.set(e,i)}const o=new nv(y,!0,!0,-r,s);Ep.animationStore.add(o)}const b=i.areaType.toLowerCase(),_=re(`texture/area/${b}.jpg`),x=await ce(_);x.flipY=!1,x.wrapS=d,x.wrapT=d,x.repeat.set(Math.ceil(o.sideWallSegments)||1,1);const w=new To({name:"sideMaterial",map:x,alphaMap:x,fog:Uy,transparent:!0,color:new Qt(m),emissive:new Qt(m),opacity:i.alpha,side:2,emissiveIntensity:1,depthWrite:p,depthTest:p});w.userData.defaultEmissiveIntensity=w.emissiveIntensity,w.emissiveIntensity*=Ep.drawableEmissiveIntensity;let S=0,M=0;"arrow01"===b?(S=1/6,x.repeat.set(Math.ceil(o.sideWallSegments)||1,1)):"gradient01"===b||("gradient02"===b?M=1/6:"gradient03"===b||("grid01"===b?x.repeat.set(Math.ceil(o.sideWallSegments/2)||1,1):"Grid02"===i.areaType?M=-1/6:"grid03"===b?M=1/6:"Grid04"===i.areaType?M=-1/6:"Grid05"===i.areaType?(M=1/6,x.wrapS=f,x.repeat.set(Math.ceil(o.sideWallSegments)||1,1)):"segment01"===b?(S=1,x.repeat.set(Math.ceil(1.3*o.sideWallSegments)||1,1)):"Segment02"===i.areaType?(x.repeat.set(1,.5),M=1/12):"Segment03"===i.areaType&&(S=-1/6)));const T=new nv(w,!0,!0,-S,M);Ep.animationStore.add(T);let A=null;switch(i.fillType){case"top":case"bottom":A=new Fi(o,[w,y]);break;case"both":A=new Fi(o,[w,y,y]);break;case"none":A=new Fi(o,[w])}if(A.onBeforeRender=function(){this.userData.inView=!0},A.name=t,r.add(A),r.visible=i.isShow,r.activeVisible=i.isShow,e.add(t,r),null!=i.enableAutoHidebyDistance&&(r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.minDistance*Ep.worldScale,r.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r)),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){if(y.polygonOffset=!0,y.polygonOffsetFactor=.1,y.polygonOffsetUnits=-4,A.position.y+=Ep.datumShiftModel.scaleX*h,i.isCircular){let e=c.lat;0===e&&(e=.001),A.scale.z/=Math.cos(ge.degToRad(90-e))}r.rotation.set(ge.degToRad(90-c.lat),ge.degToRad(c.lon-270),0,"YXZ")}else{i.offset&&r.position.set(i.lonOffset,i.altOffset+i.alt,i.latOffset),o.computeBoundingSphere();const e=o.boundingSphere.center;r.position.x+=e.x,r.position.y+=e.y,r.position.z+=e.z,A.position.x-=e.x,A.position.y-=e.y,A.position.z-=e.z}r.userData.center=r.position.clone(),a&&a(r)},oe=function(e){return new Promise((t=>{const i=new Image;i.setAttribute("crossOrigin","anonymous"),i.src=e,i.onload=function(){t(i)},i.onerror=function(){t()}}))},le=function({target:e}={}){if(!Ep.compass||!Ep.compass.canvas)return;let t=Ep.compass.canvas,i=t.getContext("2d"),n=180/Math.PI*e.getAzimuthalAngle();n=(n+360)%360;const a=Ep.compass.size,r=Ep.renderer.domElement.scrollHeight,s=Ep.renderer.domElement.scrollWidth,o=a<r?a:r<s?r:s;let l=Ep.compass.dialPlate,c=Ep.compass.pointer;t.width=o,t.height=o,i.translate(t.width/2,t.height/2),i.rotate(Math.PI/180*n),i.translate(-t.width/2,-t.height/2);let h=t.width/2-o/2,u=t.height/2-o/2;i.drawImage(l,h,u,o,o),i.translate(t.width/2,t.height/2),i.rotate(Math.PI/180*-n),i.translate(-t.width/2,-t.height/2),i.restore(),i.drawImage(c,0,0,o,o)},ce=function(e){return new Promise((t=>{Ep.loaders.textureLoader.load(e,(function(e){t(e)}))}))};Ep.billboardBeforeCompile=function(e,t){let i=e.vertexShader;i=i.replace("vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;","\n        vec2 xyPosition = ( position.xy - ( center - vec2( 0.5 ) ) );\n\n        #ifndef USE_SIZEATTENUATION\n      \n          bool isPerspective = isPerspectiveMatrix( projectionMatrix );\n          if ( isPerspective ) {\n            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n            xyPosition *= - mvPosition.z;\n          }\n       \n        #endif\n      \n        vec2 rotatedPosition;\n        rotatedPosition.x = cos( rotation ) * xyPosition.x - sin( rotation ) * xyPosition.y;\n        rotatedPosition.y = sin( rotation ) * xyPosition.x + cos( rotation ) * xyPosition.y;\n      \n        mat4 m = projectionMatrix * modelViewMatrix;\n        gl_Position = m * vec4( rotatedPosition.x, rotatedPosition.y, position.z, 1.0 );\n        "),e.vertexShader=i},Ep.billboardRaycast=function(e,t){const i=this.geometry.attributes.position.count,n=this.geometry.attributes.position.itemSize,a=new ti(new Float32Array(n*i),n),r=new Ce;for(let t=0;t<i;t++){r.fromBufferAttribute(this.geometry.attributes.position,t),a.setXYZ(t,r.x,r.y,r.z);let i=r.x-(this.center.x-.5),n=r.y-(this.center.y-.5);if(e.camera.isPerspectiveCamera){this.updateMatrixWorld(),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld);const t=new Ce;t.setFromMatrixPosition(this.modelViewMatrix),i*=-t.z,n*=-t.z}const s=this.material.rotation,o=Math.cos(s)*i-Math.sin(s)*n,l=Math.sin(s)*i+Math.cos(s)*n;this.geometry.attributes.position.setXYZ(t,o,l,r.z)}(new Fi).raycast.call(this,e,t);for(let e=0;e<i;e++)r.fromBufferAttribute(a,e),this.geometry.attributes.position.setXYZ(e,r.x,r.y,r.z)},this.resetParticleState=()=>{Ep.defaultObjectTree.children.forEach((e=>{e.particleStoreArray&&e.particleStoreArray.map((e=>{e.resetAll()}))}))},this.focusRoom=(e,t,i)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let n,a,r=Ep.instance.defaultObjectTree.getItemByName(e.buildingId);if(!r)return void(t&&t({result:0,message:"建筑不存在"}));if("BuildingItem"!==(Ep.instance.defaultObjectTree.findItemByObject3D(r.getGroup())||{}).getType())return void(t&&t({result:0,message:"指定的对象非建筑"}));if(r.children.forEach((t=>{t.level===Number(e.floor)&&(n=t)})),!n)return void(t&&t({result:0,message:"楼层号不存在"}));for(const t of n.children)t.name===e.room&&(a=t);if(!a)return void(t&&t({result:0,message:"房间不存在"}));let s={nameRoom:e.room,floor:e.floor,idBuilding:e.buildingId};i.onFocusRoomStart&&i.onFocusRoomStart(s),this.setCameraToModel(void 0,e.duration,{distance:e.distance},void 0,(()=>{i.onFocusRoomEnd&&i.onFocusRoomEnd(s)}),a.getGroup()),t&&t({result:1,message:"成功。"})},this.yzExChange=e=>{const t=[];let i,n,a;for(let t=0;t<e.length;t++){const r=e[t];"Z"==r?i=t:"Y"==r?n=t:"X"==r&&(a=t)}return t[a]="X",t[n]="Z",t[i]="Y",`${t[0]}${t[1]}${t[2]}`},this.yzPositionChange=e=>({x:e.x,y:e.z,z:e.y}),this.addConnection=(e,t,i)=>{if(t.startOffset&&(t.startOffset=this.yzPositionChange(t.startOffset)),t.finalOffset&&(t.finalOffset=this.yzPositionChange(t.finalOffset)),t.unuseParent=!0,"straight"==t.shapeType?(t.connectType="straight",t.curvature=0):"curve"==t.shapeType?t.connectType="straight":"angle90"==t.shapeType&&(t.connectType="norm"),t.type)if("ModelCylinder"==t.type)t.styleType="geometryLine",t.alphas=!1,t.color=null;else if("ModelCube"==t.type)t.styleType="geometryLine",t.sectionAccuracy=4,t.angle=Math.PI/4,t.alphas=!1,t.color=null;else{t.styleType="faceLine",t.alphas=!0;let e=`texture/path/${t.type.toLowerCase()}.jpg`;t.defaultTexture=_y.url(this.resourceBasePath,e),t.texture=null}t.angleOrder&&(t.angleOrder=this.yzExChange(t.angleOrder),t.SPLStyle=t.angleOrder),t.isShow&&(t.isVisible=t.isShow),t.width&&(t.radius=t.width),t.textureSpeed&&(t.textureSpeed=-t.textureSpeed),t.curvature&&(t.curvature*=100),t.used="interface",Ep.defaultObjectTree.addLineItem(t,((e,n)=>{t.curvature&&("straight"==t.shapeType?n.curvature=0:"curve"==t.shapeType&&(n.curvature=t.curvature)),n.smoothness=100,t.autoScale?n.sizeView=!1:n.sizeView=!0,n.useTexture(t.texture?t.texture:t.defaultTexture,t.alphas),n.useAlphaTexture(t.texture?t.texture:t.defaultTexture,t.alphas);let a=0;"arrow01"===t.type.toLowerCase()||"arrow02"===t.type.toLowerCase()||"arrow03"===t.type.toLowerCase()||"arrow04"===t.type.toLowerCase()?a=t.width*Ep.worldScale*1.3/1:"arrow05"===t.type.toLowerCase()?a=t.width*Ep.worldScale*1.5/1:"arrow06"===t.type.toLowerCase()?a=t.width*Ep.worldScale*5/1:"arrow07"===t.type.toLowerCase()?a=t.width*Ep.worldScale*1.3/1:"segment01"===t.type.toLowerCase()?a=t.width*Ep.worldScale*15/1:"segment02"===t.type.toLowerCase()||"segment03"===t.type.toLowerCase()?a=t.width*Ep.worldScale*30/1:"segment04"===t.type.toLowerCase()?a=t.width*Ep.worldScale*15/1:"segment05"===t.type.toLowerCase()||"segment06"===t.type.toLowerCase()?a=0:("segment07"===t.type.toLowerCase()||"segment08"===t.type.toLowerCase())&&(a=t.width*Ep.worldScale*1.5/1);let r=Ep.animationStore.findMaterialAnimation(n.getModelLine().mesh.material,nv.type);if(r)r.enableU=!0,r.enableV=!0,r.uSpeed=t.textureSpeed?t.textureSpeed:a,r.vSpeed=0;else{let e=new nv(n.getModelLine().mesh.material,!0,!0,t.textureSpeed,0);Ep.animationStore.add(e)}"function"==typeof i&&i(n)}))},this.updateConnection=(e,t,i)=>{"straight"==t.shapeType&&(t.curvature=0),t.startOffset&&(t.startOffset=this.yzPositionChange(t.startOffset)),t.finalOffset&&(t.finalOffset=this.yzPositionChange(t.finalOffset)),t.unuseParent=!0,t.used="interface","straight"==t.shapeType&&(t.curvature=0),t.curvature&&(t.curvature*=100),t.textureSpeed&&(t.textureSpeed=-t.textureSpeed);const n=Ep.defaultObjectTree.findItemByName(e);if(n){if(t.type)if("ModelCylinder"==t.type)n.styleType="geometryLine",t.alphas=!1,t.color=null;else if("ModelCube"==t.type)t.styleType="geometryLine",t.sectionAccuracy=4,t.angle=Math.PI/4,t.alphas=!1,t.color=null;else{n.styleType="faceLine",t.alphas=!0;let e=`texture/path/${t.type.toLowerCase()}.jpg`;t.defaultTexture=_y.url(this.resourceBasePath,e),t.texture=t.defaultTexture}n.applySetting(t,(e=>{"straight"==t.shapeType?(n.connectType="straight",n.curvature=0):"curve"==t.shapeType?n.connectType="straight":"angle90"==t.shapeType&&(n.connectType="norm"),t.angleOrder&&(t.angleOrder=this.yzExChange(t.angleOrder),n.SPLStyle=t.angleOrder),1==t.isShow?n.show():0==t.isShow&&n.hide(),t.width&&(n.radius=t.width),t.curvature&&("straight"==t.shapeType?n.curvature=0:"curve"==t.shapeType&&(n.curvature=t.curvature)),t.autoScale?e.sizeView=!1:e.sizeView=!0,e.smoothness=100,e.useTexture(t.texture?t.texture:t.defaultTexture,t.alphas),e.useAlphaTexture(t.texture?t.texture:t.defaultTexture,t.alphas);let a=0;"arrow01"===t.type.toLowerCase()||"arrow02"===t.type.toLowerCase()||"arrow03"===t.type.toLowerCase()||"arrow04"===t.type.toLowerCase()?a=t.width*Ep.worldScale*1.3/1:"arrow05"===t.type.toLowerCase()?a=t.width*Ep.worldScale*1.5/1:"arrow06"===t.type.toLowerCase()?a=t.width*Ep.worldScale*5/1:"arrow07"===t.type.toLowerCase()?a=t.width*Ep.worldScale*1.3/1:"segment01"===t.type.toLowerCase()?a=t.width*Ep.worldScale*15/1:"segment02"===t.type.toLowerCase()||"segment03"===t.type.toLowerCase()?a=t.width*Ep.worldScale*30/1:"segment04"===t.type.toLowerCase()?a=t.width*Ep.worldScale*15/1:"segment05"===t.type.toLowerCase()||"segment06"===t.type.toLowerCase()?a=0:("segment07"===t.type.toLowerCase()||"segment08"===t.type.toLowerCase())&&(a=t.width*Ep.worldScale*1.5/1);let r=Ep.animationStore.findMaterialAnimation(e.getModelLine().mesh.material,nv.type);if(r)r.enableU=!0,r.enableV=!0,r.uSpeed=t.textureSpeed?t.textureSpeed:a,r.vSpeed=0;else{let i=new nv(e.getModelLine().mesh.material,!0,!0,t.textureSpeed,0);Ep.animationStore.add(i)}"function"==typeof i&&i({result:1,message:"更新成功"})}))}else console.warn("没有找到需要更新的对应的模型线，请检查name"),"function"==typeof i&&i({result:0,message:`失败，${t.id} 未找到。`})},this.addModelPath=(e,t,i)=>{if(t.unuseParent=!0,t.name=e,"straight"==t.shapeType?(t.connectType="straight",t.curvature=0):"curve"==t.shapeType?t.connectType="straight":"angle90"==t.shapeType&&(t.connectType="norm"),t.used="interface",console.log("addModelPath",e,t,i),t.type)if("ModelCylinder"==t.type)t.styleType="geometryLine",t.alphas=!1,t.color=null;else if("ModelCube"==t.type)t.styleType="geometryLine",t.sectionAccuracy=4,t.angle=Math.PI/4,t.alphas=!1,t.color=null;else{t.styleType="faceLine",t.alphas=!0;let e=`texture/path/${t.type.toLowerCase()}.jpg`;t.defaultTexture=_y.url(this.resourceBasePath,e),t.texture=null}t.width&&(t.radius=t.width);let n=[];if(t.points){for(let e=0,i=t.points.length;e<i;e++){const i=[t.points[e].x,t.points[e].y,t.points[e].z];n.push(i)}2==t.points.length&&(n.push([0,0,0]),t.curvature=0)}t.textureSpeed&&(t.textureSpeed=-t.textureSpeed),Ep.defaultObjectTree.addLineItem(t,((e,a)=>{a.smoothness=100,a.usePoint(n),t.autoScale?a.sizeView=!1:a.sizeView=!0,a.useTexture(t.texture?t.texture:t.defaultTexture,t.alphas),a.useAlphaTexture(t.texture?t.texture:t.defaultTexture,t.alphas);"arrow01"===t.type.toLowerCase()||"arrow02"===t.type.toLowerCase()||"arrow03"===t.type.toLowerCase()||"arrow04"===t.type.toLowerCase()||"arrow05"===t.type.toLowerCase()||"arrow06"===t.type.toLowerCase()||"arrow07"===t.type.toLowerCase()||"segment01"===t.type.toLowerCase()||"segment02"===t.type.toLowerCase()||"segment03"===t.type.toLowerCase()||"segment04"===t.type.toLowerCase()?(t.width,Ep.worldScale):"segment05"===t.type.toLowerCase()||"segment06"===t.type.toLowerCase()||("segment07"===t.type.toLowerCase()||"segment08"===t.type.toLowerCase())&&(t.width,Ep.worldScale);let r=Ep.animationStore.findMaterialAnimation(a.getModelLine().mesh.material,nv.type);if(r)r.enableU=!0,r.enableV=!0,r.uSpeed=t.textureSpeed,r.vSpeed=0;else{let e=new nv(a.getModelLine().mesh.material,!0,!0,t.textureSpeed,0);Ep.animationStore.add(e)}"function"==typeof i&&i(a)}))},this.updateModelPath=(e,t,i)=>{if(t.unuseParent=!0,t.used="interface",console.log("updateModelPath",e,t,i),"straight"==t.shapeType&&(t.curvature=0),t.curvature&&(t.curvature*=100),t.textureSpeed&&(t.textureSpeed=-t.textureSpeed),t.type)if("ModelCylinder"==t.type)a.styleType="geometryLine",t.alphas=!1,t.color=null;else if("ModelCube"==t.type)t.styleType="geometryLine",t.sectionAccuracy=4,t.angle=Math.PI/4,t.alphas=!1,t.color=null;else{a.styleType="faceLine",t.alphas=!0;let e=`texture/path/${t.type.toLowerCase()}.jpg`;t.defaultTexture=_y.url(this.resourceBasePath,e),t.texture=t.defaultTexture}t.width&&(t.radius=t.width);let n=[];if(t.points)for(let e=0,i=t.points.length;e<i;e++){const i=[t.points[e].x,t.points[e].y,t.points[e].z];n.push(i)}const a=Ep.defaultObjectTree.findItemByName(e);a?a.applySetting(t,(e=>{"straight"==t.shapeType?(a.connectType="straight",t.curvature=0):"curve"==t.shapeType?a.connectType="straight":"angle90"==t.shapeType&&(a.connectType="norm"),t.curvature&&("straight"==t.shapeType?a.curvature=0:"curve"==t.shapeType&&(a.curvature=t.curvature)),t.autoScale?e.sizeView=!1:e.sizeView=!0,e.smoothness=100,e.usePoint(n),e.useTexture(t.texture?t.texture:t.defaultTexture,t.alphas),e.useAlphaTexture(t.texture?t.texture:t.defaultTexture,t.alphas);"arrow01"===t.type.toLowerCase()||"arrow02"===t.type.toLowerCase()||"arrow03"===t.type.toLowerCase()||"arrow04"===t.type.toLowerCase()||"arrow05"===t.type.toLowerCase()||"arrow06"===t.type.toLowerCase()||"arrow07"===t.type.toLowerCase()||"segment01"===t.type.toLowerCase()||"segment02"===t.type.toLowerCase()||"segment03"===t.type.toLowerCase()||"segment04"===t.type.toLowerCase()?(t.width,Ep.worldScale):"segment05"===t.type.toLowerCase()||"segment06"===t.type.toLowerCase()||("segment07"===t.type.toLowerCase()||"segment08"===t.type.toLowerCase())&&(t.width,Ep.worldScale);let r=Ep.animationStore.findMaterialAnimation(e.getModelLine().mesh.material,nv.type);if(r)r.enableU=!0,r.enableV=!0,r.uSpeed=t.textureSpeed,r.vSpeed=0;else{let i=new nv(e.getModelLine().mesh.material,!0,!0,t.textureSpeed,0);Ep.animationStore.add(i)}"function"==typeof i&&i(e)})):console.warn("没有找到需要更新的对应的路径线，请检查name")},this.setCameraModeToFlay=(e,t)=>{if(this.offFirstPersonMode(),"default"===e.mode)return void(t&&t(1));const i=e=>{this.off("click","scene",i),n({x:e.clickX,y:e.clickY,z:e.clickZ})},n=i=>{const n=this.getCamera();void 0===i.x&&(i.x=n.targetX,i.z=n.targetZ),this.cameraFlyTo(i,-5,n.inclinationAngle,1,.5,!0,(()=>{this.onFirstPersonMode({movementSpeed:e.speed,lookSpeed:e.turnSpeed,isWalk:"fly"!==e.mode,eyesHeight:e.eyesHeight}),t&&t(1)}))};!0===e.choicePoint?this.on("click","scene",i):n({y:e.eyesHeight*Ep.worldScale})},this.onPointerMove=function(e){Ep.orbitControls.onPointerMove(e)},this.cameraFollowing=function({type:t,name:i,distance:n,pitch:a,heading:r}){let s,o=Ep.animationStore.findAnimation(Qv.type,Qv.type);if(void 0===o&&(o=new Qv(Qv.type),Ep.animationStore.add(o)),Ep.orbitControls.enablePan=!1,"model"===t){s=this.defaultObjectTree.getItemByName(i).getGroup()}else{if("drawable"!==t)return;s=e.find(i)}o.set(s,n,a,r)},this.cameraFollowingStState=function(e,t){let i=Ep.animationStore.findAnimation(Qv.type,Qv.type);if(void 0!==i){if("pause"===e)i.pause(),Ep.orbitControls.enablePan=!0;else if("continue"===e)i.resume(),Ep.orbitControls.enablePan=!1;else{if("stop"!==e)return void(t&&t({result:0,message:"参数错误"}));Ep.animationStore.remove(i),Ep.orbitControls.enablePan=!0}t&&t({result:1,message:"成功。"})}else t&&t({result:0,message:"没有动画"})},this.addEventListener=function(e,t,i){if("transformControls"==e&&Ep.transformControls.addEventListener(t,i),"axesTransformControls"==e&&Ep.axesTransformControls.addEventListener(t,i),"modelSelection"==e){const e=this.defaultModelSelection[t];e.includes(i)||e.push(i)}},this.removeEventListener=function(e,t,i){if("transformControls"==e&&Ep.transformControls.removeEventListener(t,i),"axesTransformControls"==e&&Ep.axesTransformControls.removeEventListener(t,i),"modelSelection"==e){const e=this.defaultModelSelection[t];if(e.includes(i)){const t=e.indexOf((e=>e===i));e.splice(t,1)}}},this.transformObject=function({drawables:t,axisType:i,relative:n,unit:a,isIconModel:r},s){if(void 0!==a&&Ep.transformControls.setTranslationSnap(a),void 0!==i&&("transform"===i&&(i="translate"),"rotation"===i&&(i="rotate"),this.transformControls.setMode(i)),r){const e=[];for(const i of t){const t=this.getInstancedIconModelLandmarkInfo({name:i});if(!t)return void(s&&s({result:0,message:"不存在"}));const n=new Ce,a=new Ee,r=new Ce;t.data.matrix.decompose(n,a,r),e.push({box:t.data.box.clone(),matrix:t.data.matrix.clone(),position:n,rotation:a,scale:r,layer:t.layer.name,name:t.data.name,id:t.id})}return this.defaultModelSelection.setAxisType(n),void this.defaultModelSelection.selectObjectInstanced(e)}const o=e.find(t[0]);o?(Ep.transformControls.setMode("translate"),Ep.transformControls.attach(o),s&&s({result:1,message:"成功。"})):s&&s({result:0,message:"失败，没有对应绘制物实体。"})},this.untransformObject=function(){Ep.transformControls.detach()},this.domElement=function(){return Ep.renderer.domElement},this.setCompass=async function({isShow:e=!0,hor:t="right",ver:i="top",offset:n=[0,0],size:a=1}={}){let r=document.getElementById("compass");if(!e&&!r)return;if(!e&&r)return Ep.orbitControls.removeEventListener("change",le),this.container.removeChild(r),void(Ep.compass.canvas=void 0);if(!r){r=document.createElement("canvas"),r.setAttribute("id","compass"),r.style.position="absolute",r.style.pointerEvents="none",this.container.appendChild(r);let e=new Image;e.src=_y.url(this.resourceBasePath,"./texture/compass/DialPlate.png"),e.onload=()=>{Ep.compass={dialPlate:e},e=new Image,e.src=_y.url(this.resourceBasePath,"./texture/compass/Pointer.png"),e.onload=()=>{Ep.compass.pointer=e,Ep.compass.size=a,Ep.compass.canvas=r,le({target:Ep.orbitControls}),Ep.orbitControls.addEventListener("change",le)}}}let s=n[0],o=n[1];r.style.transform="unset",r.style.left="unset",r.style.right="unset",r.style.top="unset",r.style.bottom="unset","left"===t?r.style.left=`${s}px`:"right"===t&&(r.style.right=-s+"px"),"top"===i?r.style.top=`${o}px`:"bottom"===i&&(r.style.bottom=-o+"px"),"center"===t&&"center"===i?(r.style.left=`calc(50% + ${s}px)`,r.style.top=`calc(50% + ${o}px)`,r.style.transform="translate(-50%, -50%)"):"center"===t?(r.style.left=`calc(50% + ${s}px)`,r.style.transform="translate(-50%, 0)"):"center"===i&&(r.style.top=`calc(50% + ${o}px)`,r.style.transform="translate(0, -50%)"),Ep.compass&&(Ep.compass.size=a,le({target:Ep.orbitControls}))},this.setWatermark=async function(e=[],t){let i=[];Array.isArray(e)||(e=[e]);const a=e;e=[];for(const t of a){let n=await oe(t.src);n?(t.img=n,e.push(t)):i.push(t.src)}if(i.length>0)return void(t&&t(0,`${i.join("、")} 图片加载失败。`));let r=n.width,s=n.height,o=document.createElement("canvas");o.setAttribute("width",r),o.setAttribute("height",s);let l=o.getContext("2d");for(const t of e){let e=t.img.width*t.scale,i=t.img.height*t.scale,n=0;"right"===t.hor?n=r-e:"center"===t.hor&&(n=r/2-e/2);let a=0;"bottom"===t.ver?a=s-i:"center"===t.ver&&(a=s/2-i/2),n+=t.offset[0],a+=t.offset[1],l.globalAlpha=t.alpha,l.drawImage(t.img,n,a,e,i)}try{let e=o.toDataURL("image/png");Ep.effectStore.visualEffect.watermark=e}catch(e){return void(t&&t(0,`生成水印失败：${e} 。`))}t&&t(1,{})},this.endSelectDrawable=function(){Ep.selectControl.endSelectDrawable(...arguments)},this.selectDrawable=function(){Ep.selectControl.startSelectDrawable(...arguments)},this.getModelBox=function(e){let t=this.defaultObjectTree.getItemByName(e).getGroup(),i=new Re;return i.setFromObject(t),i},this.restrictCamera=function(e,t){null===J&&(J={},J.default={minDistance:Ep.orbitControls.minDistance,maxDistance:Ep.orbitControls.maxDistance,minPolarAngle:Ep.orbitControls.minPolarAngle,maxPolarAngle:Ep.orbitControls.maxPolarAngle,minAzimuthAngle:Ep.orbitControls.minAzimuthAngle,maxAzimuthAngle:Ep.orbitControls.maxAzimuthAngle,targetLimit:{limitHeight:Ep.orbitControls.targetLimit.limitHeight,center:Ep.orbitControls.targetLimit.center,radius:Ep.orbitControls.targetLimit.radius},isUse:!0},J.custom={minDistance:Ep.orbitControls.minDistance,maxDistance:Ep.orbitControls.maxDistance,minPolarAngle:Ep.orbitControls.minPolarAngle,maxPolarAngle:Ep.orbitControls.maxPolarAngle,minAzimuthAngle:Ep.orbitControls.minAzimuthAngle,maxAzimuthAngle:Ep.orbitControls.maxAzimuthAngle,targetLimit:{limitHeight:Ep.orbitControls.targetLimit.limitHeight,center:Ep.orbitControls.targetLimit.center,radius:Ep.orbitControls.targetLimit.radius},isUse:!1});const{limitDistance:i}=e;J.custom.minDistance=i[0]/Ep.worldScale,J.custom.maxDistance=i[1]/Ep.worldScale;const{limitPitch:n}=e;let a=ge.degToRad(90-n[1]);J.custom.minPolarAngle=a;let r=ge.degToRad(90-n[0]);J.custom.maxPolarAngle=r;const{limitYaw:s}=e;180==s[0]&&(s[0]+=1e-4),s[0]=(s[0]+180)%360-180,s[0]=ge.degToRad(s[0]),isNaN(s[0])&&(s[0]=-1/0),J.custom.minAzimuthAngle=s[0],180==s[1]&&(s[1]+=1e-4),s[1]=(s[1]+180)%360-180,s[1]=ge.degToRad(s[1]),isNaN(s[1])&&(s[1]=1/0),J.custom.maxAzimuthAngle=s[1];const{limitHeight:o,center:l,radius:c}=e,h=J.custom.targetLimit;h.limitHeight=[o[0]/Ep.worldScale,o[1]/Ep.worldScale],h.center=l,h.radius=c/Ep.worldScale,J.custom.isUse&&Ep.instance.setCameraRestrictionState(!0),t&&t({result:1,message:"成功。"})},this.setCameraRestrictionState=function(e,t){if(null===J&&(J={},J.default={minDistance:Ep.orbitControls.minDistance,maxDistance:Ep.orbitControls.maxDistance,minPolarAngle:Ep.orbitControls.minPolarAngle,maxPolarAngle:Ep.orbitControls.maxPolarAngle,minAzimuthAngle:Ep.orbitControls.minAzimuthAngle,maxAzimuthAngle:Ep.orbitControls.maxAzimuthAngle,targetLimit:{limitHeight:Ep.orbitControls.targetLimit.limitHeight,center:Ep.orbitControls.targetLimit.center,radius:Ep.orbitControls.targetLimit.radius},isUse:!0},J.custom={minDistance:Ep.orbitControls.minDistance,maxDistance:Ep.orbitControls.maxDistance,minPolarAngle:Ep.orbitControls.minPolarAngle,maxPolarAngle:Ep.orbitControls.maxPolarAngle,minAzimuthAngle:Ep.orbitControls.minAzimuthAngle,maxAzimuthAngle:Ep.orbitControls.maxAzimuthAngle,targetLimit:{limitHeight:Ep.orbitControls.targetLimit.limitHeight,center:Ep.orbitControls.targetLimit.center,radius:Ep.orbitControls.targetLimit.radius},isUse:!1}),e){const e=J.custom;Ep.orbitControls.minDistance=e.minDistance,Ep.orbitControls.maxDistance=e.maxDistance,Ep.orbitControls.minPolarAngle=e.minPolarAngle,Ep.orbitControls.maxPolarAngle=e.maxPolarAngle,Ep.orbitControls.minAzimuthAngle=e.minAzimuthAngle,Ep.orbitControls.maxAzimuthAngle=e.maxAzimuthAngle,Ep.orbitControls.targetLimit=e.targetLimit,J.custom.isUse=!0,J.default.isUse=!1}else{const e=J.default;Ep.orbitControls.minDistance=e.minDistance,Ep.orbitControls.maxDistance=e.maxDistance,Ep.orbitControls.minPolarAngle=e.minPolarAngle,Ep.orbitControls.maxPolarAngle=e.maxPolarAngle,Ep.orbitControls.minAzimuthAngle=e.minAzimuthAngle,Ep.orbitControls.maxAzimuthAngle=e.maxAzimuthAngle,Ep.orbitControls.targetLimit=e.targetLimit,J.custom.isUse=!1,J.default.isUse=!0}t&&t({result:1,message:"成功。"})},this.setSceneName=function(e){Ep.sceneName=e},this.getSceneName=function(){return Ep.sceneName},this.addBillboardAsset=function(t,i,n){e.remove(t);var a=new sr;let r=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===i.iconAssetName));r=JSON.parse(JSON.stringify(r)),r.name=t,r.transform.position.x=i.pos.x,r.transform.position.y=i.pos.y,r.transform.position.z=i.pos.z,r.textParam.text=i.labelText,r.textParam.enableText=""!=r.textParam.text,r.textParam.color=i.labelColor,r.isVisible=void 0===i.isShow?r.isVisible:i.isShow,r.param.iconScale=i.iconScale,r.textParam.labelScale=i.labelScale,r.param.mode=i.mode,r.param.rotation=i.rotation,new yb(r,a,(()=>{for(const e of a.children[0].children)e.onBeforeRender=function(){this.userData.inView=!0};a.children[0].renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),e.add(t,a.children[0]),n&&n(e)}))},this.updateBillboardAsset=function(t,i,n){let a=Ep.sceneSettings.objectTree.children.find((e=>"IconAsset"===e.type&&e.name===i.iconAssetName));a=JSON.parse(JSON.stringify(a)),a.name=t,a.transform.position.x=i.pos.x,a.transform.position.y=i.pos.y,a.transform.position.z=i.pos.z,a.textParam.text=i.labelText,a.textParam.enableText=""!=i.labelText,a.textParam.color=i.labelColor,a.isVisible=void 0===i.isShow?a.isVisible:i.isShow,a.param.iconScale=i.iconScale,a.textParam.labelScale=i.labelScale,a.param.mode=i.mode,a.param.rotation=i.rotation;let r=this.getIconAsset(t);if(r)r.update(a),n&&n(1);else{e.remove(t);var s=new sr;s.renderOrder=2,new yb(a,s,(()=>{s.children[0].renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),e.add(t,s.children[0]),n&&n(1)}))}},this.isContentAssets=function(e,t="IconAsset"){if(null==e||""==e)return!1;let i=e.indexOf("custom-")>-1,n=Ep.sceneSettings.objectTree.children;return i?n.findIndex((i=>i.type===t&&i.isEditor&&i.name===e.replace("custom-","")))>-1:n.findIndex((i=>i.type==t&&!i.isEditor&&i.name===e))>-1},this.interruptCameraFly=function(e=!0){if(Ep.orbitControls.removeEventListener("start",this.interruptCameraFly),Ep.orbitControls.autoRotate)return Ep.orbitControls.autoRotate=!1,Ep.autoRotateChange&&(Ep.autoRotateChange(!1),Ep.autoRotateChange=void 0),Ep.orbitControls.autoRotateSpeed=0,void Ep.orbitControls.update();if(Ep.targetCameraControls.isZoomTo)if(-1!==ne()){const e={target:S,distance:w};let t=this.getCamera();e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ},e.azimuthAngle=e.azimuthAngle||0===e.azimuthAngle?e.azimuthAngle:t.azimuthAngle,e.inclinationAngle="number"==typeof e.inclinationAngle?e.inclinationAngle:t.inclinationAngle,e.distance="number"==typeof e.distance&&e.distance>0?e.distance:t.viewDistance;let i=this.getDatumShiftModel();i&&i.editor&&i.editor.YScale&&(e.distance=e.distance*i.editor.YScale),Ep.targetCameraControls.zoomTo(new Ce(e.target.x,e.target.y,e.target.z),e.azimuthAngle,e.inclinationAngle,e.distance,0,!0)}else{let e=this.getCamera(),t=new Ce(e.targetX,e.targetY,e.targetZ),i=e.azimuthAngle,n=e.inclinationAngle,a=e.viewDistance;Ep.targetCameraControls.zoomTo(t,i,n,a,0,!0,void 0,!0)}}.bind(this),this.drawableIsSelected=function(t,i){let n=e.find(i);return!!n&&("landmark"===t&&void 0!==n.children[3])},this.getAngleByPositions=function(e,t){let i=new Ce(e.x,e.y,e.z);return 180*new Ce(t.x,t.y,t.z).angleTo(i)/Math.PI},this.getDistanceByPositions=function(e,t){let i=new Ce(e.x,e.y,e.z);return new Ce(t.x,t.y,t.z).distanceTo(i)*Ep.worldScale},this.positionLerp=function(e,t,i){let n=new Ce(e.x,e.y,e.z),a=new Ce(t.x,t.y,t.z);return n.lerp(a,i)},this.addPath=function(t,i,n){e.remove(t);let a=new sr;a.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),a.name=t;let r,s,o=[];i.points.forEach((e=>{o.push(e.x),o.push(e.y),o.push(e.z)}));let l=!0,c=!1,h=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type?(r=_y.interpolateAlongGlobe(o,3,50,!1,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR),s=_y.interpolateAlongGlobe(o,3,50,!0),l=!1,c=!0,h=!0):(r=_y.interpolate(o,3),s=_y.interpolate(o,3,50,!0)),i.pathType||(i.pathType="arrow01");let u=`texture/path/${i.pathType.toLowerCase()}.jpg`;Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,u),(o=>{o.wrapS=d,o.wrapT=d;var u=new lb.MeshLineMaterial({fog:Uy,map:o,maskMap:o,useMaskMap:!0,color:new Qt(i.color),opacity:i.alpha,resolution:new ye(window.innerWidth,window.innerHeight),sizeAttenuation:0,lineWidth:i.width*Ep.worldScale,depthWrite:h,depthTest:h,alphaTest:.05,transparent:!0,side:2,repeat:new ye(s/(i.width*Ep.worldScale*4),1),colorPass:new Qt(i.colorPass),passRange:i.passRange||0,pass:i.pass,faceUp:!1!==i.autoScale&&l,faceOut:!1!==i.autoScale&&c,outlineColor:new Qt(Ep.drawableClickColor)});Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(u.polygonOffset=!0,u.polygonOffsetFactor=.1,u.polygonOffsetUnits=-4);var p=new lb.MeshLine;p.material=u,p.setGeometry(r);var m=new Fi(p.geometry,u);m.onBeforeRender=function(){this.userData.inView=!0},!1===i.autoScale&&(m._context=Ep,m._raycast=m.raycast,m.raycast=p.raycast),m.name=t,a.add(m),e.add(t,a);let f=0;f="segment05"===i.pathType.toLowerCase()||"segment06"===i.pathType.toLowerCase()?0:i.width*Ep.worldScale/s,void 0===i.textureSpeed&&(i.textureSpeed=1);let g=new Lv(u,!0,!1,-f*i.textureSpeed,0);Ep.animationStore.add(g),a.visible=i.isShow;let y=0;const v=i.points.length;for(let e=0;e<v-1;e++){const t=i.points[e],n=i.points[e+1],a=new Ce(t.x,t.y,t.z),r=new Ce(n.x,n.y,n.z);y+=a.distanceTo(r)}let b=new Ce;if(0!==y){const e=y/2;y=0;for(let t=0;t<v-1;t++){const n=i.points[t],a=i.points[t+1],r=new Ce(n.x,n.y,n.z),s=new Ce(a.x,a.y,a.z);if(y+=r.distanceTo(s),y>e){const t=y-e;b=r.lerp(s,1-t/r.distanceTo(s));break}}}else b.x=i.points[0].x,b.y=i.points[0].y,b.z=i.points[0].z;a.position.x+=b.x,a.position.y+=b.y,a.position.z+=b.z,m.position.x-=b.x,m.position.y-=b.y,m.position.z-=b.z,a.userData.center=a.position.clone(),n&&n(a,g)}))},this.updatePathData=function(t,i){let n=e.find(t);if(!n)return;let a=[];i.points.forEach((e=>{a.push(e.x),a.push(e.y),a.push(e.z)})),n.children[0].geometry.setGeometry(a)},this.updatePathPass=function(t,{colorPass:i,pass:n}){let a=e.find(t);if(!a)return;let r=a.children[0].material;r.pass=n,r.colorPass=new Qt(i)},this.cameraFlyTo=function(e,t,i,n,a,r,s){this.interruptCameraFly(),Ep.orbitControls.addEventListener("start",this.interruptCameraFly);let o=this.getDatumShiftModel();o&&o.editor&&o.editor.YScale&&(n*=o.editor.YScale),Ep.targetCameraControls.zoomTo(new Ce(e.x,e.y,e.z),t,i,n,a,r,(e=>{Ep.orbitControls.removeEventListener("start",this.interruptCameraFly),s&&s(e)}))},this.getCameraAutoRotate=()=>Ep.orbitControls.autoRotate,this.getDatumShiftModel=function(){return Ep.datumShiftModel},this.setDatumShiftModel=function(e){Ep.datumShiftModel=e,L.setDatumShiftModel(e)},this.setReferencePoints=function(e){e instanceof Array&&!(e.length<2)||logger.warn("未提供有效的参考点信息。")},this.convertLLAToXYZ=function(e){return L.convertTransform(e)},this.convertXYZToLLA=function(e){return L.XYZToLLA(e)},this.getModelTransform=e=>{var t={};return Ep.scene.models.children.map((i=>{i.name===e&&(t.position=JSON.parse(JSON.stringify(i.position)),t.rotation=JSON.parse(JSON.stringify(i.rotation)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(i.scale)),t.rotation.x=t.rotation._x=ge.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=ge.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=ge.radToDeg(t.rotation._z))})),t},this.setModelTransform=(e,t)=>{if(t)for(let i=0;i<Ep.scene.models.children.length;i++)Ep.scene.models.children[i].name===e&&this.setTransform(Ep.scene.models.children[i],t)},this.getModelTransformByUUID=e=>{var t={};let i=Ep.scene.models.getObjectByProperty("uuid",e);if(i&&i.uuid===e){let e=i.position,n=i.rotation,a=i.scale;if(i instanceof Mb){let{key:t}=i.userData,r=i.instanced.getTransform(t);e=r.position,n=r.rotation,a=r.scale}t.position=JSON.parse(JSON.stringify(e)),t.rotation=JSON.parse(JSON.stringify(n)),t.rotation.x=t.rotation._x,t.rotation.y=t.rotation._y,t.rotation.z=t.rotation._z,t.scale=JSON.parse(JSON.stringify(a)),t.rotation.x=t.rotation._x=ge.radToDeg(t.rotation._x),t.rotation.y=t.rotation._y=ge.radToDeg(t.rotation._y),t.rotation.z=t.rotation._z=ge.radToDeg(t.rotation._z)}return t},this.setModelTransformByUUID=(e,t,i=!1)=>{if(!t)return;if(i){var n={type:"mouseDown",uuid:e},a={type:"mouseUp",mode:null,uuid:e};Ep.transformControls.dispatchEvent(n)}let r=this.defaultObjectTree.getItemByUUID(e);r&&(r.transformNode=t,r.transform=t,"IconAsset"===r.type&&r.isInstancedItem&&r.setTransform(r.transform)),Ep.scene.models.traverse((i=>{i.uuid===e&&this.setTransform(i,t)})),i&&(a.mode=Ep.transformControls.mode,Ep.transformControls.dispatchEvent(a)),this.nextRender((()=>{this.cutLevelByUUID(e,!1)}))},this.setTransformHistory=e=>{e>0?Ep.transformStore.advance():e<0&&Ep.transformStore.backOff()},this.clearTransformHistory=()=>{Ep.transformStore.clear()},this.setTransformStoreMode=e=>{Ep.transformStore.setMode(e)},this.onTransformEvent=(e,t)=>{Ep.transformStore.addEventListener(e,t)},this.offTransformEvent=(e,t)=>{Ep.transformStore.removeEventListener(e,t)},this.setModelOpacity=(e,t)=>{let i=Ep.scene.models.getObjectByName(e);if(!i)return;let n=e=>{for(let t of e)t.material&&(t.userData.defaultOpacity||(t.userData.defaultOpacity={},t.userData.defaultOpacity.transparent=t.material.transparent,t.userData.defaultOpacity.opacity=t.material.opacity)),n(t.children)};n(i.children);let a=e=>{for(let i of e)i.material&&(i.material.transparent=!(t>=1)||i.userData.defaultOpacity.transparent,i.material.opacity=i.userData.defaultOpacity.opacity*t),a(i.children)};a(i.children)},this.getModelNodeTransform=(e,t)=>{let i={};for(let n=0;n<this.defaultObjectTree.children.length;n++)switch(this.defaultObjectTree.children[n].type){case"ModelItem":this.defaultObjectTree.children[n].name===e&&(i=this.getModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t));break;case"BuildingItem":this.defaultObjectTree.children[n].name===e?i=this.getModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t):this.defaultObjectTree.children[n].children.forEach((n=>{switch(n.type){case"ModelItem":n.name===e&&(i=this.getModelTransformRecursion(n.getGroup(),t));break;case"BuildingFloorItem":n.name===e?i=this.getModelTransformRecursion(n.getGroup(),t):n.children.forEach((n=>{switch(n.type){case"ModelItem":n.name===e&&(i=this.getModelTransformRecursion(n.getGroup(),t));break;case"BuildingRoomItem":n.name===e?i=this.getModelTransformRecursion(n.getGroup(),t):n.children.forEach((n=>{n.name===e&&(i=this.getModelTransformRecursion(n.getGroup(),t))}))}}))}}))}return i},this.setModelNodeTransform=(e,t,i)=>{if(i)for(let n=0;n<this.defaultObjectTree.children.length;n++)switch(this.defaultObjectTree.children[n].type){case"ModelItem":this.defaultObjectTree.children[n].name===e&&this.setModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t,i);break;case"BuildingItem":this.defaultObjectTree.children[n].name===e?this.setModelTransformRecursion(this.defaultObjectTree.children[n].getGroup(),t,i):this.defaultObjectTree.children[n].children.forEach((n=>{switch(n.type){case"ModelItem":n.name===e&&this.setModelTransformRecursion(n.getGroup(),t,i);break;case"BuildingFloorItem":n.name===e?this.setModelTransformRecursion(n.getGroup(),t,i):n.children.forEach((n=>{switch(n.type){case"ModelItem":n.name===e&&this.setModelTransformRecursion(n.getGroup(),t,i);break;case"BuildingRoomItem":n.name===e?this.setModelTransformRecursion(n.getGroup(),t,i):n.children.forEach((n=>{n.name===e&&this.setModelTransformRecursion(n.getGroup(),t,i)}))}}))}}))}},this.getModelTransformRecursion=(e,t)=>{if(!(null!=e.children&&e.children.length>0))return!1;for(let n=0;n<e.children.length;n++){if(e.children[n].name===t){var i={};return i.position=JSON.parse(JSON.stringify(e.children[n].position)),i.rotation=JSON.parse(JSON.stringify(e.children[n].rotation)),i.rotation.x=i.rotation._x,i.rotation.y=i.rotation._y,i.rotation.z=i.rotation._z,i.scale=JSON.parse(JSON.stringify(e.children[n].scale)),i.rotation.x=i.rotation._x=ge.radToDeg(i.rotation._x),i.rotation.y=i.rotation._y=ge.radToDeg(i.rotation._y),i.rotation.z=i.rotation._z=ge.radToDeg(i.rotation._z),i}{let i=this.getModelTransformRecursion(e.children[n],t);if(i)return i}}},this.setModelTransformRecursion=(e,t,i)=>{if(null!=e.children&&e.children.length>0)for(let n=0;n<e.children.length;n++){if(e.children[n].name===t)return i.position&&(e.children[n].position.x="number"==typeof i.position.x?i.position.x:e.children[n].position.x,e.children[n].position.y="number"==typeof i.position.y?i.position.y:e.children[n].position.y,e.children[n].position.z="number"==typeof i.position.z?i.position.z:e.children[n].position.z),i.rotation&&(e.children[n].rotation.order=i.rotation._order||e.children[n].rotation.order,e.children[n].rotation.x="number"==typeof i.rotation.x?ge.degToRad(i.rotation.x):e.children[n].rotation.x,e.children[n].rotation.y="number"==typeof i.rotation.y?ge.degToRad(i.rotation.y):e.children[n].rotation.y,e.children[n].rotation.z="number"==typeof i.rotation.z?ge.degToRad(i.rotation.z):e.children[n].rotation.z),void(i.scale&&(e.children[n].scale.x="number"==typeof i.scale.x?i.scale.x:e.children[n].scale.x,e.children[n].scale.y="number"==typeof i.scale.y?i.scale.y:e.children[n].scale.y,e.children[n].scale.z="number"==typeof i.scale.z?i.scale.z:e.children[n].scale.z));this.setModelTransformRecursion(e.children[n],t,i)}},this.setTransform=(e,t)=>{const i={x:e.position.x,y:e.position.y,z:e.position.z};t.position&&("number"==typeof t.position.x&&(i.x=t.position.x),"number"==typeof t.position.y&&(i.y=t.position.y),"number"==typeof t.position.z&&(i.z=t.position.z));const n={order:e.rotation.order,x:e.rotation.x,y:e.rotation.y,z:e.rotation.z};t.rotation&&(t.rotation._order&&(n.order=t.rotation._order),"number"==typeof t.rotation.x&&(n.x=ge.degToRad(t.rotation.x)),"number"==typeof t.rotation.y&&(n.y=ge.degToRad(t.rotation.y)),"number"==typeof t.rotation.z&&(n.z=ge.degToRad(t.rotation.z)));const a={x:e.scale.x,y:e.scale.y,z:e.scale.z};t.scale&&("number"==typeof t.scale.x&&(a.x=t.scale.x),"number"==typeof t.scale.y&&(a.y=t.scale.y),"number"==typeof t.scale.z&&(a.z=t.scale.z)),e instanceof Mb?e.update(i,n,a):(t.position&&(e.position.x=i.x,e.position.y=i.y,e.position.z=i.z,Ep.eventHandlerStore.cameraMove()),t.rotation&&(e.rotation.order=n.order,e.rotation.x=n.x,e.rotation.y=n.y,e.rotation.z=n.z),t.scale&&(!0===t.forApi?(void 0===e.userData.originalScale&&(e.userData.originalScale=e.scale.clone()),e.scale.x=e.userData.originalScale.x*a.x,e.scale.y=e.userData.originalScale.y*a.y,e.scale.z=e.userData.originalScale.z*a.z):(e.scale.x=a.x,e.scale.y=a.y,e.scale.z=a.z)))},this.getSceneTransform=()=>{var e={};return e.position=Ep.scene.models.position,e.rotation=JSON.parse(JSON.stringify(Ep.scene.models.rotation)),e.scale=Ep.scene.models.scale,e.rotation.x=e.rotation._x=ge.radToDeg(e.rotation._x),e.rotation.y=e.rotation._y=ge.radToDeg(e.rotation._y),e.rotation.z=e.rotation._z=ge.radToDeg(e.rotation._z),e},this.setSceneTransform=e=>{e&&(e.position&&(Ep.scene.models.position.x="number"==typeof e.position.x?e.position.x:Ep.scene.models.position.x,Ep.scene.models.position.y="number"==typeof e.position.y?e.position.y:Ep.scene.models.position.y,Ep.scene.models.position.z="number"==typeof e.position.z?e.position.z:Ep.scene.models.position.z),e.rotation&&(Ep.scene.models.rotation.order=e.rotation._order||Ep.scene.models.rotation.order,Ep.scene.models.rotation.x="number"==typeof e.rotation._x?ge.degToRad(e.rotation._x):Ep.scene.models.rotation.x,Ep.scene.models.rotation.y="number"==typeof e.rotation._y?ge.degToRad(e.rotation._y):Ep.scene.models.rotation.y,Ep.scene.models.rotation.z="number"==typeof e.rotation._z?ge.degToRad(e.rotation._z):Ep.scene.models.rotation.z),e.scale&&(Ep.scene.models.scale.x="number"==typeof e.scale.x?e.scale.x:Ep.scene.models.scale.x,Ep.scene.models.scale.y="number"==typeof e.scale.y?e.scale.y:Ep.scene.models.scale.y,Ep.scene.models.scale.z="number"==typeof e.scale.z?e.scale.z:Ep.scene.models.scale.z))},this.setAvwToken=function(e,t,i){switch(e.toLowerCase()){case"header":let e={};"authorization:bearer"===t.toLowerCase()?e.Authorization="Bearer "+i:e[t]=i;for(let t in Ep.loaders)"function"==typeof Ep.loaders[t].setRequestHeader&&Ep.loaders[t].setRequestHeader(e)}},this.addState=function(e){return Ep.stateStore.add(e+"")},this.getStates=function(){return Ep.stateStore.getStates()},this.setDefaultState=function(e){return Ep.stateStore.setDefaultState(e)},this.setStateMoveUp=function(e){return Ep.stateStore.setStateMoveUp(e)},this.setStateMoveDown=function(e){return Ep.stateStore.setStateMoveDown(e)},this.removeState=function(e){Ep.stateStore.remove(e)},this.updateState=function(e,t){return Ep.stateStore.update(e,t)},this.copyState=function(e,t){return Ep.stateStore.copyState(e,t)},this.getCurrentState=()=>{if(Ep.stateStore)return Ep.stateStore.getCurrentState()},this.synchronizaArticulation=()=>{Ep.stateStore&&Ep.stateStore.synchronizaArticulation()},this.synchronizaAnimation=()=>{Ep.stateStore&&Ep.stateStore.synchronizaAnimation()},this.recoverView=e=>{let t=null;Ep.sceneSettings||this.saveSceneSettings(this.getSettings());let i=Ep.sceneSettings.states.find((t=>t.name==e));t=i?i.settings.view:Ep.sceneSettings.view,this.defaultView.applySettings(t)},this.setCurrentState=(e,t,i)=>{if(Ep.stateStore){if(e)return this.notState||(this.notState=JSON.parse(JSON.stringify(this.getSettings()))),this.notDistance?(this.notState.view.camera.distanceMin=this.notDistance.minDistance,this.notState.view.camera.distanceMax=this.notDistance.maxDistance):(this.notDistance||(this.notDistance={}),this.notDistance.minDistance=this.notState.view.camera.distanceMin,this.notDistance.maxDistance=this.notState.view.camera.distanceMax),window.firstLoadEnd?Y&&(this.notState.view.camera.targetX=Y.targetX,this.notState.view.camera.targetY=Y.targetY,this.notState.view.camera.targetZ=Y.targetZ,this.notState.view.camera.distance=Y.viewDistance,this.notState.view.camera.azimuth=Y.azimuthAngle,this.notState.view.camera.inclination=Y.inclinationAngle,this.notState.view.camera.fov=Y.fov,this.notState.view.camera.maxDistance=Y.distanceMax,this.notState.view.camera.minDistance=Y.distanceMin,this.notState.view.camera.near=Y.near,this.notState.view.camera.far=Y.far,this.notState.view.camera.inclinationAngleMin=Y.inclinationAngleMin,this.notState.view.camera.inclinationAngleMax=Y.inclinationAngleMax):(window.firstLoadEnd=!0,Ep.sceneSettings&&(this.notState.view.camera=Ep.sceneSettings.view.camera),Y&&(Y.targetX=this.notState.view.camera.targetX,Y.targetY=this.notState.view.camera.targetY,Y.targetZ=this.notState.view.camera.targetZ,Y.viewDistance=this.notState.view.camera.distance,Y.azimuthAngle=this.notState.view.camera.azimuth,Y.inclinationAngle=this.notState.view.camera.inclination,Y.fov=this.notState.view.camera.fov,Y.distanceMax=this.notState.view.camera.maxDistance,Y.distanceMin=this.notState.view.camera.minDistance,Y.near=this.notState.view.camera.near,Y.far=this.notState.view.camera.far,Y.inclinationAngleMin=this.notState.view.camera.inclinationAngleMin,Y.inclinationAngleMax=this.notState.view.camera.inclinationAngleMax)),Ep.stateStore.selectState(e,t,i);this.notState?(this.notState.view.camera.duration=1.5,this.applySceneSettings(this.notState,t),Ep.stateStore.setNotState(),this.notState=null):(this.notState=JSON.parse(JSON.stringify(this.getSettings())),this.notState.view.camera.duration=1.5,this.applySceneSettings(this.notState,t),Ep.stateStore.setNotState(),this.notState=null)}},this.saveCurrentStateSettings=()=>{Ep.stateStore&&Ep.stateStore.saveCurrentStateSettings()},this.saveCameraParam=(e,t)=>{Ep.stateStore&&Ep.stateStore.saveCameraParam(e,t)},this.getCameraDuration=()=>this.defaultView._camera.duration?this.defaultView._camera.duration:1.5,this.addCone=function(t,i={},n){if(e.find(t))return void console.warn(`已存在名称为${t}的绘制物。`);i.radius=i.radius||1,i.height=i.height||1,i.radialSegments=i.radialSegments||8,i.heightSegments=i.heightSegments||1,i.openEnded=!!i.openEnded,i.thetaStart=i.thetaStart||0,i.thetaLength=i.thetaLength||2*Math.PI,i.materialType=i.materialType||"basic",i.color=i.color||35071;let a,r=new ws(i.radius,i.height,i.radialSegments,i.heightSegments,i.openEnded,i.thetaStart,i.thetaLength);switch(i.originOffset&&(i.originOffset.position&&r.translate(i.originOffset.position.x||0,i.originOffset.position.y||0,i.originOffset.position.z||0),i.originOffset.rotation&&(r.rotateY(ge.degToRad(i.originOffset.rotation.y||0)),r.rotateX(ge.degToRad(i.originOffset.rotation.x||0)),r.rotateZ(ge.degToRad(i.originOffset.rotation.z||0)))),i.materialType.toLowerCase()){case"standard":case"lambert":a=new Co({});break;case"phong":a=new To({});break;case"basic":default:a=new Kt({})}i.map&&(a.map=Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,i.map)),a.map.wrapS="number"==typeof i.repeatX&&1!=i.repeatX?d:m,a.map.wrapT="number"==typeof i.repeatY&&1!=i.repeatY?d:m,a.map.repeat.set(i.repeatX||1,i.repeatY||1)),i.alphaMap&&(a.alphaMap=Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,i.alphaMap)),a.alphaMap.wrapS="number"==typeof i.repeatX&&1!=i.repeatX?d:m,a.alphaMap.wrapT="number"==typeof i.repeatY&&1!=i.repeatY?d:m,a.alphaMap.repeat.set(i.repeatX||1,i.repeatY||1)),a.alphaTest=.05,a.color=new Qt(i.color),a.transparent=!(!i.alphaMap&&"number"!=typeof i.opacity),a.opacity="number"==typeof i.opacity?i.opacity:1,a.side="number"==typeof i.side&&i.side>=0&&i.side<=2?i.side:0;let s=new Fi(r,a);if(s.name=t,i.transform&&(i.transform.position&&s.position.set(i.transform.position.x||0,i.transform.position.y||0,i.transform.position.z||0),i.transform.rotation&&s.rotation.set(ge.degToRad(i.transform.rotation.x||0),ge.degToRad(i.transform.rotation.y||0),ge.degToRad(i.transform.rotation.z||0)),i.transform.scale&&s.scale.set(i.transform.scale.x||1,i.transform.scale.y||1,i.transform.scale.z||1)),e.add(t,s),i.follow&&this.defaultObjectTree.getItemByName(i.follow.modelName)){let e=this.defaultObjectTree.getItemByName(i.follow.modelName).getGroup();if(e instanceof Et){if(i.follow.modelName){let t=e.getObjectByName(i.follow.nodeName);t&&(e=t)}Ep.animationStore.add(new mv(s,e,{followType:i.follow.type,enableRotation:!0,enableScale:!0,limit:i.limit,distance0:i.height}))}}},this.addRAFCallback=e=>{if("function"==typeof e){Ep.rafCallbacks instanceof Array||(Ep.rafCallbacks=[]);for(let t=0;t<Ep.rafCallbacks.length;t++)if(Ep.rafCallbacks[t]===e)return;Ep.rafCallbacks.push(e)}},this.removeRAFCallback=e=>{if(Ep.rafCallbacks instanceof Array)for(let t=0;t<Ep.rafCallbacks.length;t++)if(Ep.rafCallbacks[t]===e)return void Ep.rafCallbacks.splice(t,1)},this.clearRAFCallbacks=()=>{Ep.rafCallbacks instanceof Array&&(Ep.rafCallbacks=void 0)},this.addBillboard=function(t,i,n,a){e.remove(t),void 0===i.iconScale&&(i.iconScale=1),void 0===n.labelScale&&(n.labelScale=1);var r=new sr;r.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),r.position.set(i.pos.x,i.pos.y,i.pos.z);let s=Ep.drawableDepthTest;if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(s=!1),i.background){let e=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+i.background+".png"));var o=new vr({map:e,color:new Qt(i.backgroundColor),fog:Uy,depthWrite:s,depthTest:s,alphaTest:.1,transparent:!0,sizeAttenuation:i.sizeAttenuation,polygonOffset:i.polygonOffset,polygonOffsetFactor:i.polygonOffsetFactor,polygonOffsetUnits:i.polygonOffsetUnits}),l=new Or(o);l.onBeforeRender=function(){this.userData.inView=!0},l.name=t,l.scale.set(i.sizeAttenuation?Number(i.width)/30:Number(i.width)/3e3,i.sizeAttenuation?Number(i.height)/30:Number(i.height)/3e3,1),l.scale.x*=i.iconScale,l.scale.y*=i.iconScale;let n=-.1;if(l.center=new ye(i.offsetV/30*n+.5,i.offsetH/30*n+.5),i.backgroundColor&&"rgba"===i.backgroundColor.substring(0,4)){let e=i.backgroundColor.slice(4);e=e.split(","),e=parseFloat(e[3].replace(/[^0-9.]/gi,"")),l.material.opacity=e}r.add(l)}else r.add(new sr);const c=o=>{var l=new vr({map:o,color:new Qt(i.foregroundColor||"#ffffff"),fog:Uy,depthWrite:s,depthTest:s,alphaTest:.1,transparent:!0,sizeAttenuation:i.sizeAttenuation,polygonOffset:i.polygonOffset,polygonOffsetFactor:i.polygonOffsetFactor,polygonOffsetUnits:i.polygonOffsetUnits}),c=new Or(l);c.onBeforeRender=function(){this.userData.inView=!0},c.name=t,c.scale.set(i.sizeAttenuation?Number(i.width)/50:Number(i.width)/5e3,i.sizeAttenuation?Number(i.height)/50:Number(i.height)/5e3,1),c.scale.x*=i.iconScale,c.scale.y*=i.iconScale,r.add(c),c.center.set(i.offsetV,i.offsetH);var h=null;if(null!=n&&n.enableText?(h=he(r,n,i.iconScale)).name=t:r.add(new sr),null!=i.enableAutoHidebyDistance&&(r.activeVisible=!0,r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.pointMinDistance*Ep.worldScale,r.maxDistance=i.pointMaxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r)),e.add(t,r),i.isShow?(r.visible=!0,r.activeVisible=!0):(r.visible=!1,r.activeVisible=!1),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){let e=new fv(r,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR);Ep.drawableDepthTest?e.resume():e.pause(),Ep.animationStore.add(e)}i.mode&&"3d"===i.mode.toLowerCase()&&(c.material.side=2,c.material.onBeforeCompile=Ep.billboardBeforeCompile,c.raycast=Ep.billboardRaycast.bind(c),h&&(h.material.side=2,h.material.onBeforeCompile=Ep.billboardBeforeCompile,h.raycast=Ep.billboardRaycast.bind(h)),r.rotation.x=i.rotation[0]/180*Math.PI,r.rotation.y=i.rotation[1]/180*Math.PI,r.rotation.z=i.rotation[2]/180*Math.PI),a&&a(r)};return void 0!==q[i.path]?(q[i.path].objectNames.push(t),c(q[i.path].map)):b.textureLoader.load(i.path,(e=>{q[i.path]={},q[i.path].map=e,q[i.path].objectNames=[t],c(e)})),r};let he=(t,i,n=1)=>{void 0===i.labelScale&&(i.labelScale=1);let a=Ep.drawableDepthTest;var r;if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(a=!1),null!=i){var s=i.canvas,o=new vs(s),l=new vr({map:o,color:16777215,fog:Uy,depthWrite:a,depthTest:a,sizeAttenuation:i.sizeAttenuation,side:2});if((r=new Or(l)).onBeforeRender=function(){this.userData.inView=!0},r.scale.set(i.sizeAttenuation?.045*i.canvas.width:405e-6*i.canvas.width,i.sizeAttenuation?.045*i.canvas.height:405e-6*i.canvas.height,1),r.scale.x*=i.labelScale,r.scale.y*=i.labelScale,"left"===i.labelAlignment){let e=t.children[1].material.map.image.width,n=e/t.children[1].scale.x,a=o.image.width;e=e/n*(a/r.scale.x);let s=e/1.8/a*-1;r.center.set(s,i.offsetH)}else r.center.set(i.offsetV,i.offsetH*n/i.labelScale);return r.visible=i.enableText,t?t.add(r):e.add(r),r}};this.updateBillboard=function(t,i,n,a){let r=e.find(t);if(null!=r){void 0===i.iconScale&&(i.iconScale=1),void 0===n.labelScale&&(n.labelScale=1),r.position.set(i.pos.x,i.pos.y,i.pos.z);let e=Ep.drawableDepthTest;if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(e=!1),i.background){let e=r.children[0];e.material.color=new Qt(i.backgroundColor),e.material.map=Ep.loaders.textureLoader.load(_y.url(Ep.instance.resourceBasePath,"texture/iconBackground/"+i.background+".png")),e.material.sizeAttenuation=i.sizeAttenuation,e.scale.set(i.sizeAttenuation?Number(i.width)/30:Number(i.width)/3e3,i.sizeAttenuation?Number(i.height)/30:Number(i.height)/3e3,1),e.scale.x*=i.iconScale,e.scale.y*=i.iconScale,e.material.depthWrite=!1,e.material.depthTest=!1;let t=-.1;e.center=new ye(i.offsetV/30*t+.5,i.offsetH/30*t+.5)}else r.children[0].traverse((e=>{e.geometry&&e.geometry.dispose(),e.material&&(e.material.dispose(),e.material.map&&e.material.map.dispose())})),r.children[0]=new sr;let s=r.children[1];s.material.sizeAttenuation=i.sizeAttenuation,s.scale.set(i.sizeAttenuation?Number(i.width)/50:Number(i.width)/5e3,i.sizeAttenuation?Number(i.height)/50:Number(i.height)/5e3,1),s.scale.x*=i.iconScale,s.scale.y*=i.iconScale,s.center.set(i.offsetV,i.offsetH),Ep.loaders.textureLoader.load(i.path,(o=>{let l;if(s.material.map=o,s.material.depthWrite=e,s.material.depthTest=e,null!=r.children[1]&&r.children[1])if(null!=n&&n)if(n.enableText){let e=new vs(n.canvas);l=r.children[2],l.isGroup&&(r.remove(l),n.iconScale=i.iconScale,l=he(r,n),l.name=t);let a=l.material;if(a.map=e,a.sizeAttenuation=n.sizeAttenuation,l.scale.set(n.sizeAttenuation?.045*n.canvas.width:405e-6*n.canvas.width,n.sizeAttenuation?.045*n.canvas.height:405e-6*n.canvas.height,1),l.scale.x*=n.labelScale,l.scale.y*=n.labelScale,l.center.y/=n.labelScale,"left"===n.labelAlignment){let t=s.material.map.image.width,a=t/s.scale.x,r=e.image.width;t=t/a*(r/l.scale.x);let o=t/1.75/r*-1;l.center.set(o,n.offsetH*i.iconScale)}else l.center.set(n.offsetV,n.offsetH*i.iconScale/n.labelScale);l.visible=n.enableText}else r.children[2]=new sr;else r.children[2]=new sr;else if(n.enableText){_E.createText(r,n).name=t}if(null!=i.enableAutoHidebyDistance&&(r.activeVisible=!0,r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.pointMinDistance*Ep.worldScale,r.maxDistance=i.pointMaxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r)),r.visible=i.isShow,r.activeVisible=i.isShow,Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){let e=Ep.animationStore.findDrawableAnimation(r,"GeoGlobeVisibilityController");e&&(e.objectVisible0=i.isShow)}i.mode&&"3d"===i.mode.toLowerCase()&&(l&&(l.material.side=2,l.material.onBeforeCompile=Ep.billboardBeforeCompile),r.rotation.x=i.rotation[0]/180*Math.PI,r.rotation.y=i.rotation[1]/180*Math.PI,r.rotation.z=i.rotation[2]/180*Math.PI),a&&a(1)}))}},this.selectBillboard=function(t,i){var n=e.find(t);if(!n||!i)return;if(null!=n.children[3])return;var a=n.children[1];let r=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(r=!1);var s=b.textureLoader.load(_y.url(this.resourceBasePath,i.path)),o=new vr({map:s,color:16777215,fog:!1,sizeAttenuation:a.material.sizeAttenuation,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:-3e4,depthWrite:r,depthTest:r}),l=new Or(o);l.name=t+"_selector",l.position.set(a.position.x,a.position.y,a.position.z);let c=a.scale.x;c>a.scale.y&&(c=a.scale.y),l.scale.set(.8*c,.8*c,1),l.center=new ye(.5,.5),n.add(l)},this.deselectBillboard=function(t){var i=e.find(t);if(!i)return;if(null==i.children[3])return;let n=i.children[3];n.material.map.dispose(),n.material.dispose(),n.geometry.dispose(),i.remove(n)},this.deselectAllBillboard=function(){e.forEach((e=>{for(let t of e.children)if(-1!=t.name.indexOf("_selector")){t.material.dispose(),t.geometry.dispose(),e.remove(t);break}}))},this.addBillboard3D=function(e,t){const i=e.canvas,n=new vs(i),a=new vr({map:n,color:16777215,fog:Uy,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,sizeAttenuation:!!e.autoScale,transparent:!0,alphaTest:.1,side:2}),r=new Or(a);a.sizeAttenuation?r.scale.set(e.size[0],e.size[1],1):r.scale.set(e.size[0]/Ep.renderer.domElement.height,e.size[1]/Ep.renderer.domElement.height,1);const s=e.modelObject.getWorldPosition(e.modelObject.position.clone());r.position.x=s.x+e.offset[0],r.position.y=s.y+e.offset[1],r.position.z=s.z+e.offset[2],r.rotation.x=e.rotation[0]/180*Math.PI,r.rotation.y=e.rotation[1]/180*Math.PI,r.rotation.z=e.rotation[2]/180*Math.PI,a.onBeforeCompile=Ep.billboardBeforeCompile,r.name=e.name,Ep.objectStore.add(e.name,r);const o={sprite:r,canvas:i,material:a,model:e.modelObject,offset:e.offset,frameCount:e.drawInterval||0,name:e.name,render:function(){this.material.map.dispose(),this.material.map=new vs(this.canvas),this.frameCount&&Ep.instance.nextRender(this.render,this.frameCount)},remove:function(){Ep.objectStore.remove(this.name),this.frameCount=void 0}};return o.render=o.render.bind(o),o.remove=o.remove.bind(o),o.frameCount&&Ep.instance.nextRender(o.render,o.frameCount),t&&t(o),o},this.updateBillboard3D=function(t,i,n){if(!t)return;let a=e.find(t.name);if(!t)return;a.position.set(t.position.x,t.position.y,t.position.z),a.scale.set(t.scale,t.scale,t.scale);let r=ge.degToRad(t.rotation.x),s=ge.degToRad(t.rotation.y),o=ge.degToRad(t.rotation.z);a.rotation.set(r,s,o),t.enableAutoHidebyDistance&&(a.enableAutoHidebyDistance=t.enableAutoHidebyDistance,a.minDistance=t.minVisibleDistance*Ep.worldScale,a.maxDistance=t.maxVisibleDistance*Ep.worldScale,Ep.animationStore.addDistance(name,yy,Ep.camera,a)),t.visible=t.isShow;let l=a.children[0];if(i&&l){l.geometry=new sn(i.width,i.height,1,1);let e=l.material,n=b.textureLoader.load(i.path);e.map=n,e.transparent=!0,e.side=2,e.depthTest=t.depthTest,e.color.r*=i.brightness,e.color.g*=i.brightness,e.color.b*=i.brightness,l.position.set(i.offset.x,i.offset.y,i.offset.z),l.scale.set(i.scale,i.scale,i.scale),l.visible=i.isShow}let c=a.children[1];if(n&&c){c.text=n.content,c.font=n.font,c.fontSize=n.size,c.anchorX=n.alignment,c.anchorY="middle";let e=new Qt(n.color);e.r*=n.brightness,e.g*=n.brightness,e.b*=n.brightness,c.color="#"+e.getHexString(),c.material.depthTest=t.depthTest,c.position.x=n.offset.x,c.position.y=n.offset.y,c.position.z=n.offset.z+.1,c.visible=n.isShow,c.sync()}},this.addBar=function(t,i,n){e.remove(t);var a,r=new sr;r.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),a="bar"==i.type||null==i.type?new Hi(1,1,1):new xs(.5,.5,1,32);let s=new To({fog:Uy,opacity:i.alpha,transparent:!0,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest});if(s.color=new Qt(i.color),s.emissive=new Qt(i.color),s.emissiveIntensity=i.brightness,"linear"===i.columnPaint){s.vertexColors=!0;let e=_y.colorToRGBAObject(i.colorMax),t=_y.colorToRGBAObject(i.colorMin),n=new Qt((e.r-t.r)/2+t.r,(e.g-t.g)/2+t.g,(e.b-t.b)/2+t.b);s.color=new Qt("0xffffff"),s.emissive=n,s.emissiveIntensity=1.5*i.brightness,s.userData.defaultEmissiveIntensity=s.emissiveIntensity,s.emissiveIntensity*=Ep.drawableEmissiveIntensity;let r=[];for(let e=0;e<a.attributes.position.count;e++)r.push(1,1,1);a.setAttribute("color",new hi(r,3)),r=a.attributes.color;let o=new Qt(i.colorMax),l=new Qt(i.colorMin);for(let e=0;e<a.attributes.position.count;e++)a.attributes.position.array[3*e+1]>=.5?(r.setXYZ(e,o.r,o.g,o.b),r.setXYZ(e+1,o.r,o.g,o.b),r.setXYZ(e+2,o.r,o.g,o.b)):(r.setXYZ(e,l.r,l.g,l.b),r.setXYZ(e+1,l.r,l.g,l.b),r.setXYZ(e+2,l.r,l.g,l.b));r.needsUpdate=!0}var o=new Fi(a,s);o.needsUpdate=!0,o.onBeforeRender=function(){this.userData.inView=!0},Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type?(a.translate(0,.5,0),o.scale.set(i.width*Ep.worldScale,i.value*Ep.worldScale,i.width*Ep.worldScale),r.position.set(i.pos.x,i.pos.y,i.pos.z),r.rotation.order="YXZ",r.rotation.y=ge.degToRad(i.pos.lon+90),r.rotation.x=ge.degToRad(90-i.pos.lat)):(r.position.set(i.pos.x,i.pos.y+i.value*Ep.worldScale*.5,i.pos.z),o.scale.set(i.width*Ep.worldScale,i.value*Ep.worldScale,i.width*Ep.worldScale)),i.alpha>0&&(o.castShadow=!0),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(o.castShadow=!1),void 0!==i.castShadow&&(o.castShadow=!!i.castShadow),r.add(o),o.name=t;var l=null;null!=n&&n.enableText&&((l=_E.createText(r,n)).name=t,Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type?l.position.y=i.value*Ep.worldScale:l.position.y=i.value*Ep.worldScale*.5),null!=i.enableAutoHidebyDistance&&(r.activeVisible=!0,r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.minDistance*Ep.worldScale,r.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r)),e.add(t,r),i.isShow?(r.visible=!0,r.activeVisible=!0,!n.enableText&&l&&(l.visible=!1)):(r.visible=!1,r.activeVisible=!1,l&&(l.visible=!1))},this.addInstancedBar=function(t,i,n){e.remove(t);var a,r=new sr;r.renderOrder=2,a="bar"==i.type||null==i.type?new Hi(1,1,1):new xs(.5,.5,1,32);var s=new To({fog:Uy,color:new Qt(i.color),opacity:i.alpha,emissive:new Qt(i.color),emissiveIntensity:i.brightness,transparent:!0,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest});Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(s.polygonOffset=!0,s.polygonOffsetFactor=.1,s.polygonOffsetUnits=-4);var o=new Fi(a,s);r.position.set(i.pos.x,i.pos.y+i.value*Ep.worldScale*.5,i.pos.z),o.scale.set(i.width*Ep.worldScale,i.value*Ep.worldScale,i.width*Ep.worldScale),i.alpha>0&&(o.castShadow=!0),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(o.castShadow=!1),r.add(o),o.name=t;var l=null;null!=n&&n.enableText&&((l=_E.createText(r,n)).name=t),null!=i.enableAutoHidebyDistance&&(r.activeVisible=!0,r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.minDistance*Ep.worldScale,r.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r)),e.add(t,r),i.isShow?(r.visible=!0,r.activeVisible=!0,!n.enableText&&l&&(l.visible=!1)):(r.visible=!1,r.activeVisible=!1,l&&(l.visible=!1))},this.addBubble=function(t,i,n,a){Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,"texture/bubble/bubble.png"),(r=>{var s=new sr;s.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0);var o=new _s(1,32),l=new Kt({fog:Uy,color:i.color,opacity:Number(i.alpha),transparent:!0,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest});l.alphaMap=r;var c=new Fi(o,l);c.onBeforeRender=function(){this.userData.inView=!0},c.name=t,s.add(c),s.position.set(i.pos.x,i.pos.y,i.pos.z),c.rotateX(-.5*Math.PI);let h=Ep.animationStore.findNodeAnimation(t,Mv.type);h&&Ep.animationStore.remove(h),h=new Mv(c,0,i.value*Ep.worldScale,.8*i.value*Ep.worldScale,i.diffSpeed*Ep.worldScale,!0),Ep.animationStore.add(h);var u=null;null!=n&&n.enableText&&((u=_E.createText(s,n)).name=t),null!=i.enableAutoHidebyDistance&&(s.activeVisible=!0,s.enableAutoHidebyDistance=i.enableAutoHidebyDistance,s.minDistance=i.minDistance*Ep.worldScale,s.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,s)),e.add(t,s),i.isShow?(s.visible=!0,s.activeVisible=!0,!n.enableText&&u&&(u.visible=!1)):(s.visible=!1,s.activeVisible=!1,u&&(u.visible=!1)),a&&a(s)}))},this.addInstancedBubble=function(t,i,n,a){if(!(i.points instanceof Array))return void(a&&a(0));let r="none"===i.fillArea.toLowerCase()?"texture/bubble/bubble.png":`texture/bubble/fill/${i.fillArea.toLowerCase()}.jpg`;Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,r),(n=>{var r=new sr;r.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0);let s=Ep.drawableDepthTest;Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(s=!1);var o=new _s(1,32);o.rotateX(Math.PI/-2);var l=new Kt({alphaMap:n,fog:Uy,opacity:1,transparent:!0,depthWrite:s,depthTest:s,side:2});Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(l.polygonOffset=!0,l.polygonOffsetFactor=.1,l.polygonOffsetUnits=-4);let c=new Qr(o,l,zy);c.count=i.points.length,c.name=t,c.onBeforeRender=function(){this.userData.inView=!0},c.instanceMatrix.setUsage(ue),c.visible=[],c.activeVisible=[],c.hideByDistance=[],c.minDistances=[],c.maxDistances=[],c.userData.names=i.points.map((e=>e.name));let h=new Et;for(let e=0;e<i.points.length;e++){"boolean"==typeof i.points[e].isShow?c.visible[e]=i.points[e].isShow:c.visible[e]=!0,h.position.set(i.points[e].position.x,i.points[e].position.y,i.points[e].position.z),h.scale.set(1,1,1),Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(h.rotation.order="YXZ",h.rotation.y=(i.points[e].position.lon+90)/180*Math.PI,h.rotation.x=(90-i.points[e].position.lat)/180*Math.PI),h.updateMatrix(),c.setMatrixAt(e,h.matrix.clone()),c.setColorAt(e,new Qt(i.points[e].color));let n=Ep.animationStore.findInstancedAnimation(c,e,yv.type);n&&Ep.animationStore.remove(n),null!=i.points[e].enableAutoHidebyDistance&&(c.activeVisible[e]=!0,c.hideByDistance[e]=i.points[e].enableAutoHidebyDistance,c.minDistances[e]=i.points[e].minDistance*Ep.worldScale,c.maxDistances[e]=i.points[e].maxDistance*Ep.worldScale),n=Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type?new yv(c,e,0,i.points[e].value*Ep.worldScale,.8*i.points[e].value*Ep.worldScale,i.points[e].diffSpeed*Ep.worldScale,!1,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR,.5,null):new yv(c,e,0,i.points[e].value*Ep.worldScale,.8*i.points[e].value*Ep.worldScale,i.points[e].diffSpeed*Ep.worldScale,!1,Ep.camera),Ep.animationStore.add(n);var u=null;null!=i.points[e].textParam&&i.points[e].textParam.enableText&&((u=_E.createText(r,i.points[e].textParam)).position.set(i.points[e].position.x,i.points[e].position.y,i.points[e].position.z),u.name=`__bubble_${t}_${e}`,u.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),r.add(u),null!=i.points[e].enableAutoHidebyDistance&&(u.activeVisible=!0,u.enableAutoHidebyDistance=i.points[e].enableAutoHidebyDistance,u.minDistance=i.points[e].minDistance*Ep.worldScale,u.maxDistance=i.points[e].maxDistance*Ep.worldScale,Ep.animationStore.addDistance(`__bubble_dc_${t}_${e}`,yy,Ep.camera,u))),i.isShow?!i.points[e].textParam.enableText&&u&&(u.visible=!1):u&&(u.visible=!1)}c.instanceColor.needsUpdate=!0,c.instanceMatrix.needsUpdate=!0,r.add(c),r.instancedBubble=c,e.add(t,r),i.isShow?(r.visible=!0,r.activeVisible=!0):(r.visible=!1,r.activeVisible=!1),a&&a(1)}))},this.updateInstancedBubble=function(t,i,n,a){let r=Ep.objectStore.find(t);if(!r)return;"number"==typeof i.renderOrder&&(r.renderOrder=Fy+i.renderOrder);let s=r.instancedBubble;if(!s)return;if(!(i.points instanceof Array))return;s.count=i.points.length,s.name=t,s.onBeforeRender=function(){this.userData.inView=!0},s.instanceMatrix.setUsage(ue),s.activeVisible=[],s.hideByDistance=[],s.minDistances=[],s.maxDistances=[];let o=new Et;for(let e=0;e<i.points.length;e++){o.position.set(i.points[e].position.x,i.points[e].position.y,i.points[e].position.z),o.scale.set(1,1,1),o.updateMatrix(),s.setMatrixAt(e,o.matrix.clone()),s.setColorAt(e,new Qt(i.points[e].color));let n=Ep.animationStore.findInstancedAnimation(s,e,yv.type);n&&Ep.animationStore.remove(n),null!=i.points[e].enableAutoHidebyDistance&&(s.activeVisible[e]=!0,s.hideByDistance[e]=i.points[e].enableAutoHidebyDistance,s.minDistances[e]=i.points[e].minDistance*Ep.worldScale,s.maxDistances[e]=i.points[e].maxDistance*Ep.worldScale),n=Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type?new yv(s,e,0,i.points[e].value*Ep.worldScale,.8*i.points[e].value*Ep.worldScale,i.points[e].diffSpeed*Ep.worldScale,!1,Ep.camera,Ep.datumShiftModel.scaleX*Pp.EARTH_RADIUS_EQUATOR,.5,null):new yv(s,e,0,i.points[e].value*Ep.worldScale,.8*i.points[e].value*Ep.worldScale,i.points[e].diffSpeed*Ep.worldScale,!1,Ep.camera),Ep.animationStore.add(n);var l=null;null!=i.points[e].textParam&&i.points[e].textParam.enableText&&((l=_E.createText(bubbleGroup,i.points[e].textParam)).position.set(i.points[e].position.x,i.points[e].position.y,i.points[e].position.z),l.name=`__bubble_${t}_${e}`,l.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),bubbleGroup.add(l),null!=i.points[e].enableAutoHidebyDistance&&(l.activeVisible=!0,l.enableAutoHidebyDistance=i.points[e].enableAutoHidebyDistance,l.minDistance=i.points[e].minDistance*Ep.worldScale,l.maxDistance=i.points[e].maxDistance*Ep.worldScale,Ep.animationStore.addDistance(`__bubble_dc_${t}_${e}`,yy,Ep.camera,l)))}s.instanceColor.needsUpdate=!0,s.instanceMatrix.needsUpdate=!0,bubbleGroup.add(s),e.add(t,bubbleGroup)},this.removeInstancedBubble=function(t){let i=Ep.objectStore.find(t);if(!i)return;let n=i.instancedBubble;if(n){for(let e=0;e<n.count;e++){let t=Ep.animationStore.findInstancedAnimation(n,e,yv.type);t&&Ep.animationStore.remove(t)}n.geometry.dispose();for(let e in n.material)n.material[e]instanceof we&&n.material[e].dispose();n.material.dispose(),n.dispose(),i.remove(n);for(let e of i.children){for(let t in e.material)e.material[t]instanceof we&&e.material[t].dispose();i.remove(e)}e.remove(t)}},this.addODLine=function(t,i,n,a){var r=new sr;let s,o,l,c;r.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),r.name=t,s=new Ce(i.startPos.x,i.startPos.y,i.startPos.z),c=new Ce(i.endPos.x,i.endPos.y,i.endPos.z),o=new Ce,l=new Ce;var h=new Ce;if(Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&"number"==typeof Ep.worldScale){h.lerpVectors(s,c,.5);const e=6371008*Ep.worldScale;let t=2*Math.acos(h.length()/e),n=1.3333*Math.tan(t/4)*Math.cos(t/2)*e/s.distanceTo(c);const a=1.3333*Math.tan(t/4)*Math.sin(t/2)*e+e*parseFloat(i.curvatureCoefficient/50);o.lerpVectors(s,c,n),l.lerpVectors(s,c,1-n),h.normalize().multiplyScalar(a),o.add(h),l.add(h)}else h=c.clone().add(s.clone().divideScalar(-1)),o.lerpVectors(s,c,.25),l.lerpVectors(s,c,.75),o.setY(o.y+h.length()*parseFloat(i.curvatureCoefficient/100)),l.setY(l.y+h.length()*parseFloat(i.curvatureCoefficient/100));let u=new vl(s,o,l,c);var p=u.getPoints(32),m=u.getPointAt(.5);let f=[];p.forEach((e=>{f.push(e.x),f.push(e.y),f.push(e.z)}));let g="texture/odline/"+i.imageType.toLowerCase()+".jpg";Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,g),(s=>{s.wrapS=d,s.wrapT=d;let o=_y.interpolate(f,3,50,!0),l=o/(i.lineWidth*Ep.worldScale/s.image.height*s.image.width);"default"===i.imageType.toLowerCase()?l/=4:"ray"===i.imageType.toLowerCase()&&(l=1);var c=new lb.MeshLineMaterial({fog:Uy,map:s,maskMap:s,useMaskMap:!0,color:new Qt(i.color),opacity:1,resolution:new ye(window.innerWidth,window.innerHeight),sizeAttenuation:1,lineWidth:i.lineWidth*Ep.worldScale,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,alphaTest:.05,transparent:!0,side:2,repeat:new ye(l,1),outlineColor:new Qt(Ep.drawableClickColor)}),h=new lb.MeshLine;h.setGeometry(p);var u=new Fi(h.geometry,c);u.onBeforeRender=function(){this.userData.inView=!0};const g=i.animationSpeed*Ep.worldScale/o;let y=new Lv(c,!0,!1,-g,0);Ep.animationStore.add(y),u.material.uniforms.dashOffset.value=1.5,u.labelPoint=m,u.raycast=h.raycast,u.name=t,r.add(u),r.position.set(u.position.x,u.position.y,u.position.z),r.userData.mesh=u;var v=null;null!=n&&n.enableText&&((v=_E.createText(r,n)).position.set(m.x,m.y,m.z),v.name=t),null!=i.enableAutoHidebyDistance&&(r.activeVisible=!0,r.distance=new Ce,r.distance.set(m.x,m.y,m.z),r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.minDistance*Ep.worldScale,r.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r)),e.add(t,r),i.isShow?(r.visible=!0,r.activeVisible=!0):(r.visible=!1,r.activeVisible=!1),a&&a(1,m)}))},this.addInstancedODLine=function(t,i,n,a){if(!(i.points instanceof Array))return;let r,s,o,l;r=new Ce(0,0,0),l=new Ce(1,0,1),s=new Ce,o=new Ce;var c=l.clone().add(r.clone().divideScalar(-1));s.lerpVectors(r,l,.25),o.lerpVectors(r,l,.75),s.setY(s.y+c.length()*parseFloat(i.curvatureCoefficient/100)),o.setY(o.y+c.length()*parseFloat(i.curvatureCoefficient/100));let h=new vl(r,s,o,l);var u=h.getPoints(32),p=h.getPointAt(.5);let m=[];u.forEach((e=>{m.push(e.x),m.push(e.y),m.push(e.z)}));let f=[],g={};for(let e of i.points)"string"==typeof e.imageType&&(f.includes(e.imageType)||f.push(e.imageType),g[e.imageType]||(g[e.imageType]=[]),g[e.imageType].push(e));var y=new sr;y.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),y.name=t,new _s(1,32).rotateX(Math.PI/-2);for(let e of f){let n="texture/odline/"+e.toLowerCase()+".jpg";Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,n),(n=>{n.wrapS=d,n.wrapT=d;_y.interpolate(m,3,0,!0);i.lineWidth,Ep.worldScale,n.image.height,n.image.width,"default"===e.toLowerCase()||e.toLowerCase();var r=new Kt({color:new Qt(16776960)}),s=new lb.MeshLine;s.setGeometry(u);let o=new Qr(s,r,zy);o.count=g[e].length,o.name=t,o.onBeforeRender=function(){this.userData.inView=!0},o.instanceMatrix.setUsage(ue);let l=new Et;for(let t=0;t<g[e].length;t++){let i=g[e][t];l.scale.set(i.endPos.x-i.startPos.x,0,i.endPos.z-i.startPos.z),l.scale.y=Math.sqrt(l.scale.x*l.scale.x+l.scale.z*l.scale.z),l.position.set(i.startPos.x,i.startPos.y,i.startPos.z),l.updateMatrix(),o.setMatrixAt(t,l.matrix.clone()),o.setColorAt(t,new Qt(i.color))}o.instanceColor.needsUpdate=!0,o.instanceMatrix.needsUpdate=!0,y.add(o),y.userData.mesh=o,a&&a(1,p)}))}e.add(t,y)},this.addHeatMapLayer=function(t,i){var n=document.createElement("canvas");0==i.opacity&&(i.opacity=1e-7);var a=LT.create({container:n,gradient:i.gradient,opacity:i.opacity,radius:10,blur:.75,width:i.width,height:i.height}),r=n.getElementsByTagName("canvas")[0];let s=new sn(i.width,i.height),o=new we(r),l=new Yi({fog:Uy,uniforms:{map:{value:o},bgMap:{value:u},color:{value:new Qt(1,1,1)},brightness:{value:1}},vertexShader:rb.vertexShader,fragmentShader:rb.fragmentShader,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,transparent:!0,side:2,polygonOffset:!0,polygonOffsetFactor:.1,polygonOffsetUnits:-4});if("dot"===i.style){var c=Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,"texture/heatmap/heatmap-dot.png"));c.wrapS=d,c.wrapT=d,l.uniforms.bgMap.value=c}else if("line"===i.style){var h=Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,"texture/heatmap/heatmap-line.png"));h.wrapS=d,h.wrapT=d,l.uniforms.bgMap.value=h}else{var u=Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,"texture/heatmap/heatmap-none.png"));u.wrapS=d,u.wrapT=d,l.uniforms.bgMap.value=u}l.uniforms.map.value.needsUpdate=!0;var p=new Fi(s,l);p.onBeforeRender=function(){this.userData.inView=!0},p.name=t,null!=i.enableAutoHidebyDistance&&(p.activeVisible=!0,p.enableAutoHidebyDistance=i.enableAutoHidebyDistance,p.minDistance=i.minDistance*Ep.worldScale,p.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,p));let m=new sr;m.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),m.name=t,m.add(p),m.userData={dom:r,heatmap:a,plane:p},m.position.set(i.pos.x,i.pos.y,i.pos.z),p.rotation.x=-Math.PI/2+i.rotation.x,p.rotation.y=i.rotation.y,p.rotation.z=i.rotation.z,e.add(t,m),i.isShow?(m.activeVisible=!0,m.visible=!0):(m.activeVisible=!1,m.visible=!1)},this.updateHeatMapData=function(t,i,n,a,r=1){var s=e.find(t);if(null!=s.userData){var o=s.userData.heatmap;null!=o&&o.setData({min:i,max:n,data:a});var l=s.userData.plane;l.scale.setScalar(r*Ep.worldScale);var c=s.userData.dom;if(null!=l&&null!=c){let e=new we(c);l.material.uniforms.map.value=e,l.material.uniforms.map.value.needsUpdate=!0}}},this.addHeatMapLayer_ecef=function(t){const i=t.getFullName();e.remove(i);const n=[];for(const e of t.points)n.push(this.convertLLAToXYZ({x:e.lon,y:e.lat,z:e.alt}));const a=new Re;a.setFromPoints(n);const r=new Ce;a.getCenter(r);const s=this.convertXYZToLLA(r.clone()),o=ge.degToRad(90-s.y),l=ge.degToRad(90+s.x),c=new Ee;c.setFromEuler(new dt(o,l,0,"YXZ")).invert();for(const e of n)e.applyQuaternion(c);a.setFromPoints(n);const h=new Ce;a.getSize(h);const u=t.radius*Ep.worldScale,p=Math.ceil(h.x+2*u),m=Math.ceil(h.z+2*u),f=55500*Ep.worldScale,g=Math.ceil(p/f),y=Math.ceil(m/f),v=new sn(p,m,g,y),b=new dt;b.x=-Math.PI/2;const _=new it;_.makeRotationFromEuler(b),v.applyMatrix4(_),a.getCenter(r),r.copy(this.convertXYZToLLA(r)),r.z=t.points[0].alt,r.copy(this.convertLLAToXYZ(r)),r.applyQuaternion(c.invert());const x=this.convertXYZToLLA(r);b.order="YXZ",b.y=ge.degToRad(90+x.x),b.x=ge.degToRad(90-x.y),_.makeRotationFromEuler(b),_.setPosition(r.x,r.y,r.z),v.applyMatrix4(_);const w=v.attributes.position.array,S=new Ce,M=r.length(),T=r.lengthSq(),A=r.clone().normalize();for(let e=0;e<w.length;e+=3){S.fromArray(w,e);const t=S.clone().sub(r).lengthSq();A.setLength(M-Math.sqrt(T-t)),S.sub(A).toArray(w,e)}let E="texture/heatmap/heatmap-none.png";"dot"===t.style&&(E="texture/heatmap/heatmap-dot.png"),"line"===t.style&&(E="texture/heatmap/heatmap-line.png");const C=Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,E));C.wrapS=d,C.wrapT=d;const I=new Yi({fog:Uy,uniforms:{map:{value:null},bgMap:{value:C},color:{value:new Qt(1,1,1)},brightness:{value:1}},vertexShader:rb.vertexShader,fragmentShader:rb.fragmentShader,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,transparent:!0,side:2,polygonOffset:!0,polygonOffsetFactor:.1,polygonOffsetUnits:-4}),P=document.createElement("canvas"),R=LT.create({container:P,gradient:t.gradient,opacity:0==t.opacity?1e-7:t.opacity,radius:10,blur:.75,width:p,height:m}),O=Math.min(...t.points.map((e=>e.value))),D=Math.max(...t.points.map((e=>e.value))),L=Math.min(...n.map((e=>e.x))),k=Math.min(...n.map((e=>e.z))),N=[];for(let e=0;e<n.length;e++)N.push({x:n[e].x-L+u,y:n[e].z-k+u,value:t.points[e].value,radius:u});R.setData({min:O,max:D,data:N});const B=P.getElementsByTagName("canvas")[0];I.uniforms.map.value=new we(B),I.uniforms.map.value.needsUpdate=!0;const z=new Fi(v,I);z.onBeforeRender=function(){this.userData.inView=!0},z.name=i;var U=new sr;U.renderOrder=Fy+t.zLevel,U.name=i,U.add(z),U.activeVisible=!!t.isShow,U.visible=!!t.isShow,null!=t.enableAutoHidebyDistance&&(U.activeVisible=!0,U.enableAutoHidebyDistance=t.enableAutoHidebyDistance,U.minDistance=t.minDistance*Ep.worldScale,U.maxDistance=t.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(i,yy,Ep.camera,U)),Ep.objectStore.add(i,U)},this.addArea=function(t,i,n,a){if(i.areaType)return void se.call(this,t,i,n,a);var r=new sr;r.renderOrder=Fy+("number"==typeof i.renderOrder?i.renderOrder:0),r.name=t;for(var s=[],o=0;o<i.point.length;o+=2)s.push(new ye(i.point[o],i.point[o+1]));s.push(new ye(i.point[0],i.point[1]));var l,c,h=new El(s),u={depth:i.depth*Ep.worldScale,bevelEnabled:!1,bevelSegments:1,steps:1,bevelSize:1,bevelThickness:10},d=new Fi(new ao(h,u),new Kt({fog:Uy,transparent:!0,color:new Qt(i.color),shininess:0,opacity:i.alpha,depthWrite:!0,depthTest:Ep.drawableDepthTest,depthFunc:1}));d.onBeforeRender=function(){this.userData.inView=!0},d.name=t,r.add(d),d.geometry.computeBoundingSphere(),d.updateMatrixWorld(!0),null!=d.geometry.boundingSphere&&(l=d.geometry.boundingSphere.center),c=i.followPolygonColor?new Qt(i.color):new Qt(i.lineColor);var p=new ou({fog:Uy,opacity:i.lineAlpha,color:c,linewidth:i.lineWidth*Ep.worldScale,dashed:!1,depthWrite:Ep.drawableDepthTest,depthTest:Ep.drawableDepthTest,transparent:!0});i.lineFlag||(p.visible=!1);for(var m=new cu,f=[],g=0;g<s.length;g++)f.push(s[g].x),f.push(s[g].y),f.push(0);m.setPositions(f);var y=new hu(m,p);y.computeLineDistances(),y.scale.set(1,1,1),y.name=t,r.add(y);var v=null;null!=n&&n.enableText&&((v=_E.createText(r,n)).name=t,v.position.set(l.x,l.y,l.z)),r.rotation.set(.5*Math.PI,0,0),i.offset&&r.position.set(i.lonOffset,i.altOffset,i.latOffset),null!=i.enableAutoHidebyDistance&&(r.activeVisible=!0,r.enableAutoHidebyDistance=i.enableAutoHidebyDistance,r.minDistance=i.minDistance*Ep.worldScale,r.maxDistance=i.maxDistance*Ep.worldScale,Ep.animationStore.addDistance(t,yy,Ep.camera,r));let b=Ep.animationStore.findNodeAnimation(t,iv.type);b&&Ep.animationStore.remove(b);let _=new ye(window.innerWidth,window.innerHeight);b=new iv(p,_),Ep.animationStore.add(b),e.add(t,r),i.isShow?(r.activeVisible=!0,r.visible=!0,!n.enableText&&v&&(v.visible=!1)):(r.activeVisible=!1,r.visible=!1,v&&(v.visible=!1))},this.removeLayer=function(t){var i=t.substr(t.lastIndexOf("/")+1,t.length-t.lastIndexOf("/"));if("connection"!=i&&"path"!=i||Ep.defaultObjectTree.dispose(t),"trail"!=i&&"modeltrail"!==i||(e.remove(t+"Line"),Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(t+"Line",yy.type)),Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(t,Pv.type)),D.remove(t)),"area"==i&&Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(t,iv.type)),"odline"==i&&Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(t,Tv.type)),"bubble"==i&&Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(t,Mv.type)),"landmark"==i&&Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type){let i=e.find(t);if(i){let e=Ep.animationStore.findDrawableAnimation(i,fv.type);e&&Ep.animationStore.remove(e)}}"instancedbubble"==i&&this.removeInstancedBubble(t),e.remove(t),Ep.animationStore.remove(Ep.animationStore.findNodeAnimation(t,yy.type));for(const e in q){const i=q[e],n=i.objectNames.indexOf(t);if(-1!==n){if(i.objectNames.splice(n,1),e.includes("/icons/universal/pin.png")||e.includes("/icons/universal/none.png"))continue;i.objectNames.length<=0&&(i.map.dispose(),delete q[e])}}},this.showLayer=function(t){if(e.find(t)&&(e.find(t).visible=!0,e.find(t).activeVisible=!0,Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type)){const i=e.find(t);if(i){const e=Ep.animationStore.findDrawableAnimation(i,fv.type);e&&(e.objectVisible0=!0)}}const i=Ep.defaultObjectTree.findItemByName(t);i&&"LineItem"==i.type&&i.show()},this.hideLayer=function(t){if(e.find(t)&&(e.find(t).visible=!1,e.find(t).activeVisible=!1,Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type)){const i=e.find(t);if(i){const e=Ep.animationStore.findDrawableAnimation(i,fv.type);e&&(e.objectVisible0=!1)}}const i=Ep.defaultObjectTree.findItemByName(t);i&&"LineItem"==i.type&&i.hide()},this.addFireworks=function(e){e.type="fireworks",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateFireworks=function(e,t){t.type="fireworks",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showFireworks=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideFireworks=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameFireworks=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeFireworks=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.addFirefly=function(e){e.type="firefly",this.defaultEffectStore.spaceEffect.addEffect(e)},this.addFireFly=function(e){return this.addFirefly(e)},this.updateFirefly=function(e,t){t.type="firefly",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.updateFireFly=function(e,t){return this.updateFirefly(e,t)},this.showFirefly=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.showFireFly=function(e){return this.showFirefly(e)},this.hideFirefly=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.hideFireFly=function(e){return this.hideFirefly(e)},this.renameFirefly=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.renameFireFly=function(e,t){return this.renameFirefly(e,t)},this.removeFirefly=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.removeFireFly=function(e){return this.removeFirefly(e)},this.addRainline=function(e){e.type="rainline",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateRainline=function(e,t){t.type="rainline",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showRainline=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideRainline=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameRainline=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeRainline=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.addRain=function(e){e.type="rain",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateRain=function(e,t){t.type="rain",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showRain=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideRain=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameRain=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeRain=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.addSnow=function(e){e.type="snow",this.defaultEffectStore.spaceEffect.addEffect(e)},this.updateSnow=function(e,t){t.type="snow",this.defaultEffectStore.spaceEffect.updateEffect(e,t)},this.showSnow=function(e){this.defaultEffectStore.spaceEffect.showEffect(e)},this.hideSnow=function(e){this.defaultEffectStore.spaceEffect.hideEffect(e)},this.renameSnow=function(e,t){this.defaultEffectStore.spaceEffect.renameEffect(e,t)},this.removeSnow=function(e){this.defaultEffectStore.spaceEffect.removeEffect(e)},this.add3DMarker=function(e,t){(new Ix).load(e,((i,n)=>{Ep.objectStore.add(e.name,n);let a=new sr;if(a.name=e.name+"title",n.add(a),e.canvas){let t=_E.createText(a,{canvas:e.canvas,sizeAttenuation:!1,width:414e-6*e.canvas.width,height:414e-6*e.canvas.height,offsetV:.5,offsetH:.5,enableText:!0});t.name=e.name,t.position.y=e.titleHeight*e.size*Ep.worldScale}n.visible=e.isShow,n.activeVisible=e.isShow,Ep.datumShiftModel&&"ecef"===Ep.datumShiftModel.type&&(n.rotation.order="YXZ",n.rotation.y=(e.pos.lon+90)/180*Math.PI,n.rotation.x=(90-e.pos.lat)/180*Math.PI),t&&t(i,n)}))},this.update3DMarker=function(t,i,n){let a=e.find(t);if(a.children[0].path!==i.path)this.removeLayer(t),this.add3DMarker(i,n);else{a.remove(a.children[a.children.length-1]);let e=new sr;if(e.name=i.name+"title",a.add(e),i.canvas){let t=_E.createText(e,{canvas:i.canvas,sizeAttenuation:!1,width:414e-6*i.canvas.width,height:414e-6*i.canvas.height,offsetV:.5,offsetH:.5,enableText:!0});t.name=i.name,t.position.y=i.titleHeight*i.size*Ep.worldScale}a.position.set(i.position[0],i.position[1],i.position[2]),a.children[0].scale.setScalar(i.size*Ep.worldScale),a.traverse((e=>{e.isMesh&&(i.opacity<.99?e.material.transparent=!0:e.material.transparent=e.userData.transparent,e.material.opacity=i.opacity)})),n&&n(1,a)}},this.addAnimatedSprite=(e={},t,i=!1)=>{e.url&&Ep.loaders.textureLoader.load(_y.url(this.resourceBasePath,e.url),(n=>{let a=new vr({map:n,depthTest:!!e.depthTest});a.rotation=ge.degToRad(e.rotation||0);let r=new bE(a,{dimension:e.dimension,duration:e.duration,fadeInFrame:e.fadeInFrame,fadeOutFrame:e.fadeOutFrame,loop:e.loop,destroyOnFinish:!!e.destroyOnFinish});r.name=e.name||_y.randomString(8),e.center=e.center||[.5,.5],e.position=e.position||{x:0,y:0,z:0},void 0===e.scale&&(e.scale=1),r.center.set(e.center[0],e.center[1]),r.scale.setScalar(e.scale*Ep.worldScale*3.75),r.renderOrder=9999,Ep.animationStore.add(r);const s=new sr;s.name=e.name,s.add(r),s.position.set(e.position.x,e.position.y,e.position.z);const o=new sr;if(o.name=e.name+"title",s.add(o),e.canvas){let t=_E.createText(o,{canvas:e.canvas,sizeAttenuation:!1,width:414e-6*e.canvas.width,height:414e-6*e.canvas.height,offsetV:.5,offsetH:.5,enableText:!0});t.name=e.name,t.position.y=e.titleHeight*e.scale*Ep.worldScale,t.renderOrder=Fy+("number"==typeof e.zLevel?e.zLevel:0)}s.visible=e.isShow,s.activeVisible=e.isShow,i||Ep.objectStore.add(s.name,s),e.autoPlay&&r.play(),"function"==typeof t&&t(s)}))},this.getStatistics=()=>Ep.renderer?Ep.rendererInfo:{fps:0,geometries:0,textures:0,calls:0,faces:0,vertices:0},this._onWebContextLost=()=>{document.getElementById("panel").innerHTML="<p>场景显示异常,请刷新重试！</p>",clearInterval(z),z=null},this._findFpsValueElement=(e,t)=>{let i=e.getElementsByClassName(t);if(!i.length)return e;let n=i[0].children.length;return n?i[0].children[n-1]:i[0]},this.fpsPanelOn=()=>{let e=document.createElement("div");e.setAttribute("id","panel"),e.className="fps-panel",e.innerHTML='<p style="margin-left: 50px;float: left;" class="fps"><label class="fps-label"><span class="fps-span">帧率</span><spap>：</span></label><span class="fps-value">0</span></p><p style="margin-left: 20px;float: left;" class="faces"><label class="fps-label"><span class="fps-span">三角面数</span><spap>：</span></label><span class="fps-value">0</span></p><p style="margin-left: 20px;float: left;" class="vertices"><label class="fps-label"><span class="fps-span">顶点数</span><spap>：</span></label><span class="fps-value">0</span></p><p style="margin-left: 20px;float: left;" class="calls"><label class="fps-label"><span class="fps-span">绘制调用</span><spap>：</span></label><span class="fps-value">0</span></p>',e.style="position: absolute;\n                      min-width: 543px;\n                      max-width: 80%;\n                      padding: 0 10px;\n                      height: 32px;\n                      left: 50%;\n                      transform: translateX(-50%);\n                      bottom: 20px;\n                      border-radius:8px;\n                      background-color: rgba(0,0,0,0.5);\n                      line-height: 32px;\n                      font-size: 14px;\n                      color: #CCCCCC;",this.container.appendChild(e);let t=document.getElementsByClassName("fps-panel")[0],i=this._findFpsValueElement(t,"fps"),n=this._findFpsValueElement(t,"faces"),a=this._findFpsValueElement(t,"vertices"),r=this._findFpsValueElement(t,"calls");z=setInterval((()=>{let e=this.getStatistics(),t=_y.formatWithRegex(e.fps);i.innerText=t,Number(t||0)<15?(i.classList.remove("is-normal"),i.classList.add("is-low")):(i.classList.remove("is-low"),i.classList.add("is-normal")),n.innerText=_y.formatWithRegex(e.faces),a.innerText=_y.formatWithRegex(e.vertices),r.innerText=_y.formatWithRegex(e.calls)}),1e3),Ep&&Ep.renderer&&Ep.renderer.getContext()&&Ep.renderer.getContext().canvas&&Ep.renderer.getContext().canvas.removeEventListener&&Ep.renderer.getContext().canvas.removeEventListener("webglcontextlost",this._onWebContextLost,!1),Ep&&Ep.renderer&&Ep.renderer.getContext()&&Ep.renderer.getContext().canvas&&Ep.renderer.getContext().canvas.addEventListener&&Ep.renderer.getContext().canvas.addEventListener("webglcontextlost",this._onWebContextLost,!1)},this.fpsPanelOff=()=>{clearInterval(z),z=null,document.getElementById("panel")&&document.getElementById("panel").remove(),Ep&&Ep.renderer&&Ep.renderer.getContext()&&Ep.renderer.getContext().canvas&&Ep.renderer.getContext().canvas.removeEventListener&&Ep.renderer.getContext().canvas.removeEventListener("webglcontextlost",this._onWebContextLost,!1)},this.leftButtonHandle=e=>{Ep.orbitControls.keyOperate=e},this.autoRotate=(e,t=!0,i)=>{let n=_y.isNumber(e)&&0!==e;n&&t?Ep.orbitControls.addEventListener("start",this.interruptCameraFly):Ep.orbitControls.removeEventListener("start",this.interruptCameraFly),Ep.autoRotateChange=i,Ep.orbitControls.autoRotate=n,Ep.orbitControls.autoRotateSpeed=e},this.setAutoRotate=function(e,t,i,n){e?this.autoRotate(t,i,n):this.autoRotate(0)},this.addDirectionalLight=e=>{logger.debug("TRACE: Core.addDirectionalLight() - Entering.",e),Ep.lightStore.setDirectionalLight(e),logger.debug("TRACE: Core.addDirectionalLight() - Leaving.",e)},this.setDirectionalLight=e=>{logger.debug("TRACE: Core.setDirectionalLight() - Entering.",e);let t=JSON.parse(JSON.stringify(e));Ep.lightStore.setDirectionalLight(t),logger.debug("TRACE: Core.setDirectionalLight() - Leaving.",e)},this.removeDirectionalLight=e=>{logger.debug("TRACE: Core.removeDirectionalLight() - Entering.",e),Ep.lightStore.removeDirectionalLight(e),logger.debug("TRACE: Core.removeDirectionalLight() - Leaving.",e)},this.setLightHelperSize=e=>{Ep.lightStore._getLightGroup().traverse((t=>{t instanceof eE&&t.children[0].scale.set(e,e,e)}))},this.exportScene=(e,t,i)=>{if(logger.debug("TRACE: Core.exportScene() - Entering."),!v.dhExporter)return void logger.error("未定义导出器，无法导出。");let n;n=i&&"number"==typeof i.maxTextureSize?i.maxTextureSize:1/0;let a=1;i&&"number"==typeof i.textureSizeFactor&&(.5!==i.textureSizeFactor&&.25!==i.textureSizeFactor&&.125!==i.textureSizeFactor||(a=i.textureSizeFactor)),v.dhExporter.exportBlob({type:"glb",maxTextureSize:n,minTextureSize:1,textureSizeFactor:a,onFinish:e,onError:t}),logger.debug("TRACE: Core.exportScene() - Leaving.")},this.exportPackScene=(e,t,i)=>{if(logger.debug("TRACE: Core.exportPackScene() - Entering."),!v.dhExporter)return void logger.error("未定义导出器，无法导出。");let n;n=i&&"number"==typeof i.maxTextureSize?i.maxTextureSize:1/0;let a=1;i&&"number"==typeof i.textureSizeFactor&&(.5!==i.textureSizeFactor&&.25!==i.textureSizeFactor&&.125!==i.textureSizeFactor||(a=i.textureSizeFactor)),v.dhExporter.exportPackBlob({type:"glb",packSettings:i.packSettings,maxTextureSize:n,minTextureSize:1,textureSizeFactor:a,onFinish:e,onError:t}),logger.debug("TRACE: Core.exportPackScene() - Leaving.")},this.showLightHelpers=()=>{logger.debug("TRACE: Core.showLightHelpers() - Entering."),Ep.lightStore.showLightHelpers(),logger.debug("TRACE: Core.showLightHelpers() - Leaving.")},this.hideLightHelpers=()=>{logger.debug("TRACE: Core.hideLightHelpers() - Entering."),Ep.lightStore.hideLightHelpers(),logger.debug("TRACE: Core.hideLightHelpers() - Leaving.")},this.convertWorldToScreen=e=>{var t=new Ce(e.x,e.y,e.z).project(Ep.camera),i=this.container.clientWidth/2,n=this.container.clientHeight/2;return{x:Math.round(t.x*i+i),y:Math.round(-t.y*n+n),accurate_x:t.x*i+i,accurate_y:-t.y*n+n}},this.convertScreenToWorld=({x:e,y:t,z:i=.5},n)=>{const a=e/Ep.renderer.domElement.clientWidth*2-1,r=-t/Ep.renderer.domElement.clientHeight*2+1,s=new Ce(a,r,i).unproject(Ep.camera);void 0!==n&&n.copy(s);const o=Ep.camera.position.clone(),l=s.clone().sub(o).normalize(),c=new tt(s,l),h=new Rt(new Ce(0,1,0),0);let u=new Ce;return c.intersectPlane(h,u),u},this.convertNDCToWorld=(e,t)=>{const i=e.x,n=e.y;if("string"==typeof t)switch(t.toLowerCase()){case"cameraortho":case"ortho":case"orthocamera":case"orthographic":case"orthographiccamera":t=Ep.cameraOrtho;break;case"camera":case"perspective":case"perspectivecamera":default:t=Ep.camera}t instanceof Zi||t instanceof jl||(t=Ep.camera);return new Ce(i,n,.5).unproject(t)},this.pickScreenToWorld=e=>{const t=e.x,i=e.y;let n=new ye(t/this.container.scrollWidth*2-1,-i/this.container.scrollHeight*2+1);T.setFromCamera(n,Ep.camera);const a=[],r=Ep.scene.getObjectByName("__models");r&&r.traverse((function(e){a.push(e)}));const s=Ep.scene.getObjectByName("__tilesGroup");s&&s.children[0]&&a.push(s.children[0]);let o=T.intersectObjects(a);if(Ep.scene.getObjectByName("__pgl")&&Ep.pgl.terrain){let t=Ep.pgl.terrain.pickTerrain({x:e.x,y:e.y});if(t&&t.hit){for(let e=0;e<o.length;e++)if(o[e].distance>t.distance){o.splice(e,0,t);break}(0===o.length||t.distance>o[o.length-1].distance)&&o.push(t)}}let l=[];for(let e=0;e<o.length;e++){if(!1===o[e].object.visible||!1===_y.judegParentIsVisible(o[e].object))continue;let t=_y.findObjectToBuilding(o[e].object.uuid);if(t){let i=Ep.clippingStore.findCutBulidingByUUID(t.getGroup().uuid);if(i&&i.clippingController.pointClipTest(o[e].point))continue}l.push(o[e])}if(l.length>0){var c=l[0];if(c.distance>=0)return c.point}return{x:0,y:0,z:0,flag:!1}},this.pickNDCToWorld=(e,t)=>{const i=e.x,n=e.y;let a=new ye(i,n);if("string"==typeof t)switch(t.toLowerCase()){case"cameraortho":case"ortho":case"orthocamera":case"orthographic":case"orthographiccamera":t=Ep.cameraOrtho;break;case"camera":case"perspective":case"perspectivecamera":default:t=Ep.camera}t instanceof Zi||t instanceof jl||(t=Ep.camera),T.setFromCamera(a,t);let r=T.intersectObjects(Ep.scene.models.children,!0);if(r.length>0){let e=-1;for(let t=0;t<r.length;t++)if(r[t].object.visible){e=t;break}if(-1===e)return{x:0,y:0,z:0};let t=r[0];if(t.distance>=0)return t.point}return{x:0,y:0,z:0}},this.convertWorldToSceneLocal=e=>{let t=new Me(e.x,e.y,e.z,1),i=Ep.scene.models.matrix.clone();return i.invert(),t.applyMatrix4(i),new Ce(t.x,t.y,t.z)},this.addModel=(e,t,i)=>(logger.debug("TRACE: Core.addModel() - Entering.",e),this.resetSettings(),e=e||{},logger.debug("TRACE: Core.addModel() - Leaving and return a Promise."),new Promise(((n,a)=>{if(Ep.loaders.gltfLoader||(t&&t(0,"No loader initiated."),a(new Error("No loader initiated."))),e.name||(e.name=_y.guid()),Ep.modelStore.find(e.name))return t&&t(0,`Model with name ${e.name} already exists.`),void a(new Error(`Model with name ${e.name} already exists.`));Ep.cacheStore.load({path:e.modelPath,type:"glb",onLoad:i=>{i.name=e.name;const a=_y.md5(e.modelPath);i.scene.sourceModelKey=a,i.scene.traverse((e=>{if(_y.capableForCastingShadow(e)&&(R++,e.castShadow=!0,e.receiveShadow=!0),e.material instanceof So){e.material.alphaTest=.05,e.material.depthWrite=!0,e.material.depthTest=!0,e.material.vertexColors=!1,e.material.needsUpdate=!0;for(let t in e.material)e.material[t]instanceof we&&e.material[t].image&&Ep.textureStore.add(e.material[t].name||`${e.material.name}#${t}`,e.material[t],a);Ep.materialStore.add(e.material.name,e.material,e)}})),t&&t(1),n(),setTimeout((()=>{this.focus()}),500)},onProgress:i,onError:e=>{t?t(0,e):logger.debug(e),a(e)}})}))),this.rankUpNode=(e,t)=>{this.defaultObjectTree.rankUp(e,t)},this.rankDownNode=(e,t)=>{this.defaultObjectTree.rankDown(e,t)},this.preloadScene=(e,t,i,n)=>{if(!Ep.sceneStore.findScene(e.serviceName))return logger.debug("TRACE: Core.preloadScene() - Entering.",e),(e=e||{}).token&&e.token.length>64&&this.setAvwToken("header","authorization:bearer",e.token),new Promise(((a,r)=>{e.scenePath&&""!=e.scenePath||r("场景预载失败：params.scenePath为空！"),Ep.loaders.gltfLoaderAVWS.load(e.scenePath,(()=>{Ep.sceneStore.addScene(e.serviceName,e.scenePath,e.token),t&&t({result:1,message:"场景预载完毕。"}),n&&n({name:e.serviceName,default:!1}),a()}),(e=>{i&&i({type:"progress",total:e.total,loaded:e.loaded})}),(()=>{t?t({result:0,message:`场景预载失败：${e.scenePath}`}):logger.warn(`场景预载失败：${e.scenePath}`),r(`场景预载失败：${e.scenePath}`)}))}));t&&t({result:0,message:"服务已存在!"})},this.preloadResource=(e,t,i,n,{needExport:a=!1,newImport:r=!1}={})=>{logger.debug("TRACE: Core.preloadResource() - Entering.",e),logger.debug("TRACE: Core.preloadResource() - Leaving and return a Promise."),Ep.preloads||(Ep.preloads=[]);for(let t=0;t<Ep.preloads.length;t++)if(Ep.preloads[t].key===e)return void Ep.preloads[t].callback.push(i);Ep.preloads.push({key:e,total:0,loaded:0,status:0,callback:[i]}),Ep.cacheStore.load({path:e,type:t,needExport:a,newImport:r,onLoad:()=>{for(let t=0;t<Ep.preloads.length;t++)if(Ep.preloads[t].key===e){Ep.preloads[t].status=1;break}let t=!0;for(let e=0;e<Ep.preloads.length;e++)0===Ep.preloads[e].status&&(t=!1);if(t){for(let t=0;t<Ep.preloads.length;t++)1===Ep.preloads[t].status?Ep.preloads[t].callback.forEach((t=>{"function"==typeof t&&t(1,`资源预载成功。${e}`)})):-1===Ep.preloads[t].status&&Ep.preloads[t].callback.forEach((t=>{"function"==typeof t&&t(0,`资源预载失败。${e}`)}));Ep.preloads.length=0}},onProgress:t=>{for(let i=0;i<Ep.preloads.length;i++)if(Ep.preloads[i].key===e){Ep.preloads[i].total=t.total,Ep.preloads[i].loaded=t.loaded;break}if(n){let e=0,t=0;for(let i=0;i<Ep.preloads.length;i++)e+=Ep.preloads[i].total,t+=Ep.preloads[i].loaded;n({type:"progress",total:e,loaded:t})}},onError:t=>{for(let t=0;t<Ep.preloads.length;t++)if(Ep.preloads[t].key===e){Ep.preloads[t].status=-1;break}let n=!0;for(let e=0;e<Ep.preloads.length;e++)0===Ep.preloads[e].status&&(n=!1);if(n){if("function"==typeof i){let e=0,t=0;for(let i=0;i<Ep.preloads.length;i++)1===Ep.preloads[i].status&&e++,-1===Ep.preloads[i].status&&t++;0===e?i(0,"资源预载失败。"):i(1,0===t?"资源预载成功。":"部分资源预载失败。")}Ep.preloads.length=0}}})},this.materialReplace=({path:e,material:t,onLoad:i,onProgress:n,newImport:a=!1,materialImg:r},s,o)=>{const l=_y.md5(e);this.preloadResource(e,"avwa",(()=>{let n=null,a=null,c=Ep.cacheStore._cache.get(fy(e));c.refCount<=1&&(c.refCount=2),c.resource.traverse((e=>{e.material&&!n&&(n=e.material.clone()),e.userData&&e.userData.dhAsset&&!a&&(a=e.userData.dhAsset)}));for(let e in n)n[e]instanceof we&&n[e].image&&Ep.customTextureStore.add(n[e].name||`${n.name}#${e}`,n[e],l);let h=JSON.parse(JSON.stringify(a.materials[n.name]));t.replace(n,e),h&&(h.name=t.name,h.materialImg=r,Ep.materialStore.setMaterialParam({[h.name]:h},h.name,t,s,o)),Ep.defaultObjectTree.children.map((e=>{"LineItem"==e.type&&e.update()})),i&&i()}),(e=>{n&&n(e)}),{needExport:!0,newImport:a})},this.loadTGAsset=(e,t,i)=>(logger.debug("TRACE: Core.loadScene() - Entering.",e),e=e||{},logger.debug("TRACE: Core.loadScene() - Leaving and return a Promise."),new Promise(((n,a)=>{e.name||(e.name=_y.guid()),Ep.instance.setMarkFreeze(),this.defaultObjectTree.loadModel({name:e.name,modelPath:e.assetPath,secretKey:e.secretKey},(async(e,i)=>{if("20220602-NEW-AVWS"===i.VERSION||"20230317-PACK-AVWS"===i.VERSION){Ep.sceneSettings=_y.cloneDeep(i),null!=i.sceneName&&(Ep.sceneName=i.sceneName),Ep.sceneSettings.datumShiftModel?(this.setDatumShiftModel(Ep.sceneSettings.datumShiftModel),"number"==typeof Ep.sceneSettings.datumShiftModel.scaleY?Ep.worldScale=Ep.sceneSettings.datumShiftModel.scaleX:Ep.worldScale=1,Ep.orbitControls.enablePan="ecef"!==Ep.sceneSettings.datumShiftModel.type):(this.setDatumShiftModel({lon:0,lat:0,alt:0,scaleX:1,scaleY:1,scaleZ:1,type:"surface"}),Ep.datumShiftModel={editor:{mode:"none"}},Ep.worldScale=1,Ep.orbitControls.enablePan=!0);let e=this.getStates(),n=Ep.stateStore.find(e[0].name),a=n.settings.view.camera.duration;n.settings.view.camera.duration=0,this.nextRender((()=>{this.applySceneSettings(n.settings,(()=>{this.nextRender((()=>{Ep.stateStore.syncAnimation(n,e[0].name),n.settings.view.camera.duration=a,Ep.instance.setMarkCrossfade(1e3),t&&t(1)}))}))}))}else{i&&(Ep.sceneSettings=_y.cloneDeep(i),null!=i.sceneName&&(Ep.sceneName=i.sceneName)),this.setColorSpace(Ep.sceneSettings.colorSpace||"linear");let e=Ep.sceneSettings,a=null;a=Ep.sceneSettings.states&&Ep.sceneSettings.states.length?JSON.parse(JSON.stringify(Ep.sceneSettings.states.find((e=>e.defaultState)).settings.view)):JSON.parse(JSON.stringify(e.view)),Ep.stateStore&&Ep.stateStore.applySettings(Ep.sceneSettings.states);let r=[];r.push(new Promise((e=>{this.defaultView.applySettings(a,(t=>{e(t)}),!0)}))),I=e&&e.lights?e.lights.skybox:"",this.defaultObjectTree.applySettings(e.objectTree),e.background&&(Ep.background.mode=e.background.mode),Ep.background.color=null,Ep.background.texture=null,r.push(new Promise((t=>{Ep.lightStore.applySettings(e.lights,(()=>{t()}),e.view.camera.duration)}))),e.background&&(e.background.colorCSSValue&&this.setBackgroundColor(e.background.colorCSSValue),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),null!=Ep.sceneSettings.sceneModelTransform&&null!=Ep.sceneSettings.sceneModelTransform.position?(Ep.scene.models.position.x=Ep.sceneSettings.sceneModelTransform.position.x,Ep.scene.models.position.y=Ep.sceneSettings.sceneModelTransform.position.y,Ep.scene.models.position.z=Ep.sceneSettings.sceneModelTransform.position.z,Ep.scene.models.rotation._order=Ep.sceneSettings.sceneModelTransform.rotation._order,Ep.scene.models.rotation._x=Ep.sceneSettings.sceneModelTransform.rotation._x,Ep.scene.models.rotation._y=Ep.sceneSettings.sceneModelTransform.rotation._y,Ep.scene.models.rotation._z=Ep.sceneSettings.sceneModelTransform.rotation._z,Ep.scene.models.scale.x=Ep.sceneSettings.sceneModelTransform.scale.x,Ep.scene.models.scale.y=Ep.sceneSettings.sceneModelTransform.scale.y,Ep.scene.models.scale.z=Ep.sceneSettings.sceneModelTransform.scale.z):(Ep.scene.models.position.x=0,Ep.scene.models.position.y=0,Ep.scene.models.position.z=0,Ep.scene.models.rotation._order="XYZ",Ep.scene.models.rotation._x=0,Ep.scene.models.rotation._y=0,Ep.scene.models.rotation._z=0,Ep.scene.models.scale.x=1,Ep.scene.models.scale.y=1,Ep.scene.models.scale.z=1),this.defaultEffectStore.applySettings(e.effects,(e=>{n(e)})),Ep.sceneSettings.datumShiftModel?(this.setDatumShiftModel(Ep.sceneSettings.datumShiftModel),"number"==typeof Ep.sceneSettings.datumShiftModel.scaleY?Ep.worldScale=Ep.sceneSettings.datumShiftModel.scaleX:Ep.worldScale=1,Ep.orbitControls.enablePan="ecef"!==Ep.sceneSettings.datumShiftModel.type):(this.setDatumShiftModel({lon:0,lat:0,alt:0,scaleX:1,scaleY:1,scaleZ:1,type:"surface"}),Ep.datumShiftModel={editor:{mode:"none"}},Ep.worldScale=1,Ep.orbitControls.enablePan=!0),Ep.sceneSettings.objectTree.children.forEach((e=>{"TileSetItem"===e.type&&r.push(new Promise((t=>{new bx(e,(e=>{t(e)}))})))})),Promise.all(r).then((e=>{Ep.hasUpgradeSuggest&&wx.checkSuggestOn();let i=this.getStates();this.setCurrentState(i[0].name,(()=>{this.nextRender((()=>{Ep.instance.setMarkCrossfade(1e3),t&&t(1)}))}))})),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type&&(e.children.forEach((e=>{e.level&&e.hide()})),e.floor)){e.room?this.cutLevelToRoom(e.getGroup().uuid,e.floor,e.room):this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<W.length;t++)W[t].uuid===e.getGroup().uuid&&(W.splice(t,1),t--);W.push({uuid:e.getGroup().uuid,level:e.floor})}}))}Ep.sceneSettings&&(window.avwMinMode=Ep.sceneSettings.minMode)}),(e=>{i&&i({type:"progress",total:e.total,loaded:e.loaded})})),n(),setTimeout((()=>{this.focus()}),500)}),(e=>{t&&t(0,"读取资产失败。"),logger.warn("读取资产失败。"),reject("读取资产失败。")}))),this.loadScene=(e,t,i)=>(logger.debug("TRACE: Core.loadScene() - Entering.",e),e=e||{},logger.debug("TRACE: Core.loadScene() - Leaving and return a Promise."),new Promise(((a,r)=>{e.name||(e.name=_y.guid()),Ep.instance.setMarkFreeze(),this.defaultObjectTree.loadModel({name:e.name,modelPath:e.scenePath,secretKey:e.secretKey},(async(e,i)=>{if(1!==e)return"function"==typeof t&&t(0,"读取场景失败。"),logger.warn("读取场景失败。"),void r("读取场景失败。");if("20220602-NEW-AVWS"===i.VERSION||"20230317-PACK-AVWS"===i.VERSION){if(Ep.sceneSettings=_y.cloneDeep(i),null!=i.sceneName&&(Ep.sceneName=i.sceneName),Ep.sceneSettings&&Ep.sceneSettings.publishQuality&&(Ep.publishQuality={...Ep.sceneSettings.publishQuality},Ep.publishQuality.resolution))switch(Ep.publishQuality.resolution.toLowerCase()){case"original":case"high":Ep.renderer.setPixelRatio(_),this.setResolution(n.width,n.height);break;case"medium":Ep.renderer.setPixelRatio(.75*_),this.setResolution(n.width,n.height);break;case"low":Ep.renderer.setPixelRatio(.5*_),this.setResolution(n.width,n.height)}Ep.sceneSettings.datumShiftModel?(this.setDatumShiftModel(Ep.sceneSettings.datumShiftModel),"number"==typeof Ep.sceneSettings.datumShiftModel.scaleY?Ep.worldScale=Ep.sceneSettings.datumShiftModel.scaleX:Ep.worldScale=1,Ep.orbitControls.enablePan="ecef"!==Ep.sceneSettings.datumShiftModel.type):(this.setDatumShiftModel({lon:0,lat:0,alt:0,scaleX:1,scaleY:1,scaleZ:1,type:"surface"}),Ep.datumShiftModel={editor:{mode:"none"}},Ep.worldScale=1,Ep.orbitControls.enablePan=!0);let e=this.getStates(),a=Ep.stateStore.find(e[0].name),r=a.settings.view.camera.duration;a.settings.view.camera.duration=0,this.nextRender((()=>{this.applySceneSettings(a.settings,(()=>{this.nextRender((()=>{Ep.stateStore.syncAnimation(a,e[0].name),a.settings.view.camera.duration=r,Ep.instance.setMarkCrossfade(1e3),t&&t(1)}))}))}),4)}else{i&&(Ep.sceneSettings=_y.cloneDeep(i),null!=i.sceneName&&(Ep.sceneName=i.sceneName)),this.setColorSpace(Ep.sceneSettings.colorSpace||"linear");let e=Ep.sceneSettings,n=null;n=Ep.sceneSettings.states&&Ep.sceneSettings.states.length?JSON.parse(JSON.stringify(Ep.sceneSettings.states.find((e=>e.defaultState)).settings.view)):JSON.parse(JSON.stringify(e.view)),Ep.stateStore&&Ep.stateStore.applySettings(Ep.sceneSettings.states);let r=[];r.push(new Promise((e=>{this.defaultView.applySettings(n,(t=>{e(t)}),!0)}))),I=e&&e.lights?e.lights.skybox:"",this.defaultObjectTree.applySettings(e.objectTree),e.background&&(Ep.background.mode=e.background.mode),Ep.background.color=null,Ep.background.texture=null,r.push(new Promise((t=>{Ep.lightStore.applySettings(e.lights,(()=>{t()}),e.view.camera.duration)}))),e.background&&(e.background.colorCSSValue&&this.setBackgroundColor(e.background.colorCSSValue),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),null!=Ep.sceneSettings.sceneModelTransform&&null!=Ep.sceneSettings.sceneModelTransform.position?(Ep.scene.models.position.x=Ep.sceneSettings.sceneModelTransform.position.x,Ep.scene.models.position.y=Ep.sceneSettings.sceneModelTransform.position.y,Ep.scene.models.position.z=Ep.sceneSettings.sceneModelTransform.position.z,Ep.scene.models.rotation._order=Ep.sceneSettings.sceneModelTransform.rotation._order,Ep.scene.models.rotation._x=Ep.sceneSettings.sceneModelTransform.rotation._x,Ep.scene.models.rotation._y=Ep.sceneSettings.sceneModelTransform.rotation._y,Ep.scene.models.rotation._z=Ep.sceneSettings.sceneModelTransform.rotation._z,Ep.scene.models.scale.x=Ep.sceneSettings.sceneModelTransform.scale.x,Ep.scene.models.scale.y=Ep.sceneSettings.sceneModelTransform.scale.y,Ep.scene.models.scale.z=Ep.sceneSettings.sceneModelTransform.scale.z):(Ep.scene.models.position.x=0,Ep.scene.models.position.y=0,Ep.scene.models.position.z=0,Ep.scene.models.rotation._order="XYZ",Ep.scene.models.rotation._x=0,Ep.scene.models.rotation._y=0,Ep.scene.models.rotation._z=0,Ep.scene.models.scale.x=1,Ep.scene.models.scale.y=1,Ep.scene.models.scale.z=1),this.defaultEffectStore.applySettings(e.effects,(e=>{a(e)})),Ep.sceneSettings.datumShiftModel?(this.setDatumShiftModel(Ep.sceneSettings.datumShiftModel),"number"==typeof Ep.sceneSettings.datumShiftModel.scaleY?Ep.worldScale=Ep.sceneSettings.datumShiftModel.scaleX:Ep.worldScale=1,Ep.orbitControls.enablePan="ecef"!==Ep.sceneSettings.datumShiftModel.type):(this.setDatumShiftModel({lon:0,lat:0,alt:0,scaleX:1,scaleY:1,scaleZ:1,type:"surface"}),Ep.datumShiftModel={editor:{mode:"none"}},Ep.worldScale=1,Ep.orbitControls.enablePan=!0),Ep.sceneSettings.objectTree.children.forEach((e=>{"TileSetItem"===e.type&&r.push(new Promise((t=>{new bx(e,(e=>{t(e)}))})))})),Promise.all(r).then((e=>{Ep.hasUpgradeSuggest&&wx.checkSuggestOn();let i=this.getStates();this.setCurrentState(i[0].name,(()=>{this.nextRender((()=>{Ep.instance.setMarkCrossfade(1e3),t&&t(1)}))}))})),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type&&(e.children.forEach((e=>{e.level&&e.hide()})),e.floor)){e.room?this.cutLevelToRoom(e.getGroup().uuid,e.floor,e.room):this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<W.length;t++)W[t].uuid===e.getGroup().uuid&&(W.splice(t,1),t--);W.push({uuid:e.getGroup().uuid,level:e.floor})}}))}Ep.sceneSettings&&(window.avwMinMode=Ep.sceneSettings.minMode)}),(e=>{i&&i({type:"progress",total:e.total,loaded:e.loaded})})),a(),setTimeout((()=>{this.focus()}),500)}),(e=>{"function"==typeof t&&t(0,"读取场景失败。"),logger.warn("读取场景失败。"),reject("读取场景失败。")}))),this.getTGServers=(e,t,i)=>{logger.debug("TRACE: Core.replaceTGServer() - Entering.",e),e=e||{},logger.debug("TRACE: Core.replaceTGServer() - Leaving and return a Promise."),e.path?Ep.loaders.gltfLoaderAVWS.load(e.path,(e=>{let i=[];new Promise((t=>{"20230317-PACK-AVWS"===e.scene.children[0].userData.dhExtension.VERSION?_y.setPackSettings(e.scene.children[0].userData.dhExtension.pack).then((e=>{t(e.objectTree.children)})):"20220602-NEW-AVWS"===e.scene.children[0].userData.dhExtension.VERSION&&t(e.scene.children[0].userData.dhExtension.objectTree.children)})).then((e=>{e.forEach((e=>{"TileSetItem"===e.type?i.push({type:"3dtile",url:e.url,format:"3dtile",key:""}):"GisItem"===e.type&&(i.push({type:"imagery",url:e.imagery.urlFormat,format:e.imagery.mapFormat,key:e.imagery.apiKey}),i.push({type:"elevation",url:e.elevation.urlFormat,format:e.elevation.terrainFormat,key:e.elevation.apiKey}))}))})),t&&t({success:!0,data:i})}),(e=>{i&&i(e)}),(e=>{t&&t({success:!1,error:e})})):logger.error("getTGServers params path undefined!")},this.calibrateCoordinate=e=>{e?this.switchCameraMode(1):this.switchCameraMode(0)},this.setCalibrateCoordinateParams=e=>{if(e.editor)if("none"!==e.editor.mode)if("basepoint"!==e.editor.mode)if("map"!==e.editor.mode)Ep.datumShiftModel={};else{if(!(e&&e.center&&e.bounds&&e.bounds.sw&&e.bounds.ne))return;if("number"!=typeof e.center.lon||"number"!=typeof e.center.lat)return;if("number"!=typeof e.bounds.sw.lon||"number"!=typeof e.bounds.sw.lat)return;if("number"!=typeof e.bounds.ne.lon||"number"!=typeof e.bounds.ne.lat)return;let t={lon:e.center.lon,lat:e.center.lat,alt:e.center.alt||0,x:0,y:0,z:0},i={lon:e.bounds.sw.lon,lat:e.bounds.sw.lat,x:0,z:0};e.bounds.ne.lon,e.bounds.ne.lat;let n=this.convertNDCToWorld({x:0,y:0},Ep.cameraOrtho),a=this.convertNDCToWorld({x:-1,y:-1},Ep.cameraOrtho),r=this.convertNDCToWorld({x:1,y:1},Ep.cameraOrtho);n.divideScalar(Ep.scene.models.scale.x),a.divideScalar(Ep.scene.models.scale.x),r.divideScalar(Ep.scene.models.scale.x),t.x=n.x,t.y=n.y,t.z=n.z,i.x=a.x,i.z=a.z;let s=_y.lonLatToWebMercator(t.lon,t.lat),o=_y.lonLatToWebMercator(i.lon,i.lat),l=2*(s.y-o.y)/(a.z-r.z),c=1/l,h={x:s.x-l*n.x,y:s.y+l*n.z};h.y+=.75/c;let u=_y.webMercatorToLonLat(h.x,h.y),d=u.lon,p=u.lat;this.setDatumShiftModel({type:"mercator",lon:0-h.x,lat:h.y,alt:0-t.alt,scaleX:c,scaleY:c*e.editor.YScale,scaleZ:c,origin:[d,p],editor:{mode:"map",lon:e.center.lon,lat:e.center.lat,alt:e.center.alt||0,rotation:this.getSceneRotationY(),scale:c,mapOperateMode:"default",mapCenter:[e.editor.mapCenter[0],e.editor.mapCenter[1]],mapZoom:e.editor.mapZoom,YScale:e.editor.YScale}})}else this.setDatumShiftModel({type:e.type,lon:e.lon,lat:e.lat,alt:e.alt,scaleX:e.scaleX,scaleY:e.scaleY,scaleZ:e.scaleZ,editor:{mode:"basepoint"}});else Ep.datumShiftModel={editor:{mode:"none"}};else logger.warn("setCalibrateCoordinateParams() 无效的参数。")},this.setBackgroundMode=(e,t={})=>{if(Ep.scene){if(Ep.scene&&Ep.scene.background instanceof Qt)switch(Ep.background.color=Ep.scene.background,Ep.renderer.outputEncoding){case te:Ep.background.color.convertLinearToSRGB&&Ep.background.color.convertLinearToSRGB();break;case ie:Ep.background.color.convertLinearToGamma&&Ep.background.color.convertLinearToGamma()}switch(Ep.scene&&Ep.scene.background&&Ep.scene.background instanceof we&&!(Ep.scene.background instanceof Qi)&&(Ep.background.texture=Ep.scene.background),Ep.scene&&Ep.scene.background&&Ep.scene.background instanceof Qi&&(Ep.background.cubeTexture=Ep.scene.background),"none"===e&&(F=null),Ep.background.mode=e,e.toLowerCase()){case"none":if(Ep.lightStore.disableLightProbe(),!Ep.scene)return;Ep.scene.background=null,Ep.scene&&!Ep.scene.environment&&t.lights&&t.lights.skybox&&(t.lights.skyboxPath?this.setBackgroundSkybox(t.lights.skyboxPath,"",void 0,void 0,!0):this.setBackgroundSkybox(re(`texture/cubemap/sdr/${t.lights.skybox}/`),"jpg"));break;case"color":if(Ep.lightStore.disableLightProbe(),Ep.scene&&Ep.background.color&&Ep.background.color.isColor){if(!Ep.scene)return;switch(Ep.scene.background=Ep.background.color.clone(),Ep.scene.background.needsUpdate=!0,Ep.scene.background&&Ep.scene.background.getHexString?Ep.effectStore.visualEffect._fogColorFromSkybox=`#${Ep.scene.background.getHexString()}`:Ep.effectStore.visualEffect._fogColorFromSkybox="#cccccc",Ep.effectStore.visualEffect._setFog(),Ep.renderer.outputEncoding){case te:Ep.scene.background.convertSRGBToLinear&&Ep.scene.background.convertSRGBToLinear();break;case ie:Ep.scene.background.convertGammaToLinear&&Ep.scene.background.convertGammaToLinear()}!Ep.scene.environment&&t.lights&&t.lights.skybox&&(t.lights.skyboxPath?this.setBackgroundSkybox(t.lights.skyboxPath,"",void 0,void 0,!0):this.setBackgroundSkybox(re(`texture/cubemap/sdr/${t.lights.skybox}/`),"jpg"))}break;case"image":if(Ep.lightStore.disableLightProbe(),Ep.scene&&Ep.background.texture&&Ep.background.texture instanceof we){if(!Ep.scene)return;Ep.scene.background=Ep.background.texture,Ep.effectStore.visualEffect._fogColorFromSkybox="#cccccc",Ep.effectStore.visualEffect._setFog(),!Ep.scene.environment&&t.lights&&t.lights.skybox&&(t.lights.skyboxPath?this.setBackgroundSkybox(t.lights.skyboxPath,"",void 0,void 0,!0):this.setBackgroundSkybox(re(`texture/cubemap/sdr/${t.lights.skybox}/`),"jpg"))}break;case"skybox":Ep.scene&&Ep.background.cubeTexture&&Ep.background.cubeTexture instanceof we&&this.setGlobalIllumination({skybox:t&&t.lights?t.lights.skybox:this.getSettings().lights.skybox,skyboxPath:t&&t.lights?t.lights.skyboxPath:this.getSettings().lights.skyboxPath,ambientLight:t&&t.lights?t.lights.ambientLight:this.getSettings().lights.ambientLight,directionalLight:t&&t.lights?t.lights.directionalLights.GlobalDirectionalLight:this.getSettings().lights.directionalLights.GlobalDirectionalLight},(()=>{Ep.scene&&("skybox"===Ep.background.mode&&(Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(Ep.background.cubeTexture,Ep.background.cubeTextureRotationY,Ep.background.cubeTextureIntensity,Ep.background.isCustomSkybox),this.setSkyboxBlur(Ep.background.cubeTextureBlur||0)),this.crossfade())}))}_y.markObjectsNeedsUpdate()}},this.setBackgroundColor=(e=0)=>{if(e){if("string"==typeof e&&(e={type:"single",dataUrl:"",color1:e,color2:"",gradientValue:""}),"color"===Ep.background.mode)if("single"===e.type){switch(Ep.scene.background instanceof Qt&&Ep.scene.background.setStyle?Ep.scene.background.setStyle(e.color1):Ep.scene.background=new Qt(e.color1),Ep.scene.background&&Ep.scene.background.getHexString?Ep.effectStore.visualEffect._fogColorFromSkybox=`#${Ep.scene.background.getHexString()}`:Ep.effectStore.visualEffect._fogColorFromSkybox="#cccccc",Ep.effectStore.visualEffect._setFog(),Ep.background.color=Ep.scene.background.clone(),Ep.renderer.outputEncoding){case te:Ep.scene.background.convertSRGBToLinear&&Ep.scene.background.convertSRGBToLinear();break;case ie:Ep.scene.background.convertGammaToLinear&&Ep.scene.background.convertGammaToLinear()}F=null,_y.markObjectsNeedsUpdate()}else"gradient"===e.type&&(new al).load(_y.base64ToBlob(e.dataUrl),(e=>{Ep&&Ep.renderer&&(e.encoding=Ep.renderer.outputEncoding,Ep.scene.background=e,F=null,Ep.scene.background.isColor=!0,Ep.background.color=Ep.scene.background,_y.markObjectsNeedsUpdate())}));Ep.background.colorCSSValue=e}},this.setBackgroundImage=e=>{if(e){if("string"==typeof e&&(e={textureName:e,customName:"",customDataUrl:"",imgType:"default"}),"image"===Ep.background.mode){let t=null;"default"===e.imgType?t=_y.url(this.resourceBasePath,"texture/background/"+e.textureName+".png"):"custom"===e.imgType&&(t=e.customDataUrl,-1!=t.indexOf("[[origin]]")&&(t=t.replace("[[origin]]",Ep.origin))),this._imageBackgroundUrl!=t&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._imageBackgroundUrl=t,Ep.instance.customTextureStore.loadTexture({url:t,name:e.customName,isBackground:!0,onLoad:e=>{if(e&&("image"===Ep.background.mode||N)){let t=new vs(e.textureSource);t.center=new ye(.5,.5),t.repeat=new ye(-1,1),t.rotation=Math.PI,!N&&Ep.scene&&(t.encoding=Ep.renderer.outputEncoding,Ep.scene.background=t),F=null,Ep.background.texture=t,_y.markObjectsNeedsUpdate()}}}),Ep.effectStore.visualEffect._fogColorFromSkybox="#cccccc",Ep.effectStore.visualEffect._setFog()}Ep.background.textureURL=e}},this.setBackgroundSkybox=(e,t,i,n,a=!1)=>{if(Ep.scene){F=e;var r=this;if(Ep)if(Ep.cubeTextures)if(Ep.background.isCustomSkybox=a,Ep.cubeTextures[e]){if(!N){if(!Ep.scene)return;"skybox"===Ep.background.mode&&(Ep.scene.background=Ep.backgroundRotationY.cubeTextureRotateY(Ep.cubeTextures[e].envTexture,Ep.background.cubeTextureRotationY,Ep.background.cubeTextureIntensity,a))}Ep.background.cubeTexture=Ep.cubeTextures[e].envTexture,Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(Ep.cubeTextures[e].envTexture,Ep.background.cubeTextureRotationY,Ep.background.environmentLuminosity,a),Ep.lightStore.enableLightProbe(),_y.markObjectsNeedsUpdate(),_y.isCSSColor(i)?(Ep.effectStore.visualEffect._fogColor=i,Ep.effectStore.visualEffect._fogColorFromSkybox=i):Ep.effectStore.visualEffect._fogColorFromSkybox=_y.lookupSkyboxFogColor(e,Ep.scene.toneMapping),Ep.effectStore.visualEffect._setFog(),this.setSkyboxRotationY(180*(Ep.background.cubeTextureRotationY||0)/Math.PI),this.setSkyboxBlur(Ep.background.cubeTextureBlur),r.crossfade(),n&&n()}else{new Promise((i=>{if(a){let n=_y.genEquirectangularUrl(e,t);Ep.instance.customTextureStore.loadTexture({url:n,name:n,isSkybox:!0,onLoad:e=>{if(!e||!Ep.scene)return void logger.debug("资源加载失败或者 _context.scene 为空");let t=new we(e.textureSource);t.needsUpdate=!0,i(t)}})}else Ep.cacheStore.load({path:_y.genEquirectangularUrl(e,t),type:"texture",onLoad:t=>{Ep.scene?(t.name=e,t.wrapS=d,i(t)):logger.debug("_context.scene 为空")}})})).then((t=>{if("skybox"===Ep.background.mode||N){if(!N){if(!Ep.scene)return;"skybox"===Ep.background.mode&&(Ep.scene.background=Ep.backgroundRotationY.cubeTextureRotateY(t,Ep.background.cubeTextureRotationY,Ep.background.cubeTextureIntensity,a))}Ep.lightStore.enableLightProbe(),_y.markObjectsNeedsUpdate(),_y.isCSSColor(i)?(Ep.effectStore.visualEffect._fogColor=i,Ep.effectStore.visualEffect._fogColorFromSkybox=i):Ep.effectStore.visualEffect._fogColorFromSkybox=_y.lookupSkyboxFogColor(e,Ep.scene.toneMapping),Ep.effectStore.visualEffect._setFog(),r.crossfade()}Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(t,Ep.background.cubeTextureRotationY,Ep.background.environmentLuminosity,a),Ep.background.cubeTexture=t,Ep.cubeTextures[e]={envTexture:null},Ep.cubeTextures[e].envTexture=t,this.setSkyboxRotationY(180*(Ep.background.cubeTextureRotationY||0)/Math.PI),this.setSkyboxBlur(Ep.background.cubeTextureBlur),n&&n()}))}else logger.debug("_context.cubeTextures 为空");else logger.debug("_context 为空")}else logger.debug("_context.scene 为空")},this.setSkybox=(e,t,i)=>{this.setBackgroundSkybox(e,t,i)},this.setSkyboxRotationY=e=>{"number"==typeof e&&Ep.background.cubeTexture&&(Ep.background.cubeTextureRotationY=_y.degreeToRadian(e),Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(Ep.background.cubeTexture,Ep.background.cubeTextureRotationY,Ep.background.environmentLuminosity,Ep.background.isCustomSkybox),this.setSkyboxBlur(Ep.background.cubeTextureBlur||0))},this.getSkyBoxRotationY=()=>180*(Ep.background.cubeTextureRotationY||0)/Math.PI,this.setSkyboxIntensity=e=>{"number"==typeof e&&Ep.background.cubeTexture&&(Ep.background.cubeTextureIntensity=e,this.setSkyboxBlur(Ep.background.cubeTextureBlur||0))},this.getSkyBoxIntensity=()=>"number"==typeof Ep.background.cubeTextureIntensity?Ep.background.cubeTextureIntensity:1,this.setEnvironmentLuminosity=e=>{"number"==typeof e&&Ep.background.cubeTexture&&(Ep.background.environmentLuminosity=e,Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(Ep.background.cubeTexture,Ep.background.cubeTextureRotationY,Ep.background.environmentLuminosity,Ep.background.isCustomSkybox))},this.getEnvironmentLuminosity=()=>"number"==typeof Ep.background.environmentLuminosity?Ep.background.environmentLuminosity:1,this.setSkyboxBlur=e=>{"number"!=typeof e||e<0||e>100||!Ep.background.cubeTexture||!Ep.scene||Ep.backgroundBlur.textureBlur(Ep.background.cubeTexture,e,(t=>{Ep.scene&&(t.wrapS=d,t.flipY=!Ep.background.isCustomSkybox,t.needsUpdate=!0,Ep.scene&&("skybox"===Ep.background.mode&&(Ep.scene.background=Ep.backgroundRotationY.cubeTextureRotateY(t,Ep.background.cubeTextureRotationY,Ep.background.cubeTextureIntensity,Ep.background.isCustomSkybox)),Ep.background.cubeTextureBlur=e))}))},this.getSkyboxBlur=()=>Ep.background.cubeTextureBlur||0,this.getSkyboxName=()=>I,this.setEnvTime=e=>{const t=new Date("0001/01/01 04:00:00"),i=new Date("0001/01/01 06:00:00"),n=new Date("0001/01/01 18:00:00"),a=new Date("0001/01/01 20:00:00"),r=new Date(`0001/01/01 ${e.envTime}`);r>=t&&r<i?this.setSkybox(re("texture/cubemap/sdr/skybox-dusk-6/"),".jpg"):r>=i&&r<n?this.setSkybox(re("texture/cubemap/sdr/skybox-day-10/"),".jpg"):r>=n&&r<a?this.setSkybox(re("texture/cubemap/sdr/skybox-dusk-6/"),".jpg"):(r<t||r>=a)&&this.setSkybox(re("texture/cubemap/sdr/skybox-night-24/"),".jpg");let s=(r-i)/432e5*180;s<0&&(s=Math.abs(s)),s>180&&(s=360-s);const o=Ep.lightStore._directionalLights.GlobalDirectionalLight;let l=Ep.animationStore.findAnimation(o.uuid);l||(l=new fb(o),Ep.animationStore.add(l)),l.set({angle:s,duration:e.duration,alwaysForward:e.alwaysForward})},this.setGlobalIllumination=({skybox:e="",skyboxPath:t="",skyboxType:i=".jpg",ambientLight:n={color:"#ffffff",intensity:.75},directionalLight:a={name:"GlobalDirectionalLight",color:"#ffffff",position:[100,100,100],castShadow:!0,shadow:{camera:{top:100,bottom:-100,left:-100,right:100,far:200},mapSize:{height:1024,width:1024,x:1024,y:1024}},intensity:1,duration:0}}={},r)=>{if(logger.debug("TRACE: Core.setGlobalIllumination() - Entering."),F&&F!=re(`texture/cubemap/sdr/${e}/`)&&F!=t&&this.crossfadeFreeze(),this.setAmbientLight(n.color,n.intensity),Ep.lightStore.setDirectionalLight(a,a.duration),Ep.stateStore.setGlobalIlluminationInCurrentState({skybox:e,skyboxType:i,ambientLight:n,directionalLight:a}),""===e)this.setBackgroundColor(0),r&&r(1);else if("skybox"===Ep.background.mode)F!=re(`texture/cubemap/sdr/${e}/`)&&F!=t?(I=e.replace("/","").replace("/",""),t?(P=t,this.setBackgroundSkybox(t,"",void 0,r,!0)):(P="",this.setBackgroundSkybox(re(`texture/cubemap/sdr/${e}/`),i,void 0,r))):(Ep.background.cubeTexture&&this.setSkyboxRotationY(180*(Ep.background.cubeTextureRotationY||0)/Math.PI),r&&r(1));else{if(I=e.replace("/","").replace("/",""),t)if(P=t,Ep.cubeTextures[t]){r&&r(1);let e=Ep.cubeTextures[t].envTexture;Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(e)}else{let e=_y.genEquirectangularUrl(t);Ep.instance.customTextureStore.loadTexture({url:e,name:e,isSkybox:!0,onLoad:e=>{if(!e||!Ep.scene)return void logger.debug("资源加载失败或者 _context.scene 为空");let i=new we(e.textureSource);i.needsUpdate=!0,Ep.background.cubeTexture=i,Ep.cubeTextures[t]={envTexture:null},Ep.cubeTextures[t].envTexture=i,r&&r(1)}})}else if(Ep.cubeTextures[re(`texture/cubemap/sdr/${e}/`)]){P="";let t=Ep.cubeTextures[re(`texture/cubemap/sdr/${e}/`)].envTexture;if(r&&r(1),!Ep.scene)return void logger.debug("_context.scene 为空");Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(t)}else P="",Ep.cacheStore.load({path:_y.genEquirectangularUrl(re(`texture/cubemap/sdr/${e}/`),i),type:"texture",onLoad:t=>{t.wrapS=d,Ep.background.cubeTexture=t,Ep.cubeTextures[re(`texture/cubemap/sdr/${e}/`)]={envTexture:null},Ep.cubeTextures[re(`texture/cubemap/sdr/${e}/`)].envTexture=t,Ep.scene?(Ep.scene.environment=Ep.backgroundRotationY.cubeTextureRotateY(t),r&&r(1)):logger.debug("_context.scene 为空")}});this.crossfade()}logger.debug("TRACE: Core.setGlobalIllumination() - Leaving.")},this.getCamera=()=>{var e={};return e.positionX=Ep.camera.position.x,e.positionY=Ep.camera.position.y,e.positionZ=Ep.camera.position.z,e.inclinationAngle=Ep.orbitControls.getPolarAngle()/(Math.PI/2)*90-90,e.azimuthAngle=Ep.orbitControls.getAzimuthalAngle()/Math.PI*180,e.viewDistance=Math.abs(Ep.orbitControls.object.position.clone().sub(Ep.orbitControls.target).length())/Ep.worldScale,e.targetX=Ep.orbitControls.target.x,e.targetY=Ep.orbitControls.target.y,e.targetZ=Ep.orbitControls.target.z,e.fov=Ep.camera.fov,e.far=Ep.camera.far,e.near=Ep.camera.near,e.inclinationAngleMin=Ep.orbitControls.minPolarAngle/Math.PI*180-90,e.inclinationAngleMax=Ep.orbitControls.maxPolarAngle/Math.PI*180-90,e.distanceMin=Ep.orbitControls.minDistance/Ep.worldScale,e.distanceMax=Ep.orbitControls.maxDistance/Ep.worldScale,e.viewLimitRadius=Ep.orbitControls.viewLimitRadius,e.autoRotate=Ep.stateStore._camera.autoRotate,e.autoRotateSpeed=Ep.stateStore._camera.autoRotateSpeed,e.autoRotateDirection=Ep.stateStore._camera.autoRotateDirection,e.duration=Ep.stateStore._camera.duration,e},this.setCamera=(e,t)=>{if(t)if(""===this.getCurrentState()){let t=this.getCamera();e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ},e.azimuthAngle=e.azimuthAngle||0===e.azimuthAngle?e.azimuthAngle:t.azimuthAngle,e.inclinationAngle="number"==typeof e.inclinationAngle?e.inclinationAngle:t.inclinationAngle,e.distance="number"==typeof e.distance&&e.distance>0?e.distance:t.viewDistance,this.cameraFlyTo(new Ce(e.target.x,e.target.y,e.target.z),e.azimuthAngle,e.inclinationAngle,e.distance*Ep.worldScale,0,!0,(()=>{})),Ep.camera.fov=e.fov||Ep.camera.fov,("number"!=typeof e.near||e.near<0)&&(e.near=Ep.camera.near),("number"!=typeof e.far||e.far<0)&&(e.far=Ep.camera.far),e.near<e.far&&(Ep.camera.near=e.near,Ep.camera.far=e.far,Ep.camera.updateProjectionMatrix()),"number"==typeof e.inclinationAngleMin&&(Ep.orbitControls.minPolarAngle=(e.inclinationAngleMin+90)/180*Math.PI),"number"==typeof e.inclinationAngleMax&&(Ep.orbitControls.maxPolarAngle=(e.inclinationAngleMax+90)/180*Math.PI),"number"==typeof e.distanceMin&&(Ep.orbitControls.minDistance=e.distanceMin*Ep.worldScale),"number"==typeof e.distanceMax&&(Ep.orbitControls.maxDistance=e.distanceMax*Ep.worldScale),this.notDistance={minDistance:e.distanceMin*Ep.worldScale,maxDistance:e.distanceMax*Ep.worldScale},Y=this.getCamera(),this.defaultEffectStore.visualEffect._updateCameraProjection(Ep.camera),this.focus()}else this.notState.view.camera.viewDistanceMax=e.far,this.notState.view.camera.viewDistanceMin=e.near,this.notState.view.camera.distanceMax=e.distanceMax*Ep.worldScale,this.notState.view.camera.distanceMin=e.distanceMin*Ep.worldScale,this.notState.view.camera.fov=e.fov;else{let t=this.getCamera();e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ},e.azimuthAngle=e.azimuthAngle||0===e.azimuthAngle?e.azimuthAngle:t.azimuthAngle,e.inclinationAngle="number"==typeof e.inclinationAngle?e.inclinationAngle:t.inclinationAngle,e.distance="number"==typeof e.distance&&e.distance>0?e.distance:t.viewDistance,this.cameraFlyTo(new Ce(e.target.x,e.target.y,e.target.z),e.azimuthAngle,e.inclinationAngle,e.distance*Ep.worldScale,e.duration||0,!0,(()=>{})),Ep.camera.fov=e.fov||Ep.camera.fov,("number"!=typeof e.near||e.near<0)&&(e.near=Ep.camera.near),("number"!=typeof e.far||e.far<0)&&(e.far=Ep.camera.far),e.near<e.far&&(Ep.camera.near=e.near,Ep.camera.far=e.far,Ep.camera.updateProjectionMatrix()),"number"==typeof e.inclinationAngleMin&&(Ep.orbitControls.minPolarAngle=(e.inclinationAngleMin+90)/180*Math.PI),"number"==typeof e.inclinationAngleMax&&(Ep.orbitControls.maxPolarAngle=(e.inclinationAngleMax+90)/180*Math.PI),"number"==typeof e.distanceMin&&(Ep.orbitControls.minDistance=e.distanceMin*Ep.worldScale),"number"==typeof e.distanceMax&&(Ep.orbitControls.maxDistance=e.distanceMax*Ep.worldScale),this.defaultEffectStore.visualEffect._updateCameraProjection(Ep.camera),this.focus()}},this.setCameraToModel=(e,t=0,i={},n=!1,a,r)=>{let s=r;if(!r){if(s=this.defaultObjectTree.getItemByName(e),!s)return;s=s.getGroup()}let o=(new Re).setFromObject(s),l=new Ce;o.getSize(l),k.x=(o.max.x+o.min.x)/2,k.y=(o.max.y+o.min.y)/2,k.z=(o.max.z+o.min.z)/2;let c=3*l.distanceTo(o.max.sub(o.min).divideScalar(2));(isNaN(k.x)||isNaN(k.y)||isNaN(k.z))&&(logger.warn("无法获取有效的模型大小。"),k.copy(s.position)),(isNaN(c)||c===1/0||c===-1/0)&&(c=100),c<=this.getCamera().near&&(c+=this.getCamera().near),o=null,l=null;const h=this.getCamera();void 0!==i.distance&&(i.distance*=Ep.worldScale),this.cameraFlyTo(k,_y.numberOrDefault(i.azimuthAngle,h.azimuthAngle),_y.numberOrDefault(i.inclinationAngle,h.inclinationAngle),_y.numberOrDefault(i.distance,c),_y.numberOrDefault(t,0),!0,(()=>{this.focus(),a&&a()})),k=new Ce},this.focusFloor=(e,t,i)=>{if(!e)return void(t&&t({result:0,message:"参数错误"}));let n,a=Ep.instance.defaultObjectTree.getItemByName(e.buildingId);if(!a)return void(t&&t({result:0,message:`建筑${e.buildingId}不存在`}));if("BuildingItem"!==(Ep.instance.defaultObjectTree.findItemByObject3D(a.getGroup())||{}).getType())return void(t&&t({result:0,message:"指定的对象非建筑"}));if(a.children.forEach((t=>{t.level===Number(e.floor)&&(n=t)})),!n)return void(t&&t({result:0,message:`楼层号${e.floor}不存在`}));let r={floor:e.floor,idBuilding:e.buildingId};i.onFocusFloorStart&&i.onFocusFloorStart(r),this.setCameraToModel(n.name,e.duration,{distance:e.distance}),i.onFocusFloorEnd&&i.onFocusFloorEnd(r),t&&t({result:1,message:"成功。"})},this.setCameraToNode=(e,t,i=0,n={},a=!1)=>{let r=null;Ep.scene.models.traverse((t=>{t.name===e&&(r=t)}));let s=_y.findNodeInThree(r,t);if(!s)return;let o=(new Re).setFromObject(s),l=new Ce;o.getSize(l),k.x=(o.max.x+o.min.x)/2,k.y=(o.max.y+o.min.y)/2,k.z=(o.max.z+o.min.z)/2;let c=3*l.distanceTo(o.max.sub(o.min).divideScalar(2));(isNaN(k.x)||isNaN(k.y)||isNaN(k.z))&&(logger.warn("无法获取有效的模型大小。"),k.copy(r.position)),(isNaN(c)||c===1/0||c===-1/0)&&(c=100),c<=this.getCamera().near&&(c+=this.getCamera().near),o=null,l=null,this.cameraFlyTo(k,_y.numberOrDefault(n.azimuthAngle,45),_y.numberOrDefault(n.inclinationAngle,-45),_y.numberOrDefault(n.distance,c)*Ep.worldScale,_y.numberOrDefault(i,0),!0,(()=>{this.focus()})),k=new Ce},this.setCameraToModelByUUID=(e,t=0,i={},n=!1,a=!1)=>{let r=null;Ep.scene.traverse((t=>{t.uuid===e&&(r=t)}));let s=null;if(r){let e=[];r.traverse((t=>{if(t instanceof ms){let i={parent:t.parent,object:t};e.push(i)}})),e.forEach((e=>{e.parent.remove(e.object)})),s=(new Re).setFromObject(r),e.forEach((e=>{e.parent.add(e.object)}))}else this._tilesRenderers&&this._tilesRenderers.forEach((t=>{if(t.group.uuid===e&&t.tileSets[t.rootURL]&&t.tileSets[t.rootURL].root&&t.tileSets[t.rootURL].root.boundingVolume&&t.tileSets[t.rootURL].root.boundingVolume.box){let e=t.tileSets[t.rootURL].root.boundingVolume.box,i=new Ce(e[0],e[2],-e[1]),n=new Ce(t.offset.x,t.offset.y,t.offset.z),a=new Ce(e[3],e[11],e[7]),r=new Ce(t.absolutePosition.x,t.absolutePosition.y,t.absolutePosition.z),o=r.clone().add(a).add(i).add(n),l=r.clone().sub(a).add(i).add(n);s=new Re(l,o)}}));s||(s=(new Re).setFromObject(Ep.scene.models));let o=new Ce;s.getSize(o),k.x=(s.max.x+s.min.x)/2,k.y=(s.max.y+s.min.y)/2,k.z=(s.max.z+s.min.z)/2;let l=3*o.distanceTo(s.max.sub(s.min).divideScalar(2));(isNaN(k.x)||isNaN(k.y)||isNaN(k.z))&&(logger.warn("无法获取有效的模型大小。"),k.copy(r.position)),(isNaN(l)||l===1/0||l===-1/0)&&(l=100),l<=this.getCamera().near&&(l+=this.getCamera().near),s=null,o=null,this.nextRender((()=>{this.cameraFlyTo(k,_y.numberOrDefault(i.azimuthAngle,45),_y.numberOrDefault(i.inclinationAngle,-45),_y.numberOrDefault(i.distance,l)*Ep.worldScale,_y.numberOrDefault(t,0),!0,(()=>{this.focus()})),k=new Ce}),1)},this.getOrthoCamera=()=>{var e={};return e.positionX=Ep.cameraOrtho.position.x,e.positionY=Ep.cameraOrtho.position.y,e.positionZ=Ep.cameraOrtho.position.z,e.viewDistance=Math.abs(Ep.orthoCameraControls.object.position.clone().sub(Ep.orthoCameraControls.target).length()),e.targetX=Ep.orthoCameraControls.target.x,e.targetY=Ep.orthoCameraControls.target.y,e.targetZ=Ep.orthoCameraControls.target.z,e.far=Ep.cameraOrtho.far,e.near=Ep.cameraOrtho.near,e},this.setOrthoCamera=e=>{let t=Ep.cameraOrtho;if(!e.target)return;if("number"!=typeof e.target.x||"number"!=typeof e.target.y||"number"!=typeof e.target.z)return;if(isNaN(e.target.x)||isNaN(e.target.y)||isNaN(e.target.z))return;e.target=e.target||{x:t.targetX,y:t.targetY,z:t.targetZ};let i="";if("number"!=typeof e.height||isNaN(e.height)||(i="z"),"number"!=typeof e.width||isNaN(e.width)||(i="y"),""!==i){if(!("number"==typeof e.distance&&e.distance>0))if(Ep.scene.models.children instanceof Array&&Ep.scene.models.children.length>0){let t=-1/0;Ep.scene.models.traverse((e=>{if(e.geometry){e.geometry.computeBoundingBox();const n=new Ce(0,"y"===i?e.geometry.boundingBox.max[i]:0,"z"===i?e.geometry.boundingBox.max[i]:0);e.updateMatrixWorld(),n.applyMatrix4(e.matrixWorld),n[i]>t&&(t=n[i])}})),e.distance=t+10-e.target[i]}else e.distance=t.position[i]-e.target[i];if("y"===i){let t=e.width,i=t/(Ep.renderer.domElement.width/Ep.renderer.domElement.height);Ep.cameraOrtho.left=t/-2,Ep.cameraOrtho.right=t/2,Ep.cameraOrtho.top=i/2,Ep.cameraOrtho.bottom=i/-2,Ep.cameraOrtho.position.set(e.target.x,e.target.y+e.distance,e.target.z),Ep.cameraOrtho.rotation.z=0}if("z"===i){let t=e.height,i=t/(Ep.renderer.domElement.height/Ep.renderer.domElement.width);Ep.cameraOrtho.left=i/-2,Ep.cameraOrtho.right=i/2,Ep.cameraOrtho.top=t/2,Ep.cameraOrtho.bottom=t/-2,Ep.cameraOrtho.position.set(e.target.x,e.target.y,e.target.z+e.distance),Ep.cameraOrtho.rotation.z=0}Ep.cameraOrtho.zoom=1,Ep.cameraOrtho.updateProjectionMatrix(),Ep.cameraOrtho.updateMatrixWorld(),Ep.orthoCameraControls.target.set(e.target.x,e.target.y,e.target.z),Ep.orthoCameraControls.update()}else console.warn("Invalid parameter in setOrthoCamera().")},this.onGlobeCalibrate=(e,t)=>{Ep.globeCalibrateControls||(Ep.globeCalibrateControls=new nw),this.globeCalibrateControls=Ep.globeCalibrateControls,Ep.globeCalibrateControls.enable(e,t)},this.offGlobeCalibrate=()=>{Ep.globeCalibrateControls&&Ep.globeCalibrateControls.disable()},this.resetGlobeCalibrate=()=>{Ep.globeCalibrateControls&&Ep.globeCalibrateControls.reset()},this.onGlobeMode=(e="z",t)=>{"string"==typeof e&&("y"!==(e=e.toLowerCase())&&"z"!==e||(document.getElementById("__refGlobeDiv")||(Ep.refGlobeDiv=document.createElement("div"),Ep.refGlobeDiv.id="__refGlobeDiv",Ep.refGlobeDiv.style.width="100%",Ep.refGlobeDiv.style.height="100%",Ep.refGlobeDiv.style.backgroundImage=`url(${_y.url(this.resourceBasePath,"texture/ui/globe-front.jpg")})`,Ep.refGlobeDiv.style.backgroundPosition="center center",Ep.refGlobeDiv.style.backgroundRepeat="no-repeat",Ep.refGlobeDiv.style.opacity=.5,Ep.refGlobeDiv.style.position="inherit",Ep.refGlobeDiv.style.pointerEvents="none",Ep.refGlobeDiv.style.display="none",Ep.renderer.domElement.parentElement.insertBefore(Ep.refGlobeDiv,Ep.renderer.domElement)),"y"===e&&(Ep.refGlobeDiv.style.backgroundImage=`url(${_y.url(this.resourceBasePath,"texture/ui/globe-top.jpg")})`),"z"===e&&(Ep.refGlobeDiv.style.backgroundImage=`url(${_y.url(this.resourceBasePath,"texture/ui/globe-front.jpg")})`),Ep.refGlobeDiv.style.display="block",this.saveSceneCamera(),this.switchCameraMode(1,e,{fitX:!0}),U=Ep.background.mode,this.setBackgroundMode("none"),Ep.orthoCameraControls.keyOperate="translation",Ep.orthoCameraControls.zoomAxis=e,Ep.onCalibrate=()=>{const e=Ep.refGlobeDiv.offsetWidth/360*6378139,i=(Ep.cameraOrtho.right-Ep.cameraOrtho.left)/Ep.cameraOrtho.zoom/e,n={type:"ecef",scaleX:i,scaleY:i,scaleZ:i,offset:{x:Ep.orthoCameraControls.target.x,y:Ep.orthoCameraControls.target.y,z:Ep.orthoCameraControls.target.z},rotation:{x:0,y:0,z:0},editor:this.getDatumShiftModel()?this.getDatumShiftModel().editor:{}};this.setDatumShiftModel(n),"function"==typeof t&&t(n)},Ep.orthoCameraControls.addEventListener("change",Ep.onCalibrate),"y"===e&&(Ep.transformControls.attach(Ep.scene.models),this.setTransformMode("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1),H.rotation=JSON.parse(JSON.stringify(Ep.scene.models.rotation)),j&&Ep.scene.models.rotation.set(0,ge.degToRad(j),0),N=!0))},this.offGlobeMode=()=>{N&&(Ep.refGlobeDiv&&(Ep.refGlobeDiv.style.display="none"),N=!1,this.switchCameraMode(0),U&&this.setBackgroundMode(U),U=null,"editor"===Ep.pointerMode?Ep.orthoCameraControls.keyOperate="paint":Ep.orthoCameraControls.keyOperate=null,Ep.orthoCameraControls.zoomAxis="y",Ep.orthoCameraControls.removeEventListener("change",Ep.onCalibrate),Ep.onCalibrate=null,this.disableTransform(),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!1,j=this.getSceneRotationY(),this.notState&&(this.notState.datumShiftModel=JSON.parse(JSON.stringify(this.getSettings().datumShiftModel))),Ep.scene.models.rotation.order=H.rotation._order,Ep.scene.models.rotation.x=H.rotation._x,Ep.scene.models.rotation.y=H.rotation._y,Ep.scene.models.rotation.z=H.rotation._z)},this.onFirstPersonMode=({movementSpeed:e=50,lookSpeed:t=.1,isWalk:i=!1,onStart:n}={})=>{Ep.firstPersonControls&&(Ep.orbitControls.enabled=!1,Ep.targetCameraControls.enabled=!1,Ep.firstPersonControls.reset(),Ep.firstPersonControls.updateOrientation(),Ep.firstPersonControls.movementSpeed=e,Ep.firstPersonControls.lookSpeed=t,Ep.firstPersonControls.onStart=n,Ep.firstPersonControls.enabled=!0,Ep.firstPersonControls.moveHorizontal=i)},this.offFirstPersonMode=()=>{if(!Ep.firstPersonControls)return;if(0==Ep.firstPersonControls.enabled)return;Ep.firstPersonControls.mouseDragOn=!0,Ep.firstPersonControls.update(0),Ep.firstPersonControls.mouseDragOn=!1,Ep.firstPersonControls.enabled=!1;const e=Ep.orbitControls.object.position.distanceTo(Ep.orbitControls.target),t=Ep.firstPersonControls.targetPosition.clone().sub(Ep.orbitControls.object.position),i=Ep.firstPersonControls.targetPosition.clone().add(t.setLength(e));Ep.orbitControls.target.copy(i),Ep.targetCameraControls.enabled=!0,Ep.orbitControls.enabled=!0,Ep.orbitControls.update(0)},this.findParentPosition=e=>{let t=e.parent;t&&(k.x=t.position.x+k.x,k.y=t.position.y+k.y,k.z=t.position.z+k.z,this.findParentPosition(t,k))},this.findNode=(e,t)=>{let i=this.findModel(e);if(i)return i.findNode(t)},this.destroy=()=>{if(logger.debug("TRACE: Core.destroy() - Entering."),s)return;for(cancelAnimationFrame(this.frameId),this.disableTransform(),s=!0,wx.dispose(),Ep.scene.children.forEach((e=>{_y.disposeThreeObject(e)}));Ep.scene.children.length;)Ep.scene.remove(Ep.scene.children[0]);Ep.renderer.domElement&&this.container.removeChild(Ep.renderer.domElement),i&&i.domElement&&this.container.removeChild(i.domElement),z&&this.fpsPanelOff(),this.destroyTerrain(),Ep.paintControls.destroy(),Ep.transformStore.destroy(),Ep.transformStore=null,Ep.cacheStore.destroy(),Ep.cacheStore=null,Ep.sceneStore.destroy(),Ep.sceneStore=null,Ep.scene.clear(),Ep.scene=null,Ep.camera=null,Ep.targetCameraControls=null,Ep.orbitControls=null,Ep.animationStore=null,Ep.effectStore=null,Ep.lightStore=null,this.defaultLightStore=null,Ep.materialStore=null,Ep.modelStore=null,e=null,Ep.textureStore=null,Ep.customTextureStore=null,Ep.datumShiftModel=null,Ep.globeCalibrateControls=void 0,o=!1,l=!1,v={},Ep.loaders={},this.notState=null,this.allState=null,Ep.publishQuality=void 0,Ep.renderer.dispose(),Ep.renderer.forceContextLoss(),Ep.renderer.content=null;let t=Ep.renderer.domElement.getContext("webgl");t&&t.getExtension("WEBGL_lose_context").loseContext(),Ep.renderer=null,Ep.markDom=null,Zo.clear(),Xo.clear(),Ep.paperCutPlaneGeometryMap&&Ep.paperCutPlaneGeometryMap.clear(),Ep.globalTextureMap&&Ep.globalTextureMap.clear(),logger.debug("TRACE: Core.destroy() - Leaving.")},this.enableLut=()=>this.defaultEffectStore.enableLut(),this.disableLut=()=>this.defaultEffectStore.disableLut(),this.nextLut=()=>this.defaultEffectStore.nextLut(),this.findMaterial=e=>Ep.materialStore.find(e),this.findMaterialInModel=(e,t)=>{let i=this.defaultObjectTree.children;for(let n=0;n<i.length;n++)if("ModelItem"===i[n].type){if(i[n].name===e)return i[n].getMaterials()[t]}else if("BuildingItem"===i[n].type)for(let a=0;a<i[n].children.length>0;a++)if("ModelItem"===i[n].children[a].type){if(i[n].children[a].name===e)return i[n].children[a].getMaterials()[t]}else if("BuildingFloorItem"===i[n].children[a].type)for(let r=0;r<i[n].children[a].children.length;r++){if(i[n].children[a].children[r].name===e)return i[n].children[a].children[r].getMaterials()[t];if("BuildingRoomItem"===i[n].children[a].type)for(let s=0;s<i[n].children[a].children[r].children.length;s++)if(i[n].children[a].children[r].children[s].name===e)return i[n].children[a].children[r].children[s].getMaterials()[t]}},this.findModel=(e,t)=>{let i,n=this;return Ep.scene.models.traverse((function(a){a.name===e&&(t?n.findParent(a,t)&&(i=a):i=a)})),i},this.findParent=(e,t)=>{if(e.parent){if(e.parent.name===t)return e.parent;var i=this.findParent(e.parent,t);return i||void 0}},this.findTexture=e=>Ep.textureStore.find(e),this.getModels=()=>Ep.modelStore.getModels(),this.setNodeRotation=({enabled:e=!0,node:t,rotatingAxis:i="y",rotatingSpeed:n=.1})=>{if(e){let e=Ep.animationStore.findNodeAnimation(t,Sv.type);e&&(e.reset(),Ep.animationStore.remove(e)),e=new Sv(t,"x"===i,"y"===i,"z"===i,"x"===i?n:0,"y"===i?n:0,"z"===i?n:0),Ep.animationStore.add(e)}else{let e=Ep.animationStore.findNodeAnimation(t,Sv.type);e&&(e.reset(),Ep.animationStore.remove(e))}},this.setNodeRotating=({enabled:e=!0,node:t,rotatingAxis:i="y",rotatingSpeed:n=.1})=>{let a=Ep.animationStore.findNodeAnimation(t,Sv.type);if(a&&(a.reset(),Ep.animationStore.remove(a)),e){let e=new Sv(t,"x"===i,"y"===i,"z"===i,"x"===i?n:0,"y"===i?n:0,"z"===i?n:0);Ep.animationStore.add(e)}},this.setNodeScaling=({enabled:e=!0,node:t,startScale:i=1,stopScale:n=2,fadeOutScale:a=1.5,scalingSpeed:r=.1})=>{let s=Ep.animationStore.findNodeAnimation(t,Mv.type);if(s&&(s.reset(),Ep.animationStore.remove(s)),e){let e=new Mv(t,i,n,a,r,!0);Ep.animationStore.add(e)}},this.setNodeBreathing=({enabled:e=!1,node:t,endBreathe:i=1.5,breathingSpeed:n=.1})=>{let a=Ep.animationStore.findNodeAnimation(t,xv.type);if(a&&(a.reset(),Ep.animationStore.remove(a)),e){let e=new xv(t,i,n,!0);Ep.animationStore.add(e)}},this.getMaterials=()=>Ep.materialStore.getAll(),this.setMaterialAnimation=({name:e="",enableTranslation:t=!1,translationSpeedU:i=.1,translationSpeedV:n=.1,modelName:a},r,s)=>{logger.debug("TRACE: Core.setMaterialAnimation() - Entering.",{name:e,enableTranslation:t,translationSpeedU:i,translationSpeedV:n});let o=this.defaultObjectTree.getItemByName(a);if(r){let e=this.defaultObjectTree.getItemByName(r);if(!e)return;"PackedItem"==e.type?o=e.children.find((e=>e.name==a)):"PaintItem"==e.type&&(o=e.getItemByName(a),s&&(o=e.getInstanced("ModelAsset",s)))}if(!o)return;let l=o.materialStore.find(e);if(!l)return logger.debug(`Material with specified name (${e}) not found.`),void logger.debug("TRACE: Core.setMaterialAnimation() - Leaving.");if(l._enableTranslation=t,l._translationSpeedU=i,l._translationSpeedV=n,0===i&&0===n&&(t=!1),t){let e=Ep.animationStore.findMaterialAnimation(l._material(),nv.type);if(e)e.enableU=0!==i,e.enableV=0!==n,e.uSpeed=i,e.vSpeed=n;else{let e=new nv(l._material(),0!==i,0!==n,i,n);Ep.animationStore.add(e)}}else{let e=Ep.animationStore.findMaterialAnimation(l._material(),nv.type);e&&(e.reset(),l.enableUV&&(l.enableUV=!0),Ep.animationStore.remove(e))}if(l._copies instanceof Array)for(let e of l._copies)if(e._enableTranslation=t,e._translationSpeedU=i,e._translationSpeedV=n,0===i&&0===n&&(t=!1),t){let t=Ep.animationStore.findMaterialAnimation(e,nv.type);if(t)t.enableU=0!==i,t.enableV=0!==n,t.uSpeed=i,t.vSpeed=n;else{let t=new nv(e,0!==i,0!==n,i,n);Ep.animationStore.add(t)}}else{let t=Ep.animationStore.findMaterialAnimation(e,nv.type);t&&(t.reset(),Ep.animationStore.remove(t))}logger.debug("TRACE: Core.setMaterialAnimation() - Leaving.")},this._transformEvent=function(e){let t=e.target.object,i={};if(t){i.position=JSON.parse(JSON.stringify(t.position)),i.rotation=JSON.parse(JSON.stringify(t.rotation)),i.rotation.x=i.rotation._x,i.rotation.y=i.rotation._y,i.rotation.z=i.rotation._z,i.scale=JSON.parse(JSON.stringify(t.scale)),i.rotation.x=i.rotation._x=ge.radToDeg(i.rotation._x),i.rotation.y=i.rotation._y=ge.radToDeg(i.rotation._y),i.rotation.z=i.rotation._z=ge.radToDeg(i.rotation._z);let e=Ep.defaultObjectTree.getItemByUUID(t.uuid);e&&(e.transformNode=i,t&&t.userData&&t.userData.nodeSettings&&t.userData.nodeSettings.axesTransform&&(e.axesTransform=t.userData.nodeSettings.axesTransform))}},this.init=a=>{(a=a||{}).disableAvwExtensions,_=a.highDPI?window.devicePixelRatio:1,_=a.lowDPI?.5:_,_=a.dpi?a.dpi:_,c=!!a._isManaged,Ep.pointerMode="classic","string"==typeof a.pointerMode&&"editor"===a.pointerMode.toLowerCase()&&(Ep.pointerMode="editor"),"number"==typeof a.fpsLimit&&a.fpsLimit>0&&a.fpsLimit<240?Ep.fpsLimit=a.fpsLimit:Ep.fpsLimit=240,this.passiveMode=!!a.passiveMode,this.passiveModeRenderRate="number"==typeof a.passiveModeRenderRate?a.passiveModeRenderRate:1,this.passiveModeRenderRate=Math.min(Math.max(this.passiveModeRenderRate,0),1),R=0,a.container?this.container=a.container:(this.container=document.body.appendChild(document.createElement("div")),o=!0),this.container.style.overflow="hidden",a.fillWindow||o?(o=!0,a.width=window.innerWidth,a.height=window.innerHeight,this.container.style.position="absolute",this.container.style.top="0px",this.container.style.right="0px",this.container.style.bottom="0px",this.container.style.left="0px"):(a.width=a.width||this.container.scrollWidth,a.height=a.height||this.container.scrollHeight),Ep.hasUpgradeSuggest=a.performanceSuggest,this.setResolution(a.width,a.height),n||this.setResolution(1024,768),Ep.alpha="boolean"==typeof a.isTransparent&&a.isTransparent,Ep.origin=a.origin?a.origin:window.location.origin,i=new du,i.domElement.style.position="absolute",i.domElement.style.top="0px",i.domElement.style.display="none",this.container.appendChild(i.domElement);let l=document.createElement("canvas");Ep.renderer=new hr({canvas:l,alpha:Ep.alpha,antialias:!0}),Ep.renderer.autoClear=!0,Ep.renderer.outputEncoding=te,Ep.renderer.setPixelRatio(_),Ep.renderer.setSize(n.width,n.height),this.container.appendChild(Ep.renderer.domElement),window.addEventListener("resize",(()=>{o&&this.setResolution(window.innerWidth,window.innerHeight),Ep.firstPersonControls&&Ep.firstPersonControls.handleResize()})),Ep.renderer.shadowMap.enabled=!0,Ep.renderer.shadowMap.type=2,Ep.renderer.toneMapping=0,Ep.renderer.toneMappingExposure=1;let d=50,m=1,f=1e6;a.camera&&(d=a.camera.fieldOfView||d,m=a.camera.near||m,f=a.camera.far||f);let b=1*n.width/n.height;if(Ep.camera=new Zi(d,b,m,f),Ep.activeCamera=Ep.camera,Ep.camera.position.set(0,50,100),Ep.cameraOrtho=new jl(-200*b,200*b,200,-200,m,f),Ep.cameraOrtho.position.y=200,Ep.cameraOrtho.lookAt(0,0,0),Ep.orbitControls=new kx(Ep.camera,Ep.renderer.domElement),Ep.orbitControls.enableDamping=!0,Ep.orbitControls.dampingFactor=.2,Ep.orbitControls.target.set(0,0,0),Ep.orbitControls.addEventListener("change",(()=>{r=!0})),Ep.firstPersonControls=new tw(Ep.camera,Ep.renderer.domElement),Ep.firstPersonControls.enabled=!1,Ep.firstPersonControls.moveHorizontal=!0,"editor"===Ep.pointerMode&&(Ep.orbitControls.keyOperate="paint"),Ep.orbitControls.update(),Ep.orbitControls.addEventListener("end",(()=>{_y.markObjectsNeedsUpdate()})),Ep.orthoCameraControls=new kx(Ep.cameraOrtho,Ep.renderer.domElement),Ep.orthoCameraControls.zoomCenter="scene",Ep.orthoCameraControls.zoomSpeed=.25,Ep.orthoCameraControls.enableDamping=!1,Ep.orthoCameraControls.enableRotate=!1,Ep.orthoCameraControls.target.set(0,0,0),Ep.orthoCameraControls.enabled=!1,Ep.targetCameraControls=new rw(Ep.orbitControls),this.defaultView=new Jx({},Ep.targetCameraControls,Ep.camera),Ep.transformControls=new sw(Ep.camera,Ep.renderer.domElement),this.transformControls=Ep.transformControls,Ep.axesTransformControls=new cw(Ep.camera,Ep.renderer.domElement),this.axesTransformControls=Ep.axesTransformControls,Ep.transformStore=new gE(Ep.transformControls),Ep.transformControls.addEventListener("translate",(e=>{this.cutLevelByUUID(e.object.uuid,!1)})),Ep.transformControls.addEventListener("dragging-changed",(function(e){Ep.orbitControls.enabled=!e.value,Ep.orthoCameraControls.enabled=!e.value})),Ep.transformControls.addEventListener("mouseUp",this._transformEvent),Ep.axesTransformControls.addEventListener("mouseUp",this._transformEvent),Ep.scene=new mr,Ep.scene.name="__avwCore",Ep.scene.models=new sr,Ep.scene.models.name="__models",Ep.scene.add(Ep.scene.models),Ep.scene.sysObjects=new sr,Ep.scene.sysObjects.name="__sysObjects",Ep.scene.sysObjects.renderOrder=1/0,Ep.scene.add(Ep.scene.sysObjects),Ep.scene.noneModels=new sr,Ep.scene.noneModels.name="__noneModels",Ep.scene.axesHelper=new Sh(50),Ep.scene.axesHelper.name="__axesHelper",Ep.scene.axesHelper.visible=!1,Ep.scene.add(Ep.scene.noneModels),Ep.scene.sysObjects.add(Ep.transformControls),Ep.scene.sysObjects.add(Ep.axesTransformControls),!Ep.alpha){if(!Ep.scene)return;switch(Ep.scene.background=new Qt(0),Ep.renderer.outputEncoding){case te:Ep.scene.background.convertSRGBToLinear&&Ep.scene.background.convertSRGBToLinear();break;case ie:Ep.scene.background.convertGammaToLinear&&Ep.scene.background.convertGammaToLinear()}}Ep.scene.setNodeRotation=this.setNodeRotation,Ep.scene.setNodeRotating=this.setNodeRotating,Ep.scene.setNodeScaling=this.setNodeScaling,Ep.scene.setNodeBreathing=this.setNodeBreathing,Ep.scene.add(Ep.scene.axesHelper),Ep.loaders.gltfLoader=new fS,Ep.loaders.gltfLoaderAVWS=new gS,Ep.loaders.gltfLoaderTGPW=new DT,window._textureMap={},window._needReplace={},Ep.loaders.fbxLoader=new OT,Ep.loaders.dracoLoader=new iu,Ep.loaders.dracoLoader.setDecoderPath(_y.url(this.resourceBasePath,"lib/draco/gltf/")),Ep.loaders.gltfLoader.setDRACOLoader(Ep.loaders.dracoLoader),Ep.loaders.bufferGeometryLoader=new Kl,Ep.loaders.textureLoader=new al,Ep.loaders.cubeTextureLoader=new il,Ep.loaders.imageBitmapLoader=new ic,Ep.cubeTextures={},Ep.loaders.ddsLoader=new tu,Ep.loaders.tgaLoader=new uu,Jo.addHandler(/\.tga$/i,Ep.loaders.tgaLoader),Jo.addHandler(/\.dds$/i,Ep.loaders.ddsLoader),v.gltfExporter=new ru,v.dhExporter=new Qw(Ep.scene,this),Ep.sceneStore=new dE,Ep.cacheStore=new NT,Ep.modelStore=new sE(Ep.scene),e=new oE(Ep.scene),Ep.objectStore=e,this.objectStore=e,Ep.clippingControls=new gw,Ep.scene.sysObjects.add(Ep.clippingControls),Ep.sysObjectStore=new cE(Ep.scene),Ep.textureStore=new hE("textureStore"),Ep.customTextureStore=new hE("customTextureStore"),this.customTextureStore=Ep.customTextureStore,Ep.materialStore=new Eb(Ep.textureStore,this),Ep.lightStore=new rE(Ep.scene,this),this.defaultLightStore=Ep.lightStore,new Vh(Ep.renderer),Ep.effectStore=new jT,this.defaultEffectStore=Ep.effectStore,Ep.stateStore=new uE,this.defaultNodeSelection=new $y(Ep.scene,this),this.defaultModelSelection=new Lx,this.selectionControls=new fw,Ep.animationStore=new kT,Ep.animationMixers=[],Ep.clippingStore=new zT,t=new HT(Ep.renderer,Ep.scene,Ep.camera),Ep.eventHandlerStore=t,Ep.pluginStore=new lE,this.defaultObjectTree=new Sx(Ep.scene),Ep.defaultObjectTree=this.defaultObjectTree,Ep.statistics=new qx,L=new Pp,Ep.coordinateConvertHelper=L,D=new hv((e=>{t.trailmove(e)})),Ep.baseCarrierController=D,new ye,new Vc,Ep.drawableDepthTest="boolean"==typeof a.drawableDepthTest&&a.drawableDepthTest,Ep.paintControls=new aw,Ep.paintControls.init(),Ep.selectControl=new dw,Ep.instancedObjectStore=new JA,Ep.backgroundBlur=new Xy(Ep.renderer),Ep.backgroundRotationY=new Zy(Ep.renderer),a.camera&&(a.camera.target||"number"==typeof a.camera.azimuthAngle||"number"==typeof a.camera.inclinationAngle||"number"==typeof a.camera.distance)&&this.setCamera(a.camera),logger.debug("注册鼠标按下事件处理函数。"),Ep.renderer.domElement.addEventListener("pointerdown",(function(e){Ep.pointerDisabled||0!==e.button&&2!==e.button||(g=!0,y={x:e.offsetX,y:e.offsetY},u=!1,p=!1)}),!1),logger.debug("注册鼠标抬起事件处理函数。"),Ep.renderer.domElement.addEventListener("pointerup",(i=>{if(Ep.pointerDisabled)return;if(0!==i.button&&2!==i.button)return;let n=!0;i.upFlag=!0,g&&(g=!1,null!==y&&(n=Math.abs(i.offsetX-y.x)<3,!0===n&&(n=Math.abs(i.offsetY-y.y)<3),y=null)),n?(t.onClick(i,e,L),"manual"===Ep.effectStore.visualEffect.dofFocus&&(M.set(i.offsetX/Ep.renderer.domElement.clientWidth*2-1,-i.offsetY/Ep.renderer.domElement.clientHeight*2+1),this.focus())):"manual"===Ep.effectStore.visualEffect.dofFocus&&(M.set(0,0),this.focus()),u=!0,p=!0}),!1),logger.debug("注册鼠标滑动事件。"),Ep.renderer.domElement.addEventListener("pointermove",(i=>{Ep.pointerDisabled||(p=u,u=!0,u&&p&&O||g||t.mouseHoverTest(i,e,L))}),!1),Ep.renderer.domElement.addEventListener("wheel",(e=>{t.onWheel(e)}),!1),this.on("camerazoomstop",void 0,(()=>{this.focus()}),{debounce:!0}),Xu.workaroundEnabled=!0,window.rStats&&(h.bS=new BrowserStats,h.glS=new glStats,h.tS=new threeStats(Ep.renderer),h.rS=new rStats({userTimingAPI:!0,values:{frame:{caption:"Total frame time (ms)",over:16,average:!0,avgMs:100},fps:{caption:"Framerate (FPS)",below:30},calls:{caption:"Calls (three.js)",over:3e3},raf:{caption:"Time elapsed (ms)",average:!0,avgMs:100},setup:{caption:"Setup (ms)",average:!0,avgMs:100},rstats:{caption:"rStats update (ms)",average:!0,avgMs:100},focus:{caption:"Focus",average:!0,avgMs:100}},groups:[{caption:"Framerate",values:["fps","raf"]},{caption:"Frame Budget",values:["frame","setup","render"]}],fractions:[{base:"frame",steps:["texture","setup","render"]}],plugins:[h.bS,h.tS,h.glS]})),Ep.clock=new pc,s=!1,Ep.renderer.info.autoReset=!1,Ep.sceneBufferCacheExpired=!0,Ep.passiveModeRenderRateFrameCount=0,Ep.passiveModeSkipFrameCount=0,c||(Ep.deltaA=0,Ep.frameTimeLimit=1/Ep.fpsLimit,Ep.frameTimeGap=0,$()),Ep.gisStore=new qA,Ep.orbitControls.addEventListener("change",t.cameraMove.bind(t)),this.InstancedIconModelLandmarkInit()},this.focus=()=>{logger.debug("focus requested."),Ep.effectStore&&(Ep.effectStore.visualEffect.enableDOF||Ep.effectStore.visualEffect.dofQuality<=0)&&(ne(),logger.debug("focus done."),w>0&&(Ep.effectStore.visualEffect.dofFocusDistance=1*w/(Ep.camera.far-Ep.camera.near),Ep.sceneBufferCacheExpired=!0))},this.setToneMapping=(e=1,t=1)=>{Ep.renderer.toneMapping=e,Ep.renderer.toneMappingExposure=t;let i=this.getMaterials();for(let e in i)i[e]._material()&&(i[e]._material().needsUpdate=!0)},this.hideModel=(e,t)=>{this.defaultObjectTree.hideItemByName(e,t)},this.showModel=(e,t)=>{this.defaultObjectTree.showItemByName(e,t)},this.hideNode=(e,t)=>{Ep.modelStore.hideNode(e,t)},this.showNode=(e,t)=>{Ep.modelStore.showNode(e,t)},this.hideAxesHelper=()=>{Ep.scene.axesHelper.visible=!1},this.showAxesHelper=()=>{Ep.scene.axesHelper.visible=!0},this.getObjectCount=()=>R,this.getDefaultObjectTree=()=>this.defaultObjectTree,this.playAnimation=(e,t,i)=>{Ep.modelStore.playAnimation(e,t,i)},this.stopAnimation=(e,t)=>{Ep.modelStore.stopAnimation(e,t)},this._playClip=()=>{Z=!1},this._stopClip=()=>{Z=!0},this.getResolution=()=>n?{width:n.width,height:n.height}:void 0,this.setResolution=(e,t)=>{if(!("number"!=typeof e||e<0||e>Oy||"number"!=typeof t||t<0||t>Dy||(n={width:e,height:t},s))){Ep.camera.aspect=1*e/t,Ep.camera.updateProjectionMatrix(),Ep.renderer.setSize(e,t),Ep.effectStore.setSize(e,t),Ep.cameraOrtho.left=-200*Ep.camera.aspect,Ep.cameraOrtho.right=200*Ep.camera.aspect,Ep.cameraOrtho.top=200,Ep.cameraOrtho.bottom=-200,Ep.cameraOrtho.updateProjectionMatrix(),"number"==typeof Ep.fpsLimit&&this.setFPSLimit(Ep.fpsLimit),Ep.sceneBufferCacheExpired=!0;let i=Ep.animationStore.getAnimations();for(let e=0,n=i.length;e<n;e++)i[e].isParticleStore&&(i[e].isPreview||i[e].resize(t))}},this.changeSize=this.setResolution,this.setAmbientLight=(e,t)=>{Ep.lightStore.setAmbientLight(e,t)},this.statsOn=()=>{i.domElement.style.display="block",l=!0},this.statsOff=()=>{i.domElement.style.display="none",l=!1},this.statsToggle=()=>{i.domElement.style.display=l?"none":"block",l=!l},this.switchCameraMode=(e=0,t="y",i={})=>{let n=1e3;if(O=1===e,O){Ep.scene.models.traverse((e=>{e.isWater&&(e.paused=!0)}));let e=-1/0,a=-1/0,r=-1/0,s=1/0,o=1/0,l=1/0;if(Ep.scene.models.children instanceof Array&&Ep.scene.models.children.length>0?(Ep.scene.models.traverse((t=>{if(t.geometry)if(i.boundingSphere){t.geometry.computeBoundingSphere(),t.updateMatrixWorld(),t.geometry.boundingSphere.applyMatrix4(t.matrixWorld);const i=new Ce(t.geometry.boundingSphere.center.x+t.geometry.boundingSphere.radius,t.geometry.boundingSphere.center.y+t.geometry.boundingSphere.radius,t.geometry.boundingSphere.center.z+t.geometry.boundingSphere.radius);e=Math.max(e,i.x),a=Math.max(a,i.y),r=Math.max(r,i.z);const n=new Ce(t.geometry.boundingSphere.center.x-t.geometry.boundingSphere.radius,t.geometry.boundingSphere.center.y-t.geometry.boundingSphere.radius,t.geometry.boundingSphere.center.z-t.geometry.boundingSphere.radius);s=Math.min(s,n.x),o=Math.min(o,n.y),l=Math.min(l,n.z)}else{t.geometry.computeBoundingBox(),t.updateMatrixWorld();const i=new Ce(t.geometry.boundingBox.max.x,t.geometry.boundingBox.max.y,t.geometry.boundingBox.max.z);i.applyMatrix4(t.matrixWorld),e=Math.max(e,i.x),a=Math.max(a,i.y),r=Math.max(r,i.z);const n=new Ce(t.geometry.boundingBox.min.x,t.geometry.boundingBox.min.y,t.geometry.boundingBox.min.z);n.applyMatrix4(t.matrixWorld),s=Math.min(s,n.x),o=Math.min(o,n.y),l=Math.min(l,n.z)}})),n=Math.max(r-l,Math.max(e-s,a-o)),i.boundingSphere?(e+=9*Math.abs(e),a+=9*Math.abs(a),r+=9*Math.abs(r),s-=9*Math.abs(s),o-=9*Math.abs(o),l-=9*Math.abs(l)):(e+=.25*Math.abs(e),a+=.25*Math.abs(a),r+=.25*Math.abs(r),s-=.25*Math.abs(s),o-=.25*Math.abs(o),l-=.25*Math.abs(l))):(e=1e3,a=1e3,r=1e3,s=-1e3,o=-1e3,l=-1e3),Ep.cameraOrtho.position.x=0,Ep.cameraOrtho.position.y="y"===t?a:.001*n,Ep.cameraOrtho.position.y="-y"===t?o:Ep.cameraOrtho.position.y,Ep.cameraOrtho.position.z="z"===t?r:.001*n,Ep.cameraOrtho.position.z="-z"===t?l:Ep.cameraOrtho.position.z,Ep.cameraOrtho.lookAt(0,0,0),Ep.cameraOrtho.updateMatrixWorld(),Ep.cameraOrtho.updateProjectionMatrix(),i.fitX){const t=e/Ep.cameraOrtho.right;i.boundingSphere?Ep.cameraOrtho.zoom=10/t:Ep.cameraOrtho.zoom=1/t}else if(!i.fitX&&i.fitY){const e=a/Ep.cameraOrtho.top;i.boundingSphere?Ep.cameraOrtho.zoom=10/e:Ep.cameraOrtho.zoom=1/e}else Ep.cameraOrtho.zoom=1;Ep.cameraOrtho.updateMatrixWorld(),Ep.cameraOrtho.updateProjectionMatrix(),Ep.orthoCameraControls.target.set(0,0,0),"y"===t&&(Ep.orthoCameraControls.minPolarAngle=-89.999999/180*Math.PI,Ep.orthoCameraControls.maxPolarAngle=-89.99999/180*Math.PI),"z"!==t&&"-z"!==t||(Ep.orthoCameraControls.minPolarAngle=-1/0,Ep.orthoCameraControls.maxPolarAngle=1/0),Ep.transformControls.camera=Ep.cameraOrtho,Ep.activeCamera=Ep.cameraOrtho,Ep.orbitControls.enabled=!1,Ep.orthoCameraControls.enabled=!0}else Ep.scene.models.traverse((e=>{e.isWater&&(e.paused=!1)})),Ep.transformControls.camera=Ep.camera,Ep.activeCamera=Ep.camera,Ep.orthoCameraControls.enabled=!1,Ep.orbitControls.enabled=!0;return n},this.getTextures=()=>Ep.textureStore?[...Ep.textureStore.getAll(),...Ep.customTextureStore.getAll()]:[],this.getModelTextures=()=>Ep.textureStore?Ep.textureStore.getAll():[],this.getTexture=e=>Ep.textureStore.find(e),this.resetSettings=()=>{Ep.effectStore._composer&&Ep.effectStore._composer.reset()},this.applySettings=async(e,t,i,n=!1,a=!1)=>{a&&(e=await _y.setPackSettings(e)),null!=e.sceneName&&(Ep.sceneName=e.sceneName),e.fpsLimit&&this.setFPSLimit(e.fpsLimit),this.setColorSpace(e.colorSpace||"linear");let r=null;r=e.states&&e.states.length&&n?JSON.parse(JSON.stringify(e.states.find((e=>e.defaultState)).settings.view)):JSON.parse(JSON.stringify(e.view));let s={type:"progress",total:100,loaded:0};if(this.defaultView.applySettings(r,(()=>{}),!0),I=e&&e.lights?e.lights.skybox:"",this.resetSettings(),await Ep.textureStore.applySettings(e.texture0||{}),delete e.texture0,await Ep.customTextureStore.applySettings(e.texture||[]),s.loaded=10,logger.debug("core.applySettings() loadTexture end。"),i&&i(s),await Ep.cacheStore.applySettings(e.cache),s.loaded=20,logger.debug("core.applySettings() loadMaterial end。"),i&&i(s),!(e.objectTree.children instanceof Array))return void this.applyEffectSettings(e,t,i);let o=0,l=[],c=[];for(let e in b.gltfLoader.requestHeader)c.push({key:e,value:b.gltfLoader.requestHeader[e]});this.contentLengthPromisesRemove(e.objectTree.children,l,c),Promise.all(l).then((n=>{if(n instanceof Array)for(let e of n)o+=Number(e);o+=.2*o,logger.debug(o);let a=[],r=[],s=0;s=.2*o,Ep.paintControls.clearBrushPath(),this.defaultObjectTree.setIndex(e.objectTree.lastIndex,e.objectTree.minIndex);for(let t=0;t<e.objectTree.children.length;t++)a.push(new Promise((n=>{if("ModelItem"===e.objectTree.children[t].type)this.defaultObjectTree.addModel({name:e.objectTree.children[t].name,modelPath:e.objectTree.children[t].modelPath,modelType:e.objectTree.children[t].modelType||"glb",transform:e.objectTree.children[t].transform,index:e.objectTree.children[t].index,isVisible:null==e.objectTree.children[t].isVisible||e.objectTree.children[t].isVisible,isLock:null!=e.objectTree.children[t].isLock&&e.objectTree.children[t].isLock},(e=>{n(e)}),(n=>{if(i){var a={name:e.objectTree.children[t].name,parent:"model",loaded:n.loaded};for(let e=0;e<r.length;e++)if(r[e].name===a.name&&r[e].parent===a.parent){var l=a.loaded-r[e].loaded;r.splice(e,1),e--}l||(l=a.loaded),r.push(a),s+=l,i({type:"progress",total:o,loaded:s})}logger.debug("progress",n)}));else if("IconAsset"===e.objectTree.children[t].type)new yb(e.objectTree.children[t],null,(e=>{n(e)}));else if("PaperCutItem"===e.objectTree.children[t].type)this.defaultObjectTree.addPaperCutItem(e.objectTree.children[t],(e=>{n(e)}));else if("GroupItem"===e.objectTree.children[t].type){let a=new Sb(e.objectTree.children[t]),l=[];e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new yb(e,a);break;case"ModelAsset":l.push(new Promise((t=>{a.childrenAdd(new X_(e,a,(e=>{t(e)}),(t=>{if(i){var n={name:e.name,parent:"model",loaded:t.loaded};for(let e=0;e<r.length;e++)if(r[e].name===n.name&&r[e].parent===n.parent){var a=n.loaded-r[e].loaded;r.splice(e,1),e--}a||(a=n.loaded),r.push(n),s+=a,i({type:"progress",total:o,loaded:s})}logger.debug("progress",t)})))})))}})),l.length?Promise.all(l).then((()=>{n(1)})):n(1)}else if("PaintItem"===e.objectTree.children[t].type){let a=[],l=new ex(e.objectTree.children[t]);e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new yb(e,l)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":a.push(new Promise((t=>{new $_(e,((i,n,a)=>{_y.setArticulation(e,a),a.materialStore&&a.materialStore.applySettings(e.materials,l.name),t(1)}),(t=>{if(i){var n={name:e.name,parent:"model",loaded:t.loaded};for(let e=0;e<r.length;e++)if(r[e].name===n.name&&r[e].parent===n.parent){var a=n.loaded-r[e].loaded;r.splice(e,1),e--}a||(a=n.loaded),r.push(n),s+=a,i({type:"progress",total:o,loaded:s})}logger.debug("progress",t)}),l)})));break;case"PaperCutItem":new Mx(e,l)._setLock(e.isLock)}}));let c=e.objectTree.children[t].iconInstanced;for(let e=0;e<c.length;e++)new bb(c[e].assetObj,l,((t,i)=>{for(let t=0;t<c[e].points.length;t++){let n=JSON.parse(JSON.stringify(c[e].assetObj));n.transform.position.x=c[e].points[t][0],n.transform.position.y=c[e].points[t][1],n.transform.position.z=c[e].points[t][2],c[e].scales&&c[e].scales.length>t?n.transform.scale=c[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=c[e].settings[t].name,n.isVisible=c[e].settings[t].isVisible,n.isLock=c[e].settings[t].isLock;let a=new _b(n,i,c[e].settings[t].key,c[e].settings[t].index);i.children[t].name=n.name,l.childrenAdd(a),n.isVisible||(a.getGroup().visible=n.isVisible)}}));const h=e.objectTree.children[t];if(l.pathBrushLinePoints)for(const e of l.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let u=e.objectTree.children[t].modelInstanced,d=e.objectTree.children[t];for(let e=0;e<u.length;e++)a.push(new Promise((t=>{new X_(u[e],l,((i,n)=>{for(let t=0;t<u[e].points.length;t++){let i=JSON.parse(JSON.stringify(u[e]));i.transform={position:{x:u[e].points[t][0],y:u[e].points[t][1],z:u[e].points[t][2]}},i.name=u[e].settings[t].name,i.isVisible=u[e].settings[t].isVisible,i.isLock=u[e].settings[t].isLock;let a=new _b(i,n,u[e].settings[t].key,u[e].settings[t].index);l.childrenAdd(a);const r=h.children.find((i=>"movingObject"===i.type&&i.instanced===n.name&&i.key===u[e].settings[t].key));if(r){const e=l.pathBrushLinePoints[r.lineIndex];e&&(a.createMovingAnimation(),a.movingAnimation.euler.set(r.euler.x,r.euler.y,r.euler.z),a.movingAnimation.startLength=r.startLength,a.movingAnimation.maxLength=r.maxLength,a.movingAnimation.reverse=r.reverse,a.movingAnimation.speed=r.speed,a.movingAnimation.useTangent=r.useTangent,a.movingAnimation.perpendicular=r.perpendicular,a.movingAnimation.paintPoints=e.points,a.movingAnimation.paintTangents=e.tangents,a.movingAnimation.paintLengths=e.lengths,a.movingAnimation.lineIndex=r.lineIndex,a.movingAnimation.delay=r.delay,a.movingAnimation.reset());let t=new Ce;d.pathBrushProperties&&d.pathBrushProperties.options&&d.pathBrushProperties.options.offset&&(t.x=d.pathBrushProperties.options.offset.x,t.y=d.pathBrushProperties.options.offset.y,t.z=d.pathBrushProperties.options.offset.z,n.particleStoreArray&&n.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else l.pathBrushOptions&&l.pathBrushOptions.type&&("C"!==l.pathBrushOptions.type&&"D"!==l.pathBrushOptions.type||n.getHelper(a.key).rotation.set(0,0,0))}l.children.sort(((e,t)=>e.index-t.index)),n.materialStore.applySettings(u[e].materials,l.name,n.name),t(i)}),(t=>{if(i){var n={name:u[e].name,parent:"model",loaded:t.loaded};for(let e=0;e<r.length;e++)if(r[e].name===n.name&&r[e].parent===n.parent){var a=n.loaded-r[e].loaded;r.splice(e,1),e--}a||(a=n.loaded),r.push(n),s+=a,i({type:"progress",total:o,loaded:s})}logger.debug("progress",t)}))})));if(e.objectTree.children[t].effectPathItems){const i=e.objectTree.children[t].effectPathItems;for(const e of i){const t=new tv({name:e.name});l.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0,e.pathColor)}}a.length?Promise.all(a).then((e=>{l.pathBrushLinePoints||l.pathBrushOptions&&l.pathBrushOptions.type&&("C"!==l.pathBrushOptions.type&&"D"!==l.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:l})),n(1)})):n(1)}else if("BuildingItem"===e.objectTree.children[t].type){var a=e.objectTree.children[t].children;if(0===a.length)this.defaultObjectTree.addBuilding(e.objectTree.children[t],(e=>{n(e)}));else{for(let e=0;e<a.length;e++)switch(a[e].type){case"ModelItem":case"IconAsset":break;case"BuildingFloorItem":if(0===a[e].children.length);else for(let t=0;t<a[e].children.length;t++);break;case"BuildingFloorItem":if(0===a[e].children.length);else for(let t=0;t<a[e].children.length;t++);}this.defaultObjectTree.addBuilding(e.objectTree.children[t],(e=>{1===e&&n(e)}),(e=>{if(i){let t;for(let i=0;i<r.length;i++)r[i].name===e.name&&r[i].parent===e.parent&&(t=e.loaded-r[i].loaded,r.splice(i,1),i--);t||(t=e.loaded),r.push(e),s+=t,i({type:"progress",total:o,loaded:s})}logger.debug("progress",e)}))}}else if("TileSetItem"===e.objectTree.children[t].type)n({type:"TileSetItem",item:e.objectTree.children[t]});else if("GisItem"===e.objectTree.children[t].type)n({type:"GisItem",item:e.objectTree.children[t]});else if("LineItem"==e.objectTree.children[t].type)n({type:"LineItem",item:e.objectTree.children[t]});else if("PluginItem"==e.objectTree.children[t].type)n({type:"PluginItem",item:e.objectTree.children[t]});else if("PackedItem"==e.objectTree.children[t].type){let a=[],l=new Tx({assetObj:e.objectTree.children[t]});e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new yb(e,l)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":a.push(new Promise((t=>{new $_(e,((i,n,a)=>{_y.setArticulation(e,a),a.materialStore&&a.materialStore.applySettings(e.materials,l.name),t(1)}),(t=>{if(i){var n={name:e.name,parent:"model",loaded:t.loaded};for(let e=0;e<r.length;e++)if(r[e].name===n.name&&r[e].parent===n.parent){var a=n.loaded-r[e].loaded;r.splice(e,1),e--}a||(a=n.loaded),r.push(n),s+=a,i({type:"progress",total:o,loaded:s})}logger.debug("progress",t)}),l)})));break;case"PaperCutItem":new Mx(e,l)._setLock(e.isLock);break;case"PaintItem":a.push(new Promise((t=>{let n=[],a=new ex(e,null,l.getGroup(),l);e.children.map((e=>{switch(e.type){case"IconAsset":new yb(e,a)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":n.push(new Promise((t=>{new $_(e,((i,n,r)=>{_y.setArticulation(e,r),r.materialStore&&r.materialStore.applySettings(e.materials,a.name),t(1)}),(t=>{if(i){var n={name:e.name,parent:"model",loaded:t.loaded};for(let e=0;e<r.length;e++)if(r[e].name===n.name&&r[e].parent===n.parent){var a=n.loaded-r[e].loaded;r.splice(e,1),e--}a||(a=n.loaded),r.push(n),s+=a,i({type:"progress",total:o,loaded:s})}logger.debug("progress",t)}),a)})));break;case"PaperCutItem":new Mx(e,a)._setLock(e.isLock)}}));let c=e.iconInstanced;for(let e=0;e<c.length;e++)new bb(c[e].assetObj,a,((t,i)=>{for(let t=0;t<c[e].points.length;t++){let n=JSON.parse(JSON.stringify(c[e].assetObj));n.transform.position.x=c[e].points[t][0],n.transform.position.y=c[e].points[t][1],n.transform.position.z=c[e].points[t][2],c[e].scales&&c[e].scales.length>t?n.transform.scale=c[e].scales[t]:n.transform.scale={x:1,y:1,z:1},n.name=c[e].settings[t].name,n.isVisible=c[e].settings[t].isVisible,n.isLock=c[e].settings[t].isLock;let r=new _b(n,i,c[e].settings[t].key,c[e].settings[t].index);i.children[t].name=n.name,a.childrenAdd(r),n.isVisible||(r.getGroup().visible=n.isVisible)}}));const h=e;if(a.pathBrushLinePoints)for(const e of a.pathBrushLinePoints)e.points=e.points.map((e=>(new Ce).copy(e))),e.tangents=e.tangents.map((e=>(new Ce).copy(e)));let u=e.modelInstanced,d=e;for(let e=0;e<u.length;e++)n.push(new Promise((t=>{new X_(u[e],a,((i,n)=>{for(let t=0;t<u[e].points.length;t++){let i=JSON.parse(JSON.stringify(u[e]));i.transform={position:{x:u[e].points[t][0],y:u[e].points[t][1],z:u[e].points[t][2]}},i.name=u[e].settings[t].name,i.isVisible=u[e].settings[t].isVisible,i.isLock=u[e].settings[t].isLock;let r=new _b(i,n,u[e].settings[t].key,u[e].settings[t].index);a.childrenAdd(r);const s=h.children.find((i=>"movingObject"===i.type&&i.instanced===n.name&&i.key===u[e].settings[t].key));if(s){const e=a.pathBrushLinePoints[s.lineIndex];e&&(r.createMovingAnimation(),r.movingAnimation.euler.set(s.euler.x,s.euler.y,s.euler.z),r.movingAnimation.startLength=s.startLength,r.movingAnimation.maxLength=s.maxLength,r.movingAnimation.reverse=s.reverse,r.movingAnimation.speed=s.speed,r.movingAnimation.useTangent=s.useTangent,r.movingAnimation.perpendicular=s.perpendicular,r.movingAnimation.paintPoints=e.points,r.movingAnimation.paintTangents=e.tangents,r.movingAnimation.paintLengths=e.lengths,r.movingAnimation.lineIndex=s.lineIndex,r.movingAnimation.delay=s.delay,r.movingAnimation.reset());let t=new Ce;d.pathBrushProperties&&d.pathBrushProperties.options&&d.pathBrushProperties.options.offset&&(t.x=d.pathBrushProperties.options.offset.x,t.y=d.pathBrushProperties.options.offset.y,t.z=d.pathBrushProperties.options.offset.z,n.particleStoreArray&&n.particleStoreArray.forEach((e=>{e.particleGroup.map((e=>{e.moveState=!0,e.paintOffset=t.clone()}))})))}else a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||n.getHelper(r.key).rotation.set(0,0,0))}a.children.sort(((e,t)=>e.index-t.index)),n.materialStore.applySettings(u[e].materials,a.name,n.name),t(i)}),(t=>{if(i){var n={name:u[e].name,parent:"model",loaded:t.loaded};for(let e=0;e<r.length;e++)if(r[e].name===n.name&&r[e].parent===n.parent){var a=n.loaded-r[e].loaded;r.splice(e,1),e--}a||(a=n.loaded),r.push(n),s+=a,i({type:"progress",total:o,loaded:s})}logger.debug("progress",t)}))})));if(e.effectPathItems){const t=e.effectPathItems;for(const e of t){const t=new tv({name:e.name});a.addEffectPath(t),t.loadPath(e.points,e.pathStyle,e.pathWidth,e.textureSizeCoef,e.speed,!0)}}n.length?Promise.all(n).then((e=>{a.pathBrushLinePoints||a.pathBrushOptions&&a.pathBrushOptions.type&&("C"!==a.pathBrushOptions.type&&"D"!==a.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:a})),t(1)})):t(1)})))}})),a.length?Promise.all(a).then((e=>{l.pathBrushLinePoints||l.pathBrushOptions&&l.pathBrushOptions.type&&("C"!==l.pathBrushOptions.type&&"D"!==l.pathBrushOptions.type||Ep.paintControls._updatePathDrawing2({drawGroup:l})),n(1)})):n(1)}})));Promise.all(a).then((n=>{i&&i({type:"progress",total:1,loaded:1});let a=[];a.push(new Promise((t=>{this.applyEffectSettings(e,(e=>{t(e)}))}))),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type&&(e.children.forEach((e=>{e.level&&e.hide()})),e.floor)){e.room?this.cutLevelToRoom(e.getGroup().uuid,e.floor,e.room):this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<W.length;t++)W[t].uuid===e.getGroup().uuid&&(W.splice(t,1),t--);W.push({uuid:e.getGroup().uuid,level:e.floor})}})),n.forEach((e=>{e&&"TileSetItem"==e.type&&a.push(new Promise((t=>{new bx(e.item,(e=>{t(e)}))}))),e&&"GisItem"==e.type&&a.push(new Promise((t=>{new Cx(e.item,(e=>{t(e)}))}))),e&&"LineItem"==e.type&&a.push(new Promise((t=>{Ep.defaultObjectTree.addLineItem(e.item,(e=>{t(e)}))}))),e&&"PluginItem"==e.type&&a.push(new Promise((t=>{Ep.defaultObjectTree.addPluginItem(e.item,((i,n)=>{n.applySetting(e.item,(()=>{console.log("加载完成执行了"),t(i)}))}))})))})),Promise.all(a).then((i=>{Ep.hasUpgradeSuggest&&wx.checkSuggestOn(),this.defaultObjectTree.applySettings(e.objectTree),t&&t(i)}))})).catch((e=>{logger.error(e)}))}))},this.getResourceScene=async(e,t,i,n,a)=>{if(null!=e.sceneName&&(Ep.sceneName=e.sceneName),this.resetSettings(),!(e.objectTree.children instanceof Array))return void this.applyEffectSettings(e,t,i);let r=0,s=[],o=[];for(let e in b.gltfLoader.requestHeader)o.push({key:e,value:b.gltfLoader.requestHeader[e]});this.contentLengthPromisesRemove(e.objectTree.children,s,o),Promise.all(s).then((s=>{if(s instanceof Array)for(let e of s)r+=Number(e);logger.debug(r);let o=[],l=[],c=0;for(let t=0;t<e.objectTree.children.length;t++)"TileSetItem"!==e.objectTree.children[t].type&&o.push(new Promise((s=>{if("ModelItem"===e.objectTree.children[t].type)a.addModel({name:e.objectTree.children[t].name,modelPath:e.objectTree.children[t].modelPath,modelType:e.objectTree.children[t].modelType||"glb",transform:e.objectTree.children[t].transform,index:e.objectTree.children[t].index,isVisible:null==e.objectTree.children[t].isVisible||e.objectTree.children[t].isVisible,isLock:null!=e.objectTree.children[t].isLock&&e.objectTree.children[t].isLock},(e=>{s(e)}),(n=>{if(i){var a={name:e.objectTree.children[t].name,parent:"model",loaded:n.loaded};for(let e=0;e<l.length;e++)if(l[e].name===a.name&&l[e].parent===a.parent){var s=a.loaded-l[e].loaded;l.splice(e,1),e--}s||(s=a.loaded),l.push(a),c+=s,i({type:"progress",total:r,loaded:c})}logger.debug("progress",n)}),n);else if("IconAsset"===e.objectTree.children[t].type)new yb(e.objectTree.children[t],n,(e=>{s(e)}),a);else if("GroupItem"===e.objectTree.children[t].type){let i=new Sb(e.objectTree.children[t],null,n,a);e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new yb(e,i);break;case"ModelAsset":i.childrenAdd(new X_(e,i))}})),s(1)}else if("PaintItem"===e.objectTree.children[t].type){let i=!0,r=[],o=new ex(e.objectTree.children[t],null,n,a);e.objectTree.children[t].children.map((e=>{switch(e.type){case"IconAsset":new yb(e,o)._setLock(e.isLock);break;case"ModelAsset":case"ModelItem":i=!1,r.push(new Promise((t=>{new $_(e,(e=>{t(e)}),null,o)})))}})),r.length&&Promise.all(r).then((e=>{s(1)}));let l=e.objectTree.children[t].iconInstanced;for(let e=0;e<l.length;e++)new bb(l[e].assetObj,o,((e,t)=>{o.addInstanced("IconAsset",t)}));let c=e.objectTree.children[t].modelInstanced;for(let e=0;e<c.length;e++){let t=new X_(c[e],o);o.addInstanced("ModelAsset",t)}i&&s(1)}else if("BuildingItem"===e.objectTree.children[t].type){var o=e.objectTree.children[t].children;if(0===o.length)a.addBuilding(e.objectTree.children[t],(e=>{s(e)}),(()=>{}),n);else{for(let e=0;e<o.length;e++)switch(o[e].type){case"ModelItem":case"IconAsset":break;case"BuildingFloorItem":if(0===o[e].children.length);else for(let t=0;t<o[e].children.length;t++);}a.addBuilding(e.objectTree.children[t],(e=>{1===e&&s(e)}),(e=>{if(i){let t;for(let i=0;i<l.length;i++)l[i].name===e.name&&l[i].parent===e.parent&&(t=e.loaded-l[i].loaded,l.splice(i,1),i--);t||(t=e.loaded),l.push(e),c+=t,i({type:"progress",total:r,loaded:c})}logger.debug("progress",e)}),n)}}else"PackedItem"===e.objectTree.children[t].type&&new Tx(e.objectTree.children[t],n,(e=>{s(e)}),a)})));Promise.all(o).then((()=>{i&&i({type:"progress",total:1,loaded:1}),t()})).catch((e=>{logger.error(e)}))}))},this.applyEffectSettings=(e,t,i)=>{i&&i({type:"progress",total:1,loaded:1}),Ep.sceneSettings=_y.cloneDeep(e);let n=_y.cloneDeep(e.view.camera);B.azimuthAngle=n.azimuth,B.inclinationAngle=n.inclination,B.fov=n.fov,B.viewDistance=n.distance,B.near=n.viewDistanceMin,B.far=n.viewDistanceMax,B.targetX=n.targetX,B.targetY=n.targetY,B.targetZ=n.targetZ,B.inclinationAngleMin=n.inclinationAngleMin,B.inclinationAngleMax=n.inclinationAngleMax,e.background&&(Ep.background.mode=e.background.mode,Ep.background.cubeTextureRotationY=e.background.cubeTextureRotationY||0,Ep.background.cubeTextureBlur=e.background.cubeTextureBlur,Ep.background.cubeTextureIntensity=e.background.cubeTextureIntensity,Ep.background.environmentLuminosity=e.background.environmentLuminosity,Ep.background.isCustomSkybox=e.background.isCustomSkybox),Ep.background.color=null,Ep.background.texture=null,e.background&&(e.background.colorCSSValue&&this.setBackgroundColor(e.background.colorCSSValue),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),e.effects?.visualEffect?.enableToneMapping&&(e.effects.visualEffect.enableImageAdjustment=!0,e.effects.visualEffect.imageAdjustmentBrightness=Math.min(Math.max(5*e.effects.visualEffect.toneMappingBrightness,-1),1),e.effects.visualEffect.imageAdjustmentContrast=Math.min(Math.max(5*e.effects.visualEffect.toneMappingContrast,-1),1),e.effects.visualEffect.imageAdjustmentSaturation=Math.min(Math.max(e.effects.visualEffect.toneMappingSaturation,-1),1),e.effects.visualEffect.imageAdjustmentHue=Math.min(Math.max(e.effects.visualEffect.toneMappingHue,-180),180),e.effects.visualEffect.enableToneMapping=!1,e.effects.visualEffect.toneMappingBrightness=e.effects.visualEffect.toneMappingContrast=e.effects.visualEffect.toneMappingSaturation=e.effects.visualEffect.toneMappingHue=0),this.defaultEffectStore.applySettings(e.effects),e.datumShiftModel&&this.setDatumShiftModel(e.datumShiftModel),Ep.stateStore&&Ep.stateStore.applySettings(e.states),null!=e.sceneModelTransform&&null!=e.sceneModelTransform.position&&(Ep.scene.models.position.x=e.sceneModelTransform.position.x,Ep.scene.models.position.y=e.sceneModelTransform.position.y,Ep.scene.models.position.z=e.sceneModelTransform.position.z,Ep.scene.models.rotation._order=e.sceneModelTransform.rotation._order,Ep.scene.models.rotation._x=e.sceneModelTransform.rotation._x,Ep.scene.models.rotation._y=e.sceneModelTransform.rotation._y,Ep.scene.models.rotation._z=e.sceneModelTransform.rotation._z,Ep.scene.models.scale.x=e.sceneModelTransform.scale.x,Ep.scene.models.scale.y=e.sceneModelTransform.scale.y,Ep.scene.models.scale.z=e.sceneModelTransform.scale.z),e.mapWorldRotationY&&(j=e.mapWorldRotationY),Ep.paintControls&&Ep.paintControls.updateWorld(),Ep.lightStore.applySettings(e.lights,(()=>{t&&t(1,"applySettings() 加载完毕。")}),e.view.camera.duration),logger.debug("applySettings() 加载完毕。")},this.contentLengthPromisesRemove=(e,t,i,n=[])=>{e.map((e=>{if("ModelItem"===e.type||"ModelAsset"===e.type){let r=e.modelPath||e.path;if(Ep.cacheStore&&Ep.cacheStore._cache&&Ep.cacheStore._cache.get(fy(r)))return;if(-1!=r.indexOf("[[origin]]"))var a=r.replace("[[origin]]",Ep.origin);else a=r;n.find((e=>e===a))||(n.push(a),t.push(_y.fetchContentLength(a,i)))}else e.children&&e.children.length>0&&this.contentLengthPromisesRemove(e.children,t,i,n),e.modelInstanced&&e.modelInstanced.length>0&&this.contentLengthPromisesRemove(e.modelInstanced,t,i,n)}))},this.applySceneSettings=(e,t)=>{if(this.resetSettings(),e.background&&(Ep.background.mode!=e.background.mode&&(this.crossfadeFreeze(),this.crossfade(1e3)),Ep.background.mode=e.background.mode,Ep.background.cubeTextureRotationY=e.background.cubeTextureRotationY,Ep.background.cubeTextureBlur=e.background.cubeTextureBlur,Ep.background.isCustomSkybox=e.background.isCustomSkybox),Ep.background.color=null,Ep.background.texture=null,Ep.lightStore.applySettings(e.lights,(()=>{}),e.view.camera.duration),e.background&&(Ep.background.cubeTextureRotationY=e.background.cubeTextureRotationY||0,Ep.background.cubeTextureBlur=e.background.cubeTextureBlur,Ep.background.isCustomSkybox=e.background.isCustomSkybox,Ep.background.cubeTextureIntensity=e.background.cubeTextureIntensity,Ep.background.environmentLuminosity=e.background.environmentLuminosity,e.background.colorCSSValue&&(this._backgroundColorType!=e.background.colorCSSValue.type&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColorType=e.background.colorCSSValue.type,"single"==e.background.colorCSSValue.type?(this._backgroundColor1!=e.background.colorCSSValue.color1&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColor1=e.background.colorCSSValue.color1):"gradient"==e.background.colorCSSValue.type&&(this._backgroundColorUrl!=e.background.colorCSSValue.dataUrl&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColorUrl=e.background.colorCSSValue.dataUrl),this.setBackgroundColor(e.background.colorCSSValue)),e.background.textureURL&&this.setBackgroundImage(e.background.textureURL),e.background.mode&&this.setBackgroundMode(e.background.mode,e)),this.defaultObjectTree.applySettings(e.objectTree,!1,!1,!0),this.defaultEffectStore.applySettings(e.effects),e.view&&e.view.camera&&"number"==typeof e.view.camera.viewDistanceMin&&"number"==typeof e.view.camera.viewDistanceMax){let t=Ep.camera.clone();t.near=e.view.camera.viewDistanceMin,t.far=e.view.camera.viewDistanceMax,this.defaultEffectStore.visualEffect._updateCameraProjection(t)}e.datumShiftModel&&this.setDatumShiftModel(e.datumShiftModel),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type)if(e.children.forEach((e=>{e.level&&e.hide()})),e.floor){e.room?this.cutLevelToRoom(e.getGroup().uuid,e.floor,e.room):this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<W.length;t++)W[t].uuid===e.getGroup().uuid&&(W.splice(t,1),t--);W.push({uuid:e.getGroup().uuid,level:e.floor})}else this.cutLevel(e.getGroup().uuid,e.floor)})),this.nextRender((()=>{this.setAutoRotate(!1,0),this.defaultView.applySettings(e.view,(i=>{t&&t(i,"状态切换成功"),this.focus(),this.nextRender((()=>{this.setAutoRotate(e.view.camera.autoRotate,_y.getAutoRotateTime(e.view.camera.autoRotateSpeed,e.view.camera.autoRotateDirection))}),10)}))}),1),logger.debug("applySceneSettings() 应用完毕。")},this.saveSceneSettings=e=>{Ep.sceneSettings=_y.clone(e)},this.savePackSettings=async(e,t)=>{let i={};i="string"==typeof e&&e.includes("objectTree")?JSON.parse(e):await _y.setPackSettings(e),i.publishQuality=t.publishQuality,this.saveSceneSettings(i)},this.loadSceneSettings=()=>_y.clone(Ep.sceneSettings),this.disableLightProbe=()=>{Ep.lightStore.disableLightProbe()},this.enableLightProbe=()=>{Ep.lightStore.enableLightProbe()},this.off=(e,i,n)=>{t?t.remove(e,i,n):logger.error("事件处理管理器错误。")},this.on=(e,i,n)=>{t?t.add(e,i,n):logger.error("事件处理管理器错误。")},this._transformControlKeyUp=function(e){switch(e.keyCode){case 16:Ep.transformControls.setTranslationSnap(null),Ep.transformControls.setRotationSnap(null),Ep.transformControls.setScaleSnap(null)}},this._transformControlKeyDown=function(e){e.keyCode},this.enableTransformOnModel=(e,t,i)=>{if(!Ep.scene)return!1;if(!this.defaultObjectTree.getItemByName(e))return;let n=this.defaultObjectTree.getItemByName(e).getGroup();return!!(n&&n instanceof Et)&&(Ep.transformControls.attach(n),void 0!==i&&("translate"===t&&Ep.transformControls.setTranslationSnap(i),"scale"===t&&Ep.transformControls.setScaleSnap(i),"rotate"===t&&(i=i/180*Math.PI,Ep.transformControls.setRotationSnap(i))),this.setTransformMode(t),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),!0)},this.enableTransformOnNode=(e,t)=>{if(!Ep.scene)return void logger.debug("_context.scene 为空");if(this.disableTransform(),!this.defaultObjectTree.getItemByName(e))return;let i=this.defaultObjectTree.getItemByName(e).getGroup();if(i&&i instanceof Et){let e;if(i.traverse((function(i){i.name===t&&(e=i)})),e)return Ep.transformControls.attach(e),this.setTransformMode("translate"),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),!0}return Ep.effectStore.highlightObject(void 0),!1},this.enableAxesTransform=(e,t,i)=>{if(!Ep.scene)return void logger.debug("_context.scene 为空");if(this.disableTransform(),Ep.axesTransformControls.removeEventListener("change"),!this.defaultObjectTree.getItemByName(e))return;let n=this.defaultObjectTree.getItemByName(e).getGroup();return n?("function"==typeof i&&Ep.axesTransformControls.addEventListener("change",i),Ep.axesTransformControls.attach(n),this.setAxesTransformMode("translate"),!0):(Ep.effectStore.highlightObject(void 0),!1)},this.setAxesTransformXYZ=e=>{if(!Ep.scene||!Ep.axesTransformControls)return!1;Ep.axesTransformControls.setXYZ(e)},this.setAxesTransformMode=e=>{if(!Ep.scene||!Ep.axesTransformControls||"string"!=typeof e)return!1;switch(e.toLowerCase()){case"translate":return N||Ep.axesTransformControls.setMode(e.toLowerCase()),!0}return!1},this.setNodeAxesType=function(e){switch(e){case"center":Ep.axesTransformControls.setCenter();break;case"bottom":Ep.axesTransformControls.setBottom();break;case"reset":Ep.axesTransformControls.reset()}},this.disableAxesTransform=()=>{Ep.scene?N||(Ep.axesTransformControls.detach(),window.removeEventListener("keydown",this._transformControlKeyDown),window.removeEventListener("keyup",this._transformControlKeyUp)):logger.debug("_context.scene 为空")},this.transformControlChangeEvent=e=>{let t=e.target.object,i={};t&&(t instanceof Mb?i=this.getModelTransformByUUID(t.uuid):(i.position=JSON.parse(JSON.stringify(t.position)),i.rotation=JSON.parse(JSON.stringify(t.rotation)),i.rotation.x=i.rotation._x,i.rotation.y=i.rotation._y,i.rotation.z=i.rotation._z,i.scale=JSON.parse(JSON.stringify(t.scale)),i.rotation.x=i.rotation._x=ge.radToDeg(i.rotation._x),i.rotation.y=i.rotation._y=ge.radToDeg(i.rotation._y),i.rotation.z=i.rotation._z=ge.radToDeg(i.rotation._z))),Ep.TransformChangeCallback&&Ep.TransformChangeCallback(e,i),t.traverse((e=>{if(e._LineItemID)if(e._LineItemID instanceof Array)e._LineItemID.map((e=>{const t=Ep.defaultObjectTree.getItemByUUID(e);t&&t.update()}));else{const t=Ep.defaultObjectTree.getItemByUUID(e._LineItemID);t&&t.update()}}))},this.enableTransformByUUID=(e,t)=>{if(!Ep.scene)return!1;this.disableAxesTransform();let i=this.defaultObjectTree.getItemByUUID(e);if(i&&"TileSetItem"===i.type||i&&"LineItem"===i.type)return void logger.debug("TRACE:core.enableTransformByUUID() objectItem.type is TileSetItem transformControls suppress checking");let n=Ep.scene.getObjectByProperty("uuid",e);return!!(n&&n instanceof Et)&&(t&&(Ep.TransformChangeCallback=t),Ep.transformControls.addEventListener("objectChange",this.transformControlChangeEvent),Ep.transformControls.attach(n),Ep.transformControls.mode||this.setTransformMode("translate"),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),!0)},this.enableLightTransform=(e,t)=>!(!Ep.scene||!Ep.lightStore)&&Ep.lightStore.transformDirectionalLight(e,t),this.setLightTransformMode=e=>!(!Ep.scene||!Ep.lightStore)&&Ep.lightStore.setTransformMode(e),this.disableLightTransform=()=>!(!Ep.scene||!Ep.lightStore)&&Ep.lightStore.disableTransformDirectionalLight(),this.getTransformMode=()=>Ep.scene&&Ep.transformControls?Ep.transformControls.getMode():"",this.setTransformMode=e=>{if(!Ep.scene||!Ep.transformControls||"string"!=typeof e)return!1;switch(e.toLowerCase()){case"translate":case"rotate":case"scale":return N||Ep.transformControls.setMode(e.toLowerCase()),!0}return!1},this.disableTransform=()=>{Ep.scene?N||(Ep.transformControls.removeEventListener("objectChange",this.transformControlChangeEvent),Ep.transformControls.detach(),window.removeEventListener("keydown",this._transformControlKeyDown),window.removeEventListener("keyup",this._transformControlKeyUp)):logger.debug("_context.scene 为空")},this.saveSceneCamera=()=>{B=JSON.parse(JSON.stringify(this.getCamera()))},this.onMapWorld=()=>{this.saveSceneCamera(),this.switchCameraMode(1),U=Ep.background.mode,this.setBackgroundMode("none"),Ep.orthoCameraControls.keyOperate="translation",Ep.orthoCameraControls.zoomAxis="y",Ep.transformControls.attach(Ep.scene.models),this.setTransformMode("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1,Ep.transformControls.showE=!1,H.rotation=JSON.parse(JSON.stringify(Ep.scene.models.rotation)),j&&Ep.scene.models.rotation.set(0,ge.degToRad(j),0),N=!0},this.offMapWorld=()=>{N&&(N=!1,this.switchCameraMode(0),U&&this.setBackgroundMode(U),U=null,"editor"===Ep.pointerMode?Ep.orthoCameraControls.keyOperate="paint":Ep.orthoCameraControls.keyOperate=null,Ep.orthoCameraControls.zoomAxis="y",this.disableTransform(),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!1,j=this.getSceneRotationY(),this.notState&&(this.notState.datumShiftModel=JSON.parse(JSON.stringify(this.getSettings().datumShiftModel))),Ep.scene.models.rotation.order=H.rotation._order,Ep.scene.models.rotation.x=H.rotation._x,Ep.scene.models.rotation.y=H.rotation._y,Ep.scene.models.rotation.z=H.rotation._z)},this.onXYZCalibrate=()=>{this.saveSceneCamera(),this.switchCameraMode(1),U=Ep.background.mode,Ep.orthoCameraControls.keyOperate="translation",Ep.transformControls.attach(Ep.scene.models),this.setTransformMode("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!1,H.rotation=JSON.parse(JSON.stringify(Ep.scene.models.rotation)),j&&Ep.scene.models.rotation.set(0,ge.degToRad(j),0),N=!0},this.offXYZCalibrate=()=>{N&&(N=!1,this.switchCameraMode(0),U=null,"editor"===Ep.pointerMode?Ep.orthoCameraControls.keyOperate="paint":Ep.orthoCameraControls.keyOperate=null,this.disableTransform(),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!1,j=this.getSceneRotationY(),this.notState&&(this.notState.datumShiftModel=JSON.parse(JSON.stringify(this.getSettings().datumShiftModel))),Ep.scene.models.rotation.order=H.rotation._order,Ep.scene.models.rotation.x=H.rotation._x,Ep.scene.models.rotation.y=H.rotation._y,Ep.scene.models.rotation.z=H.rotation._z)},this.onMapWorld1=()=>{Ep.scene.models&&!N&&(this.switchCameraMode(1),U=Ep.background.mode,this.setBackgroundMode("none"),this.leftButtonHandle("translation"),Ep.transformControls.attach(Ep.scene.models),window.addEventListener("keydown",this._transformControlKeyDown),window.addEventListener("keyup",this._transformControlKeyUp),this.setTransformMode("rotate"),Ep.transformControls.showX=!1,Ep.transformControls.showY=!1,Ep.transformControls.showZ=!1,Ep.transformControls.showE=!0,this.on("camerazoom","",(e=>{e.wheelDelta>0?(Ep.scene.models.scale.x+=.05,Ep.scene.models.scale.y+=.05,Ep.scene.models.scale.z+=.05):(Ep.scene.models.scale.x-=.05,Ep.scene.models.scale.y-=.05,Ep.scene.models.scale.z-=.05)})),H.position=JSON.parse(JSON.stringify(Ep.scene.models.position)),H.rotation=JSON.parse(JSON.stringify(Ep.scene.models.rotation)),H.scale=JSON.parse(JSON.stringify(Ep.scene.models.scale)),_isWorldMapModelTransform&&(Ep.scene.models.position.x=_isWorldMapModelTransform.position.x,Ep.scene.models.position.y=_isWorldMapModelTransform.position.y,Ep.scene.models.position.z=_isWorldMapModelTransform.position.z,Ep.scene.models.rotation.order=_isWorldMapModelTransform.rotation._order,Ep.scene.models.rotation.x=_isWorldMapModelTransform.rotation._x,Ep.scene.models.rotation.y=_isWorldMapModelTransform.rotation._y,Ep.scene.models.rotation.z=_isWorldMapModelTransform.rotation._z,Ep.scene.models.scale.x=_isWorldMapModelTransform.scale.x,Ep.scene.models.scale.y=_isWorldMapModelTransform.scale.y,Ep.scene.models.scale.z=_isWorldMapModelTransform.scale.z),N=!0)},this.offMapWorld1=()=>{N&&(N=!1,this.switchCameraMode(0),U&&this.setBackgroundMode(U),U=null,this.leftButtonHandle(null),this.disableTransform(),Ep.transformControls.showX=!0,Ep.transformControls.showY=!0,Ep.transformControls.showZ=!0,Ep.transformControls.showE=!1,this.off("camerazoom","",""),_isWorldMapModelTransform.position=JSON.parse(JSON.stringify(Ep.scene.models.position)),_isWorldMapModelTransform.rotation=JSON.parse(JSON.stringify(Ep.scene.models.rotation)),_isWorldMapModelTransform.scale=JSON.parse(JSON.stringify(Ep.scene.models.scale)),Ep.scene.models.position.x=H.position.x,Ep.scene.models.position.y=H.position.y,Ep.scene.models.position.z=H.position.z,Ep.scene.models.scale.x=H.scale.x,Ep.scene.models.scale.y=H.scale.y,Ep.scene.models.scale.z=H.scale.z)},this.getItemByName=e=>this.defaultObjectTree.getItemByName(e),this.findNodeByName=e=>this.defaultObjectTree.findNodeByName(e),this.addCubeCamera=(e,t,i)=>{let n=t.name;if(Ep.ssr.find((t=>t.nodeName===n&&t.modelName===e&&t.materialName===i)))return;let a=new Ki(256,{format:C,generateMipmaps:!0,minFilter:x}),r=new Ji(1,2e3,a),s=(new Re).setFromObject(Ep.scene.models.getObjectByProperty("uuid",t.uuid||t.id)),o=new Ce;s.getSize(o),r.position.y=o.y/2,r.name=_y.randomString(8),Ep.scene.models.getObjectByProperty("uuid",t.uuid||t.id).add(r),s=null,o=null,Ep.ssr.push({cubeRenderTarget:a,cubeCamera:r,nodeName:n,modelName:e,materialName:i})},this.materialsInModelItem=(e,t)=>{var i=!1;for(let n in e)n===t.material&&e[n]._modelName===t.modelName&&(i=!0);return i},this.ssrOn=(e,t)=>{var i=null,n=null;if(V){let t=this.defaultObjectTree.getItemByUUID(V);for(let n=0;n<t.children.length&&!(i=_y.findModelItemNodeByName(t.children[n],e));n++);}else if(t){let n=this.defaultObjectTree.getItemByName(t);for(let t=0;t<n.children.length&&!(i=_y.findModelItemNodeByName(n.children[t],e));t++);}else i=this.findNodeByName(e);if(!i)return;if(i.enableSSR=!0,!i.modelName&&!t)return;n=t?this.defaultObjectTree.findModelFromBuilding(void 0,t,"modelName"):this.defaultObjectTree.findModelFromBuilding(void 0,i.modelName,"modelName");let a=this.defaultObjectTree.children.find((e=>e.name===n.name));if(a){var r={};null!=a.getMaterials?r=a:a.children.forEach((e=>{"ModelItem"===e.type?this.materialsInModelItem(e.materialStore._materials,i)&&(r=e):"BuildingFloorItem"===e.type&&e.children.forEach((e=>{e.materialStore&&this.materialsInModelItem(e.materialStore._materials,i)&&(r=e)}))})),r.materialStore&&("string"==typeof i.material?r.materialStore._materials[i.material].enableSSR&&this.addCubeCamera(r.name,i,i.material):i.material instanceof Array&&i.material.map((e=>{r.materialStore._materials[e].enableSSR&&this.addCubeCamera(r.name,i,e)})))}},this.ssrOff=(e,t)=>{let i=null;if(V){let t=this.defaultObjectTree.getItemByUUID(V);for(let n=0;n<t.children.length&&(i=_y.findModelItemNodeByName(t.children[n],e),!i);n++);}else if(t){let n=this.defaultObjectTree.getItemByName(t);for(let t=0;t<n.children.length&&(i=_y.findModelItemNodeByName(n.children[t],e),!i);t++);}else i=this.findNodeByName(e);if(i){i.enableSSR=!1;for(let t=0;t<Ep.ssr.length;t++)Ep.ssr[t].nodeName===e&&Ep.ssr[t].modelName===i.modelName&&(this.findMaterialInModel(Ep.ssr[t].modelName,Ep.ssr[t].materialName)._material().envMap.dispose(),this.findMaterialInModel(Ep.ssr[t].modelName,Ep.ssr[t].materialName)._material().envMap=null,Ep.ssr.splice(t,1))}},this.snapOn=(e,t)=>{switch(e){case"translation":Ep.transformControls.translationSnap=t;break;case"rotation":Ep.transformControls.rotationSnap=t/180*Math.PI;break;case"scale":Ep.transformControls.scaleSnap=t}},this.snapOff=e=>{switch(e){case"translation":Ep.transformControls.translationSnap=null;break;case"rotation":Ep.transformControls.rotationSnap=null;break;case"scale":Ep.transformControls.scaleSnap=null}},this.fadeOut=(e,t,i)=>{if(Ep.renderer&&Ep.renderer.domElement&&t)var n=Ep.renderer.domElement.style.opacity||1,a=(e=e/100||10,setInterval((function(){n>0?Ep.renderer.domElement.style.opacity=n=parseFloat(n-.1).toFixed(2):(clearInterval(a),i&&i())}),e));else i&&i()},this.fadeIn=(e,t)=>{if(!Ep.renderer||!Ep.renderer.domElement)return;let i=Ep.renderer.domElement.style.opacity;if(""!==i&&1!==i)var n=Ep.renderer.domElement.style.opacity||0,a=(e=e/100||10,setInterval((function(){n<1?Ep.renderer.domElement.style.opacity=n=(parseFloat(n)+.1).toFixed(2):(clearInterval(a),t&&t())}),e));else t&&t()},this.clipNode=(e,t,i,n,a)=>{Ep.clippingController&&(Ep.clippingController.clear(),delete Ep.clippingController),Ep.clippingController=new uv({meshes:[Ep.scene.getObjectByName(e)],clippingPlanes:[{nx:t,ny:i,nz:n,d:a}]})},this.cutLevelToRoom=(e,t,i)=>this.cutLevel(e,t,null,!0,i),this.cutLevel=(e,t,i,n=!0,a,r,s)=>{var o=this.defaultObjectTree.getItemByUUID(e);if(o||(o=this.defaultObjectTree.getItemByName(e)),o){if(e=o.getGroup().uuid,"BuildingItem"==o.type){if(o.setCut(t,a)&&!s)return}if(t){const r=Ep.animationStore.findAnimation(o.name,"ExpandBuildingFloorController");r&&(r.duration=0,r.reset((()=>{Ep.animationStore.remove(r)}))),Ep.clippingStore.findCutBulidingByUUID(e)&&Ep.clippingStore.remove(e),o.floor=t,o.children.forEach((i=>{if(i.level===Number(t)){let t=(new Re).setFromObject(i.getGroup()),n=new Ce;t.getSize(n),Ep.clippingStore.add(e,0,-1,0,t.max.y<0?0:t.max.y+.02*n.y),a&&(o.room=a,i.children.forEach((e=>{e.name===a&&e.getGroup&&e.getGroup()&&this.highlightByUUID(e.getGroup().uuid)}))),this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{if("IconAsset"===e.type){(e.getGroup().position.y||e.transform.position.y)>t.max.y?e.clipping=!0:e.clipping=!1}}))}})),n&&(this.defaultObjectTree.getItemByUUID(e)?this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{e.level===t?e.show():e.level&&e.hide()})):this.defaultObjectTree.getItemByName(e).children.forEach((e=>{e.level===t?e.show():e.level&&e.hide()})));for(let t=0;t<W.length;t++)W[t].uuid===e&&(W.splice(t,1),t--);let s={uuid:e,level:t};W.push(s),i&&i(1,"建筑拆解完成")}else{const a=Ep.animationStore.findAnimation(o.name,"ExpandBuildingFloorController");if(a)return a.duration=r,void a.reset((()=>{Ep.animationStore.remove(a),i&&i(1,"建筑恢复完成")}));o.floor=t,Ep.clippingStore.findCutBulidingByUUID(e)&&Ep.clippingStore.remove(e),this.defaultObjectTree.getItemByUUID(e)?this.defaultObjectTree.getItemByUUID(e).children.forEach((t=>{if(t.level){n&&t.hide();let i=(new Re).setFromObject(t.getGroup()),a=new Ce;i.getSize(a),this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{if("IconAsset"===e.type){(e.getGroup().position.y||e.transform.position.y)>i.max.y&&(e.clipping=!1)}}))}})):n&&this.defaultObjectTree.getItemByName(e).children.forEach((e=>{e.level&&e.hide()}));for(let t=0;t<W.length;t++)W[t].uuid===e&&(W.splice(t,1),t--);i&&i(1,"建筑恢复完成")}}else i&&i(0,"建筑不存在")},this.expandLevel=(e,t,i,n)=>{let a=this.defaultObjectTree.getItemByUUID(e);if(a||(a=this.defaultObjectTree.getItemByName(e),e=a.getGroup().uuid),!a)return void(n&&n(0,"建筑不存在"));if(a.children.filter((e=>e.isBuildingFloorItem)).length<=0)return void(n&&n(0,"没有楼层"));Ep.animationStore.findAnimation(a.name,"ExpandBuildingFloorController")?n&&n(0,"楼层已经处于展开状态"):Ep.animationStore.add(new $v({name:a.name,building:a,padding:t,duration:i,callback:n}))},this.cutLevelByUUID=(e,t=!0)=>{let i=this.defaultObjectTree.getItemByUUID(e);if(i)if("BuildingItem"===i.type){if(!i.floor&&t)return void this.defaultObjectTree.getItemByUUID(e).children.forEach((e=>{e.level&&e.hide()}));this.cutLevel(e,i.floor,(()=>{}),t,i.room)}else Ep.instance.selectionControls.fromBuildingSelection&&Ep.instance.selectionControls.fromBuildingSelection.uuid!=e&&this.cutLevelByUUID(Ep.instance.selectionControls.fromBuildingSelection.uuid,t)},this.setPaintMode=function({mode:e="roam",category:t,size:i=1,assets:n=[],removeDensity:a=1,hasLayerDraw:r=!1},s,o,l,c){Ep.paintControls&&Ep.paintControls.setMode(e,t,i,n,a,r,s,o,l,c)},this.setPaintLayerName=function(e,t=!0,i,n){Ep.paintControls&&Ep.paintControls.setLayerName(e,t,i,n)},this.setPaintData=function(e){Ep.paintControls&&Ep.paintControls.setData(e)},this.setLayerPointClick=function(e){Ep.paintControls&&Ep.paintControls.setLayerPointClick(e)},this.getPaintPaths=function(){return Ep.paintControls?Ep.paintControls.getPaths():[]},this.deletePathPoint=function(e,t){Ep.paintControls&&Ep.paintControls.deletePathPoint(e,t)},this.loadPaintPath=function(e,t){Ep.paintControls&&Ep.paintControls.loadPaintPath(e,t)},this.leavePaintMode=function(e){Ep.paintControls&&Ep.paintControls.leavePaintMode(e)},this.setOrbitDamping=e=>{"number"==typeof e&&(0===e&&(Ep.orbitControls.enableDamping=!1),e>0&&(Ep.orbitControls.dampingFactor=e))},this.getIconAsset=(e,t)=>{if(e)return this.defaultObjectTree.getAsset(e,"IconAsset",t)},this.objectIsHidedByName=e=>{_pitchOnModelName=e;let t=this.defaultObjectTree.children;if(e)W.forEach((e=>{Ep.clippingStore.remove(e.name)})),G&&0===G.length&&(G=JSON.parse(JSON.stringify({children:_y.getSettingsRecursively(t)}))),t.map((e=>{switch(e.type){case"ModelItem":case"IconAsset":e.hide();break;case"BuildingItem":e.hide(),e.children.map((e=>{switch(e.type){case"ModelItem":e.hide();break;case"BuildingFloorItem":e.hide(),e.children.map((e=>{e.hide()}))}}))}})),t.map((t=>{if(t.name===e)switch(t.type){case"ModelItem":t.show();break;case"BuildingItem":t.show(),t.children.map((e=>{switch(e.type){case"ModelItem":e.show();break;case"BuildingFloorItem":e.show(),e.children.map((e=>{e.show()}))}}))}else"BuildingItem"===t.type&&t.children.map((i=>{if(i.name===e)switch(t.show(),i.type){case"ModelItem":i.show();break;case"BuildingFloorItem":i.show(),i.children.map((e=>{e.show()}))}else"BuildingFloorItem"===i.type&&i.children.map((n=>{n.name===e&&(t.show(),i.show(),n.show())}))}))}));else{W.forEach((e=>{this.defaultObjectTree.getItemByName(e.name).children.forEach((t=>{if(t.level===Number(e.level)){let i=(new Re).setFromObject(t.getGroup()),n=new Ce;i.getSize(n),Ep.clippingStore.add(e.name,0,-1,0,i.max.y+.02*n.y)}}))})),this.defaultObjectTree.children.map((e=>{G.children.map((t=>{e.name===t.name&&("ModelItem"===e.type||"IconAsset"===e.type?t.isVisible?e.show():e.hide():"BuildingItem"===e.type&&(t.isVisible?e.show():e.hide(),e.children.length>0&&e.children.map((e=>{t.children.map((t=>{e.name===t.name&&("ModelItem"===e.type||"IconAsset"===e.type?t.isVisible?e.show():e.hide():"BuildingFloorItem"===e.type&&(t.isVisible?e.show():e.hide(),e.children.length>0&&e.children.map((e=>{t.children.map((t=>{e.name===t.name&&(t.isVisible?e.show():e.hide())}))}))))}))}))))}))})),G=[]}},this.objectIsHidedByUUID=e=>{e&&!V&&(this.saveSceneCamera(),U=Ep.background.mode),V=e;let t=this.defaultObjectTree.children;if(e)W.forEach((e=>{Ep.clippingStore.remove(e.uuid)})),0===G.length&&(G=JSON.parse(JSON.stringify({children:_y.getSettingsRecursively(t)}))),_y.setObjectTreeIsHideRecursion(t),_y.setObjectTreeShowByUUID(t,e);else{W.forEach((e=>{var t=this.defaultObjectTree.getItemByUUID(e.uuid);t||(t=this.defaultObjectTree.getItemByName(e.uuid)),t&&t.children.forEach((t=>{if(t.level===Number(e.level)){let i=(new Re).setFromObject(t.getGroup()),n=new Ce;i.getSize(n),Ep.clippingStore.add(e.uuid,0,-1,0,i.max.y+.02*n.y)}}))}));let e=this.defaultObjectTree.children;_y.recoverIsShowOrHide(G.children,e),G=[]}},this.hideAll=()=>{let e=this.defaultObjectTree.children;0===G.length&&(G=JSON.parse(JSON.stringify({children:_y.getSettingsRecursively(e)}))),_y.setObjectTreeIsHideRecursion(e)},this.crossfadeFreeze=()=>{!Ep.crossfade&&Ep.renderer&&(Ep.markDom||(Ep.crossfade=!0,K(),Ep.crossfadeImageElement=document.createElement("img"),Ep.crossfadeImageElement.style.position="absolute",Ep.crossfadeImageElement.style.height=Ep.renderer.domElement.clientHeight+"px",Ep.crossfadeImageElement.style.width=Ep.renderer.domElement.clientWidth+"px",Ep.crossfadeImageElement.style.left=Ep.renderer.domElement.clientLeft+"px",Ep.crossfadeImageElement.style.top=Ep.renderer.domElement.clientTop+"px",Ep.crossfadeImageElement.style.pointerEvents="none",Ep.crossfadeImageElement.src=Ep.renderer.domElement.toDataURL(),Ep.renderer.domElement.parentElement.appendChild(Ep.crossfadeImageElement)))},this.crossfade=e=>{let t=this;if(!Ep.crossfade||Ep.onCrossfade)return;Ep.onCrossfade=!0;var i=.9;let n;e=e/60||10;let a=(new Date).getTime();function r(){Ep.crossfadeImageElement&&(n=((new Date).getTime()-a)/(e/10),(new Date).getTime()-a>100&&(n=100/(e/10)),a=(new Date).getTime(),i>0?(Ep.crossfadeImageElement.style.opacity=i-=.001*n,t.nextRender((()=>{r()}))):(Ep.crossfadeImageElement.parentElement.removeChild(Ep.crossfadeImageElement),Ep.crossfadeImageElement=null,Ep.crossfade=!1,Ep.onCrossfade=!1))}this.nextRender((()=>{r()}))},this.saveCamera=e=>{void 0!==e&&(e?(Y=this.getCamera(),Ep.instance._notView=JSON.parse(JSON.stringify(this.defaultView.getSettings()))):Y&&(Y.target={x:Y.targetX,y:Y.targetY,z:Y.targetZ},Y.distance=Y.viewDistance,Y.duration=1.5,Y.far=this.getCamera().far,Y.fov=this.getCamera().fov,Y.near=this.getCamera().near,Y.duration=1.5,this.setCamera(Y)))},this.getSceneRotationY=()=>{var e=new Ce(0,0,1);return Ep.scene.models.quaternion.setFromEuler(Ep.scene.models.rotation),e.applyQuaternion(Ep.scene.models.quaternion),(ge.radToDeg(Math.atan2(-e.x,-e.z))+180+180)%360-180},this.setFPSLimit=e=>{"number"!=typeof e||e<1||e>240||isNaN(e)||(Ep.fpsLimit=e,Ep.frameTimeLimit=1/e,Ep.frameTimeGap=0)},this.getSettings=e=>{let t={};return e&&(this.isSave=e,""!=this.getCurrentState())?(this.notState?(this.notState.states=Ep.stateStore.getSettings(),this.notState.texture0=Ep.textureStore.getSettings(),t=this.notState):t=this.getSettings(),t.minMode=Ep.instance.minMode,t):(t.minMode=Ep.instance.minMode,Ep&&Ep.cacheStore&&Ep.instance?(t.cache=Ep.cacheStore.getSettings(),this.isSave&&(t.texture0=Ep.textureStore.getSettings()),t.texture=Ep.customTextureStore.getSettings(),t.objectTree=this.defaultObjectTree.getSettings(),G.children&&G.children.length>0&&_y.recoverShowGetSettings(G.children,t.objectTree.children),t.states=Ep.stateStore.getSettings(),t.effects={visualEffect:this.defaultEffectStore.visualEffect.getSettings(),spaceEffect:this.defaultEffectStore.spaceEffect.getSettings()},t.background={mode:Ep.background.mode,colorCSSValue:Ep.background.colorCSSValue,textureURL:Ep.background.textureURL,cubeTextureRotationY:Ep.background.cubeTextureRotationY||0,cubeTextureBlur:Ep.background.cubeTextureBlur,isCustomSkybox:Ep.background.isCustomSkybox,cubeTextureIntensity:Ep.background.cubeTextureIntensity,environmentLuminosity:Ep.background.environmentLuminosity},t.lights=Ep.lightStore.getSettings(),t.lights.skybox=I,t.lights.skyboxPath=P,t.datumShiftModel=Ep.datumShiftModel,t.view=this.defaultView.getSettings(),N&&(V?(t.view.camera.azimuth=B.azimuthAngle,t.view.camera.inclination=B.inclinationAngle,t.view.camera.distance=B.viewDistance,t.view.camera.targetX=B.targetX,t.view.camera.targetY=B.targetY,t.view.camera.targetZ=B.targetZ,t.view.camera.inclinationAngleMin=B.inclinationAngleMin,t.view.camera.inclinationAngleMax=B.inclinationAngleMax):(t.view.camera.viewDistanceMin=B.near,t.view.camera.viewDistanceMax=B.far,t.view.camera.fov=B.fov),U&&(t.background.mode=U)),t.sceneModelTransform={},N&&(t.sceneModelTransform.position=Ep.scene.models.position,t.sceneModelTransform.rotation=Ep.scene.models.rotation,t.sceneModelTransform.scale=Ep.scene.models.scale),t.mapWorldRotationY=!N&&j?j:this.getSceneRotationY(),Ep.effectStore.visualEffect._passes.outlinePass.effects[0].time=0,t.sceneName=Ep.sceneName,t.colorSpace=this.getColorSpace(),t.fpsLimit=Ep.fpsLimit,this.isSave=!1,t):(t.objectTree={children:[]},t))},this.getPackSettings=async(e,t,i)=>(e||(e=this.getSettings(t)),new Promise((t=>{_y.getPackSettings(e,i).then((e=>t(e)))}))),this.getPreloadResource=()=>Ep.cacheStore.preloadResourceStore,this.getSettingsToJSON=e=>JSON.stringify(this.getSettings(),0,e?2:0),this.highlightMaterial=(e,t)=>{if(!Ep.scene)return void logger.debug("_context.scene 为空");Ep.highlight||(Ep.highlight={material:void 0}),e||t||Ep.highlight.material&&Ep.highlight.material._material()instanceof Vt&&(delete Ep.highlight.material._material().onBeforeCompile,Ep.highlight.material._material().needsUpdate=!0,Ep.highlight.material=void 0);let i=this.defaultObjectTree.findItemByName(e);if(!i)return;let n=i.findMaterial(t);n&&n._material()instanceof Vt&&Ep.highlight.material!==n&&(Ep.highlight.material&&Ep.highlight.material._material()instanceof Vt&&(delete Ep.highlight.material._material().onBeforeCompile,Ep.highlight.material._material().needsUpdate=!0,Ep.highlight.material=void 0),Ep.highlight.material=n,n._material().onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("void main() {",["varying vec2 vUvHighlight;","void main() {","  vUvHighlight = uv;"].join("\n")),e.fragmentShader=e.fragmentShader.replace("void main() {",["varying vec2 vUvHighlight;","void main() {"].join("\n")),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",["#ifdef USE_MAP","  vec4 texelColor = mapTexelToLinear( texture2D( map, vUv ) );","\t diffuseColor = texelColor * diffuseColor;","#endif","float fracX = fract(vUvHighlight.x * 10.0);","float fracY = fract(vUvHighlight.y * 10.0);","if (abs(fracX - 0.5) <= 0.1 && abs(fracY - 0.5) <= 0.1) {","  diffuseColor = mix(diffuseColor, vec4(1.0, 0.15, 0.75, 1.0), 0.9);","}"].join("\n"))},n._material().needsUpdate=!0)},this.highlightModel=(e,t,i)=>{if(!Ep.scene)return void logger.debug("_context.scene 为空");if(!e)return Ep.effectStore.highlightObject(void 0),!1;if(void 0!==i){if("BuildingItem"===i.type){const e=this.defaultObjectTree.getItemByName(i.name);Ep.effectStore.highlightObject(e.getGroup(),!0)}if("BuildingFloorItem"===i.type){const e=this.defaultObjectTree.getItemByName(i.buildingName);for(const t of e.children)if("BuildingFloorItem"===t.type&&t.name==i.name){Ep.effectStore.highlightObject(t.getGroup(),!0);break}}if("BuildingRoomItem"===i.type){const e=this.defaultObjectTree.getItemByName(i.buildingName);for(const t of e.children)if("BuildingFloorItem"===t.type&&t.name==i.floorName){for(const e of t.children)if("BuildingRoomItem"===e.type&&e.name===i.name){Ep.effectStore.highlightObject(e.getGroup(),!0);break}break}}if("node"===i.type){const e=this.defaultObjectTree.getItemByName(i.modelName);if(e){const t=_y.findModelItemNodeByName(e,i.nodeName);if(t){const e=t.getNodeMesh||t.getGroup;Ep.effectStore.highlightObject(e(),!0)}}}if("layer"===i.type){const e=this.defaultObjectTree.getItemByName(i.layerName);if(e){const t=e.children.find((e=>e.name===i.itemName));t instanceof $_?Ep.effectStore.highlightObject(t.getGroup(),!0):t instanceof _b&&t.highlightInstance(!0)}}return}const n=this.defaultObjectTree.getItemByName(e);if(!n)return;if(n.isIconModel){const e=Ep.defaultObjectTree.getItemByName(n.name+"-IconAssect");e&&e.highlight()}let a=this.defaultObjectTree.getItemByName(e).getGroup();if(a&&a instanceof Et){if("GroupItem"===a.type)a.getGroup().children.map((e=>{"Mesh"===e.type&&Ep.effectStore.highlightObject(e,!0)}));else Ep.effectStore.highlightObject(a,t);return!0}return Ep.effectStore.highlightObject(void 0),!1},this.highlightInstancedHelper=(e,t,i)=>{e&&i||Ep.effectStore.cancelLayerHelper(),t&&(t.visible=!0)},this.highlightByUUID=(e,t)=>{let i=this.defaultObjectTree.getItemByUUID(e),n=null;if(X instanceof Array?(n=[],X.forEach((e=>{let t=this.defaultObjectTree.getItemByUUID(e);t&&n.push(t)}))):X&&(n=this.defaultObjectTree.getItemByUUID(X)),n&&n!==[]||(X=null),!Ep.scene)return void logger.debug("_context.scene 为空");if(Ep.defaultObjectTree.children.forEach((e=>{"LineItem"==e.type&&e.cancleHighlight()})),Ep.effectStore.highlightObject(void 0),!e)return n instanceof Array?n.forEach((e=>{e&&(e instanceof _b?e.disableHighlight():"PaperCutItem"===e.type?e.getGroup().children[0].children[0].material.uniforms&&(e.getGroup().children[0].children[0].material.uniforms.outline.value=0):e.getGroup().children[0].material.uniforms.outline.value=0)})):n&&(n instanceof _b?n.disableHighlight():"PaperCutItem"===n.type?n.getGroup().children[0].children[0].material.uniforms&&(n.getGroup().children[0].children[0].material.uniforms.outline.value=0):n.getGroup().children[0].material.uniforms.outline.value=0),X=null,!1;if(X){if(X==e)return;n instanceof Array?n.forEach((e=>{e&&(e instanceof _b?e.disableHighlight():"PaperCutItem"===e.type?e.getGroup().children[0].children[0].material.uniforms&&(e.getGroup().children[0].children[0].material.uniforms.outline.value=0):e.getGroup().children[0].material.uniforms.outline.value=0)})):n&&(n instanceof _b?n.disableHighlight():"PaperCutItem"===n.type?n.getGroup().children[0].children[0].material.uniforms&&(n.getGroup().children[0].children[0].material.uniforms.outline.value=0):n.getGroup().children[0].material.uniforms.outline.value=0),X=null}if(!i)return;if("IconAsset"===i.type)return X=e,i instanceof _b?i.highlightInstance():i.getGroup().children[0].material.uniforms.outline.value=1,void Ep.effectStore.highlightObject(void 0);"GroupItem"===i.type||"PaintItem"===i.type?Ep.effectStore.highlightObject(void 0):"LineItem"===i.type?i.highlight():"PackedItem"===i.type&&Ep.effectStore.highlightObject(void 0);let a=null;return a=Ep.scene.models.getObjectByProperty("uuid",e),!!a&&(a instanceof Et&&(X=[],a.traverse((e=>{"IconGroup"===e.type&&X.push(e.uuid),"PaperCutGroup"===e.type&&e.children[0].children[0].material.uniforms&&X.push(e.uuid)})),X.length>0?(X.forEach((e=>{a.traverse((t=>{t.uuid===e&&("InstancedGroup"==t.parent.type?t.parent.userData.instancedGroup&&t.parent.userData.instancedGroup.highlight(t.name,!0):"PaperCutGroup"===t.type?t.children[0].children[0].material.uniforms&&(t.children[0].children[0].material.uniforms.outline.value=1):t.children[0].material.uniforms.outline.value=1)}))})),Ep.effectStore.highlightObject(a)):Ep.effectStore.highlightObject(a)),!0)},this.highlightSpaceEffect=e=>{if(!Ep.scene||!this.defaultEffectStore||!this.defaultEffectStore.spaceEffect)return;let t=this.defaultEffectStore.spaceEffect.findEffect(e);t?t.showHelper():this.defaultEffectStore.spaceEffect.hideHelpers()},this.highlightDirectionalLightHelper=(e,t)=>{if(!Ep.scene)return void logger.debug("_context.scene 为空");let i=Ep.lightStore.findDirectionalLightHelper(e);if(i){t||Ep.effectStore.highlightObject(void 0);for(let e of i.children)Ep.effectStore.highlightObject(e,t);return!0}return Ep.effectStore.highlightObject(void 0),!1},this.takeSnapshot2=e=>Ep.effectStore.takeSnapshot2(e),this.takeSnapshot=e=>Ep.effectStore.takeSnapshot(e),this.screenshotAuxiliaryLineSwitch=e=>{if(e){this.lineDom&&(this.container.removeChild(this.lineDom),this.lineDom=null);let e,t,i,n=16,a=9,r=this.container.clientWidth,s=this.container.clientHeight,o=r/s>n/a?"height":"width";"height"===o?(e=s/9*16,t=s,i=t):"width"===o&&(e=r,t=r/16*9,i=t),this.lineDom=document.createElement("div"),this.lineDom.style=`width: ${e}px;\n                              height: ${t}px;\n                              border: 1px solid rgb(191,64,16);\n                              position: absolute;\n                              top: ${(s-t)/2}px;\n                              left: ${(r-e)/2}px;\n                              pointer-events:none;\n                              z-index: 10;\n                              box-sizing:border-box;\n                              display:flex;\n                              align-items:center;\n                              justify-content: center;`;let l=document.createElement("div");l.style=`width: 0;\n                        height: ${t}px;\n                        border-right: 1px dashed #ffffff;\n                        position:absolute;\n                        left: ${e/2}px`;let c=document.createElement("div");c.style=`width: ${e}px;\n                        height: 0;\n                        border-bottom: 1px dashed #ffffff;\n                        position:absolute;\n                        tio: ${t/2}px`;let h=document.createElement("div");h.style=`width: ${i}px;\n                          height: ${i}px;\n                          box-sizing:border-box;\n                          border:1px solid rgb(243,244,76)`,this.lineDom.append(l),this.lineDom.append(c),this.lineDom.append(h),this.container.append(this.lineDom)}else this.lineDom&&(this.container.removeChild(this.lineDom),this.lineDom=null)},this.screenshots=(e=20,t=.7)=>{let i,n,a=this.container.clientWidth,r=this.container.clientHeight,s=a/r>16/9?"height":"width";"height"===s?(i=r/9*16,n=r):"width"===s&&(i=a,n=a/16*9);let o=new Image,l=document.createElement("canvas");l.width=16*e,l.height=9*e;let c=l.getContext("2d");Ep.composer.render();let h=Ep.renderer.domElement.toDataURL("image/jpeg",.65);return o.src=h,new Promise((e=>{o.onload=()=>{c.drawImage(o,(a-i)/2,(r-n)/2,i,n,0,0,l.width,l.height);let s=l.toDataURL("image/jpeg",t);e(s)}}))},this.getStatistics=()=>Ep.renderer?Ep.rendererInfo:{geometries:0,textures:0,calls:0,faces:0,vertices:0},this._debug=()=>(window.$r=eu,window.isDebug=!0,window.logger={debug:console.debug.bind(window.console),info:console.info.bind(window.console),warn:console.warn.bind(window.console),error:console.error.bind(window.console),dir:console.dir.bind(window.console),time:console.time.bind(window.console),timeEnd:console.timeEnd.bind(window.console)},{context:Ep}),this._setInstancedObject=e=>{Ep.instancedObject=new X_(e)},this.getInstancingProfile=()=>{let e={};Ep.scene.models.traverse((t=>{if(!(t instanceof Qr))return;let i=`${t.parent.name} - ${t.name}`;"number"==typeof e[i]?e[i]++:e[i]=t.count}));let t=0,i=0;for(let n in e)i+=e[n],t++,logger.debug(`${n} 中的实例计数：${e[n]}`);logger.debug("实例网格（InstancedMesh）计数：",t),logger.debug("一个实例网格（InstancedMesh）中的实例（instance）平均数：",i/t)},this.previewMaterial=(e,t,i,n)=>{this.previewMaterialInstance&&(this.previewMaterialInstance.dispose(),this.previewMaterialInstance=null);let a=new Bx(e,t,i,n);this.previewMaterialInstance=a},this.updatePreviewMaterial=(e,t,i)=>{this.previewMaterialInstance?this.previewMaterialInstance.update(e,t,i):logger.debug("previewMaterialInstance 不存在，无法update")},this.offPreviewMaterial=()=>{this.previewMaterialInstance&&(this.previewMaterialInstance.dispose(),this.previewMaterialInstance=null)},this.setPreviewMaterialTransformMode=e=>{this.previewMaterialInstance&&this.previewMaterialInstance.showGeometry(e)},this.setPreviewMaterialResolution=(e,t)=>{this.previewMaterialInstance&&this.previewMaterialInstance.setResolution(e,t)},this.previewParticle=(e,t,i,n)=>{this.previewParticleInstance&&(this.previewParticleInstance.dispose(),this.previewParticleInstance=null);let a=new jx(e,t,i,n);this.previewParticleInstance=a},this.updatePreviewParticle=(e,t,i)=>{this.previewParticleInstance?this.previewParticleInstance.update(e,t,i):logger.debug("previewParticleInstance 不存在，无法update")},this.offPreviewParticle=()=>{this.previewParticleInstance&&(this.previewParticleInstance.dispose(),this.previewParticleInstance=null)},this.setPreviewParticleResolution=(e,t)=>{this.previewParticleInstance&&this.previewParticleInstance.setResolution(e,t)},this.updateDrawableRenderOrder=(t,i)=>{if("string"!=typeof t)return!1;if("number"!=typeof i||i<0)return!1;if(t.includes("/iconmodellandmark")||t.includes("/iconmodeltrail")){const e=this.defaultObjectTree.getItemByName(t);if(e){e.getGroup().renderOrder=Fy+i;return this.defaultObjectTree.getItemByName(e.name+"-IconAssect").getGroup().renderOrder=Fy+i,!0}return!1}let n=e.find(t);return!!n&&(n.renderOrder>=Fy&&(n.renderOrder=Fy+i,!0))},this.clampToModel=(e,t=!0)=>{if(!e)return void console.warn("clampToModel 接口参数无效。");if("number"!=typeof e.x||"number"!=typeof e.y||"number"!=typeof e.z)return void console.warn("clampToModel 接口参数无效。");E.set(new Ce(e.x,e.y,e.z),new Ce(0,-1,0));const i=Ep.scene.models.children.filter((e=>"IconGroup"!==e.type));let n=E.intersectObjects(i,!0);if(0===n.length)return e;let a=-1;if(t){for(let e=0;e<n.length;e++)if(n[e].object.visible){a=e;break}if(-1===a)return e}else a=0;let r=n[a].point.clone();return{x:r.x,y:r.y,z:r.z}},this._debugClamp=(e=10,t=10,i=1,n=10)=>{for(let a=-Math.floor(e/2);a<e-Math.floor(e/2);a++)for(let e=-Math.floor(t/2);e<t-Math.floor(t/2);e++){let t={x:a*i,y:n,z:e*i},r=this.clampToModel(t),s={path:"./resource/icons/universal/icon_01.png",sizeAttenuation:!1,pos:t,width:30,height:30,enableAutoHidebyDistance:!1,pointMinDistance:10,pointMaxDistance:1e4,offsetV:.5,offsetH:.5,polygonOffset:!1,polygonOffsetFactor:.1,polygonOffsetUnits:1,isShow:!0,background:"icon_square",backgroundColor:"#0000ff"};this.addBillboard(`landmark-${a}-${e}`,s,void 0);let o={path:"./resource/icons/universal/icon_01.png",sizeAttenuation:!1,pos:r,width:60,height:60,enableAutoHidebyDistance:!1,pointMinDistance:10,pointMaxDistance:1e4,offsetV:.5,offsetH:.5,polygonOffset:!1,polygonOffsetFactor:.1,polygonOffsetUnits:1,isShow:!0,background:"icon_square",backgroundColor:"#ff0000"};this.addBillboard(`landmark2-${a}-${e}`,o,void 0)}},this.getWorldScale=()=>Ep.worldScale,this.setSceneEffect=e=>{if(void 0!==e.lightPower&&(Ep.drawableEmissiveIntensity=e.lightPower),void 0!==e.clickColor){Ep.drawableClickColor=e.clickColor,Ep.scene.traverse((t=>{t.material&&t.material.isMeshLineMaterial&&t.material.outlineColor&&t.material.outlineColor.setStyle(e.clickColor)}));const t=Ep.effectStore.visualEffect._passes.outlinePass.outlineEffect;t.uniforms.get("visibleEdgeColor").value.setStyle(e.clickColor),t.uniforms.get("hiddenEdgeColor").value.setStyle(e.clickColor);const i=Ep.effectStore.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect;i.uniforms.get("visibleEdgeColor").value.setStyle(e.clickColor),i.uniforms.get("hiddenEdgeColor").value.setStyle(e.clickColor)}if(void 0!==e.clickEdgeWidth){const t=Ep.effectStore.visualEffect._passes.outlinePass.outlineEffect;t.edgeStrength=32+1e3*Math.pow(e.clickEdgeWidth,2),t.kernelSize=e.clickEdgeWidth-1;const i=Ep.effectStore.visualEffect._passes.articulationOutlinePass.articulationOutlineEffect;i.edgeStrength=32+1e3*Math.pow(e.clickEdgeWidth,2),i.kernelSize=e.clickEdgeWidth-1}void 0!==e.isLayerTopMost&&(Ep.drawableDepthTest=!e.isLayerTopMost,Ep.objectStore.forEach((e=>{const t=Ep.animationStore.findDrawableAnimation(e,fv.type);t?Ep.drawableDepthTest?t.resume():(t.pause(),t.reset()):e.traverse((e=>{if(void 0!==e.material)if(Array.isArray(e.material))for(const t of e.material)t.depthWrite=Ep.drawableDepthTest,t.depthTest=Ep.drawableDepthTest,void 0!==t.userData.defaultEmissiveIntensity?t.emissiveIntensity=t.userData.defaultEmissiveIntensity*Ep.drawableEmissiveIntensity:t.emissiveIntensity=Ep.drawableEmissiveIntensity;else e.material.depthWrite=Ep.drawableDepthTest,e.material.depthTest=Ep.drawableDepthTest,void 0!==e.material.userData.defaultEmissiveIntensity?e.material.emissiveIntensity=e.material.userData.defaultEmissiveIntensity*Ep.drawableEmissiveIntensity:e.material.emissiveIntensity=Ep.drawableEmissiveIntensity}))})),Ep.scene.instancedIconModelLandmark.traverse((function(e){if(void 0!==e.material)if(Array.isArray(e.material))for(const t of e.material)t.depthWrite=Ep.drawableDepthTest,t.depthTest=Ep.drawableDepthTest;else e.material.depthWrite=Ep.drawableDepthTest,e.material.depthTest=Ep.drawableDepthTest})))},this.add3DTileSet=(e,t)=>{if(Ry.customTransformEnabled=!0,!Ry.customTransformOrigin){const e=this.getDatumShiftModel();if(e&&e.type)switch(e.type.toLowerCase()){case"surface":Ry.customTransformOrigin={lon:e.lon,lat:e.lat,alt:e.alt};break;case"mercator":Ry.customTransformOrigin={lon:e.origin[0],lat:e.origin[1],alt:-e.alt}}}let i=Ep.scene.getObjectByName("__tilesGroup");i||(i=new sr,i.name="__tilesGroup",i.rotateX(Math.PI/-2),Ep._tilesGroup=i,Ep.scene.add(i)),this._tilesRenderers instanceof Map||(this._tilesRenderers=new Map),new bx(e,t)},this.remove3DTileSet=(e="")=>{if(!(this._tilesRenderers instanceof Map)||0===this._tilesRenderers.size)return;if(""===(e=e.url||e))return;if(!(this._tilesRenderers instanceof Map)||0===this._tilesRenderers.size)return;const t=fy(e);let i=[];this._tilesRenderers.forEach(((e,n)=>{if(e.urlHash===t){e.dispose(),_y.disposeThreeObject(e.group),e.group.parent.remove(e.group);let t=Ep.scene.getObjectByName(e.urlHash);t&&(_y.disposeThreeObject(t),t.parent.remove(t)),Ep.instance.defaultObjectTree.getItemByName(params.name)&&Ep.instance.defaultObjectTree.remove(params.name),i.push(n)}})),i.forEach((e=>{this._tilesRenderers.has(e)&&this._tilesRenderers.delete(e)})),0===this._tilesRenderers.size&&this.clear3DTileSets()},this.remove3DTileByID=(e="",t)=>{if(""===e)return void(t&&t({result:0,message:"id不能为空"}));if(!(this._tilesRenderers instanceof Map)||0===this._tilesRenderers.size)return void(t&&t({result:0,message:`id为 ${e} 的 3DTiles 不存在!`}));let i=[];this._tilesRenderers.forEach(((t,n)=>{if(t.group.layerId===e){let e=t.group.name;t.dispose(),_y.disposeThreeObject(t.group),t.group.parent.remove(t.group);let a=Ep.scene.getObjectByName(t.urlHash);a&&(_y.disposeThreeObject(a),a.parent.remove(a)),Ep.instance.defaultObjectTree.getItemByName(e)&&Ep.instance.defaultObjectTree.remove(e),i.push(n)}})),i.length<=0?t&&t({result:0,message:`id为 ${e} 的 3DTiles 不存在!`}):(i.forEach((e=>{this._tilesRenderers.has(e)&&this._tilesRenderers.delete(e)})),0===this._tilesRenderers.size&&this.clear3DTileSets(),t&&t({result:1,message:"成功!"}))},this.clear3DTileSets=()=>{this._tilesRenderers instanceof Map&&(this._tilesRenderers.forEach(((e,t)=>{let i=e.group.name;e.dispose(),_y.disposeThreeObject(e.group),e.group.parent.remove(e.group);let n=Ep.scene.getObjectByName(e.urlHash);n&&(_y.disposeThreeObject(n),n.parent.remove(n)),Ep.instance.defaultObjectTree.getItemByName(i)&&Ep.instance.defaultObjectTree.remove(i)})),this._tilesRenderers=void 0),this._tilesNeedRerender=!1,Ry.customTransformOrigin&&(Ry.customTransformOrigin=void 0);let e=Ep.scene.getObjectByName("__tilesGroup");e&&(_y.disposeThreeObject(e),Ep.scene.remove(e))},this.update3DTileStyle=({id:e,visible:t,alpha:i},n)=>{if(!(this._tilesRenderers instanceof Map)||0===this._tilesRenderers.size)return;if(""===e)return void(n&&n({result:0,message:"id不能为空"}));if(!(this._tilesRenderers instanceof Map)||0===this._tilesRenderers.size)return;let a=[];this._tilesRenderers.forEach(((i,n)=>{i.group.layerId===e&&(i.group.visible=null==t||t,a.push(e))})),a.length<=0?n&&n({result:0,message:`id为 ${e} 的 3DTiles 不存在!`}):n&&n({result:1,message:"成功!"})},this.setCameraTo3DTile=(e,t=0,i={},n=!1,a=!1)=>{let r=null;if(this._tilesRenderers&&this._tilesRenderers.forEach((t=>{if(t.group.layerId===e&&t.tileSets[t.rootURL]&&t.tileSets[t.rootURL].root&&t.tileSets[t.rootURL].root.boundingVolume&&t.tileSets[t.rootURL].root.boundingVolume.box){let e=t.tileSets[t.rootURL].root.boundingVolume.box,i=new Ce(e[0],e[2],-e[1]),n=new Ce(t.offset.x,t.offset.y,t.offset.z),a=new Ce(e[3],e[11],e[7]),s=new Ce(t.absolutePosition.x,t.absolutePosition.y,t.absolutePosition.z),o=s.clone().add(a).add(i).add(n),l=s.clone().sub(a).add(i).add(n);r=new Re(l,o)}})),!r)return;let s=new Ce;r.getSize(s),k.x=(r.max.x+r.min.x)/2,k.y=(r.max.y+r.min.y)/2,k.z=(r.max.z+r.min.z)/2;let o=3*s.distanceTo(r.max.sub(r.min).divideScalar(2));(isNaN(o)||o===1/0||o===-1/0)&&(o=100),o<=this.getCamera().near&&(o+=this.getCamera().near),r=null,s=null,this.nextRender((()=>{this.cameraFlyTo(k,_y.numberOrDefault(i.azimuthAngle,45),_y.numberOrDefault(i.inclinationAngle,-45),_y.numberOrDefault(i.distance,o)*Ep.worldScale,_y.numberOrDefault(t,0),!0,(()=>{this.focus()})),k=new Ce}),1)},this.testTerrainUniform=()=>{Ep.gisStore.setFog("#6298b7")},this.initTerrain=(e,t)=>{0!==Ep.gisStore.terrainState&&Ep.gisStore&&Ep.gisStore.disposeTerrain(),Ep.gisStore&&Ep.gisStore.initTerrain(e,t)},this.destroyTerrain=()=>{Ep.gisStore&&Ep.gisStore.disposeTerrain()},this.updateTerrain=(e,t)=>{Ep.gisStore&&Ep.gisStore.updateStyle(e,t)},this.addTerrain=(e,t)=>{new Cx(e,t)},this.testGeoJSON=e=>{Ep.gisStore&&Ep.gisStore.testGeoJSON(e)},this.getThree=()=>eu,this.changeScene=({name:i,savePrevious:n=!1},a,r)=>{let s=Ep.sceneStore.findScene(i);if(!s)return void(a&&a({result:0,message:`失败，${i}服务不存在!`}));if(!0===this.changingScene)return void(a&&a({result:0,message:"失败，正在切换场景中。"}));if(this.changingScene=!0,Ep.instance.setMarkFreeze(),!0===n)Ep.sceneStore.createCache(),Ep.scene=null,Ep.objectStore=null;else{Ep.sceneStore.destroyCache();const e=Ep.sceneStore.scenes[Ep.sceneStore.currentName];if(e.cacheKeys){for(const t of e.cacheKeys)Ep.cacheStore.destroyCache(t);delete e.cacheKeys}}const o=Ep.sceneStore.scenes[i].token;o&&o.length>64&&this.setAvwToken("header","authorization:bearer",o),Ep.sceneStore.currentName=i,Ep.scene&&Ep.scene.children.forEach((e=>{_y.disposeThreeObject(e)})),s.cache?(Ep.scene=s.cache.scene,Ep.scene.models.children.forEach((e=>{e instanceof sr?e.children.forEach((e=>{_y.disposeThreeObject(e)})):_y.disposeThreeObject(e)})),Ep.scene.models.clear(),Ep.objectStore&&Ep.objectStore.dispose&&Ep.objectStore.dispose(),e=s.cache.objectStore,Ep.objectStore=s.cache.objectStore,this.objectStore=s.cache.objectStore):(Ep.pgl={},Ep.scene=new mr,Ep.scene.name="__avwCore_"+i,Ep.scene.models=new sr,Ep.scene.models.name="__models",Ep.scene.add(Ep.scene.models),Ep.scene.sysObjects=new sr,Ep.scene.sysObjects.name="__sysObjects",Ep.scene.sysObjects.renderOrder=1/0,Ep.scene.add(Ep.scene.sysObjects),Ep.scene.noneModels=new sr,Ep.scene.noneModels.name="__noneModels",Ep.scene.add(Ep.scene.noneModels),Ep.scene.axesHelper=new Sh(50),Ep.scene.axesHelper.name="__axesHelper",Ep.scene.axesHelper.visible=!1,Ep.scene.add(Ep.scene.axesHelper),Ep.alpha||(Ep.scene.background=new Qt(0)),Ep.scene.setNodeRotation=Ep.instance.setNodeRotation,Ep.scene.setNodeRotating=Ep.instance.setNodeRotating,Ep.scene.setNodeScaling=Ep.instance.setNodeScaling,Ep.scene.setNodeBreathing=Ep.instance.setNodeBreathing,Ep.objectStore&&Ep.objectStore.dispose&&Ep.objectStore.dispose(),e=new oE(Ep.scene),Ep.objectStore=e,this.objectStore=e),Ep.effectStore.changeScene(Ep.scene),Ep.background.cubeTexture&&Ep.background.cubeTexture instanceof Qi&&Ep.background.cubeTexture.dispose(),Ep.modelStore.dispose&&Ep.modelStore.dispose(),Ep.modelStore=null,Ep.modelStore=new sE(Ep.scene),Ep.sysObjectStore.dispose&&Ep.sysObjectStore.dispose(),Ep.sysObjectStore=null,Ep.sysObjectStore=new cE(Ep.scene),Ep.textureStore.dispose&&Ep.textureStore.dispose(),Ep.textureStore=null,Ep.textureStore=new hE("textureStore"),Ep.customTextureStore.dispose&&Ep.customTextureStore.dispose(),Ep.customTextureStore=null,Ep.customTextureStore=new hE("customTextureStore"),this.customTextureStore=Ep.customTextureStore,Ep.materialStore.dispose&&Ep.materialStore.dispose(),Ep.materialStore=null,Ep.materialStore=new Eb(Ep.textureStore,this),Ep.lightStore.dispose&&Ep.lightStore.dispose(),Ep.lightStore=null,Ep.lightStore=new rE(Ep.scene,this),this.defaultLightStore=Ep.lightStore,new Vh(Ep.renderer),Ep.stateStore.dispose&&Ep.stateStore.dispose(),Ep.stateStore=null,Ep.stateStore=new uE,this.defaultNodeSelection.dispose&&this.defaultNodeSelection.dispose(),this.defaultNodeSelection=null,this.defaultNodeSelection=new $y(Ep.scene,this),Ep.animationStore.dispose&&Ep.animationStore.dispose(),Ep.animationStore=null,Ep.animationStore=new kT,Ep.animationMixers=[],Ep.clippingStore.dispose&&Ep.clippingStore.dispose(),Ep.clippingStore=null,Ep.clippingStore=new zT;const l=t.handlers;t.dispose&&t.dispose(),Ep.eventHandlerStore.dispose&&Ep.eventHandlerStore.dispose(),t=null,Ep.eventHandlerStore=null,t=new HT(Ep.renderer,Ep.scene,Ep.camera),Ep.eventHandlerStore=t,t.handlers=l,Ep.transformControls.dispose&&Ep.transformControls.dispose(),Ep.transformControls=new sw(Ep.camera,Ep.renderer.domElement),this.transformControls=Ep.transformControls,Ep.axesTransformControls=new cw(Ep.camera,Ep.renderer.domElement),this.axesTransformControls=Ep.axesTransformControls,Ep.transformStore.destroy&&Ep.transformStore.destroy(),Ep.transformStore=new gE(Ep.transformControls),Ep.transformControls.addEventListener("translate",(e=>{this.cutLevelByUUID(e.object.uuid,!1)})),Ep.transformControls.addEventListener("dragging-changed",(function(e){Ep.orbitControls.enabled=!e.value,Ep.orthoCameraControls.enabled=!e.value})),Ep.transformControls.addEventListener("mouseUp",this._transformEvent),Ep.axesTransformControls.addEventListener("mouseUp",this._transformEvent),Ep.scene.sysObjects.add(Ep.transformControls),Ep.clippingControls.dispose&&Ep.clippingControls.dispose(),Ep.clippingControls=new gw,Ep.scene.sysObjects.add(Ep.clippingControls),Ep.defaultObjectTree.dispose&&Ep.defaultObjectTree.dispose(),this.defaultObjectTree.dispose&&this.defaultObjectTree.dispose(),Ep.defaultObjectTree=null,this.defaultObjectTree=null,this.defaultObjectTree=new Sx(Ep.scene),Ep.defaultObjectTree=this.defaultObjectTree;const c=Array.from(Ep.cacheStore._cache.keys());this.loadScene({serviceName:i,scenePath:s.scenePath},(e=>{if(this.changingScene=!1,1==e){const e=Array.from(Ep.cacheStore._cache.keys()).filter((e=>!c.some((t=>t===e))));s.cacheKeys=e,J=null,this.InstancedIconModelLandmarkInit(),a&&a({result:1,message:"场景切换成功!"}),r&&r({name:i,default:s.defaultScene})}else a&&a({result:0,message:"场景切换失败!"})}))},this.getServicesInfo=e=>{e&&e({result:1,message:"成功。",mode:"scene",services:Ep.sceneStore.getScenes()})},this.addGround=(e,t)=>{t=t||"#cfcfcf";const i=new sn;i.scale(e||2e3,e||2e3,1);let n=new Fi(i,new So({color:new Qt(t),fog:!0}));n.rotateX(Math.PI/-2),n.name="__groundPlane",n.receiveShadow=!0,n.visible=!0,Ep.scene.sysObjects.add(n)},this.getColorSpace=()=>{switch(Ep.renderer.outputEncoding){case ee:return"linear";case te:return"srgb";case ie:return"gamma"}},this.setColorSpace=e=>{if(e!==this.getColorSpace())switch(e.toLowerCase()){case"linear":if(Ep.scene.background instanceof Qt)switch(Ep.renderer.outputEncoding){case te:Ep.scene.background.convertLinearToSRGB&&Ep.scene.background.convertLinearToSRGB();break;case ie:Ep.scene.background.convertLinearToGamma&&Ep.scene.background.convertLinearToGamma()}if(Ep.scene.fog instanceof pr&&Ep.scene.background instanceof Qt)switch(Ep.renderer.outputEncoding){case te:Ep.scene.fog.color.convertLinearToSRGB&&Ep.scene.fog.color.convertLinearToSRGB();break;case ie:Ep.scene.fog.color.convertLinearToGamma&&Ep.scene.fog.color.convertLinearToGamma()}Ep.scene.background instanceof we&&(Ep.scene.background.encoding=ee),Ep.renderer.outputEncoding=ee;break;case"srgb":if(Ep.scene.background instanceof Qt)switch(Ep.renderer.outputEncoding){case ee:Ep.scene.background.convertSRGBToLinear&&Ep.scene.background.convertSRGBToLinear();break;case ie:Ep.scene.background.convertLinearToGamma&&Ep.scene.background.convertLinearToGamma(),Ep.scene.background.convertSRGBToLinear&&Ep.scene.background.convertSRGBToLinear()}if(Ep.scene.fog instanceof pr&&Ep.scene.background instanceof Qt)switch(Ep.renderer.outputEncoding){case ee:Ep.scene.fog.color.convertSRGBToLinear&&Ep.scene.fog.color.convertSRGBToLinear();break;case ie:Ep.scene.fog.color.convertLinearToGamma&&Ep.scene.fog.color.convertLinearToGamma(),Ep.scene.fog.color.convertSRGBToLinear&&Ep.scene.fog.color.convertSRGBToLinear()}Ep.scene.background instanceof we&&(Ep.scene.background.encoding=te),Ep.renderer.outputEncoding=te;break;case"gamma":if(Ep.scene.background instanceof Qt)switch(Ep.renderer.outputEncoding){case ee:Ep.scene.background.convertGammaToLinear&&Ep.scene.background.convertGammaToLinear();break;case te:Ep.scene.background.convertLinearToSRGB&&Ep.scene.background.convertLinearToSRGB(),Ep.scene.background.convertGammaToLinear&&Ep.scene.background.convertGammaToLinear()}if(Ep.scene.fog instanceof pr&&Ep.scene.background instanceof Qt)switch(Ep.renderer.outputEncoding){case ee:Ep.scene.fog.color.convertGammaToLinear&&Ep.scene.fog.color.convertGammaToLinear();break;case te:Ep.scene.fog.color.convertLinearToSRGB&&Ep.scene.fog.color.convertLinearToSRGB(),Ep.scene.fog.color.convertGammaToLinear&&Ep.scene.fog.color.convertGammaToLinear()}Ep.scene.background instanceof we&&(Ep.scene.background.encoding=ie),Ep.renderer.outputEncoding=ie}},this.syncScene=(e,t)=>{if(!Ep.instance.notState)return void logger.warn("notState undefined");let i=JSON.parse(JSON.stringify(Ep.instance.notState));"object"===e?(i.objectTree.children.forEach((e=>{"BuildingItem"===e.type?e.children.forEach((e=>{"ModelItem"===e.type?e.articulationAnimations&&e.articulationAnimations.forEach((t=>{let i=Ep.instance.defaultObjectTree.getItemByName(e.name),n=!1;if(i){let e=i.articulationAnimations.find((e=>e.animationName===t.animationName));e&&(n=e.isEnable)}t.isEnable=n})):"BuildingFloorItem"===e.type&&e.children.forEach((e=>{"ModelItem"===e.type&&e.articulationAnimations&&e.articulationAnimations.forEach((t=>{let i=Ep.instance.defaultObjectTree.getItemByName(e.name),n=!1;if(i){let e=i.articulationAnimations.find((e=>e.animationName===t.animationName));e&&(n=e.isEnable)}t.isEnable=n}))}))})):"ModelItem"===e.type||"ModelAsset"===e.type?e.articulationAnimations&&e.articulationAnimations.forEach((t=>{let i=Ep.instance.defaultObjectTree.getItemByName(e.name),n=!1;if(i){let e=i.articulationAnimations.find((e=>e.animationName===t.animationName));e&&(n=e.isEnable)}t.isEnable=n})):"PaintItem"===e.type&&(e.children.forEach((e=>{"ModelItem"===e.type&&e.articulationAnimations&&e.articulationAnimations.forEach((t=>{let i=Ep.instance.defaultObjectTree.getItemByName(e.name),n=!1;if(i){let e=i.articulationAnimations.find((e=>e.animationName===t.animationName));e&&(n=e.isEnable)}t.isEnable=n}))})),e.modelInstanced.forEach((e=>{e.articulationAnimations&&e.articulationAnimations.forEach((e=>{e.isEnable=!1}))})))})),this.defaultObjectTree.applySettings(i.objectTree,!1,!1,!0),this.defaultObjectTree.children.forEach((e=>{if("BuildingItem"===e.type)if(e.children.forEach((e=>{e.level&&e.hide()})),e.floor){e.room?this.cutLevelToRoom(e.getGroup().uuid,e.floor,e.room):this.cutLevel(e.getGroup().uuid,e.floor);for(let t=0;t<W.length;t++)W[t].uuid===e.getGroup().uuid&&(W.splice(t,1),t--);W.push({uuid:e.getGroup().uuid,level:e.floor})}else this.cutLevel(e.getGroup().uuid,e.floor)}))):"light"===e?(this.setSkyboxRotationY(180*(i.background.cubeTextureRotationY||0)/Math.PI),this.defaultLightStore.transformedLight&&"DirectionalLight"==this.defaultLightStore.transformedLight.type&&this.defaultLightStore.transformedLight.position.fromArray(i.lights.directionalLights[this.defaultLightStore.transformedLight.name].position),Ep.lightStore.applySettings(i.lights,t,i.view.camera.duration)):"effect"===e?this.defaultEffectStore.applySettings(i.effects):"background"===e?(i.background&&(Ep.background.mode!=i.background.mode&&(this.crossfadeFreeze(),this.crossfade(1e3)),Ep.background.mode=i.background.mode,Ep.background.cubeTextureRotationY=i.background.cubeTextureRotationY,Ep.background.cubeTextureBlur=i.background.cubeTextureBlur,Ep.background.isCustomSkybox=i.background.isCustomSkybox),Ep.background.color=null,Ep.background.texture=null,i.background&&(Ep.background.cubeTextureRotationY=i.background.cubeTextureRotationY||0,Ep.background.cubeTextureBlur=i.background.cubeTextureBlur,Ep.background.isCustomSkybox=i.background.isCustomSkybox,Ep.background.cubeTextureIntensity=i.background.cubeTextureIntensity,Ep.background.environmentLuminosity=i.background.environmentLuminosity,i.background.colorCSSValue&&(this._backgroundColorType!=i.background.colorCSSValue.type&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColorType=i.background.colorCSSValue.type,"single"==i.background.colorCSSValue.type?(this._backgroundColor1!=i.background.colorCSSValue.color1&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColor1=i.background.colorCSSValue.color1):"gradient"==i.background.colorCSSValue.type&&(this._backgroundColorUrl!=i.background.colorCSSValue.dataUrl&&(this.crossfadeFreeze(),this.crossfade(1e3)),this._backgroundColorUrl=i.background.colorCSSValue.dataUrl),this.setBackgroundColor(i.background.colorCSSValue)),i.background.textureURL&&this.setBackgroundImage(i.background.textureURL),i.background.mode&&this.setBackgroundMode(i.background.mode,i))):"all"===e&&this.applySceneSettings(i,t)},this.rotatingModel=e=>{if(!e)return;const t=this.defaultObjectTree.getItemByName(e.id);if(t){const i=t.getGroup();let n=Ep.animationStore.findNodeAnimation(i,Sv.type);n&&(n.reset(),Ep.animationStore.remove(n));let a=0;0!==e.durationX&&(a=ge.degToRad(60/e.durationX),"clockwise"==e.directionX&&(a=-a));let r=0;0!==e.durationY&&(r=ge.degToRad(60/e.durationY),"clockwise"==e.directionY&&(r=-r));let s=0;0!==e.durationZ&&(s=ge.degToRad(60/e.durationZ),"clockwise"==e.directionZ&&(s=-s)),n=new Sv(i,0!==e.durationX,0!==e.durationY,0!==e.durationZ,a,r,s),Ep.animationStore.add(n)}this.nextRender((()=>{this.cutLevelByUUID(e.id,!1)}))},this.getImageBitMapCache=()=>Zo,this.findOrphanTextures=e=>{if(!Ep.textureStore)return;let t=Ep.defaultObjectTree.children.find((t=>t.name===e));return t?Ep.textureStore.findOrphanTextures(t.getGroup().sourceModelKey,t.getGroup()):void 0},this.loadPlugin=(e,t)=>{Ep.pluginStore.add(e,t)},this.findPlugin=e=>Ep.pluginStore.find(e)}}};GE.core={Model:Px,Node:qy,NodeSelection:$y,Map:hy,Material:Ab,Texture:Tb,materialExporter:function({settingsList:e=[],baseOrigin:t,onProgress:i,onLoad:n}){let a=document.createElement("div");a.style.width="200px",a.style.height="200px",document.body.append(a),Ep.origin=t,Ep.cacheStore||(Ep.cacheStore=new NT),Ep.customTextureStore||(Ep.customTextureStore=new hE("customTextureStore")),Ep.loaders||(Ep.loaders={}),Ep.loaders.textureLoader=new al,NE=new LE(a);let r=[];var s=[];e.forEach((e=>{e&&e.objectTree&&e.objectTree.children&&r.push(new zE(e,t,(e=>{e.allProgress={total:r.length,loaded:r.filter((e=>e.loadedState)).length+1},i&&i(e)}),(t=>{if(t.forEach((t=>{s.push({...t,settings:e})})),!r.find((e=>!0===e.loading))){let e=r.find((e=>!1===e.loadedState));e?e.then():(Zo.clear(),Ep.customTextureStore=null,Ep.cacheStore=null,Ep.loaders={},Ep.origin=null,n&&n(s))}})))}));let o=r.find((e=>!1===e.loadedState));o&&o.then()},materialSaver:function(e,t,i,n){e&&t&&i||n&&n({success:!1,message:"parameter error"});try{let r=e.defaultObjectTree.getItemByName(t);if(!r)return;let s=JSON.parse(JSON.stringify(r.getMaterials()[i].getSettings()));delete s.id,delete s.replacePath;let o=r.getMaterials()[i].material().clone();o.needsUpdate=!0;let l=new Map;for(let e in o)o[e]instanceof we&&o[e].image&&l.set(o[e].name||`${o.name}#${e}`,Tb._fromThreeObject(o[e]));let c=new Ab({materialOfThree:a=o,id:a.uuid,name:a.name,type:"metalness",mapType:"metalness",color:a.color,map:a.map,mapIntensit:a.mapIntensit,metalnessMap:a.metalnessMap,metalnessIntensity:a.metalness,roughnessMap:a.roughnessMap,roughnessIntensity:a.roughness,enableSpecularMap:!!a.envMap,specularMapType:a.envMap?"custom":"envmap",specularMap:a.envMap,specularMapIntensity:a.envMapIntensity/5,enableNormalMap:!!a.normalMap,normalMapType:"",normalMap:a.normalMap,normalMapFlipY:a.normalMapFlipY,normalMapIntensity:a.normalScale?a.normalScale.x:1,enableDisplacement:!!a.displacementMap,displacementMap:a.displacementMap,displacementIntensity:a.displacementScale,enableOpacity:a.transparent||!!a.alphaMap,opacityType:"blend",opacityMap:a.alphaMap,opacityIntensity:a.opacity,opacityInverted:!1,emissive:a.emissive,enableEmissive:!!a.emissiveMap||0!==a.emissive.r||0!==a.emissive.g||0!==a.emissive.b,emissiveMap:a.emissiveMap,emissiveIntensity:a.emissiveIntensity,enableLightMap:!!a.lightMap,lightMap:a.lightMap,lightMapIntensity:a.lightMapIntensity,enableSSR:a.enableSSR,envMapIntensity:a.envMapIntensity,side:a.side,depth:a.depthTest&&a.depthWrite?2:a.depthTest||a.depthWrite?1:0}),h=function(e,t,i,n=[]){let a={};for(let r in e)if(!n.includes(r))if(t[r]instanceof hy){for(let t in e[r])if(!n.includes(t))if(e[r][t.replace("_","")]=e[r][t],e[r][t.replace("_","")]instanceof Array);else if(e[r][t.replace("_","")]instanceof Object)for(let i in e[r][t.replace("_","")])n.includes(i)||(e[r][t.replace("_","")][i.replace("_","")]=e[r][t.replace("_","")][i]);switch(e[r].type){case"imagebitmap":let n="undefined"!=typeof ImageBitmap&&e[r].source instanceof ImageBitmap?e[r].source:void 0!==e[r].name?i.get(e[r].name)||Ep.previewTextureStore.find(e[r].name):i.get(t.name+"#"+r);if(("metalnessMap"===r||"roughnessMap"===r)&&!n){let t="",a="";e.roughnessMap&&(a=e.roughnessMap.name||e.roughnessMap._name||""),e.metalnessMap&&(t=e.metalnessMap.name||e.metalnessMap._name||""),n=i.get(t+a),n||(n=i.get(a+t)),i.forEach((t=>{t.name.indexOf(e[r].name)>-1&&t.name.indexOf("#MetalnessAndRoughness#")>-1&&(n=t)}))}if(!n&&e[r].name&&0===e[r].name.indexOf("[[origin]]")){Ep.previewTextureStore.loadTexture({url:e[r].name,name:e[r].name,onLoad:()=>{let n="undefined"!=typeof ImageBitmap&&e[r].source instanceof ImageBitmap?e[r].source:void 0!==e[r].name?i.get(e[r].name)||Ep.previewTextureStore.find(e[r].name):i.get(t.name+"#"+r);t[r]={type:"imagebitmap",source:n,reset:!0}}});break}if(t[r]={type:"imagebitmap",source:n,reset:!0},["opacityMap","specularMap"].includes(r)&&e[r].name&&-1!==e[r].name.lastIndexOf(".")){let t=e[r].name.lastIndexOf("."),n=e[r].name.substring(t+1),s=i.get(e[r].name);["BMP","JPG","JPEG","PNG"].includes(n.toUpperCase())&&s&&(a[r]={name:jE[r],texture:s})}break;case"color":e[r].reset=!0,t[r]=e[r];break;case"file":break;default:t[r]=e[r]}}else switch(r){case"normalMapType":t[r]="normal";break;case"type":case"mapType":t[r]="metalness";break;default:t[r]=e[r]}return e.color&&(t.color=e.color),a}(s,c,l);for(const e in h){let t=HE(o[h[e].name]);s[e].dataUrl=t}FE.set(o,s);let u={trs:!0,onlyVisible:!1,truncateDrawRange:!0,binary:!0,forcePowerOfTwoTextures:!0,includeCustomExtensions:!0,maxTextureSize:1/0};UE.parse(FE.group,(async e=>{if(e instanceof ArrayBuffer){let t=new Blob([e],{type:"application/octet-stream"}),a=s.type,r="water"==a?null:await FE.print();n&&n({success:!0,type:a,blob:t,name:i,image:r})}}),u)}catch(e){n&&n({success:!1,message:e.message})}var a}},e.scene=GE,Object.defineProperty(e,"__esModule",{value:!0})}));
